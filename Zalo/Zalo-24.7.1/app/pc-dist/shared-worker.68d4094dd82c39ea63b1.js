!function(e){function t(t){for(var r,i,o=t[0],c=t[1],d=t[2],l=0,u=[];l<o.length;l++)i=o[l],Object.prototype.hasOwnProperty.call(n,i)&&n[i]&&u.push(n[i][0]),n[i]=0;for(r in c)Object.prototype.hasOwnProperty.call(c,r)&&(e[r]=c[r]);for(h&&h(t);u.length;)u.shift()();return a.push.apply(a,d||[]),s()}function s(){for(var e,t=0;t<a.length;t++){for(var s=a[t],r=!0,i=1;i<s.length;i++){var c=s[i];0!==n[c]&&(r=!1)}r&&(a.splice(t--,1),e=o(o.s=s[0]))}return e}var r={},i={30:0},n={30:0},a=[];function o(t){if(r[t])return r[t].exports;var s=r[t]={i:t,l:!1,exports:{}};return e[t].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.e=function(e){var t=[];i[e]?t.push(i[e]):0!==i[e]&&{37:1,38:1,39:1}[e]&&t.push(i[e]=new Promise((function(t,s){for(var r=({12:"countries",19:"lang-en",20:"lang-vi"}[e]||e)+".68d4094dd82c39ea63b1.css",n=o.p+r,a=document.getElementsByTagName("link"),c=0;c<a.length;c++){var d=(h=a[c]).getAttribute("data-href")||h.getAttribute("href");if("stylesheet"===h.rel&&(d===r||d===n))return t()}var l=document.getElementsByTagName("style");for(c=0;c<l.length;c++){var h;if((d=(h=l[c]).getAttribute("data-href"))===r||d===n)return t()}var u=document.createElement("link");u.rel="stylesheet",u.type="text/css",u.onload=t,u.onerror=function(t){var r=t&&t.target&&t.target.src||n,a=new Error("Loading CSS chunk "+e+" failed.\n("+r+")");a.code="CSS_CHUNK_LOAD_FAILED",a.request=r,delete i[e],u.parentNode.removeChild(u),s(a)},u.href=n,document.getElementsByTagName("head")[0].appendChild(u)})).then((function(){i[e]=0})));var s=n[e];if(0!==s)if(s)t.push(s[2]);else{var r=new Promise((function(t,r){s=n[e]=[t,r]}));t.push(s[2]=r);var a,c=document.createElement("script");c.charset="utf-8",c.timeout=120,o.nc&&c.setAttribute("nonce",o.nc),c.src=function(e){return o.p+"lazy/"+({12:"countries",19:"lang-en",20:"lang-vi"}[e]||e)+"."+{12:"7045d6fc82db00cf8111",16:"98b3a5833fc83a3f43bf",19:"031613ca6b404bb8b4ba",20:"125e73f3d8d3b47202ba",35:"191ceb0a79125acd8dde",36:"ede9fc8aafa3aa4f6335",37:"58a2f751df2c2bee7733",38:"36cb30d287dafe4d2e11",39:"ecd57bda59c19bdf0bdf",40:"ab9ec88b2aa2b8d9e7f6",41:"d4ae41eac2e2ff119064",42:"3eb703c2be5454623449",43:"566f560b9e3549af33d5",44:"75f7eca4dcf2b19f699b"}[e]+".js"}(e);var d=new Error;a=function(t){c.onerror=c.onload=null,clearTimeout(l);var s=n[e];if(0!==s){if(s){var r=t&&("load"===t.type?"missing":t.type),i=t&&t.target&&t.target.src;d.message="Loading chunk "+e+" failed.\n("+r+": "+i+")",d.name="ChunkLoadError",d.type=r,d.request=i,s[1](d)}n[e]=void 0}};var l=setTimeout((function(){a({type:"timeout",target:c})}),12e4);c.onerror=c.onload=a,document.head.appendChild(c)}return Promise.all(t)},o.m=e,o.c=r,o.d=function(e,t,s){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(o.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(s,r,function(t){return e[t]}.bind(null,r));return s},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o.oe=function(e){throw e};var c=this.webpackJsonp=this.webpackJsonp||[],d=c.push.bind(c);c.push=t,c=c.slice();for(var l=0;l<c.length;l++)t(c[l]);var h=d;a.push([1,0,4,7,5,6,11,10,15,1,3,2,9,8,14]),s()}({1:function(e,t,s){e.exports=s("CdmT")},CdmT:function(e,t,s){"use strict";s.r(t);s("iGh7"),s("eqHM"),s("dUtG"),s("y485"),s("jmmm"),s("xDXR"),s("EmOc"),s("ezdo"),s("KdAX"),s("mzek"),s("aBYf"),s("zm+Q"),s("WSI5"),s("v/rv"),s("nAZb"),s("c0KM"),s("zheM"),s("CXIs"),s("cZjg");var r=s("YrRS");Object(r.b)();s("33YB"),s("0rWR"),s("Lq8m"),s("nUpV"),s("5yGw"),s("hRcX"),s("gpNb"),s("rhBN"),s("cF85"),s("ejhj"),s("8eBJ");var i,n=s("PmZf"),a=s("tHMN"),o=s("jIg3"),c=s("jDHv"),d=s("fsN4"),l=s("Mgpg");let h=c.ModuleContainer.injectable()(i=function(e,t){return c.ModuleContainer.inject(a.b)(e,void 0,0)}(i=function(e,t){return c.ModuleContainer.inject(l.ZLoggerFactory)(e,void 0,1)}(i=Reflect.metadata("design:type",Function)(i=Reflect.metadata("design:paramtypes",[void 0===a.a?Object:a.a,void 0===l.ZLoggerFactory?Object:l.ZLoggerFactory])(i=class extends o.a{constructor(e,t){super(),this.engine=e,this.logger=void 0,this.logger=t.createZLogger("db",["client"]),this.registerListeners()}registerListeners(){const e=e=>this.dispatchEvent(e);this.engine.addEventListener(n.b.UnexpectedError,e),this.engine.addEventListener(n.b.QueryExec,e),this.engine.addEventListener(n.b.QueryError,e),this.engine.addEventListener(n.b.SuccessOpenDB,e),this.engine.addEventListener(n.b.ConnectionClosedAbnormally,e)}install(){$zsub.$zdb.onReceiveSession(((e,t)=>{this.authenticate(t)})),$zdb.notifyDbConnected(__ZaBUNDLENAME__),$zsub.$zdb.onRequestCloseDbs((async(e,t)=>{this.logger.zsymb(0,"VMZXXK","closing databases"),await this.closeDBs(t),this.logger.zsymb(0,"Gamqh2","closed databases"),$zdb.notifyFinishCloseDb(__ZaBUNDLENAME__)})),this.logger.zsymb(0,"aV5VNv","installed")}areYouOk(){return!0}authenticate(e){e&&(this.session=e,this.dispatchEvent(new n.e(e)),this.logger.zsymb(0,"-CrTLX",(()=>["authenticated",`id: ${e.userId}`])))}async closeDBs(e){const t=d.default.getInstance(),s=this.logger;let r=[];if(e){if(e.length){let i=[...e];s.zsymb(3,"IcAgBR",["Start closing dbs: {}","sAZ336"],e),s.zsymb(3,"P2KODo",["Wait for dbs to be closed: {}","VJzu2r"],i),r=e.map((async e=>{await t[e].closeThisDatabase(),i=i.filter((t=>t!==e)),0===i.length?s.zsymb(0,"hDNI95","Done closing dbs"):s.zsymb(3,"kWPyg3",["Wait for dbs to be closed: {}","VJzu2r"],i)}))}}else r=[t.closeAllDatabases()];await Promise.all(r)}})||i)||i)||i)||i)||i;c.ModuleContainer.registerSingleton(o.b,h);var u,g=s("8/YW"),m=s("UGJm"),p=s("Y58e"),f=s("hI9i"),I=s("q1tI"),b=s.n(I),w=s("/MKj"),M=s("ClHk");function y(){const{data:e}=Object(f.k)(M.a,"all");return 0===e.length?b.a.createElement("div",null,"No Tasks"):b.a.createElement("table",null,b.a.createElement("thead",null,b.a.createElement("tr",null,b.a.createElement("th",null,"ID"),b.a.createElement("th",null,"Type"),b.a.createElement("th",null,"Status"),b.a.createElement("th",null,"Process"),b.a.createElement("th",null))),b.a.createElement("tbody",null,e.map((e=>b.a.createElement(_,{key:e,id:e})))))}function _(e){const t=Object(f.j)(M.a,e.id);return t?b.a.createElement("tr",null,b.a.createElement("td",null,t.id),b.a.createElement("td",null,t.type),b.a.createElement("td",null,t.status),b.a.createElement("td",null,t.progress),b.a.createElement("td",null,new Date(t.startTime).toLocaleString())):null}function v(){return b.a.createElement(w.a,{store:f.b,context:f.a},b.a.createElement(y,null))}Object(c.injectable)()(u=Object(c.singleton)(g.a)(u=function(e,t){return Object(c.inject)(p.a)(e,void 0,0)}(u=function(e,t){return Object(c.inject)(l.ZLoggerFactory)(e,void 0,1)}(u=Reflect.metadata("design:type",Function)(u=Reflect.metadata("design:paramtypes",[void 0===p.a?Object:p.a,void 0===l.ZLoggerFactory?Object:l.ZLoggerFactory])(u=class extends m.a{constructor(e,t){super("zalo",e,t,{component:v,container:document.getElementById("app")})}})||u)||u)||u)||u)||u);s("KszJ"),s("Hbak"),s("dhzt"),s("O6t0");var S=s("3jnX"),E=s("qUG6"),T=s("19h1"),O=s("R5gT"),N=s("4prX"),D=s("KP/S");class k extends S.b{constructor(e){super({type:"REQUEST_NOISE_ID",params:e})}}class C extends S.b{constructor(){super({type:"REQUEST_ALL_NOISE_ID",params:{}})}}var L=s("Hy6w"),A=s("h0S/");var R,F=new class{constructor(){this._writeMsgs=new L.a("writeMsgs"),this._writeFileRes=new L.a("writeFileRes"),this._writeMedia=new L.a("writeMedia"),this._convertVersion=new L.a("convertVersion"),this._readSQL=new L.a("readSQL"),this._denoiseId=new L.a("denoiseId"),this._normalMsg=new L.a("normalMsg"),this._countMsg=new L.a("countMsg"),this._indexSearch=new L.a("indexSearch"),this._mediaRes=new L.a("mediaRes"),this._filterExists=new L.a("filterExists"),this._total=new L.a("totalRestoreMsg"),this.logger=void 0,this.writeMsgs=void 0,this.convertVersion=void 0,this.readSQL=void 0,this.denoiseId=void 0,this.writeFileRes=void 0,this.writeMedia=void 0,this.normalMsg=void 0,this.countMsg=void 0,this.indexSearch=void 0,this.mediaRes=void 0,this.filterExists=void 0,this.total=void 0,this.trackHolder=void 0,this.tracker=void 0,this.writeMsgs=this._writeMsgs.getTracker(),this.convertVersion=this._convertVersion.getTracker(),this.readSQL=this._readSQL.getTracker(),this.denoiseId=this._denoiseId.getTracker(),this.writeFileRes=this._writeFileRes.getTracker(),this.writeMedia=this._writeMedia.getTracker(),this.normalMsg=this._normalMsg.getTracker(),this.countMsg=this._countMsg.getTracker(),this.indexSearch=this._indexSearch.getTracker(),this.total=this._total.getTracker(),this.mediaRes=this._mediaRes.getTracker(),this.filterExists=this._filterExists.getTracker(),this.trackHolder=[this._writeMsgs,this._convertVersion,this._readSQL,this._denoiseId,this._writeFileRes,this._writeMedia,this._mediaRes,this._normalMsg,this._countMsg,this._indexSearch,this._filterExists,this._total],this.tracker=[this.writeMsgs,this.convertVersion,this.readSQL,this.denoiseId,this.writeFileRes,this.writeMedia,this.mediaRes,this.normalMsg,this.countMsg,this.indexSearch,this.filterExists,this.total],this.lock();const e=c.ModuleContainer.resolve(l.ZLoggerFactory);this.logger=e.createZLogger(A.ZLoggerNametags.msgSync,[A.ZLoggerNametags.syncMetrics])}lock(){this.trackHolder.forEach((e=>e.lock()))}unlock(){this.trackHolder.forEach((e=>e.unlock()))}reset(){this.tracker.forEach((e=>e.reset()))}print(){let e=0;this.trackHolder.forEach((t=>{"totalRestoreMsg"!==t.label&&(e+=t.time)})),this.logger.zsymb(0,"mRoP4s","ph7 total, track, untrack: ",this._total.time,e,this._total.time-e),this.trackHolder.forEach((e=>{this.logger.zsymb(0,"EOrJCU",`ph7 ${e.info}`)}))}getSnapShot(){const e={};return this.trackHolder.forEach((t=>{e[t.label]=t.time})),e}};let U=Object(c.singleton)()(R=Object(c.injectable)()(R=class{constructor(){this.userId="",this.cache=new Map}async init(e){this.userId!==e&&(this.userId=e,this.cache=new Map,await this.tryToFetchCachedNoiseId())}async tryToFetchCachedNoiseId(){try{const e=new C,t=await e.run();t.length>0&&(this.cache=new Map(t))}catch(e){}}get(e){if(e)return this.cache.get(e.toString())}async import(e){return F.denoiseId.start(),this._getNoiseId(e.uids||[],e.gids||[]).then((e=>(F.denoiseId.end(),e)))}async _getNoiseId(e,t){const s=e.filter((e=>!this.cache.has(e)&&Number.parseInt(e).toString()===e)),r=t.filter((e=>!this.cache.has(e)&&Number.parseInt(e).toString()===e));if(s.length!==e.length||r.length!==t.length){const i=e.length-s.length+t.length-r.length;N.default.increaseFailed(D.f.REQ_NOISE_ID,1,i,D.d.INVALID_NOISE_ID,Date.now())}await this._requestNoiseId(s,r)}_requestNoiseId(e,t){return new Promise(((s,r)=>{setTimeout((()=>{r("_requestNoiseId timeout")}),1e4);new k({uids:e,gids:t}).run().then((e=>{e.forEach((([e,t])=>{this.cache.set(e,t)})),s(!0)})).catch(r)}))}})||R)||R;var j=s("1pet"),G=s("z0WU"),q=s("/Bne"),B=s("1qqm"),x=s("dGoU");let P=new B.b(B.a);var z=s("fqRP"),Q=s("s2Ee"),$=s("PoHQ"),V=s("bUXd"),Y=s("EYv5"),Z=s("v6qY");const H={shouldUseNewMediaDBConfig:0};var W,J=s("NDmK"),X=s("igA5"),K=s("/YHU");let ee=Object(c.injectable)()(W=function(e,t){return Object(c.inject)(l.ZLoggerFactory)(e,void 0,0)}(W=function(e,t){return Object(c.inject)(z.a)(e,void 0,1)}(W=Reflect.metadata("design:type",Function)(W=Reflect.metadata("design:paramtypes",[void 0===l.ZLoggerFactory?Object:l.ZLoggerFactory,void 0===z.a?Object:z.a])(W=class{constructor(e,t){this.readyToInsertMsgsQueue=[],this.idStore=void 0,this.coreDB=null,this.resDB=null,this.ttl=void 0,this.logger=void 0,this.checkSum=new Set,this.checkSum2=new Set,this.waitForNoiseId=[],this.noiseIdQueue=[],this.waitForGlobalId=[],this.lastInsertedMsgId=Date.now(),this.uid="",this.idStore=c.ModuleContainer.resolveToken(U),this.logger=e.createZLogger("sync-message",["msg-cross-importer"]),this.ttl=t}async open(e,t){await this.close(),this.uid=e,$.o.setSessionUserId(e),c.ModuleContainer.resolve(o.b).authenticate({userId:e,UIN:t}),this.checkSum=new Set,this.checkSum2=new Set;const s=d.default.getInstance();this.coreDB=s.Core,this.resDB=s.Res,this.waitForGlobalId=[],x.a.init(e,t)}close(){this.coreDB&&(this.coreDB=null),this.resDB&&(this.resDB=null)}queueNewMessages(e){let t=this.verifyCrossMsg(e);this.readyToInsertMsgsQueue=this.readyToInsertMsgsQueue.concat(t.readyToInsert),this.waitForNoiseId=this.waitForNoiseId.concat(t.waitForNoiseId),this.noiseIdQueue=this.noiseIdQueue.concat(t.idsToGetNoise)}resetLastGlobalMsgId(){this.lastInsertedMsgId=Date.now()}async processImportQueue(e){if((e||this.shouldProcessMsgsInWaitForNoiseQueue())&&await this.processWaitForNoiseIdQueue(),(e&&0===this.readyToInsertMsgsQueue.length||this.waitForGlobalId.length>99)&&this.waitForGlobalId.length>0){const e=[];this.processWaitForGlobalIdQueue(e),e.length>0&&(this.queueNewMessages(e),await this.processWaitForNoiseIdQueue())}if(this.readyToInsertMsgsQueue.length){const e=this.readyToInsertMsgsQueue.splice(0,2e3);let s=Math.min(...e.map((e=>e.sequenseId)));s=Math.max(s,this.waitForGlobalId.length?this.waitForGlobalId[0].sequenseId:0,this.waitForNoiseId.length?this.waitForNoiseId[0].sequenseId:0);try{const t=[];this.crossMsgsToNormalMsgs(e,t);return{inserted:(await this.insertToDb(t)).success,minSeqId:s,queued:e,validMsgCount:t.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}catch(t){this.logger.zsymb(18,"_DORLY",(()=>["processImportQueue error",{error:t}]))}return{inserted:[],minSeqId:s,queued:e,validMsgCount:e.length,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}return{inserted:[],minSeqId:-1,queued:[],validMsgCount:0,hasMore:this.waitForNoiseId.length>0||this.waitForGlobalId.length>0}}printChecksum(){this.logger.zsymb(12,"sKHgOB",(()=>["size",{waitNoise:this.waitForNoiseId,waitGlobal:this.waitForGlobalId,ready:this.readyToInsertMsgsQueue}])),this.checkSum.size>0?this.logger.zsymb(18,"WHFJUr",(()=>["checkSum.size > 0",{miss:this.checkSum.values()}])):this.logger.zsymb(3,"cb6KRe",["checkSum.size == 0","db4ODL"])}processWaitForGlobalIdQueue(e){const t=this.waitForGlobalId;this.waitForGlobalId=[],this.lastInsertedMsgId=t[0].cliMsgId;for(let s=t.length-1;s>=0;s--){const r=t[s];r.globalMsgId=`${this.lastInsertedMsgId}_${s.toString().padStart(3,"0")}`,e.push(r)}}async insertMsgs(e){e=e.filter((e=>!!e.globalMsgId));let t=this.verifyCrossMsg(e).idsToGetNoise;t.length&&await this.idStore.import({uids:t});let s=[];return this.crossMsgsToNormalMsgs(e,s),this.insertToDb(s)}async processWaitForNoiseIdQueue(){if(0===this.noiseIdQueue.length)return;const e=this.noiseIdQueue,t=this.waitForNoiseId;this.waitForNoiseId=[],this.noiseIdQueue=[],await this.idStore.import({uids:e}),this.readyToInsertMsgsQueue.push(...t)}shouldProcessMsgsInWaitForNoiseQueue(){return this.noiseIdQueue.length>=1e3||this.waitForNoiseId.length>150}crossMsgsToNormalMsgs(e,t){F.normalMsg.start();for(let r=0;r<e.length;r++){const i=e[r];try{if("number"==typeof i.globalMsgId&&i.globalMsgId>0&&(this.lastInsertedMsgId=i.globalMsgId,this.waitForGlobalId.length>0)){const e=this.waitForGlobalId;this.waitForGlobalId=[];for(let s=e.length-1;s>=0;s--){const r=e[s];r.globalMsgId=`${i.globalMsgId}_${s.toString().padStart(3,"0")}`,this.crossMsgToNormalMsg(r,t)}}this.crossMsgToNormalMsg(i,t)}catch(s){}}F.normalMsg.end()}crossMsgToNormalMsg(e,t){if(!e.globalMsgId)return void this.waitForGlobalId.push(e);const s=e.parsedType||G.default.normalizeMessageType(e.type);if(s===j.MSG_UNKNOWN)return void 0;let r=e.parsedIdTo||this.idStore.get(e.ownerId),i=e.parsedUidFrom||e.fromId==e.userId?"0":this.idStore.get(e.fromId);if(!i||!r)return void 0;let n=e.msg,a=e.attachData;switch(a.mentions&&Array.isArray(a.mentions)&&a.mentions.forEach((e=>{e.uid="-1"===e.uid?"-1":this.idStore.get(e.uid)})),a.quote&&(a.quote.ownerId=this.idStore.get(a.quote.ownerId)),s){case j.MSG_TEXT:a&&a.attach&&a.attach.action&&"rtf"==a.attach.action&&(a.attach.title||(a.attach.title=e.msg),n=a.attach);break;case j.MSG_PHOTO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case j.MSG_STICKER:n=a.attach||{};break;case j.MSG_GIF:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.title=l(n.title),n.type=l(n.type);break;case j.MSG_VOICE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.params=l(n.params),n.thumb=l(n.thumb),n.title=l(n.title),n.type=l(n.type);break;case j.MSG_VIDEO:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.type=l(n.type);break;case j.MSG_LOCATION:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.href=l(n.href),n.thumb=l(n.thumb),n.type=l(n.type);break;case j.MSG_DOODLE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.title=l(n.title);break;case j.MSG_CONTACT:n=a.attach||{},n.description=l(n.description),n.thumb=l(n.thumb);const t=n.action;"recommened.user"!==t&&"recommened.vip"!==t||(n.params=this.idStore.get(n.params));break;case j.MSG_FILE:n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action),n.description=l(n.description),n.thumb=l(n.thumb),n.type=l(n.type);break;case j.MSG_UNDO:n="";break;case j.MSG_OA:case j.MSG_ECARD:case j.MSG_POLL:n=a.attach;break;case j.MSG_ZINSTANT:if(!a.attach||!a.attach.params||-1==a.attach.params.indexOf("pcItem"))return void this.logger.zsymb(0,"3mo4WF","Skip invalid zinstant",null==e?void 0:e.globalMsgId);n=a.attach||{},n.childnumber=l(n.childnumber,0),n.action=l(n.action,""),n.description=l(n.description,""),n.title=l(n.title,""),n.href=l(n.href,""),n.thumb=l(n.thumb,""),n.params=l(n.params),delete n.childNumber}let o=null;if("chat.undo"==e.type&&e.attach)try{if(a.attach&&a.attach.params){let t=JSON.parse(a.attach.params).custom_message;if(t){t=JSON.parse(t);const s=t.highLightsV2;s.length&&(o=s[0]&&s[0].uid,o=this.idStore.get(o),o=o==this.uid?"0":o,e.type="chat.delete.everyone")}}}catch(h){this.logger.zsymb(18,"dJSAhi",(()=>["parseParams error:",{error:h}]))}const c={msgId:e.globalMsgId,zglobalMsgId:-1,cliMsgId:e.cliMsgId,msgType:e.type,status:"0"==i?j.MSG_DELIVERED:j.MSG_READ,notify:"1",mentions:a.mentions,quote:a.quote,content:n,ts:e.ts.toString(),uidFrom:i,dName:e.fromName,propertyExt:a.property,ttl:e.ttl};a.reference&&(c.reference=a.reference);const d=q.a.transformMessageFromServer(c,r);function l(e,t=""){return e instanceof Object&&Object.keys(e).length?t:e||t}d.localDttm=Date.now(),d.src=j.MSG_SRC.SYNC_MOBILE_DB,d.sequenceId=e.sequenseId,d.uidSenderDel=o,d.msgType!==j.MSG_UNKNOWN?t.push(d):this.logger.zsymb(0,"yiprtT",(()=>["skip message: unknown type",{id:d.cliMsgId,type:e.type}]))}verifyCrossMsg(e){const t=[],s=[],r=new Set;for(let o=0;o<e.length;o++){var i,n;const c=e[o];if(!c)continue;let d=!1;const l=e=>{e&&"-1"!==(e=e.toString())&&(this.idStore.get(e)||(d||(d=!0,t.push(c)),r.add(e)))};if(l(c.ownerId),l(c.fromId),!c.attachData){let e={};if(c.attach)try{e=JSON.parse(c.attach)}catch(a){}c.attachData=e}const h=c.attachData,u=null===(i=h.attach)||void 0===i?void 0:i.action;"recommened.user"!==u&&"recommened.vip"!==u||null===(n=h.attach)||void 0===n||!n.params||l(h.attach.params),h.mentions&&Array.isArray(h.mentions)&&h.mentions.forEach((e=>{l(e.uid)})),h.quote&&l(h.quote.ownerId),d||s.push(c)}return{waitForNoiseId:t,readyToInsert:s,idsToGetNoise:Array.from(r)}}async insertToDb(e){e=await this._filterDeletedMessages(e);const t=await this._insertMessage(e);return F.mediaRes.start(),await Promise.all([this._insertMedia(t.success),this._insertFilesToResDB(t.success)]),F.mediaRes.end(),await this._insertTTL(t.success),this._sendMediaMsgToMain(t.success),t}_insertMedia(e){F.writeMedia.start();const t=`${Z.c.TRANSFER_MOBILE}${Z.d.FROM_MSG}`;return c.ModuleContainer.resolve(Y.a).addMediasWhenTransferMessage(e,t,H.shouldUseNewMediaDBConfig).then((e=>(F.writeMedia.end(),e)))}_insertFilesToResDB(e){F.writeFileRes.start();const t=e.reduce(((e,t)=>(t.msgType===j.MSG_FILE&&e.push({msgId:t.msgId,userId:t.toUid,message:t.message,sendDttm:t.sendDttm,fromUid:t.fromUid,type:"file",cliMsgId:t.cliMsgId}),e)),[]);return(async(e,t)=>{try{let e=[],s=[];for(let r of t){const{res:t,ref:i,error:n}=P.toDb(r);n||(e.push(t),s.push(i))}e.length>0&&await x.a.insert("Res","res",e),s.length>0&&await x.a.insert("Res","ref",s)}catch{}})(this.resDB,t).then((e=>(F.writeFileRes.end(),e)))}async _insertTTL(e){const t=e.filter((e=>e.ttl&&e.ttl>0)),s=Q.b.createFromUid(this.uid).deriveTTLItems(t);if(t.length<=0)return;const r=await this.ttl.putMsgs(s);r.ok?this.logger.zsymb(3,"sg2JB-",["ttl insert success","dtJGgX"]):(this.logger.zsymb(21,"CQADHw",["ttl insert fail","tfDlWe"]),this.logger.zsymb(3,"YtkNyr",["ttl invalid {}, error {}","N9YK5j"],r.error.invalidItems.length,r.error.errorItems.length))}async _insertMessage(e){return F.writeMsgs.start(),x.a.insert("Core","message",e).then((e=>(F.writeMsgs.end(),e)))}async _filterExistsMessages(e){if(!e||!e.length)return[];const t={};e.forEach((({msgId:e,toUid:s})=>{void 0===t[s]&&(t[s]=[]),t[s].push(e)}));const s=Object.entries(t).map((([e,t])=>this.coreDB.Message.getMulti(t,{partition:e}))),r=await Promise.all(s).then((e=>e.flat())),i=new Set(r.map((e=>e&&e.msgId)));return e.filter((e=>!i.has(e.msgId)))}_sendMediaMsgToMain(e){if(!G.default.isWeb()){const t=X.default.getInstance().getItem(j.KEY_CONFIG_TRANSFER_AUTODL),{validDays:s}=t&&Object(K.a)(t),r=24*(s||J.default.auto_download_media_transfered.validDays)*60*60*1e3,i=e.filter((e=>this._isMediaMsg(e)&&!this._isAIStickerMessage(e)&&!this._isPhotoStickerMessage(e)&&this._isValidTime(e,r)));Array.isArray(i)&&i.length>0&&$zFeatures.transfer.notifyReceiveMediaMsgs(i)}}_isMediaMsg(e){var t;const s=e.msgType;if(s===j.MSG_CONTACT&&"recommened.link"===(null===(t=e.message)||void 0===t?void 0:t.action))return!0;return[j.MSG_PHOTO,j.MSG_PHOTO_2,j.MSG_DOODLE,j.MSG_FILE,j.MSG_VOICE,j.MSG_VIDEO].includes(s)}_isAIStickerMessage(e){return!1}_isPhotoStickerMessage(e){return!1}_isValidTime(e,t){const s=+e.sendDttm;return!(V.default.getTimeNow()-s>=t)}async _filterDeletedMessages(e){let t={},s=[];for(let n=0;n<e.length;n++){const r=e[n];r.msgType==j.MSG_UNDO?s.push(r):(t[r.toUid]||(t[r.toUid]=[]),t[r.toUid].push(r))}await this._sendUndo(s);let r=Object.keys(t);const i=[];for(let n=0;n<r.length;n++){const e=r[n];i.push(...t[e])}return i}async _sendUndo(e){}})||W)||W)||W)||W)||W;class te{constructor(e){this.noiseIdStore=void 0,this.importer=void 0,this.session=null,this.logger=void 0,this._searchIndexQueue=null,this.noiseIdStore=c.ModuleContainer.resolveToken(U),this.importer=c.ModuleContainer.resolveToken(ee);const t=c.ModuleContainer.resolve(l.ZLoggerFactory);this.logger=t.createZLogger("msg-sync",["importer",e])}async restoreConversations(e){const t=e.params.noiseUserId,s=e.params.password,r=this.doRestoreConversations.bind(this,e);return this.usingDatabase(t,s,r)}async restoreMessages(e){const t=e.params.noiseUserId,s=e.params.password,r=this.doRestoreMessages.bind(this,e);return this.usingDatabase(t,s,r)}async usingDatabase(e,t,s){let r,i;await this.noiseIdStore.init(e),await this.open(e,t);try{r=await s()}catch(n){i=n}if(await this.close(),i)throw i;return r}async open(e,t){await this.importer.close(),this.session={userId:e,UIN:t},await this.importer.open(e,t)}async close(){await this.importer.close()}indexSearch(e,t){return t.queueIndexSearch?this.searchIndexQueue.queueIdxs(e):O.a.executeMessageDbData(e)}get searchIndexQueue(){var e,t,s,r;this._searchIndexQueue||(null!==(e=this.session)&&void 0!==e&&e.userId&&null!==(t=this.session)&&void 0!==t&&t.UIN&&c.ModuleContainer.resolve(o.b).authenticate({userId:null===(s=this.session)||void 0===s?void 0:s.userId,UIN:null===(r=this.session)||void 0===r?void 0:r.UIN}),this._searchIndexQueue=new T.a);return this._searchIndexQueue}}class se extends te{constructor(){super("format-0"),this._backup=null,this._Logger=void 0}get Logger(){return this._Logger||(this._Logger=c.ModuleContainer.resolve(l.ZLoggerFactory).createZLogger("sync-msg",["import-format1"])),this._Logger}async doRestoreConversations(e){const{params:t,abort:s}=e,r=await this.getBackup(t.backupPath),i=await r.getAllConversations(),n=await r.getRespondedConversations(),a=new Set(n.map((e=>e.ownerId))),o=[],c=[];if(i.forEach((e=>{1===e.ownerType?o.push(e.ownerId):c.push(e.ownerId)})),await this.noiseIdStore.import({gids:o,uids:c}),s.aborted)throw new Error("aborted");const d=await r.getLastMsgForEachConversations();if(s.aborted)throw new Error("aborted");let l=await this.importer.insertMsgs(d);const h={},u=[],g=[];return i.forEach((e=>{const t=this.noiseIdStore.get(e.ownerId);if(t){const s=1===e.ownerType,r={plainId:e.ownerId,noisedId:t,isGroup:s,respondedByMe:a.has(e.ownerId),backupPath:""};u.push(r),h[t]=r}else g.push(e.ownerId)})),l.success.forEach((e=>{h[e.toUid]&&(h[e.toUid].lastMessage=e)})),l.fail.forEach((e=>{h[e.toUid]&&(h[e.toUid].lastMessage=e)})),u}async doRestoreMessages(e){const{params:t,checkpoint:s,abort:r,report:i}=e;if(!s||0!==s.format)throw new Error("invalid checkpoint");const n=new Map(t.conversations.filter((e=>!e.hasPreviewMsg)).map((e=>[e.noiseId,void 0]))),a=t.conversations.filter((e=>e.shouldIgnore)).map((e=>e.plainId));let o=s.currentSeq,c=s.maxSeq,d=s.minSeq,l=s.syncedConversations,h=0,u=s.syncedMessages||0;const g=await this.getBackup(t.backupPath),m=await g.countMessageFrom(d,a);let p=await g.countMessageFrom(o,a),f=m,I=!1;for(;;){if(r.aborted)return{trackInfo:{}};let e=await g.getMessages(o,d,a,100);if(0===e.length)f=0;else{e[0].sequenseId>c&&(c=e[0].sequenseId);for(let t=e.length-1;t>=0;t--){const s=e[t].sequenseId;if(s<o){o=s;break}}this.importer.queueNewMessages(e),f-=e.length}let s=await this.importer.processImportQueue(I);if(0===s.queued.length){if(s.hasMore){I=!0;continue}}else I=!1;if(0===s.queued.length&&0===f){(0===d||d>o)&&(d=o);return i(100,{format:0,minSeq:d,maxSeq:c,currentSeq:o,syncedMessages:u,syncedConversations:l}),{trackInfo:{}}}let b=new Map;for(let t=0;t<s.inserted.length;t++){const e=s.inserted[t];if(n.has(e.toUid)){const t=n.get(e.toUid);(!t||t<e.sequenceId)&&(b.set(e.toUid,e),n.set(e.toUid,e.sequenceId))}}if(b.size>0){u+=b.size;const e=new E.a(Array.from(b.values()));await e.run()}p+=s.validMsgCount;const w=p/m,M=Math.round(95*w);M!==h&&(h=M,s.minSeqId>0&&(this.Logger.zsymb(3,"FAF_zR",["checkpoint: {} {}/{} ({}%)","Xl3TAt"],s.minSeqId,p,m,M),i(M,{format:0,minSeq:d,maxSeq:c,currentSeq:o,syncedMessages:u,syncedConversations:l}))),await this.indexSearch(s.inserted,{queueIndexSearch:t.meta.queueIndexSearch}),await new Promise((e=>setTimeout(e,50)))}}async close(){return this._backup&&await this._backup.close(),super.close()}async getBackup(e){return this._backup||(this._backup=new re(e),await this._backup.open()),this._backup}}class re{constructor(e){this._db=void 0,this._db=$znode.sqlite3.createConnection(e)}close(){return this._db.close()}async open(){await this._db.open(),await this._db.runQuery(ne),await this._db.runQuery(ae)}async getLastMsgForEachConversations(){return this._db.getAllStatementResult(oe)}async getAllConversations(){return(await this._db.getAllQuery(le)).filter((e=>/^\d+$/.test(e.ownerId)))}async getRespondedConversations(){return this._db.getAllQuery(he)}async getMessages(e,t,s,r){return this._db.getAllStatementResult(ce,[e,t,s.join(","),r])}async countMessageFrom(e,t){const s=await this._db.getStatementResult(de,[e,t.join(",")]);return s?s.count:0}}const ie='type != "chat.webcontent" AND type != "chat.livelocation" AND type != "chat.video.live.msg"',ne='CREATE INDEX IF NOT EXISTS "sequenseId" ON "chats" ("sequenseId" DESC)',ae='CREATE INDEX IF NOT EXISTS "ts" ON "chats" ("ts" DESC)',oe=`SELECT chats.* FROM chats INNER JOIN (SELECT ownerId, MAX(ts) as maxTs from chats WHERE ${ie} GROUP BY ownerId) AS latest ON chats.ts = latest.maxTs ORDER BY chats.ts DESC`,ce=`SELECT * FROM chats WHERE sequenseId < (?) AND sequenseId > (?) AND cliMsgId NOT NULL AND ownerId NOT IN (?) AND ${ie} ORDER BY sequenseId DESC LIMIT (?)`,de=`SELECT count(*) as count FROM chats WHERE sequenseId > (?) AND cliMsgId NOT NULL AND ownerId NOT IN (?) AND ${ie} ORDER BY sequenseId DESC`,le="SELECT ownerId, ownerType, ts  FROM threads",he="SELECT DISTINCT ownerId from chats WHERE userId = fromId";var ue=s("nhJq");class ge extends S.b{constructor(e){super({type:"RELOAD_MESSAGE",params:e})}}let me=function(e){return e[e.Text=0]="Text",e[e.Doodle=2]="Doodle",e[e.Photo=3]="Photo",e[e.Photo_V2=4]="Photo_V2",e[e.Voice=6]="Voice",e[e.Sticker=10]="Sticker",e[e.Contact=12]="Contact",e[e.OA=15]="OA",e[e.Location=18]="Location",e[e.Video=19]="Video",e[e.ECard=21]="ECard",e[e.File=22]="File",e[e.Gift=23]="Gift",e[e.Webcontent=24]="Webcontent",e[e.VideoLive=25]="VideoLive",e[e.PhotoV2=31]="PhotoV2",e[e.ChatDelete=33]="ChatDelete",e[e.Undo=36]="Undo",e}({});const pe={0:"webchat",2:"chat.doodle",3:"chat.photo",4:"chat.photo",6:"chat.voice",10:"chat.sticker",12:"chat.recommended",15:"chat.list.action",18:"chat.location.new",19:"chat.video.msg",20:"webchat",22:"share.file",23:"chat.gif",24:"chat.webcontent",25:"chat.video.live.msg",26:"group.poll",31:"chat.photo",33:"chat.delete",36:"chat.undo"};class fe extends S.b{constructor(e){super({type:"RELOAD_MEDIA",params:e})}}const Ie=$znode.nativelibs.dbUtils(),be=$znode.path;class we extends te{constructor(){super("format-1"),this._backup=null}async doRestoreConversations(e){this.searchIndexQueue.pause();const{params:t,abort:s}=e,r=await this._getBackup(t.backupPath,t.plainUserId,t.noiseUserId);let i=await r.getAllConversations();const n=[],a=[];if(i.forEach((e=>{1===e.ownerType?n.push(e.ownerId):a.push(e.ownerId)})),await this.noiseIdStore.import({gids:n,uids:a}),s.aborted)throw new Error("aborted");const o=await r.getMetaDataConversations(i),c=r.getRespondedByMeSet();if(s.aborted)throw new Error("aborted");i=i.filter((e=>o[e.ownerId]&&o[e.ownerId].numOfMsg>0));const d=i.map((e=>o[e.ownerId].msg)),l=await this.importer.insertMsgs(d),h={},u=[],g=[];return i.forEach((e=>{const t=this.noiseIdStore.get(e.ownerId);if(t){const s=1===e.ownerType,r={plainId:e.ownerId,noisedId:t,isGroup:s,respondedByMe:c.has(e.ownerId)};u.push(r),h[t]=r}else g.push(e.ownerId)})),l.success.forEach((e=>{h[e.toUid]&&(h[e.toUid].lastMessage=e)})),l.fail.forEach((e=>{h[e.toUid]&&(h[e.toUid].lastMessage=e)})),await this.indexSearch(l.success,{queueIndexSearch:t.meta.queueIndexSearch}),u}async doRestoreMessages(e){this.searchIndexQueue.pause(),F.reset(),F.unlock(),F.total.start();const{params:t,checkpoint:s,abort:r,report:i}=e;if(!s||1!==s.format)throw new Error("invalid checkpoint");let n=t.conversations.filter((e=>!e.shouldIgnore)),a=t.meta.viewingConversation;const o=()=>{if(a){const t=(e=a,n.find((t=>t.noiseId===e)));if(this.logger.zsymb(0,"g5XYtC",`getViewingConversation ${a} ${JSON.stringify(t)}`),t)return t}var e;return null};let c,d=s.priorities;function l(){if(d.length>0){let e=d[0];const t=o();return t?(a=null,t):n.find((t=>t.plainId===e))}return n[0]}function h(e){return d=d.filter((t=>t!==e.plainId)),n=n.filter((t=>t.noiseId!==e.noiseId)),d}e.onParamsChange((e=>{e&&e.meta&&e.meta.viewingConversation&&(this.logger.zsymb(0,"ORh45y",`viewing conversation changed to ${e.meta.viewingConversation}`),a=e.meta.viewingConversation)}));const u=await this._getBackup(t.backupPath,t.plainUserId,t.noiseUserId);function g(e){return Math.floor(e/t.meta.numberOfMessages*95)}let m=g(s.syncedMessages);do{if(c=l(),c){let e=g(s.syncedMessages),n=!1;s.syncingConversation=c.noiseId,i(e,s);const a={ownerId:c.plainId,ownerType:c.isGroup?1:0};this.logger.zsymb(0,"Q8lxdm",`restoring ${c.plainId}, ${c.noiseId}`);try{n=await this.restoreMessagesOfConversation(a,s,u,t.meta.queueIndexSearch,!c.hasPreviewMsg,r,(()=>{const e=g(s.syncedMessages);m!==e&&(m=e,i(e,s))}))}catch(p){this.logger.zsymb(18,"TMEKaB",(()=>[`restore error: ${c.plainId}`,{error:p.message||p}]))}if(s.priorities=h(c),this.logger.zsymb(0,"-FZJhA",`ReloadMessageTask ${n} ${c.noiseId}`),n){s.updatedConversation++;new ge({convId:c.noiseId,fromTs:0,toTs:0}).run();new fe({convId:c.noiseId,abc:"abc"}).run()}e=g(s.syncedMessages),i(e,s)}else if(d.length>n.length){this.logger.zsymb(0,"tSl8gU","detect invalid priority conv "+(n.length-d.length));const e=new Set(n.map((e=>e.plainId))),t=[];for(let s=0;s<d.length;s++)e.has(d[s])&&t.push(d[s]);d=t,s.priorities=t}}while(d.length>0&&!r.aborted);return s.syncedConversations=t.meta.numberOfConversations,i(100,s),F.total.end(),F.print(),{trackInfo:F.getSnapShot()}}async restoreMessagesOfConversation(e,t,s,r,i,n,a){if(!t||1!==t.format)throw new Error("invalid checkpoint");let o=t.maxSeq,c=!1,d=0,l=t.currentSeq[e.ownerId]||Number.MAX_SAFE_INTEGER,h=!1;F.countMsg.start();let u=await s.getRemainingMessages(e,l);for(F.countMsg.end(),this.importer.resetLastGlobalMsgId();;){if(n.aborted)return h;if(u>0){let r=await s.getMessages(e,l,t.minSeq,d,2e3);if(0===r.length)u=0;else{d=r[r.length-1].cliMsgId,(0===o||r[0].ts>o)&&(o=r[0].ts);for(let e=r.length-1;e>=0;e--){const t=r[e].ts;if(t<l){l=t;break}}t.currentSeq[e.ownerId]=l,this.importer.queueNewMessages(r),u-=r.length}}let g=await this.importer.processImportQueue(c);if(0===g.queued.length){if(g.hasMore){c=!0;continue}}else c=!1;if(t.syncedMessages+=g.validMsgCount,t.importedMessages+=g.inserted.length,h=h||g.inserted.length>0,0===g.queued.length&&u<=0){delete t.currentSeq[e.ownerId],0===t.maxSeq?t.maxSeq=o:t.maxSeq=Math.max(t.maxSeq,o);let r=await s.getFirstMessageTimeStamp(e);return 0===t.minSeq?t.minSeq=r:t.minSeq=Math.min(t.minSeq,r),h}if(i&&g.inserted.length>0){let e=g.inserted[0];for(let s=1;s<g.inserted.length;s++){const t=g.inserted[s];t.sendDttm>e.sendDttm&&(e=t)}const t=new E.a([e]);await t.run(),i=!1}F.indexSearch.start(),await this.indexSearch(g.inserted,{queueIndexSearch:r}),F.indexSearch.end(),a(),await new Promise((e=>setTimeout(e,10)))}}async close(){return this._backup&&await this._backup.close(),super.close()}async _getBackup(e,t,s){return this._backup||(this._backup=new Me(e,t,s,this.logger),await this._backup.open()),this._backup}}class Me{constructor(e,t,s,r){this.path=e,this.plainUserId=t,this.noiseUserId=s,this.logger=r,this._currentBackup=null,this._responsedByMe=new Set}async open(){}async close(){this._currentBackup&&(await this._currentBackup.close(),this._currentBackup=null)}async getFirstMessageTimeStamp(e){const t=await this._getBackupOfConversation(e);return t?t.getFirstMessageTimeStamp():0}async getRemainingMessages(e,t){const s=await this._getBackupOfConversation(e);return s?s.countMessages(t):0}async getMessages(e,t,s,r,i){const n=await this._getBackupOfConversation(e);return n?n.getMessages(t,s,r,i,e.ownerId):[]}async getAllConversations(){const e=[],t=await ue.c(this.path);for(const s of t)if(s.endsWith(".db")){const t="g"===s[0]?1:0,r=t?6:0,i=s.length-3,n=s.substring(r,i);e.push({ownerId:n,ownerType:t})}return e}async getMetaDataConversations(e){const t={},s=Date.now();for(const i of e){const e=await this._getBackupOfConversation(i);if(e)try{const r=await e.getMessages(s,1,0,1,i.ownerId),n=await e.countMessages(s);if(r.length>0){t[i.ownerId]={msg:r[0],numOfMsg:n};await e.hasResponsedByUser(this.plainUserId)&&this._responsedByMe.add(i.ownerId)}}catch(r){if(this.logger.zsymb(18,"wGfIuc",`read conv failure: ${r.message}`),11!==r.errno)throw r}}return t}getRespondedByMeSet(){return this._responsedByMe}async _getBackupOfConversation(e){return this._currentBackup&&this._currentBackup.noiseId===e.ownerId||(this._currentBackup&&await this._currentBackup.close(),this._currentBackup=await this._getNewBackupOfConversation(e)),this._currentBackup}async _getNewBackupOfConversation(e){const t=e.ownerId,s=1===e.ownerType?`group_${t}`:t,r=be.join(this.path,`${s}.db`),i=new ye({path:r,noiseId:t,noiseUserId:this.noiseUserId,plainUserId:this.plainUserId,logger:this.logger});return await i.open(),i}}class ye{constructor(e){this.noiseUserId=void 0,this._db=void 0,this.plainUserId=void 0,this.logger=void 0,this.noiseId=void 0,this._db=$znode.sqlite3.createConnection(e.path),this.logger=e.logger,this.noiseUserId=e.noiseUserId,this.plainUserId=e.plainUserId,this.noiseId=e.noiseId}close(){return this._db.close()}open(){return this._db.open()}async getFirstMessageTimeStamp(){const e=await this._db.getAllQuery(ve);return 0===e.length?0:e[0].TimeStamp}async countMessages(e){const t=[e],s=await this._db.getStatementResult(Ee,t);return s?s.count:0}async getMessages(e,t,s,r,i){const n=[e,s,r];F.readSQL.start();const a=await this._db.getAllStatementResult(Se,n);F.readSQL.end();const o=[];return F.convertVersion.start(),a.forEach((e=>{const t=this.convertCrossV2ToCrossV1(e);t&&o.push(t)})),F.convertVersion.end(),this.logger.zsymb(0,"V3mJx-",`getMessages: ${i}, old:${a.length}, new:${o.length}`),o}async hasResponsedByUser(e){const t=await this._db.getQuery(Te(e));return!!t&&t.count>0}convertCrossV2ToCrossV1(e){const t=pe[e.MsgType];if(!t)return null;const s=Ie.parseBinNet(e.BinNet)||{};if(s.result>0)return this.logger.zsymb(21,"5a0LSC",["ParseBinNetFail","jsA59O"],{message:s.error_message,result:s.result,innerError:s.inner_error}),null;const r=s.data;return r.attachs&&r.attachs.length>0&&r.attachs[0]&&(e.MsgType===me.OA?r.attach=r.attachs:(r.attach=r.attachs[0],e.MsgType!==me.Sticker&&r.attach&&delete r.attach.catId)),{fromId:e.SenderId.toString(),fromName:"",attach:"{}",attachData:r,globalMsgId:e.GlbMsgId,cliMsgId:e.CliMsgId,msg:e.MsgContent,ownerId:this.noiseId,ownerType:0,sequenseId:e.TimeStamp,ts:e.TimeStamp,ttl:e.TTL,type:t,userId:this.plainUserId}}}const _e=[20,21,25,26,29,32,34,35,45,51,52].map((e=>`MsgType != ${e}`)).join(" AND "),ve="SELECT TimeStamp FROM ChatContent ORDER BY TimeStamp ASC LIMIT 1",Se=`SELECT * FROM ChatContent WHERE TimeStamp <= (?) AND MsgStatus > 0 AND CliMsgId NOT NULL AND CliMsgId != (?) AND ${_e} ORDER BY TimeStamp DESC LIMIT (?)`,Ee=`SELECT count(*) as count FROM ChatContent WHERE TimeStamp <= (?) AND MsgStatus > 0 AND cliMsgId NOT NULL AND ${_e}`,Te=e=>`SELECT count(*) as count FROM ChatContent WHERE SenderId = ${e} AND MsgStatus > 0 AND ${_e}`;function Oe(e){try{if(0===e)return new se;if(1===e)return new we}catch(t){throw t}throw new Error(`Unsupported format: ${e}`)}var Ne;Object(g.i)()(Ne=Object(c.injectable)()(Ne=class extends S.a{getType(){return"RESTORE_CONVERSATIONS"}async execute(e){if(e.abort.aborted)return Promise.reject(new Error("Aborted"));const t=Oe(e.params.format);var s;return s=e.params.shouldUseNewMediaDBFlowConfig,H.shouldUseNewMediaDBConfig=s,t.restoreConversations(e)}})||Ne);var De;Object(g.i)()(De=Object(c.injectable)()(De=class extends S.a{getType(){return"RESTORE_MESSAGES"}async execute(e){if(e.abort.aborted)return Promise.reject(new Error("Aborted"));return Oe(e.params.format).restoreMessages(e)}})||De);var ke;const Ce=$znode.nativelibs.dbUtils();Object(g.i)()(ke=Object(c.injectable)()(ke=class extends S.a{getType(){return"DECRYPT_BACKUP"}async execute(e){return e.abort.aborted?Promise.reject(new Error("Aborted")):this._decyptBackup(e)}async _decyptBackup(e){const{params:t,report:s}=e;return await Object(ue.b)(t.outputPath),0===t.format?this._decryptBackupFormat0(t.inputPath,t.outputPath,t.privateKey):this._decryptBackupFormat1(t.inputPath,t.outputPath,t.privateKey,t.numberOfConversationsCount,s)}async _decryptBackupFormat0(e,t,s){const{result:r,err_message:i}=Ce.decompressAndDecryptDb(e,t,s);return 0===r?t:Promise.reject({error:r,message:i})}async _decryptBackupFormat1(e,t,s,r,i){t=await Object(ue.a)(t);let n=0;const{result:a,inner_error:o,error_message:c}=Ce.decompressAndDecryptDb_V2(e,t,s.toUpperCase(),(()=>{n++;const e=Math.floor(Math.round(n/r*100));i(e)}));return 0===a?t:Promise.reject({error:a,inner_error:o,message:c})}})||ke);s("Ceyj"),s("Q/Ir");var Le,Ae=s("fNnj");Object(g.i)()(Le=Object(c.injectable)()(Le=class extends S.a{getType(){return"ZCLOUD"}async execute(e){let{params:t}=e;if(t){let{method:e,data:s}=t;return(new Ae.a)[e](s)}throw Error("zcloud worker no params")}})||Le);s("rBRb");var Re,Fe=s("jbAT"),Ue=s("zLd2"),je=s("5txd");Object(c.injectable)()(Re=Object(c.singleton)(Ue.c)(Re=function(e,t){return Object(c.inject)(Fe.b)(e,void 0,0)}(Re=function(e,t){return Object(c.inject)(l.ZLoggerFactory)(e,void 0,1)}(Re=Reflect.metadata("design:type",Function)(Re=Reflect.metadata("design:paramtypes",[void 0===Fe.a?Object:Fe.a,void 0===l.ZLoggerFactory?Object:l.ZLoggerFactory])(Re=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,this._logger=t.createZLogger(Ue.b,["manage-utils-media-in-ui"]),this._log=Object(je.a)(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}})||Re)||Re)||Re)||Re)||Re);s("37f1")},O6t0:function(e,t,s){"use strict";(function(e){var t=s("c8uc"),r=s("AsUd");e&&e.env;const i=12;let n=0;function a(){return new Promise(((e,s)=>{let r=t.a.isLoadedLib();r&&r.ok?(c("load lib success!!"),$zdb.sendResponse({act:i}),$zdb.updateAvailableSqliteState(!0),o(!0,91002,0,0,3==n?0:3,Date.now()),e(r)):n>0?(n--,c("load lib fail go retry "+n+" "+(r?r.error:" _resp = null")),o(!1,91002,0,0,2,Date.now()),setTimeout((()=>{a()}),15e3)):(c("load lib fail "+(r?r.error:" _resp = null")),$zdb.updateAvailableSqliteState(!1),o(!1,91002,0,0,1,Date.now()),s(r))}))}function o(e,t,s=0,r,i,n){$zlogger.crossQosLog({success:e,commandId:t,subCommandId:s,duration:r,errorCode:i,startTime:n})}function c(e){$zlogger.sendLog("info","shared-worker: "+e)}!function(){try{const e={increaseSuccess:(e,t,s,r=[],i={})=>{$zlogger.crossQosLog({success:!0,commandId:e,subCommandId:t,duration:s,params:r,options:i})},increaseFailed:(e,t,s,r,i,n=[],a={})=>{$zlogger.crossQosLog({success:!1,commandId:e,subCommandId:t,duration:s,errorCode:r,startTime:i,params:n,options:a})}},{MetriczDriver:t}=s("rkiK");t.registerQosControl(e)}catch(e){}}(),$zsub.$zdb.processRequest(((e,s)=>{!function(e){e&&(e.constructor===Array?e.forEach((e=>{t.a.receiverEvent(e)})):t.a.receiverEvent(e))}(s)})),$zapp.onPing((()=>Date.now())),$zlogger.onReceiveViewerkey(((e,t)=>{r.j("viewer_key",t)})),document.addEventListener("load",(()=>{a()})),c("[pid][shared-worker]"+e.pid),$zapp.registerProcess("dbtask",e.pid)}).call(this,s("8oxB"))},c8uc:function(e,t,s){"use strict";(function(e){var r=s("VTBJ"),i=s("ES/k"),n=s("4prX"),a=s("AtyM"),o=s("Mgpg"),c=s("jDHv");e&&e.env;let d=$znode.sqlite3;const l=s("wBhU"),h=c.ModuleContainer.resolve(o.ZLoggerFactory).createZLogger("dbtask",["manager"]),u={QUERY:1,ADD_DATA:2,PRE_DATA:3,INIT:4,GET_INDEX:5,ABORTED_SEARCH:6,MIGRATE:7,DEL_OLDDATA:8,DELETE_ALL:9,PRE_TAGGING:10,INIT_TAGGING:11,PROCESS_READY:12,QUERY_GLOBAL_MSG:13,CLOSE_DB:14,DELETE_DATA:15,PURE_QUERY:18,QUERY_GLOBAL_MSG_V3:19,COUNT_TOTAL:20},g={[u.QUERY]:function(e,t,s,n){return new Promise(((a,o)=>{let c;N(e,n),c=t?()=>L(s,n):()=>!1;let l=i.a.formatTextSearch(e);if(l=l.trim(),!l){let e=n.filter;if(!e||!0!==e.searchForEmpty)return o("text is null")}let h=l.split(" ");if((n=n||{}).progress){let e,t=!0,i=0,l=n.configs&&n.configs.limit?n.configs.limit:G,u=n.configs&&void 0!==n.configs.offset?n.configs.offset:0,g=n.configs?Object(r.a)({},n.configs):{},m=[];const p=()=>{clearTimeout(e),e=null,a(m)},f=(a,u)=>{if(c&&c())return o("aborted");d.query(h,n.filter,Object(r.a)(Object(r.a)({},g),{},{limit:u,offset:a}),c).then((r=>{if(c&&c())return o("aborted");l-=u,r&&r.constructor==Array?(m.push.apply(m,r),r.length>=u&&l>0?(t?(t=!1,i=m.length,k(m,s)):e||(e=setTimeout((()=>{e=null,i<m.length&&(i=m.length,k(m,s))}),2e3)),f(a+r.length,Math.min(100,l))):p()):p()})).catch((e=>{N("_doQuery",e),p()}))};f(u,Math.min(100,l))}else n.configs&&n.configs.limit||(n.configs=n.configs?n.configs:{},n.configs.limit=G,n.configs.offset=n.configs.offset||0),a(d.query(h,n.filter,n.configs,c))}))},[u.ADD_DATA]:function(e){return Promise.reject("not impl")},[u.INIT]:function(e){return new Promise(((t,s)=>{if(N(e),d.isLoadedLib(),!e.userId||!e.UIN)return s("invalid init data "+e.userId+" "+e.UIN);if(U){if(U.userId!=e.userId||U.UIN!=e.UIN)return C("open new db last"+e.userId),U={userId:e.userId,UIN:e.UIN},C("new Session!!"),m.length>0&&(C("promote last task priority"),m.forEach((e=>{e.priority=E}))),m.unshift({act:u.CLOSE_DB,taskId:p.next(),isAbort:!1,additions:null,priority:E,isMicro:!0}),m.unshift({act:u.INIT,data:e,taskId:p.next(),isAbort:!1,additions:null,priority:E,isMicro:!0}),t();if(!j){C("open new db now!!!"+e.userId),j={userId:e.userId,UIN:e.UIN};const s=Date.now(),r=a.a.now();return t(d.openDb(e.userId,e.UIN).catch((t=>{throw l&&e.onSentry&&l.withScope((function(e){e.setTag("db-error","open"),e.setLevel("error"),l.captureException(t)})),n.default.increaseFailed(91002,0,a.a.now()-r,4,s),t.errno&&n.default.increaseFailed(91002,0,a.a.now()-r,1e4*t.errno+4,s),t})))}return C("reopen the same with last"+e.userId),t()}U={userId:e.userId,UIN:e.UIN},C("open db first time now!!!"+e.userId),j={userId:e.userId,UIN:e.UIN},t(d.openDb(e.userId,e.UIN,e.onSentry))}))},[u.PRE_DATA]:function(e,t=!1,s,n,a){return N(e),new Promise(((t,s)=>{if(!e||0==e.length)return t();if(e.length>M){let t=e.slice(M,e.length);A({act:u.PRE_DATA,data:t,taskId:p.next(),isAbort:!1,additions:n,priority:a}),e=e.slice(0,M)}let o=[];e.forEach((e=>{if(!e||e.constructor!==Object)return;let t=i.a.getTextFromMessage(e.content);t&&o.push(Object(r.a)(Object(r.a)({},e),{},{content:t}))}));const c=!1;Date.now();o.length?d.writev2(o).then((()=>{t()})).catch((e=>{s(e)})):t()}))},[u.GET_INDEX]:function(e){return Promise.reject("not impl")},[u.MIGRATE]:function(e){return Promise.reject("not impl")},[u.DEL_OLDDATA]:function(){return Promise.reject("not impl")},[u.DELETE_ALL]:function(){return Promise.reject("not impl")},[u.QUERY_GLOBAL_MSG]:function(e,t,s,r){return new Promise(((n,a)=>{let o;o=t?()=>L(s,r):()=>!1;let c=i.a.formatTextSearch(e);if(c=c.trim(),!c)return a("text is null");if(r||(r={}),r.progress){let e=0;const t=[10,20,50],i=(e,t)=>({data:e,page:t}),l=(c,h,u,g=30)=>{if(o())a("aborted");else if(u>=h.length)n(i(null,e));else{const m=Math.min(u+g,h.length);d.queryGlobalMessageV2(c,h.slice(u,m),r.configs,o).then((r=>{r?(k(i(r,e),s),e>=1?setTimeout((()=>{l(c,h,u+g,t[Math.min(++e,t.length-1)])}),100):l(c,h,u+g,t[Math.min(++e,t.length-1)])):n(i(null,e))})).catch((e=>{a(e)}))}};(()=>{d.getConversationMatch(c,o).then((s=>{if(s&&s.length>0){s.sort(((e,t)=>t.ts-e.ts));let e=[];s.forEach((t=>{e.push(t.convId)})),e.length>0&&l(c,e,0,t[0])}else n(i(null,e))})).catch((e=>{a(e)}))})()}else n(d.queryGlobalMessageV2(c,r.listConvs,r.configs,o))}))},[u.CLOSE_DB]:function(){return new Promise(((e,t)=>{j?(C("go close db "+j.userId),e(d.closeDb(j.userId,j.UIN))):t("close what?? curr: "+JSON.stringify(j)),j=null}))},[u.DELETE_DATA]:function(e){return d.deleteRow(e.msgId)},[u.PURE_QUERY]:function(e){return new Promise(((t,s)=>{d.pureQuery(e).then((e=>{e?t(e):s(null)})).catch((e=>{s(e)}))}))},[u.QUERY_GLOBAL_MSG_V3]:function(e,t,s,r){return new Promise(((n,a)=>{let o;o=t?()=>L(s,r):()=>!1;let c=i.a.formatTextSearch(e);if(c=c.trim(),!c)return a("text is null");const l=(e,t)=>({data:e,page:t});O(`_queryGlobalMessageV3, kw: ${e}`);let h=r.configs.filter;d.queryGlobalMessageV3(c,o,h,O).then((t=>{O(`_queryGlobalMessageV3 SUCCESS, kw: ${e}, total res: ${t?t.length:"empty"}`),t?(k(l(t,0),s),n(l(t,0))):n(l(null,0))})).catch((e=>{O("_queryGlobalMessageV3 Error",JSON.stringify(e)),a(e)}))}))},[u.COUNT_TOTAL]:function(){return new Promise(((e,t)=>{d.countTotal().then((s=>{s?e(s):t(null)})).catch((e=>{t(e)}))}))}};let m=[];const p=new class{constructor(){this.value=1}next(){return this.value++,this.value}};let f=new Map;const I=1,b=2;let w=2;const M=300;let y=null;const _="FLAG_SLEEP_TOO_LONG",v=6e4,S=6e4,E=100,T=!0;function O(...e){T&&h.zsymb(0,"ibKLSF","[search]",...e)}function N(){}var D=e=>{$zdb.sendResponse(e)};function k(e,t){D({progress:!0,taskId:t,data:e})}function C(e){D({logErr:!0,data:e})}function L(e,t){return t&&t.filter?e!=f.get("with-filter"):e!=f.get("_")}function A(e){let t=!1;[u.QUERY,u.QUERY_GLOBAL_MSG,u.QUERY_GLOBAL_MSG_V3].indexOf(e.act)>=0&&(e.additions&&e.additions.filter?f.set("with-filter",e.taskId):f.set("_",e.taskId));for(let i=0;i<m.length;++i)if(s=m[i],r=e,s.priority>=r.priority){m.splice(i,0,e),t=!0;break}var s,r;t||m.push(e),function(){if(w==I)return;w=I,F()}()}function R(e,t,s){try{e.callback&&D({success:s,data:t,taskId:e.taskId}),s||C(" err "+e.act+" "+t)}catch(r){C(" _afterAction "+e.act+": "+r)}F()}function F(){if(0==m.length)return w=b,y&&clearTimeout(y),void(y=setTimeout((()=>{C(_),y=null}),v));y&&(clearTimeout(y),y=null);let e=m.pop();if(!e||"object"!=typeof e)return C("ev is not Object"),void F();let t=g&&e.act&&g.hasOwnProperty(e.act)?g[e.act]:null;if("function"==typeof t){let r=!1,i=setTimeout((()=>{i=null,r=!0,C("timeout event "+e.act),R(e,"timeout!!",!1)}),S);const n=()=>(i&&(clearTimeout(i),i=null),r);try{t(e.data,e.isAbort,e.taskId,e.additions,e.priority).then((t=>{n()||R(e,t,!0)})).catch((t=>{n()||R(e,t,!1)}))}catch(s){R(e,s,!1)}}else R(e,"not support this function "+e.act,!1)}let U,j;const G=1e4;t.a={receiverEvent:function(e){switch(e.act,e.act){case u.ABORTED_SEARCH:f=new Map,m=m.filter((e=>e.act!=u.QUERY));break;case u.DELETE_ALL:m=[],A(e);break;default:A(e)}},isLoadedLib:()=>d.isLoadedLib()}}).call(this,s("8oxB"))}});
//# sourceMappingURL=sourcemaps/shared-worker.68d4094dd82c39ea63b1.js.map