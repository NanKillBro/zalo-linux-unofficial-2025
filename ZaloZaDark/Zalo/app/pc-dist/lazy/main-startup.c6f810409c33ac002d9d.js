(this.webpackJsonp=this.webpackJsonp||[]).push([[27],{26:function(e,t){},27:function(e,t){},"3OF5":function(e,t,s){"use strict";s.r(t);s("TlRV"),s("m+NF"),s("bO0B"),s("33YB"),s("jmmm"),s("GSxB"),s("xDXR"),s("WrSY");var a=s("jDHv"),i=s("W8Xk"),n=s("igA5");const r=Object(a.define)("kv-cache"),o=Object(a.define)("kv-cache-in-mem");var c;class l{constructor(e){this._prefix=void 0,this._prefix=`${e}-kv-db`}_buildKey(e){return`${this._prefix}-${e}`}async setItem(e,t){const s=this._buildKey(e),a=n.default.getInstance();return await a.setItemAsync(s,i.b(t)),t}async getItem(e){const t=this._buildKey(e),s=n.default.getInstance(),a=await s.getItemAsync(t);return Promise.resolve(a?i.a(a):void 0)}async removeItem(e){const t=this._buildKey(e),s=n.default.getInstance();return await s.removeItemAsync(t),this}}Object(a.singleton)(r)(c=class{createCache(e){return new l(`${e}`)}});var d,u=s("ndDP");class h{constructor(e,t){this._unused_name=e,this._lru=void 0,this._lru=new u.default(t)}setItem(e,t){return this._lru.set(e,t),Promise.resolve(t)}getItem(e){return Promise.resolve(this._lru.get(e))}removeItem(e){return this._lru.delete(e),Promise.resolve(this)}}Object(a.singleton)(o)(d=class{constructor(){this._registry={}}createCache(e,t){return this._registry[e]||(this._registry[e]=new h(e,t)),this._registry[e]}});s("LyOm"),s("lNuO"),s("xir9"),s("4Vil"),s("0rWR"),s("Lq8m"),s("EicM"),s("nUpV"),s("5yGw"),s("hRcX"),s("/2rj"),s("gpNb"),s("rhBN"),s("BP4/"),s("cF85"),s("7g9m"),s("oqw1");var g,m=s("8/YW"),p=s("Hw41"),f=s("xM06"),v=s("fcdz"),_=s("Ofqi"),b=s("aEKn");Object(m.e)()(g=Object(m.f)()(g=Object(a.singleton)()(g=Reflect.metadata("design:type",Function)(g=Reflect.metadata("design:paramtypes",[])(g=class{constructor(){this.corruptionSignalConsumer=void 0,this.corruptionAnalyzeConsumer=void 0,this.corruptionSignalConsumer=b.a.getInstance(),this.corruptionAnalyzeConsumer=_.a.getInstance()}onApplicationStart(){this.install()}onAuthenticated(e){this.corruptionAnalyzeConsumer.authenticate(e._session)}async install(){const e=a.ModuleContainer.resolve(p.b);(await e.getPort()).handleMessage((e=>this.handleRequest(e)))}async handleRequest(e){const{typeID:t}=e;if(t===f.k){const{type:t,data:s}=e.data;switch(t){case f.b:return this.corruptionAnalyzeConsumer.processAnalyzeCorruption(s.database);case f.C:return this.corruptionSignalConsumer.processSignalCorruption(s.corruptionInfo)}}return v.b}})||g)||g)||g)||g);s("9AEM");var I=s("VTBJ"),y=s("teaq");const S=Object(a.define)("database-transform-reporter"),C=Object(a.define)("database-transform-migrate");var E=s("Uzj0"),O=s("wH4e"),M=s("8gV8"),T=s("yi2h"),R=s("XB6V"),w=s("h0S/"),L=function(e){return e.NotStart="NotStart",e.Running="Running",e.Paused="Paused",e.Stoped="Stoped",e.Finished="Finished",e}(L||{});const D={gapTime:200,batchSize:100,version:0};class A{constructor(e,t,s){this.scope=e,this.dbName=t,this.tableConfig=s}getState(){return M.a.create(this.scope,this.dbName,this.tableConfig)}shouldResumeMigrate(e){return this.getState().then((t=>{let s=!1;return e==t.getCurrentVersion()&&(s=!t.isFinishedMigrate()),s}))}shouldUpgradeMigrate(e){return this.getState().then((t=>{const s=t.isFinishedMigrate(),a=e==t.getCurrentVersion()+1;return s&&a}))}async getMigrateVersion(e){const t=this.tableConfig.getTransformConfig(e);if(t){const e=Object.values(t.configs.version);for(let t=0;t<e.length;t++){const s=e[t],a=await this.shouldUpgradeMigrate(s.version),i=await this.shouldResumeMigrate(s.version);if(a||i)return s.version}}return-1}}class F{constructor(e,t,s,i,n,r){this.scope=e,this.dbName=t,this.tableConfig=s,this.partition=i,this.database=n,this.reporter=r,this.status=L.NotStart,this.configs=D,this.migrateDeferer=void 0,this.logger=void 0;const o=a.ModuleContainer.resolve(R.a);this.migrateDeferer=new E.c.Container,this.logger=o.createZLogger(w.ZLoggerNametags.dbDataTransform,["migrater"])}applyNewConfig(e){this.configs=Object(I.a)({},e)}getState(){return M.a.create(this.scope,this.dbName,this.tableConfig)}shouldResumeMigrate(e){return new A(this.scope,this.dbName,this.tableConfig).shouldResumeMigrate(e)}shouldUpgradeMigrate(e){return new A(this.scope,this.dbName,this.tableConfig).shouldUpgradeMigrate(e)}async upgradeMigrateVersion(e){const{version:t,migrate:s}=e,a=await this.getState();return await this.doUpVersion(a,t),s?(this.logger.zsymb(0,"UwmIKG","upversion trigger migrate",this.tableConfig.name),this.startMigrate(t)):(this.logger.zsymb(0,"mJ_Ctt","upversion without migrate",this.tableConfig.name),this.doneMigrate())}async startMigrate(e){if(this.status!==L.NotStart)throw new Error("start migrate in valid status:"+this.status);if(this.migrateDeferer.value)return this.logger.zsymb(18,"pidIBB","trigger migrate already settled",this.tableConfig.name),this.migrateDeferer.promise;const t=await this.getState();if(t.getCurrentVersion()!==e)throw new Error("migrate invalid version, please up version first:"+this.tableConfig.name);return await t.markStateAsRunning(),this.status=L.Running,this.reporter.onStart(this.tableConfig.name,e),this.doNextMigrateIterator(t),this.migrateDeferer.promise}async resumeMigrate(){if(this.status===L.Stoped)throw new Error("resume migrate in valid status:"+this.status);if(this.migrateDeferer.value)return this.logger.zsymb(18,"QcUofG","resume migrate already settled",this.tableConfig.name),this.migrateDeferer.promise;this.logger.zsymb(0,"eNVeaC","Resume migrate ",this.tableConfig.name);const e=await this.getState();return await e.markStateAsRunning(),this.status=L.Running,this.reporter.onStart(this.tableConfig.name,e.getCurrentVersion()),this.doNextMigrateIterator(e),this.migrateDeferer.promise}async pauseMigrate(e="unknown"){this.logger.zsymb(0,"KWX-nb","Pause migrate ",this.tableConfig.name,e),this.status=L.Paused}async stopMigrate(e="unknown"){const t="string"==typeof e?e.slice(0,200):e;this.logger.zsymb(0,"NtH0fe","Stop migrate ",this.tableConfig.name,t);const s=await this.getState();this.status=L.Stoped,this.migrateDeferer.resolve({error:!0,message:t}),this.reporter.onError(this.tableConfig.name,s.getCurrentVersion(),e)}async doneMigrate(){if(this.migrateDeferer.value)return this.logger.zsymb(18,"2gPLRX","Migrate already settled!",this.tableConfig.name),this.migrateDeferer.promise;this.logger.zsymb(0,"MSiyHb","Done migrate: ",this.tableConfig.name);const e=await this.getState();return await e.markStateAsFinished()?this.migrateDeferer.resolve({error:!1,message:"Success"}):this.migrateDeferer.resolve({error:!0,message:"Persist state to fisk fail"}),this.reporter.onFinished(this.tableConfig.name,e.getCurrentVersion()),this.migrateDeferer.promise}doNextMigrateIterator(e){this.status===L.Running?setTimeout((()=>{this.doMigrate(e)}),this.configs.gapTime):this.logger.zsymb(0,"ExScbG","stop migrate, not running")}async doMigrate(e){this.logger.zsymb(0,"-fHTu_","Do migrate ",this.tableConfig.name,e.getCheckpoint());const t=async t=>{if(e.isDoneCheckpoint())return this.logger.zsymb(6,"oUUoe8","checkpoint reach upperbound",JSON.stringify(e.getCheckpoint())),[];const s={from:e.getCheckpoint(),to:e.getUpperbound(),excludeFrom:!0},a={partition:this.partition,limit:this.configs.batchSize,direction:O.c.NEXT};return await t.getAll(s,a).catch((e=>{throw this.logger.zsymb(18,"a2cem_","read error",JSON.stringify(e)),e}))},s=t=>{const s=this.tableConfig.getIndex("primary").createKey(t);e.updateCheckPoint(s)},a=async(t,s)=>{const a={replace:!0,partition:this.partition};await t.insertMulti(s,a).catch((t=>{throw e.rollback(),this.logger.zsymb(18,"j0nRAd","write error",JSON.stringify(t)),t}))},i=this.database[this.tableConfig.name];await this.database.runTransaction([i],(async([e])=>{const i=await t(e),n=i.length;return 0==n||(s(i[n-1]),await a(e,i)),n}),O.j.READWRITE).then((async t=>{this.reporter.onProgress(this.tableConfig.name,e.getCurrentVersion(),t),await e.commitChange(),t<this.configs.batchSize?(this.logger.zsymb(0,"Ii0m6b","reach to last batch",this.tableConfig.name),this.doneMigrate()):this.doNextMigrateIterator(e)})).catch((e=>{this.stopMigrate((null==e?void 0:e.message)||JSON.stringify(e))}))}doUpVersion(e,t){return new Promise(((s,a)=>{this.logger.zsymb(0,"MkZmJn","start upgrade version:",this.tableConfig.name);const i=this.database[this.tableConfig.name],n=Object(T.b)(this.tableConfig),r=e=>{this.stopMigrate((null==e?void 0:e.message)||JSON.stringify(e))};this.database.runTransaction([i],(async([a])=>{const i=await a.getAll(void 0,{limit:1,direction:O.c.PREV,partition:this.partition}),o=(()=>{if(0==i.length)return n;const e=i[i.length-1];return this.tableConfig.getIndex("primary").createKey(e)})();return e.upVersionTo(t,n,o).then(s).catch(r)}),O.j.READWRITE).catch(r)}))}}var k;const N={gapTime:100,version:0,batchSize:100};Object(a.injectable)()(k=Object(a.singleton)(C)(k=function(e,t){return a.ModuleContainer.inject(y.b)(e,void 0,0)}(k=function(e,t){return a.ModuleContainer.inject(R.a)(e,void 0,1)}(k=Reflect.metadata("design:type",Function)(k=Reflect.metadata("design:paramtypes",[void 0===y.b?Object:y.b,void 0===R.a?Object:R.a])(k=class{constructor(e,t){this.configManager=e,this.session=void 0,this.configs=void 0,this.logger=void 0,this.session=null,this.configs=N,this.logger=t.createZLogger(w.ZLoggerNametags.dbDataTransform,["manager"])}authenticate(e){this.session=e}async getMigrateVersion(e){if(!this.session)throw new Error("Get migrate version when the session has not yet been initialized.");const t=[],s=[];Object.entries(e).forEach((e=>{const t=e[0];Object.values(e[1]).forEach((e=>s.push([t,e])))}));for(let a=0;a<s.length;a++){const[e,i]=s[a],n=await this.configManager.getDatabaseConfigs(e),r=i.getTransformConfig(n[0].type);if(!r)continue;const o=await r.getScopedId(),c=new A(o,e,i),l=await c.getMigrateVersion(n[0].type);-1!==l&&t.push(l)}return t.length?Math.min(...t):-1}async migrate(e,t,s){if(!this.session)throw new Error("Request migration when the session has not yet been initialized.");return this.configs=Object(I.a)(Object(I.a)({},this.configs),e),this.doMigrateUntilDie(Object.entries(s),(([e,s])=>this.migrateDB(t,e,s)))}async migrateDB(e,t,s){return this.logger.zsymb(0,"5K6IVV","migrate db",t),this.doMigrateUntilDie(Object.values(s),(s=>this.migrateTable(e,t,s)))}async migrateTable(e,t,s){const i=await this.configManager.getDatabaseConfigs(t),n={success:!0,type:"notMigrate"};if(0==i.length)throw new Error("Migrate on a database without a configured setup");const r=s.getTransformConfig(i[0].type);if(!r)return this.logger.zsymb(0,"sI3dzT",`Transform config not found for table: ${s.name}`),n;this.logger.zsymb(0,"9a_V1q","Check migrate table: ",s.name);const o=a.ModuleContainer.resolve(S),c=await r.getScopedId(),l=new F(c,t,s,i[0].computePartitionName(this.session.userId,s.name),e[t],o);return l.applyNewConfig(this.configs),this.migrateToNextVersion(r,l)}async migrateToNextVersion(e,t){const s=Object.values(e.configs.version);for(let a=0;a<s.length;a++){const e=s[a];if(e.version>this.configs.version){this.logger.zsymb(0,"96jMgD","Version too high",this.configs.version,e.version);break}const i=await t.shouldUpgradeMigrate(e.version),n=await t.shouldResumeMigrate(e.version);if(i){const s=await t.upgradeMigrateVersion(e);return{success:!s.error,type:"migrate",error:s.message}}if(n){const e=await t.resumeMigrate();return{success:!e.error,type:"migrate",error:e.message}}}return{success:!0,type:"notMigrate"}}async doMigrateUntilDie(e,t){const s=[];for(let a=0;a<e.length;a++){const i=await t(e[a]).catch((e=>({success:!1,type:"migrate",error:null==e?void 0:e.message})));if(!i.success)return i;s.push(i),await E.c.delay(this.configs.gapTime)}return s.find((e=>"migrate"==e.type))||s[0]}})||k)||k)||k)||k)||k);var P=s("UK4g"),j=s("DI/x"),U=s("0Grr"),B=s("ipWf"),z=s.n(B);class G extends U.a{async getDBRoot(){const e=await $zelectron.getPath("db");if(null===e)throw new j.C("Can't retrieve 'userData' path!");return z.a.join(e,P.a,"_production")}async getMainBackupRoot(){const e=await $zelectron.getPath("db");if(null===e)throw new j.C("Can't retrieve 'userData' path!");let t="_production";return t+="_bu",z.a.join(e,P.a,"_production_bu")}async getTempBackupRoot(){const e=await $zelectron.getPath("db");if(null===e)throw new j.C("Can't retrieve 'userData' path!");let t="_production";return t+="_temp_bu",z.a.join(e,P.a,"_production_temp_bu")}async getRejectBackupRoot(){const e=await $zelectron.getPath("db");if(null===e)throw new j.C("Can't retrieve 'userData' path!");let t="_production";return t+="_rej_bu",z.a.join(e,P.a,"_production_rej_bu")}}a.ModuleContainer.registerSingleton(U.c,G);s("fNRA"),s("6Pbj"),s("5lV7"),s("szdT");var x=s("ahRi");var V=s("ptxg"),H=s("pUq9");let W;W=class{getOverrideDomain(e){}getDomainConfig(){return{}}setDomainConfig(e){return this}subscribe(e){return()=>{}}},Object(a.injectable)()(W),Object(a.singleton)(V.a)(W);s("dhzt");var q=s("paDR"),K=s("k+R1"),Z=s("Nve0");Object(q.b)(q.a.MakeCall,(function(e,t,s){if(null==s)return;const{chatID:a,callType:i}=s,n=K.default.getChatBoxControllerByConvId(a);var r,o;null!=n&&null!=i&&(i===Z.d.AUDIO?null===(r=n.makeCall)||void 0===r||r.call(n,!1):null===(o=n.makeCall)||void 0===o||o.call(n,!0))})),Object(q.b)(q.a.MakeVideoCall,(function(e,t,s){var a;if(null==s)return;const{chatID:i}=s,n=K.default.getChatBoxControllerByConvId(i);null==n||null===(a=n.makeCall)||void 0===a||a.call(n,!0)})),Object(q.b)(q.a.MakeVoiceCall,(function(e,t,s){var a;if(null==s)return;const{chatID:i}=s,n=K.default.getChatBoxControllerByConvId(i);null==n||null===(a=n.makeCall)||void 0===a||a.call(n,!1)}));var $=s("FyUm");var Q=s("WQAo");Object(q.b)(q.a.LoadMoreMessages,(function(e,t,s,a){const{chatID:i,windowID:n}=s;$.default.GetManager().requestMessages(i,n,s,a)})),Object(q.b)(q.a.OpenChat,(function(e,t,s,i){if(null==s)return;const{chatID:n,source:r}=s;let o=null;switch(r){case Q.a.MessageOnMessaging:o=Q.d.fromMessageOnMessageing();break;case Q.a.MessageMention:{const e=null;Q.d.fromMessageMention(e);break}}a.ModuleContainer.resolve(Q.b).openConversation(n,o).catch((e=>{}))})),Object(q.b)(q.a.ScrollToMessage,(function(e,t,a,i){var n;if(null==a)return;const{chatId:r,dispatch:o,handlers:{onError:c=(()=>{}),onFinally:l=(()=>{}),onSuccess:d=(()=>{})}={},message:u,options:h,tracking:g}=a,m=null===(n=s("4wTQ"))||void 0===n?void 0:n.default;m&&"function"==typeof m.jumpToMessage&&m.jumpToMessage(u,r,o,h).then(d).catch(c).finally(l)}));var Y=s("1pet"),J=s("PoHQ");var X=s("6ivO"),ee=s("XJ/a"),te=s("voUN");const se=new ee.a({context_menu:ee.b.field().schema({version:ee.b.field().number()})}),ae=new class extends X.ZFeatureConfig{constructor(){super({default:te.b,valiator:se})}selector(e){return e.ui_message||{}}getContextMenuConfig(){return this.config.context_menu}};var ie=s("Xp+J");const ne={};function re(e){return ne[e]}Object(q.b)(q.a.CreateToDoTask,(function(e,t,a,i){var n,r;const{chatId:o,data:c,windowId:l}=a;if(!c)return;const d=c.message;if(!d)return;const u=s("BZLJ");if(!u||void 0===u.default)return;const{ModalManagerV2:h}=s("h0sc"),g=u.default,{TODO_DATE_TYPE:m,TODO_STATUS:p}=u;let f,v=null!==(n=c.selectedText)&&void 0!==n?n:"";f=v||g.getTodoContentFromAMsg(d);let _=c.assignees;(!_||_.length<=0)&&(_=[]);const b=null!==(r=null!=o?o:d.toUid)&&void 0!==r?r:"",I=b.startsWith(Y.GROUPID_PREFIX);let y=b;I&&(y=b.slice(1));const S=J.p.getSessionUserId(),C={creator:S,content:f,dueDate:-1,assignees:_,extra:{toUid:y,msgId:d.msgId,isGroup:I,cliMsgId:d.cliMsgId,msgType:d.msgType,mention:d.mentions||[],ownerMsgUId:"0"==d.fromUid?S:d.fromUid,message:d.message},dateDefaultType:m.NO_DATE,description:"",watchers:"[]",status:p.WAITING_FOR_RESPONSE};g.setCreateTodoSrc(c.trackingSource),h.openModal({windowId:l,name:Y.ModalIdentitiesDefine.TODO_EDITOR,params:C})})),Object(q.b)(q.a.ShowMessageContextMenu,(function(e,t,a){const{context:i,oldData:n,data:r}=a||{};if(!1===Boolean(function(e){return null!=e&&void 0!==e.event&&null!==e.event&&void 0!==e.message&&null!==e.message&&void 0!==e.source&&null!==e.source}(i)))return;const o=function(e){if(!e)throw new Error("Window instance is invalid!");const t="?key=";let s="";const a=e.name;if(""===e.name)s="1";else{const e=a.indexOf(t);if(-1===e)s="1";else{const t=a.indexOf("&",e+1);s=-1!==t?a.substring(e+5,t):a.substring(e+5)}}return s}(i.event.view);!1===Boolean(ae.getContextMenuConfig().version)&&"function"==typeof re(o)&&re(o)(i.event,onContextMenu,message,localPath,resendFunc,showInFolder,downloadFunc,onExtension,indexOAChild,folderPath);const{showContextMenu:c}=s("DOj/");if("function"==typeof c){let e=[];const t=ie.a.get(r.UIMessageType);t&&(e=t(i,r.messageRef)),c(i,e)}}));var oe=s("uP4a"),ce=s("c51z"),le=s("gwig"),de=s("WIhS"),ue=s("/1VS"),he=s("xwfN"),ge=s("POdc"),me=s("QPNp"),pe=s("jSEC"),fe=s("4KMa");var ve=s("97kL"),_e=s("Ydol");Object(q.b)(q.a.SaveToDevice,(function(e,t,a,i){const{message:n,selfWindow:r}=a||{},{isShowedProgress:o,onDownloadStarted:c,onDownloadFail:l,onDownloadSuccess:d}=i||{};if(!n)return;if(!(le.b.getStateNetwork()==le.a.CONNECTED))return void me.a.ZToastModule.createError(ce.a.str("STR_TOAST_CONNECTION_FAILED"));if(!Object(he.a)()){const e=s("xHgQ").downloadWebV2ByMsg;return void Object(de.a)(e)(null,r,n,Boolean(o))}const u=n.msgType==Y.MSG_UNDO?-1:Object(fe.h)(n),h=n.msgId,g={},m=me.a.DownloadObjectModule;Object(de.a)(c)({msgId:h});let p=!1,f=new oe.c(oe.a.ChatBoxView).getBuilder().withMode(oe.e.Manual).withCode(oe.d.CBVMessage);n.msgType===Y.MSG_FILE?(f.withType(oe.f.File),g.type=m.constants.DownloadType.File,g.options={saveAs:!0,srcAction:m.constants.srcAction.Manual,showProgress:{progressBar:!0,taskBar:!0}}):n.msgType===Y.MSG_VIDEO?(f.withType(oe.f.Video),n.message&&n.message.oriUrl&&(p=!1,g.type=m.constants.DownloadType.Video,g.options={saveAs:!0,srcAction:m.constants.srcAction.Manual,showProgress:{progressBar:!1,taskBar:!0}})):n.msgType===Y.MSG_GIF?(f.withType(oe.f.Photo),n.message&&n.message.oriUrl&&(p=!1,g.type=m.constants.DownloadType.Photo,g.options={saveAs:!0,srcAction:m.constants.srcAction.Manual,showProgress:{progressBar:!1,taskBar:!0}})):n.msgType!==Y.MSG_PHOTO&&n.msgType!==Y.MSG_DOODLE&&u!=Y.MSG_SUBTYPE_PHOTO&&u!=Y.MSG_SUBTYPE_GIF||(f.withType(oe.f.Photo),n.message&&n.message.oriUrl&&(p=!1,g.type=m.constants.DownloadType.Photo,g.options={saveAs:!0,srcAction:m.constants.srcAction.Manual,duplicate:!1,showProgress:{progressBar:!1,taskBar:!0}})),Object(ge.c)(n,ge.a.UserAction),f.withConvType(oe.b[Object(pe.a)(null==n?void 0:n.toUid)]),g.entry=f.build(),ue.a.downloadWithMultiSrc("runByMsg",n,Object(I.a)({},g)).then((e=>{const{savePath:t,isFolder:s}=e,a=s?"":t,i=s?t:"";Object(de.a)(d)({isOpenedOnDone:p,msgId:h,localPath:a,folderPath:i})})).catch((e=>{Object(de.a)(l)({msgId:h,error:e})}))})),Object(q.b)(q.a.ShowInFolder,(function(e,t,a,i){const{message:n}=a||{},{localPath:r,onFilePathUpdated:o}=i||{};if(n)if(n.msgType===Y.MSG_FILE){(0,s("F1UR").default)(n)}else{const e=r||(null==n?void 0:n.localPath);if(e){const t=me.a.FileUtilsModule;t.fileExists(e).then((s=>{s?t.showInFolder(e):(me.a.ZToastModule.createError(ce.a.str("STR_TOAST_FILE_NOT_FOUND")),"function"==typeof o&&Object(de.a)(o)("",""),_e.default.send(ve.ChatBoxActions.FILEPATH_UPDATED,{msgId:n.msgId,localPath:"",folderPath:""}))}))}}}));var be=s("Vp9m"),Ie=s("h0sc"),ye=s("Py3H");function Se(e){let t=e;return t&&t.startsWith(Y.GROUPID_PREFIX)&&(t=t.substring(1,t.length)),t}Object(q.b)(q.a.AddFriend,(function(e,t,s){if(null==s)return;const{userID:a,chatID:i,windowID:n}=s;if(!a)return;const r=()=>{const e=Se(i||"");ye.a.setFriendRequestSource(a,Y.FRIEND_REQUEST_SRC_ECARD,{uidTo:e}),Ie.ModalManagerV2.openModal({windowId:n||void 0,name:Y.ModalIdentitiesDefine.ADD_FRIEND,params:a})};ye.a.getStatusFriendRequest(a).then((e=>{e.isRequested?be.default.show({textKey:"STR_PROFILE_FRIEND_REQ_SENT",noBackground:!0,type:be.TOAST_TYPE.INFO}):r()})).catch((()=>r()))}));var Ce=s("NDmK"),Ee=s("Xt6Q"),Oe=s("Z2tZ"),Me=s("Enw1"),Te=s("JDlE"),Re=s("XS0u"),we=s("EYv5");Object(q.b)(q.a.ManualDownloadMediaDoneHandler,(function(e,t,i,n){const{chatId:r,message:o,localPath:c,folderPath:l,isOpenedWhenCompleted:d=!0}=i;if(!r||!o)return;if(!c&&!l)return;if(Ee.l)return;const u=o.msgId;if(d||_e.default.send(ve.FetchActions.DOWNLOAD_DONE,{msgId:u,localPath:c,folderPath:l}),Me.g.isSetSound(J.p.getSessionUserId())&&Te.a.playNoti(),a.ModuleContainer.resolve(we.a).updateFile(r,u,{localPath:c,folderPath:l},["localPath","folderPath"]),_e.default.send(ve.ChatBoxActions.FILEPATH_UPDATED,{msgId:u,localPath:c,folderPath:l}),Re.default.updateMessage(u,{msgId:u,localPath:c,folderPath:l},["localPath","folderPath"],r),Ce.default.recent_photo.enableFeature&&Object(Ee.n)()){const e=s("z0WU").default,t=Date.now();Oe.a.setPhotoDownload({isLocalFile:!0,path:c,lastModified:t,name:$znode.path.basename(c||""),shortenPath:e.getShortenPath(c,40),fromSource:"DownloadedPhoto"})}if(!0===d){const e=s("Dprd").default;l?e.showInFolder(l):e.openItem(c)}})),Object(q.b)(q.a.OpenProfileModal,(function(e,t,s){if(null==s)return;const{userId:a,chatId:i,friendRequestSource:n,selectConversationSource:r,windowId:o}=s;if(null==a)return;let c=n;null==c&&(c=a.startsWith(Y.GROUPID_PREFIX)?Y.FRIEND_REQUEST_SRC_GROUP_CHAT:Y.FRIEND_REQUEST_SRC_CHAT);const l=Se(i||"");let d;l&&(c===Y.FRIEND_REQUEST_SRC_GROUP_CHAT?d={groupId:l}:c!==Y.FRIEND_REQUEST_SRC_CHAT&&c!==Y.FRIEND_REQUEST_SRC_ECARD||(d={toUid:l})),ye.a.setFriendRequestSource(a,c,d),null!=r&&J.p.setSelectConversationSource(r),Ie.ModalManagerV2.openModal({windowId:o||"1",name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:a})}));s("uAZB");var Le=Object(a.define)("media-player-factory"),De=s("ZsEe");var Ae=class{constructor(e){this._token=void 0,null!=e&&(this.token=e),this.token}static create(e){return new this(e)}isValidated(){return Boolean(this._token)}toString(){return void 0===this.token||null===this.token?"":String(this.token)}freeze(){return Object.freeze(this),this}get token(){return this._token}set token(e){this._token=e,this.freeze()}};let Fe=function(e){return e.Audio="audio",e.Video="video",e}({});var ke=class{constructor(e){if(e)try{Object.keys(e).forEach((t=>{t&&void 0===this[t]&&(this[t]=e[t])}))}catch(t){}}freeze(){return Object.freeze(this),this}};let Ne=function(e){return e[e.None=0]="None",e[e.Playing=1]="Playing",e[e.Paused=2]="Paused",e[e.Rewinding=3]="Rewinding",e[e.Stopped=4]="Stopped",e[e.Error=5]="Error",e}({}),Pe=function(e){return e[e.DownloadFailed=-101]="DownloadFailed",e[e.Exception=-102]="Exception",e[e.Expired=-103]="Expired",e[e.FetchFailed=-104]="FetchFailed",e[e.NotDownload=-105]="NotDownload",e}({});var je=class extends ke{constructor(e){super(e),this.state=Ne.None,this.position=0,this.rate=1}};var Ue=class{constructor(){this.builder=void 0,this.callerValidator=new WeakSet,this.playbackModel=new je,this.builder=new Proxy(this,{get:(e,t,s)=>Reflect.get(e,t,s)}),this.callerValidator.add(this.builder)}GetBuilder(){return this.builder}getState(){return this.playbackModel.state}getPosition(){return this.playbackModel.position}getRate(){return this.playbackModel.rate}isValidCaller(e){return this.callerValidator.has(e)}setState(e){this.playbackModel.state=e}setPosition(e){this.playbackModel.position=e}setRate(e){this.playbackModel.rate=e}};var Be=class{constructor(e,t,s){this.token=e,this.mediaType=t,this.builtins=void 0,this.eventListeners=void 0,this.playback=void 0,this.source="",this.eventListeners=new Map,s&&this.setSource(s)}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]);const s=this.eventListeners.get(e);return s.push(t),this.eventListeners.set(e,s),()=>this.removeEventListener(e,t)}getDuration(){return this.isPrepared()&&this.builtins.duration||0}getPlaybackPosition(){return this.isPrepared()&&this.playback.getPosition()||0}getPlaybackState(){return this.isPrepared()?this.playback.getState()||Ne.None:0}getPlaybackRate(){return this.isPrepared()&&this.playback.getRate()||0}getRemainingTime(){return this.isPrepared()?this.getDuration()-this.getCurrentTime():0}getSource(){return this.source}getToken(){return this.token}pause(){this.isPrepared()&&(this.playback.setState(Ne.Paused),this.builtins.pause())}play(){return this.isPrepared()?(this.playback.setState(Ne.Playing),this.builtins.play()):Promise.reject()}prepare(){this.playback=new Ue,this.mediaType===Fe.Audio&&(this.builtins=new Audio,this.registerEventWhenReady(),this.updateBuiltins({src:this.getSource()}))}release(){delete this.builtins,this.builtins=void 0,this.playback=void 0}removeEventListener(e,t){const s=this.eventListeners.get(e);s&&this.eventListeners.set(e,s.filter((e=>e!==t)))}seekTo(e){this.setCurrentTime(e)}setSource(e){this.source=e,this.updateBuiltins({src:e})}stop(){this.isPrepared()&&(this.playback.setState(Ne.Stopped),this.builtins.pause(),this.setCurrentTime(0))}getCurrentTime(){var e;return(null===(e=this.builtins)||void 0===e?void 0:e.currentTime)||0}isPrepared(){return null!=this.builtins&&null!=this.playback}notifyEvent(e,t,...s){const a=this.eventListeners.get(e);a&&a.forEach((e=>{"function"==typeof e&&e(t,...s)}))}onEnded(){this.playback.setState(Ne.Stopped),this.setCurrentTime(0)}registerEventWhenReady(){this.isPrepared()&&(this.builtins.addEventListener("abort",(e=>{this.notifyEvent("onabort",e)})),this.builtins.addEventListener("canplay",(e=>{this.notifyEvent("canplay",e)})),this.builtins.addEventListener("durationchange",(e=>{this.notifyEvent("durationchange",e,this.getDuration())})),this.builtins.addEventListener("error",(e=>{this.notifyEvent("onerror",e)})),this.builtins.addEventListener("loadeddata",(e=>{this.notifyEvent("loadeddata",e)})),this.builtins.addEventListener("loadedmetadata",(e=>{this.notifyEvent("loadedmetadata",e)})),this.builtins.addEventListener("timeupdate",(e=>{const t=this.getCurrentTime();this.playback.setPosition(t),this.notifyEvent("timeupdate",e,{currentTime:t,remainingTime:this.getRemainingTime()})})),this.builtins.addEventListener("ended",(e=>{this.onEnded(),this.notifyEvent("ended",e)})))}setCurrentTime(e){this.playback.setPosition(e),this.updateBuiltins({currentTime:e})}updateBuiltins(e){if(!this.builtins)return;Object.keys(e).forEach((t=>{this.builtins[t]=e[t]}))}};var ze=class{constructor(){this.IDGenerator=new De.a,this.instanceMap=new Map}createAudioPlayer(e){return this.createMediaPlayer(Fe.Audio,e)}createMediaPlayer(e,t){const s=Ae.create(this.generateTokenID()),a=new Be(s,e,t);return this.registerInstance(s,a),a}createVideoPlayer(e){return this.createMediaPlayer(Fe.Video,e)}deleteMediaPlayer(e){this.unregisterInstance(e)}generateTokenID(){return"PL_"+this.IDGenerator.next()}registerInstance(e,t){this.instanceMap.set(e.toString(),t)}unregisterInstance(e){this.instanceMap.delete(e.toString())}};a.ModuleContainer.registerSingleton(Le,ze);s("FCbV");var Ge=Object(a.define)("audio-manager"),xe=s("QZAi");var Ve=Object(a.define)("audio-resource-manager"),He=Ve;var We,qe=class{constructor(e){this.audioResourceManager=e}get AudioResourceManager(){return this.audioResourceManager}};var Ke=Object(a.injectable)()(We=function(e,t){return Object(a.inject)(He)(e,void 0,0)}(We=Reflect.metadata("design:type",Function)(We=Reflect.metadata("design:paramtypes",[Object])(We=class extends qe{constructor(e){super(e)}async loadResourceFromMessage(e,t){try{var s,a;const i=Me.g.getEnableAutoDownload(J.p.getSessionUserId()),n=await this.AudioResourceManager.loadResourceFromMessage(e,Object(I.a)(Object(I.a)({},t),{},{enableAutoDownload:i}));if(n.status===xe.a.SUCCESS){const e=n.data;return{localURL:e.localURL,URL:e.URL,status:"playable"}}return{localURL:(null===(s=n.extra)||void 0===s?void 0:s.localURL)||"",URL:(null===(a=n.extra)||void 0===a?void 0:a.URL)||"",status:"expired",error:{code:n.data.code,message:n.data.message}}}catch(i){return{localURL:"",URL:"",error:i,status:"failure"}}}async reloadResourceFromMessage(e,t){try{var s;const a=Me.g.getEnableAutoDownload(J.p.getSessionUserId()),i=await this.AudioResourceManager.reloadResourceFromMessage(e,Object(I.a)(Object(I.a)({},t),{},{enableAutoDownload:a}));if(i.status===xe.a.SUCCESS){const e=i.data;return{localURL:e.localURL,URL:e.URL,status:"playable"}}return{localURL:"",URL:(null===(s=i.extra)||void 0===s?void 0:s.URL)||"",status:"expired",error:{code:i.data.code,message:i.data.message}}}catch(a){return{localURL:"",URL:"",error:a,status:"failure"}}}})||We)||We)||We)||We;a.ModuleContainer.register(Ge,Ke);var Ze=Object(a.define)("audio-resource-loader");var $e=class{};a.ModuleContainer.register(Ze,$e);var Qe=Object(a.define)("audio-resource-status"),Ye=s("q63S"),Je=s("w1k3");var Xe=class{async checkMediaStatus(e,t=[],s=!1,a=!0){try{let{status:t}=await Object(Je.a)(e);return{isExpired:"none"===t,autoDownloadPath:Object(Ye.b)(e)}}catch(i){return Promise.reject(i)}}};a.ModuleContainer.register(Qe,Xe);var et=Object(a.define)("audio-resource-downloader"),tt=s("JprO");var st=class{async downloadFromMessage(e,t){try{const{windowId:s}=t||{},a={wKey:s,type:tt.default.constants.DownloadType.Voice,options:{saveAs:!1,srcAction:tt.default.constants.srcAction.Dev,duplicate:!1,showProgress:{progressBar:!1,taskBar:!1}}};return await ue.a.getInstance().downloadWithMultiSrc("runByMsg",e,a)}catch(s){return Promise.reject(s)}}};a.ModuleContainer.register(et,st);var at=s("KweF"),it=s("JJxn");const nt=Object(a.define)("media-action-log-info-queue-tasks"),rt=Object(a.define)("media-action-log-info-producer"),ot=Object(a.define)("media-action-log-info-manager"),ct=Object(a.define)("media-action-log-info-consumer"),lt=Object(a.define)("media-action-log-info-cron-to-group-data");var dt=s("A9FD");function ut(e,t){const s={status:xe.a.SUCCESS,data:e,extra:t};return void 0===t&&delete s.extra,s}function ht(e,t,s,a){const i={status:xe.a.ERROR,data:{code:e,message:t||"",error:s},extra:a};return void 0===i.extra&&delete i.extra,i}function gt(e){return Boolean(!1)?"zfile://"+e:e}function mt(e,t,s=!1){let a="://";return s&&(a+="/"),e+a+t}var pt,ft=class{constructor(e,t){this.audioResourceLoader=e,this.audioResourceStatus=t,this.resourceCheckerResultCache=new Map}get AudioResourceLoader(){return this.audioResourceLoader}get AudioResourceStatus(){return this.audioResourceStatus}getCheckerResultCache(){return this.resourceCheckerResultCache}hasIn(e,t){return e.has(t)}},vt=et,_t=Ze,bt=Qe,It=s("Iy59");var yt=Object(a.injectable)()(pt=function(e,t){return Object(a.inject)(_t)(e,void 0,0)}(pt=function(e,t){return Object(a.inject)(bt)(e,void 0,1)}(pt=function(e,t){return Object(a.inject)(vt)(e,void 0,2)}(pt=Reflect.metadata("design:type",Function)(pt=Reflect.metadata("design:paramtypes",[Object,Object,Object])(pt=class extends ft{constructor(e,t,s){super(e,t),this.audioResourceDownloader=s}async checkMediaStatusFromMessage(e,t,s,a){try{const i=Object(I.a)({},e);return ut(await this.AudioResourceStatus.checkMediaStatus(i,t,s,a))}catch(i){return ht(-1,"",i)}}async loadResourceFromMessage(e,t={enableAutoDownload:!0}){return-1!==e.message.href.indexOf(dt.i.E2EE_SESSION)?this.loadResourceFromMessageE2EE(e,t):this.loadResourceFromMessageNonE2EE(e,t)}async reloadResourceFromMessage(e,t={enableAutoDownload:!0,windowId:"1"}){const s=this.getDirectURL(e.message.href,e.msgId),{enableAutoDownload:a,windowId:i="1"}=t||{};try{const t=(await this.downloadFromMessage(e,{windowId:i})).data.savePath;return t?ut({localURL:gt(mt("file",t,!0))||"",URL:s}):ht(Pe.DownloadFailed,"",void 0,{URL:s})}catch(n){return ht(Pe.DownloadFailed,"",void 0,{URL:s})}}async downloadFromMessage(e,t){try{return ut(await this.AudioResourceDownloader.downloadFromMessage(e,t))}catch(s){const e="Auto download audio resource was error!";return Promise.reject(ht(-1,e,s))}}async loadResourceFromMessageE2EE(e,t={enableAutoDownload:!0,windowId:"1"}){try{const t=Object(at.j)(),s=e.message.href,a=await Object(at.h)(String(t),s,at.a.dev);return a&&a.data?ut({localURL:a.data,URL:this.getDirectURL(e.message.href,e.messageID)}):Promise.reject(ht(Pe.FetchFailed,"",null==a?void 0:a.error))}catch(s){const e="Load audio resource was error in E2EE flow!";return Promise.reject(ht(Pe.Exception,e,s))}}async loadResourceFromMessageNonE2EE(e,t={enableAutoDownload:!0,windowId:"1"}){const s=this.getDirectURL(e.message.href,e.msgId);try{const n=await this.checkMediaStatusFromMessage(e,[],!0),{flag:r}=Object(Je.b)(e);a.ModuleContainer.resolve(ot).run(e.toUid,e.msgId,{subType:it.e.SubTypeActionLogInfo.MediaStatusInView,entryPoint:it.e.EntryPointActionLogInfo.CONVERSATION_CHAT,isZCloud:r&It.d.clouded?1:0,conversationId:e.toUid});const o=n.data;if(o.autoDownloadPath)return ut({localURL:gt(mt("file",o.autoDownloadPath,!0)),URL:s});if(o.isExpired&&!(r&It.d.clouded))return ht(Pe.Expired,"",void 0,{URL:s});const{enableAutoDownload:c,windowId:l="1"}=t||{},d=(null==o?void 0:o.isExpired)&&!!(r&It.d.clouded),u=!(null!=o&&o.isExpired||c||(null==e?void 0:e.status)!=Y.MSG_SENT);if(!d&&u)return ut({localURL:"",URL:s},{reason:Pe.NotDownload});try{const t=await this.downloadFromMessage(e,{windowId:l});return ut({localURL:gt(mt("file",t.data.savePath,!0))||"",URL:s})}catch(i){return ht(Pe.DownloadFailed,"",void 0,{URL:s})}}catch(i){return Promise.reject(ht(Pe.Exception,"",i))}}getDirectURL(e,t){return-1!==e.indexOf(dt.i.E2EE_SESSION)?e:Ce.default.voice.voiceUrl+"/mp3?url="+encodeURIComponent(e)+"&msgid="+t}get AudioResourceDownloader(){return this.audioResourceDownloader}})||pt)||pt)||pt)||pt)||pt)||pt;a.ModuleContainer.register(Ve,yt);var St=s("J25b"),Ct=s("bUXd");a.ModuleContainer.registerSingleton(St.b,class{getHourNow(){return new Date(Ct.default.getTimeNow()).getHours()}getTimeNow(){return Ct.default.getTimeNow()}getSystemTimeNow(){return Ct.default.getSystemTimeNow()}});s("xRjI");const Et=Object(a.define)("tensor-flow-lib");var Ot=s("Pswx"),Mt=s("c7gn"),Tt=(s("1JlB"),s("CtZu")),Rt=(s("PG0B"),s("+kvV")),wt=s("csRb"),Lt=s("+gpH"),Dt=s("lzW/"),At=s("fn98"),Ft=s("XTCE"),kt=s("9q62"),Nt=s("pGgd"),Pt=s("ThxY"),jt=s("UvZ8"),Ut=s("DJOk"),Bt=s("aea1"),zt=s("2Gmx"),Gt=s("HdJO"),xt=s("eejg"),Vt=s("N7VH"),Ht=s("i+Li"),Wt=s("egdQ"),qt=s("Sm5c");Object(Mt.d)(Rt.a),Object(Mt.d)(wt.a),Object(Mt.d)(Lt.b),Object(Mt.d)(Dt.a),Object(Mt.d)(At.a),Object(Mt.d)(Ft.a),Object(Mt.d)(kt.a),Object(Mt.d)(Nt.a),Object(Mt.d)(Pt.a),Object(Mt.d)(jt.a),Object(Mt.d)(Ut.a),Object(Mt.d)(Bt.a),Object(Mt.d)(zt.b),Object(Mt.d)(Gt.b),Object(Mt.d)(xt.a),Object(Mt.d)(Vt.a),Object(Mt.d)(Ht.a),Object(Mt.d)(Wt.b),Object(Mt.d)(qt.a);a.ModuleContainer.registerSingleton(Et,class{tensor(e,t,s){return Object(Ot.U)(e,t,s)}ones(e,t){return Object(Ot.M)(e,t)}loadGraphModel(e,t,s){return Object(Tt.a)(e,t,s)}io_browserFiles(e){return Ot.J.browserFiles(e)}profile(e){return Object(Ot.N)(e)}});var Kt=s("MRjZ");class Zt{constructor(){this.userId=null}init(e){this.userId=e}getUserId(){if(null===this.userId)throw new Error("Resource hasn't been initialized yet!");return this.userId}}class $t extends Zt{}const Qt=Object(a.define)("ss-sticker-2-click-resource");var Yt,Jt=s("TISA"),Xt=s("fsN4"),es=s("Mgpg");let ts=Object(a.injectable)()(Yt=Object(m.h)()(Yt=function(e,t){return Object(a.inject)(St.b)(e,void 0,0)}(Yt=Reflect.metadata("design:type",Function)(Yt=Reflect.metadata("design:paramtypes",[void 0===St.ISystemTime?Object:St.ISystemTime])(Yt=class extends $t{constructor(e){super(),this.zSystemTime=e,this.timerId=null,this.logger=void 0,this.cachedUsage={};const t=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=t.createZLogger("e2ee-sticker-suggestion",["sticker-2-click"])}scheduleFlushTimeoutIfNeeded(){if(null!==this.timerId)return;this.timerId=setTimeout((async()=>{await this.flushData(),this.timerId=null}),3e4)}async get(e){const t=Xt.default.getInstance(),s=this.getTodayDateObj(),a={from:this.getDateBeforeNDays(e).getTime(),to:s.getTime(),excludeFrom:!0},i=await t.Core.StickerUsage.getAll(a);if(0===i.length)return null;const n={};return i.forEach((({data:e})=>{for(const[t,s]of Object.entries(e))void 0===n[t]&&(n[t]=0),n[t]+=s})),n}async set(e){const t=Xt.default.getInstance(),s=this.getTodayDateObj().getTime();await t.Core.StickerUsage.insert({dttm:s,data:e},{replace:!0})}async recordClickCount(e){const t=this.getTodayDateObj().getTime(),s=await this.getCurrentUsageOfSticker(t,e)+1;this.updateUsageOfSticker(t,e,s),this.scheduleFlushTimeoutIfNeeded()}async clearUnusedData(e){const t={to:this.getDateBeforeNDays(e).getTime()},s=Xt.default.getInstance(),a=await s.Core.StickerUsage.findAndDelete(t);this.logger.zsymb(3,"WJtw6y",["Unused data cleared: {}","xV2hZ4"],a.length)}getDateBeforeNDays(e){const t=this.getTodayDateObj(),s=new Date(t);return s.setDate(t.getDate()-e),s}async initStickerUsageIfNeeded(e){if(void 0===this.cachedUsage[e]){const t=Xt.default.getInstance(),s=await t.Core.StickerUsage.get(e);this.cachedUsage[e]=void 0!==s?s:{dttm:e,data:{}}}}async getCurrentUsageOfSticker(e,t){return await this.initStickerUsageIfNeeded(e),this.cachedUsage[e].data[t]||0}async updateUsageOfSticker(e,t,s){return await this.initStickerUsageIfNeeded(e),this.cachedUsage[e].data[t]=s}getAllUsageBeingTracking(){return this.cachedUsage}removeUsageOfGivenDateFromCache(e){delete this.cachedUsage[e]}async flushData(){try{const e=this.getAllUsageBeingTracking(),t=Object.values(e),s=t.length,a=Xt.default.getInstance();if(await a.Core.StickerUsage.insertMulti(t,{replace:!0}),s>1){const e=this.getTodayDateObj().getTime(),s=[];t.forEach((({dttm:t})=>{t!==e&&s.push(t)}));for(const t of s)this.removeUsageOfGivenDateFromCache(t)}0}catch(e){0}}onDispose(){null!==this.timerId&&(clearTimeout(this.timerId),this.flushData())}getTodayDateObj(){const e=this.zSystemTime.getTimeNow(),t=new Date(e);return t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0),t}})||Yt)||Yt)||Yt)||Yt)||Yt;a.ModuleContainer.registerSingleton(Qt,ts);const ss=Object(a.define)("ss-sticker-2-score-resource");a.ModuleContainer.registerSingleton(ss,class extends Zt{async get(){return $zTFModels.ss.getSticker2Score()}async set(e){return $zTFModels.ss.setSticker2Score(e)}});class as extends Zt{formatData(e){return{modelName:void 0!==e.modelName?e.modelName:"mf_sticker_v3",numItems:Math.max(void 0!==e.numItems?e.numItems:6306,0),numLatentFactor:Math.max(void 0!==e.numLatentFactor?e.numLatentFactor:32,0),minItemReconstruction:Math.max(void 0!==e.minItemReconstruction?e.minItemReconstruction:5,0),minItemTraining:Math.max(void 0!==e.minItemTraining?e.minItemTraining:10,0),numReconstructionRound:Math.max(void 0!==e.numReconstructionRound?e.numReconstructionRound:3,0),numReconstructionRoundWhenTraining:Math.max(void 0!==e.numReconstructionRoundWhenTraining?e.numReconstructionRoundWhenTraining:3,0),numTrainingRound:Math.max(void 0!==e.numTrainingRound?e.numTrainingRound:3,0),batchSize:Math.max(void 0!==e.batchSize?e.batchSize:256,0),reconDataRatio:Math.max(void 0!==e.reconDataRatio?e.reconDataRatio:.5,0),numNegativePerEachPositive:Math.max(void 0!==e.numNegativePerEachPositive?e.numNegativePerEachPositive:50,0),stickerUsageMaxValue:Math.max(void 0!==e.stickerUsageMaxValue?e.stickerUsageMaxValue:100,0),splitDatasetWhenTraining:void 0!==e.splitDatasetWhenTraining&&e.splitDatasetWhenTraining}}}const is=Object(a.define)("ss-config-resource");a.ModuleContainer.registerSingleton(is,class extends as{async get(){return $zTFModels.ss.getSSConfig()}async set(e){return $zTFModels.ss.setSSConfig(e)}});const ns=Object(a.define)("ss-item-2-sticker-resource");a.ModuleContainer.registerSingleton(ns,class extends Zt{async get(){return $zTFModels.ss.getItem2Sticker()}async set(e){return $zTFModels.ss.setItem2Sticker(e)}});var rs=s("xE0C");a.ModuleContainer.registerSingleton(rs.b,class extends Zt{async get(){return $zTFModels.ss.getKwd2Sticker()}async set(e){return $zTFModels.ss.setKwd2Sticker(e)}});const os="tf_ss";class cs extends Zt{}const ls=Object(a.define)("ss-model-resource");a.ModuleContainer.registerSingleton(ls,class extends cs{constructor(...e){super(...e),this.url=null}async get(){const e=this.getURL();return{loadURL:e,saveURL:e}}set(e){throw new Error("Method not implemented.")}getURL(){if(null===this.url){const e=[os,this.getUserId()].join("_");this.url=`indexeddb://${e}`}return this.url}async saveData(e){const t=a.ModuleContainer.resolve(Et),s=e.map((({name:e,data:t})=>new File([t],e,{type:e.endsWith(".json")?"application/json":"application/octet-stream"})));let i=null;try{i=await t.loadGraphModel(t.io_browserFiles(s));const e=this.getURL();await i.save(e)}catch(r){throw r}finally{var n;null===(n=i)||void 0===n||n.dispose()}}});class ds{constructor(){this.model=a.ModuleContainer.resolve(ls),this.config=a.ModuleContainer.resolve(is),this.item2Sticker=a.ModuleContainer.resolve(ns),this.kwd2Stickers=a.ModuleContainer.resolve(rs.b),this.sticker2Click=a.ModuleContainer.resolve(Qt),this.sticker2Score=a.ModuleContainer.resolve(ss)}}const us=Object(a.define)("ss-resource-manager");a.ModuleContainer.registerSingleton(us,class extends ds{init(e){this.model.init(e),this.config.init(e),this.item2Sticker.init(e),this.kwd2Stickers.init(e),this.sticker2Click.init(e),this.sticker2Score.init(e),$zTFModels.ss.initSSResource(e)}});var hs=s("AH6j");let gs;(gs||(gs={})).isUnavailableIDBModelResourceDataError=function(e){if(!(e instanceof Error))return!1;const{message:t}=e;return t.includes("Cannot find model with path")};let ms=function(e){return e.UnavailableModelResourceData="unavailable-model-resource-data",e.DoneReconstruct="done-reconstruct",e}({});class ps extends hs.a{constructor(e){super(ms.UnavailableModelResourceData),this.url=e}}class fs extends hs.a{constructor(e){super(ms.DoneReconstruct),this.data=e}}function vs(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}var _s=s("X61T");class bs{constructor(e,t){this.kwd2Stickers=e,this.sticker2Item=t,this.sameKWMap=function(e,t){const s={},{index:a,map:i}=e;for(const n of Object.values(i)){const e=new Set;for(const s of n){const i=a[s];if(Object(_s.a)(i)){const{content:a}=i,{sticker_id:n}=a;void 0!==t[n]&&e.add(s)}}e.forEach((t=>{void 0===s[t]?s[t]=e:s[t]=Is(s[t],e),void 0!==s[t]&&s[t].delete(t)}))}return s}(this.kwd2Stickers,this.sticker2Item)}sampleNegativeIndices(e,t,s){const a=new Set,i={};for(const[c,l]of Object.entries(e)){const e=t[c];void 0!==e&&(a.add(e),i[e]=l)}const n=Object.values(t),r=new Set;n.forEach((e=>{a.has(e)||r.add(e)}));let o=new Set;for(const c of Object.keys(i)){const e=this.sameKWMap[+c]||new Set;if(0===e.size){o=Is(o,Ss(r,s))}else{const t=new Set;for(const s of Object.keys(i))e.has(+s)||t.add(+s);if(t.size>=s){o=Is(o,Ss(t,s))}else{o=Is(o,t);const e=s-t.size;o=Is(o,Ss(r,e))}if(o.size===r.size)break}}return o}}function Is(e,t){const s=new Set(e.values());return t.forEach((t=>{e.has(t)||s.add(t)})),s}const ys=1e3;function Ss(e,t){if(0===e.size)return new Set;const s=Array.from(e.values());if(t>=e.size)return new Set(vs(s));if(t>=ys)return new Set(vs(s).slice(0,t));let a=0;const i=new Set,n=new Cs(s);for(;a<t;){const e=n.getRandomItem();i.add(e),a+=1}return i}class Cs{constructor(e){this.items=void 0,this.items=[...e]}getRandomItem(){if(0===this.items.length)return;const e=Math.floor(Math.random()*this.items.length),t=this.items[this.items.length-1];return this.items[e]=t,this.items.pop()}}const Es=[1,32];let Os=function(e){return e[e.DEFAULT=0]="DEFAULT",e[e.NON_DEFAULT=1]="NON_DEFAULT",e}({});class Ms{constructor(e,t,s){this.type=e,this.shape=t,this.values=s}}class Ts extends Ms{constructor(e){super(Os.DEFAULT,e,new Float32Array)}createTensor(e){return e.ones(this.shape)}}class Rs extends Ms{constructor(e,t){super(Os.DEFAULT,e,t)}createTensor(e){return e.tensor(this.values,this.shape,"float32")}}class ws{constructor(){this.shape=Es}static getInstance(){return null===this.instance&&(this.instance=new ws),this.instance}setShape(e){this.shape=[1,e]}createDefaultUserEmbedding(){return new Ts(this.shape)}createNonDefaultUserEmbedding(e){return new Rs(this.shape,e)}}ws.instance=null;class Ls extends hs.b{constructor(...e){super(...e),this.tfLib=a.ModuleContainer.resolve(Et),this.resourceManager=a.ModuleContainer.resolve(us),this.negativeSampler=null,this.userEmbeddingFactory=ws.getInstance()}async reconstruct(e){const t=await this.getNegativeSampler(),s=await this.getSSConfig(),a=await this.getStickerToItem(),i=t.sampleNegativeIndices(e,a,s.numNegativePerEachPositive),n={};for(const[I,y]of Object.entries(e)){const e=a[I];void 0!==e&&(n[e]=Math.min(y,s.stickerUsageMaxValue))}i.forEach((e=>{n[e]=0}));const r=function(e,t){let s=[];for(const[r,o]of Object.entries(e))s.push([+r,o]);s=vs(s);const a=[];let i=0,n=Math.max(t,1);for(;i<s.length;){const e=s.slice(i,Math.min(i+n,s.length));a.push(e),i+=n}return a}(n,s.batchSize);this.userEmbeddingFactory.setShape(s.numLatentFactor);const o=this.userEmbeddingFactory.createDefaultUserEmbedding();let c=0,l=0,d=0,u=this.userEmbeddingFactory.createDefaultUserEmbedding();for(;d<s.numReconstructionRound;){for(const e of r){const t=await this.runOneStepReconstruct(e,o);u=t.userEmbedding,c+=t.loss,l+=1}d+=1}const h=Object.values(a).length,g=await this.predict(u,h);0===l&&(l=1);const m=Object.entries(g).sort(((e,t)=>t[1]-e[1])).map((([e])=>e)),p=Object.keys(a),f=new Set(m.slice(0,Math.min(m.length,50))),v=[];p.forEach((e=>{f.has(e)&&v.push(e)}));const _=0===p.length?0:1*v.length/p.length,b={loss:c/l,precision50:0===f.size?0:1*v.length/f.size,recall50:_,scores:g,reconsCount:Object.keys(e).length};return this.dispatchEvent(new fs(b)),b}async getTFModelInstance(){let e="";try{e=await this.getModelLoadURL();return await this.tfLib.loadGraphModel(e)}catch(t){throw gs.isUnavailableIDBModelResourceDataError(t)&&this.dispatchEvent(new ps(e)),t}}async predict(e,t){const s=new Int32Array(t).fill(0),a=new Int32Array(t).fill(0);let i=0;for(;i<t;)s[i]=i,a[i]=0,i+=1;let n=null,r=null,o=null,c=null,l=null,d=null;try{n=this.tfLib.tensor(s,void 0,"int32"),r=this.tfLib.tensor(s,void 0,"int32"),o=e.createTensor(this.tfLib),c=await this.getTFModelInstance(),l=c.predict({stickers:n,clicks:r,user_embedding:o}),d=await l[1].data()}catch(b){throw b}finally{var u,h,g,m,p;null===(u=n)||void 0===u||u.dispose(),null===(h=r)||void 0===h||h.dispose(),null===(g=o)||void 0===g||g.dispose(),null===(m=c)||void 0===m||m.dispose(),null===(p=l)||void 0===p||p.forEach((e=>e.dispose()))}const f=Math.min(d.length,t),v=await this.getItem2Sticker(),_={};for(i=0;i<f;){const e=v[i];void 0!==e&&(_[e]=d[i]),i+=1}return _}async runOneStepReconstruct(e,t){const s=e.length,a=new Int32Array(s).fill(0),i=new Int32Array(s).fill(0);let n=0;for(;n<s;){const t=e[n];[a[n],i[n]]=t,n+=1}let r=null,o=null,c=null,l=null;try{r=this.tfLib.tensor(a,void 0,"int32"),o=this.tfLib.tensor(i,void 0,"int32"),c=t.createTensor(this.tfLib),l=await this.getTFModelInstance();const e=l.predict({stickers:r,clicks:o,user_embedding:c}),s=await Promise.all(e.map((e=>e.data()))),n=s[0][0],d=s[1],u=s[2];return{loss:n,scores:d,userEmbedding:this.userEmbeddingFactory.createNonDefaultUserEmbedding(u)}}catch(m){throw m}finally{var d,u,h,g;null===(d=r)||void 0===d||d.dispose(),null===(u=o)||void 0===u||u.dispose(),null===(h=c)||void 0===h||h.dispose(),null===(g=l)||void 0===g||g.dispose()}}async getModelLoadURL(){const e=await this.resourceManager.model.get();if(null===e)throw new Error("No 'model_url' data is available!");return e.loadURL}async getModelSaveURL(){const e=await this.resourceManager.model.get();if(null===e)throw new Error("No 'model_url' data is available!");return e.saveURL}async getItem2Sticker(){const e=await this.resourceManager.item2Sticker.get();if(null===e)throw new Error("No 'item2Sticker' data is available!");return e}async getStickerToItem(){const e=await this.getItem2Sticker(),t={};for(const[s,a]of Object.entries(e))t[a]=+s;return t}async getKwd2Sticker(){const e=await this.resourceManager.kwd2Stickers.get();if(null===e)throw new Error("No 'kwd2Sticker' data is available!");return e}async getSSConfig(){const e=await this.resourceManager.config.get();if(null===e)throw new Error("No 'ss-config' data is available!");return e}async getNegativeSampler(){if(null===this.negativeSampler){const e=await this.getKwd2Sticker(),t=await this.getStickerToItem();this.negativeSampler=new bs(e,t)}return this.negativeSampler}}const Ds=Object(a.define)("tf-model/sticker-suggestion");a.ModuleContainer.registerSingleton(Ds,class extends Ls{});var As=s("6Sr9"),Fs=s("7rAU");let ks;var Ns;let Ps;var js;(Ns=ks||(ks={})).getMetadataExpireDurationInMsFromRawExpireTime=function(e){return 1e3*e},Ns.getReconstructExpireDurationInMsFromRawReconstructInterval=function(e){return 24*e*60*60*1e3},(js=Ps||(Ps={})).parseKwd2StickersResponse=function(e){const{index:t,map:s}=e;if(void 0===t)throw new Error("Missing 'index' field in kwd2Sticker response");if(void 0===s)throw new Error("Missing 'map' field in kwd2Sticker response");return{index:t,map:s}},js.parseSupportedItemsData=function(e){const t={};for(let s=0;s<e.length;s+=1){const[a,i]=e[s];t[s]=i}return t};var Us=s("ggcH"),Bs=s("zmG6"),zs=s("fc/q"),Gs=s("T+bx");function xs(e){const t=new Gs.a(Gs.b);let s=!1;function a(){s=!1,i()}function i(){const i=t.dequeue();null!==i&&function(t){s=!0;const{args:i,deferrer:n}=t;e(...i).then(n.resolve).catch(n.reject).finally(a)}(i)}return(...e)=>new Promise(((a,n)=>{var r;r={args:e,deferrer:{resolve:a,reject:n}},t.append(r),1===t.size&&(s||i())}))}var Vs=s("rdC+"),Hs=s("bJrp");hs.a;var Ws=s("a3bM");const qs=()=>{const e=n.default.getInstance(),t=e.getItemForCurrentUser(Fs.j);if(null===t)return null;let s=null;try{s=JSON.parse(t),"number"==typeof s&&(e.removeItemForCurrentUser(Fs.j),s=null)}catch(a){}return s},Ks=e=>{n.default.getInstance().setItemForCurrentUser(Fs.j,JSON.stringify(e))},Zs=()=>{const e=n.default.getInstance(),t=e.getItemForCurrentUser(Fs.m);if(null===t)return null;let s=null;try{s=JSON.parse(t),"number"==typeof s&&(e.removeItemForCurrentUser(Fs.m),s=null)}catch(a){}return s},$s=e=>{n.default.getInstance().setItemForCurrentUser(Fs.m,JSON.stringify(e))},Qs=()=>{const e=n.default.getInstance().getItemForCurrentUser(Fs.o);if(null===e)return null;let t=null;try{t=JSON.parse(e)}catch(s){}return t},Ys=e=>{n.default.getInstance().setItemForCurrentUser(Fs.o,JSON.stringify(e))};var Js=s("bBj6"),Xs=s("/bDn");class ea{static getInstance(){return null===this.instance&&(this.instance=new ea),this.instance}constructor(){this.data=null,this.loadDataContainer=null,this.logger=void 0;const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger("e2ee-sticker-suggestion",["kwd-2-last-clicked-sticker"])}async loadData(){if(null!==this.loadDataContainer)return this.loadDataContainer.promise;this.loadDataContainer=new E.c.Container;try{const t=n.default.getInstance(),s=await t.getItemForCurrentUserAsync(Fs.b);let a={};if(null!==s)try{a=JSON.parse(s)}catch(e){this.logger.zsymb(18,"TxA6TM",`Failed to parse kwd2LastClickedSticker data: ${e}`)}this.data=a,this.loadDataContainer.resolve()}catch(e){this.logger.zsymb(18,"TIIxLu",`Failed to load kwd2LastClickedSticker data: ${e}`),this.loadDataContainer.reject(e),this.loadDataContainer=null}}async getLastClickedSticker(e){return null===this.data&&await this.loadData(),this.data[e]||null}async setLastClickedSticker(e,t){null===this.data&&await this.loadData();const s=this.data[e];if(void 0===s||s.sticker_id!==t.sticker_id){this.data[e]=t;const s=n.default.getInstance(),a=JSON.stringify(this.data);await s.setItemForCurrentUserAsync(Fs.b,a)}}}ea.instance=null;class ta extends hs.b{constructor(){super(),this.resourceManager=a.ModuleContainer.resolve(us),this.cachedResourceStatus=null,this.tfModel=a.ModuleContainer.resolve(Ds),this.kwd2Sticker=null,this.sticker2Score=null,this.ssResourceConfig=null,this.metadata=null,this.kwd2LastClickedStickerResource=ea.getInstance(),this.metadataExpireHandler=null,this.reconstructionExpireHandler=null,this.updateResourceIfNeededContainer=null,this.didStartup=!1,this.qos=null,this.logger=void 0,this.removeListeners=()=>{},this.didScheduleStickerUsageCleanup=!1,this.partialKwd2Sticker={map:{},index:{}},this.disposeKwd2StickersCacheTimer=null;const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger("e2ee-sticker-suggestion",["module"]),this.runReconstructionIfNeeded=xs(this.runReconstructionIfNeeded.bind(this)),this.registerListeners();a.ModuleContainer.resolve(m.a).addEventListener(m.b.Exit,(()=>{this.removeListeners()}))}registerListeners(){const e=[];e.push(this.tfModel.addEventListener(ms.UnavailableModelResourceData,(()=>{this.reset()}))),e.push(this.tfModel.addEventListener(ms.DoneReconstruct,(async e=>{const t=Hs.a.getInstance();await t.onDoneReconstruct(e.data)})));const t=a.ModuleContainer.resolve(Us.TDBCorruptionDetector);e.push(t.addEventListener(Bs.a.DB_CORRUPTION_DETECTED,(e=>{const{corruptionInfo:t}=e,{databaseCorruptInfo:s}=t,{database:a}=s;a===Vs.a.baseConfig.name&&this.reset()}))),this.removeListeners=()=>{e.forEach((e=>e()))}}async recordSuggestion(e,t){try{const s=this.getKeywordVariantsToProcess(e),a=await Promise.allSettled(s.map((e=>{this.kwd2LastClickedStickerResource.setLastClickedSticker(e,t)})));for(const e of a)if("rejected"===e.status)throw e.reason}catch(s){0,this.logQosError(Fs.i.RECORD_SUGGESTION_FAILED,s)}}async recordUsage(e){try{await this.resourceManager.sticker2Click.recordClickCount(e)}catch(t){0,this.logQosError(Fs.i.RECORD_USAGE_FAILED,t)}}init(e){try{this.resourceManager.init(e);const t=()=>{const e=this.getSSMetadata();if(null===e)throw new Error("Unavailable model version");return e.sort_sticker_model.version},s=Hs.a.getInstance();s.registerGetModelVersionFn(t),s.ready()}catch(t){this.logger.zsymb(18,"i_VhVO",`[init] Failed: ${t}`),this.logQosError(Fs.i.INIT_FAILED,t)}}getKeywordVariantsToProcess(e){const t=Js.a.prepare(e);return[t,Js.a.stripVnmeseDiacritics(t)]}scheduleStickerUsageCleanUp(){if(this.didScheduleStickerUsageCleanup)return;this.didScheduleStickerUsageCleanup=!0;const e=new Xs.a(Qs,Ys,E.j.timeInMs("1D"));e.onExpired((()=>{try{this.resourceManager.sticker2Click.clearUnusedData(Fs.d)}catch(e){this.logger.zsymb(21,"FImaht",["Sticker usage clean up error: {}","_wnHFZ"],Object(Kt.c)(e))}})),e.start()}reset(){try{this.setSSMetadata(null),this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded(!0)}catch(e){this.logger.zsymb(18,"InE9tQ",`[reset] Failed: ${e}`),this.logQosError(Fs.i.RESET_FAILED,e)}}get enableFeature(){return!!Ws.a.nestedKey("metadata.sort_sticker_model.enable_feature")}getPriorityLastClick(){return!!Ws.a.key("priority_last_click").number}async predict(e){try{0;let t=null;this.getPriorityLastClick()&&(t=await this.kwd2LastClickedStickerResource.getLastClickedSticker(e));const s=await this.getSticker2Score(),a=null!==t;let i=[];const n=this.getKeywordVariantsToProcess(e);for(const e of n)if(i=await this.getStickerArtifactsMatchingKwd(e,(e=>{const{content:s}=e;if(a){return!(s.sticker_id===t.sticker_id)}return!0})),0!==i.length)break;if(0===i.length)return[];i=i.sort((({sticker_id:e},{sticker_id:t})=>s[t]-s[e]));return[...a?[t]:[],...i]}catch(t){throw this.logger.zsymb(21,"ENKqB1",["[predict] Keyword: '{}' - Failed: {}","AdjP83"],e,t),this.logQosError(Fs.i.PREDICT_FAILED,t),Hs.a.getInstance().onFailedToSuggest(t),t}}simulateErrorIfNeeded(){if(Jt.a.enable()){if(Jt.a.get("simulate_fail_suggest"))throw new Error("Oops! Something went wrong")}}async getStickerArtifactsMatchingKwd(e,t){let s=[],a={},i=!1;if(void 0!==this.partialKwd2Sticker.map[e])a=this.partialKwd2Sticker.index;else{const{map:t,index:s}=await this.getKwd2Stickers();this.partialKwd2Sticker.map[e]=t[e]||[],a=s,i=!0}s=this.partialKwd2Sticker.map[e];const n=[];for(const r of s){const e=a[r];void 0!==e&&(Object(_s.a)(e)&&t(e)&&n.push(e.content),i&&(this.partialKwd2Sticker.index[r]=e))}return n}initExpireDuration(e,t){let s=!1,a=!1;{const t=ks.getMetadataExpireDurationInMsFromRawExpireTime(e);null===this.metadataExpireHandler&&(this.metadataExpireHandler=new Xs.a(qs,Ks,t),this.metadataExpireHandler.onExpired((()=>{try{0,this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded()}catch(e){this.logger.zsymb(21,"Kq6jqb",["Metadata expire error: {}","ae9jD4"],Object(Kt.c)(e))}})),s=!0)}{let e=ks.getReconstructExpireDurationInMsFromRawReconstructInterval(t);0,null===this.reconstructionExpireHandler&&(this.reconstructionExpireHandler=new Xs.a(Zs,$s,e),this.reconstructionExpireHandler.onExpired((()=>{try{0,this.runReconstructionIfNeeded(!0)}catch(e){this.logger.zsymb(21,"9wJaxH",["Reconstruct expire error: {}","Ifev75"],Object(Kt.c)(e))}})),a=!0)}s&&this.metadataExpireHandler.start(),a&&this.reconstructionExpireHandler.start()}updateMetadataExpireDuration(e){const t=ks.getMetadataExpireDurationInMsFromRawExpireTime(e);null===this.metadataExpireHandler?this.logger.zsymb(18,"emfGPN","[ExpireHandler][metadata] Not init yet"):this.metadataExpireHandler.updateExpiredDuration(t)}updateReconstructExpireDuration(e){let t=ks.getReconstructExpireDurationInMsFromRawReconstructInterval(e);null===this.reconstructionExpireHandler?this.logger.zsymb(18,"GUlWcd","[ExpireHandler][reconstruct] Not init yet"):this.reconstructionExpireHandler.updateExpiredDuration(t)}isEqualMetadata(e,t){return e.expired_time===t.expired_time&&(e.sort_sticker_model.enable_feature===t.sort_sticker_model.enable_feature&&(e.sort_sticker_model.version===t.sort_sticker_model.version&&(e.sort_sticker_model.reconstruct_range===t.sort_sticker_model.reconstruct_range&&(e.sort_sticker_model.reconstruct_interval===t.sort_sticker_model.reconstruct_interval&&(e.sort_sticker_model.url===t.sort_sticker_model.url&&(e.mapkwdsticker.url===t.mapkwdsticker.url&&e.mapkwdsticker.version===t.mapkwdsticker.version))))))}updateMetadataIfNeeded(){if(!this.enableFeature)return void 0;const e=this.getSSMetadata();let t=!1,s=null;if(null===e){s=this.fetchSSMetadata(),t=!0;const{expired_time:e,sort_sticker_model:a}=s;this.initExpireDuration(e,a.reconstruct_interval)}else if(s=this.fetchSSMetadata(),t=!this.isEqualMetadata(e,s),t){const{expired_time:e}=s;this.updateMetadataExpireDuration(e);const{reconstruct_interval:t}=s.sort_sticker_model;this.updateReconstructExpireDuration(t)}else 0;t&&this.updateResourceIfNeeded(e,s)}shouldReconstructAgainstResourceChangeStatus(e){return e===Fs.g.BOTH_CHANGED||e===Fs.g.TF_MODEL_CHANGED_ONLY}async runReconstructionIfNeeded(e=!1){if(!this.enableFeature)return void this.logger.zsymb(6,"EvNu7U","[runReconstructionIfNeeded] Feature is disabled");let t=Fs.g.NOT_CHANGED;if(null!==this.updateResourceIfNeededContainer)t=await this.updateResourceIfNeededContainer.promise;else{switch(this.getResourceStatus()){case Fs.h.EMPTY:return void this.logger.zsymb(18,"RSZ50w","Failed to reconstruct due to empty resource");case Fs.h.ERROR:return void this.logger.zsymb(18,"KmT_Xa","Failed to reconstruct due to invalid resource")}}if(e||this.shouldReconstructAgainstResourceChangeStatus(t)){const e=this.getSSMetadata();if(null===e)throw new Error("Metadata is still unavailable after updating resource");let t=await this.getSticker2Click(e.sort_sticker_model.reconstruct_range);0;try{0;const{scores:e}=await this.tfModel.reconstruct(t);0,this.resourceManager.sticker2Score.set(e)}catch(s){throw this.logger.zsymb(21,"lfGmtd",["[runReconstructionIfNeeded] Run reconstruction failed: {}","jbSaGQ"],s),this.logQosError(Fs.i.RUN_RECONSTRUCT_FAILED,s),s}}else 0}async startup(){if(!this.didStartup)if(this.didStartup=!0,this.enableFeature){0;try{const e=this.getSSMetadata();if(null===e)this.updateMetadataIfNeeded(),this.runReconstructionIfNeeded();else{const{expired_time:t,sort_sticker_model:s}=e;0,this.initExpireDuration(t,s.reconstruct_interval)}this.scheduleStickerUsageCleanUp()}catch(e){0,this.logQosError(Fs.i.STARTUP_FAILED,e)}}else this.logger.zsymb(6,"BXx8AJ","[startup] Feature is disabled!")}async updateResourceIfNeeded(e,t){if(null!==this.updateResourceIfNeededContainer)return this.updateResourceIfNeededContainer.promise;this.updateResourceIfNeededContainer=new E.c.Container;let s=Fs.g.NOT_CHANGED;try{const a=null===e,i=[];if(a||this.isVersionOutDated(e.sort_sticker_model.version,t.sort_sticker_model.version)){s=Fs.g.TF_MODEL_CHANGED_ONLY;const{url:e,checksum_folder:a,checksum_zip:n}=t.sort_sticker_model,r=(async()=>{try{await this.updateModelResourceData({url:e,checksumFolder:a,checksumZip:n}),this.ssResourceConfig=null}catch(t){throw this.logQosError(Fs.i.UPDATE_MODEL_RESOURCE_DATA_FAILED,t),t}})();i.push(r)}if(a||this.isVersionOutDated(e.mapkwdsticker.version,t.mapkwdsticker.version)){s=s==Fs.g.NOT_CHANGED?Fs.g.KWD_2_STICKERS_CHANGED_ONLY:Fs.g.BOTH_CHANGED;const{url:e,checksum:a}=t.mapkwdsticker,n=(async()=>{try{await this.updateKwd2StickerResourceData({url:e,checksum:a}),this.kwd2Sticker=null,this.partialKwd2Sticker={map:{},index:{}}}catch(t){throw this.logQosError(Fs.i.UPDATE_KWD2STICKER_DATA_FAILED,t),t}})();i.push(n)}return await Promise.all(i),this.setSSMetadata(t),this.logger.zsymb(0,"9Zck-b","[updateResourceIfNeeded] Save new metadata"),this.setResourceStatus(Fs.h.READY),this.updateResourceIfNeededContainer.resolve(s),s}catch(a){throw this.setResourceStatus(Fs.h.ERROR),this.updateResourceIfNeededContainer.reject(a),this.logQosError(Fs.i.UPDATE_RESOURCE_FAILED_IN_GENERAL,a),a}finally{this.updateResourceIfNeededContainer=null}}fetchSSMetadata(){return Ws.a.key("metadata").object}isVersionOutDated(e,t){return e<t}getResourceStatus(){if(null!==this.cachedResourceStatus)return this.cachedResourceStatus;let e=Fs.h.EMPTY;const t=n.default.getInstance().getItemForCurrentUser(Fs.n);if(null!==t){const s=+t;Number.isNaN(s)||(e=s)}return this.cachedResourceStatus=e,e}setResourceStatus(e){if(this.cachedResourceStatus!==e){this.cachedResourceStatus=e;n.default.getInstance().setItemForCurrentUser(Fs.n,`${e}`)}}getSSMetadata(){if(null===this.metadata){const t=n.default.getInstance().getItemForCurrentUser(Fs.k);if(null===t)return null;try{this.metadata=JSON.parse(t)}catch(e){throw this.logQosError(Fs.i.PARSE_SS_METADATA_FAILED,e),new Error("Failed to parse ssMetadata data")}}return this.metadata}setSSMetadata(e){this.metadata=e;const t=n.default.getInstance();if(null===e)t.removeItemForCurrentUser(Fs.k);else{const s=JSON.stringify(e);t.setItemForCurrentUser(Fs.k,s)}}async getSticker2Click(e){const t=await this.resourceManager.sticker2Click.get(e);return null===t?{}:t}async getKwd2Stickers(){if(null===this.kwd2Sticker){const e=await this.resourceManager.kwd2Stickers.get();if(null===e)throw new Error("No 'kwd2Stickers' data is available!");this.kwd2Sticker=e}return null!==this.disposeKwd2StickersCacheTimer&&clearTimeout(this.disposeKwd2StickersCacheTimer),this.disposeKwd2StickersCacheTimer=setTimeout((()=>{this.kwd2Sticker=null}),Fs.c),this.kwd2Sticker}async getSSResourceConfig(){if(null===this.ssResourceConfig){const e=await this.resourceManager.config.get();if(null===e)throw new Error("No 'ssConfig' data is available!");this.ssResourceConfig=e}return this.ssResourceConfig}async getSticker2Score(){if(null===this.sticker2Score){const e=await this.resourceManager.sticker2Score.get();if(null===e)throw new Error("No 'sticker2Score' data is available!");this.sticker2Score=e}return this.sticker2Score}logQosError(e,t){null===this.qos&&(this.qos=a.ModuleContainer.resolve(zs.b));let s="Unknown error";"string"==typeof t?s=t:t instanceof Error&&(s=t.message),this.qos.log({commandId:Fs.l,subCommandId:0,duration:0,success:!1,errorCode:e,params:[s]})}}var sa,aa=s("lL1k"),ia=s("9Pyw"),na=s("RrMd"),ra=s("xOOu"),oa=s.n(ra),ca=s("rP9a");let la=Object(As.a)()(sa=class extends ta{onApplicationReady(){this.startup()}async updateModelResourceData(e){try{const{url:t,checksumZip:s}=e,a=new ia.a(t,na.b.MANUAL,(()=>{}),{checksum:s}),i=await a.downloadBlob(),n=await i.arrayBuffer(),r=await oa.a.loadAsync(n),o=[];{const e=(async()=>{const e=new RegExp(`${Fs.f}/.*`),t=r.file(e);if(0===t.length)throw new Error("No model data folder is available!");let s=[];const a=new RegExp(`^${Fs.f}/`);for(const i of t){if(i.dir)throw new Error("Invalid nested folder in model data folder!");{const e=await i.async("blob"),t={name:i.name.replace(a,""),data:e};s.push(t)}}s=s.sort(((e,t)=>{const{name:s}=e,{name:a}=t;if(s.endsWith(".json"))return-1;if(a.endsWith(".json"))return 1;const i=s.replace(".bin",""),n=a.replace(".bin","");return i.localeCompare(n)})),await this.resourceManager.model.saveData(s)})();o.push(e)}{const e=(async()=>{const e=r.file(Fs.e);if(null===e)throw new Error("No 'ssConfig' file is found!");const t=await e.async("string");try{const e=JSON.parse(t);await this.resourceManager.config.set(e)}catch(s){throw new Error("Invalid 'ssConfig' data")}})();o.push(e)}{const e=(async()=>{const e=r.file(Fs.a);if(null===e)throw new Error("No 'item2Index' file is found!");let t={};const s=await e.async("string");try{const e=JSON.parse(s);t=Ps.parseSupportedItemsData(e)}catch(a){throw new Error("Invalid 'ssConfig' data")}await this.resourceManager.item2Sticker.set(t)})();o.push(e)}await Promise.all(o)}catch(t){throw this.logger.zsymb(21,"cdMF0X",["Failed to update model resource data: {} - Error: {}","AQUDil"],JSON.stringify(e),Object(Kt.c)(t)),new Error(`Failed to update model resource data: ${t}`)}}async updateKwd2StickerResourceData(e){try{const{url:t,checksum:s}=e,a=new ia.a(t,na.b.MANUAL,(()=>{}),{checksum:s}),i=await a.downloadBlob(),n=await i.arrayBuffer(),r=ca.a.inflate(n,{to:"string"}),o=JSON.parse(r),c=Ps.parseKwd2StickersResponse(o);await this.resourceManager.kwd2Stickers.set(c)}catch(t){throw new Error(`Failed to update kwd2Sticker resource data: ${t}`)}}})||sa;a.ModuleContainer.registerSingleton(aa.a,la);var da=s("3t1t"),ua=s("JRkD"),ha=s("4b23"),ga=s("vNya");const ma=Object(ha.a)("1234567890abcdef",12);class pa{constructor(e){this.ONLOAD_TIMEOUT=1e4,this.instance=null,this.id=void 0,this.__createId__=void 0,this.__createName__=void 0,this.windowId="",this.popupTitle="",this.popupPath="",this.frame="",this.specs="",this.createWindow=async e=>{const{parentWindow:t,popupPath:s,frame:a,specs:i}=e;this.windowId=e.windowId,this.popupTitle=e.popupTitle,this.popupPath=s,this.frame=a||"",this.specs=i||"";const n=t.open(s,a,i);if(n){var r,o;null!==(r=n.document)&&void 0!==r&&r.body&&(n.document.body.style.backgroundColor="#1f1f1f"),this.instance=n,zconsole.zsymb(12,"zKSWfq","[MVR]: onWindowDOMContentLoaded event",null==n?void 0:n.document.readyState),e.onWindowCreated&&e.onWindowCreated(this.selfContext);const t=t=>{var s;zconsole.zsymb(12,"j_nmNG","[MVR]: onWindowDOMContentLoaded event",t.document.readyState),e.onWindowDOMContentLoaded&&e.onWindowDOMContentLoaded(t),"complete"===(null===(s=t.document)||void 0===s?void 0:s.readyState)?(zconsole.zsymb(0,"cpi6pN","[MVR]: Load is already fired. skip listener"),e.onWindowLoad&&e.onWindowLoad(t)):(zconsole.zsymb(0,"bl6tQZ","[MVR]: listen mvr load event"),this.onLoad(e.onWindowLoad))};return["interactive"].includes((null===(o=n.document)||void 0===o?void 0:o.readyState)||"")?(zconsole.zsymb(0,"qytFlT","[MVR]: DOMContentLoaded is already fired. skip listener"),t(n)):(zconsole.zsymb(0,"MR7evw","[MVR]: listen mvr DOMContentLoaded event"),this.onDOMContentLoaded(t)),zconsole.zsymb(12,"VUzPBy","[MVR]: onWindowDOMContentLoaded event",n.document.readyState),da.d.SUCCESS(n)}return da.d.FAILURE({code:da.b.CREATE_WINDOW_FAILED,message:"Cannot create new window"})},this.onBeforeUnload=()=>{Object(ua.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`),Object(ua.a)(!!this.windowId&&"string"==typeof this.windowId,`windowId must be a valid string. Received ${this.windowId}`);const e=()=>{var t;null===(t=this.instance)||void 0===t||t.removeEventListener("beforeunload",e),a.ModuleContainer.resolve(ga.a).close(this.windowId)};this.instance.addEventListener("beforeunload",e)},this.onDOMContentLoaded=e=>{Object(ua.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`);let t=null;const s=this.instance,a=()=>{s.removeEventListener("DOMContentLoaded",a),e&&"function"==typeof e&&e(s),this.onBeforeUnload(),t&&s.clearTimeout(t)};t=s.setTimeout((()=>{s.removeEventListener("DOMContentLoaded",a),e&&"function"==typeof e&&e(s)}),this.ONLOAD_TIMEOUT),s.addEventListener("DOMContentLoaded",a)},this.onLoad=e=>{Object(ua.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`);const t=this.instance;let s=null;const a=()=>{t.removeEventListener("load",a),e&&"function"==typeof e&&e(t),s&&t.clearTimeout(s)};s=t.setTimeout((()=>{t.removeEventListener("load",a),e&&"function"==typeof e&&e(t)}),this.ONLOAD_TIMEOUT),t.addEventListener("load",a)},this.__createName__=e,this.__createId__=ma(),this.id=`zalo_popup_${ma(7)}`}cleanup(){var e;null===(e=this.instance)||void 0===e||e.removeEventListener("beforeunload",this.onBeforeUnload)}getCurrentWindowSizes(){try{var e,t,s,a,i,n;return Object(ua.a)(!!this.instance,`windowInstance must be a valid object. Received ${this.instance}`),Object(ua.a)(!(null===(e=this.instance)||void 0===e||!e.outerWidth)&&"number"==typeof(null===(t=this.instance)||void 0===t?void 0:t.outerWidth),`outerWidth must be a valid number. Received ${null===(s=this.instance)||void 0===s?void 0:s.outerWidth}`),Object(ua.a)(!(null===(a=this.instance)||void 0===a||!a.outerHeight)&&"number"==typeof(null===(i=this.instance)||void 0===i?void 0:i.outerHeight),`outerHeight must be a valid number. Received ${null===(n=this.instance)||void 0===n?void 0:n.outerHeight}`),{w:this.instance.outerWidth,h:this.instance.outerHeight}}catch(r){return zconsole.zsymb(18,"ihSGDY","[MVR]: getCurrentWindowSizes error",r),null}}}var fa;let va=Object(a.injectable)()(fa=Reflect.metadata("design:type",Function)(fa=Reflect.metadata("design:paramtypes",[])(fa=class extends pa{constructor(){super("__electron.browserwindow__"),this.create=async e=>{Object(ua.a)(!!e.parentWindow,"parentWindow must be a valid window object"),Object(ua.a)("string"==typeof e.windowId,"windowId must be a string. Received "+typeof e.windowId),Object(ua.a)("string"==typeof e.popupPath&&!!e.popupPath,`popupPath must be a valid string. Received ${e.popupPath}`),Object(ua.a)("string"==typeof e.popupTitle,"popupTitle must be a string. Received "+typeof e.popupTitle);const t=await this.createWindow(e);if("ERROR"===t.type)throw t;return da.d.SUCCESS(this)},this.focus=async()=>{if(!this.instance)throw da.d.FAILURE({code:da.b.FOCUS_NULL_WINDOW,message:"WINDOW NOT FOUND",stack:null});try{await $zwindow.focus(this.windowId)}catch(e){throw da.d.FAILURE({code:da.b.FOCUS_WINDOW_FAILED,message:`Failed to focus ${this.windowId}`,stack:e})}},this.close=async()=>{this.instance=null;try{await $zwindow.closeWindow(this.windowId)}catch(e){}finally{this.cleanup()}},this.getInfoScreenOfMouse=e=>{var t;const s=$zelectron.getInfoScreenOfMouseSync(),a=null===(t=K.default.getPopupWindowInstance(s))||void 0===t?void 0:t.windowInstance,i=a?null==a?void 0:a.screen:window.screen;return{x:i.availLeft||i.left||0,y:i.availTop||i.top||0,w:i.width,h:i.height,availW:i.availWidth,availH:i.availHeight}}}get selfContext(){return this}get closed(){throw new Error("Method not implemented.")}get focused(){throw new Error("Method not implemented.")}get visible(){throw new Error("Method not implemented.")}cleanup(){this.instance&&(super.cleanup(),this.instance=null)}})||fa)||fa)||fa;a.ModuleContainer.register(da.c,va);const _a=Object(a.define)("pulloffline-reporter");var ba,Ia=s("Yi2m");const ya="rp_ofl_p";Object(a.singleton)(_a)(ba=Reflect.metadata("design:type",Function)(ba=Reflect.metadata("design:paramtypes",[])(ba=class{constructor(){this.logger=void 0,this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("offline-monitor",["reporter"])}reportLastSession(){const e=n.default.getInstance().getObject(ya);e&&(this.logger.zsymb(0,"1k9MD2","detect last session"),this.report(e))}report(e){this.logger.zsymb(0,"ddq3fA","report: ",JSON.stringify(e)),Ia.default.logActionInfoV2(Ia.FeaturesInfo.PullOffline,1,e,[],!0);n.default.getInstance().removeItem(ya)}saveDraft(e){n.default.getInstance().setObject(ya,e),this.logger.zsymb(0,"2gdR-8","draft saved: ",JSON.stringify(e))}log(e){this.logger.zsymb(0,"R828kT","log: ",JSON.stringify(e))}})||ba)||ba);var Sa,Ca=s("BkRI"),Ea=s.n(Ca),Oa=s("AtyM"),Ma=s("eBe7"),Ta=s("yrNp"),Ra=function(e){return e.AfterApi="afterApi",e.AfterSavedDB="afterSavedDB",e}(Ra||{});Object(a.singleton)(Ta.a)(Sa=class extends hs.b{constructor(...e){super(...e),this.timeUsage={startTrackingTime:0,afterApi:0,afterSavedDB:0},this.info=null,this.started=!1}onStart(){this.started||(this.resetMonitor(),this.started=!0,this.timeUsage.startTrackingTime=Oa.a.now(),this.dispatchEvent(new Ma.d))}onDoneApi(){this.takeSnapshot(Ra.AfterApi)}onSavedDB(){this.takeSnapshot(Ra.AfterSavedDB)}onSettled(e,t){this.started&&(this.started=!1,this.info=null!=e?{error:e}:{result:t},this.dispatchEvent(new Ma.b(e,t)))}onSkip(){this.resetMonitor(),this.dispatchEvent(new Ma.c)}getCollectedMetrics(){let e={error:new Error("Incompleted metric")};return null===this.info||(e="error"in this.info?{error:this.info.error}:{result:this.info.result}),Ea()(Object(I.a)({timeUsage:Object(I.a)({},this.timeUsage)},e))}takeSnapshot(e){this.timeUsage[e]=Oa.a.now()-this.timeUsage.startTrackingTime}resetMonitor(){this.timeUsage={startTrackingTime:0,afterApi:0,afterSavedDB:0},this.info=null}});var wa=s("oq0C");const La=()=>void 0!==Ce.default.socket.offline_monitor.enable&&Ce.default.socket.offline_monitor.enable,Da=()=>void 0!==Ce.default.socket.offline_monitor.latency_time?Ce.default.socket.offline_monitor.latency_time:3e4,Aa=()=>void 0!==Ce.default.socket.offline_monitor.exclude_monitors_queues?Ce.default.socket.offline_monitor.exclude_monitors_queues:["516","517","518","519"];var Fa=s("rkiK");let ka;!function(e){function t(e,t,s){const a={lowestFPS:60,dropTime:e[s].ts-e[t].ts};for(let i=t;i<=s;i++)e[i].fps<a.lowestFPS&&(a.lowestFPS=e[i].fps);return a}e.getDroppeds=function(e,s){let a=0,i=0,n=s[0].fps<=e;const r=[];return s.forEach(((o,c)=>{n?(o.fps>e&&(i=c,n=!1,r.push(t(s,a,i))),c==s.length-1&&o.fps<=e&&(i=c,n=!1,r.push(t(s,a,i)))):o.fps>e?(a=c,n=!1):c==s.length-1?(i=c,n=!1,r.push(t(s,a,i))):n=!0})),r}}(ka||(ka={}));var Na,Pa=s("m0Bc");const ja={dropCount:0,min:60,dropTime:0};var Ua=function(e){return e.BeforePull="beforePull",e.InPull="inPull",e.InSaveDB="inSaveDB",e.AfterSaveDB="afterSaveDB",e}(Ua||{});let Ba=Object(a.singleton)(wa.a)(Na=Reflect.metadata("design:type",Function)(Na=Reflect.metadata("design:paramtypes",[void 0===_a?Object:_a])(Na=class extends hs.b{constructor(e){super(),this.reporter=e,this.cpuUsage=void 0,this.fpsUsage=void 0,this.timeUsage=void 0,this.lastActionId=void 0,this.countData={},this.countConv={},this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.callStartPullCount=0,this.actionIdSnapshot={},this.monitorQueues=new Set,this.timeStartChat={},this.isFirstSnapshot=!0,this.fpsRecorder={},this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(I.a)({},ja),inPull:Object(I.a)({},ja),inSaveDB:Object(I.a)({},ja),afterSaveDB:Object(I.a)({},ja)},this.lastActionId={}}startMonitor(){return La(),this.reporter.reportLastSession(),La()?(this.getCPU(),this.trackFPS(Ua.BeforePull),Promise.resolve()):Promise.resolve()}async stopMonitor(){this.timeStartChat.group&&!this.timeUsage.waitSendGr&&(this.timeUsage.waitSendGr=Oa.a.now()-this.timeStartChat.group),this.timeStartChat.oneone&&!this.timeUsage.waitSendOO&&(this.timeUsage.waitSendOO=Oa.a.now()-this.timeStartChat.oneone),await this.takeSnapshot(Ua.AfterSaveDB),this.reporter.report({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData})}getCollectedMetrics(){const e=Object.entries(this.countConv).reduce(((e,[t,s])=>Object(I.a)(Object(I.a)({},e),{},{[t]:s.size})),{});return{isFirstSnapshot:this.isFirstSnapshot,cpuUsage:Object(I.a)({},this.cpuUsage),fpsUsage:Object(I.a)({},this.fpsUsage),timeUsage:Object(I.a)({},this.timeUsage),countData:Object(I.a)({},this.countData),countConv:e}}resetMonitor(){this.monitorQueues.clear(),this.started=!1,this.isDoneMonitor=!1,this.doneOfflineCount=0,this.donePullCount=0,this.timeUsage={startTrackTime:0,beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0,openConv:0,waitSendOO:0,waitSendGr:0},this.cpuUsage={beforePull:0,inPull:0,inSaveDB:0,afterSaveDB:0},this.fpsUsage={beforePull:Object(I.a)({},ja),inPull:Object(I.a)({},ja),inSaveDB:Object(I.a)({},ja),afterSaveDB:Object(I.a)({},ja)},this.lastActionId={},this.actionIdSnapshot={},this.countData={},this.countConv={},this.timeStartChat={}}addMonitorQueues(e){const t=Aa();e.forEach((e=>{t.some((t=>e.startsWith(t)))||this.monitorQueues.add(e)})),this.monitorQueues}async onStartPoll(e){if(this.callStartPullCount++,!La())return;if(this.callStartPullCount%2==1&&this.resetMonitor(),this.addMonitorQueues(e),this.started,this.callStartPullCount,this.started)return;this.started=!0,this.timeUsage.startTrackTime=Oa.a.now();const t=this.callStartPullCount<=2?Pa.e.Startup:Pa.e.Resume;this.dispatchEvent(new Pa.d(t)),await this.takeSnapshot(Ua.BeforePull),this.trackFPS(Ua.InPull)}async onEndPoll(e,t){La()&&this.monitorQueues.has(e)&&(La(),this.lastActionId[e]=t,this.donePullCount++,this.monitorQueues.size==this.donePullCount&&(await this.takeSnapshot(Ua.InPull),this.trackFPS(Ua.InSaveDB)))}onPollData(e,t){if(La()&&!this.isDoneMonitor&&this.monitorQueues.has(e))switch(this.countData[e]||(this.countData[e]=0),this.countConv[e]||(this.countConv[e]=new Set),e){case"510_0":case"513_0":case"515_0":case"510_1":case"513_1":case"515_1":this.countData[e]+=t.data.msgs.length,this.countData[e]+=t.data.pageMsgs.length;for(const a of t.data.msgs)try{this.countConv[e].add(a.idTo)}catch(s){}for(const a of t.data.pageMsgs)try{this.countConv[e].add(a.idTo)}catch(s){}break;case"511_0":case"514_0":case"511_1":case"514_1":this.countData[e]+=t.data.groupMsgs.length;for(const a of t.data.groupMsgs)try{this.countConv[e].add(a.idTo)}catch(s){}break;case"610_0":case"611_0":case"610_1":case"611_1":this.countData[e]+=t.data.reacts.length,this.countData[e]+=t.data.reactGroups.length;for(const a of t.data.reacts)try{this.countConv[e].add(a.idTo)}catch(s){}for(const a of t.data.reactGroups)try{this.countConv[e].add(a.idTo)}catch(s){}break;case"603_0":case"603_1":this.countData[e]+=t.data.controls.length}}onSavedData(e){if(!this.isDoneMonitor&&La()){this.actionIdSnapshot;for(const t in e)this.monitorQueues.has(t)&&this.lastActionId[t]&&this.actionIdSnapshot[t]!==e[t]&&(this.checkDoneDoOffline(t,e[t]),this.actionIdSnapshot[t]=e[t])}}onOpenConversation(e){"string"==typeof e&&0===this.timeUsage.openConv&&(this.timeUsage.openConv=Oa.a.now()-this.timeUsage.startTrackTime)}onStartChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeStartChat.group?this.timeStartChat.group=Oa.a.now():this.timeStartChat.oneone||(this.timeStartChat.oneone=Oa.a.now()))}onEncryptChat(e){"string"==typeof e&&(e.startsWith("g")&&!this.timeUsage.waitSendGr?this.timeUsage.waitSendGr=Oa.a.now()-this.timeStartChat.group:this.timeUsage.waitSendOO||(this.timeUsage.waitSendOO=Oa.a.now()-this.timeStartChat.oneone))}async checkDoneDoOffline(e,t){if(this.lastActionId[e],this.doneOfflineCount==this.monitorQueues.size)return;const s=this.lastActionId[e];s&&Number(t)==Number(s)&&(this.doneOfflineCount++,this.doneOfflineCount==this.monitorQueues.size&&(this.isDoneMonitor=!0,await this.takeSnapshot(Ua.InSaveDB),this.trackFPS(Ua.AfterSaveDB),this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData}),this.isFirstSnapshot=!1,this.dispatchEvent(new Pa.a),setTimeout((()=>{this.stopMonitor(),this.dispatchEvent(new Pa.b)}),Da())))}async takeSnapshot(e){const t=await this.getCPU(),s=this.getFPS(e);this.cpuUsage[e]=t,this.fpsUsage[e]=s,this.timeUsage[e]=Oa.a.now()-this.timeUsage.startTrackTime,this.reporter.saveDraft({isFirstSnapshot:this.isFirstSnapshot,cpuUsage:this.cpuUsage,fpsUsage:this.fpsUsage,timeUsage:this.timeUsage,countData:this.countData})}async getCPU(){return 0}trackFPS(e){this.fpsRecorder[e]=Fa.default.Fps.registerSectionRecorder(e),this.fpsRecorder[e].start()}getFPS(e){var t;const s=null===(t=this.fpsRecorder[e])||void 0===t?void 0:t.end();if(delete this.fpsRecorder[e],!s||0==s.fpsHistory.length)return ja;const a=ka.getDroppeds(50,s.fpsHistory);if(0==a.length)return ja;const i=a.reduce(((e,t)=>e+=t.dropTime),0),n=Math.min(...a.map((e=>e.lowestFPS)));return{dropCount:a.length,dropTime:i,min:n}}})||Na)||Na)||Na;var za;Object(a.injectable)()(za=Object(a.singleton)(wa.a)(za=function(e,t){return Object(a.inject)(_a)(e,void 0,0)}(za=Reflect.metadata("design:type",Function)(za=Reflect.metadata("design:paramtypes",[void 0===_a?Object:_a])(za=class extends Ba{constructor(e){super(e)}async getCPU(){const e=(await $zperf.getCpuInfos()).reduce(((e,t)=>e+=t.cpu.percentCPUUsage||0),0);return Math.round(e)}})||za)||za)||za)||za);var Ga=s("zgbJ"),xa=s("BuY5"),Va=s("QOJ3"),Ha=s("JUJ1"),Wa=s("//ub");let qa=function(e){return e.HandleOfflineData="HANDLE_OFFLINE_DATA",e.Sample="SAMPLE",e}({}),Ka=function(e){return e[e.FRESH_START=1]="FRESH_START",e[e.RESUME=2]="RESUME",e[e.UNKNOWN=-1]="UNKNOWN",e}({});var Za;let $a=Object(Wa.b)()(Za=Reflect.metadata("design:type",Function)(Za=Reflect.metadata("design:paramtypes",[])(Za=class e extends Ha.a{static getInstance(){return Va.a.resolve(e)}constructor(){super({collections:Object.values(qa)})}collect(e){if("end"===e.action)this.report()}start(e){E.c.Macrotask.push((()=>{var t,s;null===(t=this.collection(e))||void 0===t||null===(s=t.metric())||void 0===s||s.start()}))}end(e,t){E.c.Macrotask.push((()=>{var s,a;null===(s=this.collection(e))||void 0===s||null===(a=s.metric())||void 0===a||a.end(t)}))}once(e,t){E.c.Macrotask.push((()=>{var s,a;null===(s=this.collection(e))||void 0===s||null===(a=s.metric())||void 0===a||a.once(t)}))}record(e,t){E.c.Macrotask.push((()=>{var s;null===(s=this.collection(e))||void 0===s||s.metric().record(t)}))}cancel(e){const t=this.collection(e);if(!t)return;const s=t.defaultId;t.removeMetric(s)}submitActionLog(e){Ia.default.logActionInfoV2(e.id,e.subType,e.data)}report(){const e=Object.values(qa);for(const s of e){var t;const e=null===(t=this.collection(s))||void 0===t?void 0:t.metric();if(!e||!e.isReadyToGetReport)continue;const a=e.report();if(!a)continue;let i;switch(s){case qa.HandleOfflineData:{const{convListSort:e,workload:t,result:s,error:n,timeUsage:r,offlineInfo:o}=a.metadata;if(0===o.tsOffline)i={id:-1,subType:-1,data:{}};else{i={id:Ia.FeaturesInfo.Offline2Online,subType:1,data:{conv_list_sort:{count:e.count},pull:{count_msg_data:t.msgPull,count_conv_data:t.convPull,count_msg_success:s.msgPull,time:r.pull},offline_info:{offline_time:o.tsOffline,online_time:o.tsOnline,online_type:o.onlineType}}};!!t.msgPreProcess&&(i.data.pre=Object(I.a)({count_msg_data:t.msgPreProcess,time:r.preProcess},n&&n.preProcess?{error:n.preProcess}:{}))}break}case qa.Sample:default:i={id:-1,subType:-1,data:{}}}-1!==i.id&&this.submitActionLog(i)}}})||Za)||Za)||Za;var Qa=s("FlN1");const Ya=Object(a.define)("offline-detector"),Ja=Object(a.define)("event-bus"),Xa="last-online-detector",ei=Object(a.define)(Xa),ti=Object(a.define)(`${Xa}-socket-polling`),si=Object(a.define)(`${Xa}-local-storage`);var ai=s("rXIX"),ii=s("rQsU");class ni{constructor(){this.result={numOfOrderChanges:0},this.unregisterListeners=()=>{},this.prevConvListOrderSnapshot=null}static getInstance(){return null===this.instance&&(this.instance=new ni),this.instance}startTracking(){this.registerListeners()}stopTracking(){this.unregisterListeners()}getTrackingResult(){return Ea()(this.result)}reset(){this.result={numOfOrderChanges:0},this.prevConvListOrderSnapshot=null}registerListeners(){const e=[],t=a.ModuleContainer.resolve(ii.b);e.push(t.addEventListener(ai.c.SignalRenderList,(e=>{this.recordSnapshotChange(e.listVisible)}))),this.unregisterListeners=()=>{e.forEach((e=>e()))}}recordSnapshotChange(e){const t=this.isConvListOrderChanged(e);t&&(this.result.numOfOrderChanges+=1),t&&this.result.numOfOrderChanges}isConvListOrderChanged(e){let t=!1;if(Array.isArray(e)&&null!==this.prevConvListOrderSnapshot){const s=this.prevConvListOrderSnapshot,a=e;for(let e=a.length-1;e>=0;e-=1)if(s[e]!==a[e]){t=!0;break}}return this.prevConvListOrderSnapshot=e,t}}ni.instance=null;var ri=s("3NFW"),oi=s("s40A"),ci=s("IfQO"),li=s("JhTw");class di{static getInstance(){return null===this.instance&&(this.instance=new di),this.instance}constructor(){this.logger=void 0;const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger(w.ZLoggerNametags.offline2Online,["offline-data"])}init(){ci.a.getInstance().init(),this.registerAllListeners()}registerAllListeners(){const e=ci.a.getInstance();e.addEventListener(li.c.Start,(()=>{xa.a.reset(),this.setConvListAnimationMode(Qa.b.ADVANCED),this.resetConvListOrderTracker(),this.startTrackingConvListOrder(),this.cancelO2OMetric(),this.startO2OMetric(),this.signalKeepLoadingScreenIfNeed()})),e.addEventListener(li.c.End,(async e=>{await Object(oi.c)(2e3),this.stopTrackingConvListOrder();const t=this.getTrackingConvListOrderResult();this.resetConvListOrderTracker();const{result:s}=e,a=await this.getOfflineInfo();this.endO2OMetric(s,t,{tsOffline:a.tsOffline,tsOnline:a.tsOnline,onlineType:s.offlineInfo.onlineType});const i=ri.a.getInstance();await i.stop()})),e.addEventListener(li.c.PreProcessingSettle,(e=>{this.recordPreProcessingResultForO2OMetric(e.error,e.result),this.signalDismissLoadingScreen()})),e.addEventListener(li.c.OfflineProcessingUIDone,(()=>{this.setConvListAnimationMode(Qa.b.NORMAL),xa.a.reset()}))}setConvListAnimationMode(e){Qa.a.getInstance().setAnimationMode(e)}cancelO2OMetric(){$a.getInstance().cancel(qa.HandleOfflineData)}startO2OMetric(){$a.getInstance().start(qa.HandleOfflineData)}startTrackingConvListOrder(){ni.getInstance().startTracking()}endO2OMetric(e,t,s){$a.getInstance().end(qa.HandleOfflineData,{convListSort:{count:t.numOfOrderChanges},fps:e.fps,cpu:e.cpu,workload:{msgPull:e.workload.msgPull,convPull:e.workload.convPull,msgPreProcess:e.workload.msgPreProcess},timeUsage:{pull:e.timeUsage.pull,preProcess:e.timeUsage.preProcess},result:{msgPull:e.result.msgPull},offlineInfo:{tsOffline:s.tsOffline,tsOnline:s.tsOnline,onlineType:(()=>{switch(s.onlineType){case li.a.FRESH_START:return Ka.FRESH_START;case li.a.RESUME:return Ka.RESUME;default:return Ka.UNKNOWN}})()}})}stopTrackingConvListOrder(){ni.getInstance().stopTracking()}getTrackingConvListOrderResult(){return ni.getInstance().getTrackingResult()}resetConvListOrderTracker(){ni.getInstance().reset()}async getOfflineInfo(){const e={tsOffline:-1,tsOnline:-1};try{const t=a.ModuleContainer.resolve(ei),[s,i]=await Promise.all([t.getStartTsOnlineCurrSession(),t.getLastTsOnlinePrevSession()]);e.tsOffline=i,e.tsOnline=s}catch(t){this.logger.zsymb(21,"zGn6Wy",["Failed to get offline info: {}","hx95sg"],Object(Kt.c)(t))}return e}recordPreProcessingResultForO2OMetric(e,t){const s=$a.getInstance();if(null!==e)s.record(qa.HandleOfflineData,{error:{preProcess:Object(Kt.c)(e)}});else{if(!t)return void this.logger.zsymb(0,"atIyqH","[recordPreProcessingResultForO2OMetric] Empty result");if(!["allmsgs","clearUnreads","clearUnreadsReact"].every((e=>e in t)))return void this.logger.zsymb(18,"ajbvyt","[recordPreProcessingResultForO2OMetric] Invalid result");let e=0,a=0,i=0,n=0;t.allmsgs.forEach((t=>{const{isGroup:s,cmd:r}=t;s?122===r?a+=1:n+=1:122===r?e+=1:i+=1})),s.record(qa.HandleOfflineData,{workload:{msgPreProcess:{"1_1":e,group:a,e2ee1_1:i,e2eeGroup:n,clearUnreads:t.clearUnreads.length,clearUnreadsReact:t.clearUnreadsReact.length}}})}}signalKeepLoadingScreenIfNeed(){a.ModuleContainer.resolve(Ga.c).startKeepLoadingIfNeeded()}async signalDismissLoadingScreen(){a.ModuleContainer.resolve(Ga.c).dismissLoadingScreen()}}di.instance=null,di.getInstance().init();s("tPRg");var ui=s("z0WU"),hi=(s("FcQj"),s("sxU/")),gi=s("eSGF");let mi;function pi(){return mi||(mi=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("utils",["event-bus-effects"])),mi}const fi={[ve.FetchActions.DELETE_MESSAGE]:(e,t)=>{var s;vi(e.toUid||e.userId||(null===(s=e.conversation)||void 0===s?void 0:s.userId),e.msgId)},[ve.FetchActions.DELETE_EVERYONE]:(e,t)=>{vi(e.toUid,e.msgId)},[ve.FetchActions.UNDO_MULTI]:(e,t)=>{var s;null==e||null===(s=e.forEach)||void 0===s||s.call(e,(e=>vi(e.toUid||e.userId,e.msgId)))},[ve.FetchActions.UNDO]:(e,t)=>{vi(e.toUid||e.userId,e.msgId)},[ve.FetchActions.REMOVE_MEDIA]:(e,t)=>{for(let s of e.items)vi(null==e?void 0:e.conversationId,null==s?void 0:s.msgId)},[ve.ChatBoxActions.REMOVE_EXPIRED_MEDIA]:(e,t)=>{vi(null==e?void 0:e.conversationId,(null==e?void 0:e.msgIds)||(null==e?void 0:e.msgId))},[ve.ChatBoxActions.DELETE_MESSAGE]:(e,t)=>{const s=e.toUid||e.userId||e.conversation&&e.conversation.userId;s!==Ce.default.sendToMeId&&vi(s,e.msgId)}};function vi(e,t){if(!e)return;if(!t)return;let s=Object(gi.a)(t);hi.a.instance.emit("media-removed",{convId:e,msgIds:s})}_e.default.subscribe((function(e,t){let s=fi[e];if(s)try{s(t,e)}catch(a){pi().zsymb(18,"TyFHfQ","Failed to run side effect for event:"+e),pi().zsymb(18,"WVFz6v",[a])}}));var _i=s("2ua2");s.p;_i.default.init(),ui.default.checkSupport(),ui.default.showWarningMsg();var bi,Ii=s("UiPd"),yi=s("Kvb3"),Si=s("lTs8"),Ci=s("DvVh"),Ei=s("Y4eg"),Oi=s("+2cI");Object(a.singleton)(yi.a)(bi=Object(m.f)()(bi=Reflect.metadata("design:type",Function)(bi=Reflect.metadata("design:paramtypes",[])(bi=class{constructor(){this._isConnectSignalChangeInfo=void 0,this._dispatch=void 0,this._authEvent=void 0,this._isConnectSignalChangeInfo=!1,this.signalInfoChange=this.signalInfoChange.bind(this)}isWeb(){return!1}bindDispatch(e){this._dispatch=e}getDispatch(){return this._dispatch}get dispatch(){return this._dispatch}async preFormatPayload(e){var t;let s=Object(I.a)({},e);if(s.conversation){var a,i;if(null===(a=s.conversation.userId)||void 0===a||null===(i=a.startsWith)||void 0===i?void 0:i.call(a,Y.GROUPID_PREFIX)){const e=s.conversation.userId,t=await me.a.GroupManager.get(e);if(t&&(s.conversation.topMember=t.topMembers,s.conversation.displayName=t.displayName),s.conversation.topMember)for(const a of s.conversation.topMember){const e=Ii.default.getMiniInfo(a.id);e&&(a.dName=e.dName,a.avatar=e.avatar)}}else{const e=Ii.default.getMiniInfo(s.conversation.userId);e&&(s.conversation.displayName=e.dName,s.conversation.avatar=e.avatar)}}return(null===(t=s.images)||void 0===t?void 0:t.length)>1&&s.message&&(s.images=[s.message]),s}signalInfoChange(e){this.isWeb()}connectSignalToFriendWorker(){this._isConnectSignalChangeInfo||(this._isConnectSignalChangeInfo=!0,Ii.default.connectSignalChangeDNameAndAvatar(this.signalInfoChange))}onAuthenticated(e){this._authEvent=e}_addSession(e){var t;return(e=Object(I.a)({},e)).session=null===(t=this._authEvent)||void 0===t?void 0:t.getSession(),e}async openPhotoViewer(e){var t;let s=await this.preFormatPayload(e);s=this._addSession(s),this.connectSignalToFriendWorker();const a=this.getDispatch();a&&a({type:ve.ChatBoxActions.SHOW_FULL_IMAGE,payload:s}),Ei.a.initLog(),Oi.a.startSession(),Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,null!==(t=s)&&void 0!==t&&t.isVideo?Ci.d.openVideo:Ci.d.openPhoto)}async openImageCaptionEditor(e){let t=await this.preFormatPayload(e);t=this._addSession(t),this.connectSignalToFriendWorker();const s=this.getDispatch();s&&s({type:ve.ChatBoxActions.SHOW_MEDIA_CAPTION_EDITOR,payload:t})}})||bi)||bi)||bi);var Mi,Ti=s("MLNQ"),Ri=s("Gd06");Object(a.singleton)(Ri.a)(Mi=class extends Ti.a{initialize(e){this.createModuleInstances(e)}onCloseChildWindow(e){this.getModules(e).forEach((t=>{t&&t.onCloseChildWindow&&"function"==typeof t.onCloseChildWindow&&t.onCloseChildWindow(e)})),this.releaseModules(e)}onOpenChildWindow(e){this.initialize(e);this.getModules(e).forEach((t=>{t&&t.onOpenChildWindow&&"function"==typeof t.onOpenChildWindow&&t.onOpenChildWindow(e)}))}});s("B3nq");var wi=s("IpzU"),Li=s("J1YY"),Di=s("Qb9l"),Ai=s("C64z"),Fi=s("TVUr");class ki{constructor(){this.logger=void 0,this.zrfControlService=void 0,this.logger=Object(Li.a)("TempCleanupService"),this.zrfControlService=Fi.a.instance()}static instance(){return this._instance||(this._instance=new ki),this._instance}async removeTempFolder(){try{const e=Object(wi.getZaloDownloadsTempDirSync)();let t=0,s=0;if(await Object(Ai.fileExistsV2)(e)){const a=await $znode.fsPromise.readdir(e);for(const i of a){const{isSuccess:a,fileSize:n}=await this.removeFile($znode.path.join(e,i));a&&(t+=n,s++)}await this.removeFolder(e)}return{isSuccess:!0,totalSize:t,fileCount:s}}catch(e){return this.logger.zsymb(18,"6ty94V","Error removing temp folder",e),{isSuccess:!1,totalSize:0,fileCount:0}}}async removeFile(e){try{const t=$znode.fsExtra.statSync(e).size;return await $znode.fsExtra.remove(e),{isSuccess:!0,fileSize:t}}catch(t){return this.logger.zsymb(18,"gvPTND","Error removing file",t),{isSuccess:!1,fileSize:0}}}async removeFolder(e){try{await $znode.fsExtra.remove(e)}catch{}}async cleanup({bypassCheck:e=!1}={}){try{const t=this.zrfControlService.getCleanupInterval(),s=n.default.getInstance(),a=parseInt(s.getItem(Di.d)||"0");if(!(!!e||(!a||Date.now()-a>=t)))return{isSuccess:!1,totalSize:0,fileCount:0};this.logger.zsymb(0,"WID3t6","Cleaning up temp download folder");const{isSuccess:i,totalSize:r,fileCount:o}=await this.removeTempFolder();return i&&(this.logger.zsymb(0,"BxQCNx","Temp folder removed successfully"),s.setItem(Di.d,Date.now().toString())),{isSuccess:i,totalSize:r,fileCount:o}}catch(t){return this.logger.zsymb(18,"_eml9v","Error cleaning up temp directory",t),{isSuccess:!1,totalSize:0,fileCount:0}}}}ki._instance=void 0;var Ni,Pi=s("Nvz1"),ji=s("EAii"),Ui=s("lVEP"),Bi=s("egeV");Object(m.d)()(Ni=Object(m.h)()(Ni=Reflect.metadata("design:type",Function)(Ni=Reflect.metadata("design:paramtypes",[])(Ni=class{constructor(){this.logger=void 0,this.zrfControlService=void 0,this.actionLogService=void 0,this.timeoutId=void 0,this.intervalId=void 0,this.logger=Object(Li.a)("NewZRFController"),this.onSwapPathConfigChange=this.onSwapPathConfigChange.bind(this),this.zrfControlService=Fi.a.instance(),this.actionLogService=Ui.a.getInstance()}async onApplicationReady(){this.startCleanupTempFolder(),this.zrfControlService.onConfigChange(this.onSwapPathConfigChange),this.setDefaultPathFirstTime(),this.handleSwapPath()}isEnabled(){return this.zrfControlService.isEnabled()}startCleanupTempFolder(){this.isEnabled()&&(this.timeoutId=setTimeout((async()=>{const e=ki.instance(),{isSuccess:t,totalSize:s,fileCount:a}=await e.cleanup({bypassCheck:!0});t&&this.actionLogService.logCleanupTempFolder({trigger:"start_app",cleanupSizeB:s,cleanupFileCount:a,deviceId:ui.default.getZaloClientID()})}),Di.a),this.intervalId=setInterval((async()=>{const e=ki.instance(),{isSuccess:t,totalSize:s,fileCount:a}=await e.cleanup();t&&this.actionLogService.logCleanupTempFolder({trigger:"interval",cleanupSizeB:s,cleanupFileCount:a,deviceId:ui.default.getZaloClientID()})}),Di.c))}setDefaultPathFirstTime(){try{if(!this.isEnabled())return;const e=Pi.a.instance(),t=e.getDefaultPath();if(this.logger.zsymb(0,"qvqGCn",`Current path: ${t}`),t)return;const s=this.zrfControlService.getSwapPathConfig(),i=e.setDefaultPath({path:s.new_path,version:s.change_version});a.ModuleContainer.resolve(ji.a).refreshZaloReceivedFilesDir(),i&&this.logSwapPathAttempt(i),this.logger.zsymb(0,"SCY9io",`Default path set to ${s.new_path}`)}catch(e){this.logger.zsymb(18,"DHDme-",`Error setting default path: ${e}`)}}onDispose(){clearTimeout(this.timeoutId),clearInterval(this.intervalId)}async onSwapPathConfigChange(){this.handleSwapPath()}async logSwapPathAttempt(e){const t=$znode.path.resolve(Object(wi.gethomeDirSync)(),e.oldPath);this.actionLogService.logSwapPathAttempt(Object(I.a)(Object(I.a)({},e),{},{oldPathSizeB:e.oldPath?await Object(Bi.a)(t):0}))}handleSwapPath(){const e=Pi.a.instance(),t=this.zrfControlService.getSwapPathConfig();if(t){const s=e.swapPath({originalPath:t.original_path,newPath:t.new_path,changeVersion:t.change_version});a.ModuleContainer.resolve(ji.a).refreshZaloReceivedFilesDir(),s&&this.logSwapPathAttempt(s)}}})||Ni)||Ni)||Ni);var zi,Gi=s("Fdeg"),xi=s("rCQs"),Vi=s("PD1X"),Hi=s("KkZn"),Wi=s("vXRA");const qi=$znode.path,Ki=$znode.fs;Object(xi.b)(ji.a)(zi=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(zi=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(zi=Reflect.metadata("design:type",Function)(zi=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a])(zi=class{constructor(e,t){this._app=t,this._isExpired=!0,this._localCacheName="res.zcache",this._localCacheFolders={[Gi.a.zaloLocal]:"",[Gi.a.zaloDB]:"",[Gi.a.zaloProramExe]:"",[Gi.a.zaRF]:"",[Gi.a.zaloTemp]:"",[Gi.a.zTemp]:""},this._localCacheData={[Gi.a.zaloLocal]:new u.default({maxSize:1e4}),[Gi.a.zaloDB]:new u.default({maxSize:1e3}),[Gi.a.zaloProramExe]:new u.default({maxSize:5e3}),[Gi.a.zaRF]:new u.default({maxSize:1e3}),[Gi.a.zaloTemp]:new u.default({maxSize:1e3}),[Gi.a.zTemp]:new u.default({maxSize:1e3})},this.logger=void 0,this.init=()=>{"render"===__ZaBUNDLENAME__&&this.getCachePaths()},this.getLocalCacheData=async e=>{const t=".rescache",s=[],a=await Object(wi.getzTempDir)(),i=await Object(wi.getZaloTempDir)();Gi.c.forEach((n=>{try{let r;r="zTemp"===n?qi.join(a,t):"ZaloTemp"===n?qi.join(i,t):qi.join(e,"ZaloDownloads"===n?"":n,t),null!=Ki&&Ki.existsSync(r)&&s.push(this.readCacheFile(r,n))}catch(r){}}));const n=await Promise.all(s),r={};return n.forEach((e=>{r[e.type]={count:(null==e?void 0:e.count)||0,size:(null==e?void 0:e.totalSize)||0}})),r},this.readCacheFile=async(e,t)=>{try{{let s=await $zFileManager.getFileArrayBuffer(e);const a=new Blob([s]),i=await a.text();return Object(I.a)(Object(I.a)({},Object(Hi.g)(i)),{},{type:t})||null}}catch(s){throw Error(s)}},this._listenEvents=()=>{"render"===__ZaBUNDLENAME__&&(this._app.addEventListener(m.b.Authenticated,this.init),this._app.addEventListener(m.b.Exit,this._removeListeners))},this._removeListeners=()=>{"render"===__ZaBUNDLENAME__&&(this._app.removeEventListener(m.b.Authenticated,this.init),this._app.removeEventListener(m.b.Exit,this._removeListeners))},this.logger=e.createZLogger("resmgmt",["cache-maanger"]),this.logger.zsymb(5,"12uG6l",["ResCacheManager is created","YwDs4l"]),this._listenEvents()}async getCacheType(e){if((e=(null==qi?void 0:qi.join(e,qi.sep))||e).startsWith(this._localCacheFolders[Gi.a.zaloLocal]))return Gi.a.zaloLocal;if(e.startsWith(this._localCacheFolders[Gi.a.zaloDB]))return Gi.a.zaloDB;if(e.startsWith(this._localCacheFolders[Gi.a.zaloProramExe]))return Gi.a.zaloProramExe;if(e.startsWith(this._localCacheFolders[Gi.a.zTemp]))return Gi.a.zTemp;if(e.startsWith(this._localCacheFolders[Gi.a.zaloTemp]))return Gi.a.zaloTemp;if(await this._getVerifiedZaRFPath(),e.includes(this._localCacheFolders[Gi.a.zaRF]))return Gi.a.zaRF;throw new Error("Invalid cache type "+e)}async hasScan(e){const t=await this.getCacheType(e);return this._localCacheData[t].has(e)}async getScan(e){e=e.endsWith("/")?e.slice(0,-1):e;const t=await this.getCacheType(e);if(this._localCacheData[t].has(e))return this._localCacheData[t].get(e);let s=()=>{},a=()=>{};const i=new Promise(((e,t)=>{s=e,a=t}));return this._localCacheData[t].set(e,{promise:i,resolve:s,reject:a}),{promise:i,resolve:s,reject:a}}async revokeCache(){this._isExpired=!0}async signCache(){this._isExpired=!1,this._clearAllCacheData()}async hasCacheFile(e){let t=qi.dirname(e);t=t.endsWith("/")?t.slice(0,-1):t;const s=await this.getCacheType(t);if(this._isExpired)return this._localCacheData[s].delete(e),!1;this._localCacheFolders[s]||await this.getCachePaths();return this._localCacheData[s].has(t)}async refreshZaloReceivedFilesDir(){const e=await Object(Wi.a)();this._localCacheFolders[Gi.a.zaRF]=e,await this._getVerifiedZaRFPath()}async getCacheFile(e){let t=0,s=qi.dirname(e);s=s.endsWith("/")?s.slice(0,-1):s;const a=qi.basename(e);if(!this.hasCacheFile(e)){this.logger.zsymb(15,"9XRrBa",["Cache not found for {}. Request calculator for {}","rPXcA1"],e,s);try{const e=new Vi.a(s),a=await e.run();t=a.result||0,this.logger.zsymb(15,"eSP17F",["Calculate {} responded with {}","oLNr6X"],s,a)}catch(r){}}const i=await this.getCacheType(s),n=this._localCacheData[i].get(s);return t=(await n.promise).data[a][1],this.logger.zsymb(15,"NXv2Ms",["Folder size: {} === {} bytes","uNl7du"],e,t),t}verifyCache(){this._isExpired=!1}isValid(){return!this._isExpired}deleteCacheObject(e){this._localCacheData[e].clear()}_clearAllCacheData(){this._localCacheData[Gi.a.zaloLocal].clear(),this._localCacheData[Gi.a.zaloDB].clear(),this._localCacheData[Gi.a.zaloProramExe].clear(),this._localCacheData[Gi.a.zaRF].clear()}_removeTrailingPathSeparator(e){return e.replace(/[\\/]+$/,"")}async getCachePaths(){this._localCacheFolders[Gi.a.zaloLocal]=this._removeTrailingPathSeparator(await Object(wi.getZaloPCDir)()),this._localCacheFolders[Gi.a.zaloDB]=this._removeTrailingPathSeparator(await Object(wi.getZaloDir)()),this._localCacheFolders[Gi.a.zaloProramExe]=this._removeTrailingPathSeparator(await Object(wi.getexeDir)()),this._localCacheFolders[Gi.a.zaRF]=this._removeTrailingPathSeparator(await Object(Wi.a)()),this._localCacheFolders[Gi.a.zTemp]=this._removeTrailingPathSeparator(await Object(wi.getzTempDir)()),this._localCacheFolders[Gi.a.zaloTemp]=this._removeTrailingPathSeparator(await Object(wi.getZaloTempDir)());for(const e in this._localCacheFolders){const t=this._localCacheFolders[e];t&&(this._localCacheFolders[t]=e)}await this._getVerifiedZaRFPath()}async _getVerifiedZaRFPath(){const e=await Object(Wi.a)(),t=qi.dirname(e);return this._localCacheFolders[Gi.a.zaRF]=t,this._localCacheFolders[t]=Gi.a.zaRF,t}})||zi)||zi)||zi)||zi);var Zi=s("7Xnh"),$i=s("Ff2n");let Qi=function(e){return e.DiskStatus="DiskStatus",e.ZaloUsage="ZaloUsage",e.DeleteConv="DeleteConv",e.Cache="Cache",e.TimeGoToSM="TimeGoToSM",e.TimeFinishedScan="TimeFinishedScan",e.MigrateDB="MigrateDB",e.ChangeStorageZone="ChangeStorageZone",e.RequestDeleteCache="RequestDeleteCache",e.ActualDeleteCache="ActualDeleteCache",e.RequestDeleteOtherAccounts="RequestDeleteOtherAccounts",e.ActualDeleteOtherAccounts="ActualDeleteOtherAccounts",e}({}),Yi=function(e){return e[e.Routine=0]="Routine",e[e.UserManual=1]="UserManual",e[e.Partial=2]="Partial",e[e.Forced=3]="Forced",e[e.ReScanByCleanCacheOrOtherAccounts=4]="ReScanByCleanCacheOrOtherAccounts",e}({}),Ji=function(e){return e.CacheValid="cache_valid",e.StartNewScanWithoutCache="start_new_scan_without_cache",e.StartNewScanWithCache="start_new_scan_with_cache",e.ContinueQuickScan="continue_quick_scan",e.ContinueDBScan="continue_db_scan",e}({});const Xi={[Qi.DiskStatus]:5,[Qi.ZaloUsage]:7,[Qi.DeleteConv]:8,[Qi.Cache]:9,[Qi.TimeGoToSM]:10,[Qi.TimeFinishedScan]:11,[Qi.ChangeStorageZone]:12,[Qi.RequestDeleteCache]:"request_delete_cache",[Qi.ActualDeleteCache]:"actual_delete_cache",[Qi.RequestDeleteOtherAccounts]:"request_delete_other_acc",[Qi.ActualDeleteOtherAccounts]:"actual_delete_other_acc"};function en(e){let t=e/864e5;return t=Math.round(t),t=Math.min(Math.max(t,0),15),15===t&&(t=-1),t}function tn(e){let t=e/864e5;return t=Math.round(t),t=Math.max(t,0),t}var sn=s("KmCD"),an=s("u8fi"),nn=s("MGH9"),rn=s("v4vb"),on=s("Fzrl"),cn=s("6QZ1"),ln=(s("tx+P"),s("Dy6U")),dn=s("e4Kp");const un=["type"];var hn;const gn="resource_management_last_time_send_log_auto",mn="resource_management_last_time_send_log_disk_status_auto",pn="resource_management_last_time_send_log_migrate_db_auto";var fn=function(e){return e[e.YES=1]="YES",e[e.NO=0]="NO",e}(fn||{});let vn=Object(m.d)()(hn=Reflect.metadata("design:type",Function)(hn=Reflect.metadata("design:paramtypes",[])(hn=class{constructor(){this.userCacheDir="",this.LogHistory={[Qi.DiskStatus]:{ts:-Ce.default.full_disk_check.report_interval,pending:!1},[Qi.ZaloUsage]:{ts:-Ce.default.full_disk_check.report_interval,pending:!1},[Qi.Cache]:{ts:-Ce.default.full_disk_check.report_interval,pending:!1},[Qi.MigrateDB]:{ts:-Ce.default.full_disk_check.migrate_db_report_interval,pending:!1}},this.autoReportTimer=null,this.autoDiskStatusReportTimer=null,this.autoMigrateDBReportTimer=null,this.secureLocalStorage=void 0,this.timeGoToSM=0,this.startAutoReport=()=>{if(this.autoReportTimer)return;const e=this.secureLocalStorage.getItem(gn);e&&this.getTimeNow()-+e>=Ce.default.full_disk_check.report_interval&&this.report(),this.autoReportTimer=setInterval(this.report,Ce.default.full_disk_check.report_interval)},this.report=async()=>{this.zaloUsageReport(),this.cacheReport({scan_event:Yi.Routine}),this.secureLocalStorage.setItem(gn,`${this.getTimeNow()}`)},this.getScanType=()=>Yi,this.getTimeNow=()=>Ct.default.getSystemTimeNow()||Date.now(),this.canReport=()=>Ce.default.full_disk_check.enable_disk_cache&&Ce.default.full_disk_check.enable_report,this.canMigrateDBReport=()=>Ce.default.full_disk_check.enable_report_migrate_db,this._getCurrentDisk=async()=>"Mac",this.diskStatusReport=async e=>{if(!this.canReport())return;const{DiskStatus:t}=this.LogHistory,s=e?Yi.UserManual:Yi.Routine;if(s===Yi.Routine&&!this._canActionLogDiskStatus(t.ts)||t.pending)return;this.LogHistory.DiskStatus.pending=!0;const a=e||sn.a.analyzeMainDisk(),i=await this._getCurrentDisk();if(a){const{total:e,free:t}=a,n=Re.default.getFullDiskChatPopupNoti()||{},r=(null==n?void 0:n.ts)||0;let o=0;r&&(o=tn(this.getTimeNow()-r));const c=Pi.a.instance().isSwitchedToNewPath();this.logAction999({type:"DiskStatus",scan_event:s,free:t,total:e,ts:this.getTimeNow(),current_disk:i,time_in_this_zone:o,download_path_is_ZRF:!c})}this.LogHistory.DiskStatus.pending=!1},this.zaloUsageReport=async e=>{var t,s;if(!this.canReport())return;const{ZaloUsage:i}=this.LogHistory;let n=null!==(t=null==e?void 0:e.scan_event)&&void 0!==t?t:Yi.Routine;if(n===Yi.Routine&&!this._canActionLog(i.ts)||i.pending)return;this.LogHistory.ZaloUsage.pending=!0;const r=a.ModuleContainer.resolve(an.b),o=sn.a.analyzeMainDisk(),c=JSON.parse(ln.b.getOverviewPageData()),l=a.ModuleContainer.resolve(nn.a);let d,u=!1;null!=c&&c.time?(d=c,u=!0):d=await r.getZaloUsageForLog();let h=0,g=0,m=0;const p={count:0,size:0};if(!this.userCacheDir){const e=J.p.getSessionUserId();this.userCacheDir=await Object(wi.getUserZaloDownloadsDir)(e)}let f=d.otherDataSize,v=d.total;if(u){const{zaloLocalSize:e,appDataSize:t,zaRFSize:s,zTempSize:a,zaloTempSize:i,zaloDBSearchSize:n,convDataSize:r,otherAccountsSize:o}=d;let c=e+t+a+i+n;f=c-r-o,dn.a.resource_management.enable_calculate_zrf&&(c+=s,f-=s),v=c}const _=d.appDataSize,b=l.getCompletedScanDBTime();let y={media_message:d.convDataSize,zalo_received_files:d.zarf||d.zaRFSize,other_accounts:d.otherAccountsSize,other_data:f,db_size:_,zalo_temp:d.zaloTempSize||0,ztemp:d.zTempSize||0,cache:d.zaloCacheFoldersSize||0,sticker_size:d.zaloStickersSize||0};if(b){const e=en(this.getTimeNow()-b);l.getConvData().forEach((e=>{const t=e.convId,s=sn.a.getCache(t);p.count+=1,s&&(p.size+=s.filesSize+s.imagesSize+s.videosSize,h+=s.filesSize,m+=s.imagesSize,g+=s.videosSize)})),y=Object(I.a)(Object(I.a)({},y),{},{total_known_by_db:p,photo_on_db:m,file_on_db:h,video_on_db:g,db_scan_cache_age:e})}const S={used:v,free:null!==(s=null==o?void 0:o.free)&&void 0!==s?s:-1},C=await this._getCurrentDisk();S&&this.logAction999(Object(I.a)(Object(I.a)({type:"ZaloUsage",scan_event:n,used:S.used,ts:this.getTimeNow(),free:S.free},y),{},{current_disk:C})),this.LogHistory.ZaloUsage.pending=!1},this.cacheReport=async e=>{var t,s;if(!this.canReport())return;const{Cache:i}=this.LogHistory;let n=null!==(t=null==e?void 0:e.scan_event)&&void 0!==t?t:Yi.Routine;if(n===Yi.Routine&&!this._canActionLog(i.ts)||i.pending)return;this.LogHistory.Cache.pending=!0;const r=a.ModuleContainer.resolve(ji.a);if(!this.userCacheDir){const e=J.p.getSessionUserId();this.userCacheDir=await Object(wi.getUserZaloDownloadsDir)(e)}const o=await r.getLocalCacheData(this.userCacheDir),c=a.ModuleContainer.resolve(nn.a),l={count:0,size:0},d=sn.a.analyzeMainDisk();let u=0,h=0,g=0;const m=c.getCompletedScanDBTime(),p=await this._getCurrentDisk();let f={type:"Cache",scan_event:n,cache:{cache:o.Cache,file_thumb:o.fileThumb,file:o.file,video:o.video,picture:o.picture,file_noise:o.fileNoise,rich_thumb:o.richThumb,total_on_disk:o.ZaloDownloads,voice:o.voice,zinstant:o.zinstant},ts:this.getTimeNow(),free:null!==(s=null==d?void 0:d.free)&&void 0!==s?s:-1,current_disk:p};if(m){const e=en(this.getTimeNow()-m);c.getConvData().forEach((e=>{const t=e.convId,s=sn.a.getCache(t);l.count+=1,s&&(l.size+=s.filesSize+s.imagesSize+s.videosSize,u+=s.filesSize,h+=s.videosSize,g+=s.imagesSize)})),n===Yi.Partial&&(n=Yi.UserManual),f=Object(I.a)(Object(I.a)({},f),{},{total_known_by_db:l,file_on_db:u,video_on_db:h,photo_on_db:g,db_scan_cache_age:e})}f&&this.logAction999(f),this.LogHistory.Cache.pending=!1},this.migrateDBReport=async()=>{if(!this.canMigrateDBReport())return;const{MigrateDB:e}=this.LogHistory;if(Yi.Routine===Yi.Routine&&!this._canActionLogMigrateDB(e.ts)||e.pending)return;this.LogHistory.MigrateDB.pending=!0;const t=(await Object(on.a)()).length,s=a.ModuleContainer.resolve(cn.a),i=s.getTotalMigratedAccount(),n=s.isCurrentAccountMigrated(),r={all_migrated:await $zFeatures.migrateDB.isMigrateFullDone(),number_of_acc_on_device:t,number_of_acc_upgraded:i,is_this_acc_upgraded:n,imei:Ia.default.getDeviceID(),ts:this.getTimeNow()};Ia.default.logActionInfoV2(Ia.FeaturesInfo.MigrateDrive,9999,r),this.LogHistory.MigrateDB.pending=!1},this.timeGoToSMReport=e=>{if(!this.canReport())return;const t=this.timeGoToSM;this.logAction999({type:"TimeGoToSM",ts:this.getTimeNow(),status:e,times_opened_SM_tool_in_this_session:t}),this.timeGoToSM++},this.timeFinishedScanReport=e=>{const t=this.secureLocalStorage.checkExistForCurrentUser(rn.f);let s=fn.NO,a=fn.NO;t&&(e.timeToQuickScanComplete>0&&(s=fn.YES),e.timeToDBScanComplete>0&&(a=fn.YES)),this.logAction999({type:"TimeFinishedScan",ts:this.getTimeNow(),scan_event:e.scanEvent,time_to_complete_db_scan:e.timeToDBScanComplete,time_to_complete_quick_scan:e.timeToQuickScanComplete,opening_tool_when_db_scan_complete:a,opening_tool_when_quick_scan_complete:s})},this.changeStorageZone=e=>{var t;const s=sn.a.analyzeMainDisk(),a=tn(this.getTimeNow()-e.tsInPreviousStorageZone);this.logAction999({type:"ChangeStorageZone",free:null!==(t=null==s?void 0:s.free)&&void 0!==t?t:-1,current_storage_zone:e.currentStorageZone,previous_storage_zone:e.previousStorageZone,time_in_previous_zone:a})},this.requestDeleteCache=async e=>{var t;const s=sn.a.analyzeMainDisk(),a=await this._getCurrentDisk();this.logAction999({type:"RequestDeleteCache",requested_deleted_size:e.requestedDeletedSize,ts:this.getTimeNow(),free:null!==(t=null==s?void 0:s.free)&&void 0!==t?t:-1,current_disk:a})},this.actualDeleteCache=async e=>{var t;const s=sn.a.analyzeMainDisk(),a=await this._getCurrentDisk();this.logAction999({type:"ActualDeleteCache",requested_delete_size:e.requestedDeleteSize,actual_deleted_size:e.actualDeletedSize,status:e.status,has_retry:e.hasRetry,processing_time_ms:e.processingTimeMs,ts:this.getTimeNow(),free:null!==(t=null==s?void 0:s.free)&&void 0!==t?t:-1,current_disk:a})},this.requestDeleteOtherAccounts=async e=>{var t;const s=sn.a.analyzeMainDisk(),a=await this._getCurrentDisk();this.logAction999({type:"RequestDeleteOtherAccounts",requested_deleted_size:e.requestedDeletedSize,ts:this.getTimeNow(),free:null!==(t=null==s?void 0:s.free)&&void 0!==t?t:-1,current_disk:a})},this.actualDeleteOtherAccounts=async e=>{var t;const s=sn.a.analyzeMainDisk(),a=await this._getCurrentDisk();this.logAction999({type:"ActualDeleteOtherAccounts",requested_delete_size:e.requestedDeleteSize,actual_deleted_size:e.actualDeletedSize,status:e.status,has_retry:e.hasRetry,processing_time_ms:e.processingTimeMs,ts:this.getTimeNow(),free:null!==(t=null==s?void 0:s.free)&&void 0!==t?t:-1,current_disk:a})},this.dispose=()=>{clearInterval(this.autoReportTimer),clearInterval(this.autoDiskStatusReportTimer),clearInterval(this.autoMigrateDBReportTimer)},this.logAction999=e=>{const{type:t}=e;Object($i.a)(e,un);let s;switch(t){case"DiskStatus":s=Xi.DiskStatus,this.LogHistory.DiskStatus.ts=performance.now();break;case"ZaloUsage":s=Xi.ZaloUsage,this.LogHistory.ZaloUsage.ts=performance.now();break;case"DeleteConv":s=Xi.DeleteConv;break;case"Cache":s=Xi.Cache,this.LogHistory.Cache.ts=performance.now();break;case"TimeGoToSM":s=Xi.TimeGoToSM;break;case"TimeFinishedScan":s=Xi.TimeFinishedScan;break;case"ChangeStorageZone":s=Xi.ChangeStorageZone;break;case"RequestDeleteCache":s=Xi.RequestDeleteCache;break;case"ActualDeleteCache":s=Xi.ActualDeleteCache;break;case"RequestDeleteOtherAccounts":s=Xi.RequestDeleteOtherAccounts;break;case"ActualDeleteOtherAccounts":s=Xi.ActualDeleteOtherAccounts}const a=Object(I.a)(Object(I.a)({},e),{},{device_id:Ia.default.getDeviceID()});return Ia.default.logActionInfoV2(Ia.FeaturesInfo.ResourceManagementV2,s,a),Promise.resolve()},this._canActionLog=e=>performance.now()-e>Ce.default.full_disk_check.report_interval,this._canActionLogDiskStatus=e=>performance.now()-e>Ce.default.full_disk_check.disk_status_report_interval,this._canActionLogMigrateDB=e=>performance.now()-e>Ce.default.full_disk_check.migrate_db_report_interval,this.secureLocalStorage=n.default.getInstance(),this.startDiskStatusAutoReport(),this.startAutoReport(),this.startMigrateDBAutoReport()}onApplicationReady(){this.startDiskStatusReport(),this.startDiskStatusAutoReport(),this.startMigrateDBReport()}startDiskStatusAutoReport(){const e=this.secureLocalStorage.getItem(mn);e&&this.getTimeNow()-+e>=Ce.default.full_disk_check.disk_status_report_interval&&this.startDiskStatusReport(),this.autoDiskStatusReportTimer=setInterval(this.diskStatusReport,Ce.default.full_disk_check.disk_status_report_interval)}startMigrateDBAutoReport(){const e=this.secureLocalStorage.getItem(pn);e&&this.getTimeNow()-+e>=Ce.default.full_disk_check.migrate_db_report_interval&&this.startMigrateDBReport(),this.autoMigrateDBReportTimer=setInterval(this.migrateDBReport,Ce.default.full_disk_check.migrate_db_report_interval)}startDiskStatusReport(){this.diskStatusReport(),this.secureLocalStorage.setItem(mn,`${this.getTimeNow()}`)}startMigrateDBReport(){this.migrateDBReport(),this.secureLocalStorage.setItem(pn,`${this.getTimeNow()}`)}})||hn)||hn)||hn;a.ModuleContainer.registerSingleton(Zi.a,vn);const _n=Object(a.define)("resmgmt-conv-filter-manager"),bn=Object(a.define)("resmgmt-convdata-manager");var In=s("EFQ6"),yn=s("Gm1y");Event;class Sn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class Cn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class En extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class On extends Event{constructor(e){super(e)}}Event;Event;class Mn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class Tn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class Rn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class wn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class Ln extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class Dn extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}class An extends Event{constructor(e,t){super(e),this.payload=void 0,this.payload=t}}let Fn=function(e){return e.Update_Convdata_List="Update_Convdata_List",e.ResCalc_UI_Status_Change="ResCalc_UI_Status_Change",e.ResCalc_ZaRF_Status="ResCalc_ZaRF_Status",e.ResCalc_AppData_Status="ResCalc_AppData_Status",e.ResCalc_ZaloLocal_Status="ResCalc_ZaloLocal_Status",e.ResCalc_ConvData_Status="ResCalc_ConvData_Status",e.ResCalc_OtherAccounts_Status="ResCalc_OtherAccounts_Status",e.ResCalc_Cache_Folder_Status="ResCalc_Cache_Folder_Status",e.ResCalc_Sticker_Status="ResCalc_Sticker_Status",e.ResCalc_zTemp_Status="ResCalc_zTemp_Status",e.ResCalc_ZaloTemp_Status="ResCalc_ZaloTemp_Status",e.ResConv_FilterSort_Status_Change="ResConv_FilterSort_Status_Change",e.ResDisk_Status="ResDisk_Status",e.ResNoti_Dimiss="ResNoti_Dimiss",e.ResNoti_Open_Setttings="ResNoti_Open_Setttings",e.ResStats_Tree_Change="ResStats_Tree_Change",e.ResDisk_CurrentLevel="ResDisk_CurrentLevel",e.ResDisk_Full_Disk_Status="ResDisk_Full_Disk_Status",e.ResCalc_Manual_Fast_Calculate="ResCalc_Manual_Fast_Calculate",e.ResCalc_Manual_Detail_Calculate="ResCalc_Manual_Detail_Calculate",e.ResCalc_Delete_Convs="ResCalc_Delete_Convs",e.ResCalc_Delete_Convs_Status="ResCalc_Delete_Convs_Status",e.ResCalc_Update_Detail_Page_Cache="ResCalc_Update_Detail_Page_Cache",e.ResCalc_Calculate="ResCalc_Calculate",e.Res_Clean_Cache_Folder_Status="Res_Clean_Cache_Folder_Status",e.Res_Clean_Other_Accounts_Status="Res_Clean_Other_Accounts_Status",e}({});var kn=s("7NAg"),Nn=s("yzMR"),Pn=s("j1HC"),jn=s("kcIR");const Un=["action","temp","qos","update"],Bn="res_mnt_delete_size_convs_session",zn="CLEAN_FOLDER_PROGRESS";let Gn=function(e){return e.INITIALIZING="INITIALIZING",e.RENAMING="RENAMING",e.RENAME_FAILED="RENAME_FAILED",e.DELETING="DELETING",e.DELETE_FAILED="DELETE_FAILED",e.COMPLETED="COMPLETED",e.HIDDEN_WINDOWS="HIDDEN_WINDOWS",e.HIDE_WINDOWS_FAILED="HIDE_WINDOWS_FAILED",e.HIDE_WINDOWS_SUCCESS="HIDE_WINDOWS_SUCCESS",e.CHECK_EXIST_FOLDER_FAILED="CHECK_EXIST_FOLDER_FAILED",e.CHECK_EXIST_FOLDER_SUCCESS="CHECK_EXIST_FOLDER_SUCCESS",e}({});var xn;let Vn,Hn;function Wn(){}function qn(...e){0}Vn=$znode.fastGlob,Hn=$znode.path;let Kn=Object(a.injectable)()(xn=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(xn=Reflect.metadata("design:type",Function)(xn=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(xn=class extends hs.b{constructor(e){super(),this.resultCallback=void 0,this._resultCallback=void 0,this.onDataChange=void 0,this._onDataChange=void 0,this.stoppedDBScan=void 0,this.stoppedQuickScan=void 0,this.taskDBScanIds=void 0,this.taskQuickScanIds=void 0,this.data=void 0,this.dataRecalculate=void 0,this.dataCount=void 0,this.dataRecalculateCount=void 0,this.didDelete=void 0,this._totalConvs=0,this._totalOverviewConvs=0,this._taskCalcTs=0,this.Logger=void 0,this._hasNewAutoDownload=0,this.dataHiddenConversations=void 0,this.dataOverview=void 0,this.dataOverviewRecalculate=void 0,this.isFastScanRecalculate=void 0,this.isDetailScanRecalculate=void 0,this._finalConv=null,this._isFinalOverviewTask=!1,this.deleteConvIds=[],this.completedScanDBTime=0,this.hasNewAutoDownload=()=>{this.updateCurrentAutoDownload(this.getCurrentAutoDownload()+1)},this.getCurrentAutoDownload=()=>this._hasNewAutoDownload,this.updateCurrentAutoDownload=e=>{this._hasNewAutoDownload=e},this.getTimeNow=()=>Ct.default.getSystemTimeNow()||Date.now(),this.getCompletedScanDBTime=()=>this.completedScanDBTime,this.setConvToHidden=(e,t,s)=>{const i=()=>{this.data=this._filterInvalidConv(this.data),this.data=this._filterDuplicateConv(this.data),this.dataHiddenConversations=this._filterInvalidConv(this.dataHiddenConversations),this.dataHiddenConversations=this._filterDuplicateConv(this.dataHiddenConversations),ln.b.setDetailPageData({time:this.getTimeNow(),convs:this.data,dataHiddenConversations:this.dataHiddenConversations});a.ModuleContainer.resolve(an.b).updateConvs(this.data)},n=()=>{const e=ln.b.getDetailPageData();return e?JSON.parse(e):{convs:[],dataHiddenConversations:[]}},r=(e,t,s)=>{const a=t.find((t=>t.convId===e));return a&&(t=t.filter((t=>t.convId!==e)),s.push(a)),{source:t,target:s}};if(t){let t=r(e,this.data,this.dataHiddenConversations);const s=n();s.convs.length&&(t=r(e,s.convs,this.dataHiddenConversations),this.data=t.source),i()}else{let t=r(e,this.dataHiddenConversations,this.data);const a=n();a.dataHiddenConversations.length&&(t=r(e,a.dataHiddenConversations,this.data),this.dataHiddenConversations=t.source),s&&(this.data=this.data.filter((t=>t.convId!==e))),i()}},this.startCalculating=async(e=!1)=>{qn(),this._resetProgress();try{let t=this._hasNewAutoDownload>0||e?await this.getConvs():await this._getOutdatedConvs();t=t.filter((e=>e.userId!==Y.CONV_FILTER.STRANGER));const s=this.getCurrentAutoDownload();if(0===t.length&&!e&&(s<=0||0==this._totalOverviewConvs))return this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:kn.n.IDLE,type:"convDataStatus",progress:100}),this.isDetailScanRecalculate&&this._broadcastEvent(Fn.ResCalc_Manual_Detail_Calculate,!1),this.onDataChange([]),this._broadcastEvent(Fn.ResCalc_Update_Detail_Page_Cache,{dataHiddenConversations:[]}),!1;if(this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:kn.n.CALCULATING,type:"convDataStatus",progress:1}),0===t.length)return this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:kn.n.IDLE,type:"convDataStatus",progress:100}),this.isDetailScanRecalculate&&this._broadcastEvent(Fn.ResCalc_Manual_Detail_Calculate,!1),this.onDataChange([]),this._broadcastEvent(Fn.ResCalc_Update_Detail_Page_Cache,{dataHiddenConversations:[]}),!1;this.dataCount=0,this.dataRecalculateCount=0,this._totalConvs=t.length,this._finalConv=t[this._totalConvs-1];for(let e=0;e<this._totalConvs;e++){if(this.stoppedDBScan)return this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:null,type:"convDataStatus"}),!0;await this.createTask(t[e],this.isDetailScanRecalculate)}return this.completedScanDBTime=this.getTimeNow(),this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:kn.n.IDLE,type:"convDataStatus",progress:100}),this.Logger.zsymb(2,"76DS61",`[RES-MNT] DB scan finish - has manual calculate ${this.isDetailScanRecalculate}`),this._broadcastEvent(Fn.ResCalc_Update_Detail_Page_Cache,{dataHiddenConversations:this.dataHiddenConversations}),this.updateCurrentAutoDownload(this.getCurrentAutoDownload()-s),this._taskCalcTs=Date.now(),!0}catch(t){return this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:kn.n.IDLE,type:"convDataStatus",progress:100}),this.isDetailScanRecalculate&&this._broadcastEvent(Fn.ResCalc_Manual_Detail_Calculate,!1),this.onDataChange([]),this._broadcastEvent(Fn.ResCalc_Update_Detail_Page_Cache,{dataHiddenConversations:[]}),!1}},this._broadcastEvent=(e,t)=>{switch(e){case Fn.ResCalc_ConvData_Status:this.dispatchEvent(new Sn(Fn.ResCalc_ConvData_Status,t));break;case Fn.ResCalc_Manual_Fast_Calculate:this.dispatchEvent(new Mn(Fn.ResCalc_Manual_Fast_Calculate,t));break;case Fn.ResCalc_Manual_Detail_Calculate:this.dispatchEvent(new Mn(Fn.ResCalc_Manual_Detail_Calculate,t));break;case Fn.ResCalc_Delete_Convs:this.dispatchEvent(new Tn(Fn.ResCalc_Delete_Convs,t));break;case Fn.ResCalc_Delete_Convs_Status:this.dispatchEvent(new Rn(Fn.ResCalc_Delete_Convs_Status,t));break;case Fn.ResCalc_Update_Detail_Page_Cache:this.dispatchEvent(new wn(Fn.ResCalc_Update_Detail_Page_Cache,t));break;case Fn.ResCalc_Calculate:this.dispatchEvent(new Ln(Fn.ResCalc_Calculate,t))}},this.resultCallback=Wn,this._resultCallback=Wn,this.onDataChange=Wn,this._onDataChange=Wn,this.stoppedDBScan=!0,this.stoppedQuickScan=!0,this.taskDBScanIds=[],this.taskQuickScanIds=[],this.data=[],this.dataRecalculate=[],this.dataOverview=[],this.dataOverviewRecalculate=[],this.dataHiddenConversations=[],this.didDelete=new Map,this.isFastScanRecalculate=!1,this.isDetailScanRecalculate=!1,this.dataCount=0,this.dataRecalculateCount=0,this.Logger=e.createZLogger("resmgmt",["conv-datasource"])}status(){return this.stoppedDBScan?kn.n.IDLE:kn.n.CALCULATING}getConvData(){return this.data}setForceConvData(e){this.data=e}getConvHiddenData(){return this.dataHiddenConversations}setForceConvHiddenData(e){this.dataHiddenConversations=e}async start(e,t,s){this.stoppedDBScan=!1,this.onDataChange=s,this.isDetailScanRecalculate=t,this.resultCallback=e=>{if(qn(),this.stoppedDBScan)return void this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:null,type:"convDataStatus"});this.isDetailScanRecalculate?(this.dataRecalculate.length>0&&(this.dataRecalculate=this.dataRecalculate.filter((t=>t.convId!==e.convId))),this.dataRecalculate.push(e),this.deleteConvIds.length>0&&(this.dataRecalculate=this.dataRecalculate.filter((e=>!this.deleteConvIds.includes(e.convId)))),++this.dataRecalculateCount):(this.data.length>0&&(this.data=this.data.filter((t=>t.convId!==e.convId))),this.data.push(e),++this.dataCount);let t=this._getPercentage(this.isDetailScanRecalculate?this.dataRecalculateCount:this.dataCount);0===t&&(t=1),this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:kn.n.CALCULATING,type:"convDataStatus",progress:t}),this.isDetailScanRecalculate&&this._finalConv&&(e.userId==this._finalConv.userId||e.convId==this._finalConv.convId)&&(this.Logger.zsymb(2,"MoEWHT",`[RES-MNT] DB scan finish the last conversation - has manual calculate ${this.isDetailScanRecalculate}`),this._broadcastEvent(Fn.ResCalc_Manual_Detail_Calculate,!1),this.data=[...this.dataRecalculate]),this.data=this._filterDuplicateConv(this.data),this.data=this._filterInvalidConv(this.data),this.onDataChange(this.data)},this.isDetailScanRecalculate?(this.dataRecalculate=[],this._finalConv=null):(this.data=this._filterDuplicateConv(this.data),this.data=this._filterInvalidConv(this.data),this.onDataChange(this.data)),this.Logger.zsymb(2,"JHld8H",`[RES-MNT] DB scan start - has manual calculate ${this.isDetailScanRecalculate}`);return await this.startCalculating(e)}async fastStart(e,t,s){this.stoppedQuickScan=!1,this._onDataChange=s,this.isFastScanRecalculate=t;this._resultCallback=e=>{if(this.stoppedQuickScan)return void this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:null,type:"convDataOverviewStatus"});const t=((e,t)=>{const s=new Set(t.map((e=>e.path)));return(e=e.filter((e=>!s.has(null==e?void 0:e.path)))).push(...t),e})(this.isFastScanRecalculate?this.dataOverviewRecalculate:this.dataOverview,e);this.isFastScanRecalculate?this.dataOverviewRecalculate=t:this.dataOverview=t;const s=t.length,a=this._getPercentage(s,this._totalOverviewConvs);this.isFastScanRecalculate&&100===a&&(this.dataOverview=[...this.dataOverviewRecalculate])},this.isFastScanRecalculate?this.dataOverviewRecalculate=[]:this._onDataChange(this.dataOverview),this.Logger.zsymb(2,"JM89cf",`[RES-MNT] Quick scan start - has manual calculate ${this.isFastScanRecalculate}`);return await this.fastStartCalculating()}async fastStartCalculating(){if(this._resetOverviewProgress(),this.stoppedQuickScan)return this._broadcastEventOverviewStatus(null),!0;try{const e=await this._getUserZaloDownloadDir(),t=await this._collectMediaDataForOverview(e),s=this._getTotalSizeDataForOverview(t);if(0===t.allFiles.length)return this._handleEmptyOverviewResults(),!1;this._initializeOverviewScan(t.allFiles.length),this._broadcastEventOverviewStatus(kn.n.CALCULATING),this.isFastScanRecalculate&&this._broadcastEvent(Fn.ResCalc_Manual_Fast_Calculate,!1),this._onDataChange([{amount:s}]);const a=await this._processOverviewFiles(t.allFiles);return this._finalizeOverviewScan(a),!0}catch(e){return this._handleOverviewScanError(),!1}}_broadcastEventOverviewStatus(e){this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:e,type:"convDataOverviewStatus"})}async _getUserZaloDownloadDir(){const e=J.p.getSessionUserId();return await Object(wi.getUserZaloDownloadsDir)(e)}_getFileStatsOptions(){return{stats:!0,onlyFiles:!0,dot:!1}}async _collectMediaDataForOverview(e){const t=this._getFileStatsOptions(),s=[{key:"images",_path:"picture",config:!0},{key:"videos",_path:"video",config:!0},{key:"files",_path:"file",config:!0},{key:"fileNoises",_path:"fileNoise",config:!0},{key:"voices",_path:"voice",config:dn.a.resource_management.enable_calculate_voice},{key:"fileThumbs",_path:"fileThumb",config:dn.a.resource_management.enable_calculate_fileThumb},{key:"richThumbs",_path:"richThumb",config:dn.a.resource_management.enable_calculate_richThumb},{key:"zinstants",_path:"zinstant",config:dn.a.resource_management.enable_calculate_zinstant}],a=[],i={};s.forEach((({key:e})=>i[`${e}Size`]=0));const n=Object(Pn.a)(Hn.join(e,"**"));return(await Vn(n,t)).forEach((t=>{for(const{key:n,_path:r,config:o}of s)if(t.path.includes(Object(Pn.a)(Hn.join(e,r,Hn.sep)))&&o){a.push(t),i[`${n}Size`]+=t.stats.size;break}})),{allFiles:a,sizes:{filesSize:(i.filesSize||0)+(i.fileNoisesSize||0),videosSize:i.videosSize||0,imagesSize:i.imagesSize||0,voicesSize:i.voicesSize||0,fileThumbsSize:i.fileThumbsSize||0,richThumbsSize:i.richThumbsSize||0,zinstantsSize:i.zinstantsSize||0}}}_getTotalSizeDataForOverview(e){return e.sizes}_handleEmptyOverviewResults(){this._broadcastEventOverviewStatus(kn.n.IDLE),this._onDataChange([]),this._totalOverviewConvs=0}_initializeOverviewScan(e){this._totalOverviewConvs=e,this._isFinalOverviewTask=!1,this.Logger.zsymb(2,"cgiEdd",`[RES-MNT] Quick scan start scan current account ${Date.now()}`)}_calculateFileSizeByType(e){const t=t=>new RegExp(`/\\b${t}\\b/`).test(e.path)?e.stats.size:0;return{filesSize:t("file")+t("fileNoise"),videosSize:t("video"),imagesSize:t("picture"),voicesSize:t("voice"),fileThumbsSize:t("fileThumb"),richThumbsSize:t("richThumb"),zinstantsSize:t("zinstant")}}async _processOverviewFiles(e){const t=[];for(let s=0;s<e.length;s++){if(this.stoppedQuickScan)return this._broadcastEventOverviewStatus(null),t;s===e.length-1&&(this._isFinalOverviewTask=!0);const a=e[s],i=this._calculateFileSizeByType(a);t.push({amount:i,path:a.path})}return t}_finalizeOverviewScan(e){this._resultCallback(e),this.Logger.zsymb(2,"0q9t5b",`[RES-MNT] Quick scan finish scan current account ${Date.now()}`),this.Logger.zsymb(2,"QN4a3h",`[RES-MNT] Quick scan finish - has manual calculate ${this.isFastScanRecalculate}`),this._broadcastEventOverviewStatus(kn.n.IDLE)}_handleOverviewScanError(){this._broadcastEventOverviewStatus(kn.n.IDLE),this._onDataChange([]),this._totalOverviewConvs=0}createScanFastTask(e){return new Promise(((t,s)=>{try{let s=s=>{let a={amount:s,path:e.path};return this._resultCallback(a),t(a)},a=sn.a.fastCalculateConvData(e,s);this.taskQuickScanIds.push(a)}catch(a){return t(null)}}))}cancelDBScan(){qn(),this.resultCallback=Wn,this.stoppedDBScan=!0,sn.a.cancel(this.taskDBScanIds),this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:null,type:"convDataStatus"})}cancelQuickScan(){this._resultCallback=Wn,this.stoppedQuickScan=!0,sn.a.cancel(this.taskQuickScanIds),this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:null,type:"convDataOverviewStatus"})}async onDelete(e,t){this._broadcastEvent(Fn.ResCalc_Delete_Convs_Status,kn.e.IS_DELETING);try{this.deleteConvIds=[...this.deleteConvIds,...e],await sn.a.cleanConvResource(e,t)}catch(s){}finally{this.deleteConvIds=[],this._broadcastEvent(Fn.ResCalc_Delete_Convs_Status,kn.e.DONE_OR_ERROR)}}onUpdateDataBeforeDelete(e,t){let s=0;const i=JSON.parse(ln.b.getDetailPageData());i&&i.convs.length>0&&(this.data=i.convs),i&&i.dataHiddenConversations.length>0&&(this.dataHiddenConversations=i.dataHiddenConversations);const n=this.dataHiddenConversations.filter((t=>e.includes(t.convId)));n.length>0&&(this.data=[...this.data,...n].filter(((e,t,s)=>t===s.findIndex((t=>JSON.stringify(t)===JSON.stringify(e))))));for(let a=0;a<this.data.length;a++){const n=this.data[a];let d=n.amount.filesSize,u=n.amount.imagesSize,h=n.amount.videosSize;if(this.dataOverview=this.dataOverview.filter((e=>null==e?void 0:e.path)),e.includes(n.convId)){let e=jn.a.get(n.convId);var r,o,c,l;if(!e)e=null==i||null===(r=i.convs.find((e=>e.convId==n.convId)))||void 0===r?void 0:r.amount;if(In.a.isThreadHidden(n.convId)&&(this.dataHiddenConversations=this.dataHiddenConversations.filter((e=>e.convId!==n.convId))),t.file)s+=d,d=0,null!==(o=e)&&void 0!==o&&o.filePaths&&e.filePaths.length>0&&(this.dataOverview=this.dataOverview.filter((t=>!e.filePaths.includes(null==t?void 0:t.path))));if(t.photo)s+=u,u=0,null!==(c=e)&&void 0!==c&&c.imagePaths&&e.imagePaths.length>0&&(this.dataOverview=this.dataOverview.filter((t=>e.imagePaths.some((e=>!(null!=t&&t.path.includes(e)))))));if(t.video)s+=h,h=0,null!==(l=e)&&void 0!==l&&l.videoPaths&&e.videoPaths.length>0&&(this.dataOverview=this.dataOverview.filter((t=>!e.videoPaths.includes(null==t?void 0:t.path))));this.data[a]=Object(I.a)(Object(I.a)({},n),{},{amount:{filesSize:d,imagesSize:u,videosSize:h}}),0===d&&0===u&&0===h&&this.didDelete.set(n.convId,!0)}}if(s){this.data=this._filterDuplicateConv(this.data),this.data=this._filterInvalidConv(this.data),ln.b.setDetailPageData({time:this.getTimeNow(),convs:this.data,dataHiddenConversations:this.dataHiddenConversations}),this._broadcastEvent(Fn.ResCalc_Delete_Convs,s),sessionStorage.setItem(Bn,`${s}`);a.ModuleContainer.resolve(an.b).updateConvs(this.data)}}_filterDuplicateConv(e){const t=new Set;return e.filter((e=>!t.has(e.convId)&&(t.add(e.convId),!0)))}_filterInvalidConv(e){return e.filter((e=>"number"==typeof e.amount.videosSize&&"number"==typeof e.amount.imagesSize&&"number"==typeof e.amount.filesSize&&!(e.amount.videosSize+e.amount.imagesSize+e.amount.filesSize<=0)))}removeConvToList(e){let t=[];const s=JSON.parse(ln.b.getDetailPageData());t=s&&s.convs.length>0?[...s.convs]:[...this.data];if(-1!==t.findIndex((t=>t.convId===e)))t=t.filter((t=>t.convId!==e));else{-1!==this.dataHiddenConversations.findIndex((t=>t.convId===e))&&(this.dataHiddenConversations=this.dataHiddenConversations.filter((t=>t.convId!==e)))}this.data=[...t],this.data=this._filterDuplicateConv(this.data),this.data=this._filterInvalidConv(this.data),ln.b.setDetailPageData({time:this.getTimeNow(),convs:this.data,dataHiddenConversations:this.dataHiddenConversations});a.ModuleContainer.resolve(an.b).updateConvs(this.data)}setResCalculateStatus(e){this._broadcastEvent(Fn.ResCalc_Calculate,e)}_resetProgress(){this._totalConvs=0}_resetOverviewProgress(){this._totalOverviewConvs=0}_getPercentage(e,t=this._totalConvs){return 0===t?0:Math.round(e/t*100)}async getCache(){let e=[],t=await this.getConvs();for(let s=0;s<t.length;s++){let a=t[s];if(a&&a.convId&&!this.didDelete.get(a.convId)){let t=sn.a.getCache(a.convId);t&&e.push(Object(I.a)(Object(I.a)({},a),{},{amount:t}))}}return e}async _getOutdatedConvs(){let e=await this.getConvs();this.Logger.zsymb(3,"YxsPVP",["total convs: {}","sMivV8"],e.length);const t=a.ModuleContainer.resolve(Q.b);return this._taskCalcTs>0&&(e=e.filter((e=>{const s=t.getLastOpenConv(e.convId);return s&&s>=this._taskCalcTs&&!this.didDelete.get(e.convId)}))),this.Logger.zsymb(3,"-39vJQ",["outdated convs: {}","iaRWPr"],e.length),e}_caclculateHiddenConvSize(e,t){return new Promise(((s,a)=>{try{const{convId:a}=e;let i=t=>{let a=Object(I.a)(Object(I.a)({},e),{},{amount:t});return s(a)},n=sn.a.calculateConvDataForResMnt(a,i,t);this.taskDBScanIds.push(n)}catch(i){return s(null)}}))}createTask(e,t){return qn(e.convId),new Promise(((s,a)=>{try{const{convId:a}=e;let i=t=>{let a=Object(I.a)(Object(I.a)({},e),{},{amount:t});return this.resultCallback(a),s(a)},n=sn.a.calculateConvDataForResMnt(a,i,t);this.taskDBScanIds.push(n)}catch(i){return s(null)}}))}validateCalculateResult(e){return!(!e||e.videosSize+e.imagesSize+e.filesSize<1)}async getConvs(){try{const e=await me.a.ConvInfoDataManager.getAllConv(),t=a.ModuleContainer.resolve(Nn.PreviewDataManager);let s=[];if(!e||!e.length)return s;for(let a=0;a<e.length;a++){const i=async e=>{var s;let a="",i="";const n=e.userId,r=parseInt((null===(s=await t.getPreviewById(n))||void 0===s?void 0:s.messageTime)||"0");try{if(n.startsWith(Y.GROUPID_PREFIX)){const e=await yn.default.getFullInfoGroupById(n);e.displayName&&(a=e.displayName),e.avatar&&(i=e.avatar)}else{const e=await Ii.default.getProfileFriendById(n);e.displayName&&(a=e.displayName),e.avatar&&(i=e.avatar)}return{convId:n,displayName:a,userId:e.userId,avatar:i,lastMsgTime:r}}catch(o){return null}};let n=e[a];if(!n||!n.userId)continue;if(In.a.isThreadHidden(n.userId)){const e=await i(n);if(!e)continue;let t=Object(I.a)(Object(I.a)({},n),e);t=await this._caclculateHiddenConvSize(t,this.isDetailScanRecalculate),this.dataHiddenConversations=this.dataHiddenConversations.filter((e=>e.convId!==t.convId)),t&&this.dataHiddenConversations.push(t),this.dataHiddenConversations=this.dataHiddenConversations.filter((e=>e.amount.filesSize+e.amount.imagesSize+e.amount.videosSize>0));continue}const r=await i(n);r&&s.push(Object(I.a)(Object(I.a)({},n),r))}return s}catch(e){return[]}}})||xn)||xn)||xn)||xn;var Zn;let $n=Object(a.injectable)()(Zn=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Zn=Reflect.metadata("design:type",Function)(Zn=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Zn=class extends hs.b{constructor(e){super(),this._logger=void 0,this._filterBy=void 0,this._sortBy=void 0,this._searchBy=void 0,this._toggleHiddenBy=void 0,this._logger=e.createZLogger("resmgmt",["ResConvFilterManager"]),this._filterBy=kn.k.ALL,this._sortBy=kn.l.DECREASE_CAPACITY,this._searchBy="",this._toggleHiddenBy=!1}getCurrentFilter(){return this._filterBy}getCurrentSort(){return this._sortBy}getCurrentSearch(){return this._searchBy}getCurrentToggleHiddenConvs(){return this._toggleHiddenBy}filter(e){this._filterBy=e,this._logger.zsymb(2,"XZoBbO","filterBy",e),this.dispatchEvent(new Cn(Fn.ResConv_FilterSort_Status_Change,{type:"filterBy",value:e}))}resetDefault(){this._sortBy=kn.l.DECREASE_CAPACITY,this._searchBy="",this._toggleHiddenBy=!1,this._logger.zsymb(2,"VlYNNc","resetDefault"),this.dispatchEvent(new Cn(Fn.ResConv_FilterSort_Status_Change,{type:"sortBy",value:kn.l.DECREASE_CAPACITY,ignoreRender:!0})),this.dispatchEvent(new Cn(Fn.ResConv_FilterSort_Status_Change,{type:"searchBy",value:"",ignoreRender:!0})),this.dispatchEvent(new Cn(Fn.ResConv_FilterSort_Status_Change,{type:"toggleHiddenBy",value:!1,ignoreRender:!0}))}sort(e){this._sortBy=e,this._logger.zsymb(2,"OgWQSL","sortBy",e),this.dispatchEvent(new Cn(Fn.ResConv_FilterSort_Status_Change,{type:"sortBy",value:e}))}search(e){this._searchBy=e,this._logger.zsymb(2,"kIIeOM","searchBy",e),this.dispatchEvent(new Cn(Fn.ResConv_FilterSort_Status_Change,{type:"searchBy",value:e}))}toggleHidden(e){this._toggleHiddenBy=e,this._logger.zsymb(2,"69ulpk","toggleHiddenBy",e),this.dispatchEvent(new Cn(Fn.ResConv_FilterSort_Status_Change,{type:"toggleHiddenBy",value:e}))}})||Zn)||Zn)||Zn)||Zn;class Qn extends hs.b{constructor(e,t){super(),this._calculationTracker={recalcRequests:1,lastTs:0},this.logger=void 0,this._recordCalcHistory=e=>{this._calculationTracker=e?Object(I.a)(Object(I.a)({},this._calculationTracker),e):{recalcRequests:0,lastTs:Date.now()}},this.logger=t.createZLogger("resmgmt",[e])}checkForceCalculate(e=!1){return e||this._calculationTracker.recalcRequests>0}}var Yn,Jn=s("7aVi");let Xn=Object(a.injectable)()(Yn=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Yn=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(Yn=function(e,t){return a.ModuleContainer.inject(nn.a)(e,void 0,2)}(Yn=Reflect.metadata("design:type",Function)(Yn=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===nn.a?Object:nn.a])(Yn=class extends Qn{constructor(e,t,s){super("ResConvDataManager",e),this.application=t,this.convDataSource=s,this.cancelDBScan=()=>{this.convDataSource.cancelDBScan(),this._recordCalcHistory({recalcRequests:1,lastTs:0})},this.cancelQuickScan=()=>{this.convDataSource.cancelQuickScan()},this.calculateConvDataSize=e=>e.reduce(((e,t)=>{const s=t.amount||null;let a=0;for(let i in s)a+=s[i]||0;return e+a}),0),this._listenEvents=()=>{this.convDataSource.addEventListener(Fn.ResCalc_ConvData_Status,this._handleCalculationStatus),this.convDataSource.addEventListener(Fn.ResCalc_Manual_Fast_Calculate,this._handleManualFastCalculateStatus),this.convDataSource.addEventListener(Fn.ResCalc_Manual_Detail_Calculate,this._handleManualDetailCalculateStatus),this.convDataSource.addEventListener(Fn.ResCalc_Delete_Convs,this._handleCalculateResourceWhenDeleteConvs),this.convDataSource.addEventListener(Fn.ResCalc_Delete_Convs_Status,this._handleCalculateDeleteConvsStatus),this.convDataSource.addEventListener(Fn.ResCalc_Update_Detail_Page_Cache,this._handleCalculateUpdateDetailPageCache),this.convDataSource.addEventListener(Fn.ResCalc_Calculate,this._handleResCalculateStatus),this.application.addEventListener(m.b.Exit,this.onApplicationExit)},this.onApplicationExit=()=>{this.cancelDBScan(),this.cancelQuickScan(),this._cleanupListeners()},this._cleanupListeners=()=>{this.convDataSource.removeEventListener(Fn.ResCalc_ConvData_Status,this._handleCalculationStatus),this.convDataSource.removeEventListener(Fn.ResCalc_Manual_Fast_Calculate,this._handleManualFastCalculateStatus),this.convDataSource.addEventListener(Fn.ResCalc_Manual_Detail_Calculate,this._handleManualDetailCalculateStatus),this.convDataSource.removeEventListener(Fn.ResCalc_Delete_Convs,this._handleCalculateResourceWhenDeleteConvs),this.convDataSource.removeEventListener(Fn.ResCalc_Delete_Convs_Status,this._handleCalculateDeleteConvsStatus),this.convDataSource.removeEventListener(Fn.ResCalc_Update_Detail_Page_Cache,this._handleCalculateUpdateDetailPageCache),this.convDataSource.removeEventListener(Fn.ResCalc_Calculate,this._handleResCalculateStatus),this.application.removeEventListener(m.b.Exit,this.onApplicationExit)},this._handleCalculationStatus=e=>{this.dispatchEvent(new Sn(Fn.ResCalc_UI_Status_Change,e.payload))},this._handleManualFastCalculateStatus=e=>{this.dispatchEvent(new Mn(Fn.ResCalc_Manual_Fast_Calculate,e.payload))},this._handleManualDetailCalculateStatus=e=>{this.dispatchEvent(new Mn(Fn.ResCalc_Manual_Detail_Calculate,e.payload))},this._handleCalculateResourceWhenDeleteConvs=e=>{this.dispatchEvent(new Tn(Fn.ResCalc_Delete_Convs,e.payload))},this._handleCalculateDeleteConvsStatus=e=>{this.dispatchEvent(new Rn(Fn.ResCalc_Delete_Convs_Status,e.payload))},this._handleCalculateUpdateDetailPageCache=e=>{this.dispatchEvent(new wn(Fn.ResCalc_Update_Detail_Page_Cache,e.payload))},this._handleResCalculateStatus=e=>{this.dispatchEvent(new Ln(Fn.ResCalc_Calculate,e.payload)),a.ModuleContainer.resolve(Jn.a).dispatchEvent(new Ln(Fn.ResCalc_Calculate,e.payload))},this._listenEvents()}start(e=!1,t,s){return this.checkForceCalculate(e)||t?(this.logger.zsymb(5,"xKTuxK",["calculating: force:{} {}","fYnKGT"],this.checkForceCalculate(e),this._calculationTracker),new Promise(((a,i)=>{this.convDataSource.start(e,t,s).then((e=>{a(e),this._recordCalcHistory()})).catch((e=>{i(e)}))}))):(s&&s(this.convDataSource.getConvData()),Promise.resolve(!0))}fastStart(e=!1,t,s){return this.checkForceCalculate(e)||t?(this.logger.zsymb(5,"paX2UI",["calculating: force:{} {}","fYnKGT"],this.checkForceCalculate(e),this._calculationTracker),new Promise(((a,i)=>{this.convDataSource.fastStart(e,t,s).then((e=>{a(e),this._recordCalcHistory()})).catch((e=>{i(e)}))}))):(s&&s(this.convDataSource.getConvData()),Promise.resolve(!0))}isOA(e){return Ii.default.isOA(e)}isMyCloud(e){return e===Ce.default.sendToMeId}isGroup(e){return String(e).startsWith(Y.GROUPID_PREFIX)}isHiddenConv(e){return In.a.isThreadHidden(e)}isOtherInOtherGroup(e){return this.isMyCloud(e)||this.isOA(e)}getConvs(){return this.convDataSource.getConvData().filter((e=>this.validateCalculateResult(e.amount)))}setForceConvData(e){this.convDataSource.setForceConvData(e)}getConvHiddenData(){return this.convDataSource.getConvHiddenData()}setForceConvHiddenData(e){this.convDataSource.setForceConvHiddenData(e)}setResCalculateStatus(e){this.convDataSource.setResCalculateStatus(e)}async onDelete(e,t){return this.convDataSource.onDelete(e,t)}onUpdateDataBeforeDelete(e,t){return this.convDataSource.onUpdateDataBeforeDelete(e,t)}status(){return this.convDataSource.status()}validateCalculateResult(e){return this.convDataSource.validateCalculateResult(e)}calculateConvDataSizeByIds(e,t){return this.convDataSource.getConvData().filter((t=>e.includes(t.convId))).reduce(((e,s)=>e+(null!=t&&t.video&&s.amount.videosSize?s.amount.videosSize:null!=t&&t.file&&s.amount.filesSize?s.amount.filesSize:null!=t&&t.photo&&s.amount.imagesSize?s.amount.imagesSize:0)),0)}setConvToHidden(e,t,s){this.convDataSource.setConvToHidden(e,t,s)}removeConvToList(e){this.convDataSource.removeConvToList(e)}})||Yn)||Yn)||Yn)||Yn)||Yn)||Yn;a.ModuleContainer.registerSingleton(nn.a,Kn),a.ModuleContainer.registerSingleton(bn,Xn),a.ModuleContainer.registerSingleton(_n,$n);const er=Object(a.define)("resmgmt-zarf-datasource");var tr;let sr=Object(a.injectable)()(tr=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(tr=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(tr=function(e,t){return a.ModuleContainer.inject(er)(e,void 0,2)}(tr=Reflect.metadata("design:type",Function)(tr=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===er?Object:er])(tr=class extends Qn{constructor(e,t,s){super("ResZaRFDataManager",e),this.application=t,this.zarfDataSource=s,this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents),this.removeEventListener(Fn.ResCalc_ZaRF_Status,this._handleCalcStatusChange)},this._handleCalcStatusChange=e=>{this._broadcastEvent(e.type,e.payload)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents),this.zarfDataSource.addEventListener(Fn.ResCalc_ZaRF_Status,this._handleCalcStatusChange)},this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}start(e,t){return this.checkForceCalculate(e)?(this.logger.zsymb(5,"-FiBQD",["calculating: force:{} {}","fYnKGT"],this.checkForceCalculate(e),this._calculationTracker),new Promise(((e,s)=>{this.zarfDataSource.start(t).then((t=>{e(t),this._recordCalcHistory()})).catch((e=>{s(e)}))}))):(t&&t(this.zarfDataSource.getSize()),Promise.resolve(!0))}cancel(){this.zarfDataSource.cancel(),this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:kn.n.IDLE,type:"convDataStatus",progress:1})}abort(){this.zarfDataSource.abort()}reset(){this._broadcastEvent(Fn.ResCalc_ConvData_Status,{status:kn.n.CALCULATING,type:"zaRFStatus"})}_broadcastEvent(e,t){if(e===Fn.ResCalc_ZaRF_Status)this.dispatchEvent(new Sn(Fn.ResCalc_UI_Status_Change,t))}})||tr)||tr)||tr)||tr)||tr)||tr;var ar;function ir(){}let nr=Object(a.injectable)()(ar=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,0)}(ar=Reflect.metadata("design:type",Function)(ar=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(ar=class extends hs.b{constructor(e){super(),this.application=e,this.resultCallback=void 0,this.onDataChange=void 0,this._Tasks=[],this._size=0,this._broadcastEvent=(e,t)=>{if(e===Fn.ResCalc_ZaRF_Status)this.dispatchEvent(new Sn(Fn.ResCalc_ZaRF_Status,t))},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this.resultCallback=ir,this.onDataChange=ir,this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}async start(e){var t;return this.onDataChange=t=>{this._size=t,e&&e(t)},this.resultCallback=e=>{this._size=e,this.onDataChange(e),this._broadcastEvent(Fn.ResCalc_ZaRF_Status,{status:kn.n.IDLE,type:"zaRFStatus"})},this._broadcastEvent(Fn.ResCalc_ZaRF_Status,{status:kn.n.CALCULATING,type:"zaRFStatus"}),null===(t=this._Tasks)||void 0===t||t.push(sn.a.getZaloReceivedFilesAmt(this.resultCallback,this.onDataChange)),!0}cancel(){this._cleanupEvents(),this.resultCallback=ir,this.onDataChange=ir,this._Tasks.length&&(sn.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._broadcastEvent(Fn.ResCalc_ZaRF_Status,{status:kn.n.IDLE,type:"zaRFStatus"})}abort(){this._cleanupEvents(),this.resultCallback=ir,this.onDataChange=ir,this._Tasks.length&&(sn.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._broadcastEvent(Fn.ResCalc_ZaRF_Status,{status:null,type:"zaRFStatus"})}getSize(){return this._size}})||ar)||ar)||ar)||ar;const rr=Object(a.define)("resmgmt-zarf-datamanager");a.ModuleContainer.registerSingleton(er,nr),a.ModuleContainer.registerSingleton(rr,sr);const or=Object(a.define)("resmgmt-unlisted-datasource");var cr;let lr=Object(a.injectable)()(cr=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(cr=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(cr=function(e,t){return a.ModuleContainer.inject(or)(e,void 0,2)}(cr=Reflect.metadata("design:type",Function)(cr=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a,void 0===or?Object:or])(cr=class extends Qn{constructor(e,t,s){super("ResUnlistedDataManager",e),this.application=t,this.resUnlistedDataSource=s,this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents),this.resUnlistedDataSource.removeEventListener(Fn.ResCalc_ZaloLocal_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.removeEventListener(Fn.ResCalc_AppData_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.removeEventListener(Fn.ResCalc_OtherAccounts_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.removeEventListener(Fn.Res_Clean_Cache_Folder_Status,this._handleCleanCacheFolderStatusChange),this.resUnlistedDataSource.removeEventListener(Fn.Res_Clean_Other_Accounts_Status,this._handleCleanOtherAccountsStatusChange),this.resUnlistedDataSource.removeEventListener(Fn.ResCalc_Cache_Folder_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.removeEventListener(Fn.ResCalc_Sticker_Status,this._handleCalcStatusChange)},this._handleCalcStatusChange=e=>{this._broadcastEvent(e.type,e.payload)},this._handleCleanCacheFolderStatusChange=e=>{this._broadcastEvent(e.type,e.payload)},this._handleCleanOtherAccountsStatusChange=e=>{this._broadcastEvent(e.type,e.payload)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents),this.resUnlistedDataSource.addEventListener(Fn.ResCalc_OtherAccounts_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.addEventListener(Fn.ResCalc_ZaloLocal_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.addEventListener(Fn.ResCalc_AppData_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.addEventListener(Fn.Res_Clean_Cache_Folder_Status,this._handleCleanCacheFolderStatusChange),this.resUnlistedDataSource.addEventListener(Fn.Res_Clean_Other_Accounts_Status,this._handleCleanOtherAccountsStatusChange),this.resUnlistedDataSource.addEventListener(Fn.ResCalc_Cache_Folder_Status,this._handleCalcStatusChange),this.resUnlistedDataSource.addEventListener(Fn.ResCalc_Sticker_Status,this._handleCalcStatusChange)},this._cleanupEvents=this._cleanupEvents.bind(this),this._listenEvents()}onDeleteConvs(e){return this.resUnlistedDataSource.onDeleteConvs(e)}async clearCacheData(e,t){return await this.resUnlistedDataSource.clearCacheData(e,t)}async clearOtherAccountsData(){return await this.resUnlistedDataSource.clearOtherAccountsData()}async calculateZaloAppData(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloAppData(e,t,s),!0}async calculateZaloDBSearch(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloDBSearch(e,t,s),!0}async calculateZaloAppDataLog(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloAppDataLog(e,t,s),!0}async calculateZaloLocal(e=!1,t,s,a){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloLocal(e,t,s,a),0}async calculateOtherAccounts(e=!1,t,s,a){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateOtherAccounts(e,t,s,a),!0}async calculateCacheFolder(e=!1,t,s,a){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateCacheFolder(e,t,s,a),!0}async calculateSticker(e=!1,t,s,a){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateSticker(e,t,s,a),!0}async calculatezTemp(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculatezTemp(e,t,s),!0}async calculateZaloTemp(e=!1,t,s){return this.checkForceCalculate(e)&&this.resUnlistedDataSource.calculateZaloTemp(e,t,s),!0}cancel(){this.resUnlistedDataSource.cancel(),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:kn.n.IDLE,type:"zaloLocalStatus"}),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:kn.n.IDLE,type:"appDataStatus"}),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:kn.n.IDLE,type:"otherAccountsStatus"}),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:kn.n.IDLE,type:"zTempStatus"}),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:kn.n.IDLE,type:"zaloTempStatus"})}abort(){this.resUnlistedDataSource.abort(),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:null,type:"zaloLocalStatus"}),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:null,type:"appDataStatus"}),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:null,type:"otherAccountsStatus"}),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:null,type:"zTempStatus"}),this._broadcastEvent(Fn.ResCalc_UI_Status_Change,{status:null,type:"zaloTempStatus"})}_broadcastEvent(e,t){switch(e){case Fn.ResCalc_ZaloLocal_Status:case Fn.ResCalc_OtherAccounts_Status:case Fn.ResCalc_AppData_Status:case Fn.ResCalc_Cache_Folder_Status:case Fn.ResCalc_Sticker_Status:this.dispatchEvent(new Sn(Fn.ResCalc_UI_Status_Change,t));break;case Fn.Res_Clean_Cache_Folder_Status:this.dispatchEvent(new Dn(Fn.Res_Clean_Cache_Folder_Status,t));break;case Fn.Res_Clean_Other_Accounts_Status:this.dispatchEvent(new An(Fn.Res_Clean_Other_Accounts_Status,t))}}})||cr)||cr)||cr)||cr)||cr)||cr;var dr,ur=s("zbf3"),hr=s("wudS"),gr=s("A/Z2"),mr=s("DuXi"),pr=s("zE7v"),fr=s("8gV5");let vr,_r,br;function Ir(){}vr=$znode.fastGlob,_r=$znode.path,br=s("Dprd").default;const yr=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("res-management",["unlisted-datasource"]);let Sr=Object(a.injectable)()(dr=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,0)}(dr=Reflect.metadata("design:type",Function)(dr=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(dr=class extends hs.b{constructor(e){super(),this.application=e,this._Tasks=[],this._ZaloAppData={calculated:!1,size:0,resCb:Ir,changeCb:Ir},this._ZaloLocal={calculated:!1,size:0,resCb:Ir,changeCb:Ir},this._ZaloOtherAccounts={calculated:!1,size:0,noOtherAccounts:0,otherAccountsInfo:[],resCb:Ir,changeCb:Ir},this._ZaloCacheFolder={calculated:!1,size:0,resCb:Ir,changeCb:Ir},this._ZaloStickers={calculated:!1,size:0,resCb:Ir,changeCb:Ir},this._zTemp={calculated:!1,size:0,resCb:Ir,changeCb:Ir},this._ZaloTemp={calculated:!1,size:0,resCb:Ir,changeCb:Ir},this._ZaloDBSearch={calculated:!1,size:0,resCb:Ir,changeCb:Ir},this._otherAccountPaths=[],this.lsCleaner=void 0,this.pause=e=>new Promise((t=>{setTimeout((()=>t()),e)})),this._broadcastEvent=(e,t)=>{switch(e){case Fn.ResCalc_AppData_Status:case Fn.ResCalc_OtherAccounts_Status:case Fn.ResCalc_ZaloLocal_Status:case Fn.ResCalc_Cache_Folder_Status:case Fn.ResCalc_Sticker_Status:this.dispatchEvent(new Sn(e,t));break;case Fn.Res_Clean_Cache_Folder_Status:this.dispatchEvent(new Dn(e,t));break;case Fn.Res_Clean_Other_Accounts_Status:this.dispatchEvent(new An(e,t))}},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this._cleanupEvents=this._cleanupEvents.bind(this),this.lsCleaner=mr.a.instance(),this._listenEvents()}cancel(){this._cleanupEvents(),this._Tasks.length&&(sn.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._ZaloAppData.changeCb=Ir,this._ZaloAppData.resCb=Ir,this._ZaloLocal.changeCb=Ir,this._ZaloLocal.resCb=Ir,this._ZaloOtherAccounts.changeCb=Ir,this._ZaloOtherAccounts.resCb=Ir,this._ZaloCacheFolder.changeCb=Ir,this._ZaloCacheFolder.resCb=Ir,this._ZaloStickers.changeCb=Ir,this._ZaloStickers.resCb=Ir,this._ZaloTemp.changeCb=Ir,this._ZaloTemp.resCb=Ir,this._zTemp.changeCb=Ir,this._zTemp.resCb=Ir,this._broadcastEvent(Fn.ResCalc_ZaRF_Status,{status:kn.n.IDLE,type:"zaRFStatus"})}abort(){this._cleanupEvents(),this._Tasks.length&&(sn.a.cancel(this._Tasks),this._Tasks.splice(0,this._Tasks.length)),this._ZaloAppData.changeCb=Ir,this._ZaloAppData.resCb=Ir,this._ZaloLocal.changeCb=Ir,this._ZaloLocal.resCb=Ir,this._ZaloOtherAccounts.changeCb=Ir,this._ZaloOtherAccounts.resCb=Ir,this._ZaloCacheFolder.changeCb=Ir,this._ZaloCacheFolder.resCb=Ir,this._ZaloStickers.changeCb=Ir,this._ZaloStickers.resCb=Ir,this._ZaloTemp.changeCb=Ir,this._ZaloTemp.resCb=Ir,this._zTemp.changeCb=Ir,this._zTemp.resCb=Ir}getSize(){return this._ZaloAppData.size+this._ZaloLocal.size}getZaloAppDataSize(){return this._ZaloAppData.size}getZaloLocalSize(){return this._ZaloLocal.size}getZaloOtherAccountsSize(){return this._ZaloOtherAccounts.size}onDeleteConvs(e){return this._ZaloLocal.size-=e,this._ZaloLocal.changeCb&&this._ZaloLocal.changeCb(this._ZaloLocal.size),Promise.resolve()}async calculateOtherAccounts(e,t,s,a){const i={size:this._ZaloOtherAccounts.size,noOtherAccounts:this._ZaloOtherAccounts.noOtherAccounts,otherAccountsInfo:this._ZaloOtherAccounts.otherAccountsInfo},n=e=>{this._broadcastEvent(Fn.ResCalc_OtherAccounts_Status,{status:e,type:"otherAccountsStatus"})};if(this._ZaloOtherAccounts.calculated&&s&&!e)return s(i);const r=await Object(wi.getZaloPCDir)(),o=(await vr(Object(Pn.a)(_r.join(r,"**")),{deep:1,onlyDirectories:!0})).map((e=>_r.basename(e))),c=J.p.getSessionUserId();Un.push(c);const l=o.filter((e=>!Un.includes(e))),d=Object(hr.f)().filter((e=>e!=c)),u=[...new Set([...l,...d])];if(yr.zsymb(0,"FwN0Dw",`[RES-MNT] calculateOtherAccounts - userIds from ZaloPC ${JSON.stringify(l)} userIds from DB ${JSON.stringify(d)} merge userIds ${JSON.stringify(u)}`),this._otherAccountPaths.length){if(!this._otherAccountPaths.filter((e=>!u.includes(e))).length&&!t&&s)return s(i)}else this._otherAccountPaths=[...u];if(this._ZaloOtherAccounts.calculated&&!e)return void(s?s(i):a&&a(i));t&&(this._ZaloOtherAccounts={size:0,noOtherAccounts:0,otherAccountsInfo:[],calculated:!1});const h=e=>{this._ZaloOtherAccounts.size=e,s&&s(Object(I.a)({},this._ZaloOtherAccounts))},g=e=>{this._ZaloOtherAccounts.size=e,this._ZaloOtherAccounts.calculated=!0,s&&s(Object(I.a)({},this._ZaloOtherAccounts)),n(kn.n.IDLE)};if(this._ZaloOtherAccounts.resCb=g,this._ZaloOtherAccounts.changeCb=h,n(kn.n.CALCULATING),u&&0!==u.length){if(u.length>0){var m;this._ZaloOtherAccounts.noOtherAccounts=u.length,this._ZaloOtherAccounts.otherAccountsInfo=u,null===(m=this._Tasks)||void 0===m||m.push(sn.a.getOtherAccountUsage(u,g,h))}}else this._ZaloOtherAccounts.size=0,this._ZaloOtherAccounts.noOtherAccounts=0,this._ZaloOtherAccounts.otherAccountsInfo=[],s&&s({size:0,noOtherAccounts:0}),n(kn.n.IDLE),this._ZaloOtherAccounts.calculated=!0}_getPersistedOverviewData(){return JSON.parse(ln.b.getOverviewPageData())}async calculateCacheFolder(e,t,s,a){var i;if(ln.b.getPathsBySource("cache")){const e=this._getPersistedOverviewData();if(null!=e&&e.time&&null!=e&&e.zaloCacheFoldersSize)return this._ZaloCacheFolder.size=null==e?void 0:e.zaloCacheFoldersSize,this._ZaloCacheFolder.calculated=!0,void(s?s(this._ZaloCacheFolder.size):a&&a(this._ZaloCacheFolder.size))}if(this._ZaloCacheFolder.calculated&&!e)return void(s?s(this._ZaloCacheFolder.size):a&&a(this._ZaloCacheFolder.size));const n=e=>{this._ZaloCacheFolder.size=e,s&&s(e)},r=e=>{this._ZaloCacheFolder.size=e,this._ZaloCacheFolder.calculated=!0,s&&s(e),this._broadcastEvent(Fn.ResCalc_Cache_Folder_Status,{status:kn.n.IDLE,type:"zaloCacheFolderStatus"})};this._ZaloCacheFolder.resCb=r,this._ZaloCacheFolder.changeCb=n,this._broadcastEvent(Fn.ResCalc_Cache_Folder_Status,{status:kn.n.CALCULATING,type:"zaloCacheFolderStatus"}),null===(i=this._Tasks)||void 0===i||i.push(sn.a.getCacheFolderAmount(r,n))}async calculateSticker(e,t,s,a){var i;if(this._ZaloStickers.calculated&&!e)return void(s?s(this._ZaloStickers.size):a&&a(this._ZaloStickers.size));const n=e=>{this._ZaloStickers.size=e,s&&s(e)},r=e=>{this._ZaloStickers.size=e,this._ZaloStickers.calculated=!0,s&&s(e),this._broadcastEvent(Fn.ResCalc_Sticker_Status,{status:kn.n.IDLE,type:"zaloStickerStatus"})};this._ZaloStickers.resCb=r,this._ZaloStickers.changeCb=n,this._broadcastEvent(Fn.ResCalc_Sticker_Status,{status:kn.n.CALCULATING,type:"zaloStickerStatus"}),null===(i=this._Tasks)||void 0===i||i.push(sn.a.getStickerAmount(r,n))}async calculatezTemp(e,t,s){var a;if(this._zTemp.calculated&&!e)return void(t?t(this._zTemp.size):s&&s(this._zTemp.size));const i=e=>{this._zTemp.size=e,t&&t(e)},n=e=>{this._zTemp.size=e,this._zTemp.calculated=!0,t&&t(e),this._broadcastEvent(Fn.ResCalc_zTemp_Status,{status:kn.n.IDLE,type:"zTempStatus"})};this._zTemp.resCb=n,this._zTemp.changeCb=i,this._broadcastEvent(Fn.ResCalc_zTemp_Status,{status:kn.n.CALCULATING,type:"zTempStatus"}),null===(a=this._Tasks)||void 0===a||a.push(sn.a.getzTempAmount(n,i))}async calculateZaloTemp(e,t,s){var a;if(this._ZaloTemp.calculated&&!e)return void(t?t(this._ZaloTemp.size):s&&s(this._ZaloTemp.size));const i=e=>{this._ZaloTemp.size=e,t&&t(e)},n=e=>{this._ZaloTemp.size=e,this._ZaloTemp.calculated=!0,t&&t(e),this._broadcastEvent(Fn.ResCalc_ZaloTemp_Status,{status:kn.n.IDLE,type:"zaloTempStatus"})};this._ZaloTemp.resCb=n,this._ZaloTemp.changeCb=i,this._broadcastEvent(Fn.ResCalc_ZaloTemp_Status,{status:kn.n.CALCULATING,type:"zaloTempStatus"}),null===(a=this._Tasks)||void 0===a||a.push(sn.a.getZaloTempAmount(n,i))}calculateZaloAppData(e,t,s){var a;if(this._ZaloAppData.calculated&&!e)return void(t?t(this._ZaloAppData.size):s&&s(this._ZaloAppData.size));const i=e=>{this._ZaloAppData.size=e,t&&t(e)},n=e=>{this._ZaloAppData.size=e,this._ZaloAppData.calculated=!0,t&&t(e),this._broadcastEvent(Fn.ResCalc_AppData_Status,{status:kn.n.IDLE,type:"appDataStatus"})};this._ZaloAppData.resCb=n,this._ZaloAppData.changeCb=i,this._broadcastEvent(Fn.ResCalc_AppData_Status,{status:kn.n.CALCULATING,type:"appDataStatus"}),null===(a=this._Tasks)||void 0===a||a.push(sn.a.getZaloDBAmount(n,i,!1))}calculateZaloDBSearch(e,t,s){var a;if(this._ZaloDBSearch.calculated&&!e)return void(t?t(this._ZaloDBSearch.size):s&&s(this._ZaloDBSearch.size));const i=e=>{this._ZaloDBSearch.size=e,t&&t(e)},n=e=>{this._ZaloDBSearch.size=e,this._ZaloDBSearch.calculated=!0,t&&t(e),this._broadcastEvent(Fn.ResCalc_AppData_Status,{status:kn.n.IDLE,type:"zaloDBSearchStatus"})};this._ZaloDBSearch.resCb=n,this._ZaloDBSearch.changeCb=i,this._broadcastEvent(Fn.ResCalc_AppData_Status,{status:kn.n.CALCULATING,type:"zaloDBSearchStatus"}),null===(a=this._Tasks)||void 0===a||a.push(sn.a.getZaloDBSearchAmount(n,i,!1))}calculateZaloAppDataLog(e,t,s){if(this._ZaloAppData.calculated&&!e)return void(t?t(this._ZaloAppData.size):s&&s(this._ZaloAppData.size));const a=e=>{this._ZaloAppData.size=e,this._ZaloAppData.calculated=!0,t&&t(e),this._broadcastEvent(Fn.ResCalc_AppData_Status,{status:kn.n.IDLE,type:"appDataStatus"})};this._ZaloAppData.resCb=a,this._ZaloAppData.changeCb=e=>{this._ZaloAppData.size=e,t&&t(e)},this._broadcastEvent(Fn.ResCalc_AppData_Status,{status:kn.n.CALCULATING,type:"appDataStatus"});let i=Object(wi.getDbPath)();(async()=>{const e=await ur.b.execRaw("getDirSizeNoCaching",[i]);a(e)})()}calculateZaloLocal(e,t,s,a){return new Promise((i=>{var n;if(this._ZaloLocal.calculated&&!e&&!t)return s?s(this._ZaloLocal.size):a&&a(this._ZaloLocal.size),i(this._ZaloLocal.size);const r=e=>{this._ZaloLocal.size=e,s&&s(e)},o=e=>{this._ZaloLocal.size=e,this._ZaloLocal.calculated=!0,s&&s(e),this._broadcastEvent(Fn.ResCalc_ZaloLocal_Status,{status:kn.n.IDLE,type:"zaloLocalStatus"})};this._ZaloLocal.resCb=o,this._ZaloLocal.changeCb=r,this._broadcastEvent(Fn.ResCalc_ZaloLocal_Status,{status:kn.n.CALCULATING,type:"zaloLocalStatus"}),null===(n=this._Tasks)||void 0===n||n.push(sn.a.getZaloDataAmount(o,r,!1))}))}async clearCacheData(e,t){const s=a.ModuleContainer.resolve(Zi.a),i=s.getTimeNow(),n=e=>{this._broadcastEvent(Fn.Res_Clean_Cache_Folder_Status,{status:e,type:"cleanCacheFolderStatus"})};n(kn.c.CALCULATING);const r=J.p.getSessionUserId(),o=await Object(wi.getUserCacheDir)(r),c=(e,t=!1)=>{const a=[Gn.RENAME_FAILED,Gn.DELETE_FAILED,Gn.HIDE_WINDOWS_FAILED];let r="success";const o=Number(sessionStorage.getItem(rn.d));if(e.type===zn){a.includes(e.status)&&n(kn.c.ERROR),e.status===Gn.DELETE_FAILED&&(ln.b.setInfoRemoveLocalResourceFailed("cache",e.folderPath),r="fail_at_rename"),e.status!==Gn.CHECK_EXIST_FOLDER_FAILED||t||null!=e&&e.error&&"ENOENT"===JSON.parse(null==e?void 0:e.error).code&&(n(kn.c.IDLE),r="success"),e.status!==Gn.COMPLETED||t||(n(kn.c.IDLE),r="success");const c=s.getTimeNow()-i,l="fail_at_rename"===r,d=l?0:Number(o);s.actualDeleteCache({processingTimeMs:c,hasRetry:l,actualDeletedSize:d,requestedDeleteSize:o,status:r})}},l=Ce.default.resource_management.force_remove_local_failed,d=dn.a.resource_management.enable_calculate_sticker_as_cache&&t>0;if(await ur.b.execRaw("cleanLocalResourceFolder",[o,{forceRemoveFolderFailed:l,timeToPauseAfterRename:dn.a.resource_management.rename_delay}],{on:e=>c(e,d),priority:ur.a.HIGH}),d){const e=await Object(wi.getUserZaloPCDir)(r),t=br.pathJoin(e,fr.a.StickerFolderName);await ur.b.execRaw("cleanLocalResourceFolder",[t,{forceRemoveFolderFailed:l,timeToPauseAfterRename:dn.a.resource_management.rename_delay}],{on:e=>c(e),priority:ur.a.HIGH})}}_getOtherAccountsUserIds(){var e;const t=JSON.parse(ln.b.getOverviewPageData());if((null==t||null===(e=t.otherAccountsInfo)||void 0===e?void 0:e.length)>0)return null==t?void 0:t.otherAccountsInfo;const s=J.p.getSessionUserId();return Object(hr.f)().filter((e=>e!==s))}async cleanUpDataOfOtherAccount(e,t,s,a,i=dn.a.resource_management.rename_delay){const n=Ce.default.resource_management.force_remove_local_failed;await ur.b.execRaw("cleanLocalResourceFolder",[t,{forceRemoveFolderFailed:n,timeToPauseAfterRename:i}],{on:t=>s(e,t),priority:a})}async cleanUpSearchDBOfOtherAccounts(e,t){const{getDbSearchPathRoot:a,getAllDbSearchFiles:i}=s("Acu+"),n=J.p.getSessionUserId(),r=a(),o=(await i()).filter((e=>!e.includes(n))).map((e=>_r.join(r,e)));if(o.length>0)for(const s of o)br.fileExistSync(s)&&await this.cleanUpDataOfOtherAccount(`searchDB-${o}`,s,e,t,0)}async clearOtherAccountsData(){const e=a.ModuleContainer.resolve(U.c),t=await e.getDBRoot(),s=await Object(wi.getZaloPCDir)(),i=gr.a.instance(),n=this._getOtherAccountsUserIds(),r=a.ModuleContainer.resolve(Zi.a),o=r.getTimeNow();let c=!1;yr.zsymb(0,"4VgXK-",`[RES-MNT] cleanOtherAccountsData - userIds ${JSON.stringify(n)}`);const l=e=>{this._broadcastEvent(Fn.Res_Clean_Other_Accounts_Status,{status:e,type:"cleanOtherAccountsStatus"})},d=(e,t)=>{const s=[Gn.RENAME_FAILED,Gn.DELETE_FAILED,Gn.HIDE_WINDOWS_FAILED];let a="success";const i=Number(sessionStorage.getItem(rn.e));if(t.type===zn){s.includes(t.status)&&(c=!0,l(kn.c.ERROR)),t.status===Gn.DELETE_FAILED&&(ln.b.setInfoRemoveLocalResourceFailed(e,t.folderPath),a="fail_at_rename"),t.status===Gn.COMPLETED&&(a="success");const n=r.getTimeNow()-o,d="fail_at_rename"===a,u=d?0:Number(i);r.actualDeleteOtherAccounts({processingTimeMs:n,hasRetry:d,actualDeletedSize:u,requestedDeleteSize:i,status:a})}};l(kn.c.CALCULATING),await this.cleanUpSearchDBOfOtherAccounts(d,ur.a.HIGH),await Object(pr.a)();for(let a of n)try{const e=_r.join(t,a),n=_r.join(s,a);await this.lsCleaner.cleanupLocalStorage({userId:a}),await i.deleteOldDB({userId:a}),await this.cleanUpDataOfOtherAccount(`db-${a}`,e,d,ur.a.HIGH,0),await this.cleanUpDataOfOtherAccount(`media-${a}`,n,d,ur.a.HIGH,0)}catch(u){l(kn.c.ERROR);break}c||(await this.pause(dn.a.resource_management.rename_delay),l(kn.c.IDLE))}})||dr)||dr)||dr)||dr;const Cr=Object(a.define)("resmgmt-unlisted-datamanager");a.ModuleContainer.registerSingleton(or,Sr),a.ModuleContainer.registerSingleton(Cr,lr);var Er,Or=s("q1tI"),Mr=s.n(Or),Tr=s("B8k8"),Rr=s("lCMA"),wr=s("v/qp"),Lr=s("DOOx"),Dr=s("kibv"),Ar=s("3xbP"),Fr=s("7TIh"),kr=s("Ic+i"),Nr=s("Iawr");const{RICH_SPACE:Pr,ALMOST_FULL_1:jr,ALMOST_FULL_2:Ur,FULL:Br}=kn.g,zr=1073741824,Gr=[jr,Br],xr=[Ur,Br],Vr=[Ur,Br];Object(a.injectable)()(Er=Object(m.j)()(Er=Object(xi.b)(Jn.a)(Er=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,0)}(Er=Reflect.metadata("design:type",Function)(Er=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(Er=class extends hs.b{constructor(e){super(),this.application=e,this._displayingNotiModal=void 0,this._displayingNotiBanner=void 0,this._displayingNotiPopup=void 0,this.didLog_2230101=void 0,this._Logger=void 0,this._total=0,this.openSetttings=e=>{const t=this._getLastNoti();if(e===kn.i.POPUP_MODAL||e===kn.i.FULL_DISK_BANNER){let s=Ct.default.getTimeNow();e===kn.i.FULL_DISK_BANNER&&null!=t&&t.ts&&(s=t.ts),Re.default.setFullDiskNoti(Object(I.a)(Object(I.a)({},t),{},{dismiss:!0,ts:s}))}this._closeNotiType("modal");const s={data:{tab:Fr.h.RES_MANAGEMENT}};Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.SETTINGS,params:s,forceCloseAll:!0})},this.dismissNoti=e=>{if(!e)return this._closeNotiType("all");this._closeNotiType(e===kn.i.POPUP_MODAL?"modal":"banner",!0)},this._osEventHandler=e=>{if(e)switch(e.type){case Lr.b.OUT_OF_MEM:{this._broadcastEvent(Fn.ResDisk_Status,{level:Br});const e=this._getLastNoti(),t=this._getLastBannerNoti(),s=this._getLastPopupNoti();this._handleDiskStatusModal(Br,e),this._handleDiskStatusBanner(Br,t),this._handleDiskStatusPopup(Br,s),this._handleActionLogChangeStorageZone(Br,t);break}case Lr.b.OPEN_SUCCESS:{const e=this._getLastNoti(),t=this._getLastBannerNoti();this._handleDiskStatusModal(Pr,e),this._handleDiskStatusBanner(Pr,t);break}}},this._handleDiskStatus=e=>{if(!Ce.default.full_disk_check.enable)return;const{total:t,free:s}=e,a=this._getFullStatus(t,s);a===Br&&this._broadcastEvent(Fn.ResDisk_Full_Disk_Status,{level:a}),a===Pr||Ce.default.full_disk_check.enable&&Ce.default.full_disk_check.showWarning||this.didLog_2230101||(this.Logger.zsymb(3,"mgtlUm",["Noti modal: noti={} | enable={} | showWarning={}","16T5TM"],a,Ce.default.full_disk_check.enable,Ce.default.full_disk_check.showWarning),this.didLog_2230101=!0,Ia.default.logAction(2230101)),this._broadcastEvent(Fn.ResDisk_CurrentLevel,{level:a});const i=this._getLastNoti(),n=this._getLastBannerNoti(),r=this._getLastPopupNoti();this._handleDiskStatusModal(a,i),this._handleDiskStatusBanner(a,n),this._handleDiskStatusPopup(a,r),this._handleActionLogChangeStorageZone(a,n),Dr.a.start()},this._handleDiskStatusModal=(e,t)=>{var s,a,i,n;if(!Ce.default.full_disk_check.enable||e===jr&&0==(null===(s=Ce.default.full_disk_check)||void 0===s||null===(a=s.level_control)||void 0===a?void 0:a.af1)||e===Br&&!1===(null===(i=Ce.default.full_disk_check)||void 0===i||null===(n=i.level_control)||void 0===n?void 0:n.full_modal))return;this._displayingNotiModal&&(!Gr.includes(e)||t&&t.level!==e)&&(this.Logger.zsymb(3,"7V1PkE",["Noti modal closed lastNoti={} prep for currentNoti={}","UgsS-V"],t,e),this._closeNotiType("modal"));const r=Ct.default.getTimeNow(),o=this._getLastNoti();if(!Gr.includes(e))return void(kn.f[e]<kn.f[t.level]&&(o.level=e===Pr?jr:e,o.ts=r,Re.default.setFullDiskNoti(o)));const c=Ct.default.getTimeNow()-t.ts;if(this.Logger.zsymb(3,"yVO6we",["fdn elapsed: {} | lastNoti={} | newNoti={}","smj_g3"],c,t.level,e),!1===this._displayingNotiModal&&e===Br)return t.dismiss&&c<=Ce.default.full_disk_check.modal_noti_gap&&t.level===Br?void this.Logger.zsymb(3,"diPlzR",["Noti modal full dismissed and less than 7d seconds","e4bS8l"]):(this.Logger.zsymb(3,"1Yv7rT",["Noti modal full (always show)","76whP8"]),void this._triggerDiskStatus(e,"modal",!1));if(t&&t.level===e){if(this._displayingNotiModal||!this._displayingNotiModal&&t.dismiss&&Math.abs(r-t.ts)<Ce.default.full_disk_check.modal_noti_gap)return void(this._displayingNotiModal?this.Logger.zsymb(3,"d7PnSe",["Noti modal dismissed as type unchanged. already ON","LMILy1"]):this.Logger.zsymb(3,"tBZNOO",["Noti modal dismissed as type unchanged. applying 7d-rule={}","Eprpbk"],!0));this.Logger.zsymb(3,"GlDKWy",["Noti modal passed. 7d-rule reset. dismiss reset","Avy7z8"])}else if(t&&t.level&&e&&kn.f[e]<kn.f[t.level]){if(o.dismiss&&Math.abs(r-t.ts)<Ce.default.full_disk_check.type_change_noti_gap)return this.Logger.zsymb(3,"tr-nXj",["Noti modal dismissed: downgrading emergency => 1d-rule={}","FyHp0A"],!0),o.level=e===Pr?jr:e,o.ts=r,void Re.default.setFullDiskNoti(o);this.Logger.zsymb(3,"dpXsy6",["Noti modal: downgrading emergency => 1d-rule expired","t46jxo"])}this._triggerDiskStatus(e,"modal",!0)},this._handleDiskStatusBanner=(e,t)=>{if(!Ce.default.full_disk_check.enable||e===Br&&!1===dn.a.block_usage.full_enable_banner||e===Ur&&!1===dn.a.block_usage.af2_enable_banner)return;this._displayingNotiBanner&&(!xr.includes(e)||t&&t.level!==e)&&(this.Logger.zsymb(3,"8AU_X6",["Noti banner closed lastNoti={} prep for currentNoti={}","99JrxU"],t,e),this._closeNotiType("banner"));const s=Ct.default.getTimeNow(),a=this._getLastBannerNoti();if(e===Ur){const e=n.default.getInstance(),t=e.getItemForCurrentUser(kr.f),s=e.getItemForCurrentUser(kr.h),a=e.getItemForCurrentUser(kr.g);if(t){const s=J.p.getSessionUserId();Me.g.setEnableAutoDownload(s,t),e.removeItemForCurrentUser(kr.f)}if(s&&(Me.g.setSettingNotifyCall(s),e.removeItemForCurrentUser(kr.h)),a){const t="string"==typeof a&&["0","1"].includes(a)?+a:0,s=J.p.getSessionUserId();Nr.a.setEnabled(s,t),e.removeItemForCurrentUser(kr.g)}}if(!xr.includes(e))return void(kn.f[e]<kn.f[t.level]&&(a.level=e,a.ts=s,Re.default.setFullDiskChatBannerNoti(a)));if(!1===this._displayingNotiBanner&&e==Br)return this.Logger.zsymb(3,"pEpEl2",["Noti banner full (always)","5Z_ObK"]),void this._triggerDiskStatus(e,"banner");if(t&&t.level===e){if(this._displayingNotiBanner||!this._displayingNotiBanner&&t.dismiss&&Math.abs(s-t.ts)<Ce.default.full_disk_check.af2_banner_time_reshow_when_closed_ms)return void(this._displayingNotiBanner?this.Logger.zsymb(3,"mE2xF7",["Noti banner dismissed as level unchanged. already ON","YoYq2-"]):this.Logger.zsymb(3,"fyAKH9",["Noti banner dismissed as level unchanged. applying 1d-rule={}","9vHH4A"],!0));this.Logger.zsymb(3,"T63Z6o",["Noti banner passed. 1d-rule reset. dismiss reset","SnlJZ3"])}if(t&&t.level&&e&&t.dismiss&&kn.f[e]<kn.f[t.level]){if(a.dismiss&&Math.abs(s-t.ts)<Ce.default.full_disk_check.af2_banner_time_reshow_when_closed_ms)return this.Logger.zsymb(3,"cKhOVf",["Noti banner dismissed as downgrading emergency. applying 1d-rule={}","nsFXdw"],!0),a.ts=s,a.level=e,void Re.default.setFullDiskChatBannerNoti(a);if(this._displayingNotiBanner)return void this.Logger.zsymb(3,"nnKuQ3",["Noti banner: downgrading emergency. 1d-rule expired but already ON","8bG95v"]);this.Logger.zsymb(3,"FW-T7a",["Noti banner: downgrading emergency. 1d-rule expired. showing soon","mRyQoH"])}const i=n.default.getInstance(),r=i.getItemForCurrentUser(kr.d);e===Ur&&0===dn.a.block_usage.af2_banner_time_reshow_when_closed_ms&&r||(r&&i.removeItemForCurrentUser(kr.d),this._triggerDiskStatus(e,"banner",!0))},this._handleDiskStatusPopup=(e,t)=>{var s,a;const i=()=>{const e=K.default.getAllCurrentOpens();if(e.length>0){const t=e.filter((e=>e!=Ar.c));t.length>0&&t.forEach((e=>{Ie.ModalManagerV2.closeModal({windowId:e,name:Y.ModalIdentitiesDefine.BLANK_BACKGROUND_FULL_DISK})}))}};if(!Ce.default.full_disk_check.enable)return void i();if(this._displayingNotiPopup&&(!Vr.includes(e)||t&&t.level!==e)){this.Logger.zsymb(3,"Kac7wF",["Noti popup closed lastNoti={} prep for currentNoti={}","TV1UVp"],t,e),this._closeNotiType("popup");const s=kr.a[t.level];Ie.ModalManagerV2.closeModal({windowId:Ar.c,name:s})}if(e===Br&&!1===(null===(s=dn.a.block_usage)||void 0===s?void 0:s.full_enable_popup_and_block_app)||e===Ur&&!1===dn.a.block_usage.af2_enable_popup)return void i();const r=Ct.default.getTimeNow(),o=this._getLastPopupNoti();if(o.level!==e&&o.level==Br&&i(),!Vr.includes(e)){if(o.level!==e&&[Ur,Br].includes(o.level)){const e=kr.a[o.level];Ie.ModalManagerV2.closeModal({windowId:Ar.c,name:e})}kn.f[e]<kn.f[t.level]&&(o.level=e,o.ts=r,Re.default.setFullDiskChatPopupNoti(o));const s=n.default.getInstance(),a=s.getItemForCurrentUser(kr.f),i=s.getItemForCurrentUser(kr.h),c=s.getItemForCurrentUser(kr.g);if(a){const e=J.p.getSessionUserId();Me.g.setEnableAutoDownload(e,a),s.removeItemForCurrentUser(kr.f)}if(i&&(Me.g.setSettingNotifyCall(i),s.removeItemForCurrentUser(kr.h)),c){const e="string"==typeof c&&["0","1"].includes(c)?+c:0,t=J.p.getSessionUserId();Nr.a.setEnabled(t,e),s.removeItemForCurrentUser(kr.g)}return}if(e===Br&&e!==t.level){const t={ts:r,level:e,dismiss:!1};n.default.getInstance().setItemForCurrentUser(kr.b,JSON.stringify(t))}if(!1===this._displayingNotiPopup&&e==Br)return this.Logger.zsymb(3,"o5C_Rl",["Noti popup full (always)","Dc7NEt"]),void this._triggerDiskStatus(e,"popup");const c=n.default.getInstance(),l=c.getItemForCurrentUser(kr.e);if(t&&t.level===e&&"0"==l){var d;if(this._displayingNotiPopup||!this._displayingNotiPopup&&t.dismiss&&t.tsForceClose&&Math.abs(r-t.tsForceClose)<(null===(d=dn.a.block_usage)||void 0===d?void 0:d.af2_popup_time_reshow_when_closed_ms))return void(this._displayingNotiPopup?this.Logger.zsymb(3,"95g3XS",["Noti popup dismissed as level unchanged. already ON","SFNuq8"]):this.Logger.zsymb(3,"eMJGY9",["Noti popup dismissed as level unchanged. applying 7d-rule={}","aa-KzF"],!0));this.Logger.zsymb(3,"pJc8uA",["Noti popup passed. 7d-rule reset. dismiss reset","ellfZs"])}if(e&&e===Ur&&o.level!==e&&o.level===Br&&null!=o&&o.ts&&Math.abs(r-o.ts)<dn.a.block_usage.popup_type_change_noti_gap){this.Logger.zsymb(3,"xjiAba",["Noti popup upgrading. applying 1d-rule={}","dCN3M-"],!0);const t=kr.a[o.level];return Ie.ModalManagerV2.closeModal({windowId:Ar.c,name:t}),o.ts=r,o.level=e,o.dismiss=!0,Re.default.setFullDiskChatPopupNoti(o),void(this._displayingNotiPopup=!1)}if(e&&e!==Br){const t=n.default.getInstance().getItemForCurrentUser(kr.b),s=t?JSON.parse(t):null;if(s&&(null==s?void 0:s.level)===Br&&kn.f[e]<kn.f[null==s?void 0:s.level]&&Math.abs(r-s.ts)<dn.a.block_usage.popup_type_change_noti_gap){this.Logger.zsymb(3,"G3yYdF",["Noti popup downgrading. applying 1d-rule={}","leifxU"],!0);const t=kr.a[s.level];return Ie.ModalManagerV2.closeModal({windowId:Ar.c,name:t}),o.ts=r,o.level=e,o.dismiss=!0,Re.default.setFullDiskChatPopupNoti(o),void(this._displayingNotiPopup=!1)}}if(t&&t.level&&e&&t.dismiss&&kn.f[e]<kn.f[t.level]){if(o.level===Ur&&o.dismiss&&o.tsForceClose&&Math.abs(r-t.tsForceClose)<dn.a.block_usage.af2_popup_time_reshow_when_closed_ms&&"1"==l)return this.Logger.zsymb(3,"cKRh4E",["Noti popup dismissed as downgrading emergency. applying 7d-rule={}","b5pVah"],!0),o.ts=r,o.level=e,void Re.default.setFullDiskChatPopupNoti(o);if(this._displayingNotiPopup)return void this.Logger.zsymb(3,"erFRf1",["Noti popup: downgrading emergency. 7d-rule expired but already ON","puxQSe"]);this.Logger.zsymb(3,"0pZL8O",["Noti popup: downgrading emergency. 7d-rule expired. showing soon","HjT8Dm"])}e===Ur&&0===dn.a.block_usage.af2_popup_time_reshow_when_closed_ms&&"1"==l||e===Ur&&dn.a.block_usage.af2_popup_time_reshow_when_closed_ms&&"1"==l&&t.tsForceClose&&Math.abs(r-t.tsForceClose)<(null===(a=dn.a.block_usage)||void 0===a?void 0:a.af2_popup_time_reshow_when_closed_ms)||("1"==l&&c.removeItemForCurrentUser(kr.e),this._triggerDiskStatus(e,"popup",!0))},this._handleActionLogChangeStorageZone=(e,t)=>{if(null!=t&&t.level&&e!==t.level){a.ModuleContainer.resolve(Zi.a).changeStorageZone({currentStorageZone:e,previousStorageZone:t.level,tsInPreviousStorageZone:t.ts})}},this._dismissModal=()=>{this._closeNotiType("modal",!0)},this._listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents)},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents)},this._displayingNotiModal=!1,this._displayingNotiBanner=!1,this._displayingNotiPopup=!1,this.didLog_2230101=!1,this.Logger.zsymb(5,"MDJS_B",["DiskStatusManager init","2mk-Iu"]),this._cleanupEvents=this._cleanupEvents.bind(this)}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("disk-status",["status-manager"])),this._Logger}onStart(e){J.p.listenEvent(J.d,this._handleDiskStatus),Object(sn.f)(),J.p.listenEvent(J.o,this._osEventHandler),this._listenEvents(),a.ModuleContainer.resolve(Zi.a).startDiskStatusAutoReport(),a.ModuleContainer.resolve(Zi.a).startAutoReport()}dismissPopupNoti(e,t){if(!e)return this._closeNotiType("all");this._closeNotiType("popup",!0,t)}_getFullStatus(e,t){let s=Pr;if(e<Ce.default.full_disk_check.threadhold*zr){const a=dn.a.getOverrideCapacityStatus(),i=t/e;s=this._pickNormalizedStatus(i,a.dismiss_high,a.dismiss_low,a.dismiss_low_two)}else{const e=dn.a.getOverrideCapacityStatus(),a=t/zr,i=a>1?Math.round(10*a)/10*zr:t;s=this._pickNormalizedStatus(i,e.dismiss_high*zr,e.dismiss_low*zr,(e.dismiss_low_two||1)*zr)}return s}_showNotiType(e,t,s){if("modal"===e){this._displayingNotiModal&&this._closeNotiType("modal"),this._displayingNotiModal=!0;const a=this._getLastNoti();Re.default.setFullDiskNoti(Object(I.a)(Object(I.a)({},a),{},{dismiss:!(s||!a.dismiss)&&a.dismiss,level:t,ts:Ct.default.getTimeNow()}));const i=()=>{t===jr?Ia.default.logAction(2230707):t===Br&&Ia.default.logAction(2230712),this.openSetttings(kn.i.POPUP_MODAL)},n=()=>{t===jr?Ia.default.logAction(2230704):t===Br&&Ia.default.logAction(2230711),this._dismissModal()};let r;switch(t){case Pr:return void Tr.b.closeByKey("full-disk-noti-modal");case jr:Ia.default.logAction(2230102),r="STR_RESMGMT_MODAL_ALMOST_FULL";break;case Ur:return void Tr.b.closeByKey("full-disk-noti-modal");case Br:Ia.default.logAction(2230710),r="STR_RESMGMT_MODAL_FULL"}this.Logger.zsymb(5,"pUET8m",["Noti {} triggered","OaSsc7"],e,{level:kn.g[t],type:e},new Error);const o={type:Y.MINI_NOTIFICATION_TYPE.SUCCESS,duration:-1,key:"full-disk-noti-modal",html:Mr.a.createElement("div",{className:"flx flx-col"},Mr.a.createElement("div",{className:"flx flx-1 disk-waring-content"},Mr.a.createElement("div",{className:"fa fa-warning-24 disk-waring-icon"}),Mr.a.createElement("span",null,Mr.a.createElement(Rr.a,{textKey:r})," "),Mr.a.createElement("span",null)),Mr.a.createElement("div",{className:"flx flx-1 flx-e"},Mr.a.createElement(wr.a,{type:"neutral",onClick:n,size:"medium",style:{marginRight:"8px"}},Mr.a.createElement(Rr.a,{textKey:"STR_FILE_INTRO_POP_BTN_SKIP"})),Mr.a.createElement(wr.a,{type:"primary",onClick:i,size:"medium"},Mr.a.createElement(Rr.a,{textKey:"STR_MANAGE"}))))};Tr.b.show(o)}else if("banner"!==e||t!==Ur&&t!==Br){if("popup"===e&&(t===Ur||t===Br)){this.Logger.zsymb(5,"fjc9Xr",["Noti {} triggered","OaSsc7"],e,{level:kn.g[t],type:e},new Error),this._displayingNotiPopup=!0;const a=this._getLastPopupNoti();if(a.level!==t&&[Ur,Br].includes(a.level)){a.level===Ur&&(a.tsForceClose=Ct.default.getTimeNow());const e=kr.a[a.level];Ie.ModalManagerV2.closeModal({windowId:Ar.c,name:e})}if(a.level!==t&&a.level===Br){const e=n.default.getInstance(),t=e.getItemForCurrentUser(kr.f),s=e.getItemForCurrentUser(kr.h),a=e.getItemForCurrentUser(kr.g);if(t){const s=J.p.getSessionUserId();Me.g.setEnableAutoDownload(s,t),e.removeItemForCurrentUser(kr.f)}if(s&&(Me.g.setSettingNotifyCall(s),e.removeItemForCurrentUser(kr.h)),a){const t="string"==typeof a&&["0","1"].includes(a)?+a:0,s=J.p.getSessionUserId();Nr.a.setEnabled(s,t),e.removeItemForCurrentUser(kr.g)}}switch(a.dismiss=!(s||!a.dismiss)&&a.dismiss,a.level=t,a.ts=Ct.default.getTimeNow(),Re.default.setFullDiskChatPopupNoti(a),t){case Ur:Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.BLOCK_USAGE_ALMOST_FULL_DISK_MODAL,params:{isBlockUsageAlmostFullDiskModal:!0}});break;case Br:{const e=J.p.getSessionUserId(),t=Me.g.getEnableAutoDownload(e),s=Me.g.getSettingNotifyCall(),a=Nr.a.isEnabled(),i=n.default.getInstance();Boolean(i.getItemForCurrentUser(kr.f))||i.setItemForCurrentUser(kr.f,t),Boolean(i.getItemForCurrentUser(kr.h))||i.setItemForCurrentUser(kr.h,s),Boolean(i.getItemForCurrentUser(kr.g))||i.setItemForCurrentUser(kr.g,a?"1":"0"),Me.g.setEnableAutoDownload(e,!1),Me.g.setSettingNotifyCall(!1),Nr.a.setEnabled(e,0);const r=()=>{const e=K.default.getAllCurrentOpens();if(e.length>0){const t=e.filter((e=>e!=Ar.c));t.length>0&&t.forEach((e=>{Ie.ModalManagerV2.openModal({windowId:e,name:Y.ModalIdentitiesDefine.BLANK_BACKGROUND_FULL_DISK,params:{blankBackgroundFullDisk:!0}})}))}Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.BLOCK_USAGE_FULL_DISK_MODAL,params:{isBlockUsageFullDiskModal:!0}})},o=sessionStorage.getItem(kr.c);if(o&&Boolean(+o)){let e=setTimeout((()=>{const t=sessionStorage.getItem(kr.c);t&&Boolean(+t)?this._displayingNotiPopup=!1:(this._displayingNotiPopup=!0,r()),clearTimeout(e),e=null}),dn.a.block_usage.full_time_without_input_to_block_app_ms)}else r();break}}}}else{this.Logger.zsymb(5,"3GLDY4",["Noti {} triggered","OaSsc7"],e,{level:kn.g[t],type:e},new Error),this._broadcastEvent(Fn.ResDisk_Status,{level:t}),this._displayingNotiBanner=!0;const a=this._getLastBannerNoti();a.dismiss=!(s||!a.dismiss)&&a.dismiss,a.level=t,a.ts=Ct.default.getTimeNow(),Re.default.setFullDiskChatBannerNoti(a)}if([Ur,Br].includes(t)){const e=this._getLastBannerNoti();null!=e&&e.dismiss&&this._showNotiType("banner",t,!0)}}_pickNormalizedStatus(e,t,s,a){return e>t?Pr:e>=s?jr:e>=a?Ur:Br}_getLastNoti(){return Re.default.getFullDiskNoti()||{}}_closeNotiType(e="all",t=!1,s=!1){if(this.Logger.zsymb(5,"tO23XS",["Noti {} closed","r7Htzn"],e),"all"!==e&&"modal"!==e||!this._displayingNotiModal)if("banner"!==e&&"all"!==e||!this._displayingNotiBanner){if(("popup"===e||"all"===e)&&this._displayingNotiPopup){const e=this._getLastPopupNoti();if(this._displayingNotiPopup){const a=Object(I.a)(Object(I.a)({},e),{},{dismiss:e.dismiss||t,ts:Ct.default.getTimeNow()});s&&e.level===Ur&&(a.tsForceClose=Ct.default.getTimeNow()),Re.default.setFullDiskChatPopupNoti(a)}this._displayingNotiPopup=!1}}else{const e=this._getLastBannerNoti();this._displayingNotiBanner&&Re.default.setFullDiskChatBannerNoti(Object(I.a)(Object(I.a)({},e),{},{dismiss:e.dismiss||t,ts:Ct.default.getTimeNow()})),this._displayingNotiBanner=!1,this._broadcastEvent(Fn.ResNoti_Dimiss)}else{const e=this._getLastNoti(),s=Ct.default.getTimeNow();this.Logger.zsymb(5,"MKHsI0",["fdn close modal at: {}","UYmCsE"],new Date(s).toString()),this._displayingNotiModal&&Re.default.setFullDiskNoti(Object(I.a)(Object(I.a)({},e),{},{dismiss:e.dismiss||t,ts:s})),Tr.b.closeByKey("full-disk-noti-modal"),this._displayingNotiModal=!1}Dr.a.pause()}_getLastBannerNoti(){return Re.default.getFullDiskChatBannerNoti()||{}}_getLastPopupNoti(){return Re.default.getFullDiskChatPopupNoti()||{}}_triggerDiskStatus(e=Br,t="none",s=!1){if("none"!==t)if("banner"===t)this._showNotiType("banner",e,s);else if("modal"===t)switch(e){case Pr:this._closeNotiType("modal"),this._closeNotiType("banner");break;case Br:Ia.default.logActionInfo(Ia.FeaturesInfo.ResourceManagement,2,[this._total,0]),this._showNotiType("modal",e,s),this._showNotiType("banner",e,s);break;case jr:this._showNotiType("modal",e,s)}else if("popup"===t)switch(e){case Br:case Ur:this._showNotiType("popup",e,s)}}_broadcastEvent(e,t){switch(e){case Fn.ResDisk_Status:this.dispatchEvent(new En(e,t));break;case Fn.ResNoti_Dimiss:this.dispatchEvent(new On(e));break;case Fn.ResDisk_CurrentLevel:case Fn.ResDisk_Full_Disk_Status:this.dispatchEvent(new En(e,t))}}})||Er)||Er)||Er)||Er)||Er);var Hr,Wr=s("ZEj3"),qr=s("MGLS");Object(m.f)()(Hr=Object(xi.b)(qr.b)(Hr=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Hr=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(Hr=Reflect.metadata("design:type",Function)(Hr=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===m.a?Object:m.a])(Hr=class extends Wr.a{constructor(e,t){super(qr.a,"noti"),this.loggerFactory=e,this.application=t,this.logger=void 0,this.dismissReddot=()=>{const e=n.default.getInstance();this.shouldShowReddot()&&setTimeout((()=>{this.updateItem((e=>{e.dismissReddot=!0}),"dismissReddot"),e.setItemForCurrentUser(rn.c,JSON.stringify({dismiss:!0}))}),500)},this.shouldShowReddot=()=>{var e;const t=null===(e=this.data.get("showOverviewWarningIcon"))||void 0===e?void 0:e.showOverviewWarningIcon;if(!(t&&t!==kn.g.RICH_SPACE))return!1;const s=n.default.getInstance().getItemForCurrentUser(rn.c);if(!s)return!0;try{const e=JSON.parse(s);return!e||!e.dismiss}catch(a){return!0}},this.getWarningStatus=()=>{var e;return null===(e=this.data.get("showOverviewWarningIcon"))||void 0===e?void 0:e.showOverviewWarningIcon},this.checkShowReddot=()=>{this.Logger.zsymb(5,"rdlca_",["init","yig3kr"]);this.shouldShowReddot()?this.updateItem((e=>{e.dismissReddot=!1}),"dismissReddot"):this.updateItem((e=>{e.dismissReddot=!0}),"dismissReddot")},this._cleanupEvents=()=>{"render"===__ZaBUNDLENAME__&&(this.application.removeEventListener(m.b.Exit,this._cleanupEvents),me.a.DiskStatusManager.removeEventListener(Fn.ResDisk_Status,this._onDiskStatusChanged),me.a.DiskStatusManager.removeEventListener(Fn.ResNoti_Dimiss,this._onNotiDismiss))},this._listenEvents=()=>{"render"===__ZaBUNDLENAME__&&(this.application.addEventListener(m.b.Exit,this._cleanupEvents),me.a.DiskStatusManager.addEventListener(Fn.ResDisk_Status,this._onDiskStatusChanged),me.a.DiskStatusManager.addEventListener(Fn.ResNoti_Dimiss,this._onNotiDismiss),me.a.DiskStatusManager.addEventListener(Fn.ResDisk_CurrentLevel,this._onCurrentLevelChanged))},this._onCurrentLevelChanged=e=>{var t;(null==e||null===(t=e.payload)||void 0===t?void 0:t.level)!==kn.g.RICH_SPACE?this.updateItem((t=>{var s;t.showOverviewWarningIcon=null==e||null===(s=e.payload)||void 0===s?void 0:s.level}),"showOverviewWarningIcon"):this.updateItem((e=>{e.showOverviewWarningIcon=kn.g.RICH_SPACE}),"showOverviewWarningIcon"),this.checkShowReddot()},this._onNotiDismiss=()=>{this.updateItem((e=>{e.showFullDiskBanner={show:!1}}),"showFullDiskBanner")},this._onDiskStatusChanged=e=>{this.updateItem((t=>{const s=e.payload,a=(null==s?void 0:s.level)===kn.g.ALMOST_FULL_2||(null==s?void 0:s.level)===kn.g.FULL;t.showFullDiskBanner={show:a,level:null==s?void 0:s.level}}),"showFullDiskBanner")},this.logger=this.loggerFactory.createZLogger("resmgmt",[qr.a]),this._cleanupEvents=this._cleanupEvents.bind(this)}get Logger(){return this.logger||(this.logger=this.loggerFactory.createZLogger("resmgmt",[qr.a])),this.logger}onAuthenticated(e){this._listenEvents(),this.checkShowReddot()}dismissNoti(e){this.logger.zsymb(5,"ixfVx7",["Noti {} closed","r7Htzn"],e),me.a.DiskStatusManager.dismissNoti(e),Dr.a.pause()}dismissPopupNoti(e,t=!1){me.a.DiskStatusManager.dismissPopupNoti(e,t),Dr.a.pause()}openSettings(e){me.a.DiskStatusManager.openSetttings(e)}})||Hr)||Hr)||Hr)||Hr)||Hr);var Kr=s("FB77"),Zr=s("B5Cg");function $r(e,t){try{e()}catch(s){"function"==typeof t&&t(s)}}var Qr,Yr=s("d+hT"),Jr=s("OfK0"),Xr=s("+28p"),eo=s("Ldm7");const to=$znode.os,so=s("Dprd").default,ao="migrate-drive-status-key",io="is-scan-for-new-install",no=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.resMntScanResource,["res-controller"]);Object(a.injectable)()(Qr=Object(m.d)()(Qr=Object(xi.b)(an.b)(Qr=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(Qr=function(e,t){return a.ModuleContainer.inject(bn)(e,void 0,1)}(Qr=function(e,t){return a.ModuleContainer.inject(rr)(e,void 0,2)}(Qr=function(e,t){return a.ModuleContainer.inject(Cr)(e,void 0,3)}(Qr=function(e,t){return a.ModuleContainer.inject(_n)(e,void 0,4)}(Qr=Reflect.metadata("design:type",Function)(Qr=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===bn?Object:bn,void 0===rr?Object:rr,void 0===Cr?Object:Cr,void 0===_n?Object:_n])(Qr=class extends Wr.a{constructor(e,t,s,a,i){super(an.a,"view"),this.loggerFactory=e,this._resConvDataManager=t,this._resZaRFDataManager=s,this._resUnlistedDataManager=a,this._resConvFilterManager=i,this.logger=void 0,this._listeningEvents=!1,this._isMounted=!1,this._aborted=!1,this._abortQuickScan=!1,this._abortDBScan=!1,this._intervalOn=!1,this._calculating=!1,this._fastCalculating=!1,this._manualCalculating=!1,this._calculatingLog=!1,this._fastCalculatingLog=!1,this._isSetAutoRunOverviewCalculate=!1,this._timeToQuickScanComplete=0,this._timeToDBScanComplete=0,this._timeoutAutoScan=void 0,this._calcHistory=[],this._fastCalcHistory=[],this._calculateInterval=rn.a,this._rescanFastCalculate=rn.b,this._rescanCalculate=rn.b,this._onCalcDone=[],this.updateZaRFSize=e=>{this.updateItem((t=>{t.zaRFSize=e}),"zaRFSize")},this.getZaloUsage=()=>{const e=JSON.parse(ln.b.getOverviewPageData()),t=(null==e?void 0:e.zaloLocalSize)+(null==e?void 0:e.appDataSize)+(null==e?void 0:e.zaRFSize)+(null==e?void 0:e.zTempSize)+(null==e?void 0:e.zaloTempSize);return{total:t,zarf:null==e?void 0:e.zaRFSize,appDataSize:null==e?void 0:e.appDataSize,otherDataSize:t-(null==e?void 0:e.convDataSize)-(null==e?void 0:e.zaRFSize)-(null==e?void 0:e.otherAccountsSize)}},this.getZaloUsageForLog=()=>new Promise(((e,t)=>{this._resUnlistedDataManager.calculateZaloAppDataLog(!0,(t=>{var s,a,i,n,r,o,c,l;const d=t,u=(null===(s=this.data.get("zaloLocalSize"))||void 0===s?void 0:s.zaloLocalSize)||0,h=(null===(a=this.data.get("zaRFSize"))||void 0===a?void 0:a.zaRFSize)||0,g=(null===(i=this.data.get("otherAccountsSize"))||void 0===i?void 0:i.otherAccountsSize)||0,m=u+d+h+((null===(n=this.data.get("zTempSize"))||void 0===n?void 0:n.zTempSize)||0)+((null===(r=this.data.get("zaloTempSize"))||void 0===r?void 0:r.zaloTempSize)||0),p=(null===(o=this.data.get("convDataSize"))||void 0===o?void 0:o.convDataSize)||0,f=(null===(c=this.data.get("zaloCacheFoldersSize"))||void 0===c?void 0:c.zaloCacheFoldersSize)||0,v=(null===(l=this.data.get("zaloStickersSize"))||void 0===l?void 0:l.zaloStickersSize)||0;return e({total:m,zarf:h,appDataSize:d,otherDataSize:m-p-h-g,otherAccountsSize:g,convDataSize:p,zaloCacheFoldersSize:f,zaloStickersSize:v})}),void 0)})),this.deferredPromise=e=>{const t={};t.promise=new Promise(((s,a)=>{t.resolve=()=>{s(e())},t.reject=a}));const s=this._calcHistory.length&&this._calcHistory[this._calcHistory.length-1],a=setTimeout((()=>{this._calculating||this.calculate(kn.a.ROUTINE)}),2e4);return!s||s.status!==kn.b.COMPLETED&&(null==s?void 0:s.status)!==kn.b.ABORTED?this._onCalcDone.push(t.resolve):(t.resolve(),clearTimeout(a)),t.promise},this.getConvData=()=>this.deferredPromise((()=>{var e;return(null===(e=this.data.get("convData"))||void 0===e?void 0:e.convData)||0})),this.updateConvs=e=>{e=this._filterDuplicateConv(e);const t=(e=this._filterInvalidConv(e)).filter((e=>this._resConvDataManager.validateCalculateResult(null==e?void 0:e.amount)));this.updateItem((e=>{e.convs=t}),"convs"),t.length>0?(this._searchRelative(this._resConvFilterManager.getCurrentSearch()),this.updateItem((e=>{e.isConvDetailScanNull=!1}),"isConvDetailScanNull")):this.updateItem((e=>{e.isConvDetailScanNull=!0}),"isConvDetailScanNull")},this.updateConvsDataSize=e=>{let t=0;if("number"==typeof e)t=e;else if(e.length>0){var s;const a=this._resConvDataManager.calculateConvDataSize(e),i=(null===(s=this.data.get("isDeleteConvsStatus"))||void 0===s?void 0:s.isDeleteConvsStatus)||kn.e.NOT_YET;[kn.e.NOT_YET,kn.e.DONE_OR_ERROR].includes(i)&&(t=a)}this.updateItem((e=>{e.convDataSize=t}),"convDataSize")},this._updateZaloLocalSize=e=>{var t;const s=(null===(t=this.data.get("isDeleteConvsStatus"))||void 0===t?void 0:t.isDeleteConvsStatus)||kn.e.NOT_YET;[kn.e.NOT_YET,kn.e.DONE_OR_ERROR].includes(s)&&this.updateItem((t=>{t.zaloLocalSize=e}),"zaloLocalSize");const a=ln.b.getOverviewPageData();let i={};i=a?Object(I.a)(Object(I.a)({},JSON.parse(a)),{},{zaloLocalSize:e}):{zaloLocalSize:e},ln.b.setOverviewPageData(i)},this._updateAppDataSize=e=>{this.updateItem((t=>{t.appDataSize=e}),"appDataSize")},this._updateZaloDBSearchSize=e=>{this.updateItem((t=>{t.zaloDBSearchSize=e}),"zaloDBSearchSize")},this._updateOtherAccountSize=e=>{this.updateItem((t=>{t.otherAccountsSize=e.size}),"otherAccountsSize"),this.updateItem((t=>{t.noOtherAccounts=e.noOtherAccounts}),"noOtherAccounts"),this.updateItem((t=>{t.otherAccountsInfo=e.otherAccountsInfo}),"otherAccountsInfo");const t=ln.b.getOverviewPageData();let s={};s=t?Object(I.a)(Object(I.a)({},JSON.parse(t)),{},{otherAccountsSize:e.size,noOtherAccounts:e.noOtherAccounts,otherAccountsInfo:e.otherAccountsInfo}):{otherAccountsSize:e.size,noOtherAccounts:e.noOtherAccounts,otherAccountsInfo:e.otherAccountsInfo},ln.b.setOverviewPageData(s)},this._updatezTempSize=e=>{this.updateItem((t=>{t.zTempSize=e}),"zTempSize")},this._updateZaloTempSize=e=>{this.updateItem((t=>{t.zaloTempSize=e}),"zaloTempSize")},this._updateZaloCacheFolderSize=e=>{this.updateItem((t=>{t.zaloCacheFoldersSize=e}),"zaloCacheFoldersSize")},this._updateZaloStickerSize=e=>{this.updateItem((t=>{t.zaloStickersSize=e}),"zaloStickersSize")},this._handleSortFilterEventChange=e=>{switch(e.type){case Fn.ResConv_FilterSort_Status_Change:{var t;const s=e.payload;this.updateItem((e=>{e[s.type]=s.value}),s.type,s.ignoreRender||!1);if(!((null===(t=this.data.get("isConvDetailScanNull"))||void 0===t?void 0:t.isConvDetailScanNull)||!1))switch(s.type){case"filterBy":this._filterRelative(s.value);break;case"sortBy":this._sortRelative(s.value,null);break;case"searchBy":this._searchRelative(s.value);break;case"toggleHiddenBy":this._toggleHiddenConv(s.value)}break}}},this._handleCleanCacheFolderStatusChange=e=>{this.updateItem((t=>{t.cleanCacheFolderStatus=e.payload}),"cleanCacheFolderStatus")},this._handleCleanOtherAccountsStatusChange=e=>{this.updateItem((t=>{t.cleanOtherAccountsStatus=e.payload}),"cleanOtherAccountsStatus")},this._handleCalculationStatus=e=>{const t=e.payload;this.updateItem((e=>{var s;e[t.type]={status:t.status,progress:t.progress,hasCache:!0===(null===(s=e[t.type])||void 0===s?void 0:s.hasCache)||t.status===kn.n.IDLE}}),t.type)},this._handleManualFastCalculateStatus=e=>{this.updateItem((t=>{t.isManualFastCalculateStatus=e.payload}),"isManualFastCalculateStatus")},this._handleManualDetailCalculateStatus=e=>{this.updateItem((t=>{t.isManualDetailCalculateStatus=e.payload}),"isManualDetailCalculateStatus")},this._handleCalculateResourceWhenDeleteConvs=e=>{var t,s;const a=JSON.parse(ln.b.getOverviewPageData()),i=e.payload;let n=((null===(t=this.data.get("zaloLocalSize"))||void 0===t?void 0:t.zaloLocalSize)||0)-i;n<0&&(n=0),a.zaloLocalSize=n,this._updateZaloLocalSize(n);let r=((null===(s=this.data.get("convDataSize"))||void 0===s?void 0:s.convDataSize)||0)-i;r<0&&(r=0),a.convDataSize=r,a.time=Ct.default.getSystemTimeNow()||Date.now(),ln.b.setOverviewPageData(a),this.updateItem((e=>{e.convDataSize=r}),"convDataSize")},this._handleCalculateDeleteConvsStatus=e=>{this.updateItem((t=>{t.isDeleteConvsStatus=e.payload}),"isDeleteConvsStatus")},this._handleCalculateUpdateDetailPageCache=e=>{var t;let s=(null===(t=this.data.get("convs"))||void 0===t?void 0:t.convs)||[];s.length>0&&(s=this._filterDuplicateConv(s),s=this._filterInvalidConv(s));const a=e.payload.dataHiddenConversations,i=Ct.default.getSystemTimeNow()||Date.now();ln.b.setDetailPageData({time:i,convs:s,dataHiddenConversations:a})},this.logger=this.loggerFactory.createZLogger("resmgmt",["Controller"]),this.init()}onApplicationReady(){a.ModuleContainer.resolve(Xr.RRCController).addEventListener(Xr.RRCEvents.Success,(()=>{ln.b.setInfoForceScanByDeletingRedundantRes(`${kn.h.DELETED}`)})),this._handleRetryCleanLocalResourceFailed()}setSelectedConvs(e){this.updateItem((t=>{t.selectedConvs=e}),"selectedConvs")}hasCache(){return this._calcHistory.length>0&&this._calcHistory[this._calcHistory.length-1].status!==kn.b.CALCULATING}startCalcInterval(){this._intervalOn=!0}resetCalcInterval(){this._intervalOn=!1}setCalculateInterval(e){this._calculateInterval=e,this.updateItem((t=>{t.calculateInterval=e}),"calculateInterval")}getLastCalcTs(){return this._calcHistory.length>0?this._calcHistory[this._calcHistory.length-1].end:0}getCalcHistory(){return this._calcHistory.length>0?this._calcHistory:null}getCalculateInterval(){return this._calculateInterval}_setAllLocalToReady(){this.updateItem((e=>{e.zaloLocalStatus={status:kn.n.CALCULATING,hasCache:!0}}),"zaloLocalStatus"),this.updateItem((e=>{e.convDataOverviewStatus={status:kn.n.CALCULATING,hasCache:!0}}),"convDataOverviewStatus"),this.updateItem((e=>{e.zaRFStatus={status:kn.n.CALCULATING,hasCache:!0}}),"zaRFStatus"),this.updateItem((e=>{e.appDataStatus={status:kn.n.CALCULATING,hasCache:!0}}),"appDataStatus"),this.updateItem((e=>{e.otherAccountsStatus={status:kn.n.CALCULATING,hasCache:!0}}),"otherAccountsStatus"),this.updateItem((e=>{e.zTempStatus={status:kn.n.CALCULATING,hasCache:!0}}),"zTempStatus"),this.updateItem((e=>{e.zaloTempStatus={status:kn.n.CALCULATING,hasCache:!0}}),"zaloTempStatus"),this.updateItem((e=>{e.zaloCacheFolderStatus={status:kn.n.CALCULATING,hasCache:!0}}),"zaloCacheFolderStatus"),this.updateItem((e=>{e.zaloStickerStatus={status:kn.n.CALCULATING,hasCache:!0}}),"zaloStickerStatus")}_setAllLocalToIdle(){this.updateItem((e=>{e.zaloLocalStatus={status:kn.n.IDLE,hasCache:!0}}),"zaloLocalStatus"),this.updateItem((e=>{e.convDataOverviewStatus={status:kn.n.IDLE,hasCache:!0}}),"convDataOverviewStatus"),this.updateItem((e=>{e.zaRFStatus={status:kn.n.IDLE,hasCache:!0}}),"zaRFStatus"),this.updateItem((e=>{e.appDataStatus={status:kn.n.IDLE,hasCache:!0}}),"appDataStatus"),this.updateItem((e=>{e.otherAccountsStatus={status:kn.n.IDLE,hasCache:!0}}),"otherAccountsStatus"),this.updateItem((e=>{e.zTempStatus={status:kn.n.IDLE,hasCache:!0}}),"zTempStatus"),this.updateItem((e=>{e.zaloTempStatus={status:kn.n.IDLE,hasCache:!0}}),"zaloTempStatus"),this.updateItem((e=>{e.zaloCacheFolderStatus={status:kn.n.IDLE,hasCache:!0}}),"zaloCacheFolderStatus"),this.updateItem((e=>{e.zaloStickerStatus={status:kn.n.IDLE,hasCache:!0}}),"zaloStickerStatus")}async fastCalculate(e,t=!1){if(this._fastCalculating)return;this._timeToQuickScanComplete=0;const s=a.ModuleContainer.resolve(Zi.a),i=s.getTimeNow(),n=sn.a.analyzeMainDisk(),r=this._getPersistedOverviewData(),o=this._getPersistedDetailData(),c=this._getForceScanInfoByDeletingRedundantRes(),l=this.getMigrateDriveStatus(),d=Ct.default.getSystemTimeNow()||Date.now();if(e===kn.a.RESMGMT_TAB_MOUNTED){this._handleMountedTabFastCalculateLog(n,r,d,t,s);const e=Ce.default.newInstallSuccess,a=sessionStorage.getItem(io),i=ln.b.getLoginTimestamp();if(e&&!a)return null!=r&&r.time?this.performAutoRescan(r,t):this.manualCalculate(),void sessionStorage.setItem(io,"1");if(i)return null!=r&&r.time?this.performAutoRescan(r,t):this.manualCalculate(),void ln.b.removeLoginTimestamp()}if(c==kn.h.DELETED)return ln.b.setInfoForceScanByDeletingRedundantRes(`${kn.h.SCAN}`),void(null!=r&&r.time?this.performAutoRescan(r,t):this.manualCalculate());if(l===Jr.d.SUCCEED&&!sessionStorage.getItem(ao))return sessionStorage.setItem(ao,"1"),void this.performAutoRescan(r,t);if(!t&&null!=r&&r.time&&d-(null==r?void 0:r.time)>dn.a.resource_management.cache_valid_time)this.performAutoRescan(r,t);else if(!t&&null!=o&&o.time&&d-(null==o?void 0:o.time)>dn.a.resource_management.cache_valid_time&&(this._updateDetailDataWhenAutoRecalculate(),this.updateItem((e=>{e.isManualDetailCalculateStatus=!0}),"isManualDetailCalculateStatus"),this._abortDBScan=!1,this.calculate(e,!0)),this._isMounted=!0,this._listeningEvents||this._listenEvents(),!t&&null!=r&&r.time&&d-(null==r?void 0:r.time)<=dn.a.resource_management.cache_valid_time)this._useCacheToDisplayOverviewPage(r,e,d);else{this._fastCalculating=!0;try{await this._startAllFastCalculate(t,e)}catch(u){this.logger.zsymb(21,"gFAUXf",["Error estimating resources","G77uxU"],u)}this._fastCalculating=!1,this._onCalcDone.forEach((e=>$r(e))),this._onCalcDone.splice(0,this._onCalcDone.length),this._fastCalculating||this._fastCalculatingLog||!dn.a.resource_management.enable_partial_stat||this._abortQuickScan||await this._logFastCalculateResult(e,s,i)}}_handleRetryCleanLocalResourceFailed(){let e=ln.b.getAllFailedLocalResourceRemovals();e.length>0&&setTimeout((async()=>{for(let t=0;t<e.length;t++)so.fileExistSync(e[t].path)&&(await so.deleteFolder(e[t].path),e[t].isDeleted=!0);e=e.filter((e=>!(null!=e&&e.isDeleted))),e.length>0?ln.b.setForceInfoRemoveLocalResourceFailed(e):ln.b.removeInfoRemoveLocalResourceFailed()}),dn.a.resource_management.force_delete_local_failed_delay)}_getPersistedOverviewData(){return JSON.parse(ln.b.getOverviewPageData())}_getPersistedDetailData(){return JSON.parse(ln.b.getDetailPageData())}_getForceScanInfoByDeletingRedundantRes(){return JSON.parse(ln.b.getInfoForceScanByDeletingRedundantRes())}getMigrateDriveStatus(){return Jr.d.NULL}_determineScanStatusForMountedTabFastCalculateLog(e,t,s){if(!s){if(null!=e&&e.time&&t-(null==e?void 0:e.time)<=dn.a.resource_management.cache_valid_time){var a,i;const e=(null===(a=this.data.get("isManualDetailCalculateStatus"))||void 0===a?void 0:a.isManualDetailCalculateStatus)||!1,t=(null===(i=this.data.get("isManualFastCalculateStatus"))||void 0===i?void 0:i.isManualFastCalculateStatus)||!1;return this._fastCalculating||t?Ji.ContinueQuickScan:this._calculating||e?Ji.ContinueDBScan:Ji.CacheValid}return Ji.StartNewScanWithCache}return e&&null!=e&&e.time&&t-(null==e?void 0:e.time)>dn.a.resource_management.cache_valid_time?Ji.StartNewScanWithCache:Ji.StartNewScanWithoutCache}_handleMountedTabFastCalculateLog(e,t,s,a,i){e&&i.diskStatusReport({scan_event:i.getScanType().UserManual,ts:i.getTimeNow(),total:e.total,free:e.free});const n=this._determineScanStatusForMountedTabFastCalculateLog(t,s,a);i.timeGoToSMReport(n)}_updateAllSizeForOverviewPage(e){this._updateZaloLocalSize(e.zaloLocalSize),this.updateConvsDataSize(e.convDataSize),this.updateZaRFSize(e.zaRFSize),this._updateAppDataSize(e.appDataSize),this._updateZaloDBSearchSize(e.zaloDBSearchSize),this._updateOtherAccountSize({size:e.otherAccountsSize,noOtherAccounts:null==e?void 0:e.noOtherAccounts,otherAccountsInfo:null==e?void 0:e.otherAccountsInfo}),this._updatezTempSize(e.zTempSize),this._updateZaloTempSize(e.zaloTempSize),e.zaloCacheFoldersSize&&this._updateZaloCacheFolderSize(e.zaloCacheFoldersSize),e.zaloStickersSize&&this._updateZaloStickerSize(e.zaloStickersSize)}performAutoRescan(e,t){if(!t&&null!=e&&e.time)return this._updateAllSizeForOverviewPage(e),this._updateDetailDataWhenAutoRecalculate(),this._setAllLocalToReady(),void this.manualCalculate()}async _logFastCalculateResult(e,t,s){var a;this._fastCalculatingLog=!0;const i=e===kn.a.CLEAN_CACHE_OR_OTHER_ACCOUNTS?t.getScanType().ReScanByCleanCacheOrOtherAccounts:t.getScanType().Partial,n=sn.a.analyzeMainDisk();this._timeToQuickScanComplete=t.getTimeNow()-s,t.timeFinishedScanReport({scanEvent:i,timeToDBScanComplete:this._timeToDBScanComplete,timeToQuickScanComplete:this._timeToQuickScanComplete}),dn.a.resource_management.enable_calculate_ztemp&&dn.a.resource_management.enable_calculate_zalo_temp&&await this.scanZtempZaloTemp();const r=this.getZaloUsage();t.zaloUsageReport({scan_event:i,ts:t.getTimeNow(),used:r.total,free:null!==(a=null==n?void 0:n.free)&&void 0!==a?a:-1}),t.cacheReport({scan_event:i}),this._fastCalculatingLog=!1}_useCacheToDisplayOverviewPage(e,t,s){if(no.zsymb(0,"haefdG","[RES-MNT] Quick scan - get cache to display"),this._updateAllSizeForOverviewPage(e),this._abortDBScan=!1,this.calculate(t),this.updateItem((t=>{t.lastCalcOverview=e.time}),"lastCalcOverview"),this._setAllLocalToIdle(),!this._isSetAutoRunOverviewCalculate){const t=(null==e?void 0:e.time)+dn.a.resource_management.cache_valid_time-s;this._isSetAutoRunOverviewCalculate=!0,this._timeoutAutoScan=setTimeout((()=>{this._isSetAutoRunOverviewCalculate=!1,no.zsymb(0,"oKLNL1","[RES-MNT] Start Manual Scan from Quick Scan interval"),this.manualCalculate()}),t)}}_filterDuplicateConv(e){const t=new Set;return e.filter((e=>!t.has(e.userId)&&(t.add(e.userId),!0)))}async calculate(e,t=!1,s=!1){if(this._abortDBScan)return;this._isMounted=!0,this._listeningEvents||this._listenEvents();const i=JSON.parse(ln.b.getDetailPageData()),n=Ct.default.getSystemTimeNow()||Date.now();if(this._timeToDBScanComplete=0,this._calculating)return;if(!t&&null!=i&&i.time&&n-(null==i?void 0:i.time)<=dn.a.resource_management.cache_valid_time){no.zsymb(0,"wTT9JW","[RES-MNT] DB scan - get cache to displayy"),i.convs=i.convs.filter((e=>null!==e));const e=this._filterDuplicateConv(i.convs);i.dataHiddenConversations=i.dataHiddenConversations.filter((e=>null!==e));const t=this._filterDuplicateConv(i.dataHiddenConversations);return this._resConvDataManager.setForceConvData(e),this._resConvDataManager.setForceConvHiddenData(t),this.updateConvs(e),void this.updateItem((e=>{e.convDataStatus={status:kn.n.IDLE,hasCache:!0}}),"convDataStatus")}this._calculating=!0;const r=a.ModuleContainer.resolve(Zi.a),o=sn.a.analyzeMainDisk(),c=r.getTimeNow();try{await this._startAllCalculators(e,t)}catch(d){this.logger.zsymb(21,"1uKDrg",["Error estimating resources","G77uxU"],d)}if(this._calculating=!1,this._onCalcDone.forEach((e=>$r(e))),this._onCalcDone.splice(0,this._onCalcDone.length),!(e!==kn.a.RESMGMT_TAB_MOUNTED&&e!==kn.a.ROUTINE&&e!==kn.a.MANUAL||this._calculatingLog||this._calculating||this._abortDBScan)){var l;this._calculatingLog=!0;const t=a.ModuleContainer.resolve(Zi.a),s=e===kn.a.RESMGMT_TAB_MOUNTED||e===kn.a.MANUAL?t.getScanType().UserManual:t.getScanType().Routine;this._timeToDBScanComplete=t.getTimeNow()-c,t.timeFinishedScanReport({scanEvent:s,timeToDBScanComplete:this._timeToDBScanComplete,timeToQuickScanComplete:this._timeToQuickScanComplete});const i=this.getZaloUsage();t.zaloUsageReport({scan_event:s,ts:t.getTimeNow(),used:i.total,free:null!==(l=null==o?void 0:o.free)&&void 0!==l?l:-1}),t.cacheReport({scan_event:s}),this._calculatingLog=!1}}async manualCalculate(e=kn.a.MANUAL){this._isMounted=!0,this._listeningEvents||this._listenEvents(),this._manualCalculating=!0,this._abortQuickScan=!1,this._abortDBScan=!1,this._cancelAllOverviewCalculations(),this._resZaRFDataManager.reset(),no.zsymb(0,"Hhn1La","[RES-MNT] Start Manual Scan"),this.updateItem((e=>{e.isDoneCalculate=!1}),"isDoneCalculate"),this.updateItem((e=>{e.isManualFastCalculateStatus=!0}),"isManualFastCalculateStatus"),this.updateItem((e=>{e.convDataOverviewStatus={status:kn.n.IDLE,hasCache:!0}}),"convDataOverviewStatus"),this._calculating||(this.updateItem((e=>{e.isManualDetailCalculateStatus=!0}),"isManualDetailCalculateStatus"),this.updateItem((e=>{e.convDataStatus={status:kn.n.CALCULATING,progress:1,hasCache:!0}}),"convDataStatus")),no.zsymb(0,"-Xqptj","[RES-MNT] Start quick scan in manual scan"),await this.fastCalculate(e,!0),no.zsymb(0,"DNNo9W","[RES-MNT] Manual scan - done... Bye Bye QC"),this._manualCalculating=!1}async scanZtempZaloTemp(){try{await sn.a.scanZtempZaloTemp()}catch(e){this.logger.zsymb(21,"CcvpO5",["Error estimating resources","G77uxU"],e)}}init(){this.updateItem((e=>{e.view=Kr.a.OVERVIEW,e.theme=Zr.e.LIGHT}),"view",!0),this.updateItem((e=>{e.sortBy=kn.l.DECREASE_CAPACITY}),"sortBy",!0),this.updateItem((e=>{e.filterBy=kn.k.ALL}),"filterBy",!0),this.updateItem((e=>{e.currentDisk="C:"}),"currentDisk",!0),this.updateItem((e=>{e.calculateInterval=this._calculateInterval}),"calculateInterval",!0),this.updateItem((e=>{e.selectedConvs={}}),"selectedConvs",!0),this.updateItem((e=>{e.searchBy=""}),"searchBy",!0),this.updateItem((e=>{e.toggleHiddenBy=!1}),"toggleHiddenBy",!0),this.updateItem((e=>{e.isCheckHiddenConversation=!1}),"isCheckHiddenConversation",!0),this.updateItem((e=>{e.isDeleteConvsStatus=kn.e.NOT_YET}),"isDeleteConvsStatus",!0),this._listenEvents()}resetStates(){this.updateItem((e=>{e.view=Kr.a.OVERVIEW}),"view",!0),this._timeoutAutoScan&&clearTimeout(this._timeoutAutoScan)}resetFirstTimeToggleHiddenConvsState(){this.changeDataFirstTimeToggleHiddenConvs(!1)}resetAll(){this.resetCalcInterval();const e=a.ModuleContainer.resolve(_n);this.updateItem((e=>{e.isCheckHiddenConversation=!1}),"isCheckHiddenConversation"),e.resetDefault(),this.updateItem((e=>{e.selectedConvs={}}),"selectedConvs")}updateView(e){this.updateItem((t=>{t.view=e}),"view")}abort(){this._isMounted=!1,this._fastCalculating=!1,this._abortQuickScan=!0,this._abortDBScan=!0,this._calculating=!1,this._calcHistory=[],this._fastCalcHistory=[],this._cancelAllCalculations(),this.updateItem((e=>{e.isManualDetailCalculateStatus=!1}),"isManualDetailCalculateStatus"),this._cleanupListeners()}resetSort(){this._resConvFilterManager.sort(kn.l.DECREASE_CAPACITY)}sort(e){switch(e){case kn.l.DECREASE_CAPACITY:Ia.default.logAction(2230601);break;case kn.l.INCREASE_LAST_UPDATE:Ia.default.logAction(2230605);break;case kn.l.DECREASE_LAST_UPDATE:Ia.default.logAction(2230607)}this._resConvFilterManager.getCurrentSort()!==e&&this._resConvFilterManager.sort(e)}filter(e){switch(e){case kn.k.ALL:Ia.default.logAction(2230801);break;case kn.k.FILTER_GROUP_CONVS:Ia.default.logAction(2230802);break;case kn.k.FILTER_SINGLE_CHAT_CONVS:Ia.default.logAction(2230803);break;case kn.k.FILTER_OTHER_CONVS:Ia.default.logAction(2230804)}this._resConvFilterManager.getCurrentFilter()!==e&&this._resConvFilterManager.filter(e)}search(e){this._resConvFilterManager.getCurrentSearch()!==e&&this._resConvFilterManager.search(e)}toggleHidden(e){this._resConvFilterManager.toggleHidden(e)}changeDataToggleHidden(e){this.updateItem((t=>{t.isCheckHiddenConversation=e}),"isCheckHiddenConversation",!1)}changeDataFirstTimeToggleHiddenConvs(e){this.updateItem((t=>{t.isFirstTimeToggleHiddenConvs=e}),"isFirstTimeToggleHiddenConvs",!1)}isCurrentSort(e){var t;return(null===(t=this.data.get("sortBy"))||void 0===t?void 0:t.sortBy)===e}isCurrentFiler(e){var t;return(null===(t=this.data.get("filterBy"))||void 0===t?void 0:t.filterBy)===e}changeTheme(e){return Promise.resolve()}openZaRF(){Object(sn.e)()}async onDelete(e,t={photo:!0,video:!0,file:!0},s){var i;switch(this._resConvFilterManager.getCurrentFilter()){case kn.k.FILTER_GROUP_CONVS:Ia.default.logAction(2230805);break;case kn.k.FILTER_GROUP_CONVS:Ia.default.logAction(2230806);break;case kn.k.FILTER_SINGLE_CHAT_CONVS:Ia.default.logAction(2230807);break;case kn.k.FILTER_OTHER_CONVS:Ia.default.logAction(2230808)}let n=null!=s?s:0;if(!s){const s=sessionStorage.getItem(Bn);s?(n=+s,sessionStorage.removeItem(Bn)):n=this._resConvDataManager.calculateConvDataSizeByIds(e,t)}const r=sn.a.analyzeMainDisk(),o=a.ModuleContainer.resolve(Zi.a);let c="";c="Mac",await o.logAction999({type:"DeleteConv",deleted_count:e.length,deleted_size:n,target:Object(I.a)({},t),free:null!==(i=null==r?void 0:r.free)&&void 0!==i?i:-1,current_disk:c}),await this._resConvDataManager.onDelete(e,t)}onUpdateDataBeforeDelete(e,t){this._resConvDataManager.onUpdateDataBeforeDelete(e,t)}abortTasks(){this._aborted=!0,this.logger.zsymb(0,"Ru5Fno","abort calc tasks"),me.a.ResCacheManager.revokeCache()}async _startAllFastCalculate(e,t){this._resConvDataManager.setResCalculateStatus(kn.m.START_CALCULATE);const s=this._fastCalcHistory.length&&this._fastCalcHistory[this._fastCalcHistory.length-1];return Object(sn.d)()?s&&s.status===kn.b.CALCULATING?(this.logger.zsymb(3,"jQ30Fr",["recalculateResource is called too frequently. now:{} last:{}","und6R7"],Date.now(),this.getLastCalcTs()),this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve(!0)):!e&&s&&this._hasLastFastScanRequestExpired()?(this.updateItem((e=>{e.convDataOverviewStatus={status:kn.n.IDLE,hasCache:!0}}),"convDataOverviewStatus"),this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve(!0)):this._systemUsageInfo().then((e=>e.cpu>=Ce.default.full_disk_check.high_cpu||Ce.default.full_disk_check.high_mem?(this.logger.zsymb(3,"tMguDm",["CPU or MEM usage is too high. No calculation will be postponed","yDwNbm"]),this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve()):(this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve()))).then((async()=>{let a=!0;this._aborted=!1,no.zsymb(0,"0uoYJo","[RES-MNT] Quick scan - start...");const i={start:Date.now(),end:-1,status:kn.b.CALCULATING};this._fastCalcHistory.push(i),this.updateItem((e=>{var t;e.convDataOverviewStatus={status:kn.n.CALCULATING,progress:1,hasCache:!0===(null===(t=e.convDataOverviewStatus)||void 0===t?void 0:t.hasCache)}}),"convDataOverviewStatus");const n=[];return dn.a.resource_management.enable_calculate_ztemp&&n.push(this._resUnlistedDataManager.calculatezTemp(a,this._updatezTempSize)),dn.a.resource_management.enable_calculate_zalo_temp&&n.push(this._resUnlistedDataManager.calculateZaloTemp(a,this._updateZaloTempSize)),(dn.a.resource_management.enable_calculate_zrf||dn.a.resource_management.enable_calculate_zrf_without_display)&&n.push(this._resZaRFDataManager.start(a,this.updateZaRFSize)),n.push(this._resUnlistedDataManager.calculateZaloAppData(a,this._updateAppDataSize)),n.push(this._resUnlistedDataManager.calculateZaloDBSearch(a,this._updateZaloDBSearchSize)),dn.a.resource_management.enable_calculate_sticker_as_cache?n.push(this._resUnlistedDataManager.calculateSticker(a,e,this._updateZaloStickerSize)):this._updateZaloStickerSize(0),await this._resUnlistedDataManager.calculateOtherAccounts(a,e,this._updateOtherAccountSize),await this._resUnlistedDataManager.calculateZaloLocal(a,e,this._updateZaloLocalSize),await this._resUnlistedDataManager.calculateCacheFolder(a,e,this._updateZaloCacheFolderSize),this._resConvDataManager.fastStart(a,e,this.updateConvsDataSize).then((()=>(this._calculating||(no.zsymb(0,"y_4FcC","[RES-MNT] Start db scan in manual scan"),this.calculate(t,e)),Promise.all(n).then((()=>{if(this._aborted?(me.a.ResCacheManager.revokeCache(),i.status=kn.b.ABORTED):(i.status=kn.b.COMPLETED,me.a.ResCacheManager.signCache()),i.end=Date.now(),i.status===kn.b.COMPLETED){setTimeout((()=>{this.persistDataToCache()}),500),no.zsymb(0,"tClVcx","[RES-MNT] Quick scan - done... Bye Bye QC");JSON.parse(ln.b.getInfoForceScanByDeletingRedundantRes())&&ln.b.removeInfoForceScanByDeletingRedundantRes(),this.updateItem((e=>{e.isDoneCalculate=!0}),"isDoneCalculate"),this.updateItem((e=>{e.lastCalc=i.end}),"lastCalc"),s&&!e||this.updateItem((e=>{e.lastCalcOverview=i.end}),"lastCalcOverview")}})))))})):(this.logger.zsymb(3,"g8WvoT",["Full disk check is disabled. No calculation will be performed","siVqjK"]),Promise.resolve(!0))}persistDataToCache(){var e,t,s,a,i,n,r,o,c,l,d,u;const h=(null===(e=this.data.get("convDataSize"))||void 0===e?void 0:e.convDataSize)||0,g=(null===(t=this.data.get("zaRFSize"))||void 0===t?void 0:t.zaRFSize)||0,m=(null===(s=this.data.get("zaloLocalSize"))||void 0===s?void 0:s.zaloLocalSize)||0,p=(null===(a=this.data.get("zTempSize"))||void 0===a?void 0:a.zTempSize)||0,f=(null===(i=this.data.get("zaloTempSize"))||void 0===i?void 0:i.zaloTempSize)||0,v=(null===(n=this.data.get("appDataSize"))||void 0===n?void 0:n.appDataSize)||0,_=(null===(r=this.data.get("otherAccountsSize"))||void 0===r?void 0:r.otherAccountsSize)||0,b=(null===(o=this.data.get("zaloDBSearchSize"))||void 0===o?void 0:o.zaloDBSearchSize)||0,I=(null===(c=this.data.get("zaloCacheFoldersSize"))||void 0===c?void 0:c.zaloCacheFoldersSize)||0,y=(null===(l=this.data.get("zaloStickersSize"))||void 0===l?void 0:l.zaloStickersSize)||0,S=(null===(d=this.data.get("noOtherAccounts"))||void 0===d?void 0:d.noOtherAccounts)||0,C=(null===(u=this.data.get("otherAccountsInfo"))||void 0===u?void 0:u.otherAccountsInfo)||[],E={time:Ct.default.getSystemTimeNow()||Date.now(),convDataSize:h,zaRFSize:g,zaloLocalSize:m,zTempSize:p,zaloTempSize:f,appDataSize:v,otherAccountsSize:_,zaloDBSearchSize:b,zaloCacheFoldersSize:I,zaloStickersSize:y,noOtherAccounts:S,otherAccountsInfo:C};ln.b.setOverviewPageData(E),this._isSetAutoRunOverviewCalculate||(this._isSetAutoRunOverviewCalculate=!0,this._timeoutAutoScan=setTimeout((()=>{this._isSetAutoRunOverviewCalculate=!1,this.manualCalculate()}),dn.a.resource_management.cache_valid_time))}setConvToHidden(e,t,s=!1){this._resConvDataManager.setConvToHidden(e,t,s)}removeConvToList(e){this._resConvDataManager.removeConvToList(e)}async clearCacheData(e,t){await this._resUnlistedDataManager.clearCacheData(e,t)}async clearOtherAccountsData(){await this._resUnlistedDataManager.clearOtherAccountsData()}handleAfterClearCacheData(){var e;const t=(null===(e=this.data.get("cleanCacheFolderStatus"))||void 0===e?void 0:e.cleanCacheFolderStatus)||{};(null==t?void 0:t.status)===kn.c.IDLE?(Ia.default.logAction(eo.f),this.manualCalculate(kn.a.CLEAN_CACHE_OR_OTHER_ACCOUNTS),be.default.show({noBackground:!0,text:ce.a.str("STR_RESMGMT_CLEAN_CACHE_SUCCESS"),type:be.TOAST_TYPE.SUCCESS,duration:1500})):(null==t?void 0:t.status)===kn.c.ERROR&&(Ia.default.logAction(eo.e),be.default.show({noBackground:!0,text:ce.a.str("STR_RESMGMT_CLEAN_CACHE_FAIL"),type:be.TOAST_TYPE.ERROR,duration:1500}))}handleAfterClearOtherAccountsData(){var e;const t=(null===(e=this.data.get("cleanOtherAccountsStatus"))||void 0===e?void 0:e.cleanOtherAccountsStatus)||{};(null==t?void 0:t.status)===kn.d.IDLE?(Ia.default.logAction(eo.h),this.manualCalculate(kn.a.CLEAN_CACHE_OR_OTHER_ACCOUNTS),be.default.show({noBackground:!0,text:ce.a.str("STR_RESMGMT_CLEAR_OTHER_ACCOUNTS_SUCCESS"),type:be.TOAST_TYPE.SUCCESS,duration:1500})):(null==t?void 0:t.status)===kn.d.ERROR&&(Ia.default.logAction(eo.g),be.default.show({noBackground:!0,text:ce.a.str("STR_RESMGMT_CLEAR_OTHER_ACCOUNTS_FAIL"),type:be.TOAST_TYPE.ERROR,duration:1500})),Ie.ModalManagerV2.closeModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.RES_MNT_CLEAR_OTHER_ACCOUNTS_MODAL})}_updateDetailDataWhenAutoRecalculate(){var e;const t=JSON.parse(ln.b.getDetailPageData());if(!t||null==t||!t.convs)return;t.convs=t.convs.filter((e=>null!==e));const s=this._filterDuplicateConv(t.convs);t.dataHiddenConversations=t.dataHiddenConversations.filter((e=>null!==e));const a=this._filterDuplicateConv(t.dataHiddenConversations);this._resConvDataManager.setForceConvData(s),this._resConvDataManager.setForceConvHiddenData(a),this.updateConvs(s);const i=(null===(e=this.data.get("convDataStatus"))||void 0===e?void 0:e.convDataStatus)||{progress:1},n=null==i?void 0:i.progress;this.updateItem((e=>{e.convDataStatus={status:kn.n.CALCULATING,progress:n,hasCache:!0}}),"convDataStatus")}async _startAllCalculators(e,t){this._resConvDataManager.setResCalculateStatus(kn.m.START_CALCULATE);const s=this._calcHistory.length&&this._calcHistory[this._calcHistory.length-1];return Object(sn.d)()?s&&s.status===kn.b.CALCULATING?(this.logger.zsymb(3,"VJE2di",["recalculateResource is called too frequently. now:{} last:{}","und6R7"],Date.now(),this.getLastCalcTs()),this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve(!0)):!t&&s&&this._hasLastScanRequestExpired()?(this.updateItem((e=>{e.convDataStatus={status:kn.n.IDLE,hasCache:!0}}),"convDataStatus"),this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve(!0)):this._systemUsageInfo().then((e=>e.cpu>=Ce.default.full_disk_check.high_cpu||Ce.default.full_disk_check.high_mem?(this.logger.zsymb(3,"-OFx1-",["CPU or MEM usage is too high. No calculation will be postponed","yDwNbm"]),this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve()):(this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve()))).then((()=>{this._aborted=!1,no.zsymb(0,"m2grXn","[RES-MNT] DB scan - start...");const e={start:Date.now(),end:-1,status:kn.b.CALCULATING};return this._calcHistory.push(e),this._resConvDataManager.start(!0,t,this.updateConvs).finally((()=>{this._aborted?(me.a.ResCacheManager.revokeCache(),e.status=kn.b.ABORTED):(e.status=kn.b.COMPLETED,me.a.ResCacheManager.signCache()),e.end=Date.now(),e.status===kn.b.COMPLETED&&(no.zsymb(0,"IAy7xm","[RES-MNT]  scan - done... Bye Bye QC"),this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),this.updateItem((t=>{t.lastCalc=e.end}),"lastCalc"))}))})):(this.logger.zsymb(3,"fO-pli",["Full disk check is disabled. No calculation will be performed","siVqjK"]),this._resConvDataManager.setResCalculateStatus(kn.m.FINISH_CALCULATE),Promise.resolve(!0))}async _sortRelative(e,t){let s=[];if(t)s=t;else{var a,i;s=((null===(a=this.data.get("convs"))||void 0===a?void 0:a.convs)||this._resConvDataManager.getConvs()).filter((e=>!In.a.isThreadHidden(e.userId)));const e=this._resConvDataManager.getConvHiddenData()||[],t=null===(i=this.data.get("toggleHiddenBy"))||void 0===i?void 0:i.toggleHiddenBy;e.length>0&&t&&(s=[...s,...e])}switch(e){case kn.l.DECREASE_CAPACITY:s=s.slice().sort(((e,t)=>t.amount.videosSize+t.amount.imagesSize+t.amount.filesSize-e.amount.videosSize-e.amount.imagesSize-e.amount.filesSize));break;case kn.l.INCREASE_LAST_UPDATE:case kn.l.DECREASE_LAST_UPDATE:s=s.slice().sort(((t,s)=>{const a=s.lastMsgTime-t.lastMsgTime;return e===kn.l.DECREASE_LAST_UPDATE?a:-a}))}s=this._filterDuplicateConv(s),s=this._filterInvalidConv(s),this.updateItem((e=>{e.convs=s}),"convs")}_filterInvalidConv(e){return e.filter((e=>"number"==typeof e.amount.videosSize&&"number"==typeof e.amount.imagesSize&&"number"==typeof e.amount.filesSize&&!(e.amount.videosSize+e.amount.imagesSize+e.amount.filesSize<=0)))}_filterRelative(e){var t;let s=(this._resConvDataManager.getConvs()||[]).filter((e=>!In.a.isThreadHidden(e.userId)));const a=this._resConvDataManager.getConvHiddenData()||[],i=null===(t=this.data.get("toggleHiddenBy"))||void 0===t?void 0:t.toggleHiddenBy;switch(a.length>0&&i&&(s=[...s,...a]),e){case kn.k.ALL:s=this._resConvDataManager.getConvs();break;case kn.k.FILTER_SINGLE_CHAT_CONVS:s=s.filter((e=>!this._resConvDataManager.isGroup(e.userId)&&!this._resConvDataManager.isOA(e.userId)||this._resConvDataManager.isMyCloud(e.userId)));break;case kn.k.FILTER_GROUP_CONVS:s=s.filter((e=>this._resConvDataManager.isGroup(e.userId)&&!this._resConvDataManager.isOA(e.userId)&&!this._resConvDataManager.isMyCloud(e.userId)));break;case kn.k.FILTER_OTHER_CONVS:s=s.filter((e=>this._resConvDataManager.isOA(e.userId)&&!this._resConvDataManager.isMyCloud(e.userId)))}this._sortRelative(this._resConvFilterManager.getCurrentSort(),s)}async _searchRelative(e){var t,s;const a=JSON.parse(ln.b.getDetailPageData());let i=((null===(t=this.data.get("convs"))||void 0===t?void 0:t.convs)||this._resConvDataManager.getConvs()).filter((e=>!In.a.isThreadHidden(e.userId)));0===i.length&&(null==a?void 0:a.convs.length)>0&&(i=a.convs);const n=this._resConvDataManager.getConvHiddenData()||[],r=null===(s=this.data.get("toggleHiddenBy"))||void 0===s?void 0:s.toggleHiddenBy;if(e){n.length>0&&r&&(i=[...i,...n]);const t=i.reduce(((e,t)=>Object(I.a)(Object(I.a)({},e),{},{[t.convId]:t})),{});i=(await Yr.a.search(e,t)).all}else i&&0!==i.length||(i=this._resConvDataManager.getConvs()),n.length>0&&r&&(i=[...i,...n]);this._sortRelative(this._resConvFilterManager.getCurrentSort(),i)}async _toggleHiddenConv(e){var t,s;let a=((null===(t=this.data.get("convs"))||void 0===t?void 0:t.convs)||this._resConvDataManager.getConvs()||[]).filter((e=>!In.a.isThreadHidden(e.userId)));if(e){const e=this._resConvDataManager.getConvHiddenData();a=[...a,...e]}else a=a.filter((e=>!this._resConvDataManager.isHiddenConv(e.userId)));const i=null===(s=this.data.get("searchBy"))||void 0===s?void 0:s.searchBy;if(i){const e=a.reduce(((e,t)=>Object(I.a)(Object(I.a)({},e),{},{[t.convId]:t})),{});a=(await Yr.a.search(i,e)).all}this._sortRelative(this._resConvFilterManager.getCurrentSort(),a)}_cancelAllCalculations(){this._resConvDataManager.cancelQuickScan(),this._resConvDataManager.cancelDBScan(),this._resZaRFDataManager.abort(),this._resUnlistedDataManager.abort()}_cancelAllOverviewCalculations(){this._resZaRFDataManager.cancel(),this._resUnlistedDataManager.cancel()}_listenEvents(){this._listeningEvents=!0,this._resConvDataManager.addEventListener(Fn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resZaRFDataManager.addEventListener(Fn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resUnlistedDataManager.addEventListener(Fn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resConvFilterManager.addEventListener(Fn.ResConv_FilterSort_Status_Change,this._handleSortFilterEventChange),this._resConvDataManager.addEventListener(Fn.ResCalc_Manual_Fast_Calculate,this._handleManualFastCalculateStatus),this._resConvDataManager.addEventListener(Fn.ResCalc_Manual_Detail_Calculate,this._handleManualDetailCalculateStatus),this._resConvDataManager.addEventListener(Fn.ResCalc_Delete_Convs,this._handleCalculateResourceWhenDeleteConvs),this._resConvDataManager.addEventListener(Fn.ResCalc_Delete_Convs_Status,this._handleCalculateDeleteConvsStatus),this._resConvDataManager.addEventListener(Fn.ResCalc_Update_Detail_Page_Cache,this._handleCalculateUpdateDetailPageCache),this._resUnlistedDataManager.addEventListener(Fn.Res_Clean_Cache_Folder_Status,this._handleCleanCacheFolderStatusChange),this._resUnlistedDataManager.addEventListener(Fn.Res_Clean_Other_Accounts_Status,this._handleCleanOtherAccountsStatusChange)}_cleanupListeners(){this._listeningEvents=!1,this._resConvDataManager.removeEventListener(Fn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resZaRFDataManager.removeEventListener(Fn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resUnlistedDataManager.removeEventListener(Fn.ResCalc_UI_Status_Change,this._handleCalculationStatus),this._resConvFilterManager.removeEventListener(Fn.ResConv_FilterSort_Status_Change,this._handleSortFilterEventChange),this._resConvDataManager.removeEventListener(Fn.ResCalc_Manual_Fast_Calculate,this._handleManualFastCalculateStatus),this._resConvDataManager.removeEventListener(Fn.ResCalc_Manual_Detail_Calculate,this._handleManualDetailCalculateStatus),this._resConvDataManager.removeEventListener(Fn.ResCalc_Delete_Convs,this._handleCalculateResourceWhenDeleteConvs),this._resConvDataManager.removeEventListener(Fn.ResCalc_Delete_Convs_Status,this._handleCalculateDeleteConvsStatus),this._resConvDataManager.removeEventListener(Fn.ResCalc_Update_Detail_Page_Cache,this._handleCalculateUpdateDetailPageCache),this._resUnlistedDataManager.removeEventListener(Fn.Res_Clean_Cache_Folder_Status,this._handleCleanCacheFolderStatusChange),this._resUnlistedDataManager.removeEventListener(Fn.Res_Clean_Other_Accounts_Status,this._handleCleanOtherAccountsStatusChange)}_canRequestCalculateRes(e){if([kn.a.ACTIVE_EVENT].includes(e))return!1;if(!this._intervalOn)return this._intervalOn=!0,this._intervalOn;const t=Date.now(),s=t-this.getLastCalcTs()>=this._calculateInterval;return s&&me.a.ResCacheManager.revokeCache(),this.logger.zsymb(5,"Iw26vS",["Checking expire: ","eiVpTA"],s,t-this.getLastCalcTs(),this._calculateInterval,this._calcHistory),s}_hasLastFastScanRequestExpired(){const e=Date.now(),t=e-this.getLastCalcTs()>=this._rescanFastCalculate;return t&&me.a.ResCacheManager.revokeCache(),this.logger.zsymb(5,"iCGh_G",["Checking expire: ","eiVpTA"],t,e-this.getLastCalcTs(),this._rescanFastCalculate,this._calcHistory),t}_hasLastScanRequestExpired(){const e=Date.now(),t=e-this.getLastCalcTs()>=this._rescanCalculate;return t&&me.a.ResCacheManager.revokeCache(),this.logger.zsymb(5,"VNselR",["Checking expire - scan request expired: ","ebciyD"],t,e-this.getLastCalcTs(),this._rescanCalculate,this._calcHistory),t}_getCPU(){var e=to.cpus(),t=0,s=0,a=0,i=0,n=0;for(var r in e)e.hasOwnProperty(r)&&(t+=e[r].times.user,s+=e[r].times.nice,a+=e[r].times.sys,n+=e[r].times.irq,i+=e[r].times.idle);return{idle:i,total:t+s+a+i+n}}getCPUUsage(e,t=!1){const s=this._getCPU(),a=s.idle,i=s.total;setTimeout((()=>{const s=this._getCPU(),n=s.idle,r=s.total,o=(n-a)/(r-i);e(!0===t?o:1-o)}),1e3)}async _systemUsageInfo(){return new Promise(((e,t)=>{const s=to.totalmem(),a=to.freemem(),i=s-a;this.getCPUUsage((t=>{e({cpu:t,memory:i/s})}))}))}})||Qr)||Qr)||Qr)||Qr)||Qr)||Qr)||Qr)||Qr)||Qr);s("KszJ"),s("Hbak");var ro=s("SZ0g");a.ModuleContainer.registerValue(ro.a,new class{constructor(){this._emitter=void 0,this._emitter=hi.a.instance}emit(e){return this._emitter.emit(e.topic,e),Promise.resolve()}on(e,t){return this._emitter.on(e,t),this}off(e,t){return this._emitter.off(e,t),this}});var oo,co=s("hLuk");Object(m.j)()(oo=class{onStart(){co.default.init()}});var lo=s("MPLC"),uo=s("xdZB"),ho=s("4wTQ");const go=Object(a.define)("message-controller");var mo,po=s("hWjG"),fo=s("mE25"),vo=s("mlG1"),_o=s("P6UB");let bo=Object(a.singleton)()(mo=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(mo=Reflect.metadata("design:type",Function)(mo=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(mo=class extends po.a{constructor(e){super("Core","Message","",e)}countMessages(e,t={from:["0","0"],to:[fo.b,fo.a]}){return this._dbCollection.count({from:[e,...t.from],to:[e,...t.to]},{index:"userId_sendDttm_msgId",partition:e})}async getLastMessage(e){var t;let s=null;const a={from:[e,"",""],to:[e,fo.b,fo.a],excludeFrom:!0,excludeTo:!0},i={index:"userId_sendDttm_msgId",direction:O.c.PREV,limit:1,predicate:t=>{!s&&t&&(s=t);const a=vo.d.reduceDeleteMsgs(e,[t],!0);return _o.default.isValidPreviewMessage(t)&&0!==a.length},partition:e},n=await this._dbCollection.getAll(a,i);return null!==(t=null==n?void 0:n[0])&&void 0!==t?t:s}async getPrevMessageIds(e,t,s){const a={from:[e,"",""],to:[e,(await this.get(t)).sendDttm,t],excludeFrom:!0,excludeTo:!0},i={index:"userId_sendDttm_msgId",direction:O.c.PREV,limit:s,predicate:e=>!isNaN(Number(e.msgId)),partition:e};return(await this._dbCollection.getAll(a,i)).map((e=>e.msgId))}})||mo)||mo)||mo)||mo;const Io=(e,t)=>{if(e)throw t};var yo=s("S8fy"),So=s("fBUP"),Co=s("kCOK"),Eo=s("1izJ");let Oo=function(e){return e[e.FETCH_ERROR=0]="FETCH_ERROR",e[e.FETCH_CONV_HAS_MSG_OFFLINE_ERROR=1]="FETCH_CONV_HAS_MSG_OFFLINE_ERROR",e[e.INVALID_RESPONSE=2]="INVALID_RESPONSE",e[e.INSERT_MULTI_ERROR=3]="INSERT_MULTI_ERROR",e}({});class Mo extends Eo.a{constructor(e,t,s,a){super("FetchMessageCloudError",Oo.FETCH_ERROR,`ConvId: ${e}. RequestMsgId: ${t}. OriginError: ${JSON.stringify(s)}`,a)}}class To extends Eo.a{constructor(e,t){super("InvalidResponse",Oo.INVALID_RESPONSE,e,t)}}class Ro extends Eo.a{constructor(e,t){super("FetchConvHasMessageOfflineError",Oo.FETCH_CONV_HAS_MSG_OFFLINE_ERROR,e,t)}}Eo.a;var wo,Lo=s("mea/");let Do=Object(yo.h)()(wo=class{async fetchMessagesCloud(e,t,s,a,i){const n=Lo.a.newReq(),[r,o]=await E.c.catchPromise(So.default.getCM(e,Number(t),0,s,n,i,a));Io(r,new Mo(e,t,r));const[c,l]=await E.c.catchPromise(Object(Co.a)(o));Io(c,new To(`ConvId: ${e}. RequestMsgId: ${t}. Cannot handle response: ${JSON.stringify(c)}`));const[d,u]=E.c.catchFn((()=>JSON.parse(l)));return Io(d,new To(`ConvId: ${e}. RequestMsgId: ${t}. Cannot parse json object`)),u}async fetchListConvHasMessageOffline(e,t,s){const[a,i]=await E.c.catchPromise(So.default.getConvHasMessageOffline(e,t,s));Io(a,new Ro(JSON.stringify(a)));const[n,r]=await E.c.catchPromise(Object(Co.a)(i));return Io(n,new To(`Cannot handle response: ${JSON.stringify(n)}`)),r}})||wo;var Ao,Fo=s("/Bne");class ko{constructor(e,t){this.convId=e,this.messageCloudRaw=t,this.userId=void 0,this.idTo=void 0,this.uidFrom=void 0,this.uin=void 0,this.cliMsgId=void 0,this.msgId=void 0,this.content=void 0,this.dName=void 0,this.msgType=void 0,this.status=void 0,this.ts=void 0,this.isFromCloud=void 0,this.msgKey=void 0,this.isGroup=void 0,this.mentions=void 0,this.quote=void 0,this.st=void 0,this.at=void 0,this.ttl=void 0,this.src=void 0,this.cmd=void 0,this.footer=void 0,this.footerv2=void 0,this.previewThumb=void 0,this.property=void 0,this.propertyExt=void 0,this.specialMsgType=void 0,this.topOut=void 0,this.topOutImprTimeOut=void 0,this.topOutTimeOut=void 0,this.userId=t.userId,this.idTo=t.idTo,this.uidFrom=t.uidFrom,this.uin=t.uin,this.cliMsgId=t.cliMsgId,this.msgId=t.msgId,this.content=t.content,this.dName=t.dName,this.msgType=t.msgType,this.status=t.status,this.ts=t.ts,this.mentions=t.mentions,this.quote=t.quote,this.st=t.st,this.at=t.at,this.ttl=t.ttl,this.cmd=t.cmd,this.footer=t.footer,this.footerv2=t.footerv2,this.previewThumb=t.previewThumb,this.property=t.property,this.propertyExt=t.propertyExt,this.specialMsgType=t.specialMsgType,this.topOut=t.topOut,this.topOutImprTimeOut=t.topOutImprTimeOut,this.topOutTimeOut=t.topOutTimeOut,this.isFromCloud=!0,this.msgKey=e,this.isGroup=t.isGroup}toEntity(){return Fo.a.transformMessageFromServer(this.messageCloudRaw,this.convId)}setSrc(e){this.src=e}}let No=Object(yo.h)()(Ao=Reflect.metadata("design:type",Function)(Ao=Reflect.metadata("design:paramtypes",[])(Ao=class{constructor(){this.apiAdapter=void 0,this.apiAdapter=a.ModuleContainer.resolveToken(Do)}async fetchMessagesCloud(e,t,s,a){var i;const[n,r]=await E.c.catchPromise(this.apiAdapter.fetchMessagesCloud(e,t,s,a));Io(n,n);const o=(null!==(i=r.groupMsgs)&&void 0!==i?i:[]).map((t=>new ko(e,t)));return Object(I.a)(Object(I.a)({},r),{},{groupMsgs:o})}async fetchConvHasMessageOffline(e,t,s){return await this.apiAdapter.fetchListConvHasMessageOffline(e,t,s)}})||Ao)||Ao)||Ao;var Po;Object(a.singleton)(go)(Po=Reflect.metadata("design:type",Function)(Po=Reflect.metadata("design:paramtypes",[])(Po=class{constructor(){this.messageRespository=void 0,this.messageService=void 0,this.messageRespository=a.ModuleContainer.resolveToken(bo),this.messageService=a.ModuleContainer.resolveToken(No)}async fetchMessagesCloud(e,t,s,a){return await this.messageService.fetchMessagesCloud(e,t,s,a)}async getLastMessage(e){return await this.messageRespository.getLastMessage(e)}async getPrevMessageIds(e,t,s){return this.messageRespository.getPrevMessageIds(e,t,s)}async countMessages(e,t){return await this.messageRespository.countMessages(e,t)}async getGroupHasMessageOffline(e,t,s){const a=await this.messageService.fetchConvHasMessageOffline(e,t,s);return{listConvIds:a.grids.map((e=>Y.GROUPID_PREFIX+e)),evict:!!a.evict}}reloadMessage(e){var t;null===(t=lo.b.messageCache)||void 0===t||t.deleteConversation(e);uo.a.getExistConvIds().includes(e)&&ho.default.getLastMessagesForConversation(e,{})}})||Po)||Po);var jo=s("ZCU6");const Uo=Object(a.define)("cloud-segment-controller");var Bo=s("npvr"),zo=s("t3h5");let Go=function(e){return e[e.UPDATE_FAILED=0]="UPDATE_FAILED",e}({});class xo extends Eo.a{constructor(e,t){super("UpdateSegmentError",Go.UPDATE_FAILED,e,t)}}var Vo;let Ho=Object(a.singleton)()(Vo=class{async get(e){return zo.a.getSegmentByConvId(e)}async update(e,t){const[s]=await E.c.catchPromise(Bo.b.updateSegmentDB(e,t));return Io(s,new xo(JSON.stringify(s))),zo.a.setSegmentCacheByConvId(e,t),t}})||Vo;var Wo;Object(a.injectable)()(Wo=Object(a.singleton)(Uo)(Wo=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(Wo=Reflect.metadata("design:type",Function)(Wo=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Wo=class{constructor(e){this.logger=void 0,this.repository=void 0,this.repository=a.ModuleContainer.resolveToken(Ho),this.logger=e.createZLogger(w.ZLoggerNametags.messageCloudSegment,[w.ZLoggerNametags.controller])}async get(e){return this.repository.get(e)}async update(e){return await this.repository.update(e.conversationId,e)}async updateSegment(e,t){const s=jo.a.addOrUpdateSegmentCache(e.conversationId,t.messages,e,{requestMsgId:t.requestMsgId,lastMsgId:t.lastMsgId,checkLoadTop:t.checkLoadTop,hasMore:t.hasMore,minMsgIdFromServer:t.minMsgIdFromServer,maxMsgIdFromServer:t.requestMsgId===Y.MessageConstants.MAX_MSG_ID?t.maxMsgIdFromServer:t.requestMsgId}).segmentObj;return await this.repository.update(e.conversationId,s)}})||Wo)||Wo)||Wo)||Wo);var qo,Ko=s("bV4z"),Zo=s("2kyb"),$o=s("5NxC"),Qo=s("1gE3"),Yo=s("Jw4R"),Jo=s("nWXR");Object(a.injectable)()(qo=Object(a.singleton)(Qo.b)(qo=function(e,t){return Object(a.inject)(m.a)(e,void 0,0)}(qo=Reflect.metadata("design:type",Function)(qo=Reflect.metadata("design:paramtypes",[void 0===m.a?Object:m.a])(qo=class{get Logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(Qo.a,["clip-board-link-suggest"])),this._logger}constructor(e){this._lastFocusedWindowId=Ar.c,this._linkSuggestData=null,this._currUrl="",this._showLinkSuggestTimes=0,this._showLinkSuggestTimeoutId=null,this._timeClipboardChanged=0,this._listeners=new Map,this._logger=void 0,this._appReadyTime=void 0,this.onFocusingWindowChange=this.onFocusingWindowChange.bind(this),this.onConvOnMainWindowChange=this.onConvOnMainWindowChange.bind(this),this.onNewLinkPreviewData=this.onNewLinkPreviewData.bind(this),e.addEventListenerOnce(m.b.ServicesReady,(()=>{this._appReadyTime=performance.now()})),$o.a.subscribe(ve.LinkPreviewActions.NEW_LINK_PREVIEW,this.onNewLinkPreviewData)}onHaveUrlLinkFromClipboard(e){performance.now()-this.getTimeClipboardChanged()<=Yo.a.getTimeToGetClipboard()&&this._appReadyTime&&this.getTimeClipboardChanged()>this._appReadyTime&&Ko.isClipboardLinkSuggestEnabled()&&e&&e!==this.getCurrLinkUrl()&&me.a.ParserConfig.get("enable_parse_link_client")&&this.pushLinkToCache(e)}isEnabledOnCurrentPlatform(){const e=Ko.getEnableOnPlatform().split(""),t=e[0],s=e[1];return Object(Ee.m)()&&"1"==t||Object(Ee.d)()&&"1"==s}setTimeClipboardChanged(e){this._checkIfEnabled()&&(this._timeClipboardChanged=e)}getTimeClipboardChanged(){return this._timeClipboardChanged}resetData(){var e;if(!this._checkIfEnabled())return;const t=null===(e=a.ModuleContainer.resolve(Zo.a))||void 0===e?void 0:e.getConvIdByWindowId(this._lastFocusedWindowId);this._hideShowLinkSuggest(this._lastFocusedWindowId,t),this._lastFocusedWindowId=Ar.c,this._linkSuggestData=null,this._resetShowLinkTimes(),this.stopTimeout()}startTimeout(e=Ko.getTimeShowClipboardLinkSuggest()){this._checkIfEnabled()&&(this._showLinkSuggestTimeoutId||(this._showLinkSuggestTimeoutId=window.setTimeout((()=>{this.resetData()}),e)))}stopTimeout(){this._checkIfEnabled()&&this._showLinkSuggestTimeoutId&&(clearTimeout(this._showLinkSuggestTimeoutId),this._showLinkSuggestTimeoutId=null)}getCurrLinkUrl(){return this._checkIfEnabled()?this._currUrl:""}getLinkSuggestData(){return this._checkIfEnabled()?this._linkSuggestData:null}hasLinkSuggestData(){return!!this._checkIfEnabled()&&!!this._linkSuggestData}pushLinkToCache(e){this._checkIfEnabled()&&(e&&e!==this._currUrl&&this._resetShowLinkTimes(),this._setCurrLinkUrl(e),Jo.c.create(e).do("parse",[Jo.a.CLIPBOARD]).do("download-thumb").exec().toPromise().then((t=>{null!=t&&t.href&&(t.href=e||t.href,Ko.isClipboardLinkSuggestEnabled()&&this._setLinkSuggestData(t))})).catch((e=>{this.Logger.zsymb(21,"pQ_9rB",["[pushLinkToCache] parse-link-control-error: {}","LkJL0m"],e)})))}addListenerAtWindow(e,t){this._checkIfEnabled()&&this._listeners.set(e,t)}removeListenerAtWindow(e){this._checkIfEnabled()&&this._listeners.delete(e)}onFocusingWindowChange(e){var t,s;if(!this._checkIfEnabled())return;const i=this._lastFocusedWindowId;if(!e||i===e)return;const n=null===(t=a.ModuleContainer.resolve(Zo.a))||void 0===t?void 0:t.getConvIdByWindowId(i);this._hideShowLinkSuggest(i,n),this._lastFocusedWindowId=e;const r=null===(s=a.ModuleContainer.resolve(Zo.a))||void 0===s?void 0:s.getConvIdByWindowId(e);this._countShowLinkSuggest(e,r),this._showLinkSuggest(e,r)}onConvOnMainWindowChange(e=Ar.c,t){this._checkIfEnabled()&&(this._countShowLinkSuggest(e,t),this._showLinkSuggest(e,t))}onNewLinkPreviewData(e){const{newLinkPreviewData:t}=e;this._linkSuggestData&&t&&this._linkSuggestData.data.href===t.link&&this.resetData()}_shouldResetData(){return this._showLinkSuggestTimes>=Ko.getLimitShowClipboardLinkSuggest()}_processCountShowLink(){if(this._shouldResetData())return this.resetData();this._increaseShowLinkTimes()}_increaseShowLinkTimes(e=1){this._showLinkSuggestTimes+=e}_resetShowLinkTimes(e=0){this._checkIfEnabled()&&(this._showLinkSuggestTimes=e)}_setCurrLinkUrl(e){this._currUrl=e}_setLinkSuggestData(e){var t;this._linkSuggestData={id:Object(ha.b)(12),data:Object(I.a)({},e),typeSuggest:Y.MSG_LINK_CLIENT};const s=null===(t=a.ModuleContainer.resolve(Zo.a))||void 0===t?void 0:t.getConvIdByWindowId(this._lastFocusedWindowId);this._countShowLinkSuggest(this._lastFocusedWindowId,s),this._showLinkSuggest(this._lastFocusedWindowId,s)}_checkIfEnabled(){return Ko.isClipboardLinkSuggestEnabled()&&this.isEnabledOnCurrentPlatform()}_checkIfValid(e,t){return!(!this._linkSuggestData||!e||""===t)}_showLinkSuggest(e,t){if(!this._checkIfValid(e,t))return;const s=this._listeners.get(e);s&&"function"==typeof s&&s({action:ve.LinkSuggestManagerActions.NEW_LINK_SUGGEST,payload:{newLinkSuggestData:this._linkSuggestData}})}_hideShowLinkSuggest(e,t){if(!e||""===t)return;const s=this._listeners.get(e);s&&"function"==typeof s&&s({action:ve.LinkSuggestManagerActions.HIDE_LINK_SUGGEST,payload:{newLinkSuggestData:null}})}_countShowLinkSuggest(e,t){this._checkIfValid(e,t)&&this._processCountShowLink()}})||qo)||qo)||qo)||qo);var Xo,ec=s("vQ8b"),tc=s("ZBGy"),sc=s("smi1"),ac=s("gEkt");let ic=Object(a.injectable)()(Xo=function(e,t){return a.ModuleContainer.inject(Nn.UnreadDataManager)(e,void 0,0)}(Xo=function(e,t){return a.ModuleContainer.inject(Nn.PreviewDataManager)(e,void 0,1)}(Xo=Reflect.metadata("design:type",Function)(Xo=Reflect.metadata("design:paramtypes",[void 0===Nn.UnreadDataManager?Object:Nn.UnreadDataManager,void 0===Nn.PreviewDataManager?Object:Nn.PreviewDataManager])(Xo=class{constructor(e,t){this.unreadDataManager=e,this.previewManager=t,this.menuRef=void 0,this.menuRef={}}deleteConversation(e,t=!0,s){e!=Y.CONV_FILTER.STRANGER&&(ui.default.logCoreError(`[user call del conv] ${e}`),sc.default.deleteConversation(e,t,void 0,s).then((e=>{e&&e.delConversationId&&Object(tc.f)({type:ve.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{ui.default.logCoreError("Delete conversation fail - "+JSON.stringify(e))})))}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===ac.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]&&this.menuRef[e].close()}showConvActionMenu(e,t){if(t&&t.friendItem)return;const s=Object(I.a)({},t),a=s.userId;if(s&&!ui.default.isFakeId(a)){const e=this.previewManager.getPreviewByIDSync(a),t=Ii.default.getProfileFriendByIdSync(a)||{},i=this.unreadDataManager.getUnreadByConvIdSync(a);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.type=t.type,s.unreadMark=null==i?void 0:i.unreadMark,s.smsUnreadCount=null==i?void 0:i.smsUnreadCount}this.menuRef[ac.b].updateTargetInfo(s),this.menuRef[ac.b].showAction(Object(I.a)({},e))}})||Xo)||Xo)||Xo)||Xo)||Xo;var nc=s("hI9i"),rc=s("iZzu"),oc=s("6Vk1"),cc=s("RojW"),lc=s("l+Gc"),dc=s("VTLO"),uc=s("LJTV"),hc=s("M7kw"),gc=s("Ws4b"),mc=s("6uTC"),pc=s("Ja3U"),fc=s("SdS7"),vc=s("TeAh"),_c=s("FEfs"),bc=s("u1t/");const Ic="[@CONVERSATION_OPERATION]",yc="[@CONVERSATION_RESOURCES]",Sc="[@CONVERSATION_DELETION_CACHE]",Cc="999999999999999999999",Ec="9999999999999999",Oc="c_d_c_k__";var Mc;const Tc={typeFilter:rc.FilterType.ALL,labelFilters:[],loaded:!1,isEnableArchivedChat:!!_c.a.isEnableArchivedChat(),typeFilterSrc:rc.FilterSrcType.ALL},Rc="z_sendtome_bubbledot";Object(xi.b)(rc.ConvListController)(Mc=function(e,t){return a.ModuleContainer.inject(Nn.ConvInfoDataManager)(e,void 0,0)}(Mc=function(e,t){return a.ModuleContainer.inject(oc.b)(e,void 0,1)}(Mc=function(e,t){return a.ModuleContainer.inject(Nn.UnreadDataManager)(e,void 0,2)}(Mc=function(e,t){return a.ModuleContainer.inject(Nn.MuteDataManager)(e,void 0,3)}(Mc=function(e,t){return a.ModuleContainer.inject(Nn.PinDataManager)(e,void 0,4)}(Mc=function(e,t){return a.ModuleContainer.inject(Nn.ArchivedChatManager)(e,void 0,5)}(Mc=function(e,t){return a.ModuleContainer.inject(Nn.ConversationUIUpdater)(e,void 0,6)}(Mc=Reflect.metadata("design:type",Function)(Mc=Reflect.metadata("design:paramtypes",[void 0===Nn.ConvInfoDataManager?Object:Nn.ConvInfoDataManager,void 0===oc.b?Object:oc.b,void 0===Nn.UnreadDataManager?Object:Nn.UnreadDataManager,void 0===Nn.MuteDataManager?Object:Nn.MuteDataManager,void 0===Nn.PinDataManager?Object:Nn.PinDataManager,void 0===Nn.ArchivedChatManager?Object:Nn.ArchivedChatManager,void 0===Nn.ConversationUIUpdater?Object:Nn.ConversationUIUpdater])(Mc=class extends hs.b{constructor(e,t,s,a,i,n,r){super(),this.convDataManager=e,this.labelDataManager=t,this.unreadDataManager=s,this.muteDataManager=a,this.pinDataManager=i,this.archivedChatManager=n,this.conversationUIUpdater=r,this.typeFilter=void 0,this.labelFilters=void 0,this.listRawAll=void 0,this.listVisible=void 0,this.listStrangers=void 0,this.listHiddens=void 0,this.listFiltered=void 0,this.newestStrangerId=void 0,this.menuRef=void 0,this.convUIListContainer=void 0,this.showedOnboarding=void 0,this.loaded=void 0,this.isEnableArchivedChat=void 0,this.typeFilterSrc=void 0,this._logger=void 0,this._pm=null,this._sbc=null,this.handleMuteChange=e=>{const t=e.convId,s=e.payload,a=this.listFiltered.includes(t);this.logger.zsymb(0,"_5jLnF","handleMuteChange",t,a,this.typeFilter,s),a&&(this.typeFilter===rc.FilterType.UNREAD||this.isEnableArchivedChat&&this.typeFilterSrc===rc.FilterSrcType.UNREAD)&&this.addConvToUnreadFilterV2(t)},this.deleteConversation=(e,t=!0,s)=>{e!=Y.CONV_FILTER.STRANGER&&(this.logger.zsymb(18,"9FfV-n",`[user call del conv] ${e}`),sc.default.deleteConversation(e,t,void 0,s).then((e=>{e&&e.delConversationId&&Object(tc.f)({type:ve.ConversationListActions.TAG_CONV,payload:{data:[{userId:e.delConversationId,label:null}]}})})).catch((e=>{this.logger.zsymb(18,"FJH5sn","Delete conversation fail - "+JSON.stringify(e))})))},this.name=rc.CONV_LIST_CONTROLLER,this.data=new Map,this.key="windowId",this.isEnableArchivedChat=!1,this.typeFilter=rc.FilterType.ALL,this.labelFilters=[],this.typeFilterSrc=rc.FilterSrcType.ALL,this.listRawAll=new Set,this.listVisible=[],this.listStrangers=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="",this.menuRef={},this.showedOnboarding=!1,this.loaded=!1,this.getRecentContactWithId=this.getRecentContactWithId.bind(this),this.selectConversation=this.selectConversation.bind(this),this.showBroadCastMsgModal=this.showBroadCastMsgModal.bind(this),this.markAsRead=this.markAsRead.bind(this),this.addListener()}get logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.conversation,[w.ZLoggerNametags.convList])),this._logger}get previewManager(){return this._pm||(this._pm=a.ModuleContainer.resolve(Nn.PreviewDataManager)),this._pm}get sidebarController(){return this._sbc||(this._sbc=a.ModuleContainer.resolve(rc.SidebarController)),this._sbc}get currUser(){return Object(gc.c)()}onTypeFilterChange(e,t){if(e===rc.FilterType.UNREAD){const e=this.labelFilters.length>0?1453215:1453214;Ia.default.logAction(e),setTimeout((()=>{this.scrollToTop(!1)}))}else e!==rc.FilterType.ARCHIVED&&e!==rc.FilterType.FOCUSED||this.typeFilter===e||setTimeout((()=>{this.scrollToTop(!1)}));const s=this.typeFilter,i=e,n=a.ModuleContainer.resolve(bc.TUnreadSubChatTabStateManager),r=n.convetFilterTypeToSubChatTabType(s),o=n.convetFilterTypeToSubChatTabType(i);n.isValidSubChatTabType(o)&&n.handleChangeSubtab(r,o),this.applyTypeFilter(e,t)}onLabelFilterChange(e){this.typeFilter===rc.FilterType.UNREAD&&setTimeout((()=>{this.scrollToTop(!1)})),this.applyLabelFilter(e)}rerenderList(){this.signalRenderList()}async onPreviewChange(e,t){if(!e||!t)return;const s=e.convId;if(this.listRawAll.add(s),In.a.isThreadHidden(s))return void(this.listHiddens.includes(s)||this.listHiddens.push(s));let a=s,i=!1,n=!1,r=!1;if(await cc.ConvList.isOATypeAsync(s)){if(!(await cc.ConvList.checkIfOAShouldShowInConvList(s))&&!this.listVisible.includes(s))return}else if(cc.ConvList.isStrangerV2(s)&&(i=!0,this.listStrangers.includes(s)||(this.logger.zsymb(0,"GEMzER",`first new stranger msg ${s}`),this.listStrangers.push(s)),!this.isUnboxStrangerAccount())){const t="0"==e.fromUid||this.convDataManager.isRespondedByMeSync(s),i=this.listVisible.includes(s);t||(i&&(r=!0,this.listVisible=this.listVisible.filter((e=>e!==s))),this.updateNewestStrangerId(this.listStrangers),a=Y.CONV_FILTER.STRANGER),t&&!i&&(n=!0,this.listVisible.unshift(s),this.newestStrangerId===s&&this.updateNewestStrangerId(this.listStrangers))}const[o,c]=cc.ConvList.insertToProperPosition(this.listVisible,a,this.getAlterId());this.listVisible=o,e.msgId!==Y.FAKE_DRAFT_MSG_ID||e.draft||(this.listVisible=this.listVisible.filter((e=>e!==s)),r=!0);const l=lc.a.getLabelObjByConversaionId(s),d=l&&l.id&&this.labelFilters.includes(""+l.id),u=i&&this.labelFilters.includes(ac.g),h=d||u,g=c||n||r,m="server"===e.src;if(this.typeFilter===rc.FilterType.ALL)this.addTabAllFiltered(s,h,g,m);else if(this.typeFilter===rc.FilterType.UNREAD)this.addTabUnreadFiltered(s,h,i,m);else if(this.typeFilter===rc.FilterType.STRANGER){const e=d||!this.labelFilters.length,t=i&&e;this.addTabStrangerFiltered(s,t,m)}else if(this.isEnableArchivedChat){const e=this.typeFilter===rc.FilterType.ARCHIVED;this.typeFilterSrc===rc.FilterSrcType.UNREAD?(_c.a.isArchivedChat(s)&&e||!_c.a.isArchivedChat(s)&&!e)&&!In.a.isThreadHidden(s)&&this.addTabUnreadFiltered(s,h,i,m):this.listFiltered=this.genListArchivedChat(this.listVisible,e,this.labelFilters),this.signalRenderList("all",m)}this.smartDispatchEvent(ai.c.PreviewChanged,(()=>new ai.a(ai.c.PreviewChanged,e.convId,{changedItem:e})))}addTabAllFiltered(e,t,s,a=!1){if(t){const[t,s]=cc.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());s&&(this.listFiltered=t,this.signalRenderList("all",a))}else s&&this.signalRenderList("all",a)}addTabUnreadFiltered(e,t,s,a=!1){if(this.listFiltered.includes(e)||!_o.default.isMyMessage(this.previewManager.getPreviewByIDSync(e)))if(t)this.addConvToUnreadFilterV2(e,a);else{if(this.labelFilters.length)return;this.isUnboxStrangerAccount()||!s?this.addConvToUnreadFilterV2(e,a):this.addConvToUnreadFilterV2(Y.CONV_FILTER.STRANGER,a)}}addTabStrangerFiltered(e,t,s=!1){if(!t)return;const[a,i]=cc.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());i&&(this.listFiltered=a,this.signalRenderList("all",s))}addConvToUnreadFilterV2(e,t=!1){const[s,a]=cc.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());a&&(this.listFiltered=this.safeSortConvList(s,!1),this.signalRenderList("all",t))}onPinChange(e){let t=!1;for(let s=0;s<e.length;s++){const a=e[s].priority,i=e[s].id;a?(this.onPreviewChange({convId:i},[]),t=!1):(t=!0,(!this.previewManager.getPreviewByIDSync(i)||!this.convDataManager.isRespondedByMeSync(i)&&cc.ConvList.isStrangerV2(i))&&(this.listVisible=this.listVisible.filter((e=>e!==i))))}t&&(this.listVisible=this.safeSortConvList(this.listVisible,!1),(this.typeFilter!==rc.FilterType.ALL||this.labelFilters.length)&&(this.listFiltered=cc.ConvList.sortConvId(this.listFiltered,!1,!0))),this.signalRenderList()}onHiddenChat(e,t){const s=this.convDataManager.getConvByIdSync(e);if(this.logger.zsymb(0,"rpSkh2","onHiddenChat ",e,t,!!s),t)this.listHiddens.push(e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.signalRenderList();else{if(!s&&!me.a.PinDataManager.isPinned(e))return;if(this.listHiddens=this.listHiddens.filter((t=>t!==e)),this.isUnboxStrangerAccount()||!cc.ConvList.isStrangerV2(e)||this.listStrangers.includes(e)){const[t,s]=cc.ConvList.insertToProperPosition(this.listVisible,e,this.getAlterId());this.listVisible=t}else this.listStrangers.push(e);if(this.listFiltered){const[t,s]=cc.ConvList.insertToProperPosition(this.listFiltered,e,this.getAlterId());this.listFiltered=t,this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===rc.FilterType.ARCHIVED,this.labelFilters))}}this.signalRenderList()}getCurrentFilter(){return{type:this.typeFilter,labels:this.labelFilters}}getRecentContacts(){const e=[];return this.listRawAll.forEach((t=>{const s=this.convDataManager.getConvByIdSync(t);s&&e.push(s)})),e}getRecentContactWithId(e){if(this.listRawAll.has(e)){return this.convDataManager.getConvByIdSync(e)||null}return null}addConvToLabel(e,t){let s=lc.a.getItem(t);Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.MANAGE_LABEL,params:{view:dc.b.ADD_CONVERSATION,info:s}}),e&&(e.preventDefault(),e.stopPropagation()),Ia.default.logAction(14521)}selectConversation(e){if(uc.b.startPerf(uc.a),e.userId===Y.CONV_FILTER.MEDIA)return void this.logger.zsymb(18,"Wsj1MK","No handler for mediabox. This feat disable!!!");if(e.userId===Y.CONV_FILTER.STRANGER)return void(2==Number(Re.default.getConvUXVersion())?this.applyTypeFilter(rc.FilterType.STRANGER):this.labelDataManager.onSelectLabel(ac.g));const t=this.sidebarController.getState(Ar.c).selectedId;e.userId===t&&e.userId!==Y.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(tc.f)({type:ve.ConversationListActions.SELECT_CONV_MINOR,payload:e}):(this.convUIListContainer&&this.convUIListContainer.focus(),e.userId===Ce.default.sendToMeId&&(Me.g.getFlagForCurrentUser(this.currUser.userId,Rc)||(J.p.getHasShownSendToMeTip()?Me.g.setFlagForCurrentUser(this.currUser.userId,Rc,1):setTimeout((()=>{_e.default.send(ve.ConversationListActions.SHOW_BUBBLE_DOT),J.p.setHasShownSendToMeTip(!0)}),144e5)),hc.b.getCurrentStepKey()!==hc.a.UPLOAD_IMAGES||this.showedOnboarding||(hc.b.show(),this.showedOnboarding=!0),Ia.default.logAction(13901)),e.userId===Y.FAKE_CONVERSATION_ID.FRIEND_CENTER?Object(tc.f)({type:ve.SideBarActions.SELECT_FRIEND_CENTER,payload:Object(I.a)({},e)}):a.ModuleContainer.resolve(Q.b).openConversation(e.userId,Q.d.fromConvItem(e))),this.logActionSelectConv(e.userId)}showBroadCastMsgModal(){var e;if(!Re.default.checkBroadcastTime())return void mc.default.createError(ce.a.str("STR_BROADCAST_OVER_LIMIT_TIP"));let t=!0;1===this.labelFilters.length&&(t=lc.a.getItem(this.labelFilters[0])||!0),null!==(e=Ce.default.broadcast_resend_config)&&void 0!==e&&e.enable?Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.BROADCAST_RESEND,params:t}):Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.BROADCAST_COMPSE,params:{label:t}}),Ia.default.logAction(1453102)}markAsRead(e,t=null){e&&(e.preventDefault(),e.stopPropagation()),Ia.default.logAction(164),Re.default.isShowMarkAsReadAgain()?pc.ConfirmManagerV2.openConfirm({windowId:Ar.c,name:Y.MODAL_CONFIRM.confirmIdentities,params:{message:ce.a.str("STR_MARK_READ_CONFIRM_TEXT"),okText:ce.a.str("STR_CONFIRM"),okType:"primary",cancelText:ce.a.str("STR_LOGOUT_NO"),onOk:e=>{Re.default.setShowMarkAsReadAgain(!(e&&e.dont_show_mark_as_read)),this.markConvsAsRead(t)},options:[{default_val:!1,key:"dont_show_mark_as_read",title:"STR_DONT_SHOW_AGAIN"}]}}):this.markConvsAsRead(t)}scrollToTop(e){const t=fc.b.instance().getConvList();t&&t.scrollToTop(e)}scrollToConv(e){const t=fc.b.instance().getConvList();t&&t.scrollToConversation(e)}openInNewWindow(e,t){if(!e||!e.userId)return;const s=this.menuRef[ac.b];s&&s.openInNewWindow&&(s.updateTargetInfo(e),s.openInNewWindow(t))}getStrangerInfo(){let e="";if(this.newestStrangerId){const t=this.previewManager.getPreviewByIDSync(this.newestStrangerId);e=t?t.messageTime:""}return this.logger.zsymb(0,"8qltTh","getStrangerInfo ",this.newestStrangerId,e),{messageTime:e}}getTopMostConv(){return this.typeFilter!==rc.FilterType.ALL||this.labelFilters.length?this.listFiltered[0]:this.listVisible[0]}isPreviewLoaded(){return this.loaded}addListener(){setTimeout((()=>{this.labelDataManager.addEventListener(oc.d.SelectedLabelChange,(e=>{this.onLabelFilterChange(e.payload)})),this.labelDataManager.addEventListener(oc.d.LabelAddConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"add")})),this.labelDataManager.addEventListener(oc.d.LabelRemoveConvs,(e=>{this.onLabelChangeConvs(e.payload.labelId,e.payload.convIds,"remove")}));const e=a.ModuleContainer.resolve(Nn.PreviewDataManager);e.addEventListener(ai.b.DoneLoadPreview,(e=>{this.onLoadPreview(e.payload)})),e.addEventListener(ai.b.DoneMigratePreview,(()=>{this.onMigratedPreview()})),e.addEventListener(ai.b.PreviewChanged,(e=>{const{changedItem:t,all:s}=e.payload;this.onPreviewChange(t,s)})),e.addEventListener(ai.b.DraftChanged,(e=>{})),this.convDataManager.addEventListener(ai.b.DeleteConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(ai.b.EmptyConv,(e=>{this.moveConvOutConvList(e.convId)})),this.convDataManager.addEventListener(ai.b.LeaveGroup,(e=>{this.moveConvOutConvList(e.convId)})),this.pinDataManager.addEventListener(ai.b.ChangePinConv,(e=>{this.onPinChange(e.payload)})),this.archivedChatManager.addEventListener(ai.b.UpdateListArchivedChat,(e=>{this.updateListArchivedChat()})),this.archivedChatManager.addEventListener(ai.b.OnOffArchivedChat,(e=>{this.onOffArchivedChat(e.payload.status)})),this.muteDataManager.addEventListener(ai.b.MuteChanged,this.handleMuteChange),Ii.default.subscribeEventFriend(Y.EventFriend.ADD_FRIEND,(({userId:e})=>{let t=0;this.listStrangers.includes(e)&&(t++,this.listStrangers=this.listStrangers.filter((t=>t!==e)),e==this.newestStrangerId&&(t++,this.updateNewestStrangerId(this.listStrangers))),this.onPreviewChange({convId:e},[]);const s=Ii.default.isFriend(e);this.logger.zsymb(0,"atIH9u",`on add friend ${e} ${t} ${s}`)})),Ii.default.subscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,(({userId:e})=>{let t=0;!this.listStrangers.includes(e)&&this.listVisible.some((t=>t===e))&&(t++,this.listStrangers.push(e)),this.logger.zsymb(0,"sBOvj_",`on remove friend ${e} ${t}`)})),Ii.default.subscribeEventFriend(Y.EventFriend.DOWNGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),Ii.default.subscribeEventFriend(Y.EventFriend.UPGRADE_BIZ_PROFILE,(()=>{this.handleUserPackageChange()})),this.conversationUIUpdater.addEventListener(Nn.ConversationUIUpdaterEvent.FLUSH_QUEUE_LIST,(()=>{this.smartDispatchEvent(ai.c.SignalRenderList,(()=>new ai.g(this.listVisible.slice(0,100))))})),this.conversationUIUpdater.addEventListener(Nn.ConversationUIUpdaterEvent.SIGNAL_RENDER_LIST,(()=>{this.smartDispatchEvent(ai.c.SignalRenderList,(()=>new ai.g(this.listVisible.slice(0,100))))}))}),0)}addToListFiltered(e,t=!1){e.forEach((e=>{if(t){const t=this.unreadDataManager.getUnreadByConvIdSync(e);if(!t||!t.smsUnreadCount&&!t.unreadMark)return}const[s]=cc.ConvList.insertToProperPosition(this.listFiltered,e);this.listFiltered=s}))}applyTypeFilter(e,t=!1){if(this.typeFilter===e&&!t)return;this.logger.zsymb(0,"D4Oa7Y","applyTypeFilter ",e,t);const s=this.typeFilter;switch(this.typeFilter=e,e){case rc.FilterType.ALL:if(0!==this.labelFilters.length){if(this.listFiltered=cc.ConvList.filterByLabel(this.listVisible,this.labelFilters),this.labelFilters.includes(ac.g)){let e=this.listStrangers;this.showStrangerNROnly()&&(e=cc.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}else this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters);this.addLikeConvToFilterListV2(this.listFiltered,this.labelFilters)}break;case rc.FilterType.UNREAD:if(0!==this.labelFilters.length){const e=s==rc.FilterType.ALL?this.listFiltered:this.listVisible;this.listFiltered=cc.ConvList.filterByLabel(e,this.labelFilters),this.labelFilters.includes(ac.g)?this.addToListFiltered(this.listStrangers):this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.listFiltered=cc.ConvList.filterByUnread(this.listFiltered),this.listFiltered=cc.ConvList.sortConvId(this.listFiltered,!1,!0)}else this.listFiltered=cc.ConvList.filterByUnread(this.listVisible),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case rc.FilterType.STRANGER:this.listFiltered=cc.ConvList.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=cc.ConvList.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=cc.ConvList.filterByResponsed(this.listFiltered,!1));break;case rc.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,this.labelFilters);break;case rc.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,this.labelFilters)}const a=this.getList({key:"all",version:0,extraData:{}});this.dispatchEvent(new ai.h(a.slice(0,50))),this.signalRenderState(),this.signalRenderList()}applyLabelFilter(e){if(this.labelFilters===e)return;switch(this.logger.zsymb(0,"0dCZT5","applyLabelFilter ",e.join("-")),this.labelFilters=e.map((e=>""+e)),this.typeFilter){case rc.FilterType.ALL:if(this.listFiltered=cc.ConvList.filterByLabel(this.listVisible,this.labelFilters),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.addLikeConvToFilterListV2(this.listFiltered,e),this.labelFilters.some((e=>e==ac.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=cc.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}break;case rc.FilterType.UNREAD:if(this.listFiltered=cc.ConvList.filterByLabel(this.listVisible,e),this.doAddStrangerHasLabel(this.listFiltered,this.labelFilters),this.labelFilters.some((e=>e==ac.g))){let e=this.listStrangers;this.showStrangerNROnly()&&(e=cc.ConvList.filterByResponsed(e,!1)),this.addToListFiltered(e)}this.listFiltered=cc.ConvList.filterByUnread(this.listFiltered),this.listFiltered=this.safeSortConvList(this.listFiltered,!1);break;case rc.FilterType.STRANGER:this.listFiltered=cc.ConvList.filterByLabel(this.listStrangers,this.labelFilters),this.listFiltered=cc.ConvList.sortConvId(this.listFiltered,!1,!0),this.showStrangerNROnly()&&(this.listFiltered=cc.ConvList.filterByResponsed(this.listFiltered,!1));break;case rc.FilterType.FOCUSED:this.listFiltered=this.genListArchivedChat(this.listVisible,!1,e);break;case rc.FilterType.ARCHIVED:this.listFiltered=this.genListArchivedChat(this.listVisible,!0,e)}const t=this.getList({key:"all",version:1,extraData:{}});this.dispatchEvent(new ai.i(t.slice(0,50))),this.signalRenderState(),this.signalRenderList()}showStrangerNROnly(){return!this.isUnboxStrangerAccount()}isUnboxStrangerAccount(){const e=vc.c.isUnboxStranger();return this.logger.zsymb(0,"4Esgvl","isUnboxStrangerAccount ",e),e}doAddStrangerHasLabel(e,t){if(t.length){const s=cc.ConvList.filterByLabel(this.listStrangers,t);if(s.length){const t=new Set(s);for(let s=0;s<e.length;s++)t.has(e[s])&&t.delete(e[s]);this.addToListFiltered(t)}}return e}isConvExists(e){const t=this.convDataManager.getConvByIdSync(e);return!!(null!=t&&t.firstSmsLocalId||null!=t&&t.lastSmsLocalId)}safeSortConvList(e,t=!0){const s=e.indexOf(Y.CONV_FILTER.STRANGER);if(-1!==s){e[s]=this.newestStrangerId;const a=(e=cc.ConvList.sortConvId(e,t,!0)).indexOf(this.newestStrangerId);e[a]=Y.CONV_FILTER.STRANGER}else e=cc.ConvList.sortConvId(e,t,!0);return e}isValidFakeConv(e,t,s){if(e.some((e=>e==s))||In.a.isThreadHidden(s))return!1;const a=lc.a.getLabelObjByConversaionId(s);return!(!a||!t.some((e=>e==a.id)))}isValidFakeConvV2(e,t){if(!t||e.some((e=>e==t))||In.a.isThreadHidden(t))return!1;return!(t&&t.startsWith(Y.GROUPID_PREFIX))||!!yn.default.getGroupByIdSync(t)}addLikeConvToFilterListV2(e,t){if(t.length&&this.typeFilter!==rc.FilterType.UNREAD){this.logger.zsymb(0,"YqN2WS","addLikeConvToFilterListV2 ",t);for(const s of t){const t=this.labelDataManager.getLabelById(s);if(t&&t.conversations)for(const s of t.conversations)this.isValidFakeConvV2(e,s)&&e.push(s)}}}markConvsAsRead(e){const t=[],s=0===this.labelFilters.length;this.logger.zsymb(0,"EWnFS9",`markConvsAsRead #1  ${null==e?void 0:e.join("-")}`),this.listRawAll.forEach((a=>{const i=this.unreadDataManager.getUnreadByConvIdSync(a);if(i&&(i.smsUnreadCount>0||i.unreadMark)){if(this.logger.zsymb(0,"VQcir-",`markConvsAsRead #2, ${a}, ${i.smsUnreadCount}`),e&&!e.hasOwnProperty(a)||a===Y.FAKE_CONVERSATION_ID.FRIEND_CENTER)return;const n=lc.a.getLabelObjByConversaionId(a)||{},r=this.convDataManager.getConvByIdSync(a)||{userId:a};(s||this.labelFilters.some((e=>e==n.id))||cc.ConvList.isInStrangerBoxV2(a)&&this.typeFilter===rc.FilterType.STRANGER)&&t.push(r)}})),this.logger.zsymb(0,"H9qDV3",`markConvsAsRead #3 ${t.length} ${t.map((e=>e.userId)).join("-")}`),t.length>0&&(_e.default.send(ve.SideBarActions.MARK_AS_READ,{conversations:t}),Ia.default.logAction(1453304))}onLoadPreview(e){this.logger.zsymb(0,"0ABkZj",`onload Preview 1: ${this.listRawAll.size}`);let t=e.map((e=>e.convId));const s=Re.default.getConvUXVersion();this.isEnableArchivedChat=!!_c.a.isEnableArchivedChat()&&"3"==s,this.typeFilter=this.isEnableArchivedChat?rc.FilterType.FOCUSED:rc.FilterType.ALL,this.listRawAll.size&&this.listRawAll.forEach((e=>{t.some((t=>t===e))||t.push(e)})),this.listRawAll=new Set(t);const a=Ce.default.sendToMeId;this.listRawAll.has(a)||(t.push(a),this.listRawAll.add(a)),this.logger.zsymb(0,"UIXVWo",`onload Preview 2: ${t.length}`),cc.ConvList.groupConversation(t).then((e=>{if(this.logger.zsymb(0,"aYEtfb",`grouped list #1: \n\t\t\t\t${e.hidden.length}\n\t\t\t\t- ${e.stranger.length}\n\t\t\t\t- ${e.outdate.length}\n\t\t\t\t- ${e.visible.length}\n\t\t\t`),Ce.default.stagingAccount)for(const a in e)this.logger.zsymb(0,"e21I08",`${a}: ${e[a]}`);this.listStrangers=e.stranger,this.listHiddens=e.hidden;const t=this.addStrangersToVisible(e.visible,this.listStrangers);let s=t;if(this.listVisible.length){this.logger.zsymb(0,"cCNLPT",`preview changed while group csc #1: ${this.listVisible}`),s=this.listVisible;const e=new Set(this.listVisible);t.forEach((t=>{e.has(t)||s.push(t)}))}this.listVisible=this.safeSortConvList(s,!1),this.initMyCloud(),this.isEnableArchivedChat&&(this.listFiltered=this.genListArchivedChat(this.listVisible,this.typeFilter===rc.FilterType.ARCHIVED,this.labelFilters)),this.logger.zsymb(0,"DXfCF8",`visible sorted #1: ${this.listVisible}`),this.loaded=!0,this.signalRenderList(),this.signalRenderState(),this.dispatchEvent(new ai.a(ai.c.LoadPreviewDone,"",this.listVisible.slice()))}))}onMigratedPreview(){this.logger.zsymb(0,"D--8uQ",`onMigratedPreview #1: ${this.listVisible}`);const e=Re.default.getConvUXVersion();this.isEnableArchivedChat=!!_c.a.isEnableArchivedChat()&&"3"==e,this.typeFilter=this.isEnableArchivedChat?rc.FilterType.FOCUSED:rc.FilterType.ALL;const t=Ce.default.sendToMeId;this.listRawAll.has(t)||this.initMyCloud(),this.convDataManager.getConvByIdSync(t)&&!this.listVisible.includes(t)&&(this.logger.zsymb(0,"2vA1yz","onMigratedPreview #2"),this.onPreviewChange({convId:t},[])),this.loaded=!0,this.signalRenderList(),this.signalRenderState()}initMyCloud(){const e=Me.g.getFlagForCurrentUser(null,"z_sendtome"),t=Ce.default.sendToMeId,s=!(Ce.default.isOffSendToMe||e&&1!==e);if(this.logger.zsymb(0,"fJ44Sw","initMyCloud",e,Ce.default.isOffSendToMe),this.listVisible.some((e=>e===t))){const e=this.convDataManager.getConvByIdSync(t);e&&e.pinned?Ia.default.logAction(1390703):(Me.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),Ia.default.logAction(1390702))}else if(s){const e=me.a.PinDataManager.getTotalPinnedConversation()>=Ce.default.limit_pin_messages,s=Ce.default.auto_pin_send2me&&!Me.g.getFlagForCurrentUser(null,"z_sendtome_pinned")&&!e;this.convDataManager.createEmptyConvForUser(t,s?1:0,Y.CONV_OT_STATE.none,{}),s&&(me.a.PinDataManager.pin([t]),Me.g.setFlagForCurrentUser(null,"z_sendtome_pinned",1)),Me.g.setFlagForCurrentUser(null,"z_sendtome",Date.now()),this.onPreviewChange({convId:t},[])}}addStrangersToVisible(e,t){if(!t||!t.length)return e;if(this.isUnboxStrangerAccount())return e.concat(t);{const s=cc.ConvList.filterByResponsed(t,!1);if(s.length){this.newestStrangerId=cc.ConvList.getNewestConvFromIds(s);e.includes(Y.CONV_FILTER.STRANGER)||e.push(Y.CONV_FILTER.STRANGER)}return t.forEach((t=>{this.convDataManager.isRespondedByMeSync(t)&&e.push(t)})),e}}onLabelChangeConvs(e,t,s){if(this.logger.zsymb(0,"bXXvcS","onLabelChangeConvs",t.length,e),t.length&&this.labelFilters.includes(e))if("add"==s){const e=t.filter((e=>!this.listFiltered.includes(e)&&!this.listHiddens.includes(e)));if(!e.length)return;this.listFiltered=[...this.listFiltered,...e],this.listFiltered=cc.ConvList.sortConvId(this.listFiltered,!1,!1),this.signalRenderList()}else{let e=!1;t.forEach((t=>{const s=lc.a.getLabelObjByConversaionId(t),a=s?s.id:null;this.labelFilters.includes(""+a)||(this.listFiltered=this.listFiltered.filter((e=>e!==t)),e=!0)})),e&&this.signalRenderList()}}moveConvOutConvList(e){this.logger.zsymb(0,"lymDEH","moveConvOutConvList",e),this.listVisible=this.listVisible.filter((t=>t!==e)),this.listFiltered=this.listFiltered.filter((t=>t!==e)),this.listStrangers=this.listStrangers.filter((t=>t!==e)),e!==this.newestStrangerId||this.isUnboxStrangerAccount()||this.updateNewestStrangerId(this.listStrangers),this.signalRenderList()}getAlterId(){return new Map([[Y.CONV_FILTER.STRANGER,this.newestStrangerId]])}updateNewestStrangerId(e){if(this.isUnboxStrangerAccount())return;const t=cc.ConvList.filterByResponsed(e,!1),s=this.newestStrangerId;if(this.newestStrangerId=cc.ConvList.getNewestConvFromIds(t),this.newestStrangerId||(this.listVisible=this.listVisible.filter((e=>e!==Y.CONV_FILTER.STRANGER)),this.signalRenderList()),this.previewManager.updateStrangerBox(this.newestStrangerId),s!==this.newestStrangerId&&this.newestStrangerId){const[e,t]=cc.ConvList.insertToProperPosition(this.listVisible,Y.CONV_FILTER.STRANGER,this.getAlterId());this.listVisible=e,this.signalRenderList()}}async rebuildList(){this.logger.zsymb(0,"4LfkZK",`rebuildList 1: ${this.listRawAll.size} ${this.listVisible.length} ${this.listStrangers.length}`),this.listStrangers=[],this.listVisible=[],this.listHiddens=[],this.listFiltered=[],this.newestStrangerId="";const e=Array.from(this.listRawAll),t=await cc.ConvList.groupConversation(e);if(this.logger.zsymb(0,"NEmpOk",`grouped list #2: \n\t\t\t${t.hidden.length}\n\t\t\t- ${t.stranger.length}\n\t\t\t- ${t.outdate.length}\n\t\t\t- ${t.visible.length}\n\t\t`),Ce.default.stagingAccount)for(const i in t)this.logger.zsymb(0,"ecoYV-",`${i}:, ${t[i]}`);this.listStrangers=t.stranger,this.listHiddens=t.hidden;const s=this.addStrangersToVisible(t.visible,this.listStrangers),a=this.safeSortConvList(s,!1);this.listVisible=a,this.logger.zsymb(0,"L7VGxW",`visible sorted #2: ${this.listVisible}`),this.labelFilters.length&&this.applyLabelFilter(this.labelFilters),this.typeFilter!==rc.FilterType.ALL&&this.applyTypeFilter(this.typeFilter,Ce.default.should_force_genlist_conv),this.signalRenderList(),this.signalRenderState()}handleUserPackageChange(){this.logger.zsymb(0,"_QPb5h",`handleUserPackageChange: ${Ii.default.isMeBAAccount()}}`),this.rebuildList()}signalRenderList(e="all",t=!1){this.logger.zsymb(12,"aeIbsx","signalRenderList shouldBatching",t),t?this.conversationUIUpdater.signalRenderList(this.name,e):(Object(nc.i)(this.name,e),this.smartDispatchEvent(ai.c.SignalRenderList,(()=>new ai.g(this.listVisible.slice(0,100)))))}signalRenderState(){Object(nc.h)(this.name,Ar.c)}logActionSelectConv(e){const t=this.labelFilters.length>0;if(this.typeFilter===rc.FilterType.UNREAD?(Ia.default.logAction(1453103),t||Ia.default.logAction(1453107)):this.typeFilter===rc.FilterType.ALL?(Ia.default.logAction(1453104),t&&Ia.default.logAction(1453108)):this.typeFilter===rc.FilterType.FOCUSED?Ia.default.logAction(1453501):this.typeFilter===rc.FilterType.ARCHIVED&&Ia.default.logAction(1453502),t)Ia.default.logAction(1453105);else{Ia.default.logAction(1453106);for(let e=0;e<this.labelFilters.length;e++){if(parseInt(this.labelFilters[e])>0){Ia.default.logAction(1453109);break}}}this.typeFilter==rc.FilterType.ARCHIVED&&_c.a.sendTrackSrc(e,4,!1)}init(){}getItem(e){return e.key===Ar.c?{labelFilters:this.labelFilters,typeFilter:this.typeFilter,loaded:this.loaded,isEnableArchivedChat:this.isEnableArchivedChat,typeFilterSrc:this.typeFilterSrc}:Tc}getList(e){return e.key===Ar.c||this.typeFilter==rc.FilterType.ALL&&0===this.labelFilters.length?this.listVisible:this.listFiltered}onGetItemFailure(e){}onGetListFailure(e){}bindUIMenu(e,t){this.menuRef[e]=t}cleanUpUIMenu(e){this.menuRef[e]=null}showMenu(e,t,s){if(this.menuRef[e]&&e===ac.b)this.showConvActionMenu(t,s)}hideMenu(e){this.menuRef[e]}showConvActionMenu(e,t){if(t&&t.friendItem)return;if(t.userId===Y.CONV_FILTER.STRANGER||t.userId===Y.CONV_FILTER.MEDIA)return;const s=Object(I.a)({},t),a=s.userId;if(s&&!ui.default.isFakeId(a)){const e=this.previewManager.getPreviewByIDSync(a),t=Ii.default.getProfileFriendByIdSync(a)||{},i=this.unreadDataManager.getUnreadByConvIdSync(a);s.lastMessage=null==e?void 0:e.message,s.isFr=t.isFr,s.unreadMark=null==i?void 0:i.unreadMark,s.smsUnreadCount=null==i?void 0:i.smsUnreadCount}this.menuRef[ac.b].updateTargetInfo(s),this.menuRef[ac.b].showAction(Object(I.a)({},e))}bindUIContainer(e){this.convUIListContainer=e}cleanUpUIContainer(){this.convUIListContainer=null}getEnableArchivedChat(){return this.isEnableArchivedChat}getListFilterSrc(e){return this.typeFilterSrc===rc.FilterSrcType.UNREAD?cc.ConvList.filterByUnread(e):e}setTypeFilterSrc(e){if(this.typeFilterSrc!==e&&(this.typeFilterSrc=e,this.applyTypeFilter(this.typeFilter,!0),e===rc.FilterSrcType.UNREAD)){const e=this.labelFilters.length>0?1453215:1453214;Ia.default.logAction(e)}}genListArchivedChat(e,t,s,a=!0,i=!0){let n=[];n=cc.ConvList.filterByLabel(this.getListFilterSrc(e),s),s.length&&i&&this.typeFilterSrc!==rc.FilterSrcType.UNREAD&&this.addLikeConvToFilterListV2(n,s);let r=this.getListFilterSrc(this.listStrangers).filter((e=>(_c.a.isArchivedChat(e)&&t||!_c.a.isArchivedChat(e)&&!t)&&!In.a.isThreadHidden(e)));return s.includes(ac.g)&&1==s.length?this.isUnboxStrangerAccount()||(r=cc.ConvList.filterByResponsed(r,!1)):s.includes(ac.g)||(r=cc.ConvList.filterByLabel(r,s)),n=n.filter((e=>!(this.typeFilter===rc.FilterType.ARCHIVED||!r.length||e!=Y.CONV_FILTER.STRANGER)||(_c.a.isArchivedChat(e)&&t||!_c.a.isArchivedChat(e)&&!t)&&e!==Y.CONV_FILTER.STRANGER&&!cc.ConvList.isStrangerV2(e)&&!In.a.isThreadHidden(e))),a&&(this.typeFilter===rc.FilterType.ARCHIVED?n=n.concat(r):this.isUnboxStrangerAccount()||s.length?(this.isUnboxStrangerAccount()&&(null==s||!s.length)||null!=s&&s.length)&&(n=n.concat(r)):n=this.addStrangersToVisible(n,r)),n=n.filter(((e,t)=>n.indexOf(e)==t)),this.safeSortConvList(n,!1)}isChatVisible(e){return this.listVisible.includes(e)}updateListArchivedChat(){this.typeFilter==rc.FilterType.FOCUSED?this.onTypeFilterChange(rc.FilterType.FOCUSED,!0):this.typeFilter==rc.FilterType.ARCHIVED&&this.onTypeFilterChange(rc.FilterType.ARCHIVED,!0)}onOffArchivedChat(e){if(!Ce.default.enable_archived_chat)return;const t=Re.default.getConvUXVersion();this.isEnableArchivedChat&&e&&"2"==t&&(this.isEnableArchivedChat=!1,this.signalRenderState()),this.isEnableArchivedChat!=e&&(e||this.typeFilter!==rc.FilterType.ARCHIVED&&this.typeFilter!==rc.FilterType.FOCUSED?e&&this.onTypeFilterChange(rc.FilterType.FOCUSED,!0):this.onTypeFilterChange(rc.FilterType.ALL,!0),this.labelDataManager.onClearFilter(),this.setTypeFilterSrc(rc.FilterSrcType.ALL),this.isEnableArchivedChat=e&&"3"==t,this.signalRenderState())}})||Mc)||Mc)||Mc)||Mc)||Mc)||Mc)||Mc)||Mc)||Mc);var wc,Lc=s("BR4E"),Dc=s("R5gT"),Ac=s("Xzw3"),Fc=s("uEOi"),kc=s("4prX"),Nc=s("kTC5"),Pc=s("ES/k"),jc=s("uAQs"),Uc=s("WBqA"),Bc=s("qa8q"),zc=s("vAzq");const Gc={isFocusSearchBox:!1,isFocusOnRecentSearch:!1,searchText:"",searchResult:{},searching:!1,conversation:null,highlightId:"",filter:{timeFrom:0,timeTo:Date.now()}},xc=new ui.LocalId;var Vc=function(e){return e[e.STEP_CONTACT=0]="STEP_CONTACT",e[e.STEP_MESSAGES=1]="STEP_MESSAGES",e[e.STEP_FILES=2]="STEP_FILES",e[e.STEP_DIRECTORY=3]="STEP_DIRECTORY",e}(Vc||{});const Hc=e=>ui.default.md5(e);Object(m.d)()(wc=Object(xi.b)(rc.SearchController)(wc=function(e,t){return a.ModuleContainer.inject(ii.b)(e,void 0,0)}(wc=function(e,t){return a.ModuleContainer.inject(Nn.ConvInfoDataManager)(e,void 0,1)}(wc=function(e,t){return a.ModuleContainer.inject(Nn.PreviewDataManager)(e,void 0,2)}(wc=Reflect.metadata("design:type",Function)(wc=Reflect.metadata("design:paramtypes",[void 0===ii.b?Object:ii.b,void 0===Nn.ConvInfoDataManager?Object:Nn.ConvInfoDataManager,void 0===Nn.PreviewDataManager?Object:Nn.PreviewDataManager])(wc=class{constructor(e,t,s){this.convListController=e,this.convDataManager=t,this.previewDataManager=s,this.state=void 0,this.pageLoad=void 0,this.curQuery=void 0,this.cacheResSearch=void 0,this.countQuery=void 0,this.countTimeUseGlobalSearch=void 0,this.countSelectTopRes=void 0,this.cacheSearch=void 0,this.trackSearch=void 0,this.trackSearchVietnamese=void 0,this.lastTextSearch=void 0,this.lastTextSearchTs=void 0,this.isShowRecentSearch=void 0,this.isFirstLoadSuccess=void 0,this.isSearchingMsg=void 0,this.searchDelay=void 0,this.closeBySendingMsg=void 0,this.clearAdminMode=void 0,this.timeouResetDataMsg=void 0,this.searchResultList=void 0,this.recentSearchList=void 0,this.searchInput=void 0,this.loadingMore=void 0,this.loadingMoreFiles=void 0,this.oldestTime=void 0,this.functionSearchByName=void 0,this.timeoutLog=void 0,this._timeDebounceSearch=null,this.dataLoaded=void 0,this._sbc=null,this._removeSearchResult=(e,t)=>{const s=this.getSearchState();if(s&&!s.conversation&&s.searchResult)if(t){if(!s.searchResult.groups)return;const t=[...s.searchResult.groups];for(let a=0;a<t.length;a++)if(t[a].userId==e){t.splice(a,1),this.updateState(Object(I.a)(Object(I.a)({},s),{},{searchResult:Object(I.a)(Object(I.a)({},s.searchResult),{},{groups:t})}));break}}else{if(!s.searchResult.friends)return;const t=[...s.searchResult.friends];for(let a=0;a<t.length;a++)if(t[a].userId==e){t.splice(a,1),this.updateState(Object(I.a)(Object(I.a)({},s),{},{searchResult:Object(I.a)(Object(I.a)({},s.searchResult),{},{friends:t})}));break}}},this._recordedCPUUsageTs=void 0,this.name=rc.SEARCH_CONTROLLER,this.key="windowId",this.state=Gc,this.pageLoad=0,this.curQuery="",this.countQuery=0,this.countTimeUseGlobalSearch=0,this.countSelectTopRes=0,this.cacheSearch={items:[],keywords:null},this.trackSearch=!1,this.trackSearchVietnamese=!1,this.lastTextSearch="",this.lastTextSearchTs=0,this.isShowRecentSearch=!1,this.searchDelay=this._getSearchDelaySetting(),this.closeBySendingMsg=!1,this.loadingMore=!1,this.loadingMoreFiles=!1,this.oldestTime=0,this.timeoutLog=null,this.isFirstLoadSuccess=!1,this.isSearchingMsg=!1,this.dataLoaded=null,this._innerSearchFunc=this._innerSearchFunc.bind(this),this.functionSearchByName=ui.default.throttle(this._innerSearchFunc,this.searchDelay),this.onKeywordChange=this.onKeywordChange.bind(this),this.loadMoreMessagesV2=this.loadMoreMessagesV2.bind(this),this.loadMessagesV2=this.loadMessagesV2.bind(this),this.loadMoreFiles=this.loadMoreFiles.bind(this),this.onKeyPressInput=this.onKeyPressInput.bind(this),this.onFocusInput=this.onFocusInput.bind(this),this.onBlurInput=this.onBlurInput.bind(this),this.onclickCloseSearchButton=this.onclickCloseSearchButton.bind(this),this.onClickClearSearch=this.onClickClearSearch.bind(this),this.onSearchKeyword=this.onSearchKeyword.bind(this),this.setRecentSearchFocusState=this.setRecentSearchFocusState.bind(this),this.focusSearchBox=this.focusSearchBox.bind(this),this.selectResult=this.selectResult.bind(this),this.onFileSelect=this.onFileSelect.bind(this),this.selectTopRes=this.selectTopRes.bind(this),this.listenEvents()}get sidebarController(){return this._sbc||(this._sbc=a.ModuleContainer.resolve(rc.SidebarController)),this._sbc}listenEvents(){_e.default.subscribe(((e,t)=>{switch(e){case ve.SideBarActions.FOCUS_SEARCH_INPUT:this.focusSearchBox();break;case ve.FetchActions.FRIENDS_REMOVED:this._removeSearchResult(t,!1);break;case ve.FetchActions.GROUP_LEAVE:this._removeSearchResult(t,!0);break;case ve.SideBarActions.SEARCH_FILE_DONE:this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!1}));break;case ve.SideBarActions.CLEAR_SEARCH:this.clearSearch();break;case ve.ConversationListActions.SELECT_CONVERSATION:setTimeout((()=>{this.state.highlightId!==t.userId&&this.setRecentSearchFocusState(!1,!1,!0),t.callPoint!==Q.a.JumpMessage&&this.updateStateOf("highlightId",null==t?void 0:t.userId)}),0)}}))}logSearch(e){J.p.getDebugSearch().showLogSearchFlow}updateState(e,t=!0){this.state=e,t&&Object(nc.h)(this.name,Ar.c)}isTextKey(e){return e.match(/^[a-zA-Z0-9!@#$%^&*)(+=._-|\\\[\]{}~`"\';:?/<>,-\s\n]$/)}isMultipleKeyPressed(e){return e.ctrlKey||e.metaKey||e.altKey}isKeywordStale(e){return Pc.a.formatTextSearch(e)!==Pc.a.formatTextSearch(this.state.searchText)}bindUIList(e,t){this._updateListRef(e,t)}cleanUpUIList(e){this._updateListRef(e,null)}bindUISearchInput(e){this.searchInput=e}cleanUpUISearchInput(){this.searchInput=null}_updateListRef(e,t){switch(e){case Nc.c.SEARCH_RESULT:this.searchResultList=t;break;case Nc.c.RECENT_SEARCH:this.recentSearchList=t}}resetState(){this.searchInput.value="",this.updateState(Object(I.a)({},Gc))}updateStateOf(e,t){this.state.hasOwnProperty(e)&&this.state[e]!==t&&("searchText"===e&&(this.searchInput.value=t),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{[e]:t})))}onKeyPressInput(e){if(this._isSelectAllSearchText()&&this.searchResultList&&this.isTextKey(e.key)&&!this.isMultipleKeyPressed(e)&&(this.searchResultList.openTabAll(),this.searchResultList.resetContactList()),e.which==Y.K_BACK_SPACE?this.state&&this.state.searchText&&""!==this.state.searchText&&Ia.default.logAction(12307):""===this.state.searchText&&!this.timeoutLog&&this.isTextKey(e.key)&&(this.timeoutLog=setTimeout((()=>{this.timeoutLog=null,Ia.default.logAction(1232002)}),3e3)),e.which==Y.K_ESC){if(!0===this.isShowRecentSearch){{const e=Re.default.getFullDiskChatPopupNoti();if((null==e?void 0:e.level)===kn.g.FULL&&(null==e||!e.dissmis))return}this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{isFocusOnRecentSearch:!1,isFocusSearchBox:!1})),this.searchInput&&this.searchInput.blur(),this.onCloseSearch()}""!=this.searchInput.value?this.clearSearch(!1):this.clearSearch(!0)}else if(e.which==Y.K_ENTER){let e=this.searchResultList||this.recentSearchList;if(e&&this.state.searchText){let t=e.selectFocusedConversation(!0);setTimeout((()=>{this.state.conversation?this.focusSearchBox():In.a.isThreadHidden(t)||_e.default.send(ve.ChatBoxActions.FOCUS_INPUT,{userId:t,windowId:Ar.c})}),0)}}else if(e.which==Y.K_UP||e.which==Y.K_DOWN){this.searchResultList&&Ia.default.logAction(12317);let t=this.searchResultList||this.recentSearchList;t&&(e.stopPropagation(),e.preventDefault(),e.which==Y.K_UP?t.moveUp():t.moveDown())}}onAbortSearch(){Dc.a.getInstance().abortSearch()}onKeywordChange(e,t){let s="";if(s=!e&&t?t:e.target.value,s&&(s=ui.default.ZSafeFunction((()=>s.normalize()),s)),this.countTimeUseGlobalSearch||(this.countTimeUseGlobalSearch=Oa.a.now(),this.countSelectTopRes=0),s){const e=Pc.a.formatTextSearch(this.lastTextSearch),t=Pc.a.formatTextSearch(s);ui.default.log("searching: true"),Ce.default.stagingAccount&&this._checkOnAdminMode(s),this.trackSearch||(this.trackSearch=!0,Ia.default.logAction(12318)),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchText:s})),this.countQuery=xc.next(),this.functionSearchByName(s,this.countQuery,e!==t)}else{this._resetCacheResultSearch();Dc.a.getInstance().abortSearch(),this.clearSearch(!1)}}onFocusInput(){Uc.a.onNewSession(Ar.c),this.searchInput&&""!==this.searchInput.value&&this.searchInput.select(),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{isFocusSearchBox:!0})),Ia.default.logAction(1232001)}onBlurInput(){setTimeout((()=>{this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{isFocusSearchBox:!1})),this.searchInput&&""==this.searchInput.value&&this.qosLogSearch()}),20)}onclickCloseSearchButton(e){this.setRecentSearchFocusState(!1),this.onCloseSearch(),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),Ia.default.logAction(1232003),e&&(e.stopPropagation(),e.preventDefault())}onClickClearSearch(){J.p.resetGlobalSearchMode(),this.state.conversation&&Ia.default.logAction(12314),this._resetCacheResultSearch(),this.clearSearch(!this.state.conversation),this.focusSearchBox(),Ia.default.logAction(1232006)}onSearchKeyword(e){"string"==typeof e&&this.searchInput&&(this.searchInput.value=e,this.onKeywordChange(null,e),Fc.a.addCacheKeyword(e))}onRemoveKeyword(e){"string"==typeof e&&Fc.a.removeCacheKeyword(e)}onFileSelect(e){null!=e&&e.msgId&&(this.updateStateOf("highlightId",e.msgId),this.state.searchText&&Fc.a.addCacheKeyword(this.state.searchText))}setRecentSearchFocusState(e,t=!1,s=!1){if(!s){const t=this.sidebarController.getSelectedId();if(this.state.isFocusOnRecentSearch===e||t&&this.state.highlightId===t&&!e)return}this.state.isFocusOnRecentSearch=e,e&&(this.closeBySendingMsg=!1),Object(nc.h)(this.name,Ar.c)}onCloseSearch(){var e,t;Ia.default.logAction(1232004),0==(null===(e=this.state.searchResult)||void 0===e||null===(t=e.messages)||void 0===t?void 0:t.length)&&Ia.default.logAction(1232202),this.qosLogSearch()}focusSearchBox(e=!1){this.searchInput&&(this.searchInput.focus(),e&&setTimeout((()=>{this.searchInput.select()}),0))}isSearchMode(){return!!(this.state.searchText||this.state.isFocusOnRecentSearch||this.state.isFocusSearchBox)}openRecentSearch(){this.searchInput?this.searchInput.focus():this.setRecentSearchFocusState(!0)}loadCachedMessages(e,t,s){var a,i;if(!this.dataLoaded)return void(s&&s(null,-1));let n="";if(!this.state.searchText)return;n=this.state.searchText;const r=()=>!(!this.state.searchText||!this.isKeywordStale(n)),o=!(!e||!e.timeFrom&&!e.timeTo&&"string"!=typeof e.sender),c=[],l=t?this.dataLoaded.indexCurrent:0,d=Math.min(l+20,this.dataLoaded.allSearchedMsgs.length);if(t||delete this.dataLoaded.oldestIndex,e&&e.timeFrom&&this.dataLoaded.oldestIndex&&d>=this.dataLoaded.oldestIndex)return void(s&&s(null,-1,!1));if(d<=l)return void(s&&s(null,-1,!1));this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!0}));let u=this.dataLoaded.allSearchedMsgs.slice(l,d);this.dataLoaded.indexCurrent=d;const h=a=>{let i=[];if(this.loadingMore=!1,this.isSearchingMsg=!1,r())s&&s(null,-1);else if(a&&a.listConv&&a.arr){const l=new Map(this.convDataManager.getAllConvSync().map((e=>[e.userId,e])));for(let e=0;e<a.listConv.length;++e){const t=a.listConv[e],s=l.get(t);s&&!In.a.isThreadHidden(t)&&(a.arr[e].conversation=s)}if(a.arr.forEach((t=>{if(o){if(!t.message)return;if(e&&"string"==typeof e.sender&&e.sender!==t.message.fromUid)return;if(e&&e.timeFrom&&e.timeFrom>t.message.sendDttm)return void(this.dataLoaded.oldestIndex=this.dataLoaded.indexCurrent);if(e&&e.timeTo&&e.timeTo<t.message.sendDttm)return}Object.keys(t.conversation).length>1&&i.push(t)})),Array.prototype.push.apply(c,i),!r()&&this.isFirstLoadSuccess){if(t&&this.state.searchResult.messages){var n;const e=null===(n=this.state.searchResult.messages[this.state.searchResult.messages.length-1])||void 0===n?void 0:n.message;e&&e.sendDttm<a.maxTime?(i=this.state.searchResult.messages.concat(i),i=i.sort(((e,t)=>t.message.sendDttm-e.message.sendDttm))):i=this.state.searchResult.messages.concat(i)}this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{isMoreMsg:d<this.dataLoaded.allSearchedMsgs.length,messages:i}),searching:!1}));const r=!(o&&e.timeFrom&&d>=this.dataLoaded.allSearchedMsgs.length);s&&s(c,this.pageLoad,r)}}};Lc.a.logTrace(`load more msg with key ${Hc(n)} - msgID length: ${u.length} - ${d}/${null===(a=this.dataLoaded)||void 0===a||null===(i=a.allSearchedMsgs)||void 0===i?void 0:i.length}`),this.isSearchingMsg=!0;Dc.a.getInstance().getMessages(u,r).then((e=>{h(e)})).catch((e=>{s&&s(null,-1)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!1}))}))}loadMessagesV2(e,t=!1,s){return this.loadCachedMessages(e,t,s)}loadMoreMessagesWithMsgIdsLoaded(e,t=!1,s){return this.loadCachedMessages(e,t,s)}isCanLoadMoreWithMsgIdsLoaded(){return!!(this.dataLoaded&&ui.default.valueValid(this.dataLoaded.indexCurrent)&&ui.default.valueValid(this.dataLoaded.allSearchedMsgs))&&!(this.dataLoaded.allSearchedMsgs.length<=this.dataLoaded.indexCurrent)}loadMoreMessagesWithRange(e,t,s,a){var i,n,r;let o=this.state.searchText;if(!o)return;let c=null===(i=this.searchResultList)||void 0===i?void 0:i.getRange(!t);if(!this.oldestTime||c.timeTo<this.oldestTime)return;const l=!(!a||!a.timeFrom&&!a.timeTo&&"string"!=typeof a.sender),d=()=>!(!this.state.searchText||!this.isKeywordStale(o));this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:t?null===(n=this.state.searchResult)||void 0===n?void 0:n.messages:null,isMoreMsg:!!t&&(null===(r=this.state.searchResult)||void 0===r?void 0:r.isMoreMsg)}),searching:!0}));const u=e=>{this.isSearchingMsg=!1;let i=[],n=[];if(d())return this.pageLoad++,void(s&&s(null,-1));if(!e||!e.listConv||!e.arr)return void(s&&s(null,-1));const r=new Map(this.convDataManager.getAllConvSync().map((e=>[e.userId,e])));for(let t=0;t<e.listConv.length;++t){const s=e.listConv[t],a=r.get(s);a&&!In.a.isThreadHidden(s)&&(e.arr[t].conversation=a)}e.arr.forEach((e=>{l&&a&&"string"==typeof a.sender&&a.sender!==e.message.fromUid||Object.keys(e.conversation).length>1&&n.push(e)})),Array.prototype.push.apply(i,n),t&&(n=this.state.searchResult.messages.concat(n)),this.dataLoaded?(e.dataLoaded.allSearchedMsgs&&(this.dataLoaded.allSearchedMsgs=this.dataLoaded.allSearchedMsgs.concat(e.dataLoaded.allSearchedMsgs)),e.dataLoaded.indexCurrent&&(this.dataLoaded.indexCurrent+=e.dataLoaded.indexCurrent)):this.dataLoaded=e.dataLoaded;const o=!(l&&a.timeFrom&&n.length<this.dataLoaded.allSearchedMsgs.length);this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:n,isMoreMsg:!(!n.length&&!this.dataLoaded.allSearchedMsgs.length)&&n.length<this.dataLoaded.allSearchedMsgs.length}),searching:!1})),s&&s(i,this.pageLoad,o)};let h={totalItemReq:4};Lc.a.logTrace(`load more msg with range: ${c.timeFrom} - ${c.timeTo}`),this.isSearchingMsg=!0;Dc.a.getInstance().searchGlobalMessagesV3(o,d,void 0,null,Ce.default.limit_result_msg_search+1,c,h).then((e=>u(e))).catch((e=>{this.loadingMore=!1,s&&s(null,-1),ui.default.logCoreError("searchGlobalMsg v2 "+e)})).finally((()=>{this.isSearchingMsg=!1,this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!1}))}))}loadMoreMessagesV2(e,t=!1,s,a){if(this.isFirstLoadSuccess&&!this.isSearchingMsg)return Ce.default.enable_optimize_search&&!jc.a.isSearchOnSqlite3()?this.loadCachedMessages(a,t,s):t&&this.isCanLoadMoreWithMsgIdsLoaded()?this.loadMoreMessagesWithMsgIdsLoaded(a,t,s):(t||(this.dataLoaded=null),this.loadMoreMessagesWithRange(e,t,s,a));s&&s(null,-1)}loadMoreMessages(){let e=this.state.searchResult;if(jc.a.isSearchOnSqlite3()&&e&&e.rawSearchResult&&e.messageList&&e.rawSearchResult.length>e.lastOffset&&!this.loadingMore){this.loadingMore=!0;const t=this.state.conversation.userId;Dc.a.getInstance().getMessageOfConversation(e.rawSearchResult,this.state.conversation.userId,20,e.lastOffset).then((s=>{let a=s.list;if(this.state.conversation&&t==this.state.conversation.userId){let t=ui.default.ZSafeFunction((()=>Math.max(0,e.rawSearchResult.length-e.lastOffset-20)+e.messageList.length+a.length),s.len);a.length>0?this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messageList:this.state.searchResult.messageList.concat(a.map((e=>({message:e,conversation:this.state.conversation})))),realLen:t,lastOffset:this.state.searchResult.lastOffset+20})})):this.state&&this.state.searchResult&&(this.state.searchResult.realLen!==t?this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{realLen:t,lastOffset:e.lastOffset+20})})):this.state.searchResult.lastOffset+=20)}this.loadingMore=!1}))}}loadMoreFiles(){let e=this.state.searchResult,t=this.state.searchText;if(e&&e.rawFileResult&&e.files&&e.rawFileResult.length>e.lastFileOffset&&!this.loadingMoreFiles){this.loadingMoreFiles=!0;const s=e.rawFileResult.slice(e.lastFileOffset,e.lastFileOffset+20),i=new Map;s.forEach((e=>{const t=e.convId;i.has(t)||i.set(t,[]),i.set(t,i.get(t).concat(e.msgId))}));const n=a.ModuleContainer.resolve(we.a),r=[];i.forEach(((e,t)=>{r.push(n.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(r).then((a=>{if(this.loadingMoreFiles=!1,this.isKeywordStale(t))return;e=this.state.searchResult;const i=s.map((e=>{const t=a.find((t=>t.convID===e.convId));if(t)return t.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let n=ui.default.ZSafeFunction((()=>Math.max(0,e.rawFileResult.length-e.lastFileOffset-20)+e.files.length+i.length),e.realFileLen),r=this.state.searchResult.files.concat(i);r.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm))),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{files:r,realFileLen:n,lastFileOffset:e.lastFileOffset+20})}))})).catch((e=>{this.loadingMoreFiles=!1,ui.default.logCoreError("_loadMoreFiles ",e)}))}}qosLogSearch(){this.countTimeUseGlobalSearch&&(kc.default.increaseSuccess(97111,0,Oa.a.now()-this.countTimeUseGlobalSearch),this.countTimeUseGlobalSearch=0),this.countSelectTopRes>=0&&(kc.default.increaseSuccess(97112,0,this.countSelectTopRes),this.countSelectTopRes=-1)}selectTopRes(){this.countSelectTopRes>=0&&this.countSelectTopRes++}selectResult(e,t=!1,s=!1,a=!1){var i;const n=Ce.default.search_message.global.enable_ux_enhance?Pc.a.formatTextSearch(this.state.searchText):this.state.searchText;let r=!!this.state.conversation;ho.default.jumpToMessage(e.message,null===(i=e.conversation)||void 0===i?void 0:i.userId,tc.f).then((t=>{const{groupMsgs:s=[]}=t;let a=null;ui.default.ZSafeFunction((()=>{if(s)for(let t=0;t<s.length;t++)if(s[t].msgId==e.message.msgId)return a=Object(I.a)({},s[t]),void(a.searchKeyWord=n)}),null),this.state.searchText&&Fc.a.addCacheKeyword(this.state.searchText),_e.default.send(ve.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:s,focusId:[""+e.message.msgId],conversation:e.conversation}),a&&Object(tc.f)({type:ve.ChatBoxActions.UPDATE_MESSAGE_ATTRIBUTES,payload:a})})).catch((t=>{ui.default.logCoreError(t),mc.default.createWarning(ce.a.str("STR_MESSAGE_NOT_FOUND")),a||_e.default.send(ve.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH,{messages:[],focusId:[],conversation:e.conversation})})),r?(s&&this.focusSearchBox(),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{highlightId:e.message.msgId}))):t||this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{highlightId:e.message.msgId}))}getRecentSearchItems(){if(0===Ce.default.recent_search.is_enable)return[];let e=Fc.a.getLocalRecentSearchList();if(!e)return[];let t=yn.default.getGroupsListSync(),s=t||[];return e=e.filter((e=>{if(e&&e.userId&&!In.a.isThreadHidden(e.userId)){if(e.userId.startsWith(Y.GROUPID_PREFIX)||1===e.type){let t=!1;1!==e.type||e.userId.startsWith(Y.GROUPID_PREFIX)||(e.userId=Y.GROUPID_PREFIX+e.userId);for(let a of s)if(a.userId&&e.userId==a.userId){t=!0;break}return!!t||(Fc.a.removeLocalRecentSearchList(e.userId),!1)}return!0}return!1})),e}getCacheRecentSearch(){return this.cacheSearch.items=this.getRecentSearchItems(),Ce.default.sync_recent_search.enable_kw&&(this.cacheSearch.keywords=Fc.a.getLocalKeywordList()),this.cacheSearch}getPageLoad(){return this.pageLoad}getSearchInputRef(){return this.searchInput}getSearchState(){return this.state}clearSearch(e=!0){if(this._resetCacheResultSearch(),this.onAbortSearch(),this.dataLoaded=null,this.searchInput.value="",this.lastTextSearch="",e){if(Ac.b.setMode(Ac.a.NORMAL),this.updateState(Object(I.a)({},Gc)),this.sidebarController.getState(Ar.c).currentTab==rc.SidebarTab.FILE_TAB)return void this.functionSearchByName(null,this.countQuery,!0)}else this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchText:"",searching:!0,highlightId:""})),this.functionSearchByName("",this.countQuery,!0)}_resetCacheResultSearch(){this.curQuery="",this.cacheResSearch=null,this.trackSearch=!1,this.trackSearchVietnamese=!1}_checkOnAdminMode(e){let t=this.__checkOnAdminMode(e);t&&(1===t?(this.clearAdminMode&&clearTimeout(this.clearAdminMode),Ce.default.adminMode=!0,this.sidebarController.togglePerfTab(!0),this.clearAdminMode=setTimeout((()=>{this.clearAdminMode=void 0,Ce.default.adminMode=void 0,this.sidebarController.togglePerfTab()}),216e5)):2===t&&(this.clearAdminMode&&(clearTimeout(this.clearAdminMode),this.clearAdminMode=void 0),Ce.default.adminMode=!1,this.sidebarController.togglePerfTab(!1)))}__checkOnAdminMode(e){if(e&&"string"==typeof e&&e.startsWith("$##")){return e.substring(3)===Ce.default.zAminKey?1:2}return 0}_innerSearchFunc(e,t,s=!0){if(!xc.valid(t))return;if(this.sidebarController.getState(Ar.c).currentTab===rc.SidebarTab.FILE_TAB)_e.default.send(ve.SideBarActions.SEARCH_FILE,{term:e});else if(this.state.conversation)this.filterByConversation(e,this.state.conversation);else{const t=s&&this.isKeywordStale(this.lastTextSearch),i=Pc.a.formatTextSearch(e);var a;if(this.logSearch(`[Search flow] start search-------: ${t}, ${Hc(i)}`),!i)null===(a=this.searchResultList)||void 0===a||a.forceStopSearch(),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:null,files:[],rawFileResult:[]})}));this._searchGlobal(e,t)}}debounceSearchMsgAndFile(e,t){this._timeDebounceSearch&&clearTimeout(this._timeDebounceSearch),this._timeDebounceSearch=setTimeout((()=>{e()}),t)}getTimeDebounceSearchMsgAndFile(){return Dc.a.getInstance().isEnableSearchSqlite?Ce.default.debounce_search_msg:Ce.default.debounce_search_msg_optimize}_searchGlobal(e,t=!0){var s,i,n,r,o,c;Fa.default.createCPUUsageRecorder(Fa.CPUMetricName.search_global).start().then((e=>this._trackCPUUsageOnSearching(e))),this.lastTextSearchTs=Date.now(),this.lastTextSearch=e;let l=2,d=0,u={},h=this.convDataManager.getAllConvSync(),g=this.previewDataManager.getAllPreviewsForSearch(),m=ui.default.simpleStripVietnamese(e,!1);const p=(s,a)=>{s!==Vc.STEP_DIRECTORY&&s!==Vc.STEP_FILES&&l--;let i,n=1==l&&s===Vc.STEP_CONTACT&&0==d;if(i=!!(l>1||n),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:a,searching:i})),s===Vc.STEP_CONTACT&&t&&(Ce.default.enable_optimize_search?this.debounceSearchMsgAndFile((()=>{f()?Lc.a.logTrace(`abort debound search msg: ${Hc(e)}`):(Lc.a.logTrace(`do search msg & file: ${Hc(e)}`),_(a&&!a.all.length),Ce.default.tabbedGlobalSearchResult&&Ac.b.setMode(Ac.a.SEARCHING),Ce.default.enableFileGlobalSearch&&v())}),this.getTimeDebounceSearchMsgAndFile()):(_(a&&!a.all.length),Ce.default.tabbedGlobalSearchResult&&Ac.b.setMode(Ac.a.SEARCHING),Ce.default.enableFileGlobalSearch&&v())),0==l&&!this.isKeywordStale(e)){let e=Date.now()-this.lastTextSearchTs;e>2e3?this._upSearchDelay():e<600&&this._downSearchDelay()}this.isKeywordStale(e)||this._trackPerformanceSearch(s,a,Date.now()-this.lastTextSearchTs)},f=()=>!!this.isKeywordStale(e),v=()=>{if(Ce.default.adminConfig&&Ce.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(Vc.STEP_FILES,this.state.searchResult)}),100);const t=(t,s=!0)=>{var i,n;if(this.isKeywordStale(e))return;(null!=t&&t.length||!s)&&Bc.a.fileUIVisible(Oa.a.now(),(null==t?void 0:t.length)||0);let r=new Set;const o=[];var c,l,u,h,g,m;if((t.forEach((e=>{const t=e.msgId;t&&!r.has(t)&&(r.add(t),o.push({msgId:t,convId:e.convId}))})),(null===(i=this.state.searchResult)||void 0===i||null===(n=i.rawFileResult)||void 0===n?void 0:n.length)>=20&&(null==o?void 0:o.length)>=20)&&((null===(c=this.state.searchResult)||void 0===c||null===(l=c.rawFileResult[0])||void 0===l?void 0:l.msgId)==(null===(u=o[0])||void 0===u?void 0:u.msgId)&&(null===(h=this.state.searchResult)||void 0===h||null===(g=h.rawFileResult[19])||void 0===g?void 0:g.msgId)==(null===(m=o[19])||void 0===m?void 0:m.msgId)))return void this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{rawFileResult:o,realFileLen:o.length})}),!1);const f=o.slice(0,20),v=new Map;f.forEach((e=>{const t=e.convId;v.has(t)||v.set(t,[]),v.set(t,v.get(t).concat(e.msgId))}));const _=a.ModuleContainer.resolve(we.a),b=[];v.forEach(((e,t)=>{b.push(_.getMultiMedias("file",t,e).then((e=>({convID:t,media:e}))))})),Promise.all(b).then((t=>{if(this.isKeywordStale(e))return;const s=f.map((e=>{const s=t.find((t=>t.convID===e.convId));if(s)return s.media.find((t=>t.msgId===e.msgId))})).filter(Boolean);let a=[],i=0,n=0;for(const e of s)e?(a.push(e),i++):n++;a.sort(((e,t)=>parseInt(t.sendDttm)-parseInt(e.sendDttm)));let r=this.state.searchResult;ui.default.log("search files: cur = "+r.searchKey+" this query = "+Hc(e),a.length),r=r?Object(I.a)({},r):{},r.files=a,r.realFileLen=o.length-n,r.rawFileResult=o,r.lastFileOffset=f.length,r.searchKey=e,d+=i,p(Vc.STEP_FILES,r)})).catch((t=>{ui.default.logCoreError("doSearchFiles "+t),this.state&&!this.isKeywordStale(e)&&p(Vc.STEP_FILES,this.state.searchResult)}))};Bc.a.startQueryFile(Oa.a.now());Dc.a.getInstance().search(e,null,{msgType:Y.MSG_FILE},t,{enableReject:!0}).then((e=>{t(e,!1)})).catch((e=>{this.state.searchResult.files&&this.state.searchResult.files.length||this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{files:[]})}),!0)}))},_=(t=!1)=>{if(Ce.default.adminConfig&&Ce.default.adminConfig.offglobalSearchMessage)return setTimeout((()=>{this.state&&!this.isKeywordStale(e)&&p(Vc.STEP_MESSAGES,this.state.searchResult)}),100);this.logSearch(`[Search flow] search msg: ${Hc(e)}`);const s=(t,s=!1)=>{var a;if(s&&(this.isSearchingMsg=!1),this.logSearch(`[Search flow] search msg res first load: ${Hc(e)}, ${null===(a=t.arr)||void 0===a?void 0:a.length}`),this.pageLoad=0,this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1,this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:null})}),!1)),!this.isKeywordStale(e)&&t){let a=[],r=0;t&&t.listConv&&t.arr&&h.forEach((e=>{let s=t.listConv.indexOf(e.userId);if(s>=0&&!In.a.isThreadHidden(e.userId))for(let i=s;i<t.listConv.length;++i)t.listConv[i]==e.userId&&(t.arr[i].conversation=e,r+=1,a.push(t.arr[i]))}));let o=this.state.searchResult,c=a;var i;if(o.messages&&(c=o.messages.slice(),Array.prototype.push.apply(c,a)),c.sort(((e,t)=>parseInt(t.message.sendDttm)-parseInt(e.message.sendDttm))),o=o?Object(I.a)({},o):{},o.messages=c,o.searchKey=e,o.isMoreMsg=t.isMoreMsg,this.dataLoaded=t.dataLoaded,d+=r,s)this.isFirstLoadSuccess=!0,this.searchResultList&&n&&this.searchResultList.updateFirstLoadPos(n.timeFrom),ui.default.logCoreError("[Global search] check First data",Hc(e),null===(i=this.state.searchResult.messages)||void 0===i?void 0:i.length);else if(!a.length)return;p(Vc.STEP_MESSAGES,o)}};let a=null;var i;this.searchResultList&&(!this.timeouResetDataMsg&&this.state.searchResult.messages&&(this.timeouResetDataMsg=setTimeout((()=>{this.timeouResetDataMsg=!1,this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:null})})),this.searchResultList&&this.searchResultList.resetDataSearch()}),1e3)),this.searchResultList.resetDataSearch(),jc.a.isSearchOnSqlite3()&&(a=null===(i=this.searchResultList)||void 0===i?void 0:i.getRange(),this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{filter:{timeFrom:a.timeFrom,timeTo:a.timeTo}}),!1)));const n=Object(I.a)({},a);this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{searching:!0,highlightId:"",searchResult:Object(I.a)(Object(I.a)({},this.state.searchResult),{},{messages:!this.lastTextSearch||e.length<this.lastTextSearch.length?null:this.state.searchResult.messages})})),this.loadingMore=!1,this.isFirstLoadSuccess=!1;let r={};t||(r.totalItemReq=4);const o=Dc.a.getInstance();Bc.a.startQueryMsg(Oa.a.now(),o.isEnableSearchSqlite),this.isSearchingMsg=!0,o.searchGlobalMessagesV3(e,(()=>!(!jc.a.isSearchOnSqlite3()||this.state.filter.timeFrom==n.timeFrom&&this.state.filter.timeTo==n.timeTo)||f()),void 0,s,Ce.default.limit_result_msg_search+1,a,r).then((e=>s(e,!0))).catch((t=>{if(this.logSearch(`[Search flow] search msg fail: ${t}`),ui.default.logCoreError("searchGlobalMsg "+t),this.state&&!this.isKeywordStale(e)){this.searchResultList&&this.searchResultList.forceStopSearch(),this.timeouResetDataMsg&&(clearTimeout(this.timeouResetDataMsg),this.timeouResetDataMsg=!1);let e=this.state.searchResult;e.messages=[],p(Vc.STEP_MESSAGES,e)}})).finally((()=>{this.isSearchingMsg=!1}))};if(this.curQuery&&0!==e.indexOf(this.curQuery)&&this._resetCacheResultSearch(),!this.cacheResSearch){const e=e=>{for(const t of e){const e=t.userId||t.convId;t&&!u[e]&&(null!=t&&t.userId||(t.userId=e),null!=t&&t.infoSearch&&delete t.infoSearch,null!=t&&t.isDirectory&&delete t.isDirectory,u[e]=t)}};g.length&&e(g),e(Ii.default.getFriendsSync()),e(yn.default.getGroupsListSync())}const b=Oa.a.now();Bc.a.setKeyword(e),Bc.a.resetTracking(),Yr.a.search(e,this.cacheResSearch?this.cacheResSearch:u,{hasSection:!0,suggestGroupWithMember:!0,searchFriendInGroup:!0,isCalc:!0,updateLastChat:!this.cacheResSearch,searchPb:!0,searchZName:!0,searchNumPhone:!0,filterHidden:In.a.isKeyPIN(e)}).then((t=>{var s;Bc.a.trackingContact(Oa.a.now()-b,null==t||null===(s=t.all)||void 0===s?void 0:s.length);let a=this.state.searchResult;if(!this.isKeywordStale(e)){{var i;let s=[];if(In.a.isKeyPIN(e)){Ia.default.logAction(1970601);const e=In.a.getUidsHiddenChat();if(e.length)for(let t of e){let e=!1;for(let a of h)if(a&&a.userId==t){s.push(Object(I.a)(Object(I.a)({},a),{},{infoSearch:{}})),e=!0;break}if(!e){let e=null;e=t.startsWith(Y.GROUPID_PREFIX)?yn.default.getGroupByIdSync(t):Ii.default.getProfileFriendSync(t),e&&(e.lastMessageTime||(e.lastMessageTime=0),s.push(Object(I.a)(Object(I.a)({},e),{},{infoSearch:{}})))}}}this.curQuery||(this.curQuery=e),!this.cacheResSearch&&t.orderAll&&t.orderAll.constructor==Array&&t.orderAll.length>0&&(this.cacheResSearch=u),null!==(i=t.phone)&&void 0!==i&&i.length&&(t.phone=t.phone.filter((e=>e.userId))),a=a?Object(I.a)({},a):{},a.recentChat=t.recentChat,a.groups=t.groups,a.friends=t.friends,a.oa=t.oa,a.directory=t.directory,a.searchKey=e,a.phone=t.phone,a.hiddenChat=s,a.all=t.all,a.orderAll=t.orderAll,d+=(a.groups?a.groups.length:0)+(a.friends?a.friends.length:0)+(a.oa?a.oa.length:0),d+=(a.recentChat?a.recentChat.length:0)+a.hiddenChat.length}p(Vc.STEP_CONTACT,a)}})).catch((e=>{ui.default.logCoreError(e)})),0==(null===(s=this.state.searchResult)||void 0===s||null===(i=s.messages)||void 0===i?void 0:i.length)&&0==(null===(n=this.state.searchResult)||void 0===n||null===(r=n.all)||void 0===r?void 0:r.length)&&0==(null===(o=this.state.searchResult)||void 0===o||null===(c=o.files)||void 0===c?void 0:c.length)&&Ia.default.logAction(1232201),m===e||this.trackSearchVietnamese||(this.trackSearchVietnamese=!0,Ia.default.logAction(1232010))}filterByConversation(e,t){if(!e)return this.searchInput.value="",void this.updateState(Object(I.a)(Object(I.a)({},Gc),{},{conversation:t,searching:!1,highlightId:""}));let s=(s,a=!1)=>{if(this.isKeywordStale(e))return void ui.default.logCoreError("search: abort filtermode 1",Hc(this.state.searchText),Hc(e));if(a&&(!s||0==s.length))return;Dc.a.getInstance().getMessageOfConversation(s,t.userId,20).then((i=>{if(this.isKeywordStale(e))return void ui.default.logCoreError("search: abort filtermode 2",Hc(this.state.searchText),Hc(e));let n=i.list;if(a&&(!n||0===n.length))return;let r=n.length<20&&s.length>20;n.length>0?(this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{conversation:t,searchResult:{messageList:n.map((e=>({message:e,conversation:t}))),realLen:i.len,rawSearchResult:s,lastOffset:20,progress:a},searching:!1,highlightId:n[0].msgId})),a||(this.focusSearchBox(),r&&this.loadMoreMessages()),!a&&this.searchResultList&&this.searchResultList.scrollToTop&&this.searchResultList.scrollToTop()):(this.updateState(Object(I.a)(Object(I.a)({},this.state),{},{conversation:t,searchResult:{messageList:[],realLen:0,lastOffset:0,progress:!1},searching:!1,highlightId:""})),this.focusSearchBox(),!a&&r&&this.loadMoreMessages())}))};Dc.a.getInstance().search(e,null,{convId:t.userId+""},(e=>{s(e,!0)})).then((e=>{s(e)}))}_getSearchDelaySetting(){return 70}_upSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.min(400,Math.round(1.1*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_downSearchDelay(){let e=this.searchDelay;this.searchDelay=Math.max(70,Math.round(.9*this.searchDelay+10*Math.random())),e!==this.searchDelay&&this._resetSearchFunction()}_resetSearchFunction(){ui.default.logCoreError("__rssf__",this.searchDelay),this.functionSearchByName=ui.default.throttle(this._innerSearchFunc,this.searchDelay)}_isSelectAllSearchText(){if(this.searchInput){const e=this.searchInput.selectionStart,t=this.searchInput.selectionEnd;return!(!this.searchInput.value.length||0!=e||t!=this.searchInput.value.length)}return!1}_trackPerformanceSearch(e,t,s){var a,i,n,r,o;const c={[Vc.STEP_MESSAGES]:"msg",[Vc.STEP_FILES]:"file",[Vc.STEP_CONTACT]:"contact"}[e];let l={[Vc.STEP_MESSAGES]:null==t||null===(a=t.messages)||void 0===a?void 0:a.length,[Vc.STEP_FILES]:null==t||null===(i=t.files)||void 0===i?void 0:i.length,[Vc.STEP_CONTACT]:((null==t||null===(n=t.groups)||void 0===n?void 0:n.length)||0)+((null==t||null===(r=t.friends)||void 0===r?void 0:r.length)||0)+((null==t||null===(o=t.oa)||void 0===o?void 0:o.length)||0)}[e]||0;if(c&&l){Object(zc.b)().logInfo(zc.a.GlobalSearch,{duration:s,search_type:c,result_size:l})}}_trackCPUUsageOnSearching(e){if(!e||this._recordedCPUUsageTs&&this._recordedCPUUsageTs>=e.endAt)return;this._recordedCPUUsageTs=e.endAt;Object(zc.b)().logInfo(zc.a.CPU_GlobalSearch,{cpu:e.cpu,duration:e.endAt-e.startAt,process:e.processes.map((e=>({cpu:e.cpu,name:e.name,type:e.type})))})}init(){}getItem(e){return this.state}getList(e){throw new Error("No imp!!!")}onGetItemFailure(e){}onGetListFailure(e){}onApplicationReady(){this.loadOldestTime()}loadOldestTime(){this.loadOldestTimeWithRetry(Ce.default.sqlite_mac.max_load_oldest_time_retry).then((e=>{this.oldestTime=e})).catch((e=>{Lc.a.logError("loadOldestTime fail after retrying",e),this.oldestTime=0}))}async loadOldestTimeWithRetry(e){return new Promise(((t,s)=>{Dc.a.getInstance().getOldestTime().then((e=>{e&&e.length&&!isNaN(e[0].ts)?t(Math.max(+e[0].ts,1e12)):t(0)})).catch((a=>{Lc.a.logError("loadOldestTime fail",`remaining times: ${e}`,a),e>0?setTimeout((()=>{this.loadOldestTimeWithRetry(e-1).then(t).catch(s)}),0):s(a)}))}))}getOldestTime(){return this.oldestTime}getTotalQueriedMsgIds(){var e,t;return null===(e=this.dataLoaded)||void 0===e||null===(t=e.allSearchedMsgs)||void 0===t?void 0:t.length}})||wc)||wc)||wc)||wc)||wc)||wc);var Wc,qc=s("dThN"),Kc=s("jnrz"),Zc=s("Anfm"),$c=s("BZLJ"),Qc=s("L+5E"),Yc=s("BKm0"),Jc=s("iKSP"),Xc=s("uglG"),el=s("oMqy");const tl={windowId:Ar.c,theme:Zr.e.LIGHT,currentTab:rc.SidebarTab.MESSAGE_TAB,previousTab:rc.SidebarTab.MESSAGE_TAB,selectedId:null,previousId:null,showExportImportEntry:!0},sl="z_sendtome_bubbledot",al="SIDEBAR CONTROLLER";function il(...e){ui.default.logCoreInfo(`[${al}] - `,e)}Object(m.j)()(Wc=Object(xi.b)(rc.SidebarController)(Wc=function(e,t){return a.ModuleContainer.inject(rc.ConvListController)(e,void 0,0)}(Wc=function(e,t){return a.ModuleContainer.inject(Nc.b)(e,void 0,1)}(Wc=Reflect.metadata("design:type",Function)(Wc=Reflect.metadata("design:paramtypes",[void 0===rc.ConvListController?Object:rc.ConvListController,void 0===Nc.b?Object:Nc.b])(Wc=class{constructor(e,t){this.convListController=e,this.searchController=t,this.changeTabFromSearch=void 0,this._firstTimePageLoad=void 0,this._querySelect=void 0,this._convsLoaded=void 0,this._exportImportFinished=void 0,this._exportImportProgressError=void 0,this._allowAutoJumpFC=void 0,this._es=void 0,this._onSendMsg=e=>{var t,s;const a=(null==e||null===(t=e.messages)||void 0===t||null===(s=t[0])||void 0===s?void 0:s.upSrc)&Y.FILE_UP_SRC.TextEditor,i=this.getState();if(i.currentTab==rc.SidebarTab.TODO_TAB||i.currentTab==rc.SidebarTab.CATALOG_TAB||a||e.isChild)return;const n=this.searchController.getSearchState();i.currentTab!==rc.SidebarTab.MESSAGE_TAB||n&&n.searchText?(i.currentTab=rc.SidebarTab.MESSAGE_TAB,Object(nc.h)(this.name,Ar.c),Object(tc.f)({type:ve.SideBarActions.SHOW_CHAT_VIEW}),n&&n.searchText&&Ia.default.logAction(1232007),this.searchController.clearSearch(!0)):i.currentTab==rc.SidebarTab.MESSAGE_TAB&&this.searchController.setRecentSearchFocusState(!1,!1,!0),this.searchController.closeBySendingMsg=!0,setTimeout((()=>{this.convListController.scrollToTop(!1)}),100)},this.changeTab=(e,t=Ar.c)=>{const s=this._getStateByWindowId(t);let a=s.currentTab;s.currentTab!==e&&(s.currentTab=e,Object(nc.h)(this.name,t)),this._onChangeTab(s.currentTab,a)},this.togglePerfTab=e=>{const t=this._getStateByWindowId(Ar.c);t.showPerfTab!==e&&(t.showPerfTab=e,Object(nc.h)(this.name,Ar.c))},this.changeTheme=async e=>{},this.selectMessageTab=()=>{this.changeTab(rc.SidebarTab.MESSAGE_TAB)},this.selectTodoTab=()=>{this.changeTab(rc.SidebarTab.TODO_TAB),Ia.default.logAction(171),$c.default.setViewPopupTodoSrc($c.POPUP_TODO_SRC.TAB_ICON)},this.selectContactFromSearch=async(e,t=!1)=>{if(!e)return il("Select friend null!"),Promise.resolve(!1);const s=await a.ModuleContainer.resolve(Q.b).openConversation(e.userId,Q.d.fromSearchList(e));return!0===t?(this.searchController.onCloseSearch(),this.searchController.resetState()):this.searchController.updateStateOf("highlightId",e.userId),s?(e&&e.userId===Ce.default.sendToMeId&&(Me.g.getFlagForCurrentUser(this.currUser.userId,sl)||(J.p.getHasShownSendToMeTip()?Me.g.setFlagForCurrentUser(this.currUser.userId,sl,1):setTimeout((()=>{_e.default.send(ve.ConversationListActions.SHOW_BUBBLE_DOT),J.p.setHasShownSendToMeTip(!0)}),144e5)),Ia.default.logAction(1390101)),Promise.resolve(!0)):(il("Open conv failure"),Promise.resolve(!1))},this.setupSelectConvOnPageLoad=()=>{},this.name=rc.SIDEBAR_CONTROLLER,this.data=new Map,this.key="windowId",this.changeTabFromSearch=!1,this._firstTimePageLoad=!0,this._convsLoaded=!1,this._allowAutoJumpFC=!1,this.selectConversationForFriend=this.selectConversationForFriend.bind(this),this.listenEvents()}get currUser(){return Object(gc.c)()}get autoJumFC(){return this._allowAutoJumpFC}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}onStart(e){a.ModuleContainer.resolve(Q.b)}listenEvents(){_e.default.subscribe(((e,t)=>{switch(e){case ve.ChatBoxActions.SEND_MSG:this._onSendMsg(t);break;case ve.ChatBoxActions.SELECT_FRIEND:this.selectConversationForFriend(t);break;case ve.SideBarActions.SHOW_FILE_MANAGER:this.getState().currentTab=rc.SidebarTab.FILE_TAB,Object(nc.h)(this.name,Ar.c);break;case ve.SideBarActions.SELECT_TAB_MSG:this.changeTab(rc.SidebarTab.MESSAGE_TAB);break;case ve.FetchActions.DELETE_CONVERSATION:case ve.FetchActions.GROUP_LEAVE:{const e=this.getState();e.previousId&&t===e.previousId&&(e.previousId=null);break}case ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:case ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH:this.getState().currentTab!=rc.SidebarTab.FILE_TAB&&this.getState().currentTab!=rc.SidebarTab.ZCLOUD_TAB&&this.getState().currentTab!=rc.SidebarTab.KIKI_ASSISTANT_TAB||this.changeTab(rc.SidebarTab.MESSAGE_TAB);break;case ve.TodoActions.OPEN_TODO_LIST:{const e=fc.b.instance().getTodoView();e?e.onCheckOpenTab():this.changeTab(rc.SidebarTab.TODO_TAB);break}case ve.ActionList.ACT_OPEN_TAB_CHAT:this.selectMessageTab();break;case ve.ActionList.ACT_OPEN_TAB_CONTACT:this.changeTab(rc.SidebarTab.CONTACT_TAB);break;case ve.ActionList.ACT_OPEN_GROUPLIST:if(this.getState().currentTab===rc.SidebarTab.CONTACT_TAB){const e=fc.b.instance().getContactList();e&&e.onJumpGroupCenter()}else this.changeTab(rc.SidebarTab.CONTACT_TAB);break;case Yc.c.EXPORT_IMPORT_START:this._exportImportFinished=!1,this._exportImportProgressError=!1;break;case Yc.c.EXPORT_IMPORT_FINISHED:this._exportImportFinished=!0,this._exportImportProgressError=!1;break;case Yc.c.IMPORT_DB_PROGRESS:case Yc.c.IMPORT_PROGRESS:case Yc.c.EXPORT_PROGRESS:case Yc.c.EXPORT_DB_PROGRESS:t&&t.error&&(this._exportImportProgressError=!0);break;case ve.ConversationListActions.SELECT_CONVERSATION:{const e=this.getState();e.currentTab!==rc.SidebarTab.FILE_TAB&&e.currentTab!==rc.SidebarTab.CATALOG_TAB&&e.currentTab!==rc.SidebarTab.ZCLOUD_TAB&&e.currentTab!==rc.SidebarTab.KIKI_ASSISTANT_TAB||this.changeTab(rc.SidebarTab.MESSAGE_TAB);break}}})),me.a.ConvInfoDataManager.addEventListener(ai.b.DoneLoadDB,(e=>{this._convsLoaded=!0,this._autoSelectConv()})),me.a.UnreadDataManager.addEventListener(ai.b.DoneLoadDB,(e=>{Kc.b.onDoneLoadUnreadDB(null==e?void 0:e.payload)}))}getState(e=Ar.c){return this._getStateByWindowId(e)}getSelectedId(e){return this.getState(e).selectedId||null}getCurrMainConvId(){const e=this.eventStore.getState();return e&&e.chatview.view===Jc.c.CHAT_VIEW?this.getSelectedId():null}updateSelectedId(e,t=Ar.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=e?null:s.selectedId,s.selectedId=e,Object(nc.h)(this.name,t))}updateSelectedIdWithoutPrevious(e,t=Ar.c){const s=this._getStateByWindowId(t);s.selectedId!==e&&(s.previousId=null,s.selectedId=e,Object(nc.h)(this.name,t))}isInImportExportProcess(){const e=this._exportImportFinished||this._exportImportProgressError;return void 0!==e&&!e}openFriendCenter(){}selectConversationForFriend(e,t=!1){if(!e)return void ui.default.logCoreError("friend null");if(tc.f&&(Object(tc.f)({type:ve.ConversationListActions.SELECT_CONV_MINOR,payload:e}),Object(tc.f)({type:ve.ChatBoxActions.READ_CONVERSATION,payload:{conversationId:e.userId}})),e.userId==this.currUser.userId)return void this._showMyProfile();let s=this.convListController.getRecentContactWithId(e.userId),a=!1;if(s)a=!0;else{let t=t=>{t&&t.includes(e.userId)&&(s=Object(I.a)({},t[e.userId]))};s||t(yn.default.getGroupsListSync()),s||t(Ii.default.getFriendsSync()),s||(s={}),Object.assign(s,e),s.isFr=s.isFr||0,s.type=s.type||Y.FRIEND_TYPE_NORMAL}e.byPassPIN?s.byPassPIN=1:s.byPassPIN&&delete s.byPassPIN,setTimeout((()=>{Object(tc.f)({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:s})}),0);const i=this.data.get(Ar.c);let n=null==i?void 0:i.currentTab;!0===t?(n=a?rc.SidebarTab.MESSAGE_TAB:rc.SidebarTab.CONTACT_TAB,n===rc.SidebarTab.CONTACT_TAB&&(ui.default.log("sidebar: select from search, should highlight thread"),this.changeTabFromSearch=!0),this.searchController.onCloseSearch(),this.searchController.resetState(),!e.userId||!e.byPassPIN&&In.a.isThreadHidden(e.userId)||setTimeout((()=>{_e.default.send(ve.ChatBoxActions.FOCUS_INPUT,{userId:e.userId,windowId:Ar.c})}),0)):this.searchController.updateStateOf("highlightId",e.userId),this.updateState(Object(I.a)(Object(I.a)({},i),{},{currentTab:n,selectedId:e.userId})),e&&e.userId===Ce.default.sendToMeId&&(Me.g.getFlagForCurrentUser(this.currUser.userId,sl)||(J.p.getHasShownSendToMeTip()?Me.g.setFlagForCurrentUser(this.currUser.userId,sl,1):setTimeout((()=>{_e.default.send(ve.ConversationListActions.SHOW_BUBBLE_DOT),J.p.setHasShownSendToMeTip(!0)}),144e5)))}showAddFriendModal(){Ia.default.logAction(1020203),Ia.default.logAction(12316),Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.FIND_FRIEND})}async showGroupCompose(){Ia.default.logAction(1020202),Zc.c.markStart(Zc.a.CREATE_GROUP,Zc.b.Group.CREATE_GR_HEADER_ICON);const e=el.q.isAllowCreateCommunity();if(e)try{await a.ModuleContainer.resolve(el.e).checkCreateCondition(el.n.NORMAL)}catch{return Object(Xc.b)({windowId:Ar.c})}const t=J.p.getSessionUserId(),s=(e=!0,t=!1)=>{Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.CREATE_GROUP_COMPOSE,params:{needInitE2ee:e,showCreateOptions:t},forceCloseAll:!1})};!Me.g.getTimeEntryPointE2eGroup(t,Zc.b.Group.CREATE_GR_HEADER_ICON)&&Ce.default.e2ee.enable_group&&Ce.default.e2ee.group.can_enable_right_in_creation_step?Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.E2EE_ONBOARDING,params:{entry:dt.e.CREATE_GROUP,entrySrc:Zc.b.Group.CREATE_GR_HEADER_ICON,isGroup:!0,userId:"",callback:s,callbackCancel:s},forceCloseAll:!1}):s(!1,e)}enableAutoJupmFC(){this._allowAutoJumpFC=!0}disableAutoJupmFC(){this._allowAutoJumpFC=!1}init(){}getItem(e){const t=e.key;return this._getStateByWindowId(t)}getList(e){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}updateState(e,t=Ar.c,s=!0){this.data.set(t,e),s&&Object(nc.h)(this.name,t)}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(I.a)({},tl),this.data.set(e,t)),t}_onChangeTab(e,t){switch(function(){switch(e){case rc.SidebarTab.MESSAGE_TAB:Ia.default.logAction(12801);break;case rc.SidebarTab.CONTACT_TAB:Ia.default.logAction(12802),3===Ce.default.noti_center_config.entry_position&&Ia.default.logAction(1281205);break;case rc.SidebarTab.MENTION_TAB:Ia.default.logAction(12805);break;case rc.SidebarTab.STAR_TAB:Ia.default.logAction(12806);break;case rc.SidebarTab.FILE_TAB:Ia.default.logAction(133);break;case rc.SidebarTab.TODO_TAB:3===Ce.default.noti_center_config.entry_position&&Ia.default.logAction(1281206)}}(),J.p.resetGlobalSearchMode(),this.searchController.getSearchInputRef()&&this.searchController.clearSearch(!0),e){case rc.SidebarTab.MESSAGE_TAB:{this._resetConversationList();const e=this.getState();!e.selectedId&&e.previousId&&this.updateSelectedId(e.previousId),Object(tc.f)({type:ve.SideBarActions.SHOW_CHAT_VIEW});break}case rc.SidebarTab.STAR_TAB:case rc.SidebarTab.TODO_TAB:t===rc.SidebarTab.ZCLOUD_TAB&&Object(tc.f)({type:ve.SideBarActions.SHOW_CHAT_VIEW})}}_showMyProfile(){Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:this.currUser.userId})}_resetConversationList(){}_getQueryParams(){let e={},t=window.location.search;if(t=t?t.substr(1).split("&"):null,t)for(let s=0;s<t.length;s++){let a=t[s].indexOf("=");if(a>=0){let i=t[s].slice(0,a),n=t[s].slice(a+1,t[s].length);i&&i.length>0&&n&&n.length>0&&(e[i]=decodeURIComponent(n))}}return e}_autoSelectConv(){this._querySelect&&this._convsLoaded&&(ui.default.logCoreInfo(`[${this.name}] - auto select conv start`),this._querySelect(),this._querySelect=null)}})||Wc)||Wc)||Wc)||Wc)||Wc);var nl;const rl={id:ac.f,color:"#EA87FF",conversations:[],createTime:1634956772046,emoij:"",offset:100,text:"default"};var ol=function(e){return e.ALL="all",e.SELECTED="selected",e}(ol||{});Object(xi.b)(rc.LabelDataManager)(nl=Reflect.metadata("design:type",Function)(nl=Reflect.metadata("design:paramtypes",[])(nl=class extends hs.b{constructor(){super(),this.allLabels=void 0,this.selectedLabel=void 0,this.name=rc.LABEL_DATA_MANAGER,this.data=new Map,this.key="labelId",this.allLabels=[],this.selectedLabel=[]}onLabelChange(e){const{color:t,conversations:s,createTime:a,emoij:i,offset:n,text:r}=e,o=""+e.id,c=this.data.get(o);if(!o||c&&s===c.conversations&&a==(null==c?void 0:c.createTime)&&i==c.emoij&&n==c.offset&&r===c.text&&t==c.color||(this.data.set(o,e),Object(nc.h)(this.name,o),Object(nc.i)(this.name,"all")),c&&c.conversations&&c.conversations.length!==s.length){let e=[];s.length>c.conversations.length?(e=s.filter((e=>!c.conversations.includes(e))),this.dispatchEvent(new oc.c(oc.d.LabelAddConvs,{labelId:o,convIds:e}))):(e=c.conversations.filter((e=>!s.includes(e))),this.dispatchEvent(new oc.c(oc.d.LabelRemoveConvs,{labelId:o,convIds:e})))}}onFetchLabels(e){if(Array.isArray(e)&&!(e.length<0)){for(let t=0;t<e.length;t++)this.onLabelChange(e[t]);this.data.forEach((t=>{const s=""+t.id;e.some((e=>e.id==s))||this.data.delete(s)})),this._updateAllLabels(e.map((e=>e.id)))}}onLabelDeleted(e){if("string"!=typeof e&&(ui.default.logCoreError(`[${this.name}] - delete label invalid lid type ${e}`),e=""+e),!this.data.has(e))return void ui.default.logCoreError(this.name+"Deleted not exists item!!!");const t=this.data.get(e);let s=[];t&&t.conversations&&(s=[...t.conversations]),this.data.delete(e),this._updateAllLabels(this.allLabels.filter((t=>t!==e))),this.selectedLabel.includes(e)&&this.onDeSelectLabel(e),this.dispatchEvent(new oc.c(oc.d.RemoveLabel,{labelId:e,convs:s})),Object(nc.f)(this.name,e)}_updateAllLabels(e){return!ui.default.shallowEqual(this.allLabels,e)&&(this.allLabels=e,Object(nc.i)(this.name,ol.ALL),!0)}onSelectLabel(e){this.selectedLabel=[""+e],Object(nc.i)(this.name,ol.SELECTED),this.selectedLabelChanged()}onDeSelectLabel(e){this.selectedLabel=this.selectedLabel.filter((t=>t!==e)),Object(nc.i)(this.name,ol.SELECTED),this.selectedLabelChanged()}onClearFilter(){this.selectedLabel=[],Object(nc.i)(this.name,ol.SELECTED),this.selectedLabelChanged()}getLabelById(e){return e?("string"!=typeof e&&(e=e.toString()),e==ac.f?rl:e==ac.g?{id:ac.g}:this.data.get(e)||null):null}getAllLabels(){return Array.from(this.data.values())}getAllLabelIds(){return this.allLabels}applyNewFilter(e){this.selectedLabel=e,Object(nc.i)(this.name,ol.SELECTED),this.selectedLabelChanged()}selectedLabelChanged(){this.dispatchEvent(new oc.c(oc.d.SelectedLabelChange,this.selectedLabel))}init(){lc.a.getAll().then((e=>{this.onFetchLabels(e)}))}getItem(e){const t=e.key;return this.getLabelById(t)}getList(e){const t=e.key;return t===ol.ALL?this.allLabels:t===ol.SELECTED?this.selectedLabel:[]}onGetItemFailure(e){}onGetListFailure(e){}})||nl)||nl);a.ModuleContainer.register(ec.b,ic);let cl=function(e){return e[e.FULL=0]="FULL",e[e.WINDOWED=1]="WINDOWED",e}({});var ll=s("tQbm"),dl=s("qzuk"),ul=s("NMlV"),hl=s("4HQc"),gl=s("GpwQ");const ml={message:{action:"recommened.link",childnumber:0,description:"Zalo cho máy tính gửi file cực nhanh, chụp màn hình tiện lợi, trò chuyện nhóm không giới hạn.",href:`https://${Ce.default.CONFIG_DOMAIN}/may-tinh?utm_source=chatview&utm_campaign=reinstallpc&utm_medium=web`,params:`{"mediaTitle":"Zalo cho máy tính – Windows, Mac, Ubuntu","artist":"","src":"${Ce.default.CONFIG_DOMAIN}","stream_icon":"","streamUrl":"","type":0}`,thumb:"https://stc-chat.zdn.vn/images/banner/zalo-thumb-link.png",title:"Zalo cho máy tính – Windows, Mac, Ubuntu",type:"",copyLinkActionCode:null,confirmActionCode:null},msgType:6};var pl,fl=s("OU7N"),vl=s("UYGI"),_l=s("X4fA"),bl=s("V8Oy"),Il=s("7WX+");let yl;ui.default.isWeb()||(yl=s("Dprd").default);const Sl={conversationId:null,mode:cl.FULL,windowId:Ar.c};Object(xi.b)(ll.b)(pl=function(e,t){return a.ModuleContainer.inject(rc.SidebarController)(e,void 0,0)}(pl=Reflect.metadata("design:type",Function)(pl=Reflect.metadata("design:paramtypes",[void 0===rc.SidebarController?Object:rc.SidebarController])(pl=class extends hs.b{constructor(e){super(),this.sidebar=e,this.data=new Map,this.onLogOut=()=>{if(fl.d.isCalling())return void mc.default.createWarning(ce.a.str("STR_SIGNOUT_WITH_CALL"));let e=J.p.getSessionUserId(),t="STR_LOGOUT_CONFIRM",s=+vl.b.isUploading();if(!s&&yl&&yl.isDownloading()&&(s=2),s>0){const e=1===s?ce.a.str("STR_TITLE_BAR_SEND"):ce.a.str("STR_TITLE_BAR_RECEIVE");t=ce.a.str("STR_LOGOUT_CANCEL_FILE")+` ${e} `+ce.a.str("STR_TITLE_BAR_EXIT_ZALO_P2")}_l.a.getLogoutToken(),pc.ConfirmManagerV2.openConfirm({windowId:Ar.c,name:Y.MODAL_CONFIRM.confirmIdentities,params:{message:ce.a.str(t),okText:ce.a.str("STR_LOGOUT_YES"),cancelText:ce.a.str("STR_LOGOUT_NO"),onOk:this.doLogout,options:[{default_val:Me.g.isSetClearData(e),key:"del_history",title:"STR_LOGOUT_DEL_HISTORY"}],"data-id":{confirmBtn:"btn_Logout_Logout",cancelBtn:"btn_Logout_No"}}})},this.openConversationInNewWindow=async e=>{throw new Error("Method not implemented.")},this.openScreenCapture=async()=>{Ia.default.logAction(12808),_e.default.send(ve.ChatBoxActions.SIDEBAR_CAPTURE)},this.openZaloSupport=async()=>{const e=Ce.default.supportPage;return e?a.ModuleContainer.resolve(Q.b).openConversation(e,Q.d.fromSupport()):Promise.resolve(!1)},this.openUpdateMyProfile=async()=>{Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.UPDATE_PROFILE,params:{showCloseButton:!0}})},this.openUserInfo=async e=>{ye.a.setFriendRequestSource(e,Y.FRIEND_REQUEST_SRC_CONTACT_LIST_SUGGESTION),J.p.setSelectConversationSource(178012),Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})},this.openEditAlias=async e=>{const t={windowId:Ar.c,name:Y.ModalIdentitiesDefine.EDIT_ALIAS,params:Object(I.a)({},e)};Ie.ModalManagerV2.openModal(t)},this.sendFile=async(e,t)=>{const s=this._getStateByWindowId(Ar.c),a=K.default.getChatBoxControllerByConvId(t||s.conversationId);null==a||a._uploadDragFile(e,null,t)},this.getConvId=()=>this._getStateByWindowId(Ar.c).conversationId,this.sendDirectMsgToSendToMe=(e,t)=>{!Ce.default.isOffSendToMe&&this.chatboxController&&Re.default.getConversation(Ce.default.sendToMeId).then((s=>{if(e===Y.MSG_GIF&&t.url){var a;let e={hd:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},original:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url},normal:{width:t.width?t.width:0,height:t.height?t.height:0,url:t.url}};null===(a=this.chatboxController)||void 0===a||a._sendMessage(s,Y.MSG_GIF,e,null,null,null,null,null)}Object(tc.e)({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:s}),this.sidebar.updateSelectedId(Ce.default.sendToMeId)}))},this.handleSendMessageError=(e,t,s)=>{var a,i;if(Re.default.deleteMessageById(t.msgId,t.conversationId),null===(a=this.chatboxController)||void 0===a||a._cleanUpLocalTTLItem(t),J.p.isDelSendingMsg(t.clientId))return;const n=t.convertToUIMessageObject();return null===(i=this.chatboxController)||void 0===i||i._handleMessageFailure(e,t,n,s,!0),e},this.broadCastMessage=(e,t,s,a)=>{if(e&&t)for(let o=0;o<e.length;o++){const c=e[o];if(c){let e=c.userId,o=e.startsWith(Y.GROUPID_PREFIX);if(t.msgType===Y.MSG_STICKER){var i;const l=ul.a.next();t&&t.sendSrc&&Zc.c.track(l,t.sendSrc);const d=ui.default.getMsgIdSendingFromCliMsgId(l),u=new hl.c(J.p.getSessionUserId(),e,d,l,Y.MSG_STICKER,o),h=gl.a.instance().isOnE2ee(c.userId);if(u.updateMessageContentProp(hl.a.STICKER,t.message),h){var n;const e={id:u.content.sticker.id,catId:u.content.sticker.cateId,type:u.content.sticker.type};var r;if(null!==(n=t.message)&&void 0!==n&&n.fssInfo)e.extInfo=null===(r=t.message)||void 0===r?void 0:r.fssInfo;u.updateMessageContentProp(hl.a.STICKER,e),u.e2eeStatus=Y.MSG_E2EE}qc.default.sendMsgObject(u,null,null,Y.RETRY_MSG_TIMEOUT_DEFAULT).then((t=>{if(s){var i;const t=ul.a.next(),a=ui.default.getMsgIdSendingFromCliMsgId(t);let n=new hl.c(J.p.getSessionUserId(),e,a,t,Y.MSG_TEXT,o);n.updateMessageContentProp(hl.a.TEXT,s),h&&(n.e2eeStatus=Y.MSG_E2EE),qc.default.sendMsgObject(n,null,null,Y.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{h&&(e=ui.default.parseE2eeResp(e),this.chatboxController._sentMessage(n,e))})).catch((e=>{this.handleSendMessageError(e,n,c)})),null===(i=this.chatboxController)||void 0===i||i._showLocalMessage(n,c)}h&&(t=ui.default.parseE2eeResp(t),this.chatboxController._sentMessage(u,t)),a&&a(t)})).catch((e=>{ui.default.logCoreError("BroadcastErr: ",e),this.handleSendMessageError(e,u,c),a&&a(e)})),null===(i=this.chatboxController)||void 0===i||i._showLocalMessage(u,c)}else if(t.msgType===Y.MSG_TEXT&&s){const t=ul.a.next(),i=ui.default.getMsgIdSendingFromCliMsgId(t);let n=new hl.c(J.p.getSessionUserId(),e,i,t,Y.MSG_TEXT,o);n.updateMessageContentProp(hl.a.TEXT,s);gl.a.instance().isOnE2ee(c.userId)&&(n.e2eeStatus=Y.MSG_E2EE),qc.default.sendMsgObject(n,null,null,Y.RETRY_MSG_TIMEOUT_DEFAULT).then((e=>{a&&a(e)})).catch((e=>{this.handleSendMessageError(e,n,c),a&&a(e)}))}}}},this.handleEvent=(e,t)=>{if(e===ve.ConversationListActions.SELECT_CONVERSATION){const e=this._getStateByWindowId(Ar.c);if(t.userId!==e.conversationId)return this._updateStateByWindowId(Ar.c,(e=>Object(I.a)(Object(I.a)({},e),{},{conversationId:t.userId}))),Object(nc.h)(this.name,Ar.c),void this.dispatchEvent(new dl.a(t.userId,Ar.c))}},this.name=ll.a,this.key="windowId",this.init()}get chatboxController(){const e=this.sidebar.getState().selectedId;return K.default.getChatBoxControllerByConvId(e||Ar.b)}onInviteFriend(){const e=[ml];Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.SHARE_MSG_COMPOSE,params:{messages:e,title:ce.a.str("STR_INVITE_FRIEND_1"),disableGroup:!0,disablePcUser:!0,callback:(e,t)=>{_e.default.send(ve.SideBarActions.SEND_INVITATION,{target:e,message:(null==t?void 0:t.length)>0?t[0]:"",link:`https://${Ce.default.CONFIG_DOMAIN}/may-tinh`})}}})}onWhatNew(){Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.APP_UPDATE_INFO,params:{data:Re.default.getCacheRecentUpdate(),isManual:!0}})}showMyProfile(){let e=J.p.getSessionUserId();Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:e})}get mainWindowConversationId(){return this._getStateByWindowId(Ar.c).conversationId}doLogout(e){let t=J.p.getSessionUserId();e&&e.del_history?Me.g.setClearData(t,1):Me.g.setClearData(t,0),bl.a.logout(),Il.a.logout(),_l.a.logout().catch((e=>{e.error_code&&18032===e.error_code&&Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.CHANGE_PW})}))}init(){_e.default.subscribe(this.handleEvent)}getItem(e,t){return this._getStateByWindowId(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){}_getStateByWindowId(e){let t=this.data.get(e);return t||(t=Object(I.a)({},Sl),this.data.set(e,t)),t}_updateStateByWindowId(e,t){const s=t(this._getStateByWindowId(e));this.data.set(e,s)}})||pl)||pl)||pl);var Cl,El=s("OI//");let Ol=a.ModuleContainer.injectable()(Cl=class{async get(e){return yn.default.getGroupById(e)}async getMulti(e){const t=await yn.default.getGroupsByIds(e);return Object.values(t)}async getAll(){return await yn.default.getGroupsList()}})||Cl;var Ml;let Tl=a.ModuleContainer.injectable()(Ml=function(e,t){return a.ModuleContainer.inject(El.c)(e,void 0,0)}(Ml=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,1)}(Ml=Reflect.metadata("design:type",Function)(Ml=Reflect.metadata("design:paramtypes",[void 0===El.c?Object:El.c,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Ml=class{constructor(e,t){this.groupRepository=e,this.logger=void 0,this.logger=t.createZLogger("groups",["group-manager"])}getAll(){return this.groupRepository.getAll().then((e=>e.map((e=>new El.a(e))))).catch((e=>(this.logger.zsymb(18,"Jx3axc",(()=>["getAll error. return [].",{reason:e}])),[])))}getMulti(e){return this.groupRepository.getMulti(e).then((e=>e.map((e=>new El.a(e)))))}get(e){return this.groupRepository.get(e).then((e=>e?new El.a(e):void 0)).catch((e=>{this.logger.zsymb(18,"pNIzs8",(()=>["get error. return undefined.",{reason:e}]))}))}})||Ml)||Ml)||Ml)||Ml)||Ml;a.ModuleContainer.registerSingleton(El.c,Ol),a.ModuleContainer.registerSingleton(El.b,Tl);var Rl=s("/S2x"),wl=s("vBob"),Ll=s("qlGb");var Dl=s("7gmC");class Al{constructor(e,t,s,a){this.actionSrc=void 0,this.msgType=void 0,this.convType=void 0,this.dlt=void 0,this.actionSrc=e,this.msgType=t,this.convType=s,this.dlt=a}toString(){const e=[this.actionSrc,this.msgType,this.convType,this.dlt].filter((e=>void 0!==e));return e.length<=0?"":1==e.length?e.join(""):e.length>=2?e.join("."):""}}class Fl{constructor(){this.name=void 0,this.code=void 0}}class kl extends Fl{constructor(){super(),this.name="SYNC_DOWNLOAD_DATA_INVALID",this.code=1}}class Nl extends Fl{constructor(){super(),this.name="MESSAGE_INVALID",this.code=2}}class Pl extends Fl{constructor(){super(),this.name="TOPIC_INVALID",this.code=3}}class jl extends Fl{constructor(){super(),this.name="DLT_DATA_INVALID",this.code=4}}class Ul extends Fl{constructor(){super(),this.name="ACTION_HASH_DUPLICATE",this.code=6}}class Bl extends Fl{constructor(){super(),this.name="MESSAGE_KEY_INVALID",this.code=7}}class zl extends Fl{constructor(){super(),this.name="DOWNLOAD_ERROR",this.code=8}}class Gl{constructor(e){this.topic=e}}class xl{constructor(e){this.topic=e}}var Vl,Hl=s("ePll"),Wl=s("nkyP");const ql=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["producer produce"]);let Kl=Object(a.injectable)()(Vl=function(e,t){return Object(a.inject)(Wl.i)(e,void 0,0)}(Vl=function(e,t){return Object(a.inject)(Wl.p)(e,void 0,1)}(Vl=function(e,t){return Object(a.inject)(Wl.j)(e,void 0,2)}(Vl=function(e,t){return Object(a.inject)(Wl.k)(e,void 0,3)}(Vl=function(e,t){return Object(a.inject)(Wl.m)(e,void 0,4)}(Vl=function(e,t){return Object(a.inject)(Wl.g)(e,void 0,5)}(Vl=function(e,t){return Object(a.inject)(Wl.n)(e,void 0,6)}(Vl=function(e,t){return Object(a.inject)(Wl.r)(e,void 0,7)}(Vl=function(e,t){return Object(a.inject)(Wl.c)(e,void 0,8)}(Vl=function(e,t){return Object(a.inject)(Wl.a)(e,void 0,9)}(Vl=function(e,t){return Object(a.inject)(Wl.s)(e,void 0,10)}(Vl=Reflect.metadata("design:type",Function)(Vl=Reflect.metadata("design:paramtypes",[Object,Object,Object,Object,Object,void 0===Dl.IMediator?Object:Dl.IMediator,Object,Object,Object,Object,Object])(Vl=class{constructor(e,t,s,a,i,n,r,o,c,l,d){this.duplicateBucket=e,this.syncQueueRepository=t,this.messageRepository=s,this.messageValidator=a,this.syncActionsRepository=i,this.syncActionMediator=n,this.syncDownloadDataValidator=r,this.topicMapper=o,this.compositeKeyMapper=c,this.actionHashMapper=l,this.topicValidator=d}async produceByAction(e){try{if(!this.syncDownloadDataValidator.validateSyncDownloadData(e))throw new kl;const t=this.actionHashMapper.map(e);if(this.syncDownloadDataValidator.validateDuplicateSyncDownloadData(t))throw new Ul;this.duplicateBucket.add(t.toString());const s=await this.messageRepository.getMessageByCliMsgId(e.clientMsgId,e.convId);if(!this.messageValidator.validateMessage(s))throw new Nl;const a=this.compositeKeyMapper.mapByAction(e),i=this.compositeKeyMapper.mapByMessage(s);if(!this.messageValidator.validateMessageByCompositeKey(i,a))throw new Bl;const n=this.topicMapper.map(e,s);if(!this.topicValidator.validateTopic(n))throw new Pl;this.syncQueueRepository.addByTopic(n.toString(),{action:e,message:s,lastClientMsgId:e.clientMsgId}),requestAnimationFrame((async()=>{await this.syncActionMediator.publish(new xl(n))}))}catch(t){t instanceof Ul||requestAnimationFrame((async()=>{var t;this.duplicateBucket.delete(null===(t=this.actionHashMapper.map(e))||void 0===t?void 0:t.toString())}))}}async produceByParams(e,t,s){let a=await this.syncActionsRepository.getActionsByActionSrc(e,t,s);if((a.data.length<=0||a.data.length>0&&!1===a.hasMore)&&await this.syncActionMediator.publish(new Gl(new Al(e))),!(a.data.length<=0||null==a)&&a.data)for(let[n,r]of a.data.entries())try{if(!this.syncDownloadDataValidator.validateSyncDownloadData(r))throw new kl;const e=this.actionHashMapper.map(r);if(this.syncDownloadDataValidator.validateDuplicateSyncDownloadData(e))throw new Ul;this.duplicateBucket.add(e.toString());const t=await this.messageRepository.getMessageByCliMsgId(r.clientMsgId,r.convId);let{code:s,msgType:i}=Hl.a.validateMessage(t);if(s&&i==(null==t?void 0:t.msgType))continue;if(!this.messageValidator.validateMessage(t))throw new Nl;const o=this.topicMapper.map(r,t);if(!this.topicValidator.validateTopic(o))throw new Pl;this.syncQueueRepository.addByTopic(o.toString(),{action:r,message:t,lastClientMsgId:a.lastClientMsgId,reproduce:0==n&&!1!==a.hasMore}),await this.syncActionMediator.publish(new xl(o))}catch(i){ql.zsymb(23,"Uratnp",["produce error {}","24d1zt"],i),i instanceof Ul||requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(r))||void 0===e?void 0:e.toString())}))}}})||Vl)||Vl)||Vl)||Vl)||Vl)||Vl)||Vl)||Vl)||Vl)||Vl)||Vl)||Vl)||Vl)||Vl;var Zl;let $l=Object(a.injectable)()(Zl=function(e,t){return Object(a.inject)(Wl.i)(e,void 0,0)}(Zl=Reflect.metadata("design:type",Function)(Zl=Reflect.metadata("design:paramtypes",[Object])(Zl=class{constructor(e){this.duplicateBucket=e}validateSyncDownloadData(e){return!!e&&(!(!e.clientMsgId||Number.isNaN(e.clientMsgId))&&(!(!e.actionSource||Number.isNaN(e.actionSource))&&!(!e.convId||!e.fromId)))}validateDuplicateSyncDownloadData(e){return!!this.duplicateBucket.has(e.toString())}})||Zl)||Zl)||Zl)||Zl;var Ql,Yl=s("Y58e");let Jl=Object(a.injectable)()(Ql=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(Ql=Reflect.metadata("design:type",Function)(Ql=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a])(Ql=class{constructor(e){this.config=void 0,this.config=e}validateTopic(e){if(!e.actionSrc)return!1;return!!this.config.get("syncDownload.topics").includes(e.toString())}})||Ql)||Ql)||Ql)||Ql;const Xl=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue add"]);class ed{constructor(){this.maps=new Map}unshiftByTopic(e,t){var s;Array.isArray(this.maps.get(e))?null===(s=this.maps.get(e))||void 0===s||s.unshift(t):this.maps.set(e,[t])}addByTopic(e,t){var s;Xl.zsymb(23,"pnlG45",["queue add topic {}, {}","jUk4TI"],e,t),Array.isArray(this.maps.get(e))?null===(s=this.maps.get(e))||void 0===s||s.push(t):this.maps.set(e,[t])}popByTopic(e){var t;return null===(t=this.maps.get(e))||void 0===t?void 0:t.pop()}lengthByTopic(e){var t;return(null===(t=this.maps.get(e))||void 0===t?void 0:t.length)||0}infosByTopic(e){return[...this.maps.get(e)]}}var td=s("jkDV");class sd{constructor(e){this.topic=e}}class ad{constructor(e,t,s){this.topic=e,this.syncData=t,this.reproduce=s}}const id=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("downloadSyncActions",["downloadSyncActions"]);class nd{constructor(e,t){this.topic=e,this.DltSyncData=t}}const rd=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue consume"]);class od{constructor(e,t,s,a,i,n,r,o){this.duplicateBucket=e,this.actionHashMapper=t,this.cachedDTORepository=s,this.DTOMapper=a,this.syncQueueRepository=i,this.mediator=n,this.syncActionMediator=r,this.topic=o}async consume(){id.zsymb(23,"tD1LCS",["DownloadSyncActionConsumerService consume entry","ScozdG"]);const e=this.syncQueueRepository.popByTopic(this.topic.toString()),t=null==e?void 0:e.action,s=null==e?void 0:e.message,a=null==e?void 0:e.reproduce;try{var i;const e=this.DTOMapper.map(t,s);if(null!=e&&null!==(i=e.data)&&void 0!==i&&i.url){this.cachedDTORepository.setDTO(`${t.clientMsgId}.${this.topic.toString()}`,e),rd.zsymb(23,"2Ao0v-",["actionSrc {}, cliMsgId {}, globalMsgId {}, start download","aE040C"],t.actionSource,t.clientMsgId,t.globalMsgId);const s=await e.run();if(null!=s&&s.downloadError||null==s||!s.savePath)throw rd.zsymb(23,"aucx0L",["actionSrc {}, cliMsgId {}, globalMsgId {}, downloadError {}, savePath {}, done retry download","SpC6Sb"],t.actionSource,t.clientMsgId,t.globalMsgId,null==s?void 0:s.downloadError,null==s?void 0:s.savePath),new zl;rd.zsymb(23,"VigVgW",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, done download","W2pHR9"],t.actionSource,t.clientMsgId,t.globalMsgId,s.isCached),this.cachedDTORepository.deleteDTO(`${t.clientMsgId}_${this.topic.toString()}`),await this.syncActionMediator.publish(new td.c(t.actionSource,t.fromId,t.convId,t.clientMsgId,{isCached:Boolean(s.isCached)}))}else await this.syncActionMediator.publish(new td.c(t.actionSource,t.fromId,t.convId,t.clientMsgId,{isCached:!1}))}catch(n){t&&s&&(rd.zsymb(23,"ECSVzZ",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, fail download go to retry","92KOtl"],t.actionSource,t.clientMsgId,t.globalMsgId),await this.syncActionMediator.publish(new nd(new Al(this.topic.actionSrc,this.topic.msgType,this.topic.convType,"dlt"),{action:t,message:s,retry:0})))}requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(t))||void 0===e?void 0:e.toString()),await this.mediator.publish(new sd(this.topic)),await this.mediator.publish(new ad(this.topic,t,a))}))}}class cd{constructor(e){this.topic=e}}const ld=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue retry consume"]);class dd{constructor(e,t,s,a,i,n,r,o,c){this.duplicateBucket=e,this.actionHashMapper=t,this.cachedDTORepository=s,this.DTOMapper=a,this.syncQueueDLTRepository=i,this.mediator=n,this.syncActionMediator=r,this.DltValidator=o,this.topic=c}async consume(){id.zsymb(23,"b7Rlux",["DownloadSyncActionDltConsumer consume entry","uFcCHy"]);const e=this.syncQueueDLTRepository.popByTopic(this.topic.toString()),t=null==e?void 0:e.action,s=null==e?void 0:e.message;try{var a;if(!this.DltValidator.validateDlt(e))throw new jl;const i=this.DTOMapper.map(t,s);if(null!=i&&null!==(a=i.data)&&void 0!==a&&a.url){this.cachedDTORepository.setDTO(`${e.action.clientMsgId}_${this.topic.toString()}`,i),ld.zsymb(23,"LHRb-2",["actionSrc {}, cliMsgId {}, globalMsgId {}, retry count {}, start retry download","3-C3yp"],t.actionSource,t.clientMsgId,t.globalMsgId,e.retry);const s=await i.run();if(null!=s&&s.downloadError||null==s||!s.savePath)throw ld.zsymb(23,"bORKj8",["actionSrc {}, cliMsgId {}, globalMsgId {}, downloadError {}, savePath {}, done retry download","SpC6Sb"],t.actionSource,t.clientMsgId,t.globalMsgId,null==s?void 0:s.downloadError,null==s?void 0:s.savePath),new zl;ld.zsymb(23,"-MyUeX",["actionSrc {}, cliMsgId {}, globalMsgId {}, isCache {}, done retry download","i1ndoZ"],t.actionSource,t.clientMsgId,t.globalMsgId,s.isCached),this.cachedDTORepository.deleteDTO(`${t.clientMsgId}_${this.topic.toString()}`),await this.syncActionMediator.publish(new td.c(t.actionSource,t.fromId,t.convId,t.clientMsgId,{isCached:Boolean(s.isCached)}))}else await this.syncActionMediator.publish(new td.c(t.actionSource,t.fromId,t.convId,t.clientMsgId,{isCached:!1}))}catch(n){if(t&&s)if(n instanceof jl);else if(this.DltValidator.isRetriesExceeded(e)){var i;await this.mediator.publish(new td.b(t.actionSource,t.fromId,t.convId,t.clientMsgId,null==n||null===(i=n.downloadError)||void 0===i?void 0:i.name))}else await this.mediator.publish(new nd(this.topic,{action:t,message:s,retry:e.retry+1})),ld.zsymb(23,"MPSl5J",["actionSrc {}, cliMsgId {}, globalMsgId {}, retry count {}, fail download increase retry","G8E1qw"],t.actionSource,t.clientMsgId,t.globalMsgId,e.retry)}requestAnimationFrame((async()=>{var e;this.duplicateBucket.delete(null===(e=this.actionHashMapper.map(t))||void 0===e?void 0:e.toString()),await this.mediator.publish(new sd(this.topic)),await this.mediator.publish(new cd(this.topic))}))}}var ud;let hd=Object(a.injectable)()(ud=function(e,t){return Object(a.inject)(Wl.i)(e,void 0,0)}(ud=function(e,t){return Object(a.inject)(Wl.b)(e,void 0,1)}(ud=function(e,t){return Object(a.inject)(Wl.a)(e,void 0,2)}(ud=function(e,t){return Object(a.inject)(Wl.e)(e,void 0,3)}(ud=function(e,t){return Object(a.inject)(Wl.p)(e,void 0,4)}(ud=function(e,t){return Object(a.inject)(Wl.o)(e,void 0,5)}(ud=function(e,t){return Object(a.inject)(Wl.g)(e,void 0,6)}(ud=function(e,t){return Object(a.inject)(Wl.l)(e,void 0,7)}(ud=function(e,t){return Object(a.inject)(Wl.f)(e,void 0,8)}(ud=Reflect.metadata("design:type",Function)(ud=Reflect.metadata("design:paramtypes",[Object,Object,Object,Object,Object,Object,void 0===Dl.IMediator?Object:Dl.IMediator,void 0===Dl.IMediator?Object:Dl.IMediator,Object])(ud=class{constructor(e,t,s,a,i,n,r,o,c){this.duplicateBucket=e,this.cachedDTORepository=t,this.actionHashMapper=s,this.DTOMapper=a,this.syncQueueRepository=i,this.syncQueueDltRepository=n,this.mediator=r,this.syncActionMediator=o,this.dltValidator=c,this.services=new Map,this.dltTopics=new Map}createByTopic(e){let t=this.services.get(e),s=this.services.get(this.dltTopics.get(e)||"");if(t&&s)return[t,s];let a=e.split(".");return t=new od(this.duplicateBucket,this.actionHashMapper,this.cachedDTORepository,this.DTOMapper,this.syncQueueRepository,this.mediator,this.syncActionMediator,new Al(Number(a[0]),a[1],a[2])),s=new dd(this.duplicateBucket,this.actionHashMapper,this.cachedDTORepository,this.DTOMapper,this.syncQueueDltRepository,this.mediator,this.syncActionMediator,this.dltValidator,new Al(Number(a[0]),a[1],a[2],"dlt")),this.services.set(t.topic.toString(),t),this.services.set(s.topic.toString(),s),[t,s]}deleteByTopic(e){this.services.delete(e)}getByTopic(e){return this.services.get(e)}getAll(){return Array.from(this.services.values())}})||ud)||ud)||ud)||ud)||ud)||ud)||ud)||ud)||ud)||ud)||ud)||ud;const gd={[Y.MSG_PHOTO]:"photo",[Y.MSG_PHOTO_2]:"photo",[Y.MSG_GIF]:"photo",[Y.MSG_FILE]:"file",[Y.MSG_VOICE]:"voice",[Y.MSG_VIDEO]:"video",[Y.MSG_CONTACT]:"link"};var md;let pd=Object(a.injectable)()(md=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(md=Reflect.metadata("design:type",Function)(md=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a])(md=class{constructor(e){this.config=void 0,this.config=e}map(e,t){let s=gd[t.msgType]||"";const a=this.config.get("syncDownload.topics");return a.includes(`${e.actionSource}`)?new Al(e.actionSource):a.includes(`${e.actionSource}.${s}`)?new Al(e.actionSource,s):void 0}})||md)||md)||md)||md;var fd;let vd=Object(a.injectable)()(fd=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(fd=Reflect.metadata("design:type",Function)(fd=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a])(fd=class{constructor(e){this.config=void 0,this.config=e}validateDlt(e){return!!e}isRetriesExceeded(e){const t=this.config.get("syncDownload.dlt_max_retry");return!!(Number.isNaN(e.retry)||e.retry>=t)}})||fd)||fd)||fd)||fd;class _d{constructor(e,t){this.actionSrc=void 0,this.clientMsgId=void 0,this.actionSrc=e,this.clientMsgId=t}toString(){return`${this.actionSrc}.${this.clientMsgId}`}}class bd{constructor(e,t,s){this.cliMsgId=e,this.fromUid=t,this.toUid=s}toString(){return`${this.cliMsgId}.${this.fromUid}.${this.toUid}`}}a.ModuleContainer.register(Wl.j,class{constructor(){this.DB=void 0,this.DB=Xt.default.getInstance()}async getMessageByCliMsgId(e,t){return await this.DB.Core.Message.get(`${e}`,{index:"cliMsgIdIndex",partition:t})}}),a.ModuleContainer.register(Wl.m,class{constructor(){}async getActions(){return[]}getActionsByActionSrc(e){return Object(ge.f)("SyncActionsRepository",e)}}),a.ModuleContainer.registerSingleton(Wl.o,ed),a.ModuleContainer.registerSingleton(Wl.p,ed),a.ModuleContainer.registerSingleton(Wl.b,class{constructor(){this.cache=new Map}getDTO(e){return this.cache.get(e)}setDTO(e,t){this.cache.set(e,t)}deleteDTO(e){this.cache.delete(e)}}),a.ModuleContainer.registerSingleton(Wl.i,class{constructor(){this.bucket=new Set}add(e){e&&this.bucket.add(e)}has(e){return this.bucket.has(e)}delete(e){this.bucket.delete(e)}}),a.ModuleContainer.register(Wl.n,$l),a.ModuleContainer.register(Wl.k,class{validateMessageByCompositeKey(e,t){return e.toString()==t.toString()}validateMessage(e){return!!e&&(!(!e.msgType||e.msgType==Y.MSG_UNDO)&&(!(!e.status||e.status>Y.MSG_AFTER_READ)&&!!(e.msgId&&e.cliMsgId&&e.fromUid&&e.toUid)))}}),a.ModuleContainer.register(Wl.s,Jl),a.ModuleContainer.register(Wl.f,vd),a.ModuleContainer.register(Wl.e,class{map(e,t){var s,a;const i=Object(Ll.getDataFromMessage)(t),n=Object(Ll.getTypeByMsg)(t),r=Object(Ll.getUserId)();let o,c="";ge.a.FromServer==e.actionSource&&(o=wl.a.srcAction.SyncAuto,c=wl.a.EntryFlow.fromServer),ge.a.MsgFlow==e.actionSource&&(o=wl.a.srcAction.Auto,c=wl.a.EntryFlow.msgFlow),ge.a.FromTransfer==e.actionSource&&(o=wl.a.srcAction.Auto,c=wl.a.EntryFlow.transferMsg);const l={type:n,entryFlow:c,data:Object(I.a)(Object(I.a)({},i),{},{userId:r,localPath:void 0}),options:{srcAction:o,showProgress:{progressBar:!1,taskBar:!1},caching:!0,duplicate:!1}};return t.msgType!=Y.MSG_PHOTO&&t.msgType!=Y.MSG_GIF||(l.options.saveDir=Object(wi.getZaloDownloadsPictureDirSync)(i.conversationId,r)),t.msgType==Y.MSG_FILE&&(l.data.fileName=l.data.checksum),t.msgType==Y.MSG_VOICE&&(l.data.fileName=null===(s=l.data.fileName)||void 0===s?void 0:s.replace(".aac","")),t.msgType==Y.MSG_CONTACT&&"object"==typeof t.message&&"recommened.link"===(null==t||null===(a=t.message)||void 0===a?void 0:a.action)&&(l.options.saveDir=Object(wi.getZaloDownloadsRichThumbDirSync)(r,i.conversationId)),new Rl.default(l)}}),a.ModuleContainer.register(Wl.r,pd),a.ModuleContainer.register(Wl.a,class{map(e){if(e)return new _d(e.actionSource,e.clientMsgId)}}),a.ModuleContainer.register(Wl.c,class{mapByMessage(e){var t,s;let a=null!==(t=e.toUid)&&void 0!==t&&t.startsWith(Y.GROUPID_PREFIX)?null===(s=e.toUid)||void 0===s?void 0:s.slice(Y.GROUPID_PREFIX.length):null==e?void 0:e.toUid;return new bd(e.cliMsgId,e.fromUid,a)}mapByAction(e){var t,s;let a=null!==(t=e.convId)&&void 0!==t&&t.startsWith(Y.GROUPID_PREFIX)?null===(s=e.convId)||void 0===s?void 0:s.slice(Y.GROUPID_PREFIX.length):null==e?void 0:e.convId,i=Ii.default.getUidMe()==e.fromId?"0":e.fromId;return new bd(e.clientMsgId,i,a)}}),a.ModuleContainer.registerSingleton(Wl.q,class{constructor(){this.maps=new Map}pauseByTopic(e){this.maps.get(e).enable=!1}resumeByTopic(e){this.maps.get(e).enable=!0}loadConfig(e,t){this.maps.set(e,Object(I.a)(Object(I.a)({enable:!0},this.maps.get(e)),{},{capacity:t,tokens:t}))}addByTopic(e){const t=this.maps.get(e);(null==t?void 0:t.tokens)<(null==t?void 0:t.capacity)&&(t.tokens+=1)}takeByTopic(e){const t=this.maps.get(e);return!!t.enable&&((null==t?void 0:t.tokens)>0&&(t.tokens-=1,!0))}}),a.ModuleContainer.registerSingleton(Wl.h,Kl),a.ModuleContainer.registerSingleton(Wl.d,hd),a.ModuleContainer.registerSingleton(Wl.g,Dl.Mediator);const Id=a.ModuleContainer.resolve(Yl.a),yd=a.ModuleContainer.resolve(Wl.q),Sd=Id.get("syncDownload.topics"),Cd=Id.get("syncDownload.tokens_bucket_size")||4;for(let EY of Sd)yd.loadConfig(EY,Cd),yd.loadConfig(`${EY}.dlt`,Cd);const Ed=a.ModuleContainer.resolve(Yl.a).get("syncDownload.topics"),Od=a.ModuleContainer.resolve(Wl.d);for(let EY of Ed)Od.createByTopic(EY);var Md;Object(Dl.NotificationHandler)(sd,1)(Md=Reflect.metadata("design:type",Function)(Md=Reflect.metadata("design:paramtypes",[])(Md=class{constructor(){this.tokenBucket=void 0,this.tokenBucket=a.ModuleContainer.resolve(Wl.q)}async handle(e){this.tokenBucket.addByTopic(e.topic.toString())}})||Md)||Md);var Td;const Rd=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue"]);Object(Dl.NotificationHandler)(Gl,1)(Td=Reflect.metadata("design:type",Function)(Td=Reflect.metadata("design:paramtypes",[])(Td=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.consumerServiceFactory=a.ModuleContainer.resolve(Wl.d),this.tokenBucket=a.ModuleContainer.resolve(Wl.q)}async handle(e){id.zsymb(23,"i2CMv-",["AllActionsConsumedEvent entry","uGLDEB"]);const t=e.topic;Rd.zsymb(23,"DxkTR_",["queue {}, done download","7eBC4X"],e.topic.toString());let s=this.consumerServiceFactory.getAll();s=s.filter((e=>e.topic.actionSrc==t.actionSrc)).filter((e=>e.topic.dlt));for(let a of s)a&&(this.tokenBucket.resumeByTopic(a.topic.toString()),this.tokenBucket.takeByTopic(a.topic.toString())&&a.consume())}})||Td)||Td);var wd;Object(Dl.NotificationHandler)(ad,1)(wd=Reflect.metadata("design:type",Function)(wd=Reflect.metadata("design:paramtypes",[])(wd=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.syncQueue=void 0,this.producer=void 0,this.syncActionMediator=void 0,this.consumerServiceFactory=a.ModuleContainer.resolve(Wl.d),this.producer=a.ModuleContainer.resolve(Wl.h),this.tokenBucket=a.ModuleContainer.resolve(Wl.q),this.syncQueue=a.ModuleContainer.resolve(Wl.p),this.syncActionMediator=a.ModuleContainer.resolve(Wl.g)}async handle(e){id.zsymb(23,"uVmO4j",["PullDownloadCommand entry","-1xz-s"]);const t=this.consumerServiceFactory.getByTopic(e.topic.toString());var s;if(this.syncQueue.lengthByTopic(e.topic.toString())<=0)e.reproduce?this.producer.produceByParams(e.topic.actionSrc,void 0,null===(s=e.syncData)||void 0===s?void 0:s.lastClientMsgId):await this.syncActionMediator.publish(new Gl(new Al(e.topic.actionSrc)));else for(;t&&this.tokenBucket.takeByTopic(e.topic.toString());)t.consume()}})||wd)||wd);var Ld;Object(Dl.NotificationHandler)(xl,1)(Ld=Reflect.metadata("design:type",Function)(Ld=Reflect.metadata("design:paramtypes",[])(Ld=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.consumerServiceFactory=a.ModuleContainer.resolve(Wl.d),this.tokenBucket=a.ModuleContainer.resolve(Wl.q)}async handle(e){id.zsymb(23,"zBVgLI",["PushDownloadCommand entry","MREw__"]);const t=`${e.topic}.dlt`;this.tokenBucket.pauseByTopic(t);const s=this.consumerServiceFactory.getByTopic(e.topic.toString());s&&this.tokenBucket.takeByTopic(e.topic.toString())&&s.consume()}})||Ld)||Ld);var Dd;Object(Dl.NotificationHandler)(nd,1)(Dd=Reflect.metadata("design:type",Function)(Dd=Reflect.metadata("design:paramtypes",[])(Dd=class{constructor(){this.syncQueueDLTRepository=void 0,this.syncQueueDLTRepository=a.ModuleContainer.resolve(Wl.o)}async handle(e){id.zsymb(23,"Xd_1hk",["DeadLetterUnshiftCommandHandler entry","TG5vK3"]),this.syncQueueDLTRepository.unshiftByTopic(e.topic.toString(),e.DltSyncData)}})||Dd)||Dd);var Ad;const Fd=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("tri-log",["queue retry"]);Object(Dl.NotificationHandler)(cd,1)(Ad=Reflect.metadata("design:type",Function)(Ad=Reflect.metadata("design:paramtypes",[])(Ad=class{constructor(){this.tokenBucket=void 0,this.consumerServiceFactory=void 0,this.syncDltQueue=void 0,this.consumerServiceFactory=a.ModuleContainer.resolve(Wl.d),this.tokenBucket=a.ModuleContainer.resolve(Wl.q),this.syncDltQueue=a.ModuleContainer.resolve(Wl.o)}async handle(e){id.zsymb(23,"c6BPuc",["PullDownloadCommandDlt entry","QKtpeR"]);const t=this.consumerServiceFactory.getByTopic(e.topic.toString());if(this.syncDltQueue.lengthByTopic(e.topic.toString())<=0)return Fd.zsymb(23,"VWCF5a",["retry queue {}, done download","T95dHO"],e.topic.toString()),void this.tokenBucket.pauseByTopic(e.topic.toString());for(;t&&this.tokenBucket.takeByTopic(e.topic.toString());)t.consume()}})||Ad)||Ad);var kd,Nd=s("MqnV"),Pd=s("+wBa");let jd=Object(a.injectable)()(kd=function(e,t){return Object(a.inject)(Nn.ConversationRepository)(e,void 0,0)}(kd=function(e,t){return Object(a.inject)(go)(e,void 0,1)}(kd=function(e,t){return Object(a.inject)(Nn.MuteDataManager)(e,void 0,2)}(kd=Reflect.metadata("design:type",Function)(kd=Reflect.metadata("design:paramtypes",[void 0===Nn.ConversationRepository?Object:Nn.ConversationRepository,"undefined"==typeof IMessageController?Object:IMessageController,void 0===Nn.MuteDataManager?Object:Nn.MuteDataManager])(kd=class{constructor(e,t,s){this.conversationRepository=e,this.messageLocalController=t,this.muteManager=s}getAllConvIds(){return this.conversationRepository.getAllConvIds()}async get(e){const t=await this.conversationRepository.get(e).catch((()=>{}));if(t)return new Nn.Conversation(t,this,this.messageLocalController)}isPinned(e){return this.conversationRepository.get(e).then((e=>!(null==e||!e.pinned))).catch((()=>!1))}isMuted(e){return!!this.muteManager.isMuted(e)}})||kd)||kd)||kd)||kd)||kd)||kd;var Ud;let Bd=a.ModuleContainer.injectable()(Ud=function(e,t){return a.ModuleContainer.inject(Nn.ConvInfoDataManager)(e,void 0,0)}(Ud=Reflect.metadata("design:type",Function)(Ud=Reflect.metadata("design:paramtypes",[void 0===Nn.ConvInfoDataManager?Object:Nn.ConvInfoDataManager])(Ud=class{constructor(e){this.convManager=e}getAllConvIds(){return this.convManager.getAllConvIds()}get(e){return this.convManager.getConvById(e)}})||Ud)||Ud)||Ud)||Ud;var zd=s("SVh1");var Gd=new class{constructor(){}showMyProfile(){Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:J.p.getSessionUserId()})}},xd=s("idnp"),Vd=s("mT88");var Hd=Object(a.define)("conversation-life-cycle-broadcast-channel");let Wd=function(e){return e.WillClose="WillClose",e.DidClose="DidClose",e.WillOpen="WillOpen",e.DidOpen="DidOpen",e.WillDelete="WillDelete",e.DidDelete="DidDelete",e}({});class qd extends hs.a{constructor(e,t){super(e),this.type=e,this.conversationID=t}}class Kd extends qd{constructor(e,t){super(Wd.WillClose,e),this.conversationID=e,this.windowID=t}}class Zd extends qd{constructor(e,t){super(Wd.DidClose,e),this.conversationID=e,this.windowID=t}}class $d extends qd{constructor(e,t){super(Wd.WillDelete,e),this.conversationID=e,this.windowID=t}}class Qd extends qd{constructor(e,t){super(Wd.DidDelete,e),this.conversationID=e,this.windowID=t}}class Yd extends qd{constructor(e,t){super(Wd.WillOpen,e),this.conversationID=e,this.windowID=t}}class Jd extends qd{constructor(e,t){super(Wd.DidOpen,e),this.conversationID=e,this.windowID=t}}const Xd=[],eu=[],tu=[],su=[],au=[],iu=[],nu={[Wd.WillClose]:{targets:Xd,callback:"onConversationWillClose"},[Wd.DidClose]:{targets:eu,callback:"onConversationDidClose"},[Wd.WillDelete]:{targets:tu,callback:"onConversationWillDelete"},[Wd.DidDelete]:{targets:su,callback:"onConversationDidDelete"},[Wd.WillOpen]:{targets:au,callback:"onConversationWillOpen"},[Wd.DidOpen]:{targets:iu,callback:"onConversationDidOpen"}};function ru(e,t){return e.push(t),function(e){const t=new Set,s=[];for(let a=0;a<e.length;a++){const i=e[a];t.has(i)||(t.add(i),s.push(i))}return s}(e)}function ou(){return function(e){ru(eu,e)}}function cu(){return function(e){ru(au,e)}}let lu;var du={GetModule:function(){return lu||(lu=a.ModuleContainer.resolve(Hd)),lu}},uu=s("s9sK"),hu=s("44Ud"),gu=s("E/Lo");hl.c;var mu,pu=s("SWHF"),fu=s("7gRy"),vu=s("q9t1");function _u(e,t,s){if(Ii.default.isOA(t)){let i=0;switch(e){case Q.a.ConvItem:i=8001;break;case Q.a.Support:i=1500;break;case Q.a.Notify:i=1402;break;case Q.a.SearchList:i=a.ModuleContainer.resolve(rc.SearchController).isShowRecentSearch?1252:1251;break;case Q.a.MessageOnMessaging:i=ui.default.isGroup(s)?1058:s&&Ii.default.isOA(s)?1108:1008;break;case Q.a.UriHelper:i=100}Ia.default.logActionInfoV2(Ia.FeaturesInfo.OpenOfficalAccount,1,{src_open:i,oa_id:t},[t])}}const bu="[Conversation controller]";function Iu(...e){ui.default.logCoreInfo(`${bu} - `,e)}let yu=Object(a.singleton)()(mu=Object(a.injectable)()(mu=function(e){Vd.d.GetChildWindowModuleManager().registerModule(uu.a,e,{isSingleton:!0})}(mu=function(e,t){return Object(a.inject)(Nn.PreviewDataManager)(e,void 0,0)}(mu=function(e,t){return Object(a.inject)(pu.b)(e,void 0,1)}(mu=function(e,t){return Object(a.inject)(el.e)(e,void 0,2)}(mu=function(e,t){return Object(a.inject)(el.o)(e,void 0,3)}(mu=function(e,t){return Object(a.inject)(rc.SidebarController)(e,void 0,4)}(mu=function(e,t){return Object(a.inject)(Nn.ConvInfoDataManager)(e,void 0,5)}(mu=Reflect.metadata("design:type",Function)(mu=Reflect.metadata("design:paramtypes",[void 0===Nn.PreviewDataManager?Object:Nn.PreviewDataManager,void 0===pu.b?Object:pu.b,void 0===el.e?Object:el.e,void 0===el.o?Object:el.o,void 0===rc.SidebarController?Object:rc.SidebarController,void 0===Nn.ConvInfoDataManager?Object:Nn.ConvInfoDataManager])(mu=class{constructor(e,t,s,a,i,n){this.previewManager=e,this.adminSettingController=t,this.communityController=s,this.groupLoadInfoController=a,this.sidebar=i,this.convDataManager=n,this.ipc=void 0,this.lastOpenConv=new Map,this._es=void 0,this.onRequestJumtoMsg=(e,t)=>{const s=t.conversation,a=e===ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT||In.a.getListChatBoxViewCurrent().includes(null==s?void 0:s.userId)||s.byPassPIN;if(!s)return;if(s&&!a&&In.a.isThreadHidden(s.userId))return Object(gc.b)({type:e,payload:t},!0),void Iu("req jum to msg rejected because hidden chat");Fa.default.Fps.record(Fa.MetricName.fps_jump_to_msg),Iu("req jum to msg open on main"),Object(gc.b)({type:e,payload:t},!0);const i=xd.b.fromJumpMessage();this.openConversationForJump(s.userId,i)},this.tryToFocusChild=(e,t)=>!!K.default.isOpenChildWindowByConvId(e)&&(Iu("Open conv forward because already open in child => call focus"),K.default.focusOnChildWindow(e,null==t?void 0:t.callPoint),!0),this.handleOutConversation=e=>{this.closeConversation(e.convId,{removed:!0})},this.listenEvent()}get eventStore(){return this._es||(this._es=s("emRR").default),this._es}listenEvent(){_e.default.subscribe(((e,t)=>{switch(e){case ve.ConversationListActions.SELECT_CONVERSATION_HIDDEN:this.sidebar.updateSelectedId(t.userId);break;case ve.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH:this.onRequestJumtoMsg(ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH,t);break;case ve.ChatBoxActions.OPEN_CONV_JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT:this.onRequestJumtoMsg(ve.ChatBoxActions.JUMP_TO_MESSAGE_SEARCH_HIDDEN_CHAT,t)}})),this.convDataManager.addEventListener(ai.b.DeleteConv,this.handleOutConversation),this.convDataManager.addEventListener(ai.b.EmptyConv,this.handleOutConversation),this.convDataManager.addEventListener(ai.b.LeaveGroup,this.handleOutConversation)}isConvOpeningInMain(e){const t=this.eventStore.getState(),s=this.sidebar.getState().selectedId;return t&&t.chatview.view===Jc.c.CHAT_VIEW&&s===e}openConversationForJump(e,t=xd.a){return new Promise((async s=>{if(Iu(`Request open conv for jum: ${e}`),!e||this.isConvOpeningInMain(e)){if(Iu(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||K.default.focusOnMainWindow()}return s(!1)}let a=Ar.c;if(!(await this.conversationShouldOpen(e)))return s(!1);this.conversationWillOpen(e,a);const i=this.sidebar.getSelectedId(a);i&&i!==e&&this.conversationWillClose(i,a);let n=!1;if(t.window===zd.b.Child)return n=this.tryToFocusChild(e,t),s(n);if(t.window===zd.b.PreferChild){if(n=this.tryToFocusChild(e,t),n)return s(!0)}else t.window===zd.b.MainAndChild&&(n=this.tryToFocusChild(e,t));n||K.default.focusOnMainWindow(),_e.default.send(ve.ConversationListActions.SELECT_CONV_MINOR,{userId:e}),Object(gc.b)({type:ve.ConversationListActions.OPEN_CONV_FOR_JUMP,payload:{userId:e}}),this.sidebar.updateSelectedId(e),s(!0),i&&i!==e&&this.conversationDidClose(i,a),this.conversationDidOpen(e,a),_u(t.callPoint,e)}))}openConversationInChildWindow(e,t,s){return this.conversationWillOpen(e,e),K.default.openConvInNewWindow(e,t,s),this.conversationDidOpen(e,e),_u(zd.a.ConvItem,e),Promise.resolve(!0)}onCloseChildWindow(e){this.conversationDidClose(e,e)}onOpenChildWindow(e){}openConversation(e,t=xd.a){return new Promise((async(s,i)=>{var n;if(Iu(`Request open conv from: ${e} - ${t.callPoint}`),!e||this.isConvOpeningInMain(e)&&!t.force){if(Iu(`Open conv rejected because null or opened: ${e}`),e){this.tryToFocusChild(e,t)||t.silently||K.default.focusOnMainWindow()}return s(!1)}let r=Ar.c;const o=this.sidebar.getSelectedId(r),c=J.p.getSessionUserId();if(e==c)return Gd.showMyProfile(),s(!1);Fa.default.Fps.record(Fa.MetricName.fps_switch_conv);if(!(await this.conversationShouldOpen(e)))return s(!1);this.conversationWillOpen(e,r),o&&o!==e&&this.conversationWillClose(o,r);let l=!1;if(t.window===zd.b.Child)return l=this.tryToFocusChild(e,t),s(l);if(t.window===zd.b.PreferChild){if(l=this.tryToFocusChild(e,t),l)return s(!0)}else t.window===zd.b.MainAndChild&&(l=this.tryToFocusChild(e,t));let d=t.credentConv;if(d||(d=await Re.default.getLikeConversation(e).catch((e=>{Iu(`Failure to load conv from store ${e}`)})),Iu(`Try to use storage conv: ${!!d}`)),d||(d=t.defaultConv,Iu(`Try to use default conv: ${!!d}`)),!d)return Iu(`Open conv not exists: ${e}`),s(!1);l||t.silently||K.default.focusOnMainWindow(),_e.default.send(ve.ConversationListActions.SELECT_CONV_MINOR,d);const u=In.a.isThreadHidden(e);u&&In.a.checkShowUnreadHiddenChat(e),t.byPassPIN?(d=Object(I.a)({},d),d.byPassPIN=1):delete d.byPassPIN,this.eventStore.dispatch({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:d}),_e.default.send(ve.ConversationListActions.SELECT_CONVERSATION,{userId:d.userId,needScroll:t.callPoint!==zd.a.ConvItem,callPoint:t.callPoint});(!u||t.byPassPIN||In.a.getListChatBoxViewCurrent().includes(d.userId))&&this.sidebar.updateSelectedId(e),s(!0),o&&o!==e&&this.conversationDidClose(o,r),this.conversationDidOpen(e,r),a.ModuleContainer.resolve(vu.b).promoteMigrateByOpenConv(e),_u(t.callPoint,e,null===(n=t.credentConv)||void 0===n?void 0:n.userId)}))}closeConversation(e,t={}){return new Promise((s=>{if(e&&this.sidebar.getState().selectedId!==e)return s(!1);const{windowId:a=Ar.c,removed:i}=t;if(this.conversationWillClose(e,a),a===Ar.c){const e={conversation:null,convId:null};this.eventStore.dispatch({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:e}),_e.default.send(ve.ConversationListActions.SELECT_CONVERSATION,e),i?this.sidebar.updateSelectedIdWithoutPrevious(null):this.sidebar.updateSelectedId(null)}this.conversationDidClose(e,a),s(!0)}))}closeAllConversations(){return Promise.resolve(!0)}deleteConversation(e,t=Ar.c){return new Promise((async s=>{if(this.conversationWillDelete(e,t),await sc.default.deleteConversation(e,!0,t),t===Ar.c){const a={userId:null};this.eventStore.dispatch({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:a}),_e.default.send(ve.ConversationListActions.SELECT_CONVERSATION,a),this.sidebar.updateSelectedId(null),s(!0),this.conversationDidDelete(e,t)}else s(!1)}))}pinConversation(e){return Promise.resolve(!0)}renameConversation(e){return Promise.resolve(!0)}getLastOpenConv(e){return this.lastOpenConv.get(e)}isOpeningConversation(e){const t=this.sidebar.getSelectedId();return!(!t||t!=e)||K.default.isOpenChildWindowByConvId(e)}conversationWillClose(e,t){du.GetModule().conversationWillClose(e,t)}conversationDidClose(e,t){du.GetModule().conversationDidClose(e,t)}conversationShouldOpen(e){return Iu(`Should open conv ${e}`),Iu(`Will open conv ${e}`),this.lastOpenConv.set(e,Date.now()),Promise.resolve(!0)}conversationWillOpen(e,t){hu.b.start(hu.a.ART,{convId:e}),Iu(`Conversation ${e} will be opened on windowID:${t}`),du.GetModule().conversationWillOpen(e,t)}conversationDidOpen(e,t){Fa.default.start(Fa.MetricName.open_conversation,e),Fa.default.start(Fa.MetricName.open_conversation_no_preload,e),Iu(`Did open conv ${e}`);const s=a.ModuleContainer.resolve(Nn.ConvInfoDataManager).getConvByIdSync(e);!a.ModuleContainer.resolve(Nn.ConvInfoDataManager).getLeaveType(s)&&this.adminSettingController.onLoadSetting(e),this.communityController.onConversationDidOpen(e),this.groupLoadInfoController.onOpenConversation(e),a.ModuleContainer.resolve(wa.a).onOpenConversation(e),a.ModuleContainer.resolve(fu.a).onOpenConversation(e),setTimeout((()=>{this.previewManager.revalidate(e)}),0),du.GetModule().conversationDidOpen(e,t)}conversationWillDelete(e,t){return Iu(`Will delete conv ${e}`),du.GetModule().conversationWillDelete(e,t),Promise.resolve()}conversationDidDelete(e,t){Iu(`Did delete conv ${e}`),this.lastOpenConv.delete(e),du.GetModule().conversationDidDelete(e,t)}})||mu)||mu)||mu)||mu)||mu)||mu)||mu)||mu)||mu)||mu)||mu;var Su,Cu=s("UYQr");let Eu=Object(a.injectable)()(Su=class{constructor(){this._activeConversationInfo=new Map}activateConversation(e,t){const s=this._getKey(e),a=this._activeConversationInfo.get(s);a?-1===a.windowIds.indexOf(t)&&(a.windowIds.push(t),this._activeConversationInfo.set(s,a)):this._activeConversationInfo.set(s,{convId:e,windowIds:[t]})}deactivateConversation(e,t){const s=this._getKey(e),a=this._activeConversationInfo.get(s);if(a){const e=a.windowIds.indexOf(t);-1!==e&&a.windowIds.splice(e,1),0===a.windowIds.length?this._activeConversationInfo.delete(s):this._activeConversationInfo.set(s,a)}}getActiveConversationInfo(e){const t=this._activeConversationInfo.get(this._getKey(e));return t?{convId:t.convId,windowIds:[...t.windowIds]}:{convId:"",windowIds:[]}}getActiveConvIdList(){let e=[];return this._activeConversationInfo.size>0&&(e=Array.from(this._activeConversationInfo.keys())),e}_getKey(e){return e}})||Su;var Ou=s("2rzQ"),Mu=s("+tVb"),Tu=s("UkBb"),Ru=s("Qtro"),wu=s("oiWN"),Lu=s("zo6P");let Du=function(e){return e.ABORTED="ABORTED",e.LAST_MSG_PROCESSED="LAST_MSG_PROCESSED",e}({});const Au=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.offline2Online,["last-message-processed-tracker"]);class Fu extends hs.b{constructor(...e){super(...e),this.lastMsgId=null,this.lastProcessedMsgId=null}abort(){this.dispatchEvent(new hs.a(Du.ABORTED)),this.removeAllEventListener()}onLastMessage(e){e?(this.lastMsgId=e,this.checkAndDispatchEventIfNeeded()):this.dispatchEventLastMessageProcessed()}onProcessedMessage(e){this.lastMsgId&&this.lastMsgId<e||(!this.lastProcessedMsgId||this.lastProcessedMsgId<e)&&(this.lastProcessedMsgId=e,this.checkAndDispatchEventIfNeeded())}checkAndDispatchEventIfNeeded(){const e=Number(this.lastMsgId),t=Number(this.lastProcessedMsgId),s=e&&t&&e===t;Au.zsymb(0,"SW5XW_","checkAndDispatchEventIfNeeded",{lastMsgId:e,lastProcessedMsgId:t,shouldDispatchEvent:s}),s&&this.dispatchEventLastMessageProcessed()}dispatchEventLastMessageProcessed(){this.dispatchEvent(new hs.a(Du.LAST_MSG_PROCESSED)),this.removeAllEventListener()}}var ku,Nu=function(e){return e[e.BATCHING=0]="BATCHING",e[e.IMMEDIATELY=1]="IMMEDIATELY",e}(Nu||{});let Pu=Object(a.injectable)()(ku=Object(yo.g)()(ku=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(ku=Reflect.metadata("design:type",Function)(ku=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(ku=class extends hs.b{constructor(e){super(),this.logger=void 0,this.config=void 0,this.mode=void 0,this.intervalBatching=void 0,this.lastProcessedMessageTracker=void 0,this.queueSignalRenderItems=void 0,this.queueSignalRenderLists=void 0,this.signalRenderItem=(...e)=>{switch(this.mode){case Nu.BATCHING:this.pushQueueSignalRenderItems(...e);break;case Nu.IMMEDIATELY:default:Object(nc.h)(...e),this.dispatchEvent(new hs.a(Lu.b.SIGNAL_RENDER_ITEM))}},this.signalRenderList=(...e)=>{switch(this.mode){case Nu.BATCHING:this.pushQueueSignalRenderLists(...e);break;case Nu.IMMEDIATELY:default:Object(nc.i)(...e),this.dispatchEvent(new hs.a(Lu.b.SIGNAL_RENDER_LIST))}},this.onStartPreprocessing=()=>{this.config.nestedKey("conv_ui_batching_updater.enable")&&this.startBatching()},this.onDonePullOfflineData=e=>{var t;this.mode===Nu.BATCHING&&(this.logger.zsymb(3,"HPpU3q",["receive done pull offline event","LJZr6k"]),null!=e&&e.maxMsgId?this.logger.zsymb(3,"RcIWCY",["receive last max msg {}","YY_jMb"],null==e?void 0:e.maxMsgId):this.logger.zsymb(3,"eaSUDZ",["don't have any offline data","4cIfsq"]),null===(t=this.lastProcessedMessageTracker)||void 0===t||t.onLastMessage(null==e?void 0:e.maxMsgId))},this.logger=e.createZLogger(w.ZLoggerNametags.offline2Online,["conversation-ui-updater"]),this.config=wu.b,this.mode=Nu.IMMEDIATELY,this.intervalBatching=null,this.lastProcessedMessageTracker=null,this.queueSignalRenderItems=[],this.queueSignalRenderLists=[],this.registerListener()}registerListener(){Mu.a.getInstance().addEventListener("start-preprocess",this.onStartPreprocessing),Tu.default.addEventListener(Tu.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{const{nextChatHandler:t,prevChatHandler:s}=e;null==s||s.unsubcribe(Ru.b.ON_DONE_OFFLINE,this.onDonePullOfflineData),null==t||t.subcribe(Ru.b.ON_DONE_OFFLINE,this.onDonePullOfflineData)})),this.config.addEventListener("update",(()=>{0===this.config.nestedKey("conv_ui_batching_updater.enable")&&(this.logger.zsymb(3,"ZEC5ff",["receive disable config, let stop batching immediately","udZziy"]),this.stopBatchingImmediately())}))}pushQueueSignalRenderItems(...e){this.queueSignalRenderItems.push(e)}pushQueueSignalRenderLists(...e){this.queueSignalRenderLists.push(e)}flushQueueSignalRender(){if(wu.b.nestedKey("debug.enable_ui_batching_log")&&oi.b.logUIBatching([...this.queueSignalRenderItems],[...this.queueSignalRenderLists]),this.queueSignalRenderItems.length>0){this.logger.zsymb(0,"MJckyx","flush queue items, queue size",this.queueSignalRenderItems.length);const e=Date.now().toString();Object(nc.j)(e);for(const t of this.queueSignalRenderItems)Object(nc.g)(e,...t);Object(nc.c)(e),this.queueSignalRenderItems=[],this.dispatchEvent(new hs.a(Lu.b.FLUSH_QUEUE_ITEM))}if(this.queueSignalRenderLists.length>0){this.logger.zsymb(0,"DzY8ee","flush queue list, queue size",this.queueSignalRenderLists.length);const e=[];for(const[t,s,a]of this.queueSignalRenderLists){const i=[t,s,Boolean(a)].join("::");e.includes(i)||(e.push(i),Object(nc.i)(t,s,a))}this.queueSignalRenderLists=[],this.dispatchEvent(new hs.a(Lu.b.FLUSH_QUEUE_LIST))}}startBatching(){this.logger.zsymb(0,"w14lCL","start batching"),this.mode=Nu.BATCHING,this.startIntervalFlushQueue(),this.setupStopBatching()}setupStopBatching(){var e;this.logger.zsymb(0,"Cv4NYQ","setup stop batching"),null===(e=this.lastProcessedMessageTracker)||void 0===e||e.abort();const t=a.ModuleContainer.resolve(rc.ConvListController),s=this.lastProcessedMessageTracker=new Fu,i=t.addEventListener(ai.c.PreviewChanged,(e=>{var t;const a=null===(t=e.payload)||void 0===t?void 0:t.changedItem;null!=a&&a.msgId&&s.onProcessedMessage(null==a?void 0:a.msgId)}));s.addEventListenerOnce(Du.ABORTED,(()=>{this.logger.zsymb(3,"2HOjRq",["aborted listener","gFfh4_"]),i()})),s.addEventListenerOnce(Du.LAST_MSG_PROCESSED,(()=>{this.logger.zsymb(3,"7ewMQ9",["last message processed, let stop batching","GcAMFJ"]),this.stopBatchingWithDelay(),i()}))}stopBatchingWithDelay(){const e=this.config.nestedKey("conv_ui_batching_updater.delay_after_stop_batching");this.logger.zsymb(3,"qI9eiP",["will stop batching after {}ms","PuFvMs"],e),setTimeout((()=>{this.stopBatchingImmediately()}),e)}stopBatchingImmediately(){this.flushQueueSignalRender(),this.stopIntervalFlushQueue(),this.mode=Nu.IMMEDIATELY,this.logger.zsymb(0,"NT6eOD","stop batching")}startIntervalFlushQueue(){var e;null===this.intervalBatching&&this.logger.zsymb(0,"elCPol","start interval flush queue"),null!==(e=this.intervalBatching)&&void 0!==e||(this.intervalBatching=setInterval((()=>{this.flushQueueSignalRender()}),this.config.nestedKey("conv_ui_batching_updater.interval_batching_update")))}stopIntervalFlushQueue(){this.intervalBatching&&clearInterval(this.intervalBatching),this.intervalBatching=null,this.logger.zsymb(0,"2hiRd8","stop interval flush queue")}})||ku)||ku)||ku)||ku)||ku;a.ModuleContainer.registerSingleton(Lu.a,Pu);var ju,Uu=s("TeMN"),Bu=s("Bzy+"),zu=(s("EHdh"),s("Ln14")),Gu=s("bdot"),xu=s("cfFl"),Vu=s.n(xu);const Hu={userId:Y.CONV_FILTER.STRANGER,label:null,isGroup:!1,respondedByMe:!1,numMsg:0,pinned:0,outside:0,topOut:!1,infoCheckSearch:null},Wu=["userId","label","firstSmsLocalId","lastSmsLocalId","isGroup","respondedByMe","numMsg","pinned","outside","lastActionId","topOutImprTimeOut","topOutTimeOut","syncFromMobile","topOut","localType","infoCheckSearch","preLastSmsLocalId"];Object(xi.b)(zu.c)(ju=function(e,t){return a.ModuleContainer.inject(Uu.b)(e,void 0,0)}(ju=Reflect.metadata("design:type",Function)(ju=Reflect.metadata("design:paramtypes",[void 0===ai.IReactiveDB?Object:ai.IReactiveDB])(ju=class extends hs.b{constructor(e){super(),this.DBConvInfo=e,this.name=void 0,this.key=void 0,this.data=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.fetchAllHolder=void 0,this.preloadCached=void 0,this._pm=void 0,this.pinEventQueue=void 0,this.labelEventQueue=void 0,this.doneEventQueue=void 0,this.name=zu.a,this.key="convId",this.data=new Map,this.didInit=!1,this.doneLoadDB=!1,this.fetchAllHolder=null,this.preloadCached=Bu.a.getInstance(),this._pm=null,this.pinEventQueue=[],this.labelEventQueue=[],this.doneEventQueue=!1}get previewManager(){return this._pm||(this._pm=a.ModuleContainer.resolve(Nn.PreviewDataManager)),this._pm}get unreadManager(){return me.a.UnreadDataManager}init(){if(this.didInit)return Promise.resolve();const e=Fa.default.start(Fa.MetricName.load_conversation_list),t=()=>{e.end(),me.a.ConvListController.removeEventListener(ai.c.LoadPreviewDone,t)};return me.a.ConvListController.addEventListener(ai.c.LoadPreviewDone,t),this.didInit=!0,this.loadData()}async loadData(){this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll());const e=await this.fetchAllHolder.catch((e=>{ui.default.logCoreInfo(`[${this.name}] - load conv from DB got error ${e}`)}))||[],t=await this.onLoadDataFromDB(e);ui.default.logCoreInfo(`[${this.name}] - done load db ${e.length}`),this.doneLoadDB=!0,this.doIdleTask(),this.broadcastEvent(ai.b.DoneLoadDB,"",e),this.previewManager.migrate(t.map((e=>e.userId))),this.setCacheData(Y.CONV_FILTER.STRANGER,Hu,!0)}async doIdleTask(){const e=this.pinEventQueue.slice(),t=this.labelEventQueue.slice();this.pinEventQueue=[],this.labelEventQueue=[];const s=Vu.a.series(e),a=Vu.a.series(t);return Promise.all([s,a]).then((e=>this.pinEventQueue.length||this.labelEventQueue.length?this.doIdleTask():(this.doneEventQueue=!0,e)))}getItem(e,t){return this.data.get(e.key)}getList(e,t){return e.key===zu.b.ALL?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}async onLoadDataFromDB(e){const t=await cc.ConvList.filterOutdatedConv(e);ui.default.logCoreInfo(`[${this.name}] - done filter outdate ${e.length} ${t.length}`);const s=(new Date).getTime().toString(),a=[];Object(nc.j)(s);for(let i=0;i<t.length;i++){if(!t[i].userId)continue;const e=Object(I.a)({},t[i]),n=this.data.get(e.userId);if(e.verified=!0,void 0===e.isGroup&&(e.isGroup=e.userId.startsWith(Y.GROUPID_PREFIX)),n){if(!n.verified){const t=this.mergeConv(e,n);t.verified=!0,this.setCacheData(e.userId,t),Object(nc.g)(s,this.name,e.userId),this.updateInDB(t)}}else this.setCacheData(e.userId,e),Object(nc.g)(s,this.name,e.userId);e.infoCheckSearch&&(e.infoCheckSearch&&ui.default.msgTypeValid(e.infoCheckSearch.lastType)?Yr.a.pushCacheLastChat(e.userId,e.infoCheckSearch.lastMessageTime):e.numMsg&&e.numMsg>1&&a.push(e.userId))}return a.length>0&&Yr.a.cacheCheckLastChatInDb(a),Object(nc.c)(s),t}onReceiveNewMessages(e,t,s={outside:void 0,isGroup:!1}){return new Promise(((a,i)=>{var n,r;if(!t||t.length<0)return i("Empty msgs");const o=t[t.length-1],c=t[0],l=this.data.get(e),d=cc.ConvList.getLastValidMsg(t);let u,h;d&&(u={lastMessageTime:Number(d.sendDttm),lastType:d.msgType},Yr.a.pushCacheLastChat(e,u.lastMessageTime)),o.msgType===Y.MSG_INFO&&(null==l||null===(n=l.infoCheckSearch)||void 0===n?void 0:n.lastMessageTime)>Number(o.sendDttm)&&(h=null==l?void 0:l.lastSmsLocalId);const g={userId:e,firstSmsLocalId:c.msgId,isGroup:s.isGroup||e.startsWith(Y.GROUPID_PREFIX),numMsg:t.length,respondedByMe:_o.default.includeMyMessage(t),pinned:0,label:null,topOut:o.topOut,verified:!1,lastSmsLocalId:h||o.msgId,outside:s.outside,cloudMore:!1,infoCheckSearch:u};if(this.preloadCached&&this.preloadCached.onNewMsg(e,o),l){const t=this.mergeConv(Object(I.a)({},l),g);this.setCacheData(e,t),this.shouldSignalUpdate(l,t)&&Object(nc.h)(this.name,e),l.verified&&this.updateInDB(t),a(t)}else{const s=lc.a.getLabelObjByConversaionId(e);if(g.label=s?s.id:null,this.setCacheData(e,g,!0),this.doneLoadDB){g.verified=!0,this.updateInDB(g);return _o.default.includeJoinEvent(t)&&(ui.default.logCoreInfo(`[${this.name}] - Detect join msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e)),a(g)}this.DBConvInfo.getById(e).then((t=>{const s=this.data.get(e);if(!s)return i("Internal logic handle wrong");let n=Object(I.a)({},s);n.verified=!0,t?s.verified||(n=this.mergeConv(n,t),this.setCacheData(e,n),this.shouldSignalUpdate(n,s)&&Object(nc.h)(this.name,e),this.updateInDB(n)):this.updateInDB(n),a(n)}))}l&&l.respondedByMe||null===(r=this.data.get(e))||void 0===r||!r.respondedByMe||(ui.default.logCoreInfo(`[${this.name}] - Detect first my msg ${e} ${o.msgId}`),this.previewManager.forceChangeItem(e))}))}async onDeleteMessages(e,t){const s=this.data.get(e);if(ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #1 ${e} ${t.length}`),s&&s.verified){let a=!1;if(t.find((({msgId:e})=>s.firstSmsLocalId===e))){const t=await(await Gu.b.getFirstMessage(e)).firstMsg;if(!t)return ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #4 ${e} `),this.forkDeleteCacheAndDB(e),{deletedId:e};s.firstSmsLocalId=null==t?void 0:t.msgId,a=!0}if(t.find((({msgId:e})=>s.lastSmsLocalId===e))){const t=await Gu.b.getLastMessage(e,s.lastSmsLocalId);if(!t||t.length<1)return ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #5 ${e} ${!!t}`),this.forkDeleteCacheAndDB(e),{deletedId:e};s.lastSmsLocalId=t[0].msgId,a=!0}return ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #6 ${e} ${a}`),a&&(this.setCacheData(e,Object(I.a)({},s)),this.updateInDB(s)),{conversation:s,updated:a}}{const t=await(await Gu.b.getFirstMessage(e)).firstMsg,s=await Gu.b.getLastMessage(e),a=s&&s[0];if(!t||!a)return ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #2 ${e} ${!!t} ${!!a}`),me.a.PinDataManager.isPinned(e)||this.onDeleteConversation(e),{deletedId:e};const i=await this.DBConvInfo.getById(e);let n=ui.default.msgTypeValid(a)?{lastMessageTime:a.sendDttm,lastType:a.msgType}:void 0;if(ui.default.logCoreInfo(`[${this.name}] - onDeleteMessages #3 ${e} ${!!i}`),i){let s=!1;i.firstSmsLocalId!==(null==t?void 0:t.msgId)&&(i.firstSmsLocalId=null==t?void 0:t.msgId,s=!0),i.lastSmsLocalId!==a.msgId&&(i.lastSmsLocalId=null==a?void 0:a.msgId,s=!0);const n=Object(I.a)(Object(I.a)({},i),{},{verified:!0});return this.setCacheData(e,n,!0),s&&this.updateInDB(n),{conversation:n,updated:!0}}{const s={userId:e,isGroup:e.startsWith(Y.GROUPID_PREFIX),pinned:0,label:null,topOut:void 0,verified:!0,outside:null,cloudMore:!1,firstSmsLocalId:t.msgId,lastSmsLocalId:a.msgId,numMsg:2,respondedByMe:"0"==t.fromUid||"0"==a.fromUid,infoCheckSearch:n};return this.setCacheData(e,s,!0),this.updateInDB(s),{conversation:s,updated:!0}}}}getLeaveType(e){const t=null==e?void 0:e.localType;return t===Y.LOCAL_CONVERSATION_TYPE.KICK_GROUP?"kick":t===Y.LOCAL_CONVERSATION_TYPE.DISBAND_GROUP?"disband":void 0}mergeConv(e,t){const s=e=>null!=e&&("string"==typeof e?!e.includes("undefined")&&!e.includes("null"):"number"==typeof e&&!isNaN(e));let a=!1;return s(e.lastSmsLocalId)?s(t.lastSmsLocalId)&&(a=t.lastSmsLocalId>e.lastSmsLocalId):a=!0,a&&(e.preLastSmsLocalId=e.lastSmsLocalId||t.lastSmsLocalId,e.lastSmsLocalId=t.lastSmsLocalId,e.outside=t.outside),e.numMsg=(e.numMsg||0)+t.numMsg,e.respondedByMe=e.respondedByMe||t.respondedByMe,(!e.firstSmsLocalId||t.firstSmsLocalId&&t.firstSmsLocalId<e.firstSmsLocalId)&&(e.firstSmsLocalId=t.firstSmsLocalId),(!e.infoCheckSearch||!e.infoCheckSearch.lastMessageTime||t.infoCheckSearch&&t.infoCheckSearch.lastMessageTime>e.infoCheckSearch.lastMessageTime)&&(e.infoCheckSearch=t.infoCheckSearch),e.preLastSmsLocalId||(e.preLastSmsLocalId=t.lastSmsLocalId),!t.respondedByMe&&t.topOut&&(e.topOut=t.topOut),"string"!=typeof e.firstSmsLocalId&&(e.firstSmsLocalId=""+e.firstSmsLocalId),ui.default.isKickOrDisbandGroup(e)&&(e.localType=void 0),e}async onEmptyConversation(e){const t=await this.getConvById(e);if(ui.default.logCoreInfo(`[${this.name}] - onEmptyConversation ${e} ${!!t}`),!t)return;const s=Object(I.a)({},t);return delete s.firstSmsLocalId,delete s.lastSmsLocalId,s.numMsg=0,s.respondedByMe=!1,this.setCacheData(e,s,!0),this.broadcastEvent(ai.b.EmptyConv,e),Object(nc.h)(this.name,e),me.a.PinDataManager.isPinned(e)&&me.a.PinDataManager.unpin([e]),this.updateInDB(s)}onDeleteConversation(e,t){ui.default.logCoreInfo(`[${this.name}] - onDeleteConversation ${e}`);const s=this.data.get(e);return s&&(s.leaveType=t),this.doDeleteConversation(e).then((a=>{let i;this.broadcastEvent(ai.b.DeleteConv,e,s),"kick"===t?i=Y.LOCAL_CONVERSATION_TYPE.KICK_GROUP:"disband"===t&&(i=Y.LOCAL_CONVERSATION_TYPE.DISBAND_GROUP),i&&s&&this.createEmptyConvForUser(e,0,Y.CONV_OT_STATE.none,Object(I.a)(Object(I.a)({},s),{},{localType:i}))}))}doDeleteConversation(e){const t=this.data.get(e);return ui.default.logCoreInfo(`[${this.name}] - doDeleteConversation ${e} ${!!t}`),t&&(this.data.delete(e),Object(nc.f)(this.name,e)),me.a.PinDataManager.isPinned(e)&&me.a.PinDataManager.unpinLocal([e]),this.deleteInDB(e)}onPinConversation(e,t){return new Promise((s=>{this.doneEventQueue?this.doUpdatePin(e,t).then(s):this.pinEventQueue.push((async()=>{const a=await this.doUpdatePin(e,t);s(a)}))}))}doUpdatePin(e,t){if(t&&cc.ConvList.isStrangerV2(e))return Promise.resolve(null);if(!this.data.get(e)){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const s=new Map;return s.set("pinned",t),this.updateFields(e,s).then((s=>(this.broadcastEvent(ai.b.ChangePinConv,e,t),s))).catch((t=>(ui.default.logCoreInfo(`[${this.name}] - doUpdatePin err`,t),this.data.get(e))))}onLeaveGroup(e,t){return t?(this.broadcastEvent(ai.b.LeaveGroup,e),Promise.resolve()):(ui.default.logCoreInfo(`[${this.name}] - onLeaveGroup ${e}`),this.doDeleteConversation(e).then((t=>{this.broadcastEvent(ai.b.LeaveGroup,e)})))}async onChangeConvLabel(e,t){return new Promise((s=>{const a=this.data.get(e);if(a&&a.label===t)return s(a);this.doneEventQueue?this.doUpdateConvLabel(e,t).then(s):this.labelEventQueue.push((async()=>{const a=await this.doUpdateConvLabel(e,t);s(a)}))}))}doUpdateConvLabel(e,t){if(!e)return ui.default.logCoreInfo(`[${this.name}] - doUpdateConvLabel with undefined ${t}`),Promise.resolve(null);const s=this.data.get(e);if(s&&s.label===t)return Promise.resolve(s);if(!s){if(!t)return Promise.resolve(null);const s=this.getEmptyConv(e);s.verified=!0,this.setCacheData(e,s)}const a=new Map;return a.set("label",t),this.updateFields(e,a).then((a=>(this.unreadManager.onChangeConvLabel(e,null==s?void 0:s.label,t),a)))}onFetchConvLabels(e){if(!e||!Array.isArray(e))return;ui.default.logCoreInfo(`[${this.name}] - onChangeConvLabel ${e.length}`);const t={};this.getAllConv().then((s=>{for(let e=0;e<s.length;e++)t[s[e].userId]=1;for(let a=0;a<e.length;a++){const s=e[a].id,i=e[a].conversations;if(i)for(let e=0;e<i.length;e++){const a=i[e];delete t[a],this.onChangeConvLabel(a,s)}}for(const e in t)Object.hasOwnProperty.call(t,e)&&this.onChangeConvLabel(e,null)}))}onDeleteConvLabels(e){ui.default.logCoreInfo(`[${this.name}] - onDeleteConvLabels ${e.length}`),e.forEach((e=>{const t=e.conversations;if(t&&t.length)for(let s=0;s<t.length;s++)this.data.has(t[s])&&this.onChangeConvLabel(t[s],null)}))}async onUpdateMsgId(e,t,s){if(!t||!s||t===s)return Promise.reject("[Conv-info-manager]- call update with invalid params!");const a=this.data.get(e);let i=a||{},n=!1;if(!a||!a.verified){const t=await this.DBConvInfo.getById(e);if(!a&&!t){const t=await this.createEmptyConvForUser(e,0,void 0,{firstSmsLocalId:s,lastSmsLocalId:s});return this.setCacheData(e,t),t}a&&t?(i=this.mergeConv(a,t),n=!0):(i=a||t,i.verified=!0,n=!0)}return i.firstSmsLocalId&&i.firstSmsLocalId!==t||(n=!0,i.firstSmsLocalId=s),i.lastSmsLocalId&&i.lastSmsLocalId!==t||(n=!0,i.lastSmsLocalId=s),n&&(this.setCacheData(e,i),this.updateInDB(i)),i}async addOrUpdateConv(e,t,s,a,i,n){"number"==typeof t&&(t=""+t),"number"==typeof s&&(s=""+s);const r=this.data.get(e);ui.default.logCoreInfo(`[${this.name}] - addOrUpdateConv ${e} ${!!r} ${s}`);const o=e=>((!e.firstSmsLocalId||t&&t<e.firstSmsLocalId)&&(e.firstSmsLocalId=t),(!e.lastSmsLocalId||s&&s>e.lastSmsLocalId)&&(e.lastSmsLocalId=s),e.cloudMore=a,e.respondedByMe=e.respondedByMe||i,e.numMsg=(e.numMsg||0)+n,e);if(r&&r.verified){const t=o(r);return this.setCacheData(e,Object(I.a)({},t)),this.updateInDB(t),t}{const r=await this.DBConvInfo.getById(e);if(ui.default.logCoreInfo(`[${this.name}] - addOrUpdateConv #2 ${e} ${!!r}`),r){const t=o(r);return this.setCacheData(e,Object(I.a)(Object(I.a)({},t),{},{verified:!0})),this.updateInDB(t),t}{const r={userId:e,firstSmsLocalId:t,lastSmsLocalId:s,isGroup:e.startsWith(Y.GROUPID_PREFIX),respondedByMe:i,numMsg:n||2,label:null,pinned:0,verified:!0,cloudMore:a,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),r}}}async addIfNotExistsConv(e,t,s,a,i,n){const r=this.data.get(e);if(ui.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #1 ${e} ${!!r} ${a}`),r)return!1;const o=await this.DBConvInfo.getById(e);if(ui.default.logCoreInfo(`[${this.name}] - addIfNotExistsConv #2 ${!!o}`),o)return!1;{const r={userId:e,firstSmsLocalId:s,lastSmsLocalId:a,isGroup:t||e.startsWith(Y.GROUPID_PREFIX),respondedByMe:i,numMsg:n||1,label:null,pinned:0,verified:!0,outside:null,topOut:null,infoCheckSearch:void 0};return this.setCacheData(e,r,!0),this.updateInDB(r),!0}}createEmptyConvForUser(e,t,s=Y.CONV_OT_STATE.none,a){return new Promise(((i,n)=>{this.getConvById(e).then((i=>{let n;if(ui.default.logCoreInfo(`[${this.name}] - createEmptyConvForUser ${e} ${!!i}`),i){const a=new Map;return n=i,s!==Y.CONV_OT_STATE.none&&void 0!==s&&(n.outside=s,a.set("outside",s)),t&&!me.a.PinDataManager.isPinned(n.userId)&&me.a.PinDataManager.pin([n.userId]),this.updateFields(e,a),n}return n=Object(I.a)({userId:e,lastMessageTime:t?0:Ct.default.getTimeNow(),isGroup:e.startsWith(Y.GROUPID_PREFIX)},a),s!==Y.CONV_OT_STATE.none&&void 0!==s&&(n.outside=s),t&&me.a.PinDataManager.pin([n.userId]),n.verified=!0,this.setCacheData(e,n,!0),this.updateInDB(n),n})).then((e=>{i(e)})).catch((e=>{ui.default.logCoreError(e),n(e)}))}))}updateLastMsgId(e,t){const s=this.data.get(e);if(s&&s.lastSmsLocalId===t)return Promise.resolve(s);const a=new Map;return a.set("lastSmsLocalId",t),this.updateFields(e,a)}updateInfoCheckSearch(e,t,s){const a=this.data.get(e);if(a&&a.infoCheckSearch&&a.infoCheckSearch.lastMessageTime===t)return Promise.resolve(a);const i=new Map;return i.set("infoCheckSearch",{lastMessageTime:t,lastType:s}),this.updateFields(e,i)}updateConvSetting(e,t){let s=this.data.get(e);if(!s){const a=!!this.doneLoadDB;s={userId:e,verified:a},a||ui.default.logCoreInfo(`[${this.name}] - update conv setting before done load db ${e}`,t)}ui.default.shallowEqual(s.setting,t)||(s.setting=t,this.setCacheData(e,s,!0),ui.default.logCoreInfo(`[${this.name}] - update conv setting for conv ${e}`,t))}async isRespondedByMe(e){const t=await this.getConvById(e);return!!t&&Boolean(t.respondedByMe)}isRespondedByMeSync(e){const t=this.data.get(e);return!!t&&Boolean(t.respondedByMe)}isDoneLoadDB(){return this.doneLoadDB}getConvByIdSync(e){return"string"!=typeof e&&ui.default.logCoreInfo(`[${this.name}] - getConvByIdSync with invalid id type`,e,!!this.data.get(e),!!this.data.get(""+e)),this.data.get(e)}getConvById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvInfo.getById(e).then((e=>{t(e)})).catch(s)}))}getAllConvSync(){return Array.from(this.data.values())||[]}getAllConv(){return new Promise(((e,t)=>{if(this.doneLoadDB){return e(this.getAllConvSync())}this.fetchAllHolder||(this.fetchAllHolder=this.DBConvInfo.getAll()),this.fetchAllHolder.then(e).catch(t)}))}getAllConvIds(){return this.getAllConv().then((e=>e.map((({userId:e})=>e))))}getAllConvIdsSync(){return Array.from(this.data.keys())}onDoneSyncMobile(){ui.default.logCoreInfo(`[${this.name}] - onDoneSyncMobile`),this.getAllConv().then((e=>{e&&this.previewManager.migrate(e.map((e=>e.userId)),!0)}))}setCacheData(e,t,s=!1){this.data.set(t.userId,t),s&&Object(nc.h)(this.name,e)}updateFields(e,t){return new Promise(((s,a)=>{const i=this.data.get(e),n=i=>{ui.default.logCoreInfo(`[${this.name}] - updateFields #2`);const n=Object(I.a)({},i);t.forEach(((e,t)=>{n[t]=e})),this.setCacheData(e,n,!0),this.updateInDB(n).then((()=>{s(n)})).catch(a)};i?n(i):this.DBConvInfo.getById(e).then((e=>{e&&n(e)}))}))}forkDeleteCacheAndDB(e){if(ui.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e}`),!me.a.PinDataManager.isPinned(e)){const t=this.data.get(e);ui.default.logCoreInfo(`[${this.name}] - forkDeleteCacheAndDB ${e} ${!!t}`),this.data.delete(e),Object(nc.f)(this.name,e),this.deleteInDB(e).then((s=>{this.broadcastEvent(ai.b.DeleteConv,e,t)}))}}broadcastEvent(e,t="",s){this.dispatchEvent(new ai.a(e,t,s))}shouldSignalUpdate(e,t){return me.a.PinDataManager.isPinned(e.userId)!==me.a.PinDataManager.isPinned(t.userId)||e.label!==t.label||e.respondedByMe!==t.respondedByMe}cleanConversation(e){return Object.keys(e).forEach((t=>{Wu.includes(t)||delete e[t]})),e}getEmptyConv(e){return{userId:e,isGroup:e.startsWith(Y.GROUPID_PREFIX),numMsg:0,respondedByMe:!1,pinned:0,label:null,outside:null,infoCheckSearch:null,topOut:null}}updateInDB(e){const t=this.cleanConversation(Object(I.a)({},e));return this.DBConvInfo.addOrUpdate(t).catch((e=>{ui.default.logCoreInfo(`[${this.name}] - updateInDB got error ${e}`)}))}deleteInDB(e){return this.DBConvInfo.remove(e).catch((e=>{ui.default.logCoreInfo(`[${this.name}] - deleteInDB got error ${e}`)}))}})||ju)||ju)||ju);var qu,Ku=s("NSWB"),Zu=s("1Abx"),$u=s("XEtq"),Qu=s("ZRfj"),Yu=s("oH3T"),Ju=s("13iL"),Xu=s("WK05"),eh=s("bSQ5"),th=s("dwTj"),sh=s("RVT8"),ah=s("hkvp"),ih=s("6tnf"),nh=s("sg3c"),rh=s("ofhN"),oh=s("D8f9"),ch=s("bgEr"),lh=s("PGx3");const dh="9999999999999999",uh="zum_m",hh="1.0.0",gh="paucfoa_ts_key",mh=!1,ph="total",fh=e=>({convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"",lastSeenReactId:"",unreadMark:void 0}),vh={CALL_INIT:!1},_h=1,bh=2;Object(xi.b)(sh.b)(qu=function(e,t){return a.ModuleContainer.inject(ah.b)(e,void 0,0)}(qu=function(e,t){return a.ModuleContainer.inject(Nn.ConversationUIUpdater)(e,void 0,1)}(qu=Reflect.metadata("design:type",Function)(qu=Reflect.metadata("design:paramtypes",[void 0===ai.IReactiveDB?Object:ai.IReactiveDB,void 0===Nn.ConversationUIUpdater?Object:Nn.ConversationUIUpdater])(qu=class extends hs.b{constructor(e,t){super(),this.DBConvUnread=e,this.conversationUIUpdater=t,this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this.pendingMessage=void 0,this.previewMsgs=void 0,this.pendingClearUnread=void 0,this.fetchAllHolder=void 0,this.total=void 0,this.loadState=vh,this.isLoadDBStarted=void 0,this.updateTotalQueue=void 0,this._logger=void 0,this.setupQueue=()=>Object(xu.queue)((async e=>{this.doneLoadDB&&await this.calculateComputeUnreadCount(e)}),1),this._getDeletedMsgByTTLItem=(e,t)=>{if(t)return t.find((t=>e.msgId?e.msgId===t.msgId:e.cliMsgId===t.cliMsgId))},this.name=sh.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.isLoadDBStarted=!1,this.pendingMessage=new Map,this.previewMsgs=[],this.pendingClearUnread=new Map,this.fetchAllHolder=null,this.total=this.getEmptyTotal(),this.updateTotalQueue=this.setupQueue(),this.resetToUnreadReddotOAIfNeeded_=this.resetToUnreadReddotOAIfNeeded_.bind(this),this.handleConvUnreadCountConfigChange_=this.handleConvUnreadCountConfigChange_.bind(this)}init(){this.didInit||(this.logger.zsymb(3,"q0RVZN",["call init unread","IUZc22"]),this.didInit=!0,this.addListener(),this.onState("CALL_INIT"))}onState(e){this.loadState[e]=!0;const t=Object.values(this.loadState).every((e=>!0===e));t&&!this.isLoadDBStarted&&(this.logger.zsymb(3,"vrKxB6",["done all state, ready to load db...","dbRUwN"]),this.loadData())}get logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.conversation,[w.ZLoggerNametags.unread])),this._logger}getEmptyTotal(){return{convId:"total",smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:0,smsUnreadNomute:0}}loadData(){const e=n.default.getInstance().getItemForCurrentUser(uh);if(e===hh)this.isLoadDBStarted=!0,this.logger.zsymb(3,"KK5hRU",["start load unread {}","4572HF"],e),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((e=>{this.onLoadUnreadFromDBV2(bh,e.map(this.toUnreadItem)),this.doDoneLoadDBTask()}));else{me.a.ConvInfoDataManager.isDoneLoadDB()&&(this.isLoadDBStarted=!0,this.migrateV2())}}async resetToUnreadReddotOAIfNeeded_(){try{let e=ch.b().enable_for_oa,t=await n.default.getInstance().getItemForCurrentUserAsync(gh),s=!1,a=!1;if(null==t)this.logger.zsymb(0,"4fE9pa","Force reset to unread reddot OA at first time."),s=!0;else{const[s,i]=t.split("_").map(Number);if(e===s)return;const n=!e&&1==s,r=Boolean(e)&&0==s;a=n||r,this.logger.zsymb(3,"0CKQCm",["shouldResetToUnreadReddotByRule by mainRule: {} - subRule: {}","7MrVOM"],n,r)}if(s||a){if(this.data.size>0){this.logger.zsymb(0,"xft7Mr","perf reset to default unread reddot OA.");const e=e=>{const t=e.smsUnreadCount||0;let s=e.smsUnreadNotCount||0;const a=t-s;return a>0?(this.logger.zsymb(3,"mkE6_P",["resetToDefaultUnreadReddotItemIfNeeded - OAConvId: {} - count: {} - smsUnreadNotCount: {}","X9WISm"],e.convId,a,s),s=s||1,{shouldReset:!0,data:Object(I.a)(Object(I.a)({},e),{},{smsUnreadCount:s,smsUnreadNotCount:s,strangerUnreadCount:s})}):{shouldReset:!1,data:e}},t=Array.from(this.data.values()),s=new Map;t.forEach((e=>s.set(e.convId,Object(I.a)({},e))));const a=t.map((e=>e.convId));this.logger.zsymb(3,"-16D2o",["before verify oa convs: {}","KlQQ2n"],Date.now());const i=(await cc.ConvList.verifyOATypeAsync(a)).reduce(((t,a)=>{if(a.isOA&&s.has(a.cid)){const i=s.get(a.cid),{shouldReset:n,data:r}=e(i);n&&t.push(r)}return t}),[]);if(this.logger.zsymb(3,"rt9LOa",["Reset to default unread reddot OA - count: {} - ts: {}","tOTNxU"],i.length,Date.now()),i.length){const e=Date.now().toString();Object(nc.j)(e),i.forEach((t=>{this.data.set(t.convId,t),Object(nc.g)(e,this.name,t.convId),this.updateInDB(t)})),Object(nc.c)(e),this.unreadChanged("reset")}}}const i=`${e}_${Date.now()}`;this.logger.zsymb(3,"8ivgZY",["apply new unread count for OA config - newAppliedConfigAndTS: {}","zKga3E"],i),n.default.getInstance().setItemForCurrentUserAsync(gh,i)}catch(e){this.logger.zsymb(21,"7YfjnA",["reset to unread reddot OA if needed error: {}","unihUE"],null==e?void 0:e.message)}}handleConvUnreadCountConfigChange_(e){const{prevConfig:t,nextConfig:s}=e;t.enable_for_oa!==s.enable_for_oa&&this.doneLoadDB&&this.resetToUnreadReddotOAIfNeeded_()}shouldForceShowReddotForOAMessages_(e,t=!1){const s=ch.b().enable_for_oa;return Boolean(!s&&(t||e&&cc.ConvList.isOAType({userId:e})))}async migrateV2(){const e=n.default.getInstance(),t=e.getItemForCurrentUser(uh)===hh;if(this.logger.zsymb(3,"5p58T_",["call migrate unread {}","_MKz-L"],t),t)return;const s=me.a.ConvInfoDataManager.getAllConvSync(),a=[];s.forEach((e=>{const t=e.smsUnreadCount||0,s=e.smsUnreadNotCount||0,i=e.mentionUnreadCount||0,n=e.unreadMark||null;if(!(e&&e.userId&&(t||s||i||n)))return;const r={convId:e.userId,smsUnreadCount:t,smsUnreadNotCount:s,strangerUnreadCount:0,mentionUnreadCount:i,lastProcessMsgId:e.lastMessageIdFromServerv2||"0",lastSeenReactId:e.lastSeenReactId||"0",unreadMark:n};a.push(r)})),this.onLoadUnreadFromDBV2(_h,a),this.doDoneLoadDBTask(),this.logger.zsymb(3,"ei5FOo",["done migrate unread {}","bfrB8L"],a.length),e.setItemForCurrentUser(uh,hh)}async doDoneLoadDBTask(){await this.resetToUnreadReddotOAIfNeeded_();const e=Array.from(this.data.values());this.doneLoadDB=!0,this.broadcastEvent(ai.b.DoneLoadDB,"total",e),this.logger.zsymb(3,"d0B63h",["done load unread {}","Zyuu4F"],e.length),Object(lh.e)(e),setTimeout((()=>{this.unreadChanged("init")}),200)}addListener(){me.a.MuteDataManager.addEventListener(ai.b.MuteChanged,(e=>{this.onMuteConversation(e.convId,!!e.payload)})),me.a.ConvInfoDataManager.addEventListener(ai.b.LeaveGroup,(e=>{this.doDeleteUnread(e.convId)})),me.a.ConvInfoDataManager.addEventListener(ai.b.DeleteConv,(e=>{this.doDeleteUnread(e.convId)})),me.a.ConvInfoDataManager.addEventListener(ai.b.EmptyConv,(e=>{this.doDeleteUnread(e.convId)})),me.a.ConvInfoDataManager.addEventListener(ai.b.DoneLoadDB,(e=>{this.onState("CALL_INIT")})),me.a.ArchivedChatManager.addEventListener(ai.b.UpdateListArchivedChat,(e=>{this.onArchivedChat(e.convId)})),_e.default.subscribe(((e,t)=>{if(null!=t&&t.length&&e===ve.ConversationListActions.CLEAR_MARK_AS_UNREAD)t.forEach((e=>{this.updateUnreadMark(e,null)}));else if(null!=t&&t.length&&e===ve.GeneralActions.UPDATE_HIDDEN_CHAT)for(let s=0;s<t.length;s++){const e=t[s];this.onHiddenConversation(e.uid,e.isHide)}})),ch.a(this.handleConvUnreadCountConfigChange_)}getItem(e,t){if(e.key===ph)return this.total;return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){}onGetListFailure(e){throw new Error("Method not implemented.")}onMuteConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||In.a.isThreadHidden(e)||this.shouldForceShowReddotForOAMessages_(e)||(this.logger.zsymb(0,"RY5D_W","onMuteConversation:",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onHiddenConversation(e,t){const s=this.data.get(e);!s||s.smsUnreadCount<1&&!s.unreadMark||Re.default.isMuted(e)||this.shouldForceShowReddotForOAMessages_(e)||(this.logger.zsymb(0,"iyjLsP","onHiddenConversation: ",e,t,s.smsUnreadCount,s.smsUnreadNotCount),this.unreadChanged(e))}onArchivedChat(e){const t=this.data.get(e);!t||t.smsUnreadCount<1&&!t.unreadMark||Re.default.isMuted(e)||this.shouldForceShowReddotForOAMessages_(e)||this.unreadChanged(e)}onChangeConvLabel(e,t,s){const a=this.data.get(e);t===s||!a||a.smsUnreadCount<1||Re.default.isMuted(e)||this.unreadChanged(e)}onReceivePreviewMessages(e){e.length>0&&(this.previewMsgs=[...this.previewMsgs,...e])}onReceiveNewMessagesOld(e,t,s){if(!s||!t)return;const a=this.data.get(e);if(a)this.logger.zsymb(0,"1WKMam","receive msg",e,a.lastProcessMsgId,s),(!a.lastProcessMsgId||a.lastProcessMsgId<t)&&this.handleNewMessages(e,s,t).then((()=>{this.signalRenderItem(this.name,e)}));else{const t=this.pendingMessage.get(e),a=t?s.concat(t):s;this.pendingMessage.set(e,a),a.length===s.length&&this.DBConvUnread.getById(e).then((t=>{if(!t){const t=this.pendingMessage.get(e);if(t){const s=t.filter(((e,t,s)=>s.indexOf(e)===t)),a=_o.default.getLastMessageInList(s);if(!a)return;this.pendingMessage.delete(e),this.handleNewMessages(e,s,a.msgId).then((()=>{this.signalRenderItem(this.name,e)}))}}}))}}async onReceiveNewMessages(e,t,s){if(!s||!s.length||!t)return;const i=this.data.get(e);if(this.doneLoadDB){if(!i||!i.lastProcessMsgId||i.lastProcessMsgId<t){const a=s.map((e=>e.msgId)).join("-");this.logger.zsymb(0,"dmyFL3",`onReceiveNewMessages: ${null==i?void 0:i.lastProcessMsgId} ${e} ${t} ${a}`),await this.handleNewMessages(e,s,t),this.signalRenderItem(this.name,e)}}else{const t=this.pendingMessage.get(e),a=t?s.concat(t):s;this.pendingMessage.set(e,a)}a.ModuleContainer.resolve(bc.TUnreadSubChatTabStateManager).handleReceiveLatestMessage({convId:e,msgId:t})}onDoneOffLineMessages(){this.logger.zsymb(0,"Y-RdW_","ph7 done offline"),Kc.b.onDoneEntry(Kc.a.FIRST_FETCH),this.previewMsgs.length>0&&setTimeout((()=>{this.handlePreviewMsgs()}),0)}doDeleteUnread(e){if(!e)return;Object(lh.a)([e]);const t=this.data.get(e);this.logger.zsymb(0,"1VDCRJ",`doDeleteUnread ${!!t}`),this.data.delete(e)&&(Object(nc.f)(this.name,e),this.unreadChanged(e)),this.deleteInDB(e)}onReceiveDeleteConvMsg(e,t){if(this.doneLoadDB){const s=this.safeGetUnreadCached(e);if(0===s.smsUnreadCount)return;if(t>=+s.lastProcessMsgId){const t=Object(I.a)(Object(I.a)({},s),{},{smsUnreadCount:0,smsUnreadNotCount:0});this.data.set(t.convId,t),this.signalRenderItem(this.name,e),this.unreadChanged(e)}}else this.pendingClearUnread.set(e,t)}onClearUnreadConversations(e){if(!e||e.length<0)return;let t=[];for(let s=0;s<e.length;s++){const a=e[s],i=this.data.get(a.userId)||fh(a.userId);this.logger.zsymb(0,"NrqbQ3","onClearUnreadConversations",!!a,null==i?void 0:i.smsUnreadCount),a&&(t.push(a.userId),i.smsUnreadCount>0&&Re.default.getLastMessageFrom(a.userId,a.lastSmsLocalId,dh,i.smsUnreadCount,!0).then((e=>{let t={};if(e&&e.length>0)for(let a=0;a<e.length;a++){let s=e[a];ui.default.validMessageFromOther(s)&&(t[s.msgId]=s)}const s={userId:a.userId,lastSmsLocalId:a.lastSmsLocalId,smsUnreadCount:i.smsUnreadCount};this.clearUnreadConversation(s,t),this.resetUnreadToZero(a.userId,i.lastProcessMsgId)})).catch((e=>{this.logger.zsymb(21,"C6TSKE",["clear unread conv failure {}","Tbdix2"],e)})),Xu.a.clearUnreadIfExist({userId:a.userId,lastSeenReactId:i.lastSeenReactId}))}Object(lh.a)(t,e.length>0)}onReadConversation(e,t){var s;if(Ce.default.mark_unread.enable&&!Object(lh.c)(e))return this.logger.zsymb(0,"sePP_J",`[read-message] dont clear ${e}`,Ce.default.mark_unread.enable,Object(lh.c)(e)),!1;Object(lh.b)(e)&&(e.startsWith(Y.GROUPID_PREFIX)?Ia.default.logAction(2160024):Ia.default.logAction(2160023),Ia.default.logAction(2160022));const a=this.data.get(e)||fh(e),i=a.smsUnreadCount;if(!t&&!i){this.logger.zsymb(0,"d6CkAW",`[read-message] dont clear ${e} unread `,i,t);const s=Xu.a.sendClearUnread(e,a.lastSeenReactId);return Object(lh.a)([e],!1),s!=a.lastSeenReactId&&(a.lastSeenReactId=s,this.data.set(e,Object(I.a)({},a)),this.signalRenderItem(this.name,e),this.updateInDB(a)),!1}const n=this.acquireConvManager().getConvByIdSync(e);if(!n)return this.logger.zsymb(0,"0N_FBk",`[read-message] convinfo not exists ${e}`),!1;const r=[],o={},c=n.lastSmsLocalId?n.lastSmsLocalId.toString().split("_")[0]:"";let l=!1;const d=null===(s=lo.b.messageCache)||void 0===s?void 0:s.getLast({userId:e},i);for(let g=d.length-1;g>-1;g--){let e=d[g];if(ui.default.validMessageFromOther(e)&&!r.includes(e.msgId)&&(r.push(e.msgId),o[e.msgId]=e,e.msgId==c&&(l=!0),r.length==i))break}const u={userId:e,lastSmsLocalId:n.lastSmsLocalId,smsUnreadCount:i};var h;!c||l||o[c]?this.clearUnreadConversation(u,o):(this.logger.zsymb(0,"qnUSYf",`[read-message] append lastMsgIdInConv ${c} ${Object.keys(o).length}`),null===(h=lo.b.messageCache)||void 0===h||h.getMessageByMsgIdAsync(c,e).then((e=>{o[c]=Object(I.a)({},e),this.clearUnreadConversation(u,o)})).catch((e=>{this.clearUnreadConversation(u,o)})));return Object(lh.a)([e],!1),a.lastSeenReactId=Xu.a.sendClearUnread(e,a.lastSeenReactId),this.resetUnreadToZero(e,a.lastProcessMsgId),!0}getUnreadByConvIdSync(e){return this.data.get(e)}getUnreadByConvId(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.getUnreadByConvIdSync(e));this.DBConvUnread.getById(e).then((e=>t(void 0===e?void 0:this.toUnreadItem(e)))).catch(s)}))}getAllUnreadsSync(){return Array.from(this.data.values())}getAllUnreads(){return new Promise(((e,t)=>{if(this.doneLoadDB)return e(this.getAllUnreadsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvUnread.getAll()),this.fetchAllHolder.then((t=>e(t.map(this.toUnreadItem)))).catch(t)}))}resetUnreadToZero(e,t){return this.getUnreadByConvId(e).then((s=>{if(Yu.b.onClearUnreadConv(e),!s||!s.smsUnreadCount&&!s.smsUnreadNotCount)return this.logger.zsymb(3,"O2sMHn",["resetUnreadToZero {} {} skipped","gp_f4I"],e,t),!1;if(this.logger.zsymb(3,"EEwN4n",["resetUnreadToZero {} {} {}","Ev_jo0"],e,t,s.smsUnreadCount),!cc.Validator.assertString(t,this.logger))return!1;const a={convId:e,smsUnreadCount:0,mentionUnreadCount:0,strangerUnreadCount:0,smsUnreadNotCount:0,lastProcessMsgId:t,lastSeenReactId:s.lastSeenReactId||"",unreadMark:s.unreadMark};return s.smsUnreadCount>0&&Qu.a.notiMainClearunread(e),this.forkUpdateCacheAndDB(a).then((t=>(this.broadcastEvent(ai.b.ReadConv,e),!0))).catch((t=>(this.logger.zsymb(21,"yo9Cm8",["resetUnreadToZero failure {} {}","i4BQaF"],e,t),!1)))}))}isUnreadMessage(e){const{message:t,convId:s,lastProcessMsgId:a}=e,i=_o.default.isMyMessage(t),n=Zu.b.isRead({userId:s,msgId:t.msgId,msgSendDttm:t.ts||t.serverTime||t.sendDttm,msgLocalId:void 0,e2eeStatus:Object(nh.f)(t)}),r=!t.msgId||!a||t.msgId<=a;return!n&&r&&!i}_updateTTLUnreadCount(e,t,s){const a=this.data.get(e)||null;if(this.logger.zsymb(0,"QzHIKT","_updateTTLUnreadCount",e,null==a?void 0:a.smsUnreadCount),a&&a.smsUnreadCount===t&&a.smsUnreadNotCount===s)return;let i=this.safeGetUnreadCached(e);i.smsUnreadCount=t,i.smsUnreadNotCount=s,this.forkUpdateCacheAndDB(i)}updateUnreadTTLConversation(e,t,s){const a=this.getUnreadByConvIdSync(e);if(a){let i=a.smsUnreadCount,n=a.smsUnreadNotCount;t.filter((t=>t.ttlType===oh.a.Message&&this.isUnreadMessage({message:this._getDeletedMsgByTTLItem(t,s),convId:e,lastProcessMsgId:a.lastProcessMsgId}))).forEach((e=>{const t=this._getDeletedMsgByTTLItem(e,s),a=ui.default.getDataReminder(t),r=_o.default.isMyMessage(t);a&&r&&(t.idTo===Ce.default.sendToMeId||r)?(n-=1,i-=1):i-=1})),this._updateTTLUnreadCount(e,Math.max(i,0),Math.max(n,0))}}updateUnreadCount(e,t){const s=this.data.get(e)||null;if(this.logger.zsymb(0,"wZL-pi","updateUnreadCount",e,null==s?void 0:s.smsUnreadCount),s&&s.smsUnreadCount===t)return;let a=this.safeGetUnreadCached(e);a.smsUnreadCount=t,this.forkUpdateCacheAndDB(a)}updateMentionCount(e,t){this.logger.zsymb(0,"tElTfK","updateMentionCount",e,t);let s=this.safeGetUnreadCached(e);s.mentionUnreadCount=t,this.forkUpdateCacheAndDB(s,!1),ih.a.updateUnreadMentions(this.getTotalMentionCount())}updateLastSeenReactId(e,t){let s=this.safeGetUnreadCached(e);s.lastSeenReactId=t,this.forkUpdateCacheAndDB(s,!1)}updateUnreadMark(e,t){let s=this.safeGetUnreadCached(e);s.unreadMark||(s.unreadMark=null),t||(t=null),t!==s.unreadMark&&(s.unreadMark=t,this.forkUpdateCacheAndDB(s))}shouldClearUnread(e,t){const s=this.data.get(e),a=null==s?void 0:s.smsUnreadCount,i=null==s?void 0:s.lastProcessMsgId;return!!a&&!!(i&&t&&+t>=+i)}onRollMessage(){}async forkUpdateCacheAndDB(e,t=!0){this.data.set(e.convId,e),this.signalRenderItem(this.name,e.convId),t&&this.isValidConvKey(e.convId)&&this.unreadChanged(e.convId),await this.updateInDB(e)}safeGetUnreadCached(e){const t=this.data.get(e);let s;return s=t?Object(I.a)({},t):{convId:e,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,strangerUnreadCount:0,lastProcessMsgId:"0",lastSeenReactId:"0",unreadMark:null},s}getTotalMentionCount(){let e=0;return this.data.forEach((t=>{e+=t.mentionUnreadCount})),e}isValidConvKey(e){return!(!e||e.length<3)&&("null"!=e&&(e!==Y.CONV_FILTER.STRANGER&&e!==ph))}unreadChanged(e){"null"!=e&&(this.updateTotalQueue.remove((e=>!0)),this.updateTotalQueue.push(e))}async calculateComputeUnreadCount(e){try{var t;const i=this.getEmptyTotal(),n=(null===(t=this.data.get(Y.CONV_FILTER.STRANGER))||void 0===t?void 0:t.smsUnreadCount)||0;let r=0;const o=a.ModuleContainer.resolve(bc.TUnreadSubChatTabStateManager),c=o.getAllSeenMilestones(),l={[bc.SubChatTabType.FOCUSED]:!1,[bc.SubChatTabType.ARCHIVED]:!1},d=new Map,u=new Map,h=new Map;me.a.LabelDataManager.getAllLabelIds().map((e=>{const t=""+e;h.set(t,t)}));const g=new Map,m=[];for(let e of Array.from(this.data.keys())){if(!this.isValidConvKey(e))continue;const t=this.data.get(e);if(!t)continue;if(!(Boolean(t.smsUnreadCount)||Boolean(t.smsUnreadNotCount)||Boolean(t.unreadMark)))continue;const s=o.getSubtabTypeOfConv(e),a=Re.default.isMuted(e),i=t.lastProcessMsgId;!a&&o.isValidSubChatTabType(s)&&i>c[s]&&(l[s]=!0);if(In.a.isThreadHidden(e))continue;_c.a.isArchivedChat(e)||(g.set(e,t),m.push(e))}mh;const p=await cc.ConvList.verifyOATypeAsync(m),f=async({cid:e,isOA:t,oaInfo:s})=>{const n=g.get(e),o=n.convId,c=this.acquireConvManager().getConvByIdSync(o),l=Re.default.isMuted(o);if(t&&!(await cc.ConvList.checkIfOAShouldShowInConvList(o))){const e=a.ModuleContainer.resolve(ii.b);if(!e||!e.isChatVisible(o))return void this.logger.zsymb(0,"avyu7J","calc total unread count, skip OA no topOut conv: ",o,t,null==c?void 0:c.topOut)}const h=n.smsUnreadCount||0,m=n.smsUnreadNotCount||0;if(i.smsUnreadCount+=h,c&&!l&&!this.shouldForceShowReddotForOAMessages_(o,t)&&c.userId!==Y.FAKE_CONVERSATION_ID.FRIEND_CENTER){const e=Math.max(h-m,0);i.smsUnreadNomute+=e;const t=c.label?""+c.label:"",s="0"==t||!!t;if(s&&(d.has(t)?d.set(t,d.get(t)+e):d.set(t,e)),n.unreadMark){const e=i.unreadMark||0;i.unreadMark=e+1,s&&(u.has(t)?u.set(t,u.get(t)+1):u.set(t,1))}e>0&&this.isInStrangerBox(o)&&(r+=e)}};for(const{cid:e,isOA:t,oaInfo:s}of p)await f({cid:e,isOA:t,oaInfo:s});if(this.total.smsUnreadCount!==i.smsUnreadCount||this.total.smsUnreadNomute!==i.smsUnreadNomute||this.total.unreadMark!==i.unreadMark){var s;const t=null===(s=this.data.get(e))||void 0===s?void 0:s.smsUnreadCount,a=Re.default.isMuted(e);this.total=i,this.dispatchEvent(new ai.a(ai.b.ChangeUnreadCount,ph,{unreadNoMute:i.smsUnreadNomute,totalUnread:i.smsUnreadCount,convId:e,currentUnread:t,curentUnreadNoMute:a?0:t})),this.data.set(ph,i),this.signalRenderItem(this.name,ph)}if(o.handleShowReddotsAtSubChatTab(l),n!==r){const e=this.safeGetUnreadCached("");e.smsUnreadCount=r,e.convId=Y.CONV_FILTER.STRANGER,this.data.set(Y.CONV_FILTER.STRANGER,e),this.signalRenderItem(this.name,Y.CONV_FILTER.STRANGER)}for(let e of Array.from(d.keys())){const t=this.safeGetUnreadCached("");t.smsUnreadCount=d.get(e),t.unreadMark=u.get(e),this.data.set(e,t),h.delete(e),this.signalRenderItem(this.name,e)}for(let e of Array.from(h.keys()))this.data.delete(e)&&this.signalRenderItem(this.name,e)}catch(i){this.logger.zsymb(21,"pGcSaT",[" unread err - contact phucnh7 please!!! {}","lWYdJk"],i)}}acquireConvManager(){return me.a.ConvInfoDataManager}onLoadUnreadFromDBV2(e,t){if(this.logger.zsymb(0,"SImupT","onLoadUnreadFromDB",t.length),t.length<1)return;const s=(new Date).getTime().toString();Object(nc.j)(s);a.ModuleContainer.resolve(Nn.PreviewDataManager);for(let a=0;a<t.length;a++){const i=t[a];if("object"==typeof i.lastProcessMsgId||"string"==typeof i.lastProcessMsgId&&i.lastProcessMsgId.includes("object")?(i.lastProcessMsgId="0",this.logger.zsymb(18,"WSQEZ1","Corrected lastProcessMsgId!"),kc.default.increaseFailed(151101,0,0,0,Date.now())):Zu.b.isRead({userId:i.convId,msgId:+i.lastProcessMsgId,e2eeStatus:void 0,msgSendDttm:void 0,msgLocalId:void 0})&&(i.smsUnreadCount||i.smsUnreadNotCount)&&(this.logger.zsymb(0,"texWqa","clear offline",i.convId,i.smsUnreadCount),i.smsUnreadCount=0,i.strangerUnreadCount=0,i.smsUnreadNotCount=0),this.pendingClearUnread.has(i.convId)){const e=this.pendingClearUnread.get(i.convId);e&&e>=+i.lastProcessMsgId&&(this.logger.zsymb(0,"frw5l5","clear pending",this.pendingClearUnread.size,i.convId),i.smsUnreadCount=0,i.strangerUnreadCount=0,i.smsUnreadNotCount=0)}"null"===i.lastProcessMsgId&&(i.lastProcessMsgId=""),this.data.set(i.convId,i),Object(nc.g)(s,this.name,i.convId),e===_h&&this.updateInDB(i),i.unreadMark&&this.total.unreadMark++}this.pendingClearUnread.clear(),this.processPendingMessages(),Object(nc.c)(s)}processPendingMessages(){this.logger.zsymb(0,"JCLAZe","start processPendingMessages",this.pendingMessage.size),this.pendingMessage.forEach(((e,t)=>{const s=new Map,a=this.data.get(t);e.forEach((e=>{var t;(!a||a.lastProcessMsgId<e.msgId)&&s.set(`${(t=e).uidFrom||t.fromUid}_${t.idTo||t.toUid}_${t.cliMsgId}`,e)})),this.logger.zsymb(0,"KCjiB9","check processPendingMessages #2",t,null==a?void 0:a.smsUnreadCount,e.map((e=>e.msgId)),s.keys());const i=Array.from(s.values()),n=_o.default.getLastMessageInList(i);this.handleNewMessages(t,i,null==n?void 0:n.msgId)})),this.pendingMessage.clear()}async handleNewMessages(e,t,s){var a,i;if(!t||!t.length)return;if(!cc.Validator.assertString(s,this.logger))return;let n=!1;const r={convId:e,strangerUnreadCount:0,smsUnreadCount:0,smsUnreadNotCount:0,mentionUnreadCount:0,lastProcessMsgId:s,lastSeenReactId:"0"},o=Date.now(),c=new Set,{isOA:l}=null!==(a=null===(i=await cc.ConvList.verifyOATypeAsync([e]))||void 0===i?void 0:i[0])&&void 0!==a?a:{isOA:!1};if(t.forEach((t=>{const a=_o.default.isMyMessage(t);if(t.status!==Y.MSG_READ&&!a){const s=t.ts||t.serverTime||t.sendDttm;Zu.b.isRead({userId:e,msgId:t.msgId,msgSendDttm:s,msgLocalId:void 0,e2eeStatus:Object(nh.f)(t)})&&(Ce.default.stagingAccount&&this.logger.zsymb(0,"zJSGgZ",`mark msg status as read ${e} ${t.msgId}`),t.status=Y.MSG_READ)}let i=$u.a.get(t.msgId,t.status);i!=t.status&&Ce.default.stagingAccount&&this.logger.zsymb(0,"UhyK7E",`change msg status ${t.status} => ${i}`),t.status=i;let d=!1;if("chat.todo"===t.msgType){let e=t.content;if(e){"todo.remind"===e.action&&(d=!0)}}let u=ui.default.getDataReminder(t);if(t.status!==Y.MSG_READ&&!a||!0===d){if(t.paramsExt&&ui.default.valueValid(t.paramsExt.countUnread)){const s=this.shouldForceShowReddotForOAMessages_(e,l);(0==t.paramsExt.countUnread||1==t.paramsExt.countUnread&&s)&&(r.smsUnreadNotCount+=1)}this.isCallTimeMessage(t)||(r.smsUnreadCount+=1,r.strangerUnreadCount+=1),Ku.b.isMessageMentionMe(t)&&r.mentionUnreadCount++}else u&&a&&(t.idTo===Ce.default.sendToMeId||a)?(r.smsUnreadCount+=1,r.smsUnreadNotCount+=1,this.logger.zsymb(0,"IsPf5Y",`new unread #2: ${o} ${e} ${t.msgId} ${t.idTo} ${t.toUid} ${t.src} ${s}`)):eh.a(t)?t.isCallMessage||(r.smsUnreadCount=0,r.strangerUnreadCount=0,r.mentionUnreadCount=0,n=!0):(c.add(t.msgId),this.logger.zsymb(0,"ulDiA0","_addMessages: skipped clear unread for",t.idTo));r.smsUnreadCount>0&&Kc.b.markGotUnread(e,t.msgId),Kc.b.isLastMsgV2(t)&&this.onDoneOffLineMessages()})),c.has(s))for(let u=t.length-1;u>=0;u--){const s=t[u];if(ui.default.validMessageFromServer(s)&&!c.has(s.msgId)){if(this.logger.zsymb(0,"UGCSj-","update last process id",e,r.lastProcessMsgId,s.msgId),r.lastProcessMsgId=s.msgId,!cc.Validator.assertString(s.msgId,this.logger))return;break}var d;0==u&&(r.lastProcessMsgId=(null===(d=this.data.get(e))||void 0===d?void 0:d.lastProcessMsgId)||"0")}return Object(lh.a)([e]),this.updateUnread(e,n,r)}handlePreviewMsgs(){if(!this.previewMsgs.length)return;const e=[...this.previewMsgs];this.previewMsgs=[],this.logger.zsymb(0,"lHasTv","handle preview",e.map((e=>e.msgId))),e.forEach((e=>{const t=e.toUid,s=th.default.checkDuplicate(t,{uidFrom:e.fromUid,cliMsgId:e.cliMsgId});s&&s.src&&s.msgId!==e.msgId&&(this.logger.zsymb(0,"V7yzj3","detect dup msg",e.msgId,s.msgId),e.msgId=s.msgId),this.onReceiveNewMessages(t,e.msgId,[e])}))}updateUnread(e,t,s){let a=this.data.get(e);if(a){const e=a.lastSeenReactId||"0";t?a=s:(a.smsUnreadNotCount+=s.smsUnreadNotCount,a.smsUnreadCount+=s.smsUnreadCount,a.strangerUnreadCount+=s.strangerUnreadCount,a.mentionUnreadCount+=s.mentionUnreadCount,a.lastProcessMsgId=s.lastProcessMsgId),a.lastSeenReactId=e}else{if(a=s,!a)return void this.logger.zsymb(18,"poDBEV",`updateUnread undefined item ${e}`);a.lastSeenReactId=rh.b.getLastSeen(e)||"0"}this.data.set(e,Object.assign({},a)),this.updateInDB(a),0!=s.mentionUnreadCount&&ih.a.updateUnreadMentions(this.getTotalMentionCount()),this.unreadChanged(e)}isInStrangerBox(e){const t=me.a.ConvInfoDataManager.getConvByIdSync(e);return Qu.a.isInStrangerBox(t)}isCallTimeMessage(e){if("chat.recommended"===e.msgType&&e.content){if(e.content.action===Y.CallMessageAction.CallTime)return!0;if(e.content.action===Y.CallMessageAction.MissCall){let s=e.content.params;if("string"==typeof s)try{s=JSON.parse(e.content.params)}catch(t){}if(s&&3===s.reason)return!0}}return!1}clearUnreadConversation(e,t={}){if(e&&e.smsUnreadCount)try{let s=!0,a=Object.keys(t);a&&0!=a.length||(s=!1,this.logger.zsymb(0,"4pRGF4",`[read-message] actually, no need send seen in that case 2: ${a.length}`)),!s&&Ce.default.chat_aggressive_send_seen&&(s=!0),s?(a&&0!==a.length?this.sendClearUnreadToServer(t,e.userId):Re.default.getLastMessageFrom(e.userId,e.lastSmsLocalId,dh,e.smsUnreadCount,!0).then((t=>{let s=[],a={};if(t&&t.length)for(let e=0;e<t.length;e++){let i=t[e];ui.default.validMessageFromOther(i)&&(s.push(i.msgId),a[i.msgId]=i)}0===s.length?this.logger.zsymb(3,"pnlU0x",["- [read-message] get ids.length == 0 {}","A6k31p"],e.userId):this.sendClearUnreadToServer(a,e.userId)})).catch((e=>{this.logger.zsymb(21,"quwJl2",[" [read-message] get msgs err {}","JWoaC4"],e)})),Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.clearUnreadMessages,{convId:e.userId})):this.logger.zsymb(3,"umsgIh",["[read-message] no send {}","HDBkXT"],e.userId)}catch(s){this.logger.zsymb(21,"KlnAHm",["[read-message] err {}","7iqhO7"],s)}else this.logger.zsymb(0,"euPWYg",`[read-message] actually, no need send seen in that case 1: ${null==e?void 0:e.userId}`)}async sendClearUnreadToServer(e={},t){const s=Object.keys(e),a=Qu.a.isGroup(t),i=Lo.a.newReq();try{await qc.default.sendSeen(e,t,a,i),Ce.default.stagingAccount&&this.logger.zsymb(0,"WY2wvb",`[read-message] done ${t} msgId:\n\t\t\t\t\t${s&&s.length?s[s.length-1]:0}`)}catch(n){if(this.logger.zsymb(21,"D6LhMi",["[read-message] err {}","7iqhO7"],n),!(s&&s.length>0))throw this.logger.zsymb(21,"RF2Iz6",["[read-message] send seen fail!!! convId:{} msgId len = 0","ZomO9z"],t),n;if(this.logger.zsymb(21,"jyJDXw",["[read-message] send seen fail!! convId:{} msgId:{}","5b3Hkl"],t,s[s.length-1]),n&&(114===n.error_code||-69===n.error_code))throw this.logger.zsymb(21,"YjVab0",["[read-message] send seen fail!!! no need retry {}","xI2xms"],n.error_code),n;throw Ce.default.retrySendSeen?(this.logger.zsymb(21,"R9F6HK",["[read-message] send seen fail!!! retry","PKXMzL"]),Ju.b.retryAction(Ju.a.SEND_SEEN_V2,[e,t,a,i],{startedTime:Date.now(),duration:Ce.default.retrySendSeen.timeout})):this.logger.zsymb(21,"7CAdSX",["[read-message] send seen fail!!! not retry","go0Nnx"]),n}}broadcastEvent(e,t,s){this.dispatchEvent(new ai.a(e,t,s))}signalRenderItem(e,t,s){this.conversationUIUpdater.signalRenderItem(e,t,s)}updateInDB(e){if(null==e.lastSeenReactId&&(e.lastSeenReactId=rh.b.getLastSeen(e.convId)||"0",this.logger.zsymb(18,"_-z6MT",`update invalid lastSeen ${e.convId}`)),!cc.Validator.assertString(e.lastProcessMsgId,this.logger))return;const t=this.toUnreadConvItemEntity(e);this.DBConvUnread.addOrUpdate(t)}deleteInDB(e){this.DBConvUnread.remove(e)}toUnreadItem(e){return Object(I.a)(Object(I.a)({},e),{},{unreadMark:e.unreadMark})}toUnreadConvItemEntity(e){return Object(I.a)({},e)}})||qu)||qu)||qu)||qu);var Ih=s("8Nax"),yh=s("GSHL"),Sh=s("w5bt");let Ch;var Eh;(Eh=Ch||(Ch={})).modelToEntity=function(e){if(!e)throw new Error("[PreviewHelper] Convert undefined model to entity");return{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties?{type:e.properties.type}:null,mentions:e.mentions?e.mentions:null,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon}},Eh.entityToModel=function(e){return e?{convId:e.convId,msgId:e.msgId,dName:e.dName,message:e.message,messageType:e.messageType,messageTime:e.messageTime,isGroup:e.isGroup,fromUid:e.fromUid,toUid:e.toUid,urgencyLevel:e.urgencyLevel,properties:e.properties,mentions:e.mentions,ttl:e.ttl,cliMsgId:e.cliMsgId,status:e.status,substate:e.substate,computedMessage:e.computedMessage,computedIcon:e.computedIcon,src:"db.preview",verified:!1}:null};var Oh,Mh=s("yWVE");const Th="zpm_m",Rh="1.0.0";Object(xi.b)(Sh.b)(Oh=function(e,t){return a.ModuleContainer.inject(yh.b)(e,void 0,0)}(Oh=function(e,t){return a.ModuleContainer.inject(Lu.a)(e,void 0,1)}(Oh=Reflect.metadata("design:type",Function)(Oh=Reflect.metadata("design:paramtypes",[void 0===ai.IReactiveDB?Object:ai.IReactiveDB,void 0===Lu.a?Object:Lu.a])(Oh=class extends hs.b{constructor(e,t){super(),this.DBConvPreview=e,this.conversationUIUpdater=t,this.name=void 0,this.key=void 0,this.didInit=void 0,this.data=void 0,this.expiredConvs=void 0,this.list=void 0,this.deleteQueue=void 0,this.doneLoadDB=void 0,this.migrating=void 0,this.fetchAllHolder=void 0,this._Logger=void 0,this.name=Sh.a,this.key="convId",this.didInit=!1,this.data=new Map,this.expiredConvs=new Map,this.list=new Map,this.deleteQueue=[],this.doneLoadDB=!1,this.migrating=!1,this.fetchAllHolder=null}init(){return this.didInit?Promise.resolve():(this.didInit=!0,this.loadData())}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}signalRenderItem(e,t,s=!1){this.Logger.zsymb(12,"kAbOSh","signalRenderItem allowAutoBatching",s);const a=s?this.conversationUIUpdater.signalRenderItem:nc.h,i=s?this.conversationUIUpdater.signalRenderList:nc.i;a(e,t),this.broadcastEvent(ai.b.PreviewChanged,t,{changedItem:this.data.get(t),all:Array.from(this.data.values())}),i(e,"all")}loadData(){return new Promise(((e,t)=>{n.default.getInstance().getItemForCurrentUser(Th)!==Rh||this.migrating?e():(this.Logger.zsymb(3,"xp2VxE",["start load preview","wKlMyY"]),this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((t=>{this.onLoadPreviewsFromDB(t).then(e).catch((t=>{this.Logger.zsymb(21,"QE6q6n",["load previews from db failure #1! {}","IBYjSA"],t),e()}))})).catch((t=>{this.Logger.zsymb(21,"IJYUM0",["load preview from db failure #2! {}","Xm1Z1D"],t),e()})))}))}async revalidate(e){const t=!!this.getPreviewByIDSync(e),s=await Gu.b.getPreviewMessage(e).catch((s=>(this.Logger.zsymb(21,"JCEZRm",["revalidate failure #1 {} {} {}","srHrek"],e,t,s),{previewMsg:void 0})));return!!s.previewMsg&&this.onReceiveNewMessage("db.message",s.previewMsg).then((s=>(this.Logger.zsymb(3,"NPKG5c",["revalidate success {} {} {}","HqLBFd"],e,t,s),!0))).catch((s=>(this.Logger.zsymb(21,"MJ0k75",["revalidate failure #2 {} {} {}","Y-qDYk"],e,t,s),!1)))}migrate(e,t=!1){return new Promise((s=>{const a=n.default.getInstance().getItemForCurrentUser(Th);if(a===Rh&&!t)return;if(this.Logger.zsymb(3,"I6Q2Rq",["start migrate {} {}","sXxY9_"],a,t),this.migrating=!0,0===e.length)return this.doneMigratePreivew(0),s(0);let i=0,r=0;const o=()=>{if(i++,i===e.length)return this.doneMigratePreivew(r),s(r)},c=()=>{r++,o()},l=()=>{for(let t=0;t<e.length;t++)Gu.b.getPreviewMessage(e[t]).then((s=>{s&&s.previewMsg?this.onReceiveNewMessage("db.message",s.previewMsg).then(c).catch(o):(this.Logger.zsymb(3,"QXHEBn",["migrate not exists msg {}","LCD95D"],e[t]),o())})).catch((s=>{o(),this.Logger.zsymb(21,"lLKycv",["migrate failure for conv {} {}","4ZPcbB"],e[t],s)}))};let d=e.filter((e=>e!==Y.FAKE_CONVERSATION_ID.FRIEND_CENTER&&e!==Y.FAKE_CONVERSATION_ID.GROUP_CENTER&&!e.startsWith(Y.GROUPID_PREFIX)));if(d.length>0)return Ii.default.getProfileFriendByIds(d,Y.SRC_GET_PROFILE.FETCH_MINI_INFO).then((()=>{l()})).catch((()=>{l()}));l()}))}doneMigratePreivew(e){this.Logger.zsymb(3,"NmKM0X",["done migrate preview {}","0bl7cY"],e);n.default.getInstance().setItemForCurrentUser(Th,Rh),this.broadcastEvent(ai.b.DoneMigratePreview,"")}upgradeItemsVersion(e=[]){this.Logger.zsymb(3,"5dsucJ",["upgradeItemsVersion","6xR_6z"]);const t=(new Date).getTime().toString();Object(nc.j)(t),0!==e.length?e.forEach((e=>{Object(nc.g)(t,this.name,e)})):this.data.forEach((e=>{Object(nc.g)(t,this.name,e.convId)})),Object(nc.c)(t)}updateStrangerBox(e){const t=this.data.get(e);t&&(this.data.set(Y.CONV_FILTER.STRANGER,Object(I.a)({},t)),this.conversationUIUpdater.signalRenderItem(this.name,Y.CONV_FILTER.STRANGER))}forceChangeItem(e){this.signalRenderItem(this.name,e)}getItem(e,t){const s=this.data.get(e.key);return s||this.Logger.zsymb(5,"LCXduP",["try to get item not exist in cache {}","aM3blG"],e.key),s}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e){this.Logger.zsymb(11,"ABVsFL",["onGetItemFailure {}","opWHcj"],e)}onGetListFailure(e,t){this.Logger.zsymb(11,"PK8f10",["onGetListFailure {} {}","hRxmI1"],e,t)}onLoadPreviewsFromDB(e){return new Promise(((t,s)=>{if(this.Logger.zsymb(3,"Q4CQvs",["onLoadPreviewsFromDB {}","BN6ard"],null==e?void 0:e.length),!e||0===e.length)return this.doneLoadPreview(0),t();let a=0;const i=()=>{a++,a===e.length&&(this.doneLoadPreview(a),t())};for(let n=0;n<e.length;n++){const t=Ch.entityToModel(e[n]);t&&!Ih.a.instance.filterExpiredPreview(t)&&(t.messageType=Y.MSG_VANISH,t.message="",this.updateInDB(t)),this.addPreviewToManager(t).then((()=>{i()})).catch((e=>{i(),this.Logger.zsymb(21,"yALD2E",["onload preview failure for item {} {}","THvdjC"],null==t?void 0:t.convId,e)}))}}))}doneLoadPreview(e){this.Logger.zsymb(3,"siebHg",["doneLoadPreview {}","zdIA_1"],e),this.doneLoadDB=!0,this.broadcastEvent(ai.b.DoneLoadPreview,"",Array.from(this.data.values())),Object(nc.i)(this.name,"all")}onReceiveNewMessage(e,t){return new Promise(((s,a)=>{if(!t)return s(!1);const i=this.convertDBMessageToPreviewItem(e,t);this.addPreviewToManager(i).then((a=>{if(a){const a="server"===e;return this.signalRenderItem(this.name,t.toUid,a),s(!0)}return s(!1)})).catch(a),this.smartDispatchEvent(ai.b.ReceiveNewMsg,(()=>new ai.f(e,t)))}))}onReceiveNewMessages(e,t){return new Promise((s=>{if(!t)return s(!1);const a=this.groupMessageByConvId(t),i=[];for(const e in a){if(!Object.prototype.hasOwnProperty.call(a,e))continue;const t=a[e];for(let e=t.length-1;e>=0;e--){if(_o.default.isValidPreviewMessage(t[e])){i.push(t[e]);break}this.Logger.zsymb(3,"b3QxxG",["receive msg but not preview {}","Ns6-Kx"],t[e].msgId)}}return i.length?Promise.all(i.map((async t=>this.onReceiveNewMessage(e,t)))).then((e=>{const t=e.some((e=>1==e));s(t)})).catch((e=>{this.Logger.zsymb(21,"IepIrE",["add messages to preview got error {}","dyQP9j"],e),s(!1)})):s(!1)}))}onUndoMessage(e,t){if(!t)return;this.Logger.zsymb(3,"JmUxLg",["onUndoMessage {}","oWHO8y"],t.msgId);const s=this.convertDBMessageToPreviewItem(e,t);s.messageType=Y.MSG_UNDO,s.message="",this.addPreviewToManager(s).then((e=>{e&&this.signalRenderItem(this.name,t.toUid)}))}onUpdateE2EEMessage(e,t){if(!t)return;const s=t.toUid,a=this.data.get(s);if(this.Logger.zsymb(3,"OjZ9i_",["onUpdateE2EEMessage {} {} {}","I6ye7z"],s,null==a?void 0:a.msgId,t.msgId),a&&(a.msgId!==t.msgId||!Ku.b.isSameMsg(a,t)))return;const i=this.convertDBMessageToPreviewItem(e,t),n=ui.default.normalizeMessageTypeFromSubState(null==t?void 0:t.e2eeStatus)||t.msgType;i.message=i.message||_o.default.getPlainText({msgType:n}),i.verified=!0,i.messageType=n,this.data.set(t.toUid,i),this.updateInDB(i),this.signalRenderItem(this.name,t.toUid)}onDeleteMessage(e,t){return new Promise(((e,s)=>{if(!t)return e(!1);this.Logger.zsymb(3,"dqu00T",["onDeleteMessage {}","Fq3lwf"],t.msgId);const a=this.convertDBMessageToPreviewItem("db.message",t);t.msgType===Y.MSG_DEL_EVERYONE&&(a.messageType=Y.MSG_DEL_EVERYONE,a.message=""),this.deleteMessageInManager(a).then((s=>{s?(this.Logger.zsymb(3,"E3NLCY",["onDeleteMessage success {}","-f81q-"],t.msgId),this.signalRenderItem(this.name,t.toUid),e(!0)):e(!1)}))}))}onRollMessage(){const e=new Map;this.data.forEach((t=>{Object(Mh.c)(t)?this.expiredConvs.set(t.convId,t):e.set(t.convId,t)})),this.data=e,Object(nc.i)(this.name,"all")}onDeleteMessages(e,t){if(!t||t.length<1)return;const s=this.groupMessageByConvId(t);for(const a in s)if(Object.prototype.hasOwnProperty.call(s,a)){const t=s[a];let i=this.convertDBMessageToPreviewItem(e,t[0]),n=0;for(let s=1;s<t.length;s++){const a=this.convertDBMessageToPreviewItem(e,t[s]);this.isSecondItemNewer(i,a)&&(n=s,i=a)}this.onDeleteMessage(e,t[n])}}onDeleteConversation(e,t){e&&(this.Logger.zsymb(3,"U6dAtY",["onDeleteConversation {}","mwlvSt"],e),"kick"!==t&&"disband"!==t?(this.data.delete(e)&&Object(nc.f)(this.name,e),this.deleteInDB(e)):this.onLeaveConversation(e,t))}async onLeaveConversation(e,t){try{const s=this.data.get(e);if(!s)return void this.Logger.zsymb(21,"9eZ_MN",["onLeaveConversation leavePreview not exist {}","mfUsY8"],e);s.message="",s.messageType="disband"===t?Y.MSG_DISBAND_GROUP:Y.MSG_KICK_GROUP,this.data.set(e,s),this.signalRenderItem(this.name,e),this.updateInDB(s)}catch(s){this.Logger.zsymb(21,"RaCFGL",["onLeaveConversation error {}","RhjsOV"],e)}}onChangeDraft(e,t){let s=this.getPreviewByIDSync(e);return!e||!s||s.draft===t||s.draft&&t&&s.draft.draftTime===t.draftTime?(!s&&t&&(this.data.set(e,{convId:e,msgId:Y.FAKE_DRAFT_MSG_ID,draft:t,messageTime:-1}),this.signalRenderItem(this.name,e)),void this.Logger.zsymb(3,"5d1_WE",["onChangeDraft - reject {}","SDrFu9"],!!s)):(this.Logger.zsymb(3,"6TBT6b",["onChangeDraft - call update {}","kMchnW"],!!s),s.msgId!==Y.FAKE_DRAFT_MSG_ID||t?void((s.draft||t)&&(s=Object(I.a)(Object(I.a)({},s),{},{draft:t}),this.data.set(e,s),this.signalRenderItem(this.name,e),this.broadcastEvent(ai.b.DraftChanged))):(this.data.set(e,{convId:e,msgId:Y.FAKE_DRAFT_MSG_ID,draft:void 0,messageTime:-1}),this.signalRenderItem(this.name,e),void this.data.delete(e)))}getPreviewById(e){return new Promise(((t,s)=>{if(this.data.has(e))return t(this.data.get(e));this.DBConvPreview.getById(e).then((s=>{s||this.Logger.zsymb(3,"2Hr_rw",["get item not exist with id {}","DrAggS"],e);const a=Ch.entityToModel(s);t(a||void 0)})).catch(s)}))}getPreviewByIDSync(e){return this.data.get(e)}getAllPreviews(e){return new Promise(((t,s)=>{if(this.doneLoadDB&&!e)return t(this.getAllPreviewsSync());this.fetchAllHolder||(this.fetchAllHolder=this.DBConvPreview.getAll()),this.fetchAllHolder.then((e=>{const s=e.map((e=>Ch.entityToModel(e)));t(s)})).catch(s)}))}getAllPreviewsSync(){return Array.from(this.data.values())||[]}getAllPreviewsForSearch(){return this.getAllPreviewsSync()}setPreview(e,t,s,a,i,n=1,r={}){const o=this.data.get(e);this.Logger.zsymb(3,"yXrtPn",["call set preview {} {}","J2rm-r"],e,!!o);const c={convId:e,msgId:r.msgId||"unset",src:"ui",dName:r.dName||"",message:t,messageType:"",isGroup:e.startsWith(Y.GROUPID_PREFIX),messageTime:s,fromUid:a,toUid:i,urgencyLevel:r.urgencyLevel,properties:null,verified:!0,status:n,computedMessage:t,computedIcon:r.icon};this.data.set(e,c),this.signalRenderItem(this.name,e),this.updateInDB(c)}setPreviewContentIfMatched(e,t,s){const a=this.data.get(e);if(void 0===a||a.msgId!==t)return;const i=Object(I.a)(Object(I.a)({},a),{},{message:s});this.data.set(e,i),this.signalRenderItem(this.name,e),this.updateInDB(i)}async rejectLatestPreview(e){const t=this.data.get(e);void 0!==t&&(this.Logger.zsymb(3,"zjP-CR",["rejectLatestPreview {} {}","m6_-w2"],e,t.msgId),this.data.delete(e),await this.DBConvPreview.remove(e),await this.revalidate(e))}async addPreviewToManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);let a=!1;if(Object(Mh.c)(e))return this.expiredConvs.set(t,e),!1;if(this.expiredConvs.has(t)&&this.expiredConvs.delete(t),s){const i=!(s.messageType||s.message||!e.messageType||!e.message);i&&(s.verified=!0,this.Logger.zsymb(3,"g-7LMR",["force update new preview item {}","t6J4nN"],t)),(i||this.isSecondItemNewer(s,e))&&(this.data.set(t,e),a=!0,s.verified?(e.verified=!0,this.updateInDB(e)):a=await this.compareCacheWithDBAndUpdate(t,e))}else this.data.set(t,e),a=!0,"db.preview"!==e.src&&(a=await this.compareCacheWithDBAndUpdate(t,e));return a}async deleteMessageInManager(e){if(!e)return!1;const t=e.convId,s=this.data.get(t);if(!s||!Ku.b.isSameMsg(e,s)&&this.isSecondItemNewer(e,s))return 0!==this.deleteQueue.length&&this.deleteQueue.push(e),!1;const a=async()=>{const a=await Gu.b.getPreviewMessage(t),i=this.deleteQueue.find((e=>{var t;return e.msgId===(null===(t=a.previewMsg)||void 0===t?void 0:t.msgId)}));if(i)return e.messageType===Y.MSG_DEL_EVERYONE&&(i.messageType=Y.MSG_DEL_EVERYONE,i.message=""),this.data.set(t,i),await this.deleteMessageInManager(i);this.deleteQueue=[];const n=this.data.get(t);if(n&&this.isSecondItemNewer(s,n))return!1;if(a.previewMsg){const s=this.convertDBMessageToPreviewItem("db.message",a.previewMsg);return s.verified=!0,e.messageType===Y.MSG_DEL_EVERYONE&&(s.messageType=Y.MSG_DEL_EVERYONE,s.message=""),this.data.set(t,s),this.updateInDB(s),!0}return this.data.delete(t),this.deleteInDB(t),Object(nc.f)(this.name,t),!1};if(s.verified)return await a();{const s=await this.DBConvPreview.getById(t),i=s&&Ch.entityToModel(s);return i&&this.isSecondItemNewer(e,i)?(this.data.set(t,i),!0):await a()}}convertDBMessageToPreviewItem(e,t){let s=t.sendDttm||t.serverTime;s=s?s.toString():"";const a=t.fromUid||t.uidFrom,i=t.toUid||t.idTo,n=i&&i.startsWith(Y.GROUPID_PREFIX);return{convId:t.toUid,msgId:t.msgId,src:e,dName:t.dName||"",message:t.message,messageType:t.msgType,mentions:t.mentions,isGroup:n,messageTime:s,fromUid:a,properties:t.properties,urgencyLevel:t.urgency,verified:!1,ttl:t.ttl,status:t.status||1,substate:t.e2eeStatus,cliMsgId:t.cliMsgId,toUid:t.toUid}}isSecondItemNewer(e,t){return!e||(t.msgId===e.msgId&&t.messageTime===e.messageTime||Ku.b.isSameMsg(e,t)?t.messageType===Y.MSG_UNDO&&e.messageType!==Y.MSG_UNDO||(cc.ConvList.comparePreviewStt(t.status,e.status)>0||e.substate===Y.MSG_E2EE_PRELOAD&&t.substate!==Y.MSG_E2EE_PRELOAD):e.messageTime!==t.messageTime?t.messageTime>e.messageTime:t.msgId>e.msgId)}compareCacheWithDBAndUpdate(e,t){return new Promise(((s,a)=>{this.DBConvPreview.getById(e).then((a=>{this.Logger.zsymb(3,"HMVWUB",["compareCacheWithDBAndUpdate {} {}","ReFlyT"],e,!!a);const i=Ch.entityToModel(a),n=this.data.get(e);if(JSON.stringify(n)!==JSON.stringify(t))return s(!1);!i&&n||i&&n&&this.isSecondItemNewer(i,n)?(n.verified=!0,this.updateInDB(n)):i&&this.data.set(e,i),s(!0)})).catch(a)}))}groupMessageByConvId(e){const t={};for(let s=0;s<e.length;s++)t[e[s].toUid]?t[e[s].toUid].push(e[s]):t[e[s].toUid]=[e[s]];return t}broadcastEvent(e,t="",s){this.dispatchEvent(new ai.a(e,t,s))}updateInDB(e){this.Logger.zsymb(3,"YdDxii",["update in db {}","uFzSyl"],e.msgId);try{const t=Ch.modelToEntity(e);this.DBConvPreview.addOrUpdate(t)}catch(t){this.Logger.zsymb(21,"gqKWQR",["update in db got err{}","EX3kOT"],t)}}deleteInDB(e){this.DBConvPreview.remove(e).catch((e=>{this.Logger.zsymb(18,"CWmiAo",`[${this.name}] - deleteInDB got error ${e}`)}))}})||Oh)||Oh)||Oh)||Oh);var wh=s("rKwX"),Lh=s("SWKE");const Dh="z_ml";class Ah{constructor(){this.cache=void 0,this.cache={}}localKey(e){return Dh+"_"+e}muteConversation(e,t){const s=n.default.getInstance(),a=Dh+"_"+e;t?t.constructor===Object?s.setItemForCurrentUser(this.localKey(e),JSON.stringify(t)):s.setItemForCurrentUser(this.localKey(e),`${t}`):s.removeItemForCurrentUser(a),this.cache[e]=t||!1}isMuted(e){if(this.cache.hasOwnProperty(e))return this.cache[e];let t,s=n.default.getInstance().getItemForCurrentUser(this.localKey(e));if(!s)return null;try{return t=JSON.parse(s),this.cache[e]=t,t}catch(a){ui.default.logCoreError(a)}return this.cache[e]=!1,!1}setMutedConversations(e){let t=[];e.chatEntries&&e.chatEntries.length>0&&e.chatEntries.reduce(((e,t)=>(e.push(t),e)),t),e.groupChatEntries&&e.groupChatEntries.length>0&&e.groupChatEntries.reduce(((e,t)=>(t.id=Y.GROUPID_PREFIX+t.id,e.push(t),e)),t);Lh.a.getInstance().cleanupLocalStorageMatchConditions((e=>{const t=n.default.getInstance().getKeyNameForCurrentUser(this.localKey(""));return e.startsWith(t)})),this.cache={};for(let s=0;s<t.length;s++)this.muteConversation(t[s].id,t[s]);return t}}var Fh;Object(xi.b)(Nn.MuteDataManager)(Fh=Reflect.metadata("design:type",Function)(Fh=Reflect.metadata("design:paramtypes",[])(Fh=class extends hs.b{constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this._muteManager=void 0,this.userId=void 0,this.mapTimeout=void 0,this.name=Nn.MUTE_MANAGER_NAME,this.key="id",this.didInit=!1,this.userId="",this.mapTimeout={}}init(e){this.didInit||(this.didInit=!0,this.userId=e)}get muteManager(){return this._muteManager&&""!==this.userId||(this.userId,this._muteManager=new Ah),this._muteManager}getItem(e,t){return this.muteManager.isMuted(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e){}onGetListFailure(e,t){}onMute(e,t){return new Promise(((s,a)=>{this._clearTimeout(e);let i=-1;switch(t){case 1:i=3600;break;case 2:i=14400;break;case 3:i=Math.round(this._getNowTo8Am()/1e3)}ui.default.logCoreInfo(`[${this.name}] - onMute ${e} ${i}`),wh.a.lock(e,i,!0).then((t=>{this.muteManager.muteConversation(e,{id:e,startTime:t.startTime,duration:t.duration,systemTime:t.systemTime,currentTime:t.currentTime,muteMode:t.muteMode}),s(!0)})).catch(a)}))}onUnMute(e,t=!0,s=!1){return new Promise(((a,i)=>{this._clearTimeout(e),ui.default.logCoreInfo(`[${this.name}] - onUnMute ${e} ${t} ${s}`),wh.a.unlock(e,t,s).then((t=>{this.muteManager.muteConversation(e,0),a(!!t)})).catch(i)}))}onFetchMute(e){ui.default.logCoreInfo(`[${this.name}] - onFetchMute`);let t=this.muteManager.setMutedConversations(e);return this.processFetchData(e),t}onCtrMute(e,t){t?(this.doLock(t,!1),this.muteManager.muteConversation(e,t),this.muteChanged(e,!!t)):this.onUnMute(e,!1).then((s=>{this.muteChanged(e,!!t)}))}isMuted(e){return this.muteManager.isMuted(e)}processFetchData(e){try{e.chatEntries&&(e.chatEntries.forEach((e=>{this.doLock(e,!0)})),e.groupChatEntries.forEach((e=>{this.doLock(e,!0)})))}catch(t){ui.default.logCoreError(t)}}doLock(e,t=!0){if(this.mapTimeout.hasOwnProperty(e.id)&&(t=!0),this._clearTimeout(e.id),-1!=e.duration){ui.default.log("setTimer",e);let s=e.duration-(e.currentTime-e.systemTime);s>=0?(ui.default.log("setTimer: lock1",e.id),ui.default.logCoreInfo("[Unmute timeout] setTimer: lock1",e.id,s),this.mapTimeout[e.id]=setTimeout((()=>{this.onUnMute(e.id,t,!0),ui.default.logCoreInfo("[Unmute timeout] setTimer: unlock1",e.id)}),1e3*s)):(ui.default.log("setTimer: unlock",s),ui.default.logCoreInfo("[Unmute timeout] setTimer: unlock",e.id),this.onUnMute(e.id,t))}}_clearTimeout(e){this.mapTimeout.hasOwnProperty(e)&&(clearTimeout(this.mapTimeout[e]),delete this.mapTimeout[e])}_getNowTo8Am(){let e=(new Date).getTime(),t=new Date(e);return t.setHours(8,0,0,0),t.getTime()<=e?t.getTime()+864e5-e:t.getTime()-e}muteChanged(e,t){Object(nc.h)(this.name,e),this.broadcastEvent(ai.b.MuteChanged,e,t)}broadcastEvent(e,t="",s){this.dispatchEvent(new ai.a(e,t,s))}})||Fh)||Fh);var kh,Nh=s("qvRd");const Ph="zpinc",jh="ver_pin",Uh=0,Bh=1,zh=2;Object(xi.b)(Nh.b)(kh=Reflect.metadata("design:type",Function)(kh=Reflect.metadata("design:paramtypes",[])(kh=class extends hs.b{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("conversation",[this.name])),this._Logger}constructor(){super(),this.name=void 0,this.key=void 0,this.didInit=void 0,this.doneLoadDB=void 0,this.data=void 0,this._Logger=void 0,this.reFetchCount=void 0,this.retryTimeout=void 0,this.refetchInterval=void 0,this.lastFetchTime=void 0,this.isDataLastest=void 0,this.requestingIds=void 0,this.name=Nh.a,this.key="convId",this.didInit=!1,this.doneLoadDB=!1,this.data=new Map,this.reFetchCount=0,this.isDataLastest=!1,this.lastFetchTime=0,this.requestingIds=new Map}init(){this.didInit||(this.didInit=!0,this._loadData(),this._fetchPinnedConversations(),this._addListener())}async _loadData(){const e=n.default.getInstance().getItemForCurrentUser(Ph);if(e&&e.length)try{const s=JSON.parse(e),a=Object.keys(s).map((async e=>{await this._verifyPin(s[e].id)&&this.data.set(s[e].id,{id:s[e].id,priority:Number(s[e].priority)||Ct.default.getTimeNow()})}));await Promise.all(a);try{this.Logger.zsymb(0,"iSsDUC","pin conversations loaded from local",JSON.stringify(Object.fromEntries(this.data)))}catch(t){this.Logger.zsymb(18,"zxyi_d","stringify fail")}this.doneLoadDB=!0;const i=this.getAllPinnedConversations();i.length&&this._broadcastEvent(ai.b.ChangePinConv,i)}catch(s){0}}_addListener(){Ii.default.subscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,(e=>{this.Logger.zsymb(0,"fsOkwa","remove friend - unpin",e.userId),this.updateListPin([e.userId],zh)})),this._setFetchInterval()}_setFetchInterval(){this.refetchInterval&&clearTimeout(this.refetchInterval),this.refetchInterval=setInterval((()=>{this._fetchPinnedConversations()}),864e5)}_broadcastEvent(e,t){this.dispatchEvent(new ai.e(e,t))}_newPinItem(e,t){return{id:e,priority:t}}_syncServer(e,t){return this._updatePinnedConversationsV2(e,t)}getLastFetchTime(){return this.lastFetchTime}isPinned(e){return this.data.has(e)}getPinTime(e){const t=this.data.get(e);return t?t.priority:0}async _checkAndSyncDataBeforeAction(){if(!this.isDataLastest)try{return await this._fetchPinnedConversations(),!0}catch(e){return!1}return!0}pin(e){return this.Logger.zsymb(0,"idVGbK","client pin",e),new Promise((async(t,s)=>{const a=await this._checkAndSyncDataBeforeAction();if(!e||!e.length)return s(null);if(a){if(this.data.size+e.length>Ce.default.limit_pin_messages)return s(null);let a=[];for(let t=0;t<e.length;++t)this.isPinned(e[t])||a.push(e[t]);if(a.length>0)try{const s=await this._syncServer(a,Bh);return this.updateListPin(e,Bh),t(s)}catch(i){return s(i)}}return s(null)}))}pinLocal(e){this.updateListPin(e,Bh)}unpin(e,t=!1){return this.Logger.zsymb(0,"HWxWIP","client unpin",e,"force sync",t),new Promise((async(s,a)=>{if(!e||!e.length)return a(null);if(await this._checkAndSyncDataBeforeAction()){let n=[];for(let s=0;s<e.length;++s)(this.isPinned(e[s])||t)&&n.push(e[s]);if(n.length>0)try{await this._syncServer(n,zh),this.updateListPin(e,zh),s(1)}catch(i){a(i)}}return a(null)}))}unpinLocal(e){this.Logger.zsymb(0,"ohRBya","unpin local",e),this.updateListPin(e,zh)}getAllPinnedConversations(){return Array.from(this.data.values())}getAllPinnedConversationsSync(){return Array.from(this.data.values())}getTotalPinnedConversation(){return this.data.size+Array.from(this.requestingIds.values()).filter((e=>e===Bh)).length}async _verifyPin(e){try{const{isOk:t,index:s}=await this.checkPromises([()=>Promise.resolve(Ii.default.isFriend(e)),()=>Promise.resolve(yn.default.getGroupByIdSync(e)),()=>Promise.resolve(e===Ce.default.sendToMeId),()=>new Promise((t=>{Ii.default.getProfileFriendByIds([e],Y.SRC_GET_PROFILE.FETCH_MINI_INFO,{isReqOAInfo:!0}).then((s=>{var a;return t((null==s||null===(a=s[e])||void 0===a?void 0:a.type)>=1)})).catch((()=>t(!1)))}))]);return this.Logger.zsymb(3,"Akmybm",["verify pinned conversation","9mHnqK"],e,t,s),t}catch(t){return this.Logger.zsymb(21,"ewUwBU",["Error checking if conversation is OA","OOI9Lq"],e,t),!1}}async checkPromises(e){for(let s=0;s<e.length;s++)try{if(await e[s]())return{isOk:!0,index:s}}catch(t){continue}return{isOk:!1,index:-1}}async updateListPin(e,t){if(this.Logger.zsymb(0,"LG01lc","updateListPin",e,t),!e||!e.length)return;const s=[];switch(t){case Bh:{let t=Ct.default.getTimeNow();const a=e.map((async e=>{if(await this._verifyPin(e)&&!this.data.has(e)){++t,this.requestingIds.get(e)&&this.requestingIds.set(e,Uh);return{convId:e,pin:this._newPinItem(e,t)}}return null}));(await Promise.all(a)).forEach((e=>{e&&(this.data.set(e.convId,e.pin),s.push(e.pin),Object(nc.h)(this.name,e.convId))}));break}case zh:for(let t=0;t<e.length;t++)if(this.data.has(e[t])){this.requestingIds.get(e[t])&&this.requestingIds.set(e[t],Uh),this.data.delete(e[t]);const a=this._newPinItem(e[t],0);s.push(a),Object(nc.h)(this.name,e[t])}break;default:return}s.length&&this._broadcastEvent(ai.b.ChangePinConv,s),this._updateInDB()}_retryFetch(e){if(this.reFetchCount>5)return;let t=0;switch(e){case"ERR_NO_NETWORK":case-69:break;case 212:this.Logger.zsymb(20,"pSxjLl","hasn't pinned conversation from server");n.default.getInstance().setItemForCurrentUser(jh,"0"),this._sendToServer();break;case"ERR_CONNECTION_TIMED_OUT":case 112:t=5e3*this.reFetchCount;break;default:t=36e5}this.Logger.zsymb(21,"TcIKrO",["Handle request error fail with error: {}, retry after time= {}","nfvOvB"],e,t),this.retryTimeout||t>0&&(this.retryTimeout=setTimeout((()=>{this._fetchPinnedConversations(),this.retryTimeout=void 0}),t))}_parseData(e){let t=[];for(let s=0;s<e.length;++s)"m1"===e[s]||(e[s].startsWith("g")?t.push(e[s]):t.push(e[s].slice(1)));return t}_fetchPinnedConversations(){return this.reFetchCount++,this.Logger.zsymb(0,"Zha0VV","_fetchPinnedConversations",this.reFetchCount),new Promise(((e,t)=>{So.default.getPinnedConversations().then(Co.a).then((t=>{if(t&&t.conversations){const e=n.default.getInstance();void 0===t.version&&null===t.version||e.setItemForCurrentUser(jh,t.version),this._onFetchPin(this._parseData(t.conversations))}e(t)})).catch((e=>{this.isDataLastest=!1,e&&(e.error_code?this._retryFetch(e.error_code):e.code?this._retryFetch(e.code):this._retryFetch("UNKNOWN_ERROR")),t(e)}))}))}_updatePinnedConversationsV2(e,t){return new Promise(((s,a)=>{if(!Ce.default.enable_sync_pinned)return;if(!le.b.getStateNetwork())return void a(t===Bh?ce.a.str("STR_ERR_NETWORK_PIN_CONVERSATION"):ce.a.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));let i=[];for(let n=0;n<e.length;++n)e[n].startsWith("g")||e[n].startsWith("u")||(e[n]="u"+e[n]),i.includes(e[n])||this.requestingIds.has(e[n])&&this.requestingIds.get(e[n])!==Uh||(i.push(e[n]),this.requestingIds.set(e[n],t));i.length&&So.default.updatePinnedConversationsV2(i,t).then(Co.a).then((()=>{i.forEach((e=>{this.requestingIds.set(e,Uh)})),s(!0)})).catch((e=>{i.forEach((e=>{this.requestingIds.set(e,Uh)})),this.Logger.zsymb(20,"WLG80v","Update sync pin conv v2 FAIL: "+e);let s="";if(e)if(e.error_code)if(160===e.error_code)this._fetchPinnedConversations();else s=ce.a.str("STR_ERR_PIN_CONVERSATION")+" ("+e.error_code+")";else"ERR_NO_NETWORK"===e.code&&le.b.getStateNetwork()==le.a.DISCONNECT&&(s=t===Bh?ce.a.str("STR_ERR_NETWORK_PIN_CONVERSATION"):ce.a.str("STR_ERR_NETWORK_UNPIN_CONVERSATION"));a(s)}))}))}_isRemoteDataChanged(e){const t=Array.from(this.data.values()).sort(((e,t)=>t.priority-e.priority)).map((e=>e.id));if(e.length!==t.length)return!0;let s=!1;return e.forEach(((e,a)=>{e!==t[a]&&(s=!0)})),s}async _onFetchPin(e){this.Logger.zsymb(0,"SWL6Aq","onFetchPin",e),this.isDataLastest=!0,this.lastFetchTime=Ct.default.getTimeNow(),this.reFetchCount=0;let t=Ct.default.getTimeNow();this._setFetchInterval();const s=[],a=[];for(let n=0;n<e.length;n++)try{await this._verifyPin(e[n])?a.push(e[n]):this.unpin([e[n]],!0)}catch(i){this.Logger.zsymb(18,"glQ5yj","Error verifying pin for conversation",e[n],i)}if(this._isRemoteDataChanged(a)){for(const e of Array.from(this.data.values()))a.find((t=>t===e.id))||(this.data.delete(e.id),Object(nc.h)(this.name,e.id),s.push({id:e.id,priority:0}));for(let e=0;e<a.length;e++){const i=this._newPinItem(a[e],t),n=this.isPinned(a[e]);this.data.set(a[e],i),n||Object(nc.h)(this.name,a[e]),t--,s.push(i)}this.Logger.zsymb(0,"SeYQ66","[After Fetch]",Array.from(this.data.values())),s.length&&this._broadcastEvent(ai.b.ChangePinConv,s),this._updateInDB()}}_sendToServer(){this._syncServer(Array.from(this.data.keys()),Bh)}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){this.Logger.zsymb(18,"-teX0d","onGetItemFailure - key:",e," - error",t)}onGetListFailure(e,t){this.Logger.zsymb(18,"GI7wgb","onGetItemFailure - key:",e," - error",t)}_updateInDB(){if(!this.data)return;const e=n.default.getInstance();this.data.size?e.setItemForCurrentUser(Ph,JSON.stringify(Array.from(this.data.values()))):e.removeItemForCurrentUser(Ph)}})||kh)||kh);var Gh,xh=s("MnJw");Object(xi.b)(xh.b)(Gh=Reflect.metadata("design:type",Function)(Gh=Reflect.metadata("design:paramtypes",[])(Gh=class extends hs.b{constructor(){super()}onUpdateListArchivedChat(e){this.dispatchEvent(new ai.a(ai.b.UpdateListArchivedChat,e))}onOffArchivedChat(e){this.dispatchEvent(new ai.a(ai.b.OnOffArchivedChat,"",{status:e}))}})||Gh)||Gh);var Vh=s("413w"),Hh=s("KGrx"),Wh=s("YZUF"),qh=s("m89U"),Kh=s("k1WO"),Zh=s("DS8e");class $h extends Error{constructor(e){super(e.message||e.code),this._code=void 0,this._code=Zh.a[e.code]}get code(){return this._code}}var Qh=s("8Isn"),Yh=s("iRKH"),Jh=s("hNYB"),Xh=s("jnJr"),eg=s("2+pv"),tg=s("QDKs");function sg(e){if(!e)return!1;if(!["string","number"].includes(typeof e))return!1;if("string"==typeof e){const t=Number(e);if(isNaN(t)||(t+"").length!==e.length)return!1}return!0}function ag(e){return(e+"").startsWith(Y.GROUPID_PREFIX)}function ig(e,t){return new Promise((async(s,a)=>{try{let a=await ng(e);var i,n,r;if(a)e.cliMsgId=null===(i=a.msg)||void 0===i?void 0:i.cliMsgId,e.fromUid=null===(n=a.msg)||void 0===n?void 0:n.fromUid,e.toUid=null===(r=a.msg)||void 0===r?void 0:r.toUid;let o=await function(e,t){return new Promise((async(s,a)=>{try{if(!e.convId||!e.cliMsgId)return s(void 0);const a={msgId:e.msgId+"",cliMsgId:e.cliMsgId+"",fromUid:e.fromUid+"",toUid:e.convId+""},i=Xt.default.getInstance(),n={index:"cliMsgIdIndex",limit:null==t?void 0:t.limit,direction:(null==t?void 0:t.direction)||O.c.PREV,predicate:e=>Object(Qh.a)(e,a),partition:e.convId},r={from:e.cliMsgId+"",to:e.cliMsgId+"",excludeFrom:!1,excludeTo:!1},o=await i.Core.Message.getAll(r,n);let c=o[0];const l=o.map((e=>e.msgId)),d=[];o.length>1&&a.fromUid&&(c=o.reduce(((e,t)=>{var s,i;return t.fromUid!==a.fromUid?e:(e||(e=t),t.isLocalMsgId||null!==(s=t.msgId)&&void 0!==s&&s.includes("_")?(e.msgId!==t.msgId&&d.push(t.msgId),e):e.isLocalMsgId||null!==(i=e.msgId)&&void 0!==i&&i.includes("_")?(d.push(e.msgId),e=t):(Number.isInteger(parseInt(e.msgId))&&Number.isInteger(parseInt(t.msgId))&&(parseInt(e.msgId)>parseInt(t.msgId)||parseInt(e.msgId)==parseInt(t.msgId)&&e.msgId>t.msgId)&&(d.push(e.msgId),e=t),e))}))),s({msg:c,msgIds:l,duplicatedMsgIds:d})}catch(i){ng(e).then(s).catch(a)}}))}(e,t);if(a)return s({msg:a.msg,msgIds:(null==o?void 0:o.msgIds)||[],duplicatedMsgIds:(null==o?void 0:o.duplicatedMsgIds)||[]});if(null!=o&&o.msg)return s(o);s(void 0)}catch(o){a(o)}}))}function ng(e){return new Promise((async(t,s)=>{try{if(!e.convId)return t(void 0);if(!e.msgId)return t(void 0);const s=Xt.default.getInstance(),a=await s.Core.Message.get(String(e.msgId),{partition:e.convId});if(a)return t({msg:a,msgIds:[a.msgId],duplicatedMsgIds:[]});t(void 0)}catch(a){s(a)}}))}function rg(e){if(!e)return;const{msgId:t,cliMsgId:s,fromUid:a,toUid:i}=Object(Yh.c)(e);if(sg(s)&&sg(a)&&t)return{ownerId:a+"",cliMsgId:s+"",globalMsgId:Vh.a.normalize(t),destId:i}}function og(e,t,s){if(!(e&&t&&t.quote&&s))return!1;if(t.quote.cliMsgType===Y.MSG_DEL_EVERYONE)return!1;if(t.quote.cliMsgType===Y.MSG_UNDO)return!1;const a="0"==s.fromUid?e:s.fromUid;return!(!t.quote.globalMsgId||!t.quote.cliMsgId||t.quote.globalMsgId.toString()!=s.msgId||t.quote.cliMsgId!=s.cliMsgId||a!=t.quote.ownerId)||t.quote.cliMsgId==s.cliMsgId&&a==t.quote.ownerId&&t.toUid===s.toUid}async function cg(e){try{const t=Xt.default.getInstance(),s={from:[e,"",""],to:[e,Ec,Cc],excludeFrom:!1,excludeTo:!1},a={index:"userId_sendDttm_msgId",limit:1,direction:O.c.PREV,partition:e,predicate:e=>!!(e.cliMsgId&&e.fromUid&&e.msgId)},i=await t.Core.Message.getAll(s,a);return null==i?void 0:i[0]}catch(t){return}}const lg=Object(gu.d)()?tg.a:{info:void 0,warn:void 0,error:void 0,zlog:tg.a.zlog};var dg;const ug="runDeleteMessages",hg="deleteMessage";let gg=Object(a.injectable)()(dg=function(e,t){return Object(a.inject)(Nn.ConvInfoDataManager)(e,void 0,0)}(dg=function(e,t){return Object(a.inject)(Nn.PreviewDataManager)(e,void 0,1)}(dg=Reflect.metadata("design:type",Function)(dg=Reflect.metadata("design:paramtypes",[void 0===Nn.ConvInfoDataManager?Object:Nn.ConvInfoDataManager,void 0===Nn.PreviewDataManager?Object:Nn.PreviewDataManager])(dg=class extends hs.b{constructor(e,t){super(),this.convInfoDataManager=e,this.previewDataManager=t,this.database=void 0,this.taskManager=void 0,this.joinGroupTime={},this.receivedActions={},this.waitingMessages=[],this.batchingModeResolvers=[],this.batchingModeRejectors=[],this.batchingModeTimeout=null,this.database=Xt.default.getInstance(),this.taskManager=(new Hh.TaskManager).setup("conversation-operation");const s=()=>{Kh.b.key("enable_restore_task").boolean&&(Kh.b.remove(s),this.restoreBackupTasks())};Kh.b.add(s)}deleteConversation(e,t){return new Promise((async(s,a)=>{try{var i,n,r,o,c;if(null===(i=lg.info)||void 0===i||i.call(lg,Ic,`${e} Delete conversation start`,t),lg.zlog.zsymb(0,"e5XI4o",`${e} ${Ic} Delete conversation start`),Wh.b.start(Wh.a.ART_delete_conversation_v2),!e)throw new $h({code:"INVALID_CONVERSATION_DATA",message:`${e} Delete conversation info is invalid`});const a=await this.convInfoDataManager.getConvById(e),u=await this.previewDataManager.getPreviewById(e),h=(null==t?void 0:t.deleteTime)||Ct.default.getTimeNow();let g=(null==t||null===(n=t.messageInfo)||void 0===n?void 0:n.msgId)||(null==u?void 0:u.msgId),m=(null==t||null===(r=t.messageInfo)||void 0===r?void 0:r.cliMsgId)||(null==u?void 0:u.cliMsgId);if(void 0===g){const t=await cg(e);g=null==t?void 0:t.msgId,m=null==t?void 0:t.cliMsgId}const p={convId:e,msgId:g,cliMsgId:m,toUid:e,fromUid:null==t||null===(o=t.messageInfo)||void 0===o?void 0:o.fromUid,initialDeleteTime:h,deleteTime:h,isGroup:ag(e),isLeaveGroup:null==t?void 0:t.isLeaveGroup,isLeaveGroupInSilentMode:null==t?void 0:t.isLeaveGroupInSilentMode,leaveType:null==t?void 0:t.leaveType,isForceDelete:null==t?void 0:t.isForceDelete,isDeleteResource:"boolean"!=typeof(null==t?void 0:t.isDeleteResource)||t.isDeleteResource,isExistConvInfo:!!a,isExistPreviewInfo:!!u,delConversationId:e},f=`${p.convId}_${p.msgId}_${p.cliMsgId}`;if("client"!==(null==t?void 0:t.source)||null!=t&&t.isDisableSync){if("server"===(null==t?void 0:t.source)&&this.receivedActions[f]){var l;return delete this.receivedActions[f],null===(l=lg.warn)||void 0===l||l.call(lg,Ic,`${p.convId} Delete conversation is duplicate action ${f}`),Wh.b.cancel(Wh.a.ART_delete_conversation_v2),s(p)}}else this.receivedActions[f]=!0;if(!this.isNewDeleteEvent(e,p.initialDeleteTime))throw new $h({code:"CANCEL_DELETE_CONVERSATION",message:`${e} Delete conversation info is old event`});var d;if(!p.isForceDelete&&(ui.default.isKickOrDisbandGroup(a)||(null==u?void 0:u.messageType)===Y.MSG_KICK_GROUP||(null==u?void 0:u.messageType)===Y.MSG_DISBAND_GROUP))return null===(d=lg.warn)||void 0===d||d.call(lg,Ic,`${e} Delete conversation info is kick or disband group`),Wh.b.cancel(Wh.a.ART_delete_conversation_v2),s(p);this.fireEventsBeforeDeleteConversation(p);if(Kh.b.key("sync_delete_conversation").boolean&&!(null!=t&&t.isDisableSync)){const t=await this.createSyncDeleteConversationData(e,{msgId:p.msgId,cliMsgId:p.cliMsgId,fromUid:p.fromUid});this.syncDeleteConversation(e,t)}await this.deleteConversationInfo(p),this.deleteMessagesWithConversationInfo(p),this.fireEventsAfterDeleteConversation(p),null===(c=lg.info)||void 0===c||c.call(lg,Ic,`${e} Delete conversation success`,p),lg.zlog.zsymb(0,"Ut5jlm",`${e} ${Ic} Delete conversation success`),Wh.b.end(Wh.a.ART_delete_conversation_v2),s(p)}catch(h){var u;const t=h;null===(u=lg.error)||void 0===u||u.call(lg,Ic,`${e} Delete conversation error`,t.code||-1,t),lg.zlog.zsymb(18,"ewgaRt",`${Ic} ${e} Delete conversation error ${t.message}`),Wh.b.end(Wh.a.ART_delete_conversation_v2,{isFailed:!0,errorCode:t.code||-1}),a(t)}}))}deleteMessage(e,t){return new Promise((async(s,a)=>{const{convId:i,msgId:n,cliMsgId:r,fromUid:o,toUid:c,uidSenderDel:l}=e;try{var d,u;const a=(null==t?void 0:t.type)||"only-me";null===(d=lg.info)||void 0===d||d.call(lg,Ic,`${n} Delete message start`,e,t),lg.zlog.zsymb(0,"Q7lfKq",`${Ic} ${n} Delete message start`),Wh.b.start(Wh.a.ART_delete_message_v2);const g={convId:i,msgId:n,cliMsgId:r,fromUid:o,toUid:c,uidSenderDel:l,type:a,isDisableSync:(null==t?void 0:t.isDisableSync)||!0,isDeleteResource:"boolean"!=typeof(null==t?void 0:t.isDeleteResource)||t.isDeleteResource,conversation:{userId:i}};if(!function(e){return!(!e.convId||!e.cliMsgId)}(g))throw new $h({code:"INVALID_MESSAGE_DATA",message:`${n} Delete message info is invalid`});const m=Kh.b.key("immediately_execute_everyone_or_recall").boolean&&("recall"===g.type||"everyone"===g.type);if(Kh.b.key("enable_batching_mode").boolean&&!m){var h;const e=await this.collectWaitingMessages(g)||{};return null===(h=lg.info)||void 0===h||h.call(lg,Ic,`${n} Delete message success`,g),lg.zlog.zsymb(0,"1UhAyS",`${Ic} ${n} Delete message success`),Wh.b.end(Wh.a.ART_delete_message_v2),void s(Object(I.a)(Object(I.a)({},g),e))}const p=await this.deleteMessageWithMessageInfo([g],{isCatchError:!0,isImmediately:m})||{};null===(u=lg.info)||void 0===u||u.call(lg,Ic,`${n} Delete message success`,g),lg.zlog.zsymb(0,"V1HlYG",`${Ic} ${n} Delete message success`),Wh.b.end(Wh.a.ART_delete_message_v2),s(p)}catch(m){var g;const e=m;null===(g=lg.error)||void 0===g||g.call(lg,Ic,`${n} Delete message error`,e.code||-1,e),lg.zlog.zsymb(18,"5YxvSe",`${Ic} ${n} Delete message error ${e.message}`),Wh.b.end(Wh.a.ART_delete_message_v2,{isFailed:!0,errorCode:e.code||-1}),a(e)}}))}setJoinGroupTime(e,t){e&&t&&(!this.joinGroupTime[e]||this.joinGroupTime[e]<t)&&(this.joinGroupTime[e]=t)}isDeleteMessage(e){try{if(vo.d.isDeleteMessage(e.toUid,e))return!0;const t=this.buildMessageKey(e);if(!e.msgId&&!t)throw new Error("Invalid message key");const s=this.taskManager.getBackupData(hg);if(s)for(let a in s){const i=s[a];if(i.find((s=>{if(s.msgId)return s.msgId===e.msgId;return this.buildMessageKey(s)===t})))return!0}return!1}catch(s){var t;return null===(t=lg.error)||void 0===t||t.call(lg,Ic,`${e.msgId} Check delete message error`,s),lg.zlog.zsymb(18,"ONTlcK",`${Ic} ${e.msgId} Check delete message error ${s}`),!1}}restoreBackupTasks(){const e=this.createDeleteConversationTask();e.onRestore((t=>{if(e.close(!0,"Restore delete conversations"),t)for(let e in t)this.deleteMessagesWithConversationInfo(t[e],!1)}));const t=this.createDeleteMessageTask();t.onRestore((e=>{if(t.close(!0,"Restore delete messages"),e)for(let t in e){const s=Array.isArray(e[t])?e[t]:[e[t]];let a=!0,i=!1;if(1===s.length){const e=s[0];i=Kh.b.key("immediately_execute_everyone_or_recall").boolean&&("recall"===e.type||"everyone"===e.type),i&&(a=!1)}this.deleteMessageWithMessageInfo(s,{isCatchError:!1,isImmediately:i,isTriggerDispatch:!0,batchingModeOptions:{isBatchingMode:Kh.b.key("enable_batching_mode").boolean&&a}})}}))}isNewDeleteEvent(e,t){return!this.joinGroupTime[e]||!t||this.joinGroupTime[e]<t}syncDeleteConversation(e,t){return new Promise((async(s,a)=>{try{var i,n;if(null===(i=lg.info)||void 0===i||i.call(lg,Ic,`${e} Sync delete conversation start`,t),lg.zlog.zsymb(0,"XSLbx0",`${Ic} ${e} Sync delete conversation start`),Wh.b.start(Wh.a.ART_delete_conversation_sync_v2),!t)throw new $h({code:"INVALID_CONVERSATION_DATA",message:`${e} Sync delete conversation data is invalid`});await qc.default.syncDeleteConversation(e,ag(e),t,ul.a.next()+""),null===(n=lg.info)||void 0===n||n.call(lg,Ic,`${e} Sync delete conversation success`),lg.zlog.zsymb(0,"OBn_Kf",`${Ic} ${e} Sync delete conversation success`),Wh.b.end(Wh.a.ART_delete_conversation_sync_v2),s()}catch(o){var r;const t=new $h({code:"SYNC_CONVERSATION_ERROR",message:`${e} Sync delete conversation failed`});null===(r=lg.error)||void 0===r||r.call(lg,Ic,`${e} Sync delete conversation failed`),lg.zlog.zsymb(18,"ybSeUp",`${Ic} ${e} Sync delete conversation failed`),Wh.b.end(Wh.a.ART_delete_conversation_sync_v2,{isFailed:!0,errorCode:t.code||-1}),a(t)}}))}deleteConversationInfo(e){return new Promise((async(t,s)=>{try{if(!e.convId)throw new $h({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete conversation info is invalid`});if(Kh.b.key("leave_conversation_ui").boolean&&!el.q.isCommunity(e.convId)||delete e.leaveType,"disband"===e.leaveType){const t=yn.default.getGroupByIdSync(e.convId);(null==t?void 0:t.creatorId)&&t.creatorId===Ii.default.getUidMe()&&delete e.leaveType}const s=e.isLeaveGroup||e.convId===Ce.default.sendToMeId;this.previewDataManager.onDeleteConversation(e.convId,e.leaveType),s?await this.convInfoDataManager.onDeleteConversation(e.convId,e.leaveType):await this.convInfoDataManager.onEmptyConversation(e.convId),e.isForceDelete&&yn.default.removeGroupById(e.convId),t()}catch(a){s(new $h({code:"CONVERSATION_INFO_ERROR",message:`${e.convId} Delete conversation info failed`}))}}))}deleteMessagesWithConversationInfo(e,t=!0){return new Promise((async(s,a)=>{const i=this.createDeleteConversationTask(),n=i=>{var n;null===(n=lg.error)||void 0===n||n.call(lg,Ic,`${e.convId} Run delete messages error`,i.code||-1,i),lg.zlog.zsymb(18,"hfs8-o",`${Ic} ${e.convId} Run delete messages error ${i.message}`),Wh.b.end(Wh.a.ART_delete_messages_in_batch_v2,{isFailed:!0,errorCode:i.code||-1}),t?a(i):s()};i.execute((()=>{Wh.b.start(Wh.a.ART_delete_messages_in_batch_v2),this.runDeleteMessages(e,(()=>{Wh.b.end(Wh.a.ART_delete_messages_in_batch_v2),s(),i.close()}),(e=>{n(e),i.close()}))}),e),i.onError((e=>n(e)))}))}async runDeleteMessages(e,t,s){try{if(e.convId&&!this.isNewDeleteEvent(e.convId,e.initialDeleteTime))return void s(new $h({code:"CANCEL_DELETE_CONVERSATION",message:`${e.convId} Delete batch messages is canceled`}));const a=await this.getDeleteInfoByThread(e);if(!a)throw e.isExistConvInfo&&e.isExistPreviewInfo?new $h({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete conversation info is invalid`}):new $h({code:"NOT_FOUND_CONVERSATION",message:`${e.convId} Conversation not found`});const i=Object(I.a)({},e);i.msgId!=a.maxMsgId&&(i.msgId=a.maxMsgId),i.deleteTime&&a.maxSendDttm&&i.deleteTime!=a.maxSendDttm&&(i.deleteTime=a.maxSendDttm),i.cliMsgId!=a.maxCliMsgId&&(i.cliMsgId=a.maxCliMsgId),this.database.Core.runFakeTransaction([this.database.Core.Message],(async([n])=>new Promise((async()=>{try{var r,o,c;if(null===(r=lg.info)||void 0===r||r.call(lg,Ic,`${e.convId} Delete batch messages start`),null!==(o=a.duplicatedMsgIds)&&void 0!==o&&o.length)null===(c=lg.info)||void 0===c||c.call(lg,Ic,`${e.convId} Delete duplicated messages for first message in batch`,a.duplicatedMsgIds),await n.deleteMulti(a.duplicatedMsgIds,{partition:e.convId});const u=await this.deleteBatchMessages(i,n);var l,d;if(u.isContinue)return null===(l=lg.info)||void 0===l||l.call(lg,Ic,`${e.convId} Delete batch messages success`,i),i.msgId=u.nextRoundMsgId,i.cliMsgId=u.nextRoundCliMsgId,i.fromUid=u.nextRoundFromUid,i.rangeMessage=u.oldRoundRangeMessage,this.runDeleteMessages(i,t,s);null===(d=lg.info)||void 0===d||d.call(lg,Ic,`${e.convId} Delete batch messages success`),t()}catch(u){const e=u;s(e.code?e:new $h({code:"DB_ERROR",message:`${i.convId} Delete batch messages failed`}))}}))))}catch(a){s(a)}}deleteBatchMessages(e,t){return new Promise((async(s,a)=>{try{var i;if(!e.convId)return a(new $h({code:"INVALID_CONVERSATION_DATA",message:`${e.convId} Delete batch messages data is invalid`}));const r={isContinue:!1,nextRoundMsgId:void 0};if(!e.msgId)return s(r);const o=this.getBatchMessagesLimit();if(o<1)return s(r);const c={from:[e.convId+"","",""],to:[e.convId+"",e.deleteTime+"",e.msgId+""],excludeFrom:!1,excludeTo:!1},l={index:"userId_sendDttm_msgId",limit:o+1,direction:O.c.PREV,partition:e.convId,useLGKeyRange:!0},d=await t.getAll(c,l),u=d.map((e=>e.msgId));if(0===d.length)return s(r);if(d.length>o){r.isContinue=!0;const e=d.pop();u.pop(),r.nextRoundMsgId=null==e?void 0:e.msgId,r.nextRoundCliMsgId=null==e?void 0:e.cliMsgId,r.nextRoundFromUid=null==e?void 0:e.fromUid}null===(i=lg.info)||void 0===i||i.call(lg,Ic,`${e.convId} Delete batch messages list`,d);const h={fromId:d[0].msgId,toId:d[d.length-1].msgId};if(e.rangeMessage){if(e.rangeMessage.fromId===d[0].msgId&&e.rangeMessage.toId===d[d.length-1].msgId)return a(new $h({code:"LOOP_ERROR",message:`${e.convId} Loop delete batch messages`}));r.oldRoundRangeMessage=h}else r.oldRoundRangeMessage=h;this.fireEventsBeforeDeleteBatchMessages(e,d),await t.deleteMulti(u,{partition:e.convId}),this.fireEventsAfterDeleteBatchMessages(e,d),void 0===e.countDeleted&&(e.countDeleted=0),e.countDeleted++;const g=this.getBatchThrottleTime();var n;if(r.isContinue&&g>0)null===(n=lg.info)||void 0===n||n.call(lg,Ic,`${e.convId} Delete batch messages sleep`,g),await Object(gu.i)(g);s(r)}catch(o){var r;null===(r=lg.error)||void 0===r||r.call(lg,Ic,`${e.convId} Delete batch messages failed`,o),a(o)}}))}syncDeleteMessage(e,t){const{convId:s}=e;return s?new Promise((async(a,i)=>{try{var n,r;null===(n=lg.info)||void 0===n||n.call(lg,Ic,`${t.msgId} Sync delete message start`),lg.zlog.zsymb(0,"_R-dzp",`${Ic} ${t.msgId} Sync delete message start`),Wh.b.start(Wh.a.ART_delete_message_sync_v2),await qc.default.syncDeleteMessage(s,ag(s),[rg(t)],ul.a.next(),"only-me"===e.type?1:0,void 0,Object(nh.f)(t)===Y.MSG_E2EE),null===(r=lg.info)||void 0===r||r.call(lg,Ic,`${t.msgId} Sync delete message success`),lg.zlog.zsymb(0,"FpOhHd",`${Ic} ${t.msgId} Sync delete message success`),Wh.b.end(Wh.a.ART_delete_message_sync_v2),a()}catch(o){const e=new $h({code:"SYNC_MESSAGE_ERROR",message:`${t.msgId} Sync delete message failed`});Wh.b.end(Wh.a.ART_delete_message_sync_v2,{isFailed:!0,errorCode:e.code||-1}),i(e)}})):Promise.resolve()}deleteMessageWithMessageInfo(e,t){return new Promise((async(s,a)=>{var i,n;const r=(null==t||null===(i=t.batchingModeOptions)||void 0===i?void 0:i.resolvers)||[s],o=(null==t||null===(n=t.batchingModeOptions)||void 0===n?void 0:n.rejectors)||[a];try{const s=(e,t)=>{const s="before"===t?this.fireEventsBeforeDeleteMessage.bind(this):this.fireEventsAfterDeleteMessage.bind(this);e.rawMsgs["only-me"].length>0&&s(Object(I.a)(Object(I.a)({},e.lastData),{},{type:"only-me"}),e.rawMsgs["only-me"]),e.rawMsgs.recall.length>0&&s(Object(I.a)(Object(I.a)({},e.lastData),{},{type:"recall"}),e.rawMsgs.recall),e.rawMsgs.everyone.length>0&&s(Object(I.a)(Object(I.a)({},e.lastData),{},{type:"everyone"}),e.rawMsgs.everyone)},a=this.createDeleteMessageTask(null!=t&&t.isImmediately?"immediately":void 0),i=e=>{null!=t&&t.isCatchError?o.forEach((t=>null==t?void 0:t(e))):r.forEach((e=>null==e?void 0:e()))};a.execute((async()=>{var i,n,c;const l={},d={};let u=0;for(let s=0;s<e.length;s++){const a=e[s],i=await ig({convId:a.convId,msgId:a.msgId,cliMsgId:a.cliMsgId,fromUid:a.fromUid,toUid:a.toUid}),n=null==i?void 0:i.msg,c=(null==i?void 0:i.msgIds)||[],m=(null==i?void 0:i.duplicatedMsgIds)||[];if(!n||!a.convId||!a.type){var h,g;if(null!=t&&t.isCatchError)null===(h=o[s])||void 0===h||h.call(o,new $h({code:"NOT_FOUND_MESSAGE",message:`${a.msgId} Message not found`})),o[s]=void 0;else null===(g=r[s])||void 0===g||g.call(r),r[s]=void 0;a.convId&&a.type&&(d[a.convId]||(d[a.convId]={lastData:a,msgs:{"only-me":[],recall:[],everyone:[]}}),d[a.convId].lastData=a,d[a.convId].msgs[a.type].push({cliMsgId:a.cliMsgId,msgId:a.msgId,fromUid:a.fromUid,toUid:a.toUid,sendDttm:a.cliMsgId})),u++;continue}Kh.b.key("sync_delete_message").boolean&&!(null!=a&&a.isDisableSync)&&this.syncDeleteMessage(a,n),l[a.convId]||(l[a.convId]={msgs:{"only-me":[],recall:[],everyone:[]},rawMsgs:{"only-me":[],recall:[],everyone:[]},msgIdsOnlyMe:[],duplicatedMsgIds:[],lastData:a});const p=this.modifyMessageData(a,n);p.__index=s,l[a.convId].msgs[a.type].push(p),l[a.convId].rawMsgs[a.type].push(n),l[a.convId].duplicatedMsgIds.push(...m),l[a.convId].lastData=a,"only-me"===a.type&&l[a.convId].msgIdsOnlyMe.push(...c)}for(const e in d){const t=d[e];t.msgs["only-me"].length>0&&this.fireEventsNotFoundMessage(Object(I.a)(Object(I.a)({},t.lastData),{},{type:"only-me"}),t.msgs["only-me"]),t.msgs.recall.length>0&&this.fireEventsNotFoundMessage(Object(I.a)(Object(I.a)({},t.lastData),{},{type:"recall"}),t.msgs.recall),t.msgs.everyone.length>0&&this.fireEventsNotFoundMessage(Object(I.a)(Object(I.a)({},t.lastData),{},{type:"everyone"}),t.msgs.everyone)}var m;if(e.length===u)return null===(m=lg.info)||void 0===m||m.call(lg,Ic,"All messages are not found"),void a.close();const p=Object.values(l);if(0===p.length)throw new $h({code:"BATCHING_MODE_ERROR",message:"No delete messages"});p.forEach((e=>{s(e,"before")})),(null==t||null===(i=t.batchingModeOptions)||void 0===i?void 0:i.isBatchingMode)&&(null===(n=lg.info)||void 0===n||n.call(lg,Ic,"Batching messages",l));for(const e in l){const t=l[e],s=t.lastData,a=t.duplicatedMsgIds;var f;if(a.length)null===(f=lg.info)||void 0===f||f.call(lg,Ic,"Delete duplicated messages",a),await this.database.Core.Message.deleteMulti(a,{partition:e});switch(s.type){case"only-me":const e=t.msgs["only-me"].map((e=>e.msgId));await this.database.Core.Message.deleteMulti(e,{partition:s.convId}),s.convId&&this.convInfoDataManager.onDeleteMessages(s.convId,t.msgIdsOnlyMe.map((e=>({msgId:e}))));break;case"recall":case"everyone":const a=[...t.msgs.recall,...t.msgs.everyone].map((e=>{const t=Object(I.a)({},e);return delete t.__index,t}));await this.database.Core.Message.insertMulti(a,{replace:!0})}this.previewDataManager.onDeleteMessages("server",[...t.msgs["only-me"],...t.msgs.everyone]),t.msgs.recall.forEach((e=>{this.previewDataManager.onUndoMessage("server",e)}))}p.forEach((a=>{s(a,"after");const i=[...a.msgs["only-me"],...a.msgs.recall,...a.msgs.everyone];for(let s=0;s<i.length;s++){const a=i[s];if("number"==typeof a.__index){var n;const s=a.__index;delete a.__index;const i=Object(I.a)(Object(I.a)({},e[s]),a);null===(n=r[s])||void 0===n||n.call(r,i),null!=t&&t.isTriggerDispatch&&Object(qh.a)([i])}}}));const v=null!=t&&null!==(c=t.batchingModeOptions)&&void 0!==c&&c.isBatchingMode?this.getBatchingModeThrottleTime():this.getMessageThrottleTime();var _;v>0&&(null===(_=lg.info)||void 0===_||_.call(lg,Ic,"Delete message sleep",v),await Object(gu.i)(v));a.close()}),e),a.onError((e=>i(e)))}catch(c){null!=t&&t.isCatchError?o.forEach((e=>null==e?void 0:e(c))):r.forEach((e=>null==e?void 0:e()))}}))}modifyMessageData(e,t){let s=Object(I.a)({},t);switch(e.uidSenderDel&&(s.uidSenderDel=e.uidSenderDel),e.type){case"only-me":break;case"recall":s=_o.default.convertToRecalled(s),s.msgType=Y.MSG_UNDO,s.originMsgType="chat.undo",Object(nh.f)(s)!==Y.MSG_E2EE_PENDING&&Object(nh.f)(s)!==Y.MSG_E2EE_FAILED||(s.e2eeStatus=Y.MSG_E2EE_UNDO);break;case"everyone":s=_o.default.convertToDelEveryone(s),s.msgType=Y.MSG_DEL_EVERYONE}return s}createSyncDeleteConversationData(e,t){return new Promise((async(s,a)=>{try{if(sg(t.fromUid)&&sg(t.cliMsgId)&&t.msgId)return s({ownerId:this.getFromUid(t.fromUid+""),cliMsgId:t.cliMsgId+"",globalMsgId:Vh.a.normalize(t.msgId)});const a=await cg(e);if(a&&a.fromUid&&a.cliMsgId&&a.msgId)return s({ownerId:this.getFromUid(a.fromUid+""),cliMsgId:a.cliMsgId+"",globalMsgId:Vh.a.normalize(a.msgId)});s(void 0)}catch(i){a(i)}}))}createDeleteConversationTask(){return this.taskManager.createTask(ug,{priority:"normal",backup:{key:ug},retry:this.getRetryTime(),waitForRetry:this.getWaitForRetry()})}createDeleteMessageTask(e){return this.taskManager.createTask(hg,{priority:e||"high",backup:{key:hg},retry:this.getRetryTime(),waitForRetry:this.getWaitForRetry()})}getDeleteInfoByThread(e){return new Promise((async(t,s)=>{try{if(!e.convId)return t(void 0);const s=await ig({convId:e.convId,msgId:e.msgId,cliMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid}),a=null==s?void 0:s.msg,i=null==s?void 0:s.duplicatedMsgIds;if(a)return t({maxMsgId:a.msgId,maxSendDttm:parseInt(a.sendDttm),maxCliMsgId:a.cliMsgId,duplicatedMsgIds:i});if(e.msgId&&e.deleteTime)return t({maxMsgId:e.msgId,maxSendDttm:e.deleteTime,maxCliMsgId:e.cliMsgId});t(void 0)}catch(a){s(a)}}))}collectWaitingMessages(e){const t=()=>{this.deleteMessageWithMessageInfo([...this.waitingMessages],{isCatchError:!0,batchingModeOptions:{isBatchingMode:!0,resolvers:[...this.batchingModeResolvers],rejectors:[...this.batchingModeRejectors]}}),this.waitingMessages=[],this.batchingModeResolvers=[],this.batchingModeRejectors=[],this.batchingModeTimeout&&(clearTimeout(this.batchingModeTimeout),this.batchingModeTimeout=null)};return new Promise(((s,a)=>{this.waitingMessages.length>=this.getBatchingModeLimit()&&t(),this.waitingMessages.push(e),this.batchingModeResolvers.push(s),this.batchingModeRejectors.push(a),this.batchingModeTimeout||(this.batchingModeTimeout=setTimeout((()=>{t()}),this.getBatchingModeDelayTime()))}))}getFromUid(e){return"0"==e?Ii.default.getUidMe():e}buildMessageKey(e){let t;return void 0!==e.cliMsgId&&void 0!==e.fromUid&&void 0!==e.toUid&&(t=`${e.cliMsgId}-${this.getFromUid(e.fromUid)}-${e.toUid.replace("g","")}`),t}getRetryTime(){return Kh.b.key("retry_time").number>0?Kh.b.key("retry_time").number:Kh.a.retry_time}getWaitForRetry(){return Kh.b.key("wait_for_retry").number>0?Kh.b.key("wait_for_retry").number:Kh.a.wait_for_retry}getBatchMessagesLimit(){const e=Ee.l?"batch_messages_limit_for_web":"batch_messages_limit";return Kh.b.key(e).number>0?Kh.b.key(e).number:Kh.a[e]}getBatchThrottleTime(){const e=Ee.l?"batch_messages_throttle_for_web":"batch_messages_throttle";return Kh.b.key(e).number>0?Kh.b.key(e).number:Kh.a[e]}getMessageThrottleTime(){const e=Ee.l?"message_throttle_for_web":"message_throttle";return Kh.b.key(e).number>0?Kh.b.key(e).number:Kh.a[e]}getBatchingModeThrottleTime(){const e=Ee.l?"batching_mode_throttle_for_web":"batching_mode_throttle";return Kh.b.key(e).number>0?Kh.b.key(e).number:Kh.a[e]}getBatchingModeDelayTime(){return Kh.b.key("batching_mode_delay_time").number>0?Kh.b.key("batching_mode_delay_time").number:Kh.a.batching_mode_delay_time}getBatchingModeLimit(){const e=Ee.l?"batching_mode_limit_for_web":"batching_mode_limit";return Kh.b.key(e).number>0?Kh.b.key(e).number:Kh.a[e]}fireEventsBeforeDeleteConversation(e){try{this.dispatchEvent(new Zh.b(Zh.c.BeforeDeleteConversation,{data:e}))}catch(t){}}fireEventsAfterDeleteConversation(e){try{this.dispatchEvent(new Zh.b(Zh.c.AfterDeleteConversation,{data:e}))}catch(t){}}fireEventsBeforeDeleteBatchMessages(e,t){try{this.dispatchEvent(new Zh.b(Zh.c.BeforeDeleteBatchMessages,{data:e,messages:t}))}catch(s){}}fireEventsAfterDeleteBatchMessages(e,t){try{this.dispatchEvent(new Zh.b(Zh.c.AfterDeleteBatchMessages,{data:e,messages:t}))}catch(s){}}fireEventsBeforeDeleteMessage(e,t){try{this.dispatchEvent(new Zh.b(Zh.c.BeforeDeleteMessage,{data:e,messages:t}))}catch(s){}}fireEventsAfterDeleteMessage(e,t){try{this.dispatchEvent(new Zh.b(Zh.c.AfterDeleteMessage,{data:e,messages:t}))}catch(s){}}fireEventsNotFoundMessage(e,t){try{this.dispatchEvent(new Zh.b(Zh.c.NotFoundMessage,{data:e,messages:t}))}catch(s){}}})||dg)||dg)||dg)||dg)||dg;var mg;a.ModuleContainer.registerSingleton(Nn.ConversationOperation,gg);let pg=Object(a.injectable)()(mg=Reflect.metadata("design:type",Function)(mg=Reflect.metadata("design:paramtypes",[])(mg=class{constructor(){this.isInitial=!1,this.isReady=!1,this.storage=void 0,this.timeoutSaveCache=null,this.data={},this.setTemp={},this.removeTempArr=[],this.storage=n.default.getInstance()}async init(e){if(Kh.b.key("enable").boolean&&Kh.b.key("cache_conversation_deletion").boolean)try{if(this.isInitial)return void(null==e||e());this.isInitial=!0;const t=await this.storage.getItemForCurrentUserAsync(Oc);t&&(this.data=JSON.parse(t)),this.data=Object(I.a)(Object(I.a)({},this.data),this.setTemp),this.setTemp={};for(const e of this.removeTempArr)delete this.data[e];this.removeTempArr=[],this.runTimeoutSaveCache(),this.isReady=!0,null==e||e()}catch(s){var t;this.isInitial=!1,null===(t=lg.error)||void 0===t||t.call(lg,Sc,"Init conversation deletion cache fail"),lg.zlog.zsymb(18,"d2emFj",`${Sc} Init conversation deletion cache fail`)}}getDeletedConversations(){return Kh.b.key("cache_conversation_deletion").boolean&&this.isReady?Object.values(this.data):[]}setDeletedConversation(e,t){Kh.b.key("cache_conversation_deletion").boolean&&e&&t&&(this.isReady?(this.data[e]=t,this.runTimeoutSaveCache()):this.setTemp[e]=t)}removeDeletedConversation(e){Kh.b.key("cache_conversation_deletion").boolean&&e&&(this.isReady?(delete this.data[e],this.runTimeoutSaveCache()):this.removeTempArr.push(e))}runTimeoutSaveCache(){this.timeoutSaveCache||(this.timeoutSaveCache=setTimeout((()=>{this.timeoutSaveCache=null;try{this.storage.setItemForCurrentUserAsync(Oc,JSON.stringify(this.data))}catch(t){var e;null===(e=lg.error)||void 0===e||e.call(lg,Sc,"Save conversation deletion cache fail"),lg.zlog.zsymb(18,"kgZAuO",`${Sc} Save conversation deletion cache fail`)}}),0))}})||mg)||mg)||mg;a.ModuleContainer.registerSingleton(Nn.ConversationDeletionCache,pg);var fg,vg=s("ezRR"),_g=s("3AlX"),bg=s("RoG4"),Ig=s("yXlY"),yg=s("jDFw"),Sg=s("9Cxg"),Cg=s("2gQH"),Eg=s("JsDs"),Og=s("UQla"),Mg=s("vDlm"),Tg=s("k5QF"),Rg=s("1FaF"),wg=s("V0Mo");let Lg;Ee.l||(Lg=s("Dprd").default);let Dg=Object(vg.c)()(fg=Object(a.injectable)()(fg=function(e,t){return Object(a.inject)(Nn.ConvInfoDataManager)(e,void 0,0)}(fg=function(e,t){return Object(a.inject)(Nn.PreviewDataManager)(e,void 0,1)}(fg=function(e,t){return Object(a.inject)(Nn.ConversationOperation)(e,void 0,2)}(fg=function(e,t){return Object(a.inject)(Nn.ConversationDeletionCache)(e,void 0,3)}(fg=Reflect.metadata("design:type",Function)(fg=Reflect.metadata("design:paramtypes",[void 0===Nn.ConvInfoDataManager?Object:Nn.ConvInfoDataManager,void 0===Nn.PreviewDataManager?Object:Nn.PreviewDataManager,void 0===Nn.ConversationOperation?Object:Nn.ConversationOperation,void 0===Nn.ConversationDeletionCache?Object:Nn.ConversationDeletionCache])(fg=class extends vg.b{constructor(e,t,s,a){super(),this.convInfoDataManager=e,this.previewDataManager=t,this.conversationOperation=s,this.conversationDeletionCache=a,this.database=void 0,this.deleteMediaManager=void 0,this.database=Xt.default.getInstance(),this.deleteMediaManager=new Ig.a}start(){this.addEventListeners()}running(){const e=()=>{Kh.b.key("enable").boolean&&this.conversationDeletionCache.init((()=>{this.conversationDeletionCache.getDeletedConversations().forEach((e=>{vo.d.setDeleteConversation(e)}))}))};e();const t=()=>{e(),Kh.b.remove(t)};Kh.b.add(t)}getConversationResources(e){return new Promise((async(t,s)=>{try{var i;if(!Kh.b.isStaging)return t(void 0);const s={},n=await this.convInfoDataManager.getConvById(e),r=await this.previewDataManager.getPreviewById(e);s.convInfo=n,s.previewInfo=r;const o=a.ModuleContainer.resolve(Nn.PinDataManager).isPinned(e);s.isPinned=o;const c={from:[e,"",""],to:[e,(null==r?void 0:r.messageTime)||"",(null==r?void 0:r.msgId)||""],excludeFrom:!1,excludeTo:!1},l={index:"userId_sendDttm_msgId",direction:O.c.PREV,partition:e,useLGKeyRange:!0},d=await this.database.Core.Message.getAll(c,l);s.msgNum=d.length,s.messageTypes={},s.media={};let u=0,h=0,g=0,m=0,p=0,f=0,v=0,_=0;for(let e=0;e<d.length;e++){d[e].staredDttm&&u++;const t=parseInt(d[e].msgId);if(!isNaN(t)){await this.database.Core.Mention.get(t)&&h++}d[e].msgType===Y.MSG_FILE&&g++,d[e].msgType!==Y.MSG_PHOTO&&d[e].msgType!==Y.MSG_PHOTO_2&&d[e].msgType!==Y.MSG_DOODLE||m++,d[e].msgType===Y.MSG_GIF&&p++,d[e].msgType===Y.MSG_VIDEO&&f++,d[e].msgType===Y.MSG_CONTACT&&"object"==typeof d[e].message&&"recommened.link"===d[e].message.action&&v++,d[e].msgType===Y.MSG_VOICE&&_++}s.starMsgNum=u,s.mentionMsgNum=h,s.messageTypes.fileMsgNum=g,s.messageTypes.imageMsgNum=m,s.messageTypes.gifMsgNum=p,s.messageTypes.videoMsgNum=f,s.messageTypes.linkMsgNum=v,s.messageTypes.audioMsgNum=_;const b=Dc.a.getInstance(),I=await b.getMessageOfConversation([],e);if(s.searchMsgNum=I.len||0,Ce.default.change_media_db.should_use_new_media_db_flow){const t={from:[e,"",""],to:[e,"",""],excludeFrom:!1,excludeTo:!1},a={index:"convId_sendDttm_cliMsgId",direction:O.c.PREV,partition:e},i=await this.database.Media.File.getAllKey(t,a),n=await this.database.Media.Image.getAllKey(t,a),r=await this.database.Media.Link.getAllKey(t,a);s.media.fileMsgNum=i.length,s.media.imageAndVideoMsgNum=n.length,s.media.linkMsgNum=r.length}else{const t={from:[e,"",""],to:[e,"",""],excludeFrom:!1,excludeTo:!1},a={index:"userId_sendDttm_msgId",direction:O.c.PREV,partition:e},i=await this.database.Core.File.getAllKey(t,a),n=await this.database.Core.Image.getAllKey(t,a),r=await this.database.Core.Link.getAllKey(t,a);s.media.fileMsgNum=i.length,s.media.imageAndVideoMsgNum=n.length,s.media.linkMsgNum=r.length}null===(i=lg.info)||void 0===i||i.call(lg,yc,`${e} Conversation resources`,s),t(s)}catch(r){var n;null===(n=lg.error)||void 0===n||n.call(lg,yc,`${e} Error when getting conversation resources`,r),s(r)}}))}addEventListeners(){this.conversationOperation.addEventListener(Zh.c.BeforeDeleteConversation,(e=>{var t,s,a,i;const n=null===(t=e.payload)||void 0===t?void 0:t.data;if(!n)return;const r=null===(s=e.payload)||void 0===s||null===(a=s.data)||void 0===a?void 0:a.convId;r&&yg.a.clearCache(r);const o={msgId:n.msgId,conversationId:n.convId,isLeaveGroup:n.isLeaveGroup,deleteAllPrior:!0,sendDttm:n.deleteTime,clientMsgId:n.cliMsgId,fromUid:n.fromUid};vo.d.setDeleteConversation(o),null===(i=lo.b.messageCache)||void 0===i||i.deleteMessageBefore(o)})),this.conversationOperation.addEventListener(Zh.c.AfterDeleteConversation,(e=>{var t;const s=null===(t=e.payload)||void 0===t?void 0:t.data;if(s&&(s.convId&&(a.ModuleContainer.resolve(Nn.PinDataManager).isPinned(s.convId)&&a.ModuleContainer.resolve(Nn.PinDataManager).unpin([s.convId]),Ee.l||a.ModuleContainer.resolve(an.b).removeConvToList(s.convId)),this.deleteConversationInMediaStore(s),s.isLeaveGroup)){jo.b.getInstance().removeCloudSegmentByConvId(s.convId)}})),this.conversationOperation.addEventListener(Zh.c.BeforeDeleteBatchMessages,(e=>{})),this.conversationOperation.addEventListener(Zh.c.AfterDeleteBatchMessages,(e=>{var t,s;const a=null===(t=e.payload)||void 0===t?void 0:t.data,i=null===(s=e.payload)||void 0===s?void 0:s.messages;a&&a.convId&&i&&this.cleanResourcesOfMessages(a.convId,i,a.isDeleteResource)})),this.conversationOperation.addEventListener(Zh.c.BeforeDeleteMessage,(e=>{var t,s;const a=null===(t=e.payload)||void 0===t?void 0:t.data,i=null===(s=e.payload)||void 0===s?void 0:s.messages;if(!a||!a.convId||!i)return;yg.a.clearCache(a.convId);const n=wg.b.getZQuoteBannerDataById(a.convId);i.forEach((e=>{var t,s;n&&null!==(t=n.quote)&&void 0!==t&&t.msgId&&n.quote.msgId===e.msgId&&(null===(s=n._clear)||void 0===s||s.call(n));const i={msgId:e.msgId,conversationId:a.convId,isLeaveGroup:a.isLeaveGroup,deleteAllPrior:!0,sendDttm:a.deleteTime,clientMsgId:e.cliMsgId,fromUid:e.fromUid,toUid:e.toUid};switch(a.type){case"only-me":vo.d.setDeleteMessage(i);break;case"everyone":vo.d.setDeleteEveryoneCache(i);break;case"recall":vo.d.setRecallMessage(i)}}))})),this.conversationOperation.addEventListener(Zh.c.AfterDeleteMessage,(e=>{var t,s;const a=null===(t=e.payload)||void 0===t?void 0:t.data,i=null===(s=e.payload)||void 0===s?void 0:s.messages;a&&a.convId&&i&&(this.cleanResourcesOfMessages(a.convId,i,a.isDeleteResource),this.deleteMessageInMediaStore(a.convId,i),this.cleanReplyMessages(a,i),a.convId&&a.msgId)})),this.conversationOperation.addEventListener(Zh.c.NotFoundMessage,(e=>{var t,s;const a=null===(t=e.payload)||void 0===t?void 0:t.data,i=null===(s=e.payload)||void 0===s?void 0:s.messages;a&&a.convId&&i&&this.cleanReplyMessages(a,i)}))}cleanResourcesOfMessages(e,t,s){var i;if(!t.length)return;const n=`${e} Clean resources of messages ${t.length}`;null===(i=lg.info)||void 0===i||i.call(lg,yc,n),lg.zlog.zsymb(0,"8uYojo",n);const r={ids:[],pendingIds:[]},o=[],c=[],l=[];t.forEach((t=>{var i;s&&this.deleteMediaManager.deleteLocalRes(t),!Ee.l&&tt.default.abortByMsg(Object(I.a)({},t)),null===(i=Re.default.cbMessageToMsgThread)||void 0===i||i.call(Re.default,"delete",t);let n=t.msgType;if(n=Object(Mg.a)(n,t),Og.c.includes(n)){const e=Object(Mg.b)(t);o.push(e)}if(t&&t.status===Y.MSG_LOCAL&&t.cliMsgId){var d,u;const s={code:_g.a.DeleteConversationHasSendingMsg,message:"Delete conversation has sending message"},i=_g.b.cancel(+t.cliMsgId,s);J.p.setDeleteSendingMsg(t.cliMsgId),i||t.msgType!==Y.MSG_FILE||(J.p.setHasCancelledSending(t.cliMsgId),vl.b.cancelUpload(t.cliMsgId)),null===(d=a.ModuleContainer.resolve(Tg.a))||void 0===d||null===(u=d.getChatBoxControllerByConvId(e))||void 0===u||u.functionSendingFile(e,{act:Rg.b.Cancel,clientId:`${t.cliMsgId}`})}if(t.msgType===Y.MSG_FILE&&t.message&&t.message.href){var h,g;const e=null===(h=Lg)||void 0===h?void 0:h.getDownloadKey(t);null===(g=Lg)||void 0===g||g.cancelDownload(e)}if(t.staredDttm){const e=Re.default.getTsStarMsgSchemaChanged();t.staredDttm&&t.staredDttm>=e?r.ids.push(t.msgId):r.pendingIds.push(t.msgId)}t&&t.msgType==Y.MSG_ZINSTANT&&bg.b.removeFileFromMessage(t,Re.default.getUserId()),c.push(t.msgId);const m=parseInt(t.sendDttm);l.push(m)}));Dc.a.getInstance().deleteMessages(t),o.length>0&&this.database.Res.Meta.deleteMulti(o),Cg.a.increaseNumberOfMessages(-t.length);const d=this.database.Core.Mention;c.length>0&&d.deleteMulti(c);const u=this.database.Core.Notifications;l.length>0&&u.deleteMulti(l),rh.b.deleteReactions(t.map((e=>e.msgId)));const h=this.database.Core.StarMessage;r.pendingIds.forEach((async(e,t)=>{try{await h.get(e)||(r.pendingIds[t]=parseInt(e))}catch(s){}})),h.deleteMulti([...r.ids,...r.pendingIds],{partition:e})}deleteConversationInMediaStore(e){var t;if(!e.convId){var s;const e=new $h({code:"RESOURCE_ERROR",message:"Delete conversation media store failed: conversationId is not provided"});return void(null===(s=lg.error)||void 0===s||s.call(lg,yc,e))}const i=this.canDeleteMediaStore(e.convId),n=`${e.convId} Delete conversation media store ${Ce.default.change_media_db.should_use_new_media_db_flow} ${i}`;if(null===(t=lg.info)||void 0===t||t.call(lg,yc,n),lg.zlog.zsymb(0,"xa9Z-M",n),i)if(Ce.default.change_media_db.should_use_new_media_db_flow){a.ModuleContainer.resolve(we.a).emptyMediaStores(e.convId,["image","file","link"])}else Eg.a.runCleanUpMedia({conversationId:e.convId,msgId:e.msgId,sendDttm:e.deleteTime,clientMsgId:e.cliMsgId,ignoreDeleteRes:!0},"del-conv")}deleteMessageInMediaStore(e,t){var s;const i=this.canDeleteMediaStore(e),n=`Delete message media store ${Ce.default.change_media_db.should_use_new_media_db_flow} ${i}`;if(null===(s=lg.info)||void 0===s||s.call(lg,yc,n),lg.zlog.zsymb(0,"ezauf8",n),!i)return;const r=[],o=[],c=[];for(const a of t)Object(Sg.isPhotoOrVideoMessage)(a)&&r.push(a),Object(Sg.isFileMessage)(a)&&o.push(a),Object(Sg.isLinkMessage)(a)&&c.push(a);if(Ce.default.change_media_db.should_use_new_media_db_flow){const e=(e,t)=>{const s={};for(const a of t)if(a.toUid){const e=a.toUid;s[e]||(s[e]=[]),s[e].push({newId:`${a.cliMsgId}_${a.fromUid}_${e}`,oldId:a.msgId})}for(const n in s){var i;null===(i=a.ModuleContainer.resolve(we.a))||void 0===i||i.deleteMediasById(e,n,s[n])}};o.length>0&&e("file",o),r.length>0&&e("image",r),c.length>0&&e("link",c)}else o.length>0&&this.database.Core.File.deleteMulti(o.map((e=>e.msgId))),r.length>0&&this.database.Core.Image.deleteMulti(r.map((e=>e.msgId))),c.length>0&&this.database.Core.Link.deleteMulti(c.map((e=>e.msgId)))}async cleanReplyMessages(e,t){if("only-me"===e.type)return;const s=Re.default.getUserId(),a=[],i=[];for(const n of t){const t={index:"userId_sendDttm_msgId",limit:500,direction:O.c.NEXT,predicate:e=>og(s,e,n),partition:e.convId,useLGKeyRange:!0},i={from:[e.convId+"",n.sendDttm+"",n.msgId+""],to:[e.convId+"",Ec,Cc],excludeFrom:!1,excludeTo:!1},r=await this.database.Core.Message.getAll(i,t);a.push(...r)}if(a.length){for(let t=0;t<a.length;t++){const s=a[t];s.quote&&("everyone"===e.type?(s.quote.cliMsgType=Y.MSG_DEL_EVERYONE,s.quote.msg="[Tin nhắn đã bị xóa]"):"recall"===e.type&&(s.quote.cliMsgType=Y.MSG_UNDO,s.quote.msg="[Tin nhắn đã được thu hồi]"),i.push(s),J.p.dispatch({type:ve.ChatBoxActions.UPDATE_MSG_CONTENT,payload:{message:s,conversation:{userId:e.convId}}}))}i.length&&await this.database.Core.Message.insertMulti(i,{replace:!0})}}canDeleteMediaStore(e){return!ag(e)||!Ce.default.media_settings.media_cloud}})||fg)||fg)||fg)||fg)||fg)||fg)||fg)||fg;a.ModuleContainer.registerSingleton(Nn.ConversationResources,Dg),a.ModuleContainer.registerSingleton(Nd.b,Bd),a.ModuleContainer.registerSingleton(uu.b,yu),a.ModuleContainer.registerSingleton(Nd.a,jd),a.ModuleContainer.registerSingleton(Pd.a,class{constructor(){this.name=void 0,this.key=void 0,this.dependencies={},this.name="conv-notification-controller",this.key=this.name,this.dependencies=new Proxy({},{get:async(e,t)=>e[t]?await e[t]():Promise.resolve(void 0),set:(e,t,s)=>(e[t]=s,!0)}),this._registerResolvers({friendsManager:()=>Promise.resolve().then(s.bind(null,"UiPd")).then((e=>e.default)),convListUtils:()=>Promise.resolve().then(s.bind(null,"RojW")).then((e=>e.ConvList)),convListController:()=>Promise.resolve(a.ModuleContainer.resolve(ii.b))})}async checkIfConvCanNotify(e,t){try{return await this._checkIfConvCanNotify(e,t)}catch(s){return!1}}registerResolvers(e){return this._registerResolvers(e)}async _checkIfConvCanNotify(e,t){if(Object(Cu.a)(e))return!0;let s=await this._getModule("friendsManager",t);if(await s.isOA(e)){let s=await this._getModule("convListUtils",t);if(!(await s.checkIfOAShouldShowInConvList(e))){return!!(await this._getModule("convListController",t)).isChatVisible(e)}return!0}return!0}async _getModule(e,t){return t&&t[e]?await t[e]():await this.dependencies[e]}_registerResolvers(e){for(const[t,s]of Object.entries(e))this.dependencies[t]=s}}),a.ModuleContainer.registerSingleton(Ou.a,Eu);var Ag,Fg=s("Xvw2"),kg=s("5uwv"),Ng=s("lCn6"),Pg=s("kg13"),jg=s("dJFb");const Ug=2,Bg={userId:"",friendRequestType:Ug,friendRequestSource:85};var zg=function(e){return e.SUGGEST="suggest",e.REQUEST="request",e.UNREADREQ="unread-req",e}(zg||{});Object(xi.b)(Fg.b)(Ag=Reflect.metadata("design:type",Function)(Ag=Reflect.metadata("design:paramtypes",[])(Ag=class extends hs.b{constructor(){super(),this.sugguestList=void 0,this.requestList=void 0,this.unreadFRList=void 0,this._ebFriendRequestSend=e=>{const t=this.unreadFRList.filter((t=>t!==e));t.length!==this.unreadFRList.length&&(Re.default.changeFriendsToStranger(e),ui.default.logCoreError("[reddot-check] SEND_FRIEND_REQUEST: "+JSON.stringify(e)),this.unreadFRList=t,Object(nc.i)(this.name,zg.UNREADREQ))},this._ebFriendFetch=e=>{for(let t in e)if(e.hasOwnProperty(t)){const e=this.requestList.slice();for(let s=0;s<e.length;s++)if(e[s]===t){e.splice(s,1);break}e.length!==this.requestList.length&&(this.requestList=e,Object(nc.i)(this.name,zg.REQUEST))}},this._ebFrReqFetch=e=>{ui.default.log("friendNotificationAction: friend requests fetched",e);const t=this.requestList.reduce(((e,t)=>(e[t]||(e[t]=!0),e)),{}),s=this.requestList.slice();for(let a of e)t[a.userId]||s.unshift(a);this.requestList=s,Object(nc.i)(this.name,zg.REQUEST)},this._ebFrReqRemove=e=>{ui.default.log("friendNotificationAction: friend requests removed",e);const t=this.requestList.filter((t=>-1===e.indexOf(t)));t.length!==this.requestList.length&&(this.requestList=t,Object(nc.i)(this.name,zg.REQUEST)),this.onFriendListNotificationsChange({action:"remove",ids:e})},this.name=Fg.a,this.data=new Map,this.key="userId",this.sugguestList=[],this.requestList=[],this.unreadFRList=[],this.listenEvents()}listenEvents(){_e.default.subscribe(((e,t)=>{switch(e){case ve.ChatBoxActions.SEND_FRIEND_REQUEST:this._ebFriendRequestSend(t);break;case ve.FetchActions.FRIENDS_FETCHED:this._ebFriendFetch(t);break;case ve.FetchActions.FRIEND_REQUESTS_FETCHED:this._ebFrReqFetch(t);break;case ve.FetchActions.FRIEND_REQUESTS_REMOVED:this._ebFrReqRemove(t)}}))}onAddFriend(e){Pg.a.removeSuggest(e.userId),this.onFriendListNotificationsChange({action:"remove",ids:[e.userId]})}onReceiveFriendRequests(e){if(!e||e.length<1)return;for(let s=0;s<e.length;s++){let t=e[s];t&&Pg.a.removeSuggest(t.userId)}jg.d.setUnreadRequest(1);for(let s=0;s<e.length;s++)e[s]&&J.p.addNewFriendItem(e[s].userId);me.a.UnreadDataManager.updateUnreadCount(Y.FAKE_CONVERSATION_ID.FRIEND_CENTER,jg.d.getUnreadRequest());let t=e.map((e=>({dataInfo:Object(I.a)(Object(I.a)({},e),{},{recommInfo:{message:e.friendRequestMsg,source:e.friendRequestSource},recommType:Ug}),recommItemType:e.friendRequestType})));Pg.a.addRequest(t),this.broadcastEvent(kg.b.ReceiveRequest,"",{uids:e.map((e=>e.userId))})}onRemoveSuggest(e,t,s){return Pg.a.removeSuggestFriend(e,t,s).then((t=>{this.broadcastEvent(kg.b.RemoveSuggest,e)}))}onPromoteFriends(){me.a.UnreadDataManager.updateUnreadCount(Y.FAKE_CONVERSATION_ID.FRIEND_CENTER,1)}onFriendRequestFetched(){}onFriendListNotificationsChange(e){if(!e.ids||!e.ids.length)return void("clear"===e.action&&(this.unreadFRList=[],Object(nc.i)(this.name,zg.UNREADREQ)));let t=this.unreadFRList;if("remove"===e.action)t=t.filter((t=>-1===e.ids.indexOf(t)));else if("add"===e.action){const s=[];for(let a of e.ids)-1===t.indexOf(a)&&s.push(a);s.length&&(t=t.concat(s))}t.length!==this.unreadFRList.length&&(this.unreadFRList=t,Object(nc.i)(this.name,zg.UNREADREQ))}acceptFriendRequest(e,t=Ar.c){return new Promise(((s,a)=>{const i=this.data.get(e);if(!i)return ye.a.acceptAddFriend(e,t).then((a=>{Ie.ModalManagerV2.openModal({windowId:t,name:Y.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch(a);let n;if(i.friendRequestType===Y.FRIEND_REQUEST_TYPE_SUGGEST){if(i.requested)return n=104097,Ia.default.logAction(n),s(!1);const r=ce.a.trans("STR_MSG_DEFAULT_REQ_ADD_FR",Ii.default.getMiniProfileMe().zaloName);ye.a.requestAddFriend(e,r,i.friendRequestSource,t).then((()=>{Ie.ModalManagerV2.openModal({windowId:t,name:Y.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),Re.default.changeFriendsToStranger(e),Pg.a.removeSuggest(e);const a=Object(I.a)(Object(I.a)({},i),{},{requested:!0});this.broadcastEvent(kg.b.SentFriendReq,e),this.data.set(e,a),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),a(e)})),n=104096}else ye.a.acceptAddFriend(e,t).then((()=>{this.data.delete(e),Object(nc.f)(this.name,e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),this.broadcastEvent(kg.b.AcceptRequest,e),Ng.a.getUser(e).then((t=>{_e.default.send(ve.FetchActions.FRIENDS_FETCHED,{[e]:Object(I.a)(Object(I.a)({},ui.default.reformatConversationFromFriend(t)),{},{isFr:1})})})),Re.default.getAcceptNewFriend(i),Ie.ModalManagerV2.openModal({windowId:t,name:Y.ModalIdentitiesDefine.BLOCK_STORIES,params:{userId:e,windowId:t}}),s(!0)})).catch((e=>{this.handleFailureFriendRq(e),a(e)})),n=104095;n&&Ia.default.logAction(n)}))}async rejectFriendRequest(e){const t=this.data.get(e),s=()=>{mc.default.createSuccess(ce.a.str("STR_TOAST_REJECT_REQUEST")),Re.default.changeFriendsToStranger(e),Pg.a.removeSuggest(e),this.broadcastEvent(kg.b.RejectRequest,e)},a=e=>{ui.default.logCoreError(e),e&&e.error_message&&mc.default.createError(e.error_message)};t&&t.friendRequestSource?qc.default.removeRecommendedFriend(e,t.friendRequestSource).then(s).catch(a):ye.a.rejectRequestAddFriend(e).then(s).catch(a),this.data.delete(e),this.onFriendListNotificationsChange({action:"remove",ids:[e]}),Ia.default.logAction(104094)}undoRequestFriend(e){e&&ye.a.undoRequestAddFriend(e).catch((e=>{e.error_message&&mc.default.createError(e.error_message)}))}clearUnreadFriendRequest(){me.a.UnreadDataManager.updateUnreadCount(Y.FAKE_CONVERSATION_ID.FRIEND_CENTER,0),this.unreadFRList=[],Object(nc.i)(this.name,zg.UNREADREQ)}getAllFriendRequests(){return new Promise(((e,t)=>{const s=Pg.a.getRecommendedFriendsV2(!1,!1);if(!s)return e({});e(this.filterFriendRequest(s))}))}getAllFriendRequestsSync(){const e=Pg.a.getRecommendedFriendsSync();return e?this.filterFriendRequest(e):{}}init(){Re.default.getFriends(null,!0).then((e=>{if(e){const t=Re.default.getLastContactListOpenTime(),s=e.filter((e=>e&&e.friendRequestFetchTime>t)).map((e=>e.userId));s.length&&this.onFriendListNotificationsChange({action:"add",ids:s})}}))}getItem(e){return Bg}getList(e){return e.key===zg.UNREADREQ?this.unreadFRList:[]}onGetItemFailure(e){}onGetListFailure(e){}handleFailureFriendRq(e){if(ui.default.logCoreError(e),e&&e.error_message){let t=e.error_message;[224,251].includes(e.error_code)&&(t=ce.a.trans(`STR_FRIEND_REQUEST_FAIL_${e.error_code}`,[""+Ce.default.limitFriends])),mc.default.createMessage(t,3e3)}}filterFriendRequest(e){const t={};for(let s in e)if(e.hasOwnProperty(s)){let a=e[s];a&&a.dataInfo.recommType===Ug&&(t[s]=a,t[s].friendRequestType=a.dataInfo.recommType)}return t}broadcastEvent(e,t,s){this.dispatchEvent(new kg.a(e,t,s)),this.dispatchEvent(new kg.a(kg.b.FriendCenterChange,t,Object(I.a)(Object(I.a)({},s),{},{act:e})))}})||Ag)||Ag);const Gg=Object(a.define)("cloud-segment-repository"),xg=Object(a.define)("cloud-segment-manager"),Vg=Object(a.define)("cloud-message-manager");class Hg{constructor(e){this.entity=e}get conversationId(){return this.entity.conversationId}get cloudFirstSmsLocalId(){return this.entity.cloudFirstSmsLocalId}get cloudSegmentCheck(){return this.entity.cloudSegmentCheck}get hasMore(){return this.entity.hasMore}get lastCloudVerifiedDttm(){return this.entity.lastCloudVerifiedDttm}get lastDeletedMsgID(){return this.entity.lastDeletedMsgID}get lastGetMaxRecentTs(){return this.entity.lastGetMaxRecentTs}get maxCloudMsgId(){return this.entity.maxCloudMsgId}}var Wg;let qg=a.ModuleContainer.injectable()(Wg=Reflect.metadata("design:type",Function)(Wg=Reflect.metadata("design:paramtypes",[])(Wg=class{constructor(){}get(e){return zo.a.getSegmentByConvId(e)}})||Wg)||Wg)||Wg;var Kg,Zg=s("D8Ji");let $g=a.ModuleContainer.injectable()(Kg=function(e,t){return a.ModuleContainer.inject(Gg)(e,void 0,0)}(Kg=Reflect.metadata("design:type",Function)(Kg=Reflect.metadata("design:paramtypes",[void 0===Gg?Object:Gg])(Kg=class{constructor(e){this.segmentRepository=e}get(e){return this.segmentRepository.get(e).then((e=>e&&new Hg(e))).catch((e=>{}))}async createOrExtendSegment(e,t){const s=await this.segmentRepository.get(e);s.cloudSegmentCheck=Zg.a.mergeNewSegment(t.verifiedRange,null==s?void 0:s.cloudSegmentCheck),s.maxCloudMsgId=Math.max(s.maxCloudMsgId||0,t.verifiedRange[1]),zo.a.setSegmentCacheByConvId(e,s),await Bo.b.updateSegmentDB(e,s)}})||Kg)||Kg)||Kg)||Kg;class Qg extends Error{constructor(e,t,s){super(s),this.code=e,this.data=t}}var Yg;let Jg=a.ModuleContainer.injectable()(Yg=function(e,t){return a.ModuleContainer.inject(Yl.a)(e,void 0,0)}(Yg=Reflect.metadata("design:type",Function)(Yg=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a])(Yg=class{constructor(e){this.config=e}get settings(){return this.config.get("cloud.auto_download")}async crawlMissingMessage(e,t={nRetry:0,count:50}){let s=e.conversationId;s.startsWith("g")&&(s=s.slice(1));const a=`${s}_${e.requestMsgId}`;let i=this.settings.limit.minMsgDttm,n=this.settings.limit.maxMsgFirstSegment;const r={groupId:s,fromMsgId:e.requestMsgId,globalMsgIds:e.globalMsgIds,curTotalMsgs:e.curTotalMsgs,tsJoinGroup:e.tsJoinGroup,minMsgTs:i,maxTotalSyncMsg:n};return await So.default.crawlMissingMessage(a,r,{requestTimeout:this.settings.fetching.timeout,count:t.count,nRetry:t.nRetry,usePostApi:!0}).then((e=>Object(Co.a)(e))).then((e=>{try{return JSON.parse(e)}catch(t){throw{error_code:-1,error_message:"invalid response"}}})).then((e=>{const t=e[s];if(t.error>0)throw{error_code:t.error,error_message:"inner error"};return t})).catch((e=>{if("number"==typeof e.error_code){let s=e.data;try{s=JSON.parse(s)}catch(t){}throw new Qg(e.error_code,s,e.error_message)}throw e}))}})||Yg)||Yg)||Yg)||Yg;var Xg,em=s("yEZN"),tm=s("EO3V"),sm=s("enz2");const am={totalMsgCount:0,fetchedMsgCount:0,serverMsgCount:0,newMsgCount:0,phaseDone:!1,isFilteredByTimeJoin:!1,done:!0,tsJoinGroup:"0"};let im=a.ModuleContainer.injectable()(Xg=function(e,t){return a.ModuleContainer.injectToken(Jg)(e,void 0,0)}(Xg=function(e,t){return a.ModuleContainer.inject(xg)(e,void 0,1)}(Xg=function(e,t){return a.ModuleContainer.inject(em.c)(e,void 0,2)}(Xg=function(e,t){return a.ModuleContainer.inject(em.b)(e,void 0,3)}(Xg=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,4)}(Xg=Reflect.metadata("design:type",Function)(Xg=Reflect.metadata("design:paramtypes",[void 0===Jg?Object:Jg,void 0===xg?Object:xg,void 0===em.c?Object:em.c,void 0===em.b?Object:em.b,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Xg=class{constructor(e,t,s,a,i){this.api=e,this.segmentManager=t,this.messageRepository=s,this.messageManager=a,this.logger=void 0,this.logger=i.createZLogger("cld-msg",["manager"])}async crawlMissingMessage(e,t,s){const a=await this.segmentManager.get(e),i=(()=>{var e;let t=s.minMsgId&&Number.parseInt(s.minMsgId);return a&&a.lastDeletedMsgID&&(t=t?Math.max(a.lastDeletedMsgID,t):a.lastDeletedMsgID),null===(e=t)||void 0===e?void 0:e.toString()})(),n="0"!==t,r=n?s.count+1:s.count;if(n&&t<=i)return am;const o=await this.messageManager.findPrevMessagesFromMsgId(e,{maxMsgId:"0"!==t?t:void 0,minMsgId:i,limit:r}).then((e=>e.map((e=>e.entity)))),c=new Set;o.forEach((e=>{try{const t=Number.parseInt(e.msgId);Number.isInteger(t)&&c.add(t.toString())}catch(t){}}));const l=Array.from(c.values()),d=await this.api.crawlMissingMessage({conversationId:e,requestMsgId:t,globalMsgIds:l,curTotalMsgs:s.curTotalMsgs,tsJoinGroup:s.tsJoinGroup},{nRetry:s.nRetry,count:s.count});if(0===d.groupMsgs.length&&"0"===d.maxMsgId)return am;let u=tm.a.checkDupMessageFromCloud(e,d.groupMsgs);i&&i>"0"&&(u=u.filter((e=>e.msgId>i)));const h=[...o,...u];if(0===h.length)return am;const g=Number.parseInt(d.lastMsgId,10);let m=Number.parseInt(t);const p=tm.a.findMinMaxGroupMsg(h,m,g,null==a?void 0:a.lastDeletedMsgID),{groupMsgsToView:f,groupMsgsAddDb:v,groupMsgsSearch:_}=sm.a.findMsgsAddDb(t,u,[],o,Object(I.a)({apiType:2,conversationId:e},p));v.forEach((e=>{e.src=Y.MSG_SRC.AUTO_LOADER})),await this.messageRepository.saveMessages(e,v),await sm.a.updateSearchV3(_,e);const b=!!d.isFilteredByPhase,y=d.maxMsgId;p.minMsgId&&p.maxMsgId&&await this.segmentManager.createOrExtendSegment(e,{verifiedRange:[p.minMsgId,p.maxMsgId]});let S="0";Number.isInteger(Number.parseInt(d.tsJoinGroup))?S=d.tsJoinGroup:this.logger.zsymb(18,"ytaK3f",(()=>["api res invalid ts join group",{tsJoinGroup:d.tsJoinGroup}]));const C=!!d.isFilteredByTimeJoin,E={totalMsgCount:f.length,fetchedMsgCount:v.length,serverMsgCount:u.length,newMsgCount:v.length,phaseDone:b,isFilteredByTimeJoin:C,done:!(b||!C&&d.hasMore),minMsgId:i,maxMsgId:y.toString(),tsJoinGroup:S};return this.logger.zsymb(3,"1qBVvW",["[auto-dl-msg] crawl result","egeqXf"],E),E}})||Xg)||Xg)||Xg)||Xg)||Xg)||Xg)||Xg)||Xg;a.ModuleContainer.registerSingleton(Gg,qg),a.ModuleContainer.registerSingleton(xg,$g),a.ModuleContainer.registerSingleton(Vg,im);var nm,rm=s("rfrl"),om=s("KP/S"),cm=s("wiGx"),lm=s("ttnr");const dm={screen:cm.a.Hidden,error:om.c.NO_ERROR,progress:0,totalProgress:0,numOfSyncedConv:0,popupVisible:!1,startSyncTime:0,closing:!1,syncingConversation:null};Object(xi.b)(cm.b)(nm=Reflect.metadata("design:type",Function)(nm=Reflect.metadata("design:paramtypes",[])(nm=class{constructor(){this.progressRecording=void 0,this.downloadBackupTime=void 0,this.state=Object(I.a)({},dm),this.name="sync-message-ui",this.key="window_id",this.progressRecording=new Map,this.initialRecordProgress(),this.downloadBackupTime=null}initialRecordProgress(){this.progressRecording.set(cm.a.DownloadingBackup,0),this.progressRecording.set(cm.a.DecryptingBackup,0),this.progressRecording.set(cm.a.SyncInProgress,0)}recordProgress(e){const t=this.state.screen,s=e=>e>100?100:e;switch(t){case cm.a.DownloadingBackup:this.progressRecording.set(t,s(e));break;case cm.a.DecryptingBackup:this.progressRecording.set(cm.a.DownloadingBackup,100),this.progressRecording.set(t,s(e));break;case cm.a.SyncInProgress:this.progressRecording.set(cm.a.DownloadingBackup,100),this.progressRecording.set(cm.a.DecryptingBackup,100),this.progressRecording.set(t,s(e))}}calculateTotalProgressTransfer(){const e=this.state.screen,t=this.progressRecording.get(cm.a.DownloadingBackup)||0,s=this.progressRecording.get(cm.a.DecryptingBackup)||0,a=this.progressRecording.get(cm.a.SyncInProgress)||0,i=(e,t)=>{let s=0;switch(t){case cm.a.DownloadingBackup:s=lm.a.getPercentDownload();break;case cm.a.DecryptingBackup:s=lm.a.getPercentDecrypt();break;case cm.a.SyncInProgress:s=lm.a.getPercentRestore()}return Math.round(e*s/100)};switch(e){case cm.a.DownloadingBackup:return i(t,e);case cm.a.DecryptingBackup:return i(t,cm.a.DownloadingBackup)+i(s,e);case cm.a.SyncInProgress:return i(t,cm.a.DownloadingBackup)+i(s,cm.a.DecryptingBackup)+i(a,e);default:return 0}}showPopup(){this.setState((e=>{e.popupVisible=!0}))}setSyncingConversation(e){this.setState((t=>{t.syncingConversation=e}))}hidePopup(){this.setState((e=>{e.popupVisible=!1}))}hideAllUI(){this.setState((e=>{e.screen=cm.a.Hidden,e.closing=!1}))}showError(e){this.setState((t=>{t.error=e,t.screen=cm.a.Error,t.syncingConversation=null}))}showSuggestNewSync(e){this.setState((t=>{t.screen=cm.a.SuggestNewSync,t.popupVisible=e}))}showSuggestResume(){this.setState((e=>{e.screen=cm.a.SuggestResume,e.popupVisible=!1}))}showSyncGuide(){this.setState((e=>{e.screen=cm.a.SyncGuide,e.popupVisible=!0}))}showWaitForBackup(){this.setState((e=>{e.screen=cm.a.WaitForBackup}))}showMobileIdleInBackup(){this.setState((e=>{e.screen=cm.a.MobileIdleInBackup}))}showDownloadingBackup(){this.setDownloadBackupTime(performance.now()),this.setState((e=>{e.screen=cm.a.DownloadingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showDecryptingBackup(){this.setState((e=>{e.screen=cm.a.DecryptingBackup,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showInProgress(){this.setState((e=>{e.screen=cm.a.SyncInProgress,e.progress=0,e.totalProgress=this.calculateTotalProgressTransfer()}))}showCloseNotice(){this.setState((e=>{e.closing=!0}))}showSuccessMessage(){this.setState((e=>{e.screen=cm.a.SyncSuccess,e.syncingConversation=null}))}showWaitForNetwork(){this.setState((e=>{e.screen=cm.a.WaitForNetwork}))}setProgress(e){this.recordProgress(e),this.setState((t=>{t.progress=e,t.totalProgress=this.calculateTotalProgressTransfer()}))}setNumOfSyncedConv(e){this.setState((t=>{t.numOfSyncedConv=e}))}resetStartSyncTime(){this.setState((e=>{e.startSyncTime=Date.now()}))}clearError(){this.setState((e=>{e.error=om.c.NO_ERROR}))}getStartSyncTime(){return this.state.startSyncTime}getCurrentError(){return this.state.error}getCurrentScreen(){return this.state.screen}getPopupVisible(){return this.state.popupVisible}setDownloadBackupTime(e){this.downloadBackupTime=e}getDownloadBackupTime(){return this.downloadBackupTime}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(rm.a)(this.state,e);this.state!==t&&(this.state=t,Object(nc.h)(this.name,"current"))}})||nm)||nm);class um{constructor(e,t,s){this._issuedAt=void 0,this._ttl=void 0,this._publicKey=void 0,this._privateKey=void 0,this._publicKey=e,this._privateKey=t,this._ttl=s,this._issuedAt=Date.now()}get valid(){return Date.now()-this._issuedAt<this._ttl}get publicKey(){return this._publicKey}get privateKey(){return this._privateKey}}const hm=Object(a.define)("sync-message-key-generator");var gm;const mm=$znode.crypto;let pm=a.ModuleContainer.injectable()(gm=class{generate(){return this.generateKey()}decryptKey(e,t,s){return mm.privateDecrypt(s.privateKey,mm.constants.RSA_PKCS1_PADDING,e,{input:"base64",output:t})}generateKey(){const e=mm.generateKeyPairSync("rsa",{modulusLength:2048,publicKeyEncoding:{type:"spki",format:"der"},privateKeyEncoding:{type:"pkcs1",format:"pem"}},{publicKey:"base64",privateKey:""}),t=Ce.default.cross_setting.timeoutKey*Y.ONE_HOUR_MS;return new um(e.publicKey,e.privateKey,t)}})||gm;a.ModuleContainer.registerSingleton(hm,pm);const fm=Object(a.define)("ui-helper");a.ModuleContainer.register(fm,class{async showUserConfirm(e={}){return new Promise((t=>{let s=e.message;"string"==typeof s&&(s=ce.a.trans(s)),J.p.dispatch({type:ve.PopupActions.TOGGLE_CONFIRM,payload:{headerText:ce.a.trans(e.header||"STR_ZALO_CONFIRM"),callback:(e,s)=>{const a=!!s&&s.dontAskAgain;t([e,a])},buttons:{confirm:e.confirm&&ce.a.trans(e.confirm),cancel:e.cancel&&ce.a.trans(e.cancel),type:e.primaryButtonType||"primary"},message:s,usePrimaryForConfirm:!1,width:e.width||450,options:e.remember?[{title:e.remember,key:"dontAskAgain"}]:[]}})}))}async showUserConfirmV2(e={}){return new Promise((t=>{pc.ConfirmManagerV2.openConfirm({windowId:e.windowId||Ar.c,name:Y.MODAL_CONFIRM.confirmIdentities,params:{title:ce.a.str(e.header||"STR_CONFIRM"),message:ce.a.str(e.message||""),okText:ce.a.str(e.confirm||"STR_OK"),cancelText:ce.a.str(e.cancel||"STR_CANCEL"),okType:e.primaryButtonType,width:e.width,onOk:()=>{t(!0)},onCancel:()=>{t(!1)}}})}))}closeUserCOnfrimV2(e){pc.ConfirmManagerV2.isVisible({windowId:(null==e?void 0:e.windowId)||Ar.c,name:Y.MODAL_CONFIRM.confirmIdentities})&&pc.ConfirmManagerV2.closeConfirm({windowId:(null==e?void 0:e.windowId)||Ar.c,name:Y.MODAL_CONFIRM.confirmIdentities})}});var vm=s("cPHW");const _m=Object(a.define)("sync-message-service");var bm=s("BOd8"),Im=s("lgMn"),ym=s("qKtC"),Sm=s("FQFD"),Cm=s("+Mel");let Em=function(e){return e[e.RESTORE_CONVERSATIONS=0]="RESTORE_CONVERSATIONS",e[e.RESTORE_MESSAGES=1]="RESTORE_MESSAGES",e[e.UPDATE_MESSAGES_CACHE=2]="UPDATE_MESSAGES_CACHE",e}({});const Om=Object(a.define)("sync-message-storage");class Mm{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("SyncStorage already initialized");this.key="sync_cross_state"}read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=s.getItemForCurrentUser(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItemForCurrentUser(e)}return null}write(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void a.setItemForCurrentUser(e,JSON.stringify({version:t,value:s}));this.remove(e)}remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,t.removeItemForCurrentUser(e)}}class Tm{constructor(e){this.adapter=e,this._state=void 0}get step(){if(!this._state)throw new Error("SyncStateStore not initialized");return this._state.step}get isStarted(){return!!this._state&&this._state.started}get isSyncing(){return!!this._state&&this._state.isSyncing}set isSyncing(e){if(!this._state)throw new Error("SyncStateStore not initialized");this._state=Object(I.a)(Object(I.a)({},this._state),{},{isSyncing:e}),this.save()}get checkpoint(){if(!this._state)throw new Error("SyncStateStore not initialized");if(!this._state.checkpoint)throw new Error("Reset checkpoint before using");return this._state.checkpoint}set checkpoint(e){if(!this._state)throw new Error("SyncStateStore not initialized");if(!e)throw new Error("checkpoint should not be null");this._state=Object(I.a)(Object(I.a)({},this._state),{},{checkpoint:e}),this.save()}load(){this._state=this.adapter.read("sync-state",1)}resetCheckpoint(e,t,s){if(!this._state)throw new Error("SyncStateStore not initialized");if(0===e)this._state=Object(I.a)(Object(I.a)({},this._state),{},{checkpoint:{format:0,syncedConversations:0,updatedConversation:0,importedMessages:0,syncedMessages:0,minSeq:t,maxSeq:s,currentSeq:Number.MAX_SAFE_INTEGER}});else{if(1!==e)throw new Error("checkpoint.format must be 0 or 1");this._state=Object(I.a)(Object(I.a)({},this._state),{},{checkpoint:{format:1,syncedConversations:0,updatedConversation:0,importedMessages:0,syncedMessages:0,minSeq:t,maxSeq:s,currentSeq:{},priorities:[],syncingConversation:null}})}}nextStep(){if(!this._state)throw new Error("SyncStateStore not initialized");const e=this._state.step+1;if(e>Em.UPDATE_MESSAGES_CACHE)throw new Error("already at the last step");this._state=Object(I.a)(Object(I.a)({},this._state),{},{step:e}),this.save()}reset(){this._state={step:Em.RESTORE_CONVERSATIONS,started:!0,isSyncing:!1},this.save()}clear(){this._state=null,this.adapter.remove("sync-state")}save(){this._state?this.adapter.write("sync-state",1,this._state):this.adapter.remove("sync-state")}}class Rm{constructor(e){this.adapter=e,this._backup=void 0}load(){this._backup=this.adapter.read("backup",1)}get(){if(void 0===this._backup)throw new Error("BackupStore not initialized");return this._backup}save(e){return this._backup=e,this.adapter.write("backup",1,this._backup),e}clear(){this._backup=null,this.adapter.remove("backup")}}class wm{constructor(e){this.adapter=e,this._value=void 0}load(){this._value=this.adapter.read("src",1)}get(){if(void 0===this._value)throw new Error("SyncSourceStore not initialized");return this._value}save(e){this._value=e,this.adapter.write("src",1,this._value)}clear(){this._value=null,this.adapter.remove("src")}}class Lm{constructor(e){this.adapter=e,this._value=void 0,this._arrivalTimestamp=void 0,this._arrivalTimestamp=0}load(){this._value=this.adapter.read("tempKeySource",1)}setArrivalTimestamp(e){this._arrivalTimestamp=e}getArrivalTimestamp(){return this._arrivalTimestamp}get(){return void 0===this._value?om.m.SERVER:this._value}save(e){this._value=e,this.adapter.write("tempKeySource",1,this._value)}clear(){this._value=null,this.adapter.remove("tempKeySource")}}a.ModuleContainer.registerSingleton(Om,class{constructor(){this._adapter=void 0,this._syncStateStore=void 0,this._syncSourceStore=void 0,this._backupStore=void 0,this._tempKeySourceStore=void 0,this._adapter=new Mm,this._syncStateStore=new Tm(this._adapter),this._syncSourceStore=new wm(this._adapter),this._backupStore=new Rm(this._adapter),this._tempKeySourceStore=new Lm(this._adapter)}load(e){this.migrate(),this._adapter.load(),this._syncSourceStore.load(),this._syncStateStore.load(),this._backupStore.load(),this._tempKeySourceStore.load()}clear(e){e||(this._syncSourceStore.clear(),this._syncStateStore.clear()),this._backupStore.clear()}get syncState(){return this._syncStateStore}get backup(){return this._backupStore}get syncSource(){return this._syncSourceStore}get tempKeySource(){return this._tempKeySourceStore}migrate(){}});var Dm,Am=s("6D/Z"),Fm=s("U+wf");const km=Object(a.define)("sync-message-metrics");let Nm=Object(a.injectable)()(Dm=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(Dm=Reflect.metadata("design:type",Function)(Dm=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Dm=class{constructor(e){this.startTime=-1,this.lastMilestone=-1,this.lastSyncSource=om.j.MANUAL,this.logger=void 0,this.logger=e.createZLogger("msg-sync",["metrics"])}get storage(){return a.ModuleContainer.resolve(Om)}get uiState(){return a.ModuleContainer.resolve(Am.b)}get setting(){return a.ModuleContainer.resolve(Sm.a)}get entriesTransferManager(){return a.ModuleContainer.resolve(ym.b)}get messageReadinessChecker(){return a.ModuleContainer.resolve(Fm.a)}setLastSyncSource(e){this.lastSyncSource=e}getLastSyncSource(){return this.lastSyncSource}onStartTransferAfterLogin(){this.actionLog(om.l.NORMAL),this.entriesTransferManager.missingMessageEventList.includes(om.j.E2EE_MISSING_MESSAGE)&&this.onTransferAfterLoginWithChangeDeviceEvent(),this.entriesTransferManager.missingMessageEventList.includes(om.j.OVERFLOW)&&this.onTransferAfterLoginWithOverflowQueueEvent(),this.setLastSyncSource(om.j.TRANSFER_WHEN_LOGIN)}onTransferAfterLoginWithChangeDeviceEvent(){this.actionLog(om.l.WITH_E2EE_MISSING_MESSAGE)}onTransferAfterLoginWithOverflowQueueEvent(){this.actionLog(om.l.WITH_OVERFLOW_QUEUE)}onCheckSyncSuggestion(e){switch(e){case om.j.FIRST_TIME_LOGIN:break;case om.j.OVERFLOW:this.actionLog(2090208)}}onShowSyncSuggestion(){switch(this.storage.syncSource.get()){case om.j.FIRST_TIME_LOGIN:this.actionLog(2090101);break;case om.j.OVERFLOW:case om.j.E2EE_MISSING_MESSAGE:this.actionLog(2090201)}}onShowErrorModal(){this.uiState.getCurrentError()===om.c.USER_DONT_CONFIRM&&this.actionLog(2090801)}onSyncFailed(e){const t=this.lastSyncSource,s=this.storage.backup.get(),a=this.getSyncDuration(),i=JSON.stringify({format:(null==s?void 0:s.format)||void 0,src:t,import:this.storage.syncState.checkpoint.importedMessages,transfer:(null==s?void 0:s.numberOfMessagesCount)||void 0});kc.default.increaseFailed(om.f.GENERAL,0,a,e,Date.now(),[i]),this.logger.zsymb(0,"JSvPqK",`onSyncFailed ${e} ${i}`),e===om.c.USER_DONT_CONFIRM&&this.actionLog(2090903),t===om.j.TRANSFER_WHEN_LOGIN&&this.actionLog(om.l.FAILED)}onCloseBanner(){const e=this.uiState.getCurrentError(),t=this.uiState.getPopupVisible(),s=this.uiState.getCurrentScreen();if(!t){if(this.actionLog(2090301),s===Am.a.SyncGuide)this.actionLog(2090701);e!==om.c.NO_ERROR&&(t||this.actionLog(2090402),e===om.c.USER_DONT_CONFIRM&&this.actionLog(2090901))}}onClosePopup(){const e=this.uiState.getCurrentError();this.uiState.getCurrentScreen()===Am.a.SyncGuide&&this.actionLog(2090601),e===om.c.USER_DONT_CONFIRM&&this.actionLog(2090803),e!==om.c.NO_ERROR&&this.actionLog(2091406)}onCloseSyncSuggestion(){switch(this.storage.syncSource.get()){case om.j.FIRST_TIME_LOGIN:this.actionLog(2090101);break;case om.j.OVERFLOW:case om.j.E2EE_MISSING_MESSAGE:this.actionLog(2090203)}}clickResend(){this.actionLog(2090602)}clickCacnelInCloseSyncSuggestionConfirmModal(){switch(this.storage.syncSource.get()){case om.j.FIRST_TIME_LOGIN:break;case om.j.OVERFLOW:this.actionLog(2090206)}}clickConfirmSync(){switch(this.storage.syncSource.get()){case om.j.MANUAL:this.setting.value().dontSuggest?this.actionLog(2091001):this.actionLog(2091002);break;case om.j.SETTING:this.setting.value().dontSuggest?this.actionLog(2090502):this.actionLog(2090501);break;case om.j.FIRST_TIME_LOGIN:this.actionLog(2090102);break;case om.j.OVERFLOW:case om.j.E2EE_MISSING_MESSAGE:this.actionLog(2090202)}}clickRejectSuggestion(){this.actionLog(2090103)}clickContinueInRejectSuggestionConfirmModal(){switch(this.storage.syncSource.get()){case om.j.FIRST_TIME_LOGIN:break;case om.j.OVERFLOW:this.setting.value().dontSuggest?this.actionLog(2090205):this.actionLog(2090204)}}clickCancelInRejectSuggestionConfirmModal(){}clickCancelSync(){switch(this.uiState.getCurrentScreen()){case Am.a.SyncGuide:this.actionLog(2090304);break;case Am.a.WaitForBackup:this.actionLog(2090305)}}clickCancelInCancelSyncConfirmModal(){this.actionLog(2090302)}clickConfirmCancelSyncConfirmModal(){const e=this.uiState.getCurrentScreen(),t=this.storage.syncSource.get();e===Am.a.SyncGuide&&this.actionLog(2090311),t===om.j.TRANSFER_WHEN_LOGIN&&this.onUserTerminateTransferAfterLogin(),this.actionLog(2090303)}onUserTerminateTransferAfterLogin(){this.actionLog(om.l.USER_TERMINATE_TRANSFER_WHEN_LOGIN)}terminateTransferWhenLogin(){this.actionLog(om.l.AUTO_TERMINATE_TRANSFER_WHEN_LOGIN)}waitingForNoMissingMessageEventsTimeout(){this.actionLog(om.l.WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT)}clickRetrySync(){const e=this.uiState.getCurrentError(),t=this.uiState.getPopupVisible();e!==om.c.NO_ERROR&&(this.actionLog(2090401),t&&this.actionLog(2091407),e===om.c.USER_DONT_CONFIRM&&(t?this.actionLog(2090802):this.actionLog(2090902)))}clickViewGuide(){this.actionLog(2090702)}resetSyncStartTime(){this.startTime=Oa.a.now(),this.lastMilestone=Oa.a.now()}onSyncSuccess(e,t,s,a={},i){const n=this.lastSyncSource;this.actionLog(2091101);const r=this.getSyncDuration(),o=JSON.stringify({format:e,src:n,import:t,transfer:s,trackInfo:a,timeBetweenSyncs:i});kc.default.increaseSuccess(om.f.GENERAL,0,r,[o]),n===om.j.TRANSFER_WHEN_LOGIN&&this.actionLog(om.l.SUCCESS),this.logger.zsymb(0,"tptDGl",`ph7 onSyncSuccess ${o}, ${r}`)}onReqBackupSuccess(e){const t=this.getMilestoneDuration(!0);kc.default.increaseSuccess(om.f.REQ_BACKUP,0,t,[JSON.stringify({format:e})])}onReqBackupFailure(e,t){kc.default.increaseFailed(om.f.REQ_BACKUP,e,this.getMilestoneDuration(),t,Date.now())}onDownloadBackupSuccess(){const e=this.getMilestoneDuration(!0);kc.default.increaseSuccess(om.f.DOWNLOAD_BACKUP,0,e)}onDownloadBackupFailure(e,t){kc.default.increaseFailed(om.f.DOWNLOAD_BACKUP,e,this.getMilestoneDuration(),t,Date.now())}onDecryptBackupSuccess(){const e=this.getMilestoneDuration(!0);kc.default.increaseSuccess(om.f.DECRYPT_BACKUP,0,e)}onDecryptBackupFailure(e){const t=this.getMilestoneDuration();kc.default.increaseFailed(om.f.DECRYPT_BACKUP,0,t,e,Date.now())}onRestoreDataSuccess(){const e=this.getMilestoneDuration(!0);kc.default.increaseSuccess(om.f.RESTORE_TASK,0,e),this.logger.zsymb(0,"o6cctS","ph7 restore success",e)}onRestoreDataFailure(e){const t=this.getMilestoneDuration();kc.default.increaseFailed(om.f.RESTORE_TASK,om.g.SELF_DEFINE,t,e,Date.now())}clickConfirmCancelSyncConfirmModalFromCounterModal(){this.uiState.getCurrentScreen()===Am.a.SyncGuide&&this.actionLog(2090311),this.actionLog(2090303)}onErrorTimeoutWaitingMobileConfirm(){this.actionLog(2090312)}clickCloseSynGuidePopup(){this.actionLog(2090601)}onShowSyncGuidePopup(){this.actionLog(2090604)}onConfirmSyncFromMobile(){this.actionLog(2090605)}onRejectSyncFromMobile(){this.actionLog(2090606)}onErrorPopupWaitingMobileConfirm(e){if(this.uiState.getPopupVisible())switch(this.actionLog(2091401),e){case om.c.NO_NETWORK:this.actionLog(2091402);break;case om.c.USER_DONT_CONFIRM:this.actionLog(2091403);break;case om.c.BUSY_RESTORING:this.actionLog(2091404);break;case om.c.CLIENT_NOT_SUPPORT:this.actionLog(2091405)}}onShowSyncSuggestionWithoutResume(){this.actionLog(2090209)}onMobileIdle(){this.actionLog(om.e)}logMissingMessageEventsTimeSinceGetLoginInfo(){const e=e=>e>0?(e-t)/1e3:-1,t=this.messageReadinessChecker.getGetLoginInfoTimestamp(),s=this.messageReadinessChecker.getDoneCheckOverflowTimestamp(),a=this.messageReadinessChecker.getE2eeSessionChangedTimestamp(),i=this.storage.tempKeySource.getArrivalTimestamp(),n=this.messageReadinessChecker.getApplicationReadyTimestamp();let r=e(s),o=e(a),c=e(i),l=e(n);t<=0&&(r=o=c=l=-1);this.actionLogInfoV2(Ia.FeaturesInfo.MessageReadinessStatus,2,{temp_key:c,queue_evict:r,change_device_e2ee:o,application_ready:l})}actionLogInfoV2(e,t,s,a,i){Ia.default.logActionInfoV2(e,t,s,a,i)}actionLog(e){Ia.default.logAction(e)}getSyncDuration(){return this.startTime>0?Oa.a.now()-this.startTime:0}getMilestoneDuration(e=!1){const t=this.lastMilestone>0?Oa.a.now()-this.lastMilestone:0;return e&&(this.lastMilestone=Oa.a.now()),t}})||Dm)||Dm)||Dm)||Dm;a.ModuleContainer.registerSingleton(km,Nm);var Pm=s("G15u"),jm=s("4ZNH"),Um=s("Fbac");function Bm(e){const t={retryCount:-1,canRetry:0!==e.maxRetry};return Object(Pm.a)({context:t,initial:"running",states:{running:{entry:Um.a.assign({retryCount:e=>e.retryCount+1}),invoke:{src:t=>e.action(t.retryCount),onError:[{cond:(t,s)=>!(!t.canRetry||"function"==typeof e.canRetryError&&!e.canRetryError(s.data)),target:"retry"},{actions:(e,t)=>{e.error=t.data},target:"failure"}],onDone:{target:"final"}}},retry:{invoke:{src:()=>t=>{const s=e.autoRetry||0;if(s>0){const e=setTimeout((()=>{t({type:"RETRY"})}),s);return()=>clearTimeout(e)}return()=>{}}},on:{RETRY:{actions:Um.a.assign({canRetry:t=>-1===e.maxRetry||t.retryCount<e.maxRetry}),target:"running"},ABORT:{target:"final"}}},failure:{type:"final",data:e=>({success:!1,error:e.error})},final:{type:"final",data:{success:!0}}}})}function zm(e,t,s,a){return Object(Pm.a)({strict:!0,context:{},initial:"running",states:{running:{initial:"prepare",states:{prepare:{entry:()=>{e.zsymb(3,"OOyhtX",["prepare","D8KBzL"])},invoke:{src:async()=>t.prepareNewSync(),onDone:"request_backup",onError:{actions:()=>{kc.default.increaseFailed(98102,0,0,0,Date.now()),s.showError(om.c.PREPARE_NEW_SYNC_FAILED)},target:"failure"}}},request_backup:{entry:()=>{me.a.SyncMessageController.setRequestBackupTimeout(!1),e.zsymb(3,"pIh_vf",["send_request","iOcuMe"]),s.clearError(),s.showSyncGuide()},invoke:{id:"request_backup_api",src:Bm({action:async e=>t.request(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>e.code===Y.NetWorkError.NO_NETWORK?(a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.NO_NET),!1):211===e.error_code||-69===e.error_code?(a.onReqBackupFailure(om.g.EXTERNAL,e.error_code),!1):(a.onReqBackupFailure(om.g.EXTERNAL,e.error_code||-1),!0)}),onDone:[{cond:(e,t)=>t.data.success,target:"wait_for_user_confirm"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===Y.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var i;211===(null===(i=t.data.error)||void 0===i?void 0:i.error_code)?(s.showError(om.c.CLIENT_NOT_SUPPORT),a.onErrorPopupWaitingMobileConfirm(om.c.CLIENT_NOT_SUPPORT)):s.showError(om.c.REQUEST_BACKUP_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(om.c.REQUEST_BACKUP_FAILED)},target:"failure"}},on:{SUCCESS:{target:"wait_for_user_confirm"},ERR_TIMEOUT:{actions:()=>{s.showError(om.c.BACKUP_TIMEOUT),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERROR:{actions:()=>{s.showError(om.c.REQUEST_BACKUP_FAILED),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_CLIENT_NOT_SUPPORT:{actions:()=>{s.showError(om.c.CLIENT_NOT_SUPPORT),a.onErrorPopupWaitingMobileConfirm(om.c.CLIENT_NOT_SUPPORT),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},USER_CONFIRM:{actions:()=>{e.zsymb(3,"Cl8BQS",["user_confirm","8xU-t8"]),s.hidePopup(),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"wait_for_backup"},USER_REJECT:{actions:()=>{s.showError(om.c.USER_REJECT_BACKUP),s.hidePopup(),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(om.c.BACKUP_FAILED),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"}}},wait_for_user_confirm:{entry:()=>{e.zsymb(3,"TmE398",["wait_for_user_confirm","Wrbxnv"]),s.clearError(),s.showSyncGuide(),a.onShowSyncGuidePopup()},on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"ge8U7W",["user_confirm","8xU-t8"]),s.hidePopup(),a.onConfirmSyncFromMobile(),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"wait_for_backup"},USER_REJECT:{actions:()=>{s.showError(om.c.USER_REJECT_BACKUP),s.hidePopup(),a.onRejectSyncFromMobile(),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_TIMEOUT:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.CONFIRM_TIMEOUT),a.onErrorTimeoutWaitingMobileConfirm(),a.onErrorPopupWaitingMobileConfirm(om.c.USER_DONT_CONFIRM),s.showError(om.c.USER_DONT_CONFIRM),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_INVALID_BACKUP:{actions:()=>{s.showError(om.c.REQUEST_BACKUP_FAILED),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BUSY_RESTORING:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.BUSY_RESTORING),s.showError(om.c.BUSY_RESTORING),a.onErrorPopupWaitingMobileConfirm(om.c.BUSY_RESTORING),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.BACKUP_FAILED),s.showError(om.c.BACKUP_FAILED),lm.a.isEnableUXConfirmTransferRevamp()&&me.a.SyncMessageController.closeCancelSyncInSuggestingPopup()},target:"failure"}}},wait_for_backup:{entry:()=>{e.zsymb(3,"g8_jVb",["wait_for_backup","hFzB1c"]),me.a.SyncMessageController.setRequestBackupTimeout(!0),s.showWaitForBackup()},on:{SUCCESS:{target:"download_backup"},ERR_TIMEOUT:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.BACKUP_TIMEOUT),s.showError(om.c.BACKUP_TIMEOUT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(om.c.BACKUP_FAILED)},target:"failure"},INVALID_BACKUP_INFO:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.INVALID_BACKUP),s.showError(om.c.INVALID_BACKUP_INFO)},target:"failure"},INVALID_BACKUP_ENCRYPT_FORMAT:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.INVALID_BACKUP),s.showError(om.c.INVALID_BACKUP_ENCRYPT_FORMAT)},target:"failure"}}},download_backup:{entry:()=>{e.zsymb(3,"7b4msz",["download_backup","actB-6"]),me.a.SyncMessageController.clearRequestBackupTimeout(),s.showDownloadingBackup()},invoke:{strict:!0,src:Bm({action:async e=>t.download(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>{var t;if(e.code===Y.NetWorkError.NO_NETWORK)return a.onDownloadBackupFailure(om.g.SELF_DEFINE,om.h.NO_NET),!1;if(211===e.error_code||-69===e.error_code)return a.onDownloadBackupFailure(om.g.EXTERNAL,e.error_code),!1;const s=(null===(t=e.downloadError)||void 0===t?void 0:t.name)||e.name||"";if("string"==typeof s&&s.includes("ENOSPC"))return a.onDownloadBackupFailure(om.g.SELF_DEFINE,om.b.ENOSPC),!1;const i=e.code||e.error_code,n=i?om.g.EXTERNAL:om.g.SELF_DEFINE;return a.onDownloadBackupFailure(n,i||om.b.UNKNOW_ERR),!0}}),onDone:[{cond:(e,t)=>t.data.success,actions:()=>{a.onDownloadBackupSuccess()},target:"decrypt_backup"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===Y.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var i;a.onDownloadBackupFailure(om.g.SELF_DEFINE,om.b.DOWNLOAD_BACKUP_ERR);const n=(null===(i=t.data.error)||void 0===i?void 0:i.downloadError)||t.data.error,r=(null==n?void 0:n.name)||"Error";"string"==typeof r&&r.includes("ENOSPC")?s.showError(om.c.LOW_STORAGE):s.showError(om.c.DOWNLOAD_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(om.c.DOWNLOAD_FAILED)},target:"failure"}}},decrypt_backup:{entry:()=>{e.zsymb(3,"FC2R42",["decrypt_backup","wIKilD"]),s.showDecryptingBackup()},invoke:{src:async()=>t.decrypt(),onDone:{actions:()=>{a.onDecryptBackupSuccess()},target:"#success"},onError:{actions:(t,i)=>{const n=i.data;e.zsymb(18,"0_9Zc0",(()=>["decrypt_backup error",{error:n}])),a.onDecryptBackupFailure(n.error_code),s.showError(om.c.DECRYPT_FAILED)},target:"failure"}}},failure:{entry:[()=>{e.zsymb(3,"KpWoQO",["failure","lCwg8q"]),me.a.SyncMessageController.onSyncFailed()},"signalDone"],on:{RETRY_SYNC:{target:"prepare"},START_SYNC:{target:"prepare"},USER_CONFIRM:{actions:()=>{e.zsymb(0,"7qCZ9j","user_confirm"),s.clearError(),s.hidePopup()},target:"wait_for_backup"},SUCCESS:{actions:()=>{e.zsymb(0,"twd8Z1","received success event"),s.clearError(),s.hidePopup()},target:"download_backup"}}},hist:{history:"shallow",type:"history"}}},success:{id:"success",type:"final"},wait_for_network:{id:"wait_for_network",entry:()=>{e.zsymb(3,"W4brCP",["wait_for_network","LBeYUO"]),s.showWaitForNetwork(),a.onErrorPopupWaitingMobileConfirm(om.c.NO_NETWORK),me.a.SyncMessageController.onNetworkError()},on:{START_SYNC:{target:"running.prepare"},ONLINE:{target:"running.hist"},RETRY_SYNC:{target:"running.hist"}}}}})}var Gm,xm=s("VBs7");function Vm(e,t,s,a,i){return Object(Pm.a)({context:{canRetry:!1},initial:"running",states:{running:{entry:()=>{e.zsymb(3,"DQby4k",["restoring","l-nn5P"]),s.setProgress(0)},invoke:{id:"restore_backup",src:Bm({action:async e=>t.restore(e),maxRetry:5,autoRetry:2e3,canRetryError:e=>"WorkerInterrupted"===e.name}),onDone:[{cond:(e,t)=>t.data.success,target:"cleanup"},{actions:e=>{s.showError(om.c.SYNC_FAILED)},target:"failure"}],onError:{actions:e=>{s.showError(om.c.SYNC_FAILED)},target:"failure"}}},cleanup:{entry:()=>{e.zsymb(3,"NMO-8P",["cleanup","N9bln_"])},invoke:{src:async()=>{t.clean()},onDone:"success",onError:"success"}},wait_for_network:{entry:()=>{e.zsymb(3,"pNigIO",["wait_for_network","LBeYUO"]),s.showWaitForNetwork()},on:{START_SYNC:{actions:()=>{me.a.SyncMessageController.restartSync()}},ONLINE:{target:"running"}}},failure:{entry:[()=>{me.a.SyncMessageController.onSyncFailed()},"signalDone"],on:{START_SYNC:{actions:()=>{me.a.SyncMessageController.restartSync()}},RETRY_SYNC:[{target:"running",cond:e=>e.canRetry},{actions:()=>{e.zsymb(3,"ULlVdG",["restart sync","IbmffT"]),me.a.SyncMessageController.restartSync()}}]}},success:{entry:[async()=>{await Object(lm.c)(s),e.zsymb(3,"54PNfv",["success","unhCSj"]),s.showSuccessMessage(),me.a.SyncMessageController.onSyncSuccess(),me.a.SyncMessageController.setAutoCloseSuccessTimeout()},"signalDone"],on:{START_SYNC:{actions:()=>{me.a.SyncMessageController.restartSync()}},AUTO_CLOSE:{target:"done",actions:()=>s.hideAllUI()}}},done:{type:"final"}}},{actions:{signalDone:()=>{a.emit({topic:xm.a.Done})}}})}function Hm(e,t,s,a){return Object(Pm.a)({strict:!0,initial:"running",states:{running:{initial:"holding_temp_key",states:{holding_temp_key:{entry:()=>{me.a.SyncMessageController.setNoMissingMessageEventsTimeout(),t.getEnableLogEventsArrivalTimeConfig()&&setTimeout((()=>{a.logMissingMessageEventsTimeSinceGetLoginInfo()}),t.getEventsArrivalTimeSubmitLogTimeout()),t.getSuccessBannerWhenDropTransferWhenLoginConfig()&&s.showWaitForBackup(),e.zsymb(0,"7-fTux","holding temp key")},always:[{cond:"shouldTransferGuard",target:"prepare"},{cond:"shouldTerminateGuard",target:"#terminate_transfer_when_login"}],on:{HAVE_MISSING_MESSAGE_EVENTS:{target:"prepare"},WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT:{actions:()=>a.waitingForNoMissingMessageEventsTimeout(),target:"prepare"},HAVE_NO_MISSING_MESSAGE_EVENT:{cond:"shouldTerminateConfigGuard",target:"#terminate_transfer_when_login"}}},prepare:{entry:()=>me.a.SyncMessageController.startTransferAfterHoldingTempKey(),invoke:{src:async()=>t.prepareNewSync(),onDone:[{cond:(e,t)=>""!==e.tempKey,target:"request_backup"},{cond:(e,t)=>""===e.tempKey,actions:()=>s.showError(om.c.PREPARE_NEW_SYNC_FAILED),target:"failure"}],onError:{actions:()=>{kc.default.increaseFailed(98102,0,0,0,Date.now()),s.showError(om.c.PREPARE_NEW_SYNC_FAILED)},target:"failure"}}},request_backup:{entry:()=>{me.a.SyncMessageController.setRequestBackupTimeout(!1),e.zsymb(3,"usypLL",["send_request","iOcuMe"]),s.clearError()},invoke:{id:"request_backup_api",src:(e,s)=>Bm({action:async s=>t.request(s,void 0,e.tempKey),maxRetry:2,autoRetry:5e3,canRetryError:e=>e.code===Y.NetWorkError.NO_NETWORK?(a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.NO_NET),!1):211===e.error_code||-69===e.error_code?(a.onReqBackupFailure(om.g.EXTERNAL,e.error_code),!1):(a.onReqBackupFailure(om.g.EXTERNAL,e.error_code||-1),!0)}),onDone:[{cond:(e,t)=>t.data.success,actions:Object(jm.b)((e=>({tempKey:""}))),target:"wait_for_user_confirm"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===Y.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var i;211===(null===(i=t.data.error)||void 0===i?void 0:i.error_code)?(s.showError(om.c.CLIENT_NOT_SUPPORT),a.onErrorPopupWaitingMobileConfirm(om.c.CLIENT_NOT_SUPPORT)):s.showError(om.c.REQUEST_BACKUP_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(om.c.REQUEST_BACKUP_FAILED)},target:"failure"}},on:{SUCCESS:{target:"wait_for_user_confirm"},ERR_TIMEOUT:{actions:()=>s.showError(om.c.BACKUP_TIMEOUT),target:"failure"},ERROR:{actions:()=>s.showError(om.c.REQUEST_BACKUP_FAILED),target:"failure"},ERR_CLIENT_NOT_SUPPORT:{actions:()=>{s.showError(om.c.CLIENT_NOT_SUPPORT),a.onErrorPopupWaitingMobileConfirm(om.c.CLIENT_NOT_SUPPORT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>s.showError(om.c.BACKUP_FAILED),target:"failure"}}},wait_for_user_confirm:{entry:()=>{me.a.SyncMessageController.setMobileTransferConfirmTimeout()},on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"c3mqE0",["user_confirm (transfer after login)","dtFsCw"]),me.a.SyncMessageController.clearMobileTransferConfirmTimeout()},target:"wait_for_backup"},MOBILE_CONFIRM_TIMEOUT:{actions:()=>{lm.a.isEnableSyncIdleMobileState()&&s.showMobileIdleInBackup()}},ERR_TIMEOUT:{actions:()=>{s.showError(om.c.REQUEST_BACKUP_FAILED)},target:"failure"},ERR_INVALID_BACKUP:{actions:()=>{s.showError(om.c.REQUEST_BACKUP_FAILED)},target:"failure"},ERR_BUSY_RESTORING:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.BUSY_RESTORING),s.showError(om.c.BUSY_RESTORING),a.onErrorPopupWaitingMobileConfirm(om.c.BUSY_RESTORING)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.BACKUP_FAILED),s.showError(om.c.REQUEST_BACKUP_FAILED)},target:"failure"}}},wait_for_backup:{entry:()=>{e.zsymb(3,"8Y4leg",["wait_for_backup","hFzB1c"]),me.a.SyncMessageController.setRequestBackupTimeout(!0),s.showWaitForBackup()},on:{SUCCESS:{target:"download_backup"},ERR_TIMEOUT:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.BACKUP_TIMEOUT),s.showError(om.c.BACKUP_TIMEOUT)},target:"failure"},ERR_BACKUP_FAIL:{actions:()=>{s.showError(om.c.BACKUP_FAILED)},target:"failure"},INVALID_BACKUP_INFO:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.INVALID_BACKUP),s.showError(om.c.INVALID_BACKUP_INFO)},target:"failure"},INVALID_BACKUP_ENCRYPT_FORMAT:{actions:()=>{a.onReqBackupFailure(om.g.SELF_DEFINE,om.h.INVALID_BACKUP),s.showError(om.c.INVALID_BACKUP_ENCRYPT_FORMAT)},target:"failure"}}},download_backup:{entry:()=>{e.zsymb(3,"r-WC_w",["download_backup","actB-6"]),me.a.SyncMessageController.clearRequestBackupTimeout(),s.showDownloadingBackup()},invoke:{strict:!0,src:Bm({action:async e=>t.download(e),maxRetry:2,autoRetry:5e3,canRetryError:e=>{var t;if(e.code===Y.NetWorkError.NO_NETWORK)return a.onDownloadBackupFailure(om.g.SELF_DEFINE,om.h.NO_NET),!1;if(211===e.error_code||-69===e.error_code)return a.onDownloadBackupFailure(om.g.EXTERNAL,e.error_code),!1;const s=(null===(t=e.downloadError)||void 0===t?void 0:t.name)||e.name||"";if("string"==typeof s&&s.includes("ENOSPC"))return a.onDownloadBackupFailure(om.g.SELF_DEFINE,om.b.ENOSPC),!1;const i=e.code||e.error_code,n=i?om.g.EXTERNAL:om.g.SELF_DEFINE;return a.onDownloadBackupFailure(n,i||om.b.UNKNOW_ERR),!0}}),onDone:[{cond:(e,t)=>t.data.success,actions:()=>{a.onDownloadBackupSuccess()},target:"decrypt_backup"},{cond:(e,t)=>{var s;return(null===(s=t.data.error)||void 0===s?void 0:s.code)===Y.NetWorkError.NO_NETWORK},target:"#wait_for_network"},{actions:(e,t)=>{var i;a.onDownloadBackupFailure(om.g.SELF_DEFINE,om.b.DOWNLOAD_BACKUP_ERR);const n=(null===(i=t.data.error)||void 0===i?void 0:i.downloadError)||t.data.error,r=(null==n?void 0:n.name)||"Error";"string"==typeof r&&r.includes("ENOSPC")?s.showError(om.c.LOW_STORAGE):s.showError(om.c.DOWNLOAD_FAILED)},target:"failure"}],onError:{actions:()=>{s.showError(om.c.DOWNLOAD_FAILED)},target:"failure"}}},decrypt_backup:{entry:()=>{e.zsymb(3,"mpWkr_",["decrypt_backup","wIKilD"]),s.showDecryptingBackup()},invoke:{src:async()=>t.decrypt(),onDone:{actions:()=>{a.onDecryptBackupSuccess()},target:"#success"},onError:{actions:(t,i)=>{const n=i.data;e.zsymb(18,"WJSCe-",(()=>["decrypt_backup error",{error:n}])),a.onDecryptBackupFailure(n.error_code),s.showError(om.c.DECRYPT_FAILED)},target:"failure"}}},failure:{entry:[()=>{e.zsymb(3,"UWyOjQ",["failure","lCwg8q"]),me.a.SyncMessageController.onSyncFailed()},"signalDone",Object(jm.b)((e=>({tempKey:""})))],on:{USER_CONFIRM:{actions:()=>{e.zsymb(3,"myXyE6",["user_confirm (transfer after login)","dtFsCw"]),s.clearError(),s.hidePopup()},target:"wait_for_backup"},SUCCESS:{actions:()=>{e.zsymb(0,"vzweGI","received success event"),s.clearError(),s.hidePopup()},target:"download_backup"}}},hist:{history:"shallow",type:"history"}}},terminate_transfer_when_login:{id:"terminate_transfer_when_login",type:"final",entry:()=>me.a.SyncMessageController.terminateTransferWhenLogin(),data:()=>({terminate_transfer_when_login:!0})},success:{id:"success",type:"final"},wait_for_network:{id:"wait_for_network",entry:[()=>{e.zsymb(3,"3tn0-K",["wait_for_network","LBeYUO"]),s.showWaitForNetwork(),a.onErrorPopupWaitingMobileConfirm(om.c.NO_NETWORK)},Object(jm.b)((e=>({tempKey:""})))],on:{START_AUTO_SYNC:{target:"running.prepare"},ONLINE:{target:"running.hist"}}}}},{guards:{shouldTransferGuard:()=>{if(!t.getEnabledDropTransferWhenLoginFlowConfig())return!0;const e=t.isAtLeastOneMissingMessageEventArrived(),s=t.shouldTransferWhenLogin();return e||s},shouldTerminateGuard:()=>{if(!t.getEnabledDropTransferWhenLoginFlowConfig())return!1;const s=t.isNoMissingMessageEventsArrived();return e.zsymb(0,"myxHZr",`shouldTerminate: ${s}`),s},shouldTerminateConfigGuard:()=>t.getEnabledDropTransferWhenLoginFlowConfig()}})}let Wm=Object(a.injectable)()(Gm=Object(a.singleton)()(Gm=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(Gm=function(e,t){return Object(a.inject)(_m)(e,void 0,1)}(Gm=function(e,t){return Object(a.inject)(Om)(e,void 0,2)}(Gm=function(e,t){return Object(a.inject)(Am.b)(e,void 0,3)}(Gm=function(e,t){return Object(a.inject)(km)(e,void 0,4)}(Gm=function(e,t){return Object(a.inject)(Im.b)(e,void 0,5)}(Gm=Reflect.metadata("design:type",Function)(Gm=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===_m?Object:_m,void 0===Om?Object:Om,void 0===Am.b?Object:Am.b,void 0===km?Object:km,void 0===Im.b?Object:Im.b])(Gm=class extends bm.a{constructor(e,t,s,a,i,n){super(),this.loggerFactory=e,this.service=t,this.storage=s,this.ui=a,this.metrics=i,this.zmq=n}createMachine(){return e=this.loggerFactory.createZLogger("msg-sync",["state"]),t=this.metrics,s=this.service,a=this.storage,i=this.ui,n=this.zmq,Object(Pm.a)({strict:!0,id:"message-sync",context:{},initial:"idle",states:{idle:{entry:()=>e.zsymb(3,"pqpYQ_",["idle","8dJtlO"]),on:{SUGGEST_NEW_SYNC:"suggest_new_sync",SUGGEST_RESUME:"suggest_resume",START_AUTO_SYNC:"run.auto_backup",START_SYNC:{actions:()=>{t.clickConfirmSync()},target:"run"}}},suggest_new_sync:{entry:(s,n)=>{e.zsymb(0,"qp96tb",(()=>["suggest_new_sync",{src:Object(om.t)(n.src)}])),a.syncSource.save(n.src),t.onShowSyncSuggestion(),i.showSuggestNewSync(n.shouldShowSyncGuide)},on:{START_SYNC:{actions:()=>{t.clickConfirmSync()},target:"run"},START_AUTO_SYNC:"run.auto_backup",CLOSE_SUGGEST:{actions:()=>i.hideAllUI(),target:"idle"}}},suggest_resume:{entry:()=>{e.zsymb(3,"UU8VhP",["suggest_resume","qWDgaR"]),i.showSuggestResume()},on:{START_SYNC:"run",START_AUTO_SYNC:"run.auto_backup",RESUME_SYNC:"#restore_backup",CLOSE_SUGGEST:{actions:()=>i.hideAllUI(),target:"idle"}}},run:{initial:"request_backup",states:{request_backup:{entry:()=>e.zsymb(3,"EHhOur",["request_backup","x1mQQA"]),invoke:{id:"request_backup",src:zm(e,s,i,t),onDone:"restore_backup"},on:{SUCCESS:{actions:Object(jm.i)("request_backup")},USER_REJECT:{actions:Object(jm.i)("request_backup")},USER_CONFIRM:{actions:Object(jm.i)("request_backup")},RETRY_SYNC:{actions:Object(jm.i)("request_backup")},ERR_INVALID_BACKUP:{actions:Object(jm.i)("request_backup")},ERR_BACKUP_FAIL:{actions:Object(jm.i)("request_backup")},ERR_BUSY_RESTORING:{actions:Object(jm.i)("request_backup")},ERR_TIMEOUT:{actions:Object(jm.i)("request_backup")},START_SYNC:{actions:[Object(jm.i)("request_backup"),()=>{t.clickConfirmSync()}]}}},auto_backup:{entry:()=>{e.zsymb(3,"6xd5Af",["auto_backup","dWLa4D"]),t.onStartTransferAfterLogin(),a.syncSource.save(om.j.TRANSFER_WHEN_LOGIN)},invoke:{id:"auto_backup",src:Hm(e,s,i,t),data:(e,t)=>({tempKey:t.tempKey}),onDone:[{cond:(e,t)=>{var s;return null===(s=t.data)||void 0===s?void 0:s.terminate_transfer_when_login},target:"terminate_transfer_when_login"},{cond:(e,t)=>{var s;return!(null!==(s=t.data)&&void 0!==s&&s.terminate_transfer_when_login)},target:"restore_backup"}]},on:{SUCCESS:{actions:Object(jm.i)("auto_backup")},RETRY_SYNC:{target:"#message-sync.run",actions:()=>{const e=om.j.MANUAL;a.syncSource.save(e),t.setLastSyncSource(e)}},USER_CONFIRM:{actions:Object(jm.i)("auto_backup")},ERR_INVALID_BACKUP:{actions:Object(jm.i)("auto_backup")},ERR_BACKUP_FAIL:{actions:Object(jm.i)("auto_backup")},ERR_BUSY_RESTORING:{actions:Object(jm.i)("auto_backup")},MOBILE_CONFIRM_TIMEOUT:{actions:Object(jm.i)("auto_backup")},ERR_TIMEOUT:{actions:Object(jm.i)("auto_backup")},START_AUTO_SYNC:{actions:Object(jm.i)("auto_backup")},TERMINATE_TRANSFER_WHEN_LOGIN:{actions:Object(jm.i)("auto_backup")},WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT:{actions:Object(jm.i)("auto_backup")},HAVE_MISSING_MESSAGE_EVENTS:{actions:Object(jm.i)("auto_backup")},HAVE_NO_MISSING_MESSAGE_EVENT:{actions:Object(jm.i)("run.auto_backup")}}},restore_backup:{id:"restore_backup",entry:()=>{i.showInProgress(),i.setProgress(0)},invoke:{id:"restore_backup_machine",src:Vm(e,s,i,n),onDone:"done"},on:{RESTART_SYNC:{actions:()=>{t.clickConfirmSync()},target:"request_backup"},START_SYNC:{actions:Object(jm.i)("restore_backup_machine")},RETRY_SYNC:{actions:Object(jm.i)("restore_backup_machine")},AUTO_CLOSE:{actions:Object(jm.i)("restore_backup_machine")}}},terminate_transfer_when_login:{entry:[async()=>{e.zsymb(2,"MDY9q-","Successfully terminate transfer when login"),me.a.SyncMessageController.onTerminateTransferWhenLoginSuccess(),s.getSuccessBannerWhenDropTransferWhenLoginConfig()&&(i.showSuccessMessage(),me.a.SyncMessageController.setAutoCloseSuccessTimeout())}],always:[{cond:"shouldFinishTerminateFlow",target:"done"}],on:{AUTO_CLOSE:{target:"done",actions:()=>i.hideAllUI()}}},done:{type:"final"}},onDone:"idle"}},on:{CANCEL:{target:"idle",actions:()=>{i.hideAllUI(),me.a.SyncMessageController.onSyncCanceled()}},RESET:{target:"idle",actions:()=>i.hideAllUI()}}},{guards:{shouldFinishTerminateFlow:()=>!s.getSuccessBannerWhenDropTransferWhenLoginConfig()}});var e,t,s,a,i,n}canSuggestNewSync(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;if(!t)return!1;if(t.matches("idle"))return!0;let s;return t.children.request_backup&&(s=t.children.request_backup.getSnapshot()),t.children.auto_backup&&(s=t.children.auto_backup.getSnapshot()),t.children.restore_backup_machine&&(s=t.children.restore_backup_machine.getSnapshot()),!s||(s.matches("success")||s.matches("failure")||s.matches("running.failure"))}canStartNewSync(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;return!!t&&(!!(t.matches("idle")||t.matches("suggest_new_sync")||t.matches("suggest_resume"))||this.canSuggestNewSync())}isMachineIdle(){var e;const t=null===(e=this.interpreter)||void 0===e?void 0:e.state;return!t||t.matches("idle")}})||Gm)||Gm)||Gm)||Gm)||Gm)||Gm)||Gm)||Gm)||Gm)||Gm;var qm,Km=s("LLK0"),Zm=s("fg6f"),$m=s("RxLg"),Qm=s("HaJU"),Ym=s("svq+"),Jm=s("rrDN"),Xm=s("lANr");Object(m.j)()(qm=Object(m.f)()(qm=Object(m.h)()(qm=Object(a.singleton)(vm.a)(qm=Object(a.injectable)()(qm=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(qm=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(qm=function(e,t){return Object(a.inject)(Sm.a)(e,void 0,2)}(qm=function(e,t){return Object(a.inject)(_m)(e,void 0,3)}(qm=function(e,t){return Object(a.inject)(Am.b)(e,void 0,4)}(qm=function(e,t){return Object(a.inject)(Om)(e,void 0,5)}(qm=function(e,t){return Object(a.inject)(fm)(e,void 0,6)}(qm=function(e,t){return Object(a.inject)(km)(e,void 0,7)}(qm=function(e,t){return Object(a.inject)(ym.b)(e,void 0,8)}(qm=function(e,t){return Object(a.inject)(St.b)(e,void 0,9)}(qm=function(e,t){return Object(a.inject)(Fm.a)(e,void 0,10)}(qm=Reflect.metadata("design:type",Function)(qm=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===Sm.a?Object:Sm.a,void 0===_m?Object:_m,void 0===Am.b?Object:Am.b,void 0===Om?Object:Om,void 0===fm?Object:fm,void 0===km?Object:km,void 0===ym.b?Object:ym.b,void 0===St.ISystemTime?Object:St.ISystemTime,Object])(qm=class extends hs.b{constructor(e,t,s,i,n,r,o,c,l,d,u){super(),this.initialized=!1,this.currentUserId="",this.currentUserUIN="",this.isSyncRunning=!1,this.requestedSuggestSync=null,this.requestBackupTimeout=null,this.mobileTransferConfirmTimeout=null,this.waitingForMissingMessageEventsTimeout=null,this.autoCloseSuccessTimeout=null,this.logger=void 0,this.config=void 0,this.setting=void 0,this.service=void 0,this.storage=void 0,this.machine=void 0,this.systemTime=void 0,this.ui=void 0,this.helper=void 0,this.entriesTransferManager=void 0,this.messageReadinessChecker=void 0,this.metricts=void 0,this.suggestSync=async(e,t=!0,s=!1)=>{this.initialized?(this.machine.send({type:"SUGGEST_NEW_SYNC",src:e,shouldShowSyncGuide:t}),s||this.metricts.onShowSyncSuggestionWithoutResume()):this.logger.zsymb(18,"r32e_x","suggest sync but not ready")},this.suggestResume=async()=>{this.initialized?this.machine.send("SUGGEST_RESUME"):this.logger.zsymb(18,"bTiBMD","suggest resume but not ready")},this.sync=async e=>{this.isSyncRunning=!0,"number"==typeof e?this.storage.syncSource.save(e):e=this.storage.syncSource.get()||om.j.MANUAL,this.metricts.setLastSyncSource(e),this.metricts.resetSyncStartTime(),this.logger.zsymb(0,"xa-Moe","start new sync"),e===om.j.FIRST_TIME_LOGIN&&(this.setting.setMaxSeq(0),this.setting.setMinSeq(0)),this.machine.send("START_SYNC"),this.setting.value().showSharedWorkerWhenSync&&this.showSharedWorker(),this.dispatchEvent(new Cm.d)},this.resume=async()=>{this.isSyncRunning=!0,this.logger.zsymb(0,"tt_ul0","resume last sync");const e=this.storage.backup.get();this.storage.syncSource.save(om.j.RESUME),this.metricts.setLastSyncSource(om.j.RESUME),this.metricts.resetSyncStartTime();const t=e&&this.storage.syncState.isSyncing,s=this.entriesTransferManager.getSyncSource();if(t&&!s){const t=await this.service.getBackupFolderPath(e);t!==e.outputPath&&(e.outputPath=t,this.storage.backup.save(e),this.logger.zsymb(0,"8_fAuO","backup output changed over the last session")),this.machine.send("RESUME_SYNC")}else this.machine.send("START_SYNC");this.setting.value().showSharedWorkerWhenSync&&this.showSharedWorker(),this.dispatchEvent(new Cm.b)},this.startTransferAfterHoldingTempKey=()=>{this.isSyncRunning=!0,this.dispatchEvent(new Cm.d),this.clearNoMissingMessageEventsTimeout(),this.metricts.resetSyncStartTime(),this.logger.zsymb(0,"dlVCWf","start transfer after holding temp key")},this.cancel=async e=>{if(this.metricts.onCloseBanner(),this.metricts.clickCancelSync(),this.setting.value().dontConfirmCancel)return this.metricts.onUserTerminateTransferAfterLogin(),this.logger.zsymb(0,"zQxPKq","cancel sync"),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),void(await this.service.clean());let t,s,a;this.logger.zsymb(0,"FElqeW","prompt cancel sync"),e?(t="STR_CONFIRM_SKIP_SYNC_DB_MSG_TITLE",s="STR_CONFIRM_SKIP_SYNC_DB_MSG_TEXT",a="STR_CONFIRM_SKIP_SYNC_DB_MSG_CONFIRM"):(t="STR_SETTING_MSG_SYNC_POPUP_HEADER",s="STR_SETTING_MSG_SYNC_POPUP_BODY",a="STR_SETTING_MSG_SYNC_POPUP_OK");const[i,n]=await this.helper.showUserConfirm({header:t,message:s,confirm:a,cancel:"STR_SETTING_MSG_SYNC_POPUP_CANCEL",remember:"STR_SETTING_MSG_SYNC_POPUP_DONTASK",primaryButtonType:"secondary-danger"});i?(this.metricts.clickConfirmCancelSyncConfirmModal(),this.logger.zsymb(0,"Gm_-ul",(()=>["user confirm cancel sync",{dontAskAgain:n}])),n&&this.setting.setDontConfirmCancel(n),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),await this.service.clean()):this.metricts.clickCancelInCancelSyncConfirmModal()},this.confirmCancelSyncInSuggestingPopup=async()=>{this.metricts.clickCloseSynGuidePopup();await this.helper.showUserConfirmV2({header:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_TITLE",message:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_DES",confirm:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_BTN_OKE",cancel:"STR_CONFIRM_SYNC_DB_CONFRIM_STOP_BTN_CANCEL",primaryButtonType:"secondary-danger",width:410})&&(this.metricts.clickConfirmCancelSyncConfirmModalFromCounterModal(),this.machine.send("CANCEL"),this.service.cancelTransferMobile(),await this.service.clean())},this.cleanupInMobileBusyBackup=async()=>{this.machine.send("CANCEL"),await this.service.clean()},this.closeCancelSyncInSuggestingPopup=async()=>{this.helper.closeUserCOnfrimV2()},this.reset=()=>{this.machine.send("RESET"),this.metricts.onCloseBanner(),this.ui.clearError(),this.clearAutoCloseSuccessTimeout(),this.clearRequestBackupTimeout(),this.service.clean()},this.pause=async()=>{throw new Error("Method not implemented.")},this.retry=async()=>{this.metricts.clickRetrySync(),this.logger.zsymb(0,"iXPZKs","retry sync"),this.machine.send("RETRY_SYNC"),this.dispatchEvent(new Cm.c)},this.showSuggestPopup=()=>{this.ui.showPopup()},this.closeSuggestPopup=()=>{this.metricts.onClosePopup(),this.ui.hidePopup()},this.rejectSuggest=async()=>{this.metricts.onCloseBanner(),this.logger.zsymb(0,"iVLuPa","prompt user reject suggest sync");const[e,t]=await this.helper.showUserConfirm({header:"STR_SETTING_MSG_SYNC_POPUP_HEADER_START",message:"STR_SETTING_MSG_SYNC_POPUP_BODY_START",confirm:"STR_SETTING_MSG_SYNC_POPUP_OK_START",cancel:"STR_SETTING_MSG_SYNC_POPUP_CANCEL_START",remember:"STR_SETTING_MSG_SYNC_POPUP_DONTSHOW",primaryButtonType:"primary"});e?(this.logger.zsymb(0,"gIXtZq","user confirm reject suggest sync"),t&&(this.logger.zsymb(0,"MVK7Ij","user check dont suggest again"),this.setting.setDontSuggest(!0)),this.metricts.clickContinueInRejectSuggestionConfirmModal(),this.machine.send("CLOSE_SUGGEST"),this.storage.syncSource.clear(),this.setting.setLastCloseSuggest(this.systemTime.getTimeNow())):(this.metricts.clickCacnelInCloseSyncSuggestionConfirmModal(),this.ui.hidePopup(),this.logger.zsymb(0,"55vU01","user cancel"))},this.hideProgress=async()=>{this.setting.value().hideProgress||this.setting.toggleHideProgress(),this.helper.showUserConfirm({width:353,header:"STR_SETTING_MSG_SYNC_NOTICE_HEADER",confirm:"STR_SETTING_MSG_SYNC_NOTICE_OK",primaryButtonType:"neutral",message:Mr.a.createElement("span",null,Mr.a.createElement(Rr.a,{textKey:"STR_HIDE_DB_TOAST",tagName:"div"}),Mr.a.createElement("i",{className:"fa fa-tab-setting internal-icon"}),Mr.a.createElement(Rr.a,{textKey:"STR_SETTING_MSG_SYNC_NOTICE_BODY_BOLD",style:{fontWeight:500}}))})},this.setRequestBackupTimeout=e=>{this.ui.resetStartSyncTime(),this.clearRequestBackupTimeout(),this.requestBackupTimeout=setTimeout((()=>{this.logger.zsymb(0,"E-XLp7","request backup timeout"),this.machine.send("ERR_TIMEOUT")}),this.service.getRequestBackupTimeout(e))},this.setMobileTransferConfirmTimeout=()=>{this.ui.resetStartSyncTime(),this.clearMobileTransferConfirmTimeout();const e=this.service.getMobileTransferConfirmTimeout();e>0?this.mobileTransferConfirmTimeout=setTimeout((()=>{this.logger.zsymb(0,"DOFuzO","mobile auto confirm timeout"),this.machine.send("MOBILE_CONFIRM_TIMEOUT")}),e):this.machine.send("MOBILE_CONFIRM_TIMEOUT")},this.setNoMissingMessageEventsTimeout=()=>{this.clearNoMissingMessageEventsTimeout();const e=this.service.getNoMissingMessageEventsTimeout();e>0?this.waitingForMissingMessageEventsTimeout=setTimeout((()=>{this.logger.zsymb(0,"mvh1xL","waiting for no missing events timeout"),this.machine.send("WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT")}),e):this.machine.send("WAITING_FOR_NO_MISSING_MESSAGE_EVENTS_TIMEOUT")},this.clearRequestBackupTimeout=()=>{this.requestBackupTimeout&&(clearTimeout(this.requestBackupTimeout),this.requestBackupTimeout=null)},this.clearMobileTransferConfirmTimeout=()=>{this.mobileTransferConfirmTimeout&&(clearTimeout(this.mobileTransferConfirmTimeout),this.mobileTransferConfirmTimeout=null)},this.clearNoMissingMessageEventsTimeout=()=>{this.waitingForMissingMessageEventsTimeout&&(clearTimeout(this.waitingForMissingMessageEventsTimeout),this.waitingForMissingMessageEventsTimeout=null)},this.setAutoCloseSuccessTimeout=()=>{this.autoCloseSuccessTimeout=setTimeout((()=>{this.logger.zsymb(0,"mSi6UF","auto close success timeout"),this.machine.send("AUTO_CLOSE")}),this.service.getCloseSuccessTimeout())},this.clearAutoCloseSuccessTimeout=()=>{this.autoCloseSuccessTimeout&&(clearTimeout(this.autoCloseSuccessTimeout),this.autoCloseSuccessTimeout=null)},this.resendRequest=async()=>this.service.request(0,1),this.handleCtrlEvents=e=>{const t=this.service.session;if(!t)return this.logger.zsymb(18,"Z-Ds7a","received control event but no session"),void this.metricts.onReqBackupFailure(om.g.SELF_DEFINE,om.h.NO_SESSION);for(const i of e){if(Cm.a.isUserConfirm(t,i))return void this.machine.send({type:"USER_CONFIRM"});if(Cm.a.isUserReject(t,i))return void this.machine.send({type:"USER_REJECT"});if(lm.a.isEnableSyncIdleMobileState()&&Cm.a.isMobileIdle(t,i))return this.metricts.onMobileIdle(),void this.ui.showMobileIdleInBackup();if(lm.a.isEnableSyncIdleMobileState()&&Cm.a.isMobileActive(t,i))return void this.ui.showWaitForBackup();if(Cm.a.isBackupSuccess(t,i)){var s;let e;try{e=JSON.parse(i.data.db_info)}catch(a){return this.logger.zsymb(18,"fPUciQ",(()=>["parse db info fail",{error:a.message}])),this.metricts.onReqBackupFailure(om.g.SELF_DEFINE,om.h.CANT_PASE_DB_INFO),void this.machine.send("ERR_INVALID_BACKUP")}let t=0,n=0;try{e.backup_db&&(t=e.backup_db.msg_thread,n=e.backup_db.msg_total),e.origin_db&&(t=e.origin_db.msg_thread,n=e.origin_db.msg_total)}catch(a){return this.logger.zsymb(18,"B8bXPL",(()=>["parse db info fail",{error:a.message}])),this.metricts.onReqBackupFailure(om.g.SELF_DEFINE,om.h.CANT_PASE_DB_INFO),void this.machine.send("ERR_INVALID_BACKUP")}const r=null!==(s=e.db_format)&&void 0!==s?s:0;this.metricts.onReqBackupSuccess(r);const o=this.storage.syncSource.get();this.metricts.setLastSyncSource(o),this.storage.backup.save({rawUid:i.data.uid,userId:this.currentUserId,uin:this.currentUserUIN,fromSeqId:i.data.from_seq_id,isFull:!!i.data.is_full_transfer,name:i.data.file_name,url:i.data.url,checksum:i.data.checksum_code||i.data.checksum||"",publicKey:i.data.public_key,encryptedKey:i.data.encrypted_key,privateKey:"",format:r,inputPath:"",outputPath:"",numberOfConversationsCount:t,numberOfMessagesCount:n,conversations:[]});const c=this.setting.value();return this.storage.syncState.resetCheckpoint(r,c.minSeq,c.maxSeq),this.logger.zsymb(0,"6j3rq2",(()=>["received backup",{format:r,msgCount:n,threadCount:t}])),void this.machine.send("SUCCESS")}if(Cm.a.isBackupFail(t,i))return void this.machine.send("ERR_BACKUP_FAIL");if(Cm.a.isMobileRestoring(t,i))return void this.machine.send("ERR_BUSY_RESTORING");kc.default.increaseFailed(om.f.REQ_BACKUP,0,0,om.h.UNKNOWN_EVENT,Date.now()),this.logger.zsymb(18,"5831g0",(()=>["unknown control event",{event:i}]))}},this.handleTransferAfterLoginCtrlEvents=e=>{if(!this.shouldProcessTransferAfterLogin())return;const t=this.validateTransferWhenLoginEvents(e);t&&this.processTransferWhenLogin(t)},this.shouldProcessTransferAfterLogin=()=>{const e=!a.ModuleContainer.resolve(vu.b).didBlockApp;return this.logger.zsymb(0,"DaeOIV",`should process transfer after login: ${e}`),e},this.validateTransferWhenLoginEvents=e=>{try{const t=e.filter((e=>Cm.a.isTransferAfterLoginControlEvent(e)));if(0===t.length)return null;t.sort(((e,t)=>e.ts-t.ts)),this.logger.zsymb(0,"wzOIkr",(()=>["sorted and filtered transfer events",t]));const s=t[t.length-1];if(this.systemTime.getTimeNow()-s.ts<=om.k)return s;this.logger.zsymb(0,"Kld8lz","No valid temp key in this control batch")}catch(t){this.logger.zsymb(0,"xb6ug8","failed to validate transfer when login events",t)}return null},this.processTransferWhenLogin=e=>{this.logger.zsymb(0,"BN82bs","tempKey for transfer when login arrived",e),this.logTempKeyArrivalTimestamp(),Zm.k.GetManager().setIsTransferAfterLogin(!0),Zm.k.GetManager().hideTransferMessagesModal();let t=e.data.temp_key;switch(this.storage.tempKeySource.get()){case om.m.ARBITRARY:t="arbitrary temp key";break;case om.m.EMPTY:t=""}this.machine.send({type:"START_AUTO_SYNC",tempKey:t})},this.registerEventListenerForTransferWhenLogin=()=>{this.messageReadinessChecker.addEventListener(Xm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleNoMissingMessageEvents),_e.default.subscribe(this.handleOverFlowQueue)},this.handleNoMissingMessageEvents=()=>{this.logger.zsymb(0,"fg2trE","No missing message events, send event HAVE_NO_MISSING_MESSAGE_EVENT"),this.machine.send("HAVE_NO_MISSING_MESSAGE_EVENT"),this.messageReadinessChecker.removeEventListener(Xm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleNoMissingMessageEvents)},this.handleOverFlowQueue=(e,t)=>{if(e===ve.FetchActions.CHECK_OVERFLOW_QUEUE_BY_FLAG){if(!t.queueId)return;this.machine.send("HAVE_MISSING_MESSAGE_EVENTS"),_e.default.unsubscribe(this.handleOverFlowQueue)}},this.logTempKeyArrivalTimestamp=()=>{try{var e;this.storage.tempKeySource.setArrivalTimestamp(null!==(e=Ct.default.getSystemTimeNow())&&void 0!==e?e:0)}catch(t){}},this.machine=a.ModuleContainer.resolveToken(Wm),this.logger=t.createZLogger(w.ZLoggerNametags.msgSync,[w.ZLoggerNametags.controller,"daivd"]),this.config=e,this.service=i,this.setting=s,this.storage=r,this.ui=n,this.helper=o,this.metricts=c,this.systemTime=d,this.entriesTransferManager=l,this.messageReadinessChecker=u}isEnable(){const e=this.config.get("cross_setting.offFeature"),t=this.config.get("cross_setting.enable");return!e&&t}isEnableBySrc(e){if(this.metricts.onCheckSyncSuggestion(e),!this.isEnable())return!1;switch(e){case om.j.FIRST_TIME_LOGIN:return this.config.get("cross_setting.enableFirstTimeUse");case om.j.MANUAL:return this.config.get("cross_setting.enableManual");case om.j.OVERFLOW:return this.config.get("cross_setting.enableOverQueue");case om.j.E2EE_MISSING_MESSAGE:return this.config.get("notify_missing_e2ee_message.enable")}return!0}isEnableResume(){return!!this.isEnable()&&this.config.get("cross_setting.enableResume")}canSync(e){return this.isEnableBySrc(e)?this.machine.canStartNewSync()?om.a.OK:om.a.INVALID_STATE:om.a.DISABLED}isThisSessionSyncing(){return this.isSyncRunning}onStart(){if(this.isEnable()){this.logger.zsymb(0,"SmavBO","initialize");try{this.machine.create(),this.machine.start()}catch(e){return void this.logger.zsymb(18,"1pOSq4",(()=>["start error",{error:e}]))}this.initialized=!0,""!==this.currentUserId&&this.checkSuggestWhenReady(),this.registerEventListenerForTransferWhenLogin(),a.ModuleContainer.resolve(Jm.AFMC_TModule).get(Jm.AFMC_TController).addEventListener(Ym.a.SHOW_SYNC_MESSAGE_SUGGESTION,(e=>{const t=e.queueId;if(!t)return;if(this.setting.value().dontSuggest)return void this.logger.zsymb(3,"3CwPq0",["queue is full, but user has already disable sync suggestion","wGEttX"]);if(!this.isEnableBySrc(om.j.OVERFLOW))return void this.logger.zsymb(0,"OYwdDR","sync when overflow is not enable");const s=this.config.get("cross_setting.timeBetweenSync")||0,a=this.setting.value().lastSync;if(s>0&&a>0){const e=a+60*s*1e3;if(e>Date.now())return void this.logger.zsymb(0,"2-lLU4",`queue is full, but user has already sync in time. next sync: ${new Date(e).toLocaleString()}`)}const i=this.config.get("msg_sync.overflow_queue");if(i){if(i.some((e=>t==e)))return void this.delayedSuggestSync(om.j.OVERFLOW,!1)}else this.logger.zsymb(0,"2JJpb2","queue evict is not set")})),this.entriesTransferManager.addEventListener($m.a.NotifyE2eeConvChangeDevice,(e=>{if(e.type===$m.a.NotifyE2eeConvChangeDevice){if(this.machine.send({type:"HAVE_MISSING_MESSAGE_EVENTS"}),this.setting.value().dontSuggest)return void this.logger.zsymb(3,"QHXs_D",["Change device and has e2ee convs, but user has already disable sync suggestion","T-2lJz"]);if(!this.isEnableBySrc(om.j.E2EE_MISSING_MESSAGE))return void this.logger.zsymb(0,"wydSaA","Sync when change device and has e2ee convs is not enable");const e=this.config.get("cross_setting.timeBetweenSync")||0,t=this.setting.value().lastSync;if(e>0&&t>0){const s=t+60*e*1e3;if(s>Date.now())return void this.logger.zsymb(0,"mkBm49",`Change device and has e2ee convs, but user has already sync in time. next sync: ${new Date(s).toLocaleString()}`)}this.entriesTransferManager.getSyncSource()===om.j.E2EE_MISSING_MESSAGE&&(this.logger.zsymb(0,"GBX7Q5","Suggest sync by [NotifyE2eeConvChangeDevice] event"),this.delayedSuggestSync(om.j.E2EE_MISSING_MESSAGE,!1))}}))}else this.logger.zsymb(0,"rQgUFq","feature is not enable")}onAuthenticated(e){this.storage.load(e.getSession().userId),this.setting.load(e.getSession().userId),this.currentUserId=e.getSession().userId,this.currentUserUIN=e.getSession().UIN||"",setTimeout((()=>{if(!this.isThisSessionSyncing()){Dc.a.getInstance().resumeIdx()}}),5e3),this.initialized&&setTimeout(this.checkSuggestWhenReady.bind(this),1e3)}onDispose(){this.service.abortRestore(),this.machine.status===Km.b.Running&&this.machine.stop()}delayedSuggestSync(e,t=!0,s=!1){setTimeout((()=>this.suggestSync(e,t,s)),Qm.a.transfer_when_login.time_wait_for_temp_key)}delayedSuggestResume(e){setTimeout((()=>this.suggestResume()),e)}terminateTransferWhenLogin(){this.service.clean(),this.clearNoMissingMessageEventsTimeout(),this.logger.zsymb(0,"wX-Q3L","cleaning for terminate transfer when login")}prepareSearchAfterSync(){const e=Dc.a.getInstance();e.resumeIdx(),setTimeout((()=>{e.isEnableSearchSqlite&&a.ModuleContainer.resolve(Nc.b).loadOldestTime()}),500)}onTerminateTransferWhenLoginSuccess(){this.isSyncRunning=!1,this.metricts.terminateTransferWhenLogin()}onSyncSuccess(){this.isSyncRunning=!1,this.prepareSearchAfterSync(),this.dispatchEvent(new Cm.g)}onSyncFailed(){const e=this.ui.getCurrentError();e&&this.metricts.onSyncFailed(e),this.isSyncRunning=!1,this.prepareSearchAfterSync(),this.dispatchEvent(new Cm.f)}onSyncCanceled(){this.isSyncRunning=!1,this.dispatchEvent(new Cm.f),this.prepareSearchAfterSync()}onNetworkError(){this.dispatchEvent(new Cm.f)}async restartSync(){this.metricts.resetSyncStartTime(),this.machine.send("RESTART_SYNC")}get tempKeySource(){return this.storage.tempKeySource.get()}set tempKeySource(e){this.storage.tempKeySource.save(e)}makeMobileActive(){this.ui.showWaitForBackup()}makeMobileIdle(){this.ui.showMobileIdleInBackup()}currentSyncSource(){return this.storage.syncSource.get()}getCurrentSyncScreenState(){return this.ui.getCurrentScreen()}async checkSuggestWhenReady(){this.logger.zsymb(0,"NAzBVQ","checking for sync suggestion"),this.setting.value().dontSuggest?this.logger.zsymb(0,"umfc7h","user don't want to suggest sync"):await this.checkForSuggestFirstLogin().catch((e=>(this.logger.zsymb(18,"L1Yov-",(()=>["checkForSuggestFirstLogin failed",e])),!1)))||await this.checkLastStateForSuggestResumeOrNewSync().catch((e=>(this.logger.zsymb(18,"gE51eH",(()=>["checkLastStateForSuggestResumeOrNewSync failed",e])),!1)))||await this.checkPendingRequestSync().catch((e=>(this.logger.zsymb(18,"JEp_Hp",(()=>["checkPendingRequestSync failed",e])),!1)))||await this.checkStateForSuggestSyncFromOtherEntries().catch((e=>(this.logger.zsymb(18,"3rodpx",(()=>["checkStateForSuggestSyncFromOtherEntries failed",e])),!1)))||this.logger.zsymb(3,"SDXPuy",["no sync suggestion","dyjVbt"])}async checkForSuggestFirstLogin(){const e=n.default.getInstance();let t=e.getItem("z_needSyncMsg");if(t&&JSON.parse(t)){if(e.removeItem("z_needSyncMsg"),this.isEnableBySrc(om.j.FIRST_TIME_LOGIN)&&!Zm.k.GetManager().isEnabledFeature())return this.delayedSuggestSync(om.j.FIRST_TIME_LOGIN),!0;this.logger.zsymb(0,"4SnHP3","first login sync is disabled")}return!1}showSharedWorker(){$zsharedWorker.show()}async checkPendingRequestSync(){if(!this.initialized)return this.logger.zsymb(18,"h9Ea9g","check pending request sync but not ready"),!1;if(this.requestedSuggestSync){const e=this.requestedSuggestSync;if(this.requestedSuggestSync=null,this.isEnableBySrc(e))return this.delayedSuggestSync(e),!0;this.logger.zsymb(0,"LDNzLr",`${e} sync is disabled`)}return!1}async checkLastStateForSuggestResumeOrNewSync(){if(this.storage.syncState.isStarted)return this.isEnableResume()?this.delayedSuggestResume(Qm.a.transfer_when_login.time_wait_for_temp_key):(this.logger.zsymb(0,"CvJhMF","resume sync is disabled"),this.storage.clear()),!0;const e=this.storage.syncSource.get();return"number"==typeof e&&(this.requestedSuggestSync=null,this.isEnableBySrc(e)?this.delayedSuggestSync(e,!1,!0):(this.logger.zsymb(0,"y-NOn-",`${e} sync is disabled`),this.storage.clear()),!0)}async checkStateForSuggestSyncFromOtherEntries(){if(this.storage.syncState.isStarted)return this.isEnableResume()?this.delayedSuggestResume(Qm.a.transfer_when_login.time_wait_for_temp_key):(this.logger.zsymb(0,"ehj_y5","resume sync is disabled"),this.storage.clear()),!0;const e=this.entriesTransferManager.getSyncSource();return"number"==typeof e&&(this.requestedSuggestSync=null,this.isEnableBySrc(e)?(this.logger.zsymb(0,"hDFHqO","Suggest sync with cached entry transfer before"),this.delayedSuggestSync(e,!1)):(this.logger.zsymb(0,"CtlD-p",`${e} sync is disabled`),this.storage.clear()),!0)}})||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm)||qm);var ep=s("3jnX"),tp=s("nhJq");class sp{constructor(e,t,s){this.hostName=void 0,this.key=void 0,this.keyDecryptor=void 0,this.folderBackupName=void 0,this.hostName=e,this.key=t,this.keyDecryptor=s,this.folderBackupName=this.createFolderBackupName()}get publicKey(){return this.key.publicKey}get sessionFolderBackupName(){return this.folderBackupName}createFolderBackupName(){return`blob_${Object(lm.b)()}`}isSame(e){return this.hostName===e.hostName&&this.key===e.key}decryptKey(e,t){return this.keyDecryptor(e,t,this.key)}static create(e,t){return new sp(e,t.generate(),t.decryptKey.bind(t))}}class ap extends ep.b{constructor(e){super({type:"DECRYPT_BACKUP",params:e})}}class ip extends ep.b{constructor(e,t){super({type:"RESTORE_MESSAGES",params:e,checkpoint:t}),this.handleEventBusMessage=(e,t)=>{if("SELECT_CONVERSATION"===e){const e=t.userId;this.params.meta.viewingConversation!==e&&this.changeParams({meta:Object(I.a)(Object(I.a)({},this.params.meta),{},{viewingConversation:e})})}}}run(){return this.startListenEventBus(),this.addEventListenerOnce(ep.c.Finalized,(()=>{this.stopListenEventBus()})),super.run()}startListenEventBus(){this.stopListenEventBus(),_e.default.subscribe(this.handleEventBusMessage)}stopListenEventBus(){_e.default.unsubscribe(this.handleEventBusMessage)}}class np extends ep.b{constructor(e){super({type:"RESTORE_CONVERSATIONS",params:e})}}var rp,op=s("qUG6"),cp=s("1erv");const lp=$znode.path;Object(a.injectable)()(rp=Object(a.singleton)(_m)(rp=Object(As.f)()(rp=Object(As.e)()(rp=function(e,t){return Object(a.inject)(Om)(e,void 0,0)}(rp=function(e,t){return Object(a.inject)(Sm.a)(e,void 0,1)}(rp=function(e,t){return Object(a.inject)(Am.b)(e,void 0,2)}(rp=function(e,t){return Object(a.inject)(hm)(e,void 0,3)}(rp=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,4)}(rp=function(e,t){return Object(a.inject)(km)(e,void 0,5)}(rp=function(e,t){return Object(a.inject)(Fm.a)(e,void 0,6)}(rp=Reflect.metadata("design:type",Function)(rp=Reflect.metadata("design:paramtypes",[void 0===Om?Object:Om,void 0===Sm.a?Object:Sm.a,void 0===Am.b?Object:Am.b,void 0===hm?Object:hm,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===km?Object:km,Object])(rp=class{constructor(e,t,s,a,i,n,r){this.session=void 0,this.hostName=void 0,this.keyGenerator=void 0,this.storage=void 0,this.setting=void 0,this.ui=void 0,this.logger=void 0,this._currentTask=null,this.metricts=void 0,this.messageReadinessChecker=void 0,this.logger=i.createZLogger(w.ZLoggerNametags.msgSync,[w.ZLoggerNametags.service]),this.storage=e,this.setting=t,this.ui=s,this.keyGenerator=a,this.hostName=$znode.os.hostname(),this.session=null,this.metricts=n,this.messageReadinessChecker=r}get currentSession(){return this.session||(this.session=this.newSession()),this.session}get queueIndexSearch(){return!1}onSessionExpired(){this.logger.zsymb(0,"subJ1R","onSessionExpired"),this.session&&this.cancelTransferMobile(),this.cleanUrgent(!0)}onDispose(){this.logger.zsymb(0,"EcwnpH","onDispose"),Me.g.isRememberMe()||this.cleanUrgent()}isNoMissingMessageEventsArrived(){return this.messageReadinessChecker.isNoMissingMessageEventsArrived()}isAtLeastOneMissingMessageEventArrived(){return this.messageReadinessChecker.isAtLeastOneMissingMessageEventArrived()}shouldTransferWhenLogin(){let e=n.default.getInstance().getItem("z_needSyncMsg");const t=this.storage.syncState.isStarted,s="number"==typeof this.storage.syncSource.get(),a=this.messageReadinessChecker.isMessageReady(),i=e&&JSON.parse(e)||t||s||!a;return this.logger.zsymb(0,"FVp41_",`shouldTransfer: ${i}, isMessageReady: ${a}, needSync: ${e}, isStarted: ${t}, syncSrc : ${this.storage.syncSource.get()}`),i}async prepareNewSync(){var e;await this.abortRestore(),null!==(e=Ce.default.cross_setting)&&void 0!==e&&e.enable_break_folder_db_as_session||await this.cleanupTempFiles(),this.session=null,this.storage.syncState.reset();const t=this.setting.value();this.storage.syncState.resetCheckpoint(0,t.minSeq,t.maxSeq)}request(e=0,t=0,s=""){this.messageReadinessChecker.isDBCorruptedThatNeedToTransferFull()&&(this.setting.resetMinMaxSeq(),this.logger.zsymb(9,"YHGwUz",["DB corrupt detected, transfer full message","RJYOx_"]));const a=this.currentSession.publicKey,i=this.setting.value(),n=i.maxSeq,r=i.minSeq,o=Lo.a.newReq();return this.logger.zsymb(0,"Y0ylxf",(()=>["sent request backup",{id:o,max:n,min:r,retry:e,resend:t,key:a}])),So.default.pullMobileMsg(a,n,o,t,r,s).then(Co.a).catch((s=>{throw this.logger.zsymb(0,"sfTJQE",(()=>["failed to send request backup",{id:o,max:n,min:r,retry:e,resend:t,error:s}])),e>0&&(this.session=null),s}))}async clean(){this.logger.zsymb(0,"T0vREl","abort current task"),await this.abortRestore(),this.logger.zsymb(0,"IR9FHE","clean storage"),await this.cleanupTempFiles(),this.storage.clear(),this.logger.zsymb(0,"d0ic2A","clean session"),this.session=null,this.logger.zsymb(0,"V1v0ag","cleanup done")}async download(e=0){this.logger.zsymb(0,"K36e8s",(()=>["downloading backup",{retry:e}]));const t=this.storage.backup.get();if(!t)return this.metricts.onDownloadBackupFailure(om.g.SELF_DEFINE,om.b.BACKUP_NOT_FOUND),Promise.reject("No backup found");await tt.default.run({type:tt.default.constants.DownloadType.File,data:{fileName:t.name,url:t.url,checksum:t.checksum},options:{saveDir:await this.getBackupDirFolderPath(),caching:!0,duplicate:!1,srcAction:tt.default.constants.srcAction.Dev,showProgress:{taskBar:!1,progressBar:!0,progressChannel:"UPDATE_CHANNEL_CROSS_DB",progressChannelId:t.checksum},onProgress:(e=>{e>0&&this.ui.setProgress(e)}).bind(this),noiseDownload:!1,timeOut:1e4,cookies:!0,preventTransform:!0}}),this.ui.setProgress(100);const s=lp.join(await this.getBackupDirFolderPath(),t.name);t.inputPath=s,this.storage.backup.save(t)}async decrypt(){const e=this.storage.backup.get();if(!e)return Promise.reject("no backup found");if(0===e.numberOfMessagesCount)return;const t=e.format?"hex":"base64",s=e.encryptedKey,i=this.currentSession.decryptKey(s,t),n=await this.getBackupFolderPath(e);e.outputPath=n,e.sessionOutputFolder=this.currentSession.sessionFolderBackupName,e.privateKey=i,this.storage.backup.save(e);const r=new ap({inputPath:e.inputPath,outputPath:e.outputPath,privateKey:e.privateKey,format:1===e.format?1:0,numberOfConversationsCount:e.numberOfConversationsCount});(async()=>{let e=0,t=setInterval((()=>{e+=5,this.ui.getCurrentScreen()===Am.a.DecryptingBackup?this.ui.setProgress(e):clearInterval(t),100===e&&clearInterval(t)}),2e3)})(),this._currentTask=r,await a.ModuleContainer.resolve(vu.b).waitMigrateRelease(),a.ModuleContainer.resolveToken(Wm).isMachineIdle()?this.logger.zsymb(0,"uxs9gX","Skip decrypt, transfer flow is aborded!"):await r.run()}async restore(e){Dc.a.getInstance().pauseIdx(),this.logger.zsymb(0,"jGKdzA",(()=>["restoring backup",{retry:e}]));const t=this.storage.backup.get();if(!t||0===t.numberOfMessagesCount)return void this.ui.setNumOfSyncedConv(0);const s=this.storage.syncState.step;s<=Em.RESTORE_CONVERSATIONS&&(this.storage.syncState.isSyncing=!0,await this._restoreConversations().catch((e=>{throw this.logger.zsymb(18,"NdmZ5l",(()=>["restore conversations failed",{error:e}])),this.metricts.onRestoreDataFailure(om.i.RESTORE_CONV_ERR),e})),this.storage.syncState.nextStep());let a={trackInfo:{}};if(s<=Em.RESTORE_MESSAGES&&(a=await this.restoreMessages().catch((e=>{throw this.logger.zsymb(18,"imGD8c",(()=>["restore messages failed",{error:e}])),this.metricts.onRestoreDataFailure(om.i.RESTORE_MSGS_ERR),e})),this.storage.syncState.nextStep()),s<=Em.UPDATE_MESSAGES_CACHE){const e=this.setting.value().lastSync,s=e?(Date.now()-e)/864e5:-1;return this.setting.setLastSync(Date.now()),this.metricts.onRestoreDataSuccess(),void this.metricts.onSyncSuccess(t.format,this.storage.syncState.checkpoint.importedMessages,t.numberOfMessagesCount,a.trackInfo,Number(s.toFixed(2)))}throw new Error("unknown step")}async getBackupDirRootFolderPath(){const e=await Object(wi.getuserDataDir)();return lp.join(e,"blob")}async getBackupDirSessionFolderPath(e){const t=e||this.currentSession.sessionFolderBackupName;return lp.join(await this.getBackupDirRootFolderPath(),t)}async getBackupDirFolderPath(e){return Ce.default.cross_setting.enable_break_folder_db_as_session?await this.getBackupDirSessionFolderPath(e):await this.getBackupDirRootFolderPath()}async getBackupFolderPath(e){return lp.join(await this.getBackupDirFolderPath(e.sessionOutputFolder),e.name+"_tmp")}async restoreMessages(){this.logger.zsymb(0,"fAxLMi","restore messages");const e=this.storage.backup.get(),t=a.ModuleContainer.resolve(rc.SidebarController),s=new ip({backupPath:e.outputPath,plainUserId:e.rawUid,noiseUserId:e.userId,password:e.uin,format:e.format,conversations:e.conversations,shouldUseNewMediaDBFlowConfig:Object(cp.a)(),meta:{queueIndexSearch:this.queueIndexSearch,viewingConversation:t.getSelectedId(),cachedRanges:{},numberOfMessages:e.numberOfMessagesCount,numberOfConversations:e.numberOfConversationsCount}},this.storage.syncState.checkpoint);if(s.addEventListener(ep.c.Progress,(e=>{e.progress>0&&this.ui.setProgress(e.progress);const t=e.checkpoint;t&&(this.storage.syncState.checkpoint=t)})),s.addEventListenerOnce(ep.c.Completed,(()=>{if(0==e.format)this.ui.setNumOfSyncedConv(e.numberOfConversationsCount);else{const t=e.numberOfConversationsCount,s=this.storage.syncState.checkpoint.updatedConversation;this.ui.setNumOfSyncedConv(s),this.logger.zsymb(0,"eBrDW8","completed sync",s,t)}this.setting.setMinSeq(this.storage.syncState.checkpoint.minSeq),this.setting.setMaxSeq(this.storage.syncState.checkpoint.maxSeq)})),this._currentTask=s,await a.ModuleContainer.resolve(vu.b).waitMigrateRelease(),!a.ModuleContainer.resolveToken(Wm).isMachineIdle())return s.run();this.logger.zsymb(0,"2LnUzO","Skip restore message, transfer flow is aborded!")}async _restoreConversations(){this.logger.zsymb(0,"t_i9uX","restore conversations");let e=this.storage.backup.get();const t=new np({backupPath:e.outputPath,format:e.format,plainUserId:e.rawUid,noiseUserId:e.userId,password:e.uin,shouldUseNewMediaDBFlowConfig:Object(cp.a)(),meta:{queueIndexSearch:this.queueIndexSearch}});if(this._currentTask=t,await a.ModuleContainer.resolve(vu.b).waitMigrateRelease(),a.ModuleContainer.resolveToken(Wm).isMachineIdle())return void this.logger.zsymb(0,"IStQun","Skip restore conversation, transfer flow is aborded!");const s=await t.run(),i=(await this._validateConversations(s)).filter((e=>!e.shouldIgnore)),n=i.filter((e=>!e.isExist)),r=i.filter((e=>!!e.lastMessage));if(n.length>0&&await this._createNewImportConversations(n).catch((e=>{this.logger.zsymb(18,"v9Gb6m",(()=>["create new import conversations failed. but continue",{error:e}]))})),r.length>0){const e=r.map((e=>e.lastMessage));this._updatePreviewOfConversations(e)}e=this.storage.backup.save(Object(I.a)(Object(I.a)({},e),{},{conversations:i.map((e=>({plainId:e.plainId,noiseId:e.noiseId,isGroup:e.isGroup,hasPreviewMsg:!!e.lastMessage,shouldIgnore:e.shouldIgnore})))}));const o=this.storage.syncState.checkpoint;if(1===o.format){const e=Object(I.a)({},o);let t=i.filter((e=>!!e.lastMessage)).sort(((e,t)=>t.lastMessage.localDttm-e.lastMessage.localDttm)).map((e=>e.plainId));t=t.concat(i.filter((e=>!e.lastMessage)).map((e=>e.plainId))),e.priorities=t,e.currentSeq={},this.storage.syncState.checkpoint=e}}_updatePreviewOfConversations(e){new op.a(e).run()}async _createNewImportConversations(e){const t=a.ModuleContainer.resolve(Nn.ConvInfoDataManager);await Promise.all(e.map((e=>{var s,a;t.addIfNotExistsConv(e.noiseId,e.isGroup,null===(s=e.lastMessage)||void 0===s?void 0:s.msgId,null===(a=e.lastMessage)||void 0===a?void 0:a.msgId,_o.default.isMyMessage(e.lastMessage),1)})))}async _validateConversations(e){const t=[],s=[];for(const o of e)o.isGroup?s.push(o.noisedId):t.push(o.noisedId);const[a,i]=await Promise.all([Ii.default.getProfileFriendByIds(t).catch((e=>(this.logger.zsymb(18,"zZvmX0",(()=>["validate friend error",{error:e}])),{}))),yn.default.getGroupsByIds(s).catch((e=>(this.logger.zsymb(18,"nvvoBG",(()=>["validate group error",{error:e}])),{})))]),n=e.map((e=>({plainId:e.plainId,noiseId:e.noisedId,isExist:!!me.a.ConvInfoDataManager.getConvByIdSync(e.noisedId),isGroup:e.isGroup,hasPreview:!!e.lastMessage,lastMessage:e.lastMessage,shouldIgnore:!a[e.noisedId]&&!i[e.noisedId]}))),r=n.filter((e=>!e.shouldIgnore)).length;return this.logger.zsymb(0,"QcQqo4",(()=>["validate conversations done",{total:e.length,valid:r}])),n}async cleanUrgent(e){this.abortRestore(),this.logger.zsymb(0,"P4FD_s","abort restore"),this.storage.clear(e),this.logger.zsymb(0,"JDmvH1","clean storage"),this.session=null,this.logger.zsymb(0,"PA2AtA","clean session"),$zdb.abortSyncMsg({reason:"session-expired",path:await this.getBackupDirRootFolderPath()})}cancelTransferMobile(){const e=this.currentSession.publicKey,t=Lo.a.newReq();this.logger.zsymb(0,"R2i9Eb",(()=>["cancel request backup",{id:t,key:e}])),So.default.cancelTransferMessage(t,e).then(Co.a).then((e=>{this.logger.zsymb(0,"FkTyaQ",(()=>["success to cancel request backup",{id:t,res:e}]))})).catch((s=>{throw this.logger.zsymb(0,"mUqArT",(()=>["failed to cancel request backup",{id:t,key:e,error:s}])),s}))}async abortRestore(){this._currentTask&&await this._currentTask.abort(),this._currentTask=null}getRequestBackupTimeout(e){if(e)return 1e3*Ce.default.cross_setting.waitDbTimeout;const t=1e3*Ce.default.cross_setting.cfTimeout;return Math.max(0,t-(Date.now()-this.ui.getStartSyncTime()))}getMobileTransferConfirmTimeout(){let e=Qm.a.transfer_when_login.mobile_transfer_confirm_timeout;const t=Ce.default.transfer_when_login.mobile_transfer_confirm_timeout;return"number"==typeof t&&t>=0&&(e=t),e}getNoMissingMessageEventsTimeout(){let e=Qm.a.transfer_when_login.no_missing_message_events_timeout;const t=Ce.default.transfer_when_login.no_missing_message_events_timeout;return"number"==typeof t&&t>=0&&(e=t),e}getEnabledDropTransferWhenLoginFlowConfig(){let e=Qm.a.transfer_when_login.enable_drop_flow;const t=Ce.default.transfer_when_login.enable_drop_flow;return"boolean"==typeof t&&(e=t),e}getSuccessBannerWhenDropTransferWhenLoginConfig(){let e=Qm.a.transfer_when_login.success_banner_when_drop;const t=Ce.default.transfer_when_login.success_banner_when_drop;return"boolean"==typeof t&&(e=t),e}getEnableLogEventsArrivalTimeConfig(){let e=Qm.a.transfer_when_login.enable_log_events_arrival_time;const t=Ce.default.transfer_when_login.enable_log_events_arrival_time;return"boolean"==typeof t&&(e=t),e}getEventsArrivalTimeSubmitLogTimeout(){return Qm.a.transfer_when_login.timeout_submit_events_arrival_time_log}getCloseSuccessTimeout(){return 1e3*Ce.default.cross_setting.closeSuccessTimeout||1e4}async cleanupTempFiles(){this.logger.zsymb(0,"uaYV9f","remove temp files"),await tp.b(await this.getBackupDirRootFolderPath()).catch((e=>{this.logger.zsymb(18,"zIL14k",(()=>["remove temp failed",{err:e}]))}))}newSession(){return sp.create(this.hostName,this.keyGenerator)}getHardcodeError(e){return 0}})||rp)||rp)||rp)||rp)||rp)||rp)||rp)||rp)||rp)||rp)||rp)||rp);var dp,up;const hp=new Map;Object(m.j)()(dp=Object(a.injectable)()(dp=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(dp=Reflect.metadata("design:type",Function)(dp=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(dp=class extends ep.a{constructor(e){super(),this.logger=void 0,this.logger=e.createZLogger("sync-message",["noise-id-handler"])}async execute({params:e}){const t=e.uids.length+e.gids.length;return 0===t?[]:t>1e4?Promise.all([this.getNoiseIdFromServer(e.uids,[]),this.getNoiseIdFromServer([],e.gids)]).then((([e,t])=>[...e,...t])):this.getNoiseIdFromServer(e.uids,e.gids)}async getNoiseIdFromServer(e,t){let s=e.map((e=>Number.parseInt(e))),a=t.map((e=>Number.parseInt(e)));const i=await So.default.getnuid(s,a).then(Co.a).catch((s=>{this.logger.zsymb(18,"9DLZb7",(()=>["get noise id from server error",s]));const a=s.code||s.error_code;if(a===Y.NetWorkError.NO_NETWORK||-69===a)throw kc.default.increaseFailed(om.f.REQ_NOISE_ID,0,0,om.d.NO_NET_OR_TOO_MUCH_REQ,Date.now()),s;return this.logger.zsymb(0,"Qc39rU",(()=>["return empty result for ids:",{uids:e,gids:t}])),kc.default.increaseFailed(om.f.REQ_NOISE_ID,0,0,s.error_code,Date.now()),{fids:[],gids:[]}}));if(s.length>0&&s.length!==i.fids.length)throw this.logger.zsymb(18,"1aBGBI",`data mismatch: uids: ${s.length}, fids: ${i.fids.length}`),kc.default.increaseFailed(om.f.REQ_NOISE_ID,0,0,om.d.U_MIS_MATCH,Date.now()),new Error("data mismatch reason:uids");if(a.length>0&&a.length!==i.gids.length)throw this.logger.zsymb(18,"uxpEgM",`data mismatch: gids: ${a.length}, gids: ${i.gids.length}`),kc.default.increaseFailed(om.f.REQ_NOISE_ID,0,0,om.d.G_MIS_MATCH,Date.now()),new Error("data mismatch reason:gids");let n=[];return i.gids&&i.gids.forEach(((e,s)=>{e=e.startsWith("g")?e:`g${e}`,n.push([t[s],e]),hp.set(t[s],e)})),i.fids&&i.fids.forEach(((t,s)=>{const a=`g${t}`;yn.default.getGroupByIdSync(a)?(n.push([e[s],a]),hp.set(e[s],a)):(n.push([e[s],t]),hp.set(e[s],t))})),n}getType(){return"REQUEST_NOISE_ID"}getHardcodeError(e){return 0}})||dp)||dp)||dp)||dp),Object(m.j)()(up=Object(a.injectable)()(up=class extends ep.a{async execute(){return Array.from(hp.entries())}getType(){return"REQUEST_ALL_NOISE_ID"}})||up);var gp;Object(m.j)()(gp=Object(a.injectable)()(gp=class extends ep.a{async execute({params:e}){const t=a.ModuleContainer.resolve(Nn.PreviewDataManager);await t.onReceiveNewMessages("sync-db",e)}getType(){return"UPDATE_CONVERSATION_PREVIEW"}})||gp);var mp;Object(m.j)()(mp=Object(a.injectable)()(mp=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(mp=Reflect.metadata("design:type",Function)(mp=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(mp=class extends ep.a{constructor(e){super(),this.logger=void 0,this.logger=e.createZLogger("feat",["sync-message","reload-msg-handler"])}async execute({params:e}){if(!lo.b.messageCache)return;lo.b.messageCache.deleteConversation(e.convId);const t=uo.a.getExistConvIds();this.logger.zsymb(0,"8yZpEQ",`ReloadMessagehandle ${t.includes(e.convId)} ${e.convId}`),t.includes(e.convId)&&ho.default.getLastMessagesForConversation(e.convId,{})}getType(){return"RELOAD_MESSAGE"}})||mp)||mp)||mp)||mp);var pp,fp=s("1KLq"),vp=s("nuPU");Object(m.j)()(pp=Object(a.injectable)()(pp=function(e,t){return Object(a.inject)(fp.b)(e,void 0,0)}(pp=Reflect.metadata("design:type",Function)(pp=Reflect.metadata("design:paramtypes",[void 0===fp.IMediaEventEmitter?Object:fp.IMediaEventEmitter])(pp=class extends ep.a{constructor(e){super(),this._mediaEventEmitter=void 0,this._mediaEventEmitter=e}async execute({params:e}){this._mediaEventEmitter.emit(vp.a.RELOAD_MEDIA_OF_CONV,e)}getType(){return"RELOAD_MEDIA"}})||pp)||pp)||pp)||pp);var _p=s("Erqw");const{setTimeoutUnlimited:bp,clearTimeoutUnlimited:Ip}=function(e={}){var t,s;const a=null!==(t=e.step)&&void 0!==t&&t?1e4:36e5,i=null!==(s=e.registry)&&void 0!==s?s:{};return{setTimeoutUnlimited:(e,t,...s)=>{const n=(e=>{var t;const s=e.step,a=e.registry;let i=null!==(t=e.timeout)&&void 0!==t?t:0;const n=e.callback,r=e.args,o=performance.now()+i;let c;function l(){let e=Math.min(o-performance.now(),s);return performance.now()>o?a[c]=setTimeout(n,0,r):a[c]=setTimeout(l,e),a[c]}return function(){let e=Math.min(o-performance.now(),s);return c=setTimeout(l,e),a[c]=c,c}()})({step:a,registry:i,callback:e,timeout:t,args:s});return n},clearTimeoutUnlimited:e=>{(e=>{const t=e.id,s=e.registry;clearTimeout(s[t]),delete s[t]})({id:e,registry:i})}}}({registry:{}});var yp,Sp=s("1p+n"),Cp=s("UYft"),Ep=s("AULX");Object(a.injectable)()(yp=Object(a.singleton)(Ep.a)(yp=Object(m.h)()(yp=Object(m.f)()(yp=function(e,t){return Object(a.inject)(o)(e,void 0,0)}(yp=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(yp=Reflect.metadata("design:type",Function)(yp=Reflect.metadata("design:paramtypes",[void 0===r?Object:r,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(yp=class{constructor(e,t){this.kvCacheFactory=e,this.loggerFactory=t,this._logger=void 0,this._authEvent=void 0,this.__cache=void 0,this._renewRegistry={},this.updateEmitter=new Sp.a,this._logger=this.loggerFactory.createZLogger("feat",["group-link"])}onAuthenticated(e){this._authEvent=e}_makeCache(){if(!this._authEvent)throw new Error("Not authenticated");return this.kvCacheFactory.createCache(`group-link-v3-${this._authEvent.getSession().userId}`,{maxSize:50})}get _cache(){return this.__cache||(this.__cache=this._makeCache()),this.__cache}_scheduleRenew(e,t){if(this._clearRenewSchedule(e),!t.enabled)return this;if(!Ce.default.groupLink.enableScheduleRenew)return this._logger.debug(["_scheduleRenew skipped, enableScheduleRenew:",Ce.default.groupLink.enableScheduleRenew]),this;let s=t.expirationDate-Ct.default.getTimeNow(),a=bp((()=>{this._clearRenewSchedule(e),this._emitGroupLinkUpdated(e,!0)}),s);return this._renewRegistry[e]=()=>{Ip(a),delete this._renewRegistry[e]},this}_clearRenewSchedule(e){var t,s;return null===(t=(s=this._renewRegistry)[e])||void 0===t||t.call(s),this}onDispose(){this._authEvent=void 0,this.__cache=void 0}async _getFromCache(e){if(!Ce.default.groupLink.enableCache)return void this._logger.debug(["cache skipped, enableCache:",Ce.default.groupLink.enableCache]);e=Op(e);let t=await this._cache.getItem(e);if(t){if(function(e){if(!e)return!1;let{data:t,meta:s}=e;if(!t)return!1;if(!s)return!1;if(_p.a.isOverflowAtTime(s.ts))return!1;const a=Ct.default.getTimeNow();if(s.ts+Ce.default.groupLink.maxCacheDuration<a)return!1;if(t.enabled&&t.expirationDate<a)return!1;return!0}(t))return t.data;await this._cache.removeItem(e)}}async _fetchAndPutToCache(e,t){const s=Ct.default.getTimeNow(),a=await t(),i={enabled:a.enabled,expirationDate:a.expiration_date,link:a.link};let n={ts:s};return await this._cache.setItem(e,{data:i,meta:n}),i}async _deleteCache(e){await this._cache.removeItem(e)}async getGroupLinkDetail(e,t=!1){this._logger.zsymb(12,"OgTovO",["getting",e]);let s=Op(e),a=await this._getFromCache(s);if(a&&!t)return this._logger.zsymb(12,"6pgTnD",["cache hit",s]),this._scheduleRenew(s,a),a;this._logger.zsymb(12,"BsJk5l",["fetching",s]);let i=ui.default.getRawGroupId(s);let n=await this._fetchAndPutToCache(s,(()=>qc.default.getGroupLinkDetail(i))).catch(Cp.a.catch((e=>this._logger.zsymb(18,"JlGYyy",["get failed",s,e]))));return this._scheduleRenew(s,n),t&&await this._emitGroupLinkUpdated(e),this._logger.zsymb(12,"8aPjsc",["done",s]),n}async renewGroupLink(e){this._logger.zsymb(12,"_9xOu5",["renewing",e]);let t=Op(e),s=ui.default.getRawGroupId(t);let a=await this._fetchAndPutToCache(t,(()=>qc.default.renewGroupLink(s))).catch(Cp.a.catch((e=>this._logger.zsymb(18,"laYBJW",["renew failed",t,e]))));return this._scheduleRenew(t,a),await this._emitGroupLinkUpdated(t),this._logger.zsymb(12,"cAxrtp",["renew done",e]),a}async disableGroupLink(e){this._logger.zsymb(12,"tydtFu",["disabling",e]);let t=Op(e),s=ui.default.getRawGroupId(t);await qc.default.disableGroupLink(s).catch(Cp.a.catch((e=>this._logger.zsymb(18,"dTwHdD",["disable failed",t,e])))),await this._emitGroupLinkUpdated(t,!0),this._logger.zsymb(12,"Gfo1F-",["disable done",e])}async _emitGroupLinkUpdated(e,t=!1){const s=Op(e);t&&await this._deleteCache(s),this.updateEmitter.emit(s,s),this.updateEmitter.emit("*",s)}async emitGroupLinkUpdated(e){return await this._emitGroupLinkUpdated(e,!0)}})||yp)||yp)||yp)||yp)||yp)||yp)||yp);function Op(e){return Y.GROUPID_PREFIX+ui.default.getRawGroupId(e)}var Mp,Tp=s("TO4U");const Rp={loading:!0};Object(xi.b)(Tp.a)(Mp=function(e,t){return Object(a.inject)(Ep.a)(e,void 0,0)}(Mp=Reflect.metadata("design:type",Function)(Mp=Reflect.metadata("design:paramtypes",[void 0===Ep.a?Object:Ep.a])(Mp=class e{constructor(e){this._groupLink=e,this.type=void 0,this.name="group-link-ui",this.key="group-link-ui",this._cache=new u.default({maxSize:50}),this._handleUpdate=e=>{const t=wp(e);this._cache.delete(t),this._startFetchAndSetToSession(t)},this._groupLink.updateEmitter.on("*",this._handleUpdate)}init(){}getItem(e,t){if(!e.key.startsWith(Y.GROUPID_PREFIX))return;const s=wp(e.key);this._startFetchAndSetToSession(s);let a=this._cache.get(s);return a||Rp}static shouldSignal(e,t){var s,a,i,n,r,o;return!e||(null==e||e.error,null==t||t.error,null==t||null===(s=t.data)||void 0===s||s.enabled,null==t||null===(a=t.data)||void 0===a||a.enabled,null!=e&&null!==(i=e.data)&&void 0!==i&&i.enabled&&null!=t&&null!==(n=t.data)&&void 0!==n&&n.enabled&&(null==e||null===(r=e.data)||void 0===r||r.link,null==t||null===(o=t.data)||void 0===o||o.link),!1)}signalIfNeeded(t,s,a){e.shouldSignal(s,a)&&Object(nc.h)(this.name,t)}_startFetchAndSetToSession(e){const t=this._cache.get(e);setTimeout((()=>{this._groupLink.getGroupLinkDetail(e).then((s=>{const a={loading:!1,data:s};this._cache.set(e,a),this.signalIfNeeded(e,t,a)})).catch((s=>{const a={loading:!1,error:s};this._cache.set(e,a),this.signalIfNeeded(e,t,a)}))}),0)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Mp)||Mp)||Mp);function wp(e){return Y.GROUPID_PREFIX+ui.default.getRawGroupId(e)}var Lp=s("oOjv"),Dp=s("bB26"),Ap=s("lteq");const Fp={[Ar.c]:{}};a.ModuleContainer.registerSingleton(Lp.b,class{constructor(){this.state=Fp,this.animationControllers=new Map,this._manuallyOff=!1,this.name=Lp.a,this.key="convId",this.isFeatEnabled=()=>!this._manuallyOff&&Ce.default.preview_msg_time.enable,this.state=Fp}offFeature(){this._manuallyOff=!0}enableFeature(){this._manuallyOff=!1}getAnimController(e){if(!this.isFeatEnabled())return null;if(!this.animationControllers.has(e)){const t=new Dp.a(e);this.animationControllers.set(e,t)}return this.animationControllers.get(e)||null}setScrollDirection(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.setScrollDirection(t)}hasNewMsgInView(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasNewMsgInView(t)}hasViewOverflowMsg(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hasViewOverflowMsg(t)}hitBottom(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.hitBottom(t)}triggerActiveScroll(e,t){if(!this.isFeatEnabled())return;const s=this.getAnimController(e);null==s||s.triggerActiveScroll(t)}onChangeConversation(e){var t;const s=this.getAnimController(e);null==s||s.resetAnimation(),null===(t=Ap.a.getInViewController(e))||void 0===t||t.resetPreviewTimestamp(),Uc.a.onNewSession(e)}clearAnimations(e){const t=this.getAnimController(e);null==t||t.clearAnimations()}onMouseEnterPreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.pause())}onMouseLeavePreviewTime(e,t){if(!this.isFeatEnabled()||!t)return;const s=this.getAnimController(e);(null==s?void 0:s.mountedPreviewTime)===t&&(null==s||s.resume())}setTopMost(e,t,s){if(!this.isFeatEnabled())return;const a=this.getAnimController(e);null==a||a.setTopMost(t,s)}setSecondTopMost(e,t,s){if(!this.isFeatEnabled())return;const a=this.getAnimController(e);null==a||a.setSecondTopMost(t,s)}init(){}getItem(e){return this.state[e.key]}getList(e){return Object.keys(this.state)}onGetItemFailure(e){}onGetListFailure(e){}});var kp=s("px+z"),Np=s("AqnK"),Pp=s("X2DH"),jp=s("3Rxw"),Up=s("V2fg"),Bp=s("RUx3"),zp=s("DhYn"),Gp=s("Bvld"),xp=s("bavj"),Vp=s("KgJV");var Hp,Wp=s("QmNg"),qp=s("ACSi"),Kp=s("TjvF");let Zp=Object(a.injectable)()(Hp=class{constructor(){this.MAX_REGEN_TASKS=10,this.MAX_MEMORY_USAGE=52428800,this.MetadataCache=new u.default({maxSize:100,maxAge:3e5}),this.requests=[],this.availableTask=this.MAX_REGEN_TASKS,this.totalMemoryUsage=0,this.regenImageFromLocal=async e=>{var t,s;const{getSourcePath:a,getGenThumbPath:i}=e;Object(ua.a)(!!a,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(ua.a)(!!i,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const n=await a(),r=this.checkSize(n);await this.acquireTaskLock(r);const o=`${null==e||null===(t=e.log)||void 0===t?void 0:t.mediaId}-${null==e||null===(s=e.log)||void 0===s?void 0:s.entry}`;let c=Date.now(),l=c,d=Np.n.oriUrl,u="";e.sizes||(e.sizes={originalWidth:void 0,originalHeight:void 0,maxDimension:void 0});try{var h;let t={type:"",width:e.sizes.originalWidth,height:e.sizes.originalHeight,size:0};if(void 0!==this.MetadataCache.peek(n))t=this.MetadataCache.get(n);else{const s=$znode.path.extname(n);if(Object(qp.c)(e.sizes.originalWidth)&&Object(qp.c)(e.sizes.originalHeight)&&s)t.size=r,t.type=s.replace(".","");else{const s=await $zFileManager.getFileArrayBuffer(n);t=await Object(Vp.a)(s),t.size=r,e.sizes.originalWidth=t.width,e.sizes.originalHeight=t.height}this.MetadataCache.set(n,t)}Up.b.log(null===(h=e.log)||void 0===h?void 0:h.clientId,{msgFormat:`image/${t.type}`,originalSize:r,originalWidth:t.width,originalHeight:t.height}),d=function(e,t,s=Ce.default.image_loader.max_original){const a=Ce.default.image_loader.max_original,i=Ce.default.image_loader.max_hd,n=Ce.default.image_loader.max_normal,r=Ce.default.image_loader.max_thumb,o=[{quality:Np.n.oriUrl,min:i,max:a},{quality:Np.n.hdUrl,min:n,max:i},{quality:Np.n.normalUrl,min:r,max:n},{quality:Np.n.thumbUrl,min:1,max:r}].sort(((e,t)=>t.max-e.max)),[c,l]=Object(xp.d)(e,t,s,s,!1);let d=Np.n.oriUrl;for(let u of o){const[e,t,s]=Object(xp.d)(c,l,u.max,u.max,!1);if(s)break;d=u.quality}return d}(t.width,t.height,e.sizes.maxDimension),u=await i();const s=new Wp.c(u);s.q=d,u=s.getGenPath();if(u&&Object(Hi.a)(u)){if(Object(qp.b)(e.getOldLocalPathForMigration)){let t=await(null==e?void 0:e.getOldLocalPathForMigration());t=t?this._toJpeg(t):t,t&&Object(Hi.a)(t)&&(zconsole.zsymb(3,"o7Wv65",["MediaDiskFetcher: delete existed old. no regen","vu6bc-"],t,"->",u),await this._deleteLocalSource(t))}return Np.l.Success({mediaURL:u})}if(Object(qp.b)(e.getOldLocalPathForMigration)){let t=await e.getOldLocalPathForMigration();t=t?this._toJpeg(t):t,t&&Object(Hi.a)(t)&&(zconsole.zsymb(3,"N48Fe_",["MediaDiskFetcher: delete existed old. regen","TlH3uu"],t,"->",u),await this._deleteLocalSource(t))}const[a,g,p]=Object(xp.d)(t.width,t.height,e.sizes.maxDimension,e.sizes.maxDimension,!1);if(!p&&"jxl"!==t.type)return u=n,Np.l.Success({mediaURL:n});Kp.b.getInstance().record(Kp.a.RenderPhotoHighQuality,{logId:o,resizeWidth:a,resizeHeight:g});const f=Object(I.a)(Object(I.a)({},e),{},{getGenThumbPath:()=>Promise.resolve(u),metadata:t,output:{width:a,height:g}});try{c=Date.now();const e=await this.regenImageFromLocalUsingNativelibs(f);return l=Date.now(),kc.default.increaseSuccess(Bp.a,0,l-c),kc.default.increaseSuccess(Bp.c,0,l-c),e}catch(m){l=Date.now(),kc.default.increaseFailed(Bp.a,0,l-c,Object(Bp.k)(),c)}try{c=Date.now();const e=await this.regenImageFromUrlUsingNativeElectron(f);return l=Date.now(),kc.default.increaseSuccess(Bp.c,0,l-c),e}catch(m){throw m}}catch(m){throw l=Date.now(),kc.default.increaseFailed(Bp.c,0,l-c,Object(Bp.i)(),c),m}finally{try{var g;const t=this.checkSize(u);Kp.b.getInstance().record(Kp.a.RenderPhotoHighQuality,{logId:o,resizeSize:t});const s=d===Np.n.normalUrl,a=d===Np.n.thumbUrl;Up.b.endLog(null===(g=e.log)||void 0===g?void 0:g.clientId,{regenStatus:1,localSize:t,hdSize:t,normalSize:s?t:void 0,thumbSize:a?t:void 0}),this.releaseTaskLock(r)}catch(m){zconsole.zsymb(18,"lElz9d","ImageRegeneratorImpl: regenImageFromLocal finally error",m)}}},this.regenImageFromLocalUsingNativelibs=async e=>{try{const{getSourcePath:r,getGenThumbPath:o,sizes:c={width:void 0,height:void 0},removeOriginalAfterGenerate:l=!1,priority:d=-1}=e;Object(ua.a)(!!r,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(ua.a)(!!o,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const u=await o();if($znode.fs.existsSync(u))return Np.l.Success({mediaURL:u});const h=await r(),g="jxl"===e.metadata.type;try{if(zp.a.jxl.version===Gp.a.V2&&g){var t,s;zconsole.zsymb(14,"3ucPo9","JXL: regen jxl using native libs",e);const a="number"==typeof(null==e||null===(t=e.sizes)||void 0===t?void 0:t.maxDimension)?(null==e||null===(s=e.sizes)||void 0===s?void 0:s.maxDimension)+1:void 0;await Object(Pp.b)(h,{tasks:[{width:e.sizes.originalWidth,height:e.sizes.originalHeight,outputPath:u,maxWidth:a,maxHeight:a}]},{priority:d})}else{const t=await $zFileManager.getFileArrayBuffer(h),s=new Blob([t]),a=await Object(jp.a)(s,{width:e.output.width,priority:d,quality:.9}),i=$znode.path.dirname(u);this.ensureDir(i),await $zFileManager.writeBufferToPath(u,await a.arrayBuffer())}}catch(i){var a;throw Up.b.endLog(null===(a=e.log)||void 0===a?void 0:a.clientId,{regenStatus:0}),i}if(l)try{$znode.fs.unlinkSync(h)}catch(n){}return Np.l.Success({mediaURL:u})}catch(i){throw i}},this.regenImageFromUrlUsingNativeElectron=async e=>{try{const{getSourcePath:i,getGenThumbPath:n,removeOriginalAfterGenerate:r=!1}=e;Object(ua.a)(!!i,"ImageRegeneratorImpl: getSourcePath cannot be null"),Object(ua.a)(!!n,"ImageRegeneratorImpl: getGenThumbPath cannot be null");const o=await n();if($znode.fs.existsSync(o))return Np.l.Success({mediaURL:o});const c=await i();let l=null;try{const t=await $zFileManager.getFileArrayBuffer(c),s=new Blob([t]),a=await createImageBitmap(s);l=document.createElement("canvas"),l.width=e.output.width,l.height=e.output.height;const i=l.getContext("2d");null==i||i.drawImage(a,0,0,e.output.width,e.output.height);const n=await new Promise(((e,t)=>{l.toBlob((s=>{s?e(s):t(new Error("Failed to convert canvas to blob"))}),"image/jpeg",.9)})),r=$znode.path.dirname(o);this.ensureDir(r),await $zFileManager.writeBufferToPath(o,await n.arrayBuffer())}catch(s){throw zconsole.error("[JXL]: regen erorr",s),s}finally{var t;const e=null===(t=l)||void 0===t?void 0:t.getContext("2d");e&&e.clearRect(0,0,l.width,l.height),l&&(l.width=0,l.height=0)}if(r)try{$znode.fs.unlinkSync(c)}catch(a){}return Np.l.Success({mediaURL:o})}catch(s){throw s}},this.ensureDir=e=>{$znode.fsExtra.ensureDirSync(e,1533)},this.createDeferred=(e=0)=>{let t,s;return{promise:new Promise(((e,a)=>{t=e,s=a})),resolve:t,reject:s,fileSize:e}},this.acquireTaskLock=async e=>{const t=this.createDeferred(e),s=this.availableTask<this.MAX_REGEN_TASKS;(this.availableTask<=0||this.totalMemoryUsage+e>this.MAX_MEMORY_USAGE&&s)&&(this.requests.push(t),await t.promise),this.totalMemoryUsage+=e,this.availableTask--},this.releaseTaskLock=e=>{if(this.availableTask=Math.min(this.MAX_REGEN_TASKS,this.availableTask+1),this.totalMemoryUsage=Math.max(0,this.totalMemoryUsage-e),this.availableTask>0&&this.requests.length>0){const e=this.requests[0],t=this.availableTask<this.MAX_REGEN_TASKS;if(e.fileSize+this.totalMemoryUsage<=this.MAX_MEMORY_USAGE||!t){this.requests.shift().resolve()}}},this.checkSize=e=>{try{return $znode.fs.statSync(e).size}catch(t){return 0}},this._deleteLocalSource=async e=>{if(e)try{await new Promise(((t,s)=>{$znode.fs.unlink(e,(a=>{a?(zconsole.zsymb(18,"EwnZg9","MediaDiskFetcher: deleteLocalSource error",e,a),s(a)):t(!0)}))}))}catch(t){zconsole.zsymb(15,"6Mm6oE",["MediaDiskFetcher: deleteLocalSource error","xi52GE"],t)}else zconsole.zsymb(21,"UjWH8-",["MediaDiskFetcher: deleteLocalSource localPath cannot be null","yqDDoT"],e)},this._copySource=async(e,t,s=!0)=>{if(e&&t)try{const a=`${e}.tmp`;await new Promise(((t,s)=>{$znode.fsExtra.rename(e,a,(a=>{a?(zconsole.zsymb(18,"Jngi2s","MediaDiskFetcher: migrateSource error",e,a),s(a)):t(!0)}))})),await $znode.fsExtra.copy(a,t,{dereference:!0,overwrite:!0}),s||await this._deleteLocalSource(a)}catch(a){zconsole.zsymb(15,"Rr9alK",["MediaDiskFetcher: migrateSource error","q1rldG"],a)}else zconsole.zsymb(21,"G5VJnu",["MediaDiskFetcher: migrateSource oldPath and newPath cannot be null","yImBOD"],e,t)},this._toJpeg=(e,t="")=>{if(".jxl"===$znode.path.extname(e))return e.replace(/\.jxl$/,".jpg");if(t){const s=$znode.path.basename(e),a=$znode.path.dirname(e);return $znode.path.join(a,`${t}-${s}`)}return e}}})||Hp;a.ModuleContainer.registerSingleton(kp.a,Zp);var $p=s("tDXj");const Qp=Object(a.define)("JIT_MEDIA_CODEC");var Yp;let Jp=Object(a.injectable)()(Yp=class{constructor(){this._blobURLMapping=new Map,this._conversationCache=new Map}async preload(e,t,s){let a=e;if(this._isHttpURL(e))try{if(this._blobURLMapping.has(e))return Np.l.Success({mediaURL:e});const t=Object(at.j)().toString(),s=await Object(at.h)(t,e,at.a.dev,void 0,{useDiskCache:!1});if(s.error)return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:s.error});a=s.data}catch(i){return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:i})}else if(this._isBlobURL(e)){if(this._blobURLMapping.has(e))return Np.l.Success({mediaURL:e});if(!(await this.isBlobURLAlive(e)))return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:"blob url expired"})}return this._cache(a,t,s),Np.l.Success({mediaURL:a})}async isBlobURLAlive(e,t){const s=null!=t&&t.document?t.document.createElement("img"):new Image;s.src=e;try{return await s.decode(),!0}catch(a){return!1}}async preloadImageDOM(e,t){let s=0,i=null,n=1,r=t&&"async"!==(null==t?void 0:t.mode)&&"auto"!==(null==t?void 0:t.mode)?"sync":"async";const o=e.src,c=null==o?void 0:o.endsWith("jxl"),l=!!zp.a.jxl.enable_native_electron_jxl||!Object(he.a)()&&zp.a.jxl.enable_native_electron_jxl;if(c&&!l)try{var d,u;const t=null===(d=e.rawSrc)||void 0===d||null===(u=d.replace("file://",""))||void 0===u?void 0:u.replace("zfile://",""),s=await a.ModuleContainer.resolve(Qp).decodeLocalImage(t);if(!s)throw new Error("JXL decode failed. Empty url");e.src=s}catch(h){zconsole.zsymb(21,"m2YeoU",["Failed to decode JXL image","uMXBSH"],h)}if("async"===r){n=2;try{return await this._preloadImageAsync(e)}catch(h){s++,i=h}}try{return await this.preloadImageSync(e)}catch(h){s++,i=h}if(s===n)throw new Error(`preloadImageDOM failed ${i}`);return null}async _preloadImageAsync(e){try{const t=new Image;t.draggable=!1;for(const s in e)s&&e[s]&&t.setAttribute(s,e[s]);return await t.decode(),t}catch(t){throw t}}async preloadImageSync(e){const t=new Image;t.draggable=!1;for(const i in e)i&&e[i]&&t.setAttribute(i,e[i]);const s=new Promise(((e,s)=>{t.onload=e,t.onerror=s}));try{return await s,t}catch(a){throw a}}_cache(e,t,s){if(this._blobURLMapping.set(e,{blobURL:e,cacheMode:t,convId:s}),s){const t=this._conversationCache.get(s)||[];t.push(e),this._conversationCache.set(s,t)}}_isHttpURL(e){return e.startsWith("http")||e.startsWith("https")}_isBlobURL(e){return e.startsWith("blob")}})||Yp;a.ModuleContainer.registerSingleton($p.a,Jp);var Xp=s("UeuQ"),ef=s("XDVU");function tf(e){return e.startsWith("http")||e.startsWith("https")}function sf(e){return e.startsWith("blob")}var af=s("iD3V"),nf=s("tqrY");var rf=s("Q8nW"),of=s("Ageb"),cf=s("qvbK"),lf=s("5+PA"),df=s("dog1"),uf=s("6e5J");const hf=(e,t)=>{if(!t)return e;const s=new URL(e);return s.pathname=`${t}${s.pathname}`,s.search=decodeURIComponent(s.search),s.href},gf=new u.default({maxSize:300,maxAge:3e5}),mf=3;async function pf(e,t={}){var s;if("boolean"==typeof(null===(s=gf.peek(e))||void 0===s?void 0:s.alive))return!0===gf.get(e).alive;const{retries:a=mf,cacheResponse:i=!1,retryableErrorCodes:n=[]}=t,r=Object(af.a)((async e=>{try{return await ui.default.checkAlive(e),!0}catch(t){throw t}}),{min:5e5,max:1e3,retries:a,lastTryDelayTime:{min:5e3,max:1e4},shouldRetryOnError:async({error:e,currentState:t})=>(zconsole.debug((function(e){return e[0]})`checkAlive: should retry on error`,e,t),t.nTry!=mf||Array.isArray(n)&&n.length>0&&n.some((t=>t===e))),afterRetry:async({success:e,nTry:t})=>{const s=t===mf;zconsole.debug((function(e){return e[0]})`checkAlive: afterRetry`,{success:e,nTry:t,isLastTry:s})}});let o=!1;try{o=await r(e)}catch(c){zconsole.zsymb(18,"qhZX4s","checkAlive with cache caught error",c)}return i&&gf.set(e,{alive:o,contentLength:null,contentType:null}),o}class ff{constructor(){this.aborted=void 0,this.aborted=!0}}class vf{constructor(e,t=[]){this._task=e,this.args=t,this._abortController=void 0,this._aborted=!1,this._fulfilled=!1,this._promise=null,this._abortableTask=void 0,this.abort=()=>{this._abortController.abort()},this._abortController=new AbortController,this._abortableTask=(...e)=>new Promise(((t,s)=>{const a=()=>{this._aborted=!0,s(new ff),this._abortController.signal.removeEventListener("abort",a)};this._abortController.signal.addEventListener("abort",a),this._task(...e).then(t).catch(s).finally((()=>{this._abortController.signal.removeEventListener("abort",a),this._fulfilled=!0}))}))}get aborted(){return this._aborted}get fulfilled(){return this._fulfilled}get promise(){return this._promise||(this._promise=this._abortableTask(...this.args)),this._promise}}function _f(e,...t){return new vf(e,t)}class bf{constructor(e,t){this.taskId=e,this.executor=t}}class If{constructor(e,t){this.limit=void 0,this.runningTasks=void 0,this.taskQueue=void 0,this.taskMap=void 0,this.onTaskCompleted=void 0,this.isRunning=e=>this.runningTasks.has(e),this.abortTask=e=>{const t=this.taskMap.get(e);t&&(t.executor.abort(),this.removeTask(e))},this.limit=e,this.runningTasks=new Set,this.taskQueue=[],this.taskMap=new Map,this.onTaskCompleted=t||(()=>{})}addTask(e){this.runningTasks.has(e.taskId)||(this.taskMap.has(e.taskId)&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e.taskId))),this.taskQueue.push(e),this.taskMap.set(e.taskId,e),this._tryToRunTasks())}removeTask(e){const t=this.taskMap.get(e);t&&(this.taskQueue=this.taskQueue.filter((t=>t.taskId!==e)),this.taskMap.delete(e)),this.runningTasks.has(e)&&(this.runningTasks.delete(e),t&&t.executor.abort())}_tryToRunTasks(){if(!(this.runningTasks.size>=this.limit))for(;this.runningTasks.size<this.limit&&this.taskQueue.length>0;){const e=this.taskQueue.pop();e&&this._runTask(e)}}_runTask(e){this.runningTasks.add(e.taskId),e.executor.promise.then((()=>{this._taskFinished(e.taskId)})).catch((()=>{this._taskFinished(e.taskId)}))}_taskFinished(e){this.removeTask(e),this._tryToRunTasks(),this.onTaskCompleted(e)}}var yf;let Sf=Object(a.injectable)()(yf=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(yf=Reflect.metadata("design:type",Function)(yf=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(yf=class{constructor(e){this.Logger=void 0,this.BigFileTaskQueue=new If(1),this.BIG_FILE_THRESHOLD=10485760,this.fetch=async e=>{const t=await(s=e.source,void 0!==gf.peek(s)?Promise.resolve(gf.get(s)):new Promise(((e,t)=>{const a=new XMLHttpRequest;let i=s.replace("http://","https://");i=ui.default.removeE2eeProtocol(i),a.open("HEAD",i),a.responseType="arraybuffer",a.timeout=5e3,a.onload=()=>{const t={contentType:a.getResponseHeader("Content-Type"),contentLength:ui.default.ZSafeFunction((()=>parseInt(a.getResponseHeader("Content-Length"))),null),alive:!(404===a.status||a.responseURL&&a.responseURL.indexOf("default")>=0),status:a.status};gf.set(s,t),e(t)},a.onerror=t=>{zconsole.error((function(e){return e[0]})`checkHEAD error`,t);const i={contentType:null,contentLength:null,alive:!1,status:a.status};gf.set(s,i),e(i)},a.ontimeout=t=>{const i={contentType:null,contentLength:null,alive:!1,status:a.status};gf.set(s,i,{maxAge:6e4}),e(i)},a.onabort&&(a.onabort=()=>{const t={contentType:null,contentLength:null,alive:!1,status:a.status};gf.set(s,t,{maxAge:6e4}),e(t)}),a.send()})));var s;if(zconsole.zsymb(0,"syIw7s","MediaBlobFetcher: check HEAD response",e.source,t),"number"==typeof(null==t?void 0:t.contentLength)&&t.contentLength>=this.BIG_FILE_THRESHOLD){var a,i;const t=`${e.mediaId}-${(null===(a=e.options)||void 0===a||null===(i=a.regenerateFromSource)||void 0===i?void 0:i.regenId)||""}`,s=_f(this._fetch,e),n=new bf(t,s);return this.BigFileTaskQueue.addTask(n),await n.executor.promise}return await this._fetch(e)},this._fetch=async e=>{var t;let{mediaId:s,source:a,options:i={},entry:n}=e;Object(ef.a)("string"==typeof a&&tf(a),`Media source must be a (http|https) URL. Got ${a}`);const r={start:performance.now(),end:performance.now()};zconsole.zsymb(3,"cDmudr",["MediaBlobFetcher: fetch start. {} {} {}","ItfAn5"],s,n,a,null===(t=i.regenerateFromSource)||void 0===t?void 0:t.regenId);try{var o;let t=(null===(o=i.regenerateFromSource)||void 0===o?void 0:o.maxDimension)||Ce.default.image_loader.max_original,n=t,d=t;if(null!=i&&i.regenerateFromSource){delete i.regenerateFromSource.getLocalPath;const e=i.regenerateFromSource;Object(qp.c)(e.originalWidth)&&e.originalWidth>0&&Object(qp.c)(e.originalHeight)&&e.originalHeight>0&&([n,d]=Object(xp.d)(e.originalWidth,e.originalHeight,t,t,!1),t=n)}const u=Object(I.a)(Object(I.a)({cacheControl:"cache",useMemCache:!0,useDiskCache:!1},i),{},{convertible:Object(rf.g)(a)});if(null!=i&&i.regenerateFromSource){u.regenerateJXL={outputWidth:n,outputHeight:d};const s=i.regenerateFromSource.regenId;a=Object(rf.b)(i.regenerateFromSource.url,"regenw",t.toString()),"cache"===u.cacheControl&&(u.useDiskCache="thumb"===s||"normal"===s,u.useDiskCache&&(a=Object(of.d)(a))),e.source=a}if("cache"==u.cacheControl){var c;if(lf.b.has(a)){var l;const e=null===(l=lf.b.get(a))||void 0===l?void 0:l.prepared;return Np.l.Success({mediaURL:e})}const e=hf(a,(null===(c=i.regenerateFromSource)||void 0===c?void 0:c.regenId)||""),t=await lf.a.getFile(e);if(t){const e=URL.createObjectURL(t);return lf.b.set(a,t.size,e),Np.l.Success({mediaURL:e})}}const h=await this.getFetcher()(Object(at.j)().toString(),a,"dev",void 0,u,void 0,(e=>{if(!e)return null;const[t,s,a]=e.split(".");return{cliMsgId:t,fromUid:s,toUid:a}||null})(s),at.c.IMAGE_COMPONENT);return r.end=performance.now(),h.error||!h.data?(zconsole.zsymb(18,"ySskWx",`MediaBlobFetcher: fetch failed. ${s} ${a}. took: ${Date.now()-r.start}`,h),await this.handleFailure(e,u,h,r)):await this.handleSuccess(e,u,h,r)}catch(d){return this.Logger.zsymb(0,"4Ot79m",`MediaBlobFetcher: fetch caught error. ${s} ${a}. took: ${Date.now()-r.start}`,d,null==d?void 0:d.code),Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:a,error:d}})}},this.getFetcher=()=>{const e={[df.a.V1]:at.h,[df.a.V2]:at.i}[nf.a.image_loader.version];Object(ef.a)(!!e,`Invalid fetcher: targeting ${nf.a.image_loader.version}`);return Object(af.a)(e,{min:nf.a.image_loader.retryMin,max:nf.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:nf.a.image_loader.lastTryDelayTime.min,max:nf.a.image_loader.lastTryDelayTime.max},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:a})=>{e||this.Logger.zsymb(0,"HS1BOK",`MediaBlobFetcher: Try ${s}: failed. Should retry: ${t} after ${a}ms`),e||t||this.Logger.zsymb(0,"hGpRrZ",`MediaBlobFetcher: Download failed after ${s} tries`)}})},this.handleFailure=async(e,t,s,a)=>{var i;const{mediaId:n,source:r}=e;this.Logger.zsymb(0,"6XI339",`MediaBlobFetcher: fetch failed. ${n} ${r}. took: ${Date.now()-a.start}`,s.error,s.data,null==s||null===(i=s.error)||void 0===i?void 0:i.code);const o=a.end-a.start;if(Object(cf.l)(s.error)){var c;const e=Object(cf.m)(null===(c=s.error)||void 0===c?void 0:c.code);if(e){const{qosCommand:t,errorCode:s}=e;kc.default.increaseFailed(t,0,o,s,a.start)}return kc.default.increaseFailed(Bp.a,0,o,Object(Bp.k)(),a.start),Np.l.Failure({code:Np.d.LIBJXL_ERROR,mediaURL:r,error:{mediaURL:r,error:s.error}})}return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:r,error:s.error}})},this.handleSuccess=async(e,t,s,a)=>{Object(ef.a)(!!s.data,"Data must be present in response");try{var i,n;const{source:c,mediaId:l,entry:d}=e,u=a.end-a.start;if(Object(rf.g)(c)&&s.data&&(kc.default.increaseSuccess(Bp.b,0,u),kc.default.increaseSuccess(Bp.a,0,u)),"string"==typeof s.data)return Np.l.Success({mediaURL:s.data});let h=s.data;const g=null===(i=e.options)||void 0===i?void 0:i.regenerateFromSource;if(g){const e=g.maxDimension||Ce.default.image_loader.max_original;let t=g.originalWidth,s=g.originalHeight,a=!1,i=0,n=0;if(Object(qp.c)(t)&&Object(qp.c)(s)&&Object(qp.c)(e))[i,n,a]=Object(xp.d)(t,s,e,e,!1);else{const[r,o]=await E.c.catchAsyncFn((()=>uf.default.getDimension({key:c,file:h})));!r&&o&&(t=o.width,s=o.height,[i,n,a]=Object(xp.d)(o.width,o.height,e,e,!1))}a&&(h=await Object(jp.a)(h,{width:i,height:n,priority:0,quality:.75})),Kp.b.getInstance().record(Kp.a.RenderPhotoHighQuality,{logId:`${l}-${d}`,resizeSize:h.size,resizeWidth:i,resizeHeight:n})}"image/jxl"!==(null===(n=h)||void 0===n?void 0:n.type)||null!=t&&t.downloadAsJxl||(h=Object(of.b)(h,"image/jpeg"));const m=URL.createObjectURL(h);if("cache"===t.cacheControl&&(lf.b.set(c,h.size,m),!0===t.useDiskCache)){var r,o;const t=hf(c,(null==e||null===(r=e.options)||void 0===r||null===(o=r.regenerateFromSource)||void 0===o?void 0:o.regenId)||"");await lf.a.putFile(t,h)}return Np.l.Success({mediaURL:m})}catch(c){return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:e.source,error:c}})}},this.createDeferredTask=e=>{let t=()=>{},s=()=>{};return{promise:new Promise(((e,a)=>{t=e,s=a})),resolve:t,reject:s,source:e}},this.Logger=e.createZLogger(w.ZLoggerNametags.imageLoader,[w.ZLoggerNametags.mediaBlobFetcher])}})||yf)||yf)||yf)||yf;a.ModuleContainer.registerSingleton(Xp.a,Sf);var Cf,Ef=s("xQyS"),Of=s("HOwT"),Mf=s("CI+W"),Tf=s("BDVO"),Rf=s("UD1y");const wf=$znode.path;let Lf=Object(a.injectable)()(Cf=class{constructor(){this._Logger=null,this.fetch=async e=>{let{mediaId:t,source:s,options:i,entry:n}=e;Object(ef.a)(!!wf,"Path module cannot be null"),Object(ef.a)("string"==typeof s&&tf(s),`Media source must be a http|https. Got ${s}`);const r=await i.getSavePath(s);let o=null,c=null,l=null;try{const e=t.split(".");3===e.length&&(o=e[0],l=e[1],c=e[2])}catch(m){}let d=r;const u=i.regenerateFromSource;u&&(Object(ef.a)(!!u.getLocalPath,"MediaDiskFetcher: regenerateFromSource.getLocalPath cannot be null"),Object(ef.a)(!!u.url,"MediaDiskFetcher: regenerateFromSource.getLocalPath cannot be null"),d=await u.getLocalPath(u.url));let h=!1;if(!Object(Hi.a)(d)){if(Object(qp.b)(i.getOldLocalPathForMigration)&&!i.regenerateFromSource){const e=await i.getOldLocalPathForMigration(s);if(e&&Object(Hi.a)(e))return this.Logger.zsymb(0,"evtsod",`MediaDiskFetcher: migrateSource ${e} -> ${d}`),await this._copySource(e,d,!1),Np.l.Success({mediaURL:d})}h=!0;try{let e={url:s,mediaId:t,localPath:d,entrySerial:i.entrySerial,sendDttm:null==i?void 0:i.sendDttm,noCacheRespFail:(null==i?void 0:i.sendDttm)&&Object(Tf.a)(null==i?void 0:i.sendDttm),options:{isLastFallbackUrl:i.isLastFallbackUrl}};!0===i.autoDownload&&(e.options=Object(I.a)(Object(I.a)({},e.options),{},{srcAction:tt.default.constants.srcAction.Auto})),this.Logger.zsymb(0,"_4SFeb",`MediaDiskFetcher: try fetch sendDttm:${e.sendDttm} ${e.url} -> ${e.localPath}. cacheFail:${e.noCacheRespFail}`),o&&Up.a.log(o,{clientId:o,dest_id:c,srcId:l,msgFormat:$znode.path.extname(d)});const a=await this._downloadWithRetry(e);if(o&&Up.a.endLog(o,{clientId:o}),a.error)return this.Logger.zsymb(18,"rd-daV",`MediaDiskFetcher: error ${s} | ${e.localPath} -> ${JSON.stringify(a.error)}`),Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:a.error}})}catch(m){return this.Logger.zsymb(14,"7HQGQt",`MediaDiskFetcher: fetch throws unknown error ${s}`,m),Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:s,error:m}})}}if(!i.regenerateFromSource)return Np.l.Success({mediaURL:d});Object(ef.a)(!!u,"MediaDiskFetcher: regenerateFromSource cannot be null");const g=await a.ModuleContainer.resolve(kp.a).regenImageFromLocal({priority:null==u?void 0:u.priority,getSourcePath:()=>Promise.resolve(d),getGenThumbPath:()=>Promise.resolve(r),sizes:{originalWidth:u.originalWidth,originalHeight:u.originalHeight,maxDimension:u.maxDimension},log:{clientId:o,originalWidth:null==u?void 0:u.originalWidth,originalHeight:null==u?void 0:u.originalHeight,mediaId:t,entry:n},getOldLocalPathForMigration:()=>{var e;return Promise.resolve(null==i||null===(e=i.getOldLocalPathForMigration)||void 0===e?void 0:e.call(i,s))}}).finally((()=>{u.enableStandalone&&h&&this._deleteLocalSource(d)}));return"ERROR"===g.type?(this.Logger.zsymb(18,"I1rWtC","MediaDiskFetcher: regenerateFromSource failed",t,n,s,d),Np.l.Failure({code:Np.d.FAILURE_BY_REGENERATE,error:{mediaURL:s,error:g.data.error}})):Np.l.Success({mediaURL:g.data.mediaURL})},this._toJpeg=(e,t="")=>{if(".jxl"===$znode.path.extname(e))return e.replace(/\.jxl$/,".jpg");if(t){const s=$znode.path.basename(e),a=$znode.path.dirname(e);return $znode.path.join(a,`${t}-${s}`)}return e},this._downloadHandler=async e=>{const{localPath:t}=e,s=await Object(Ef.a)(Mf.loadPC,e),a=s.ok?t:"";if(s.ok)return{mediaURL:a,error:void 0};throw s.error},this._downloadWithRetry=Object(af.a)(this._downloadHandler,{min:nf.a.image_loader.retryMin,max:nf.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:nf.a.image_loader.lastTryDelayTime.min,max:nf.a.image_loader.lastTryDelayTime.max},shouldRetryOnError:async({error:e})=>{if(!a.ModuleContainer.resolve(Rf.b).isOnline)return!1;return e instanceof Of.NotReadyError||e instanceof Of.TimeoutTTFB||e instanceof Of.TimeoutError},afterRetry:async({success:e,shouldRetry:t,nTry:s,duration:a})=>{e||this.Logger.zsymb(0,"SHod_1",`Try ${s}: failed. Should retry: ${t} after ${a}ms`),e||t||this.Logger.zsymb(0,"K-zieX",`MediaDiskFetcher: Download failed after ${s} tries`)}}),this._deleteLocalSource=async e=>{if(e)try{await new Promise(((t,s)=>{$znode.fs.unlink(e,(a=>{a?(this.Logger.zsymb(18,"IJviuE","MediaDiskFetcher: deleteLocalSource error",e,a),s(a)):t(!0)}))}))}catch(t){zconsole.zsymb(15,"ukzmn3",["MediaDiskFetcher: deleteLocalSource error","xi52GE"],t)}else zconsole.zsymb(21,"2RSpzV",["MediaDiskFetcher: deleteLocalSource localPath cannot be null","yqDDoT"],e)},this._copySource=async(e,t,s=!0)=>{if(e&&t)try{let a=e;s||(a=`${e}.tmp`,await new Promise(((t,s)=>{$znode.fsExtra.rename(e,a,(a=>{a?(this.Logger.zsymb(18,"-E_R78","MediaDiskFetcher: migrateSource error",e,a),s(a)):t(!0)}))}))),await $znode.fsExtra.copy(a,t,{dereference:!0,overwrite:!0}),s||await this._deleteLocalSource(a)}catch(a){zconsole.zsymb(15,"2FP4VK",["MediaDiskFetcher: migrateSource error","q1rldG"],a)}else zconsole.zsymb(21,"Skhrpv",["MediaDiskFetcher: migrateSource oldPath and newPath cannot be null","yImBOD"],e,t)}}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.imageLoader,[w.ZLoggerNametags.mediaDiskFetcher])),this._Logger}})||Cf;var Df;a.ModuleContainer.registerSingleton(Xp.b,Lf);let Af=Object(a.injectable)()(Df=class extends hs.b{async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:i,sendDttm:n,isLastFallbackUrl:r=!1,regenerateFromSource:o,entry:c}=e;let l;Object(ef.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(ef.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),l=i&&i.savePath?Np.j.DiskCache:Np.j.MemoryCache;const d=tf(s),u=sf(s);if(!d&&u)return Np.l.Success({mediaURL:s});if(!d&&!u){var h,g;const e=!u||["file://","zfile://"].some((e=>s.startsWith(e))),t=null==s||null===(h=s.replace("file://",""))||void 0===h?void 0:h.replace("zfile://","");if(e&&(null===(g=$znode.fs)||void 0===g?void 0:g.existsSync(t)))return Np.l.Success({mediaURL:t});if(e)return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH})}if(e.useHttpsSource){try{return await ui.default.checkAlive(s),Np.l.Success({mediaURL:s})}catch(_){}return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH})}if(l===Np.j.MemoryCache)try{return await a.ModuleContainer.resolve(Xp.a).fetch({mediaId:t,source:s,options:{cacheControl:"cache",sendDttm:n,regenerateFromSource:o,isLastFallbackUrl:r,useDiskCache:!1,useMemCache:!0},entry:c})}catch(b){return Promise.reject(b)}Object(ef.a)("object"==typeof i&&"string"==typeof i.savePath&&!!i.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${i}`);const{savePath:m,downloadEntrySerial:p,getSavePath:f,getOldLocalPathForMigration:v}=i;return a.ModuleContainer.resolve(Xp.b).fetch({mediaId:t,source:s,options:{entrySerial:p,savePath:m,sendDttm:n,regenerateFromSource:o,isLastFallbackUrl:r,getSavePath:f,getOldLocalPathForMigration:v},entry:c})}async fetchSocialMediaStandalone(e){const{mediaId:t,source:s,entry:i=Np.k.UNKNOWN}=e;Object(ef.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(ef.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`);const n=tf(s),r=sf(s);if(!n&&r)return Np.l.Success({mediaURL:s});try{return await a.ModuleContainer.resolve(Xp.a).fetch({mediaId:t,source:s,options:{cacheControl:"noCache"},entry:i})}catch(o){return Promise.reject(o)}}})||Df;a.ModuleContainer.registerSingleton(Xp.c,Af);var Ff,kf=s("Evs5");let Nf=Object(a.injectable)()(Ff=class{constructor(){this.loadMedia=async(e,t)=>{const{mediaId:s,entry:a,qualityFallback:i,fetchStrategy:n}=e,{fetcher:r,diskCacheConfig:o,disableLocalCache:c}=n,l=null==t?void 0:t.onFirstAvailable;let d=i,u=null;const h=new Set;let g=!1;for(;d;){const t=d.data.url,i=d.data.getLocalPath,p=d.data.getOldLocalPathForMigration;let f=d.data.regenerateFromSource;if(!t){d=d.nextOR||d.next;continue}const v=!d.nextOR&&!d.next;if(h.has(t)&&!v){d=d.nextOR||d.next;continue}g=!0;const _=await this._buildFetchConfig({mediaId:s,entry:a,source:t,getLocalPath:()=>null==i?void 0:i(t),downloadEntrySerial:null==o?void 0:o.downloadEntrySerial,autoDownload:!!u,sendDttm:e.sendDttm,isLastFallbackUrl:v,regenerateFromSource:f,disableLocalCache:c,getOldLocalPathForMigration:p}),b=await r(_);if("ERROR"==b.type){if(b.data.error&&Object(cf.l)(b.data.error))return Np.l.Failure({code:Np.d.LIBJXL_ERROR,error:b.data.error});h.add(t),d=d.nextOR||d.next;continue}let I=null,y=null,S=null;try{const t=e.mediaId.split(".");3===t.length&&(I=t[0],y=t[1],S=t[2])}catch(m){}if(I&&Up.c.log(I,{msgFormat:Object(rf.g)(t)?".jxl":".jpg"}),!u&&(u={mediaURL:b.data.mediaURL},null==l||l(Np.l.Success(u)),!n.fetchAllAvailable))break;d=d.next}return g?null===u?Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:s}):Np.l.Success(u):Np.l.Failure({code:Np.d.EMPTY_SOURCE,error:s})},this.loadImage=async(e,t)=>{const{mediaId:s,entry:i,srcs:n,downloadAllResources:r}=e,o=a.ModuleContainer.resolve(Xp.c).fetch,c=null==t?void 0:t.onFirstAvailable;let l=null;const d=new Set;let u=!1;const h=(e=>{const t={},s=[];for(const a of e)a.src&&!t[a.src]&&(s.push(a),t[a.src]=!0);return s})(n);for(let a=0;a<h.length;a++){var g,m,p,f;const t=h[a],n=t.src,_=null===(g=t.downloadConfig)||void 0===g?void 0:g.getLocalPath,b=null===(m=t.downloadConfig)||void 0===m?void 0:m.getOldLocalPathForMigration;let I=t.regenerateFromSource;const y=a===h.length-1;if(d.has(n)&&!y)continue;u=!0;if(e.useHttpsSource)try{if(tf(n)){if(!(await pf(n,{cacheResponse:!0,retryableErrorCodes:nf.a.image_loader.retryErrorCodes})))throw new Error("url is not alive. Continue to the next source");return Np.l.Success({mediaURL:n})}return Np.l.Success({mediaURL:n})}catch(v){d.add(n);continue}const S=await this._buildFetchConfig({mediaId:s,entry:i,source:n,getLocalPath:()=>null==_?void 0:_(n),downloadEntrySerial:null===(p=t.downloadConfig)||void 0===p?void 0:p.downloadEntrySerial,autoDownload:!!l,sendDttm:null===(f=t.downloadConfig)||void 0===f?void 0:f.sendDttm,isLastFallbackUrl:y,regenerateFromSource:I,useHttpsSource:e.useHttpsSource,getOldLocalPathForMigration:b}),C=await o(S);if("ERROR"==C.type){if(zconsole.error((function(e){return e[0]})`MediaPackageManager: fetch error`,C),C.data.error&&Object(cf.l)(C.data.error))return Np.l.Failure({code:Np.d.LIBJXL_ERROR,error:C.data.error});if(d.add(n),a===h.length-1)return C;continue}let E=null,O=null,M=null;try{const t=e.mediaId.split(".");3===t.length&&(E=t[0],O=t[1],M=t[2]),E&&Up.c.log(E,{msgFormat:Object(rf.g)(n)?".jxl":".jpg"})}catch(v){}if(!l&&(l={mediaURL:C.data.mediaURL},null==c||c(Np.l.Success(l)),!r))break}return u?null===l?Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:s}):Np.l.Success(l):Np.l.Failure({code:Np.d.EMPTY_SOURCE,error:s})},this._buildFetchConfig=async e=>{Object(ef.a)(!!e&&"object"==typeof e,`_buildDownloadConfig: config must be object, got ${e}`);const t=Object(e);Object(ef.a)("string"==typeof t.mediaId,`_buildDownloadConfig: mediaId must be string, got ${null==t?void 0:t.mediaId}`),Object(ef.a)(t.entry in Np.k,`_buildDownloadConfig: entry must be MediaDisplayTarget, got ${null==t?void 0:t.entry}`),Object(ef.a)("string"==typeof t.source,`_buildDownloadConfig: source must be string, got ${null==t?void 0:t.source}`);const s={mediaId:t.mediaId,source:t.source,sendDttm:t.sendDttm,isLastFallbackUrl:t.isLastFallbackUrl,regenerateFromSource:t.regenerateFromSource,entry:t.entry};if(t.getLocalPath&&!t.disableLocalCache){const e=await t.getLocalPath();s.diskFetcherConfig={savePath:e,downloadEntrySerial:t.downloadEntrySerial,autoDownload:t.autoDownload,getSavePath:t.getLocalPath,getOldLocalPathForMigration:t.getOldLocalPathForMigration}}return s}}abort(e,t){}})||Ff;a.ModuleContainer.registerSingleton(kf.a,Nf);var Pf=s("o46R"),jf=s("OgkW"),Uf=s.n(jf);const Bf={FORWARD_MESSAGE:"FORWARD_MESSAGE",DOWNLOAD_MESSAGE:"DOWNLOAD_MESSAGE",RELOAD_MEDIA:"RELOAD_MEDIA"};var zf=s("Mf3M");const Gf=["failure"];var xf;Object(a.injectable)()(xf=Object(xi.b)(Rf.b)(xf=function(e,t){return Object(a.inject)(kf.a)(e,void 0,0)}(xf=function(e,t){return Object(a.inject)(m.a)(e,void 0,1)}(xf=Reflect.metadata("design:type",Function)(xf=Reflect.metadata("design:paramtypes",[Object,void 0===m.a?Object:m.a])(xf=class{constructor(e,t){this.mediaPackageManager=e,this.application=t,this._revokedBlobURL=new Map,this._activeContextWindow=null,this._retryItems=new u.default({maxSize:1e3}),this.TaskQueue=void 0,this.UserSourceTracker=new Map,this.MAX_LOAD_TASKS=8,this._eventEmitter=new Uf.a,this.MAX_RETRIES=4,this._isOnline=!0,this.NETWORK_STABLE_TIMEOUT=2e3,this._networkRetryTimeout=null,this._retryNetworkWhenAliveQueue=new Map,this._PreTaskQueue=[],this.trackTempBlob=(e,t)=>{this.UserSourceTracker.set(e.toString(),t)},this.removeTrackTempBlob=e=>{this.UserSourceTracker.delete(e.toString())},this.setActiveWindowContext=e=>("WeakRef"in globalThis?this._activeContextWindow=new globalThis.WeakRef(e):this._activeContextWindow=e,this.removeActiveWindowContext),this.removeActiveWindowContext=()=>{this._activeContextWindow=null},this.getActiveWindowContext=()=>this._activeContextWindow instanceof globalThis.WeakRef?this._activeContextWindow.deref():this._activeContextWindow,this.manualRetry=async(e,t,s=!1)=>{var a,i,n,r,o,c;if(nf.a.image_loader.version===df.a.V2)return this.retryEntry(e,t,s);const l=this.data.get(e),d=`${e}-${t}`;if((null==l||null===(a=l.failure)||void 0===a?void 0:a.code)!==Np.d.FORCE_EXPIRE&&!this.TaskQueue.isRunning(d)&&(s||(null==l||null===(i=l.view)||void 0===i||null===(n=i[t])||void 0===n||null===(r=n.failure)||void 0===r?void 0:r.code)!==Np.d.FORCE_ERROR))if(this._retryable(d)||s)if(l){if(s&&this._retryItems.set(d,0),l&&l.view&&null!==(o=l.view)&&void 0!==o&&null!==(c=o[t])&&void 0!==c&&c.failure){var u,h;this._handleRevokeURL({payload:{blobURL:null==l||null===(u=l.view[t])||void 0===u?void 0:u.actual,mediaId:e}}),this._handleRevokeURL({payload:{blobURL:null==l||null===(h=l.view[t])||void 0===h?void 0:h.expected,mediaId:e}});const s=l.view,{[t]:a}=s,i=Object($i.a)(s,[t].map(Pf.a)),{failure:n}=l,r=Object($i.a)(l,Gf),o=Object(I.a)(Object(I.a)({},r),{},{view:i});this.data.set(e,o)}this.emit(Bf.RELOAD_MEDIA,{mediaId:e,entry:t,hotSwapSource:!0})}else this.emit(Bf.RELOAD_MEDIA,{mediaId:e,entry:t});else this.forceError(e,t)},this.forceError=(e,t,s)=>{var a;const i=this.data.get(e)||{mediaId:e,view:{}},n=(null==i?void 0:i.view)||{},r=null==s||null===(a=s.data)||void 0===a?void 0:a.code,o=r&&Object.values(Np.d).some((e=>e===r))?r:Np.d.FORCE_ERROR;this.data.set(e,Object(I.a)(Object(I.a)({},i),{},{view:Object(I.a)(Object(I.a)({},n),{},{[t]:{failure:{code:o,message:`ForceError=${r}`}}})})),this._signalRenderItem(this.name,e)},this.loadMedia=async(e,t={})=>{const s=_f(this._loadMedia,e,t),a=`${e.mediaId}-${e.entry}`,i=new bf(a,s);this.TaskQueue.addTask(i)},this._handleTaskQueueCompleted=e=>{if(this._PreTaskQueue.length>0&&this._PreTaskQueue.some((t=>t.taskId===e))){const e=this.MAX_LOAD_TASKS-this.TaskQueueSize;if(e>0&&this._PreTaskQueue.length>0){const t=this._PreTaskQueue.slice(0,e);this._PreTaskQueue.splice(0,t.length);const s=new Set;for(let e of t){const{mediaId:t,entry:a}=e;this._mayInitState(t);const i=this.data.get(t),n=Array.from(new Set([...(null==i?void 0:i.hotLoad)||[],a]));this.data.set(t,Object(I.a)(Object(I.a)({},i),{},{hotLoad:n})),s.add(t)}Array.from(s).forEach((e=>{this._signalRenderItem(this.name,e)}))}}},this.enqueueNetworkRetry=(e,t)=>{const s=this._retryNetworkWhenAliveQueue.get(e)||{};s[t]={mediaId:e,entry:t},this._retryNetworkWhenAliveQueue.set(e,s)},this.dequeueNetworkRetry=(e,t)=>{const s=this._retryNetworkWhenAliveQueue.get(e)||{};s&&(delete s[Np.k[t]],Object.values(s).length>0?this._retryNetworkWhenAliveQueue.set(e,s):this._retryNetworkWhenAliveQueue.delete(e))},this._removeEntryFromPreTaskQueue=(e,t)=>Array.isArray(e)&&0!==e.length?e.filter((e=>e!==t)):[],this._loadMedia=async(e,t={})=>{var s,a,i,n,r,o,c;const{forceLoad:l=!1}=t,d=(e.mediaId,e.entry,this.data.get(e.mediaId));if(globalThis.__alwaysForcePhotoExpired)return this.forceExpire(e.mediaId);if((null==d||null===(s=d.failure)||void 0===s?void 0:s.code)===Np.d.FORCE_EXPIRE||(null==d||null===(a=d.view)||void 0===a||null===(i=a[e.entry])||void 0===i||null===(n=i.failure)||void 0===n?void 0:n.code)===Np.d.FORCE_ERROR)return;const u=this._revokedBlobURL.get(e.mediaId),h=null==d||null===(r=d.view)||void 0===r?void 0:r[e.entry],g=!(null==h||!h.actual||null!=u&&u.has(h.actual)),m=[Np.e.EmptySource,Np.e.ZaloSource,Np.e.ExpiredSource];if(g&&m.some((e=>e===h.dataSrcId))||null!=d&&d.failure&&!1===l)return;if(this._mayInitState(e.mediaId,{rotateDeg:90*e.vOrient}),null!==(o=e.uploadSource)&&void 0!==o&&null!==(c=o.oriUrl)&&void 0!==c&&c.startsWith("blob:"))return void this._updateViewUpload(e.mediaId,e.entry,e.uploadSource);let p=null,f=null,v=null;try{const t=e.mediaId.split(".");3===t.length&&(p=t[0],f=t[1],v=t[2])}catch(_){}p&&Up.c.log(p,{clientId:p,dest_id:v,srcId:f});try{let s=!1;const a=this.data.get(e.mediaId),i=Object(I.a)(Object(I.a)({},t),{},{expiryCheck:e.expiryCheck}),n=await this.mediaPackageManager.loadMedia(e,{hasHd:null==a?void 0:a.hasHd,skipHdCheck:null==a?void 0:a.hasHd,onFirstAvailable:t=>{s=!0,this._handleLoadResponse(e.mediaId,e.entry,t,i)}});s||this._handleLoadResponse(e.mediaId,e.entry,n,i)}catch(_){zconsole.zsymb(18,"g_pVvG","ImageLoaderController: loadMedia error",_),p&&Up.c.endLog(p,{clientId:p,dest_id:v,srcId:f,renderStatus:0})}},this._retryable=e=>!((this._retryItems.get(e)||0)>=this.MAX_RETRIES||this.TaskQueue.isRunning(e)),this.runFullflow=(e,t)=>{var s,a,i,n;const r=this.data.get(e),o=`${e}-${t}`;if((null==r||null===(s=r.failure)||void 0===s?void 0:s.code)===Np.d.FORCE_EXPIRE||this.TaskQueue.isRunning(o)||(null==r||null===(a=r.view)||void 0===a||null===(i=a[t])||void 0===i||null===(n=i.failure)||void 0===n?void 0:n.code)===Np.d.FORCE_ERROR)return;if(!this._retryable(o))return void this.forceError(e,t);this.abanbonMedia(e,t);const c=this._retryItems.get(o)||0;this._retryItems.set(o,c+1),this.manualRetry(e,t)},this.abort=e=>{const t=this._retryItems.get(e)||0;this._retryItems.set(e,Math.max(t-1,0)),this.TaskQueue.abortTask(e)},this.loadDOMSuccess=(e,t)=>{try{const t=e.split(".");if(t.length){const e=t[0];Up.c.endLog(e,{renderStatus:1})}}catch(s){}this._retryItems.delete(`${e}-${t}`)},this.loadDOMError=(e,t)=>{},this._signalRenderItem=(...e)=>{Object(nc.h)(...e)},this._updateView=(e,t,s,a)=>{if(!s)return;const i=this.data.get(e);let n=i.view[t]||{};if(2===nf.a.image_loader.version)for(const[d,u]of Object.entries(i.view))u.failure&&u.failure.code===Np.d.FORCE_ERROR&&delete i.view[d];const r=this._revokedBlobURL.get(e);if(!n||!Boolean(n.actual)||n.actual&&null!=r&&r.has(n.actual))i.view=Object(I.a)(Object(I.a)({},i.view),{},{[t]:{actual:s,expected:s,dataSrcId:Np.e.ZaloSource}}),this.data.set(e,i),n&&n.actual&&n.actual!==n.expected&&this._handleRevokeURL({payload:{blobURL:n.actual,mediaId:e}});else if(Boolean(n.actual)&&n.actual!==s){const a=Object(I.a)(Object(I.a)({},n),{},{expected:s});i.view=Object(I.a)(Object(I.a)({},i.view),{},{[t]:a}),this.data.set(e,i)}if(null!=a&&a.hotSwapSource){var o,c;const i=this.data.get(e);var l;if(n=i.view[t]||{},a.reloadUploadSource&&null!==(o=n)&&void 0!==o&&o.actual&&n.actual!==s)URL.revokeObjectURL(null===(l=n)||void 0===l?void 0:l.actual),this.UserSourceTracker.delete(e.split(".")[0]);this.data.set(e,Object(I.a)(Object(I.a)({},i),{},{view:Object(I.a)(Object(I.a)({},null==i?void 0:i.view),{},{[t]:Object(I.a)(Object(I.a)({},null==i||null===(c=i.view)||void 0===c?void 0:c[t]),{},{actual:s,expected:s,dataSrcId:Np.e.ZaloSource})})})),n&&n.actual&&n.actual!==n.expected&&this._handleRevokeURL({payload:{blobURL:n.actual,mediaId:e}})}this._signalRenderItem(this.name,e)},this._handleRevokeURL=e=>{const t=null==e?void 0:e.payload;Object(ef.a)(!!t,"ImageLoaderController: revoke event payload undefined");const{blobURL:s,mediaId:a}=t;s&&URL.revokeObjectURL(s)},this.listenEvents=()=>{this.application.addEventListener(m.b.Exit,this._cleanupEvents),_e.default.subscribe(this._handleNetworkChange)},this._cleanupEvents=()=>{this.application.removeEventListener(m.b.Exit,this._cleanupEvents),_e.default.unsubscribe(this._handleNetworkChange)},this.loadImage=async e=>{const t=_f(this._loadImage,e),s=`${e.mediaId}-${e.entry}`,a=new bf(s,t);this.TaskQueue.addTask(a)},this.reloadImage=async(e,t)=>{const s=this.data.get(e);if(!s)return;s.view[t]&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{view:Object(I.a)(Object(I.a)({},s.view),{},{[t]:{}})})),this._signalRenderItem(this.name,e))},this.abortLoadImage=(e,t)=>{const s=`${e}-${t}`;this.TaskQueue.abortTask(s),this.dequeueNetworkRetry(e,Np.k[t])},this.swapUploadSourceOutview=(e,t)=>{const s=this.data.get(e),a=null==s?void 0:s.view[t],i=(null==s?void 0:s.uploadSource)===(null==a?void 0:a.actual);return!!a&&(!(!i||a.actual===a.expected||!Boolean(a.expected))&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{view:Object(I.a)(Object(I.a)({},null==s?void 0:s.view),{},{[t]:Object(I.a)(Object(I.a)({},a),{},{actual:a.expected,dataSrcId:Np.e.ZaloSource})})})),this._signalRenderItem(this.name,e),this._runCleanup(e,a.actual),!0))},this.freeImageCache=(e,t)=>{},this.retryEntry=(e,t,s=!1)=>{var a,i,n,r,o,c,l,d;const u=this.data.get(e);if(!u||null===(a=u.view)||void 0===a||null===(i=a[t])||void 0===i||!i.failure)return;const h=`${e}-${t}`;var g,m,p,f;if((null==u||null===(n=u.failure)||void 0===n?void 0:n.code)===Np.d.FORCE_EXPIRE||this.TaskQueue.isRunning(h)||!s&&(null==u||null===(r=u.view)||void 0===r||null===(o=r[t])||void 0===o||null===(c=o.failure)||void 0===c?void 0:c.code)===Np.d.FORCE_ERROR)zconsole.log("retryEntry: early return",e,t,(null==u||null===(g=u.failure)||void 0===g?void 0:g.code)===Np.d.FORCE_EXPIRE,this.TaskQueue.isRunning(h),!s&&(null==u||null===(m=u.view)||void 0===m||null===(p=m[t])||void 0===p||null===(f=p.failure)||void 0===f?void 0:f.code)===Np.d.FORCE_ERROR);else if(this._retryable(h)||s){var v,_;if(s&&this._retryItems.set(h,0),u&&u.view&&null!==(l=u.view)&&void 0!==l&&null!==(d=l[t])&&void 0!==d&&d.failure)this._handleRevokeURL({payload:{blobURL:null==u||null===(v=u.view[t])||void 0===v?void 0:v.actual,mediaId:e}}),this._handleRevokeURL({payload:{blobURL:null==u||null===(_=u.view[t])||void 0===_?void 0:_.expected,mediaId:e}}),null!=u&&u.view[t]&&(null==u||delete u.view[t]),null!=u&&u.failure&&(null==u||delete u.failure),this.data.set(e,u),u.hotLoad=this._removeEntryFromPreTaskQueue(u.hotLoad,t);this._signalRenderItem(this.name,e)}else this.forceError(e,t)},this._loadImage=async e=>{var t;const{mediaId:s,entry:a,uploadSource:i}=e,n=`${s}-${a}`;let r=null,o=null,c=null;try{const t=e.mediaId.split(".");3===t.length&&(r=t[0],o=t[1],c=t[2]),[Np.k.IMAGE_VIEWER,Np.k.IMAGE_VIEW_SLIDER,Np.k.MESSAGE_LIST,Np.k.MEDIA_STORE].some((e=>e===a))&&Kp.b.getInstance().record(Kp.a.RenderPhotoHighQuality,{logId:n,startRenderTs:performance.now()})}catch(d){}this._mayInitState(e.mediaId),null!=i&&i.blobUrl&&"string"==typeof i.blobUrl&&i.blobUrl.startsWith("blob:")&&await this._prepareUploadingSource(e);const l=this.data.get(s);if(i&&null!==(t=l.uploadSource)&&void 0!==t&&t.startsWith("blob:")&&!e.reloadUploadSource)this._updateViewUpload(s,Np.k[a],{oriUrl:l.uploadSource});else{r&&Up.c.log(r,{clientId:r,dest_id:c,srcId:o});try{let t=!1;const i={hotSwapSource:e.hotSwapSource,reloadUploadSource:e.reloadUploadSource},n=await this.mediaPackageManager.loadImage(e,{onFirstAvailable:s=>{t=!0,this._handleLoadResponse(e.mediaId,Np.k[e.entry],s,i)}});if(!this.isOnline&&e.retryWhenOnline&&"ERROR"===n.type&&n.data.code===Np.d.FAILURE_BY_FETCH)return this.enqueueNetworkRetry(s,Np.k[e.entry]),void this.forceError(s,Np.k[a],Np.l.Failure({code:Np.d.FAILURE_BY_NETWORK,error:n.data.error}));t||this._handleLoadResponse(e.mediaId,Np.k[e.entry],n)}catch(d){this.forceError(s,Np.k[a]),r&&Up.c.endLog(r,{clientId:r,dest_id:c,renderStatus:0})}}},this._resetItemState=(e,t)=>{if(!this.data.has(e))return;const s=this.data.get(e)||{mediaId:e,view:{}};if(!s.view[t])return;const a=s.view;delete a[t],this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{view:Object(I.a)({},a)})),this._signalRenderItem(this.name,e)},this._retryNetworkTasks=()=>{const e=Array.from(this._retryNetworkWhenAliveQueue.values());this._retryNetworkWhenAliveQueue.clear();for(let t of e){const e=Object.values(t);for(let t of e)this._resetItemState(t.mediaId,Np.k[t.entry])}},this._clearNetworkRetryTimeout=()=>{this._networkRetryTimeout&&(clearTimeout(this._networkRetryTimeout),this._networkRetryTimeout=null)},this._handleNetworkChange=(e,t)=>{e===ve.GeneralActions.NETWORK_STATUS_CHANGED&&(this._isOnline=!0===t),this._isOnline&&this._retryNetworkWhenAliveQueue.size>0?(this._clearNetworkRetryTimeout(),this._networkRetryTimeout=setTimeout(this._retryNetworkTasks,this.NETWORK_STABLE_TIMEOUT)):this._clearNetworkRetryTimeout()},this._prepareUploadingSource=async e=>{var t;const{mediaId:s,uploadSource:i}=e;let n=this.data.get(s)||{mediaId:s,view:{}};if(null!=i&&null!==(t=i.blobUrl)&&void 0!==t&&t.startsWith("blob:")){const e=s.split(".")[0],t=this.UserSourceTracker.get(e);if(t)n=Object(I.a)(Object(I.a)({},n),{},{uploadSource:t});else{const[t,s,o]=Object(xp.d)(i.width,i.height,1024,1024);{let e=(await a.ModuleContainer.resolve(zf.a.IPhotoMessageProcessorDef).getTempBlob(+i.clientId)).data;try{Object(ef.a)(!!e,`ImageLoaderController: no blob found by getTempBlob::${i.clientId}`),e&&o&&(e=await Object(jp.a)(e,{width:t,height:s,priority:2}));const a=URL.createObjectURL(e);n=Object(I.a)(Object(I.a)({},n),{},{uploadSource:a})}catch(r){}}n.uploadSource&&this.UserSourceTracker.set(e,n.uploadSource)}}this.data.set(s,n)},this.name=Rf.a,this.data=new Map,this.key="mediaId",this.init=()=>{this.listenEvents(),this._eventEmitter.setMaxListeners(50)},this.TaskQueue=new If(this.MAX_LOAD_TASKS,this._handleTaskQueueCompleted),this.init()}get TaskQueueSize(){return this.TaskQueue.taskQueue.length+this.TaskQueue.runningTasks.size}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter&&e in Bf&&this._eventEmitter.emit(e,t)}registerPreloadTask(e,t){const s=this._PreTaskQueue.findIndex((s=>s.mediaId===e&&s.entry===t));-1!==s&&this._PreTaskQueue.splice(s,1),this._PreTaskQueue.push({mediaId:e,entry:t,taskId:`${e}-${t}`})}unregisterPreloadTask(e,t){const s=this._PreTaskQueue.findIndex((s=>s.mediaId===e&&s.entry===t));-1!==s&&this._PreTaskQueue.splice(s,1)}getViewState(e,t){var s,a;return null===(s=this.data.get(e))||void 0===s||null===(a=s.view)||void 0===a?void 0:a[t]}allowOutviewUpdate(e,t){const s=this.data.get(e),a=null==s?void 0:s.view[t];a&&(a.dataSrcId!==Np.e.Upload||a.expected)?a.actual!==a.expected&&Boolean(a.expected)&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{view:Object(I.a)(Object(I.a)({},null==s?void 0:s.view),{},{[t]:Object(I.a)(Object(I.a)({},a),{},{actual:a.expected,dataSrcId:Np.e.ZaloSource})})})),this._signalRenderItem(this.name,e),this._runCleanup(e,a.actual)):this.emit("RELOAD_MEDIA",{mediaId:e,entry:t,hotSwapSource:!0,forceLoad:!0})}forceExpire(e){var t;this._retryNetworkWhenAliveQueue.has(e)&&this._retryNetworkWhenAliveQueue.delete(e);const s=this.data.get(e)||{mediaId:e,view:{}};(null==s||null===(t=s.failure)||void 0===t?void 0:t.code)!==Np.d.FORCE_EXPIRE&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{failure:{code:Np.d.FORCE_EXPIRE,message:"Force expire"},view:{}})),this._signalRenderItem(this.name,e))}rotateMedia(e,t){let s=this.data.get(e);if(!s)throw new Error(`rotateMedia failed with ${e}: ${t}`);let a=s.rotateDeg||0;a+=t,s=Object(I.a)(Object(I.a)({},s),{},{rotateDeg:a}),this.data.set(e,s),this._signalRenderItem(this.name,e)}abanbonMedia(e,t){if(!this.data.has(e))return;const s=this.data.get(e);null!=s&&s.view[t]&&(delete s.view[t],this.data.set(e,Object(I.a)({},s)),this._signalRenderItem(this.name,e))}clearItemData(e,t,s){const a=this.data.get(e);a&&(delete a.view[t],a.hotLoad=this._removeEntryFromPreTaskQueue(a.hotLoad,t),this.data.set(e,a),!0===(null==s?void 0:s.signalRenderItem)&&this._signalRenderItem(this.name,e))}_runCleanup(e,t){if(!t||!t.startsWith("blob:"))return;const s=this.data.get(e);if(!s)return void URL.revokeObjectURL(t);const a=s.view;Object.values(a).forEach((e=>{e.actual!==t&&e.expected})),URL.revokeObjectURL(t)}_mayInitState(e,t={},s=!0){let a=this.data.get(e);a||(a=Object(I.a)(Object(I.a)({mediaId:e,view:{}},t),{},{hotLoad:[]}),this.data.set(e,a)),s||this._signalRenderItem(this.name,e)}_handleLoadResponse(e,t,s,a){switch(s.type){case"ERROR":this._handleLoadError(s,e,t,a);break;case"SUCCESS":this._handleLoadSuccess(s,e,t,a);break;default:throw new Error(`Unknown response type: ${e} ${t} got ${null==s?void 0:s.type}`)}}_handleLoadError(e,t,s,a={}){const i=e.data,n=()=>{try{var e;const a=null==i||null===(e=i.error)||void 0===e?void 0:e.error;return[`id=${t}-${s}`,`stt=${i.code}`,`dlerr=${null==a?void 0:a.name}:${null==a?void 0:a.code}`].join("\n")}catch(a){return zconsole.zsymb(18,"ePm39A","ImageLoaderController: buildDebugInfo error",a),`status: ${i.code}`}};switch(i.code){case Np.d.FAILURE_BY_FETCH:{const e=this.data.get(t);e.view=Object(I.a)(Object(I.a)({},e.view),{},{[s]:Object(I.a)(Object(I.a)({},e.view[s]),{},{failure:{code:i.code,message:n()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case Np.d.FAILURE_BY_PRELOAD:{const e=this.data.get(t);e.view=Object(I.a)(Object(I.a)({},e.view),{},{[s]:Object(I.a)(Object(I.a)({},e.view[s]),{},{failure:{code:i.code,message:n()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case Np.d.EMPTY_SOURCE:{const e=this.data.get(t);e.view=Object(I.a)(Object(I.a)({},e.view),{},{[s]:Object(I.a)(Object(I.a)({},e.view[s]),{},{failure:{code:i.code,message:n()}})}),this.data.set(t,e),this._signalRenderItem(this.name,t);break}case Np.d.LIBJXL_ERROR:this.forceError(t,s)}}async _updateViewUpload(e,t,s){var a;if(null==s||!s.oriUrl)return;let i=this.data.get(e);const n=s.oriUrl;i?(null===(a=i.view[t])||void 0===a?void 0:a.actual)!==n&&Boolean(n)&&(i=Object(I.a)(Object(I.a)({},i),{},{view:Object(I.a)(Object(I.a)({},i.view),{},{[t]:{actual:n,expected:n,dataSrcId:Np.e.Upload}})})):i={mediaId:e,view:{[t]:{actual:n,expected:n,dataSrcId:Np.e.Upload}}},this.data.set(e,i),this._signalRenderItem(this.name,e)}_handleLoadSuccess(e,t,s,a){const i=e.data;this._updateView(t,s,i.mediaURL,a)}get isOnline(){return this._isOnline}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||xf)||xf)||xf)||xf)||xf);s("vUp1");var Vf,Hf=s("Mf7h"),Wf=s("8c0e"),qf=s("alF8");const Kf=new ui.LocalId;Object(a.injectable)()(Vf=Object(a.singleton)(Wf.a)(Vf=class{constructor(){this._linkPreviewDatas=new Map,this._lastCheckLinks=new Map,this._listeners=new Map}addListenerAtConv(e,t){if(e&&"function"==typeof t){const s=this._listeners.get(e);this._listeners.set(e,[...s||[],t])}}removeListenerAtConv(e,t){let s=this._listeners.get(e);s&&s.length>0&&(s=s.filter((e=>e!==t)),this._listeners.set(e,s))}removeAllListenerAtConv(e){this._listeners.delete(e)}setLastCheckLinkByConvId(e,t){this._lastCheckLinks.set(e,t)}isLastCheckLinkOfConv(e,t){const s=this._lastCheckLinks.get(e);return!!s&&qf.a.isEqualUrl(s,t)}getLinkPreviewDataByConvId(e){return this._linkPreviewDatas.get(e)||null}addLinkDataToConv(e,t){const s=this._prepareLinkPreviewData(e,t);this._linkPreviewDatas.set(e,Object(I.a)({},s));const a={action:ve.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(I.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,a),Hf.a.emit(ve.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(I.a)({},s)})}createLoadingLinkPreview(e,t){const s={id:Kf.next(),convId:e,content:{title:ce.a.str("STR_GETTING_LINK_INFO"),src:t,desc:"",thumb:"",loading:!0},link:t,shouldParseLinkOrContact:!0};e&&this._linkPreviewDatas.set(e,Object(I.a)({},s));const a={action:ve.LinkPreviewActions.NEW_LINK_PREVIEW,payload:{newLinkPreviewData:Object(I.a)({},s)}};this._notifyLinkPreviewDataChangeToConv(e,a),Hf.a.emit(ve.LinkPreviewActions.NEW_LINK_PREVIEW,{newLinkPreviewData:Object(I.a)({},s)})}removeLinkPreviewData(e){if(!e)return;this._linkPreviewDatas.delete(e);const t={action:ve.LinkPreviewActions.HIDE_LINK_PREVIEW,payload:null};this._notifyLinkPreviewDataChangeToConv(e,t),Hf.a.emit(ve.LinkPreviewActions.HIDE_LINK_PREVIEW,null)}_notifyLinkPreviewDataChangeToConv(e,t){const s=this._listeners.get(e);null==s||s.forEach((e=>{"function"==typeof e&&e({action:t.action,payload:t.payload})}))}_prepareLinkPreviewData(e,t){return{id:Kf.next(),convId:e,link:t.link,content:t.content,shouldParseLinkOrContact:!1}}})||Vf);var Zf,$f=s("iy3m"),Qf=s("twqL");Object(m.j)()(Zf=Object(a.singleton)(Qf.a)(Zf=Reflect.metadata("design:type",Function)(Zf=Reflect.metadata("design:paramtypes",[])(Zf=class{constructor(){this.changeTimeFlushNotiReactWhenResumeApp=this.changeTimeFlushNotiReactWhenResumeApp.bind(this),this.changeTimeFlushNotiReactWhenDisNetwork=this.changeTimeFlushNotiReactWhenDisNetwork.bind(this),this.changeTimeFlushNotiReactWhenStartApp=this.changeTimeFlushNotiReactWhenStartApp.bind(this)}onStart(e){this.changeTimeFlushNotiReactWhenStartApp()}changeTimeFlushNotiReactWhenResumeApp(){this.changeTimeFlushNotiReact(Object($f.d)())}setupTimer(e){rh.b.TimeFlushNotiReact=e,rh.b.TimeMaxWaiting=Object($f.a)(),rh.b.setupIntervalToFlushNotiReact(),rh.b.setupTimeoutToGoBackNormalCondition()}changeTimeFlushNotiReactWhenDisNetwork(e){if(e===le.a.CONNECTED){const e=le.b.getPreStateNetwork();e!==le.a.CONNECTED&&e!==le.a.NOT_SET&&this.changeTimeFlushNotiReact(Object($f.b)())}}changeTimeFlushNotiReactWhenStartApp(){this.changeTimeFlushNotiReact(Object($f.e)())}changeTimeFlushNotiReact(e){rh.b.notiReactTimeoutId?(rh.b.TimeFlushNotiReact!==e&&(rh.b.TimeFlushNotiReact=e,rh.b.setupIntervalToFlushNotiReact()),rh.b.TimeMaxWaiting!==Object($f.a)()&&(rh.b.TimeMaxWaiting=Object($f.a)(),rh.b.setupTimeoutToGoBackNormalCondition())):this.setupTimer(e)}})||Zf)||Zf)||Zf);var Yf,Jf=s("5cla"),Xf=s("WV6O"),ev=s("8JBC");const tv={currentView:Xf.j.FRIEND_LIST,unread:{newFriendRequests:[],newGroupRequests:[],newGroupInvitations:new Set,isUnread:!1}};Object(xi.b)(Jf.b)(Yf=Reflect.metadata("design:type",Function)(Yf=Reflect.metadata("design:paramtypes",[])(Yf=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.currentTab=void 0,this.data=new Map,this._Logger=void 0,this.name=Jf.a,this.key=Jf.a,this.data.set(Ar.c,tv),this.currentTab=""}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_updateState(e,t=Ar.c,s=!0){this.data.set(t,e),s&&Object(nc.h)(this.name,t)}_getState(e=Ar.c){return this.data.get(e)}_getAccessTime(){try{return JSON.parse(n.default.getInstance().getItemForCurrentUser(Xf.g))}catch(e){return this.Logger.zsymb(18,"LQIe7R","[_getAccessTime], error: "+JSON.stringify(e)),null}}_setAccessTime(e){n.default.getInstance().setItemForCurrentUser(Xf.g,JSON.stringify(e))}_setLastRequestFriendTime(e,t,s){let a=[];try{a=JSON.parse(n.default.getInstance().getItemForCurrentUser(Xf.i))||[]}catch(r){this.Logger.zsymb(18,"wWdLC-","[_setLastRequestFriendTime], error: "+JSON.stringify(r))}let i=[];switch(e){case"NEW":a.find((e=>(null==e?void 0:e.userId)===s))?(i=a.filter((e=>e.userId!==s)),i=[{ts:t,userId:s},...a]):i=[{ts:t,userId:s},...a];break;case"REMOVE":i=a.filter((e=>e.userId!==s))}n.default.getInstance().setItemForCurrentUser(Xf.i,JSON.stringify(i))}_setLastReceivedGroupInvitationTime(e,t,s){let a=[];try{const e=n.default.getInstance().getItemForCurrentUser(Xf.h);a=e&&JSON.parse(e)||[]}catch(r){this.Logger.zsymb(18,"yFiHav","[_setListReceivedGroupInvitationTime], error: "+JSON.stringify(r))}let i=[];switch(e){case"NEW":a.some((e=>(null==e?void 0:e.groupId)==s))&&(i=a.filter((e=>e.groupId!=s))),i=[{ts:t,groupId:s},...a];break;case"REMOVE":i=a.filter((e=>(null==e?void 0:e.groupId)!==s))}n.default.getInstance().setItemForCurrentUser(Xf.h,JSON.stringify(i))}_getLastRequestAddFriendTime(){let e;try{e=JSON.parse(n.default.getInstance().getItemForCurrentUser(Xf.i))}catch(t){this.Logger.zsymb(18,"jMNHja","[_getLastRequestAddFriendTime], error: "+JSON.stringify(t))}return e?e[0]:null}_getLastReceivedGroupInvitationTime(){let e;try{const t=n.default.getInstance().getItemForCurrentUser(Xf.h);e=t?JSON.parse(t):null}catch(t){this.Logger.zsymb(18,"WjXSRN","[_getLastReceivedGroupInvitationTime], error: "+JSON.stringify(t))}return e?e[0]:null}_onChangeView(e){switch(a.ModuleContainer.resolve(rc.SidebarController).updateSelectedId(null),e){case Xf.j.FRIEND_LIST:Object(tc.f)({type:ve.SideBarActions.SELECT_FRIEND_LIST,payload:{userId:"999"}});break;case Xf.j.GROUP_LIST:Object(tc.f)({type:ve.SideBarActions.SELECT_GROUP_CENTER,payload:{userId:"999"}});break;case Xf.j.FRIEND_REQUEST:Object(tc.f)({type:ve.SideBarActions.SELECT_FRIEND_CENTER,payload:{userId:"999"}});break;case Xf.j.GROUP_INVITATION:Object(tc.f)({type:ve.SideBarActions.SELECT_GROUP_INVITATION_CENTER,payload:{userId:"999"}})}}_onUpdateUnreadRequest(e,t){const s=this._getState();if(!s)return;let a=s.unread;switch(t){case"FRIEND":s.currentView!==Xf.j.FRIEND_REQUEST&&(a.newFriendRequests.push(e),a.isUnread=!0);break;case"GROUP":a.newGroupRequests.push(e);break;case"GROUP_INV":Ce.default.group_privacy.invitation_box.enable&&s.currentView!==Xf.j.GROUP_INVITATION&&(a.newGroupInvitations.add(e),a.isUnread=!0)}this._updateState(Object(I.a)(Object(I.a)({},s),{},{unread:a}),Ar.c,!0)}_clearUnreadOnOpenView(){const e=this._getState();if(!e)return;let t=e.unread;if(e.currentView===Xf.j.GROUP_INVITATION){t.newGroupInvitations.size>0&&(t.isUnread=!1),t.newGroupInvitations.clear();const e=this._getLastReceivedGroupInvitationTime();e&&n.default.getInstance().setItemForCurrentUser(Xf.h,JSON.stringify([e]))}else t.newFriendRequests.length+t.newGroupRequests.length>0&&(t.isUnread=!1),t.newFriendRequests=[],t.newGroupRequests=[];this._updateState(Object(I.a)(Object(I.a)({},e),{},{unread:t}),Ar.c,!0)}_clearGroupInvitationUnreadItem(e){const t=this._getState();if(!t)return;let s=t.unread;s.newGroupInvitations.delete(e);0===s.newGroupInvitations.size+s.newFriendRequests.length+s.newGroupRequests.length&&(s.isUnread=!1),this._updateState(Object(I.a)(Object(I.a)({},t),{},{unread:s}),Ar.c,!0)}_clearFriendRequestUnreadItem(e){const t=this._getState();if(!t)return;let s=t.unread;s.newFriendRequests=s.newFriendRequests.filter((t=>t!==e));0===s.newGroupInvitations.size+s.newFriendRequests.length+s.newGroupRequests.length&&(s.isUnread=!1),this._updateState(Object(I.a)(Object(I.a)({},t),{},{unread:s}),Ar.c,!0)}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetTabData(){this.currentTab="",ev.a.resetNewFriendList(),a.ModuleContainer.resolve(Jf.b).resetData(),a.ModuleContainer.resolve(Jf.g).resetData(),a.ModuleContainer.resolve(Jf.f).resetData(),a.ModuleContainer.resolve(Jf.l).resetData(),a.ModuleContainer.resolve(Jf.j).resetData(),a.ModuleContainer.resolve(Jf.o).resetData()}resetData(){const e=this._getState();e&&this._updateState(Object(I.a)(Object(I.a)({},e),{},{currentView:Xf.j.FRIEND_LIST}))}changeView(e){const t=this._getState();t&&this._updateState(Object(I.a)(Object(I.a)({},t),{},{currentView:e}),Ar.c,!0),this.currentTab=e,this._onChangeView(e)}onClickContabTabEntry(){if(document.getElementById("ContactTabV2")){const e=this._getState(),t=(null==e?void 0:e.currentView)||tv.currentView;this._onChangeView(t)}}onContactTab(e){a.ModuleContainer.resolve(Jf.c).onOpenContactTab(e),this._setAccessTime(e),this._clearUnreadOnOpenView()}getDefaultView(){if(this.currentTab)return this.currentTab;const e=this._getAccessTime(),t=this._getLastRequestAddFriendTime(),s=this._getLastReceivedGroupInvitationTime();if(!t)return Ce.default.group_privacy.invitation_box.enable&&s&&s.ts>=Ct.default.getTimeNow()-Ce.default.group_privacy.invitation_box.max_auto_focus_time?this.currentTab=Xf.j.GROUP_INVITATION:this.currentTab=Xf.j.FRIEND_LIST,this.currentTab;const a=!Ce.default.contactTabV2.enable_rule_last_view_friend_req||e&&t.ts<e,i=t.ts<Ct.default.getTimeNow()-864e5;return Ce.default.group_privacy.invitation_box.enable&&s&&s.ts>t.ts&&s.ts>=Ct.default.getTimeNow()-Ce.default.group_privacy.invitation_box.max_auto_focus_time?(this.currentTab=Xf.j.GROUP_INVITATION,this.currentTab):(this.currentTab=i&&a?Xf.j.FRIEND_LIST:Xf.j.FRIEND_REQUEST,this.currentTab)}getState(e){return this._getState(e)||tv}clearFriendRequestUnread(e){const t=this._getState();if(e.length>0&&t){const s=new Set(e),a=t.unread,i=a.newFriendRequests.filter((e=>!s.has(e)));i.length!==a.newFriendRequests.length&&(a.newFriendRequests=i,a.isUnread=a.newFriendRequests.length>0||a.newGroupInvitations.size>0,this._updateState(Object(I.a)(Object(I.a)({},t),{},{unread:a}),Ar.c,!0))}for(const s of e)this._setLastRequestFriendTime("REMOVE",0,s)}clearGroupInvitationUnread(e){const t=this._getState();if(e.length>0&&t){const s=t.unread,a=new Set(s.newGroupInvitations.values());e.forEach((e=>a.delete(e))),a.size!==s.newGroupInvitations.size&&(s.newGroupInvitations=a,s.isUnread=s.newFriendRequests.length>0||s.newGroupInvitations.size>0,this._updateState(Object(I.a)(Object(I.a)({},t),{},{unread:s}),Ar.c,!0))}for(const s of e)this._setLastReceivedGroupInvitationTime("REMOVE",0,s)}onUpdateRequestTracking(e,t,s,a){switch("NEW"===t?this._onUpdateUnreadRequest(a,e):"REMOVE"===t&&(Ce.default.group_privacy.invitation_box.enable&&"GROUP_INV"===e&&a?this._clearGroupInvitationUnreadItem(a):this._clearFriendRequestUnreadItem(a)),e){case"FRIEND":this._setLastRequestFriendTime(t,s||0,a);break;case"GROUP":default:break;case"GROUP_INV":Ce.default.group_privacy.invitation_box.enable&&this._setLastReceivedGroupInvitationTime(t,s||0,a)}}computeUpdateUnread(){const e=this._getState();let t=(null==e?void 0:e.unread)||tv.unread;const s=(null==e?void 0:e.currentView)||tv.currentView,a=this._getAccessTime(),i=this._getLastRequestAddFriendTime(),n=this._getLastReceivedGroupInvitationTime();a&&(i&&a<i.ts&&t.newFriendRequests.push(i.userId),Ce.default.group_privacy.invitation_box.enable&&n&&a<n.ts&&t.newGroupInvitations.add(n.groupId),t.isUnread=t.newFriendRequests.length>0||t.newGroupInvitations.size>0,this._updateState({currentView:s,unread:t},Ar.c,!0))}onInitUnreadRequest(){this.computeUpdateUnread()}onReceivedControlEvents(e){for(const t of e)if(t.act===Xf.a.CLICKED)t.data.ts_clicked&&(this._setAccessTime(t.data.ts_clicked),this._clearUnreadOnOpenView());else this.Logger.zsymb(18,"Da1Yo0","unhandled event",t)}})||Yf)||Yf);var sv,av=s("iq5K"),iv=s("d++c");Object(xi.b)(Jf.g)(sv=Object(a.injectable)()(sv=function(e,t){return a.ModuleContainer.inject(Jf.f)(e,void 0,0)}(sv=function(e,t){return a.ModuleContainer.inject(rc.LabelDataManager)(e,void 0,1)}(sv=Reflect.metadata("design:type",Function)(sv=Reflect.metadata("design:paramtypes",[void 0===Jf.f?Object:Jf.f,void 0===rc.LabelDataManager?Object:rc.LabelDataManager])(sv=class{constructor(e,t){this.friendInfoManager=e,this.labelDataManager=t,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listFriend=void 0,this.initListFriend=void 0,this.currentPage=void 0,this.didSort=void 0,this.eventBusInstance=void 0,this._Logger=void 0,this.name=Jf.e,this.key=Jf.e,this.listState=av.d,this.listFriend=[],this.initListFriend=[],this.currentPage=1,this.didSort=!1,this.eventBusInstance=null,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(nc.i)(this.name,"all")}_signalRenderItem(){Object(nc.h)(this.name,"all")}_signalRenderBoth(){Object(nc.h)(this.name,"all"),Object(nc.i)(this.name,"all")}_onRemoveFriend(e){this.listFriend.includes(e.userId)&&(this.listFriend.splice(this.listFriend.indexOf(e.userId),1),this.initListFriend.splice(this.initListFriend.indexOf(e.userId),1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth())}_onAddFriend(e){this.listFriend.includes(e.userId)||(this.listFriend.unshift(e.userId),this.initListFriend.unshift(e.userId),ev.a.addNewFriendUid(e.userId),this._signalRenderList())}_getItemInfo(e){return this.friendInfoManager.getItem({key:e,version:1,extraData:null},null)||this.friendInfoManager.loadInfoNotRender({userId:e})}_onBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onUnBlockFriend(e){this.friendInfoManager.onLoadInfo({userId:e.userId})}_onEditAlias(e){this.friendInfoManager.onLoadInfo({userId:e.userId}),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!this.isDidSort(),!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderBoth()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((a=>{if(this.friendInfoManager.onLoadInfo({userId:a}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listFriend.findIndex((e=>e===a));"remove"===t&&-1!==e?(this.listFriend.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listFriend.push(a),this.listFriend=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1,!1),this.listState.totalRecord=this.listFriend.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.friendInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}addComponentListeners(){Ii.default.subscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),Ii.default.subscribeEventFriend(Y.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),Ii.default.subscribeEventFriend(Y.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),Ii.default.subscribeEventFriend(Y.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance=_e.default.on(ve.FetchActions.UPDATE_NAME,this._onEditAlias.bind(this)),this.labelDataManager.addEventListener(rc.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(rc.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(rc.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){Ii.default.unsubscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,this._onRemoveFriend.bind(this)),Ii.default.unsubscribeEventFriend(Y.EventFriend.ADD_FRIEND,this._onAddFriend.bind(this)),Ii.default.unsubscribeEventFriend(Y.EventFriend.BLOCK_FRIEND,this._onBlockFriend.bind(this)),Ii.default.unsubscribeEventFriend(Y.EventFriend.UNBLOCK_FRIEND,this._onUnBlockFriend.bind(this)),this.eventBusInstance&&this.eventBusInstance.remove(),this.labelDataManager.removeEventListener(rc.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(rc.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(rc.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}async onLoadList(e){try{const t=await ev.a.getFriendList(e);this.listFriend=t,this.initListFriend=t,this.listState.totalRecord=t.length,this.listFriend=this._handleFilter(av.g.searching.searchText,av.g.searching.sorter,av.g.searching.filter,!0,!1),this.initListFriend=this._handleFilter(av.g.searching.searchText,av.g.searching.sorter,av.g.searching.filter,!0,!0),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}catch(t){this.Logger.zsymb(18,"x5AtOS","[FriendListController] -> [onLoadList], error: "+JSON.stringify(t))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListFriend];return[...this.initListFriend].filter((t=>{const s=this._getItemInfo(t);return Object(iv.a)((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterAll(e){return e}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!In.a.isThreadHidden(e)))}onSortAlpha(e,t){if(e===av.p.DEFAULT)return t;return t.sort(((t,s)=>{const a=this._getItemInfo(t),i=this._getItemInfo(s);return((t,s)=>{const a=/^[a-zA-Z]/,i=a.test(ui.default.simpleStripVietnamese(t)),n=a.test(ui.default.simpleStripVietnamese(s));switch(e){case av.p.ALPHA_INCREASE:return!i&&n?1:i&&!n?-1:t.localeCompare(s);case av.p.ALPHA_DECREASE:return!i&&n?-1:i&&!n?1:s.localeCompare(t);default:return 0}})((null==a?void 0:a.displayName.toLowerCase())||(null==a?void 0:a.zaloName.toLowerCase())||"",(null==i?void 0:i.displayName.toLowerCase())||(null==i?void 0:i.zaloName.toLowerCase())||"")}))}onMovingNewFriend(e){let t=[],s=[];for(let a=e.length-1;a>=0;a--){const i=this._getItemInfo(e[a]);null!=i&&i.isNewFriend?t.unshift(null==i?void 0:i.userId):s.unshift(null==i?void 0:i.userId)}return[...t,...s]}_handleFilter(e,t,s,a,i){var n;let r=[];return r=this.onFilterByName(e),r=this.onFilterByLabel(null==s||null===(n=s.label)||void 0===n?void 0:n.convs,r),r=this.onFilterAll(r),r=this.onSortAlpha(t,r),r=this.onFilterHidden(i,e,r),a&&(r=this.onMovingNewFriend(r)),r}_checkDidSort(e){return e!==av.p.ALPHA_INCREASE?this.didSort=!0:this.didSort=!1,this.didSort}isDidSort(){return this.didSort}_updateInitListFriendWithoutDockNewFriends(){this.initListFriend=this._handleFilter(av.g.searching.searchText,av.g.searching.sorter,av.g.searching.filter,!1,!0),this.listState.totalRecord=this.listFriend.length}onFilter(e,t,s){const a=this._checkDidSort(t);a&&this._updateInitListFriendWithoutDockNewFriends(),this.listFriend=this._handleFilter(e,t,s,!a,!1),this.listState.totalRecord=this.listFriend.length,this._signalRenderItem(),this._signalRenderList()}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}getList(e,t){return this.listFriend}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listFriend=[],this.initListFriend=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:av.p.ALPHA_INCREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1,this.didSort=!1}})||sv)||sv)||sv)||sv)||sv);var nv;Object(xi.b)(Jf.f)(nv=Reflect.metadata("design:type",Function)(nv=Reflect.metadata("design:paramtypes",[])(nv=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=Jf.d,this.key=Jf.d}init(e){throw new Error("Method not implemented.")}onLoadInfo(e){const t=ev.a.getFriendInfo(e);t&&(this.data.set(e.userId,t),Object(nc.h)(this.name,e.userId))}loadInfoNotRender(e){const t=ev.a.getFriendInfo(e);return t?(this.data.set(e.userId,t),t):null}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||nv)||nv);var rv;Object(xi.b)(Jf.l)(rv=Object(a.injectable)()(rv=function(e,t){return a.ModuleContainer.inject(Jf.j)(e,void 0,0)}(rv=function(e,t){return a.ModuleContainer.inject(Nn.PreviewDataManager)(e,void 0,1)}(rv=function(e,t){return a.ModuleContainer.inject(rc.LabelDataManager)(e,void 0,2)}(rv=Reflect.metadata("design:type",Function)(rv=Reflect.metadata("design:paramtypes",[void 0===Jf.j?Object:Jf.j,void 0===Nn.PreviewDataManager?Object:Nn.PreviewDataManager,void 0===rc.LabelDataManager?Object:rc.LabelDataManager])(rv=class{constructor(e,t,s){this.groupInfoManager=e,this.previewDataManager=t,this.labelDataManager=s,this.type=void 0,this.name=void 0,this.key=void 0,this.listState=void 0,this.listGroup=void 0,this.initListGroup=void 0,this.currentPage=void 0,this._Logger=void 0,this.name=Jf.i,this.key=Jf.i,this.listState=av.e,this.listGroup=[],this.initListGroup=[],this.currentPage=1,this._onHandleConvRemoveLabel=this._onHandleConvRemoveLabel.bind(this),this._onHandleConvAddLabel=this._onHandleConvAddLabel.bind(this),this._onHandleRemoveLabel=this._onHandleRemoveLabel.bind(this)}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderList(){Object(nc.i)(this.name,"all")}_signalRenderItem(){Object(nc.h)(this.name,"all")}_signalRenderBoth(){Object(nc.h)(this.name,"all"),Object(nc.i)(this.name,"all")}_getItemInfo(e){return this.groupInfoManager.getItem({key:e,version:1,extraData:null},null)||this.groupInfoManager.loadInfoNotRender({userId:e})}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.listState}async onLoadList(){try{const e=await ev.b.getGroupList(),t=e.map((e=>e.userId));this.listGroup=t,this.initListGroup=t,this.listState.totalRecord=t.length,this.groupInfoManager.setMultiGroupInfo(e),this.listGroup=this._handleFilter(av.h.searching.searchText,av.h.searching.sorter,av.h.searching.filter,!1),this.initListGroup=this._handleFilter(av.h.searching.searchText,av.h.searching.sorter,av.h.searching.filter,!0),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}catch(e){this.Logger.zsymb(18,"PLoUn1","[GroupListController] -> [onLoadList], error: "+JSON.stringify(e))}}onLoadMore(){this.currentPage++,this._signalRenderList()}onFilterByName(e){if(!e)return[...this.initListGroup];return this.initListGroup.filter((t=>{const s=this._getItemInfo(t);return Object(iv.a)((null==s?void 0:s.displayName.toLowerCase())||"",e.toLowerCase())}))}onFilterByLabel(e,t){if(!e)return t;if(0===e.length)return[];return t.filter((t=>e.includes(t)))}onFilterMyAdminGroup(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e&&!el.q.isCommunityFromInfo(s)}))}onFilterMyAdminCommunity(e,t){if(!e)return t;return t.filter((t=>{const s=this._getItemInfo(t);return(null==s?void 0:s.creatorId)===e&&el.q.isCommunityFromInfo(s)}))}onFilterAll(e){return e}onSortAlpha(e,t){return e===av.p.DEFAULT||e===av.p.ACTION_INCREASE||e===av.p.ACTION_DECREASE?t:t.sort(((t,s)=>{const a=this._getItemInfo(t),i=this._getItemInfo(s),n=(null==a?void 0:a.displayName.toLowerCase())||"",r=(null==i?void 0:i.displayName.toLowerCase())||"";switch(e){case av.p.ALPHA_INCREASE:return n.localeCompare(r);case av.p.ALPHA_DECREASE:return r.localeCompare(n);default:return 0}}))}onFilterHidden(e,t,s){return t||e?s:s.filter((e=>!In.a.isThreadHidden(e)))}onSortActionTime(e,t){return e===av.p.DEFAULT||e===av.p.ALPHA_INCREASE||e===av.p.ALPHA_DECREASE?t:t.sort(((t,s)=>{var a,i;const n=(null===(a=this.previewDataManager.getPreviewByIDSync(t))||void 0===a?void 0:a.messageTime)||0,r=(null===(i=this.previewDataManager.getPreviewByIDSync(s))||void 0===i?void 0:i.messageTime)||0;switch(e){case av.p.ACTION_DECREASE:if(r&&n){if(r>n)return 1;if(r<n)return-1}return r&&!n?1:!r&&n?-1:0;case av.p.ACTION_INCREASE:if(r&&n){if(r<n)return 1;if(r>n)return-1}return!r&&n?1:r&&!n?-1:0;default:return 0}}))}_handleFilter(e,t,s,a){var i;let n=[];return n=this.onFilterByName(e),n=this.onFilterByLabel(null==s||null===(i=s.label)||void 0===i?void 0:i.convs,n),n=this.onFilterMyAdminGroup((null==s?void 0:s.admin)||"",n),s&&s.adminComm&&(n=this.onFilterMyAdminCommunity(s.adminComm,n)),n=this.onFilterAll(n),n=this.onSortAlpha(t,n),n=this.onSortActionTime(t,n),n=this.onFilterHidden(a,e,n),n}onFilter(e,t,s){this.listGroup=this._handleFilter(e,t,s,!1),this.listState.totalRecord=this.listGroup.length,this._signalRenderItem(),this._signalRenderList()}_onUpdateTagConv(e,t="add"){let s=!1;e.convIds.forEach((a=>{if(this.groupInfoManager.onLoadInfo({userId:a}),this.listState.searching.filter.label.id&&this.listState.searching.filter.label.id===+e.labelId){const e=this.listGroup.findIndex((e=>e===a));"remove"===t&&-1!==e?(this.listGroup.splice(e,1),this.listState.totalRecord=Math.max(this.listState.totalRecord-1,0),s=!0):"add"===t&&-1===e&&(this.listGroup.push(a),this.listGroup=this._handleFilter(this.listState.searching.searchText,this.listState.searching.sorter,this.listState.searching.filter,!1),this.listState.totalRecord=this.listGroup.length,s=!0)}})),s&&this._signalRenderBoth()}_onHandleConvAddLabel(e){this._onUpdateTagConv(e.payload,"add")}_onHandleConvRemoveLabel(e){this._onUpdateTagConv(e.payload,"remove")}_onHandleRemoveLabel(e){if(e.payload&&e.payload.convs&&e.payload.convs.length){for(const t of e.payload.convs)this.groupInfoManager.onLoadInfo({userId:t});this._signalRenderBoth()}}_onLeaveGroup(e){for(let t=0;t<e.length;t++){if(!this.listGroup.includes(e[t]))return;this.listGroup.splice(this.listGroup.indexOf(e[t]),1),this.initListGroup.splice(this.listGroup.indexOf(e[t]),1),this.listState.totalRecord=this.listGroup.length}this._signalRenderBoth()}addComponentListeners(){yn.default.subscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.addEventListener(rc.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.addEventListener(rc.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.addEventListener(rc.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}removeComponentListeners(){yn.default.unsubscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this._onLeaveGroup.bind(this)),this.labelDataManager.removeEventListener(rc.LabelEvents.LabelAddConvs,this._onHandleConvAddLabel),this.labelDataManager.removeEventListener(rc.LabelEvents.LabelRemoveConvs,this._onHandleConvRemoveLabel),this.labelDataManager.removeEventListener(rc.LabelEvents.RemoveLabel,this._onHandleRemoveLabel)}getList(e,t){return this.listGroup}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}setSearchText(e){this.listState.searching.searchText=e,this._signalRenderItem()}setSorter(e){this.listState.searching.sorter=e,this._signalRenderItem()}setFilter(e){this.listState.searching.filter=e,this._signalRenderItem()}getFilter(){return this.listState.searching.filter}getSorter(){return this.listState.searching.sorter}resetData(){this.listGroup=[],this.initListGroup=[]}resetState(){this.listState={totalRecord:0,searching:{searchText:"",sorter:av.p.ACTION_DECREASE,filter:{label:{convs:null,id:null},admin:"",all:!0}}},this.currentPage=1}})||rv)||rv)||rv)||rv)||rv)||rv);var ov;Object(xi.b)(Jf.j)(ov=Reflect.metadata("design:type",Function)(ov=Reflect.metadata("design:paramtypes",[])(ov=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=Jf.h,this.key=Jf.h}init(e){throw new Error("Method not implemented.")}async onLoadInfo(e){const t=ev.b.getGroupInfoSync(e);t&&(this.data.set(e.userId,t),Object(nc.h)(this.name,e.userId))}loadInfoNotRender(e){const t=ev.b.getGroupInfoSync(e);return t?(this.data.set(e.userId,t),t):null}loadMultiGroupInfo(e){for(const t of e)this.loadInfoNotRender({userId:t})}setMultiGroupInfo(e){for(const t of e)this.data.set(t.userId,t)}openGroupMemberPopup(e){const t=this.data.get(e);Ie.ModalManagerV2.openModal({windowId:"1",name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:{group_member:t}})}getItem(e,t){return this.data.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}resetData(){this.data.clear()}})||ov)||ov);let cv=function(e){return e[e.RECOMMEND=1]="RECOMMEND",e[e.RECEIVE=2]="RECEIVE",e}({});const lv=500,dv=500;var uv;Object(xi.b)(Jf.o)(uv=function(e,t){return a.ModuleContainer.inject(Jf.b)(e,void 0,0)}(uv=Reflect.metadata("design:type",Function)(uv=Reflect.metadata("design:paramtypes",[void 0===Jf.b?Object:Jf.b])(uv=class extends hs.b{constructor(e){super(),this.contactTabController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this._Logger=void 0,this.name=Jf.m,this.key=Jf.m,this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}}),this.addPublicListeners()}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}_signalRenderItem(){Object(nc.h)(this.name,"all")}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.data.get(e.key)}_updateLoadingState(e,t){const{listFriendReceived:s=[],listFriendSuggest:a=[],listFriendSent:i=[]}=this.data.get("all")||{};let{isLoadingRecommendFriendList:n,isLoadingRequestedFriendList:r}=this.data.get("all")||{};if("RecommendFriendList"===e)switch(t){case"ON":n||0!==s.length||0!==a.length||(n=!0);break;case"OFF":n&&(n=!1)}if("RequestedFriendList"===e)switch(t){case"ON":r||0!==i.length||(r=!0);break;case"OFF":r&&(r=!1)}this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{isLoadingRecommendFriendList:n,isLoadingRequestedFriendList:r})),this._signalRenderItem()}async onLoadRequestedFriendList(){const e=Date.now();try{this._updateLoadingState("RequestedFriendList","ON");const t=await ev.c.getRequestedFriendList();Date.now()-e<lv&&await Object(iv.b)(dv),this._updateLoadingState("RequestedFriendList","OFF");const s=Object.keys(t).map((e=>t[e])).sort(((e,t)=>{var s,a;const i=null===(s=e.fReqInfo)||void 0===s?void 0:s.time,n=null===(a=t.fReqInfo)||void 0===a?void 0:a.time;return n>i?1:n<i?-1:0})),{listFriendReceived:a=[],listFriendSuggest:i=[],mapRelatedGroup:n={}}=this.data.get("all")||{};this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:a,listFriendSent:s,listFriendSuggest:i,mapRelatedGroup:n})),this._signalRenderItem()}catch(t){Date.now()-e<lv&&await Object(iv.b)(dv),this._updateLoadingState("RequestedFriendList","OFF"),this.Logger.zsymb(18,"nr6fAV","[InvitationController] -> [onLoadRequestedFriendList], error: "+JSON.stringify(t))}}async onLoadRecommendFriendList(){const e=Date.now();try{this._updateLoadingState("RecommendFriendList","ON");const t=await ev.c.getRecommendFriendList();if(Date.now()-e<lv&&await Object(iv.b)(dv),this._updateLoadingState("RecommendFriendList","OFF"),Array.isArray(t)&&t.length>0){const e=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===cv.RECEIVE})),s=t.filter((e=>{var t;return(null===(t=e.dataInfo)||void 0===t?void 0:t.recommType)===cv.RECOMMEND})),{listFriendSent:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{};this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:a,listFriendSuggest:s,mapRelatedGroup:i})),s.length>0&&this.dispatchEvent(new Xf.f(Xf.e.LoadRelatedGroups,"",{})),this._signalRenderItem()}}catch(t){Date.now()-e<lv&&await Object(iv.b)(dv),this._updateLoadingState("RecommendFriendList","OFF"),this.Logger.zsymb(18,"u_0O8o","[InvitationController] -> [onLoadRecommendFriendList], error: "+JSON.stringify(t))}}_handleSortFriendSuggestList(e,t){return 0===e.length?e:e.sort(((e,s)=>{var a,i,n,r,o,c;const l=t[null===(a=e.dataInfo)||void 0===a?void 0:a.userId]&&t[null===(i=e.dataInfo)||void 0===i?void 0:i.userId].length,d=(null===(n=e.dataInfo)||void 0===n?void 0:n.displayName)||"",u=t[null===(r=s.dataInfo)||void 0===r?void 0:r.userId]&&t[null===(o=s.dataInfo)||void 0===o?void 0:o.userId].length,h=(null===(c=s.dataInfo)||void 0===c?void 0:c.displayName)||"";return l&&u?l===u?d.localeCompare(h):u>l?1:-1:l&&!u?-1:!l&&u?1:l||u?0:d.localeCompare(h)}))}async onLoadRelatedGroupList(){try{const{listFriendSuggest:e=[]}=this.data.get("all")||{},t=e.map((e=>{var t;return null==e||null===(t=e.dataInfo)||void 0===t?void 0:t.userId})),s=await ev.c.getRelatedGroup(t),{listFriendReceived:a=[],listFriendSent:i=[]}=this.data.get("all")||{},n=this._handleSortFriendSuggestList(e,s.groupRelateds);this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:a,listFriendSent:i,listFriendSuggest:n,mapRelatedGroup:s.groupRelateds||{}})),this._signalRenderItem()}catch(e){this.Logger.zsymb(18,"oHLLIV","[InvitationController] -> [onLoadRelatedGroupList], error: "+JSON.stringify(e))}}handleFriendProfileChange(e){const{listFriendReceived:t=[],listFriendSuggest:s=[],listFriendSent:a=[]}=this.data.get("all")||{};Object.keys(e).forEach((e=>{const i=Ii.default.getDName(e),n=t.findIndex((t=>t.dataInfo.userId===e));-1!==n&&(t[n].displayName=i);const r=s.findIndex((t=>t.dataInfo.userId===e));-1!==r&&(s[r].displayName=i);const o=a.findIndex((t=>t.userId===e));-1!==o&&(a[o].displayName=i)})),this._signalRenderItem()}handlePublicFriendEvents(e){const t=e.payload;if(t)for(let a=0;a<t.length;a++){var s;const i=t[a].ts,n="add"===t[a].act&&t[a].data||(null===(s=t[a].data)||void 0===s?void 0:s.fromUid),r=n===e.userId;if(i&&n&&!r&&"fr"===t[a].act_type)switch(t[a].act){case"req_v2":this.contactTabController.onUpdateRequestTracking("FRIEND","NEW",i,n);break;case"undo_req":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",i,n),this.dispatchEvent(new Xf.f(Xf.e.UndoAddFriendEvent,"",n));break;case"add":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",i,n),this.dispatchEvent(new Xf.f(Xf.e.AcceptAddFriendEvent,"",n));break;case"reject":this.contactTabController.onUpdateRequestTracking("FRIEND","REMOVE",i,n),this.dispatchEvent(new Xf.f(Xf.e.RejectAddFriendEvent,"",n))}}}handlePublicAddFriendEvent(e){let t=[];const s=e.payload;if(s){for(let e=0;e<s.length;e++){let a={};a.userId=s[e].userId,a.zaloName=s[e].zaloName,a.avatar=s[e].avatar,a.displayName=s[e].displayName,a.recommInfo={message:s[e].friendRequestMsg,source:s[e].friendRequestSource},a.recommTime=s[e].friendRequestFetchTime,a.recommType=s[e].friendRequestType,t.push({dataInfo:a,recommItemType:1})}this.dispatchEvent(new Xf.f(Xf.e.ReceiveAddFriendEvent,"",t))}}addPublicListeners(){this.addEventListener(Xf.e.PublicInvitationEvents,this.handlePublicFriendEvents.bind(this)),this.addEventListener(Xf.e.PublicReceiveAddFriendEvent,this.handlePublicAddFriendEvent.bind(this)),Ii.default.connectSignalChangeDNameAndAvatar(this.handleFriendProfileChange.bind(this))}addComponentListeners(){}removeComponentListeners(){}_addFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{},n=e.concat(t);this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:n,listFriendSent:s,listFriendSuggest:a,mapRelatedGroup:i})),this._signalRenderItem()}_removeFriendReceived(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{},n=t.filter((t=>{var s;return(null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:n,listFriendSent:s,listFriendSuggest:a,mapRelatedGroup:i})),this._signalRenderItem()}onUpdateFriendRequests(e,t){switch(t){case"ADD":this._addFriendReceived(e);break;case"REMOVE":this._removeFriendReceived(e)}}async onRejectFriend(e){return new Promise(((t,s)=>{ev.c.rejectAddFriend(e).then((()=>{this._removeFriendReceived(e),t(e)})).catch((e=>{this.Logger.zsymb(18,"zQo7C4","[InvitationController] -> [onRejectFriend], error: "+JSON.stringify(e)),s(e)}))}))}async onAddFriend(e){return new Promise(((t,s)=>{ev.c.acceptAddFriend(e).then(t).catch((e=>{this.Logger.zsymb(18,"tvXomY","[InvitationController] -> [onAddFriend], error: "+JSON.stringify(e)),s(e)}))}))}removeFriendSent(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{},n=s.filter((t=>(null==t?void 0:t.userId)!==e));this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:n,listFriendSuggest:a,mapRelatedGroup:i})),this._signalRenderItem()}onRemoveFriendSent(e){ev.c.makeUndoSentRequestFriend(e).then((()=>{this.removeFriendSent(e.userId)})).catch((e=>{this.Logger.zsymb(18,"aJTdRF","[InvitationController] -> [onRemoveFriendSent], error: "+JSON.stringify(e)),e&&301==e.error_code?mc.default.createError(ce.a.str("STR_UNDO_REQUEST_ERROR_301")):e&&"ERR_NO_NETWORK"===e.code?mc.default.createError(ce.a.str("STR_CHECK_NET")):mc.default.createError(ce.a.str("STR_UNDO_REQUEST_ERROR_UNKNOWN"))}))}_removeFriendSuggest(e){const{listFriendReceived:t=[],listFriendSent:s=[],listFriendSuggest:a=[],mapRelatedGroup:i={}}=this.data.get("all")||{},n=a.filter((t=>{var s;return(null==t||null===(s=t.dataInfo)||void 0===s?void 0:s.userId)!==e}));this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:t,listFriendSent:s,listFriendSuggest:n,mapRelatedGroup:i})),this._signalRenderItem()}onAddFriendSuggest(e){Ng.a.doAddFriend(e.uid,e.src,null,e.windowId).then((()=>{this._removeFriendSuggest(e.uid),this.onLoadRequestedFriendList()})).catch((e=>{this.Logger.zsymb(18,"m0K92G","[InvitationController] -> [onAddFriendSuggest], error: "+JSON.stringify(e))}))}onRemoveFriendSuggest(e){ev.c.removeSuggestFriend(e).then((()=>{this._removeFriendSuggest(e.uid)})).catch((e=>{this.Logger.zsymb(18,"VWafUl","[InvitationController] -> [onRemoveFriendSuggest], error: "+JSON.stringify(e))}))}openMutualGroupPopup(e){Ie.ModalManagerV2.openModal({windowId:"1",name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:{userId:e,showMutualGroups:!0}})}resetData(){this.data.set("all",{isLoadingRecommendFriendList:!1,isLoadingRequestedFriendList:!1,listFriendReceived:[],listFriendSent:[],listFriendSuggest:[],mapRelatedGroup:{}})}makeExpiredReceivedFriendRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:a={}}=this.data.get("all")||{};if(0!==e.length){for(let t=0;t<e.length;t++)e[t].dataInfo.recommTime=-1,e[t].dataInfo.recommInfo.source=-1,e[t].dataInfo.recommInfo.message="";this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:a})),this._signalRenderItem()}}makeExpiredSentFriendSentRequest(){let{listFriendReceived:e=[],listFriendSent:t=[],listFriendSuggest:s=[],mapRelatedGroup:a={}}=this.data.get("all")||{};if(0!==t.length){for(let e=0;e<t.length;e++)t[e].fReqInfo.time=-1,t[e].fReqInfo.src=-1,t[e].fReqInfo.message="";this.data.set("all",Object(I.a)(Object(I.a)({},this.data.get("all")),{},{listFriendReceived:e,listFriendSent:t,listFriendSuggest:s,mapRelatedGroup:a})),this._signalRenderItem()}}markSeenFriendRequests(e){const t=this.data.get("all")||{},{listFriendReceived:s=[]}=t;if(e.length>0&&s.length>0){const a=new Set(e);let i=!1;for(const e of s){const t=e.dataInfo;t&&!t.isSeenFriendReq&&a.has(t.userId)&&(e.dataInfo.isSeenFriendReq=!0,i=!0)}i&&(this.data.set("all",Object(I.a)(Object(I.a)({},t),{},{listFriendReceived:s})),this._signalRenderItem())}}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||uv)||uv)||uv);var hv,gv=s("2x/M"),mv=s("FhUL"),pv=s("zU/x"),fv=s("dhU0"),vv=s("2e02"),_v=s("HnA5");function bv(e){return{avatar:e.avatar,displayName:Ii.default.getDName(e.id)||e.dName||e.zaloName,userId:e.id,zaloName:e.zaloName,type:e.type}}Object(xi.b)(vv.b)(hv=Reflect.metadata("design:type",Function)(hv=Reflect.metadata("design:paramtypes",[])(hv=class extends hs.b{constructor(){super(),this.name=void 0,this.key=void 0,this._Logger=void 0,this.data=void 0,this.metadata=void 0,this.timer=void 0,this.isOpeningInvitationBox=void 0,this.handleNetworkStatusChange=e=>{e===le.a.CONNECTED&&0===this.data.size&&this.getReceivedInvitations({page:0})},this.name=vv.a,this.key="groupId",this.data=new Map,this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.timer={instance:new x.b,intervalId:null},this.isOpeningInvitationBox=!1}init(){throw new Error("Method not implemented.")}getList(){return Array.from(this.data.keys())}getItem(e){const t=this.data.get(e.key);return t||this.Logger.zsymb(5,"ZSOhFb",["try to get item not exist in cache {}","aM3blG"],e.key),t}onGetItemFailure(e){this.Logger.zsymb(18,"JrdqCx","Get group invitation item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(18,"0DV7CF","Get group invitation list failed",e)}signalUpdateList(){Object(nc.i)(this.name,"all")}signalUpdateItem(e){Object(nc.h)(this.name,e)}signalUpdateListMeta(){this.dispatchEvent(new Xf.d(Xf.b.UpdateUIListMetadata,this.metadata))}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.contactTabV2,[this.name])),this._Logger}async getCreatorInfos(e){const t=await Ii.default.getProfileFriendForGroup(Object.fromEntries(e.map((e=>[e.creatorId||e,0]))));return new Map(e.map((e=>[e.groupId,t[e.creatorId]])))}async getCreatorInfoForGroup(e){return Ii.default.getProfileFriendForGroup({[e]:0})}startTimer(){this.stopTimer(),this.timer.intervalId=window.setInterval((()=>this.timer.instance.publish(Ct.default.getTimeNow())),Xf.c.COUNT_INTERVAL)}stopTimer(){null!==this.timer.intervalId&&window.clearInterval(this.timer.intervalId),this.timer.intervalId=null}getTimer(){return this.timer.instance}isValidInvitation(e){var t;return!!(null!==(t=e.groupInfo)&&void 0!==t&&t.groupId&&e.grCreatorInfo&&e.inviterInfo)&&e.expiredTs-Ct.default.getTimeNow()>0}convertToGroupInvitation(e){const t=Y.GROUPID_PREFIX+e.groupInfo.groupId,s=function(e){return{avatar:e.avt,creatorId:e.creatorId,displayName:e.name,name:e.name,setting:e.setting,adminIds:e.adminIds,totalMember:e.totalMember,userId:e.groupId,type:e.type,topMember:e.currentMems.map(bv),isGroup:!0}}(e.groupInfo),a=bv(e.inviterInfo),i=bv(e.grCreatorInfo);return Object(I.a)(Object(I.a)({},e),{},{groupId:t,groupInfo:s,inviterInfo:a,grCreatorInfo:i})}async loadServerReceivedInvitations(){var e;const{invitations:t,hasMore:s,total:a}=await qc.default.getGroupInvitationList(this.metadata.page,Ce.default.group_privacy.invitation_box.paging_limit,Ce.default.group_privacy.invitation_box.mcount_item,null===(e=this.metadata)||void 0===e?void 0:e.lastGroupId);this.metadata=Object(I.a)(Object(I.a)({},this.metadata),{},{hasMore:s,total:a});const i=await this.getCreatorInfos(t.map((e=>e.groupInfo))),n=[];for(let r=0;r<t.length;r++){const e=t[r];if(e.grCreatorInfo||(e.grCreatorInfo=i.get(e.groupInfo.groupId)),this.isValidInvitation(e)){const s=Y.GROUPID_PREFIX+e.groupInfo.groupId,a=this.convertToGroupInvitation(e);n.push(a),r===t.length-1&&(this.metadata.lastGroupId=s)}}return n}onInvitationListUIAppear(){this.isOpeningInvitationBox=!0,this.startTimer(),this.getReceivedInvitations({page:0}).catch((e=>{this.Logger.zsymb(18,"G2m4m8","Init load invitation failed",e)})).finally((()=>{this.metadata.loading&&(this.metadata.loading=!1,setTimeout((()=>{this.signalUpdateListMeta()}),300))})),J.p.listenEvent(J.k,this.handleNetworkStatusChange)}onInvitationListUIDisappear(){this.stopTimer(),this.metadata={total:0,page:0,hasMore:!0,loading:!0},this.data.clear(),J.p.removeListenEvent(J.k,this.handleNetworkStatusChange),this.isOpeningInvitationBox=!1}getUIListMeta(){return this.metadata}async getReceivedInvitations(e={}){const{page:t=0}=e;if(!this.metadata.hasMore)return[];this.metadata.page=t,this.data=new Map(this.data);const s=await this.loadServerReceivedInvitations();return s.forEach((e=>{this.data.set(e.groupId,e)})),this.signalUpdateListMeta(),this.signalUpdateList(),s}async loadMoreReceivedInvitations(){const e=Ce.default.group_privacy.invitation_box.paging_limit,t=Math.trunc(this.data.size/e);return this.getReceivedInvitations({page:t})}handleNewInvitation(e,t){this.metadata.total+=1,this.data=new Map([[e,t],...Array.from(this.data.entries())]),this.signalUpdateListMeta(),this.signalUpdateList()}async acceptInvitation(e,t){try{if(e.type===mv.a.PENDING_REVIEW)throw{error_code:pv.a.WAITING_APPROVE};const t=ui.default.getRawGroupId(e.groupId);await qc.default.joinGroupFromInvitation(t),this.Logger.zsymb(2,"QftIrZ","Join group success",e.groupId),a.ModuleContainer.resolve(Q.b).openConversation(e.groupId,Q.d.fromGroupInvitation()),this.deleteInvitationsFromCache([e.groupId])}catch(s){this.Logger.zsymb(18,"ijUE6_","Join group failed",e.groupId,s),this.handleJoinInvitationError(e,null==s?void 0:s.error_code,t)}}async rejectInvitation(e,t={}){try{if(e.type===mv.a.PENDING_REVIEW)throw{error_code:pv.a.WAITING_APPROVE};const s=ui.default.getRawGroupId(e.groupId);await qc.default.deleteGroupInvitation([{grid:s}],t.blockGroup),this.Logger.zsymb(2,"1n2ft8","Reject group invitation success",e.groupId,t),t.blockInviter&&Ii.default.blockFriend(e.inviterInfo.userId,Y.SET_BLOCK),this.deleteInvitationsFromCache([e.groupId]),mc.default.createInfo(ce.a.str(_v.a.get("STR_GROUP_INVITATION_DELETED",e.groupInfo)))}catch(s){this.Logger.zsymb(18,"ojgxRl","Reject group invitation failed",e.groupId,s),mc.default.createError(ce.a.str("STR_ERROR_OCCUR"))}}async deleteInvitations(e){const t=e.map((e=>({grid:ui.default.getRawGroupId(e.groupId)})));try{await qc.default.deleteGroupInvitation(t,!1),this.Logger.zsymb(2,"su5RyC","Delete group invitations success",t),this.deleteInvitationsFromCache(e.map((e=>e.groupId)))}catch(s){this.Logger.zsymb(18,"2Z5TZI","Delete group invitations failed",t,s),mc.default.createError(ce.a.str("STR_ERROR_OCCUR"))}}deleteInvitationsFromCache(e){let t=0;for(const s of e)this.data.has(s)&&(this.data.delete(s),t+=1);0!==t&&(this.metadata.total=Math.max(this.metadata.total-t,0),this.signalUpdateListMeta(),this.signalUpdateList(),this.metadata.hasMore&&this.data.size<Ce.default.group_privacy.invitation_box.paging_limit&&this.loadMoreReceivedInvitations())}getInvitationSync(e){return this.data.get(e)||null}getInvitation(e){return new Promise((t=>{const s=ui.default.getRawGroupId(e);qc.default.getGroupInvitationInfo(s).then((e=>{e.grCreatorInfo?t(this.convertToGroupInvitation(e)):this.getCreatorInfoForGroup(e.groupInfo.creatorId).then((s=>{e.grCreatorInfo=s,t(this.convertToGroupInvitation(e))})).catch((()=>t(null)))})).catch((s=>{this.Logger.zsymb(18,"scSduF","Get invitation info failed",e,s),t(null)}))}))}updateInvitationFromCache(e){const{groupId:t}=e;this.data.has(t)&&this.data.set(t,e)}updateInvitationStatus(e,t){const s=this.data.get(e);if(s){const a=Object(I.a)(Object(I.a)({},s),{},{type:t});this.updateInvitationFromCache(a),this.data.set(e,a),this.signalUpdateItem(e)}}onReceivedInvitationEvents(e,t){const s=t.groupId;if(!s)return;const i=Y.GROUPID_PREFIX+s;switch(this.Logger.zsymb(0,"nRwUIK","Received new event",e,i),e){case gv.b.NEW_INVITATION:this.isOpeningInvitationBox&&this.getInvitation(i).then((e=>{e&&this.handleNewInvitation(i,e)})).catch((e=>{this.Logger.zsymb(18,"hxb2gF","Load new invitation item by event failed",i,e)})),a.ModuleContainer.resolve(fv.b).onUpdateRequestTracking("GROUP_INV","NEW",Ct.default.getTimeNow(),i);break;case gv.b.UPDATE_INVITATION:const e=this.data.get(i);"number"==typeof t.invitationType&&(null==e?void 0:e.type)!==t.invitationType&&this.updateInvitationStatus(i,t.invitationType);break;case gv.b.REMOVE_INVITATION:this.deleteInvitationsFromCache([i]),a.ModuleContainer.resolve(fv.b).onUpdateRequestTracking("GROUP_INV","REMOVE",Ct.default.getTimeNow(),i)}}handleJoinInvitationError(e,t,s){switch(t){case pv.a.WAITING_APPROVE:this.updateInvitationStatus(e.groupId,mv.a.PENDING_REVIEW),mc.default.createInfo(ce.a.str(_v.a.get("STR_GROUP_INVITATION_JOIN_ERR_240",e.groupInfo)));break;case pv.a.EXCEED_MAX_GROUP:case pv.a.CANNOT_CHANGE:case pv.a.BANNED:case pv.a.NOT_PERMITTED:mc.default.createInfo(ce.a.str(_v.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case pv.a.NOT_EXIST:case pv.a.ALREADY_MEMBER:case pv.a.EXPIRED:this.deleteInvitationsFromCache([e.groupId]),mc.default.createInfo(ce.a.str(_v.a.get("STR_GROUP_INVITATION_JOIN_ERR_"+t,e.groupInfo)));break;case Y.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:case Y.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:Ce.default.group_privacy.community.enable_upgrade?a.ModuleContainer.resolve(el.e).onReceivedCommunityError({errorCode:t,windowId:s,groupId:e.groupId}):mc.default.createError(ce.a.str("STR_ERROR_OCCUR"));break;default:mc.default.createError(ce.a.str("STR_ERROR_OCCUR"))}}})||hv)||hv);var Iv;Object(m.j)()(Iv=Object(m.h)()(Iv=Object(m.d)()(Iv=Object(a.singleton)(Jf.c)(Iv=class{constructor(){this.logger=void 0,this.handleFetchClearUnread=async()=>{if(Ce.default.contactTabV2.seen_friendrequest){this.Logger.zsymb(18,"P5JUCA","overflow queue -> fetch clear unread");try{const{ts:e}=await qc.default.getLastReadContactTab(),t=this.getLastCachedAccessTs();"number"==typeof e&&e>t&&(this.Logger.zsymb(0,"LEXbdi",`do reinit unread lastTs=${t} ts=${e}`),n.default.getInstance().setItemForCurrentUser(Xf.g,String(e)),a.ModuleContainer.resolve(Jf.b).computeUpdateUnread())}catch(e){this.Logger.zsymb(18,"OHih5u","fetch clear unread fail",e)}}}}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.contactTabV2,["unread-manager"])),this.logger}getLastCachedAccessTs(){const e=n.default.getInstance().getItemForCurrentUser(Xf.g);return e&&!isNaN(+e)?+e:0}clearFriendRequestUnread(e,t=!1){a.ModuleContainer.resolve(Jf.o).markSeenFriendRequests(e),a.ModuleContainer.resolve(Jf.b).clearFriendRequestUnread(e),t&&qc.default.sendClearUnreadFriendRequest(e).then((()=>{this.Logger.zsymb(0,"ps0rAC","sync read friend req tab success total=",e.length)})).catch((e=>{this.Logger.zsymb(18,"9FtZUe","sync read friend req tab fail",e)}))}onStart(){J.p.listenEvent(J.n,this.handleFetchClearUnread)}onApplicationReady(){a.ModuleContainer.resolve(Jf.b).onInitUnreadRequest()}onDispose(){J.p.removeListenEvent(J.n,this.handleFetchClearUnread)}onOpenContactTab(e){const t=a.ModuleContainer.resolve(Jf.b).getState(Ar.c).unread,s=t.isUnread&&t.newFriendRequests.length>0&&Ce.default.contactTabV2.seen_friendrequest;this.Logger.zsymb(0,"bqEMLg",`open contact tab -> friend req=${t.newFriendRequests.length} group inv=${t.newGroupInvitations.size}`),s&&qc.default.readContactTab(e).then((()=>{this.Logger.zsymb(0,"m4k6jz","sync read contact tab success",e)})).catch((t=>{this.Logger.zsymb(18,"K25_qa","sync read contact tab fail",e,t)}))}onOpenFriendRequestTab(e){const t=e.filter((({dataInfo:e})=>e&&!e.isSeenFriendReq)).map((({dataInfo:e})=>e.userId));t.length>0&&this.clearFriendRequestUnread(t,!!Ce.default.contactTabV2.seen_friendrequest)}onOpenGroupInvitationTab(){const e=a.ModuleContainer.resolve(Jf.b),t=e.getState(Ar.c).unread;if(t.newGroupInvitations.size){const s=Array.from(t.newGroupInvitations);e.clearGroupInvitationUnread(s)}}onSeenBannerFriendRequest(e){if(Ce.default.contactTabV2.seen_friendrequest&&Ce.default.contactTabV2.seen_friendrequest_chat_view){a.ModuleContainer.resolve(Jf.b).getState(Ar.c).unread.newFriendRequests.includes(e)&&this.clearFriendRequestUnread([e],!0)}}onSeenFriendRequests(e){Ce.default.contactTabV2.seen_friendrequest&&this.clearFriendRequestUnread(e,!1)}})||Iv)||Iv)||Iv);var yv=s("akSd"),Sv=s("fqRP"),Cv=s("L904"),Ev=s("EiAw"),Ov=s("IoRb"),Mv=s("CzFt");let Tv;class Rv{static get instance(){return Tv||(Tv=new Rv),Tv}get _eventStore(){return this.__eventStore||(this.__eventStore=s("emRR").default),this.__eventStore}constructor(){this.__eventStore=void 0,this._emitConversationDeleted=e=>{let t,s,a=[];if(e.ok?({conversation:t,toUid:s,allItems:a}=e.value):({conversation:t,toUid:s,allItems:a}=e.error),t)return;if(a.length&&a.every((e=>e.ttlType===oh.a.Quote)))return;const i={type:ve.FetchActions.DELETE_CONVERSATION,payload:s};this._eventStore.dispatch(i),Mv.a.dispatch(i),_e.default.send(i.type,i.payload)},this._emitDeletedMsgs=e=>{let t,s;e.ok?({allItems:s,conversation:t}=e.value):({allItems:s,conversation:t}=e.error);const a=s.filter((e=>e.ttlType===oh.a.Message)),i=a.map((e=>e.msgId));Object(Ev.a)({msgId:i,conversation:t,messages:a.map((e=>JSON.parse(JSON.stringify(e)))),trackingSource:"ttlPrune"})},this._emitUpdateUnread=(e,t)=>{let s,a=[];e.ok?({toUid:s,allItems:a}=e.value):({toUid:s,allItems:a}=e.error),me.a.UnreadDataManager.updateUnreadTTLConversation(s,a,null==t?void 0:t.get(s))},this.emitPerConversation=async(e,t)=>{let s=await Object(Ef.a)(this._emitConversationDeleted,e);s.ok||Object(Ov.a)("_emitConversationDeleted failed",s.error),s=await Object(Ef.a)(this._emitDeletedMsgs,e),s.ok||Object(Ov.a)("_emitDeletedMsgs failed",s.error),s=await Object(Ef.a)(this._emitUpdateUnread,e,t),s.ok||Object(Ov.a)("_emitUpdateUnread failed",s.error)}}}var wv,Lv=s("LA52"),Dv=s("GSaP");const Av=e=>null==e?void 0:e.toUid,Fv=e=>null!=e&&e.ok?"success":"error";Object(a.singleton)(Lv.a)(wv=Reflect.metadata("design:type",Function)(wv=Reflect.metadata("design:paramtypes",[])(wv=class{constructor(){this._pruning=!1,this._task=void 0,this._ttl=a.ModuleContainer.resolve(Sv.a),this._logger=void 0,this.dispose=()=>{},this.prune=async()=>this._pruning?await this._task:(this._pruning=!0,this._task=this._pruneFromDB(),this._pruning=!1,this._task),this._pruneFromDB=async()=>{const e=Ct.default.getTimeNow();this._logger.zsymb(0,"fcrcB-","Pruner execute task",e);const t=await Object(Ef.b)(this._ttl.getExpireItemsBefore,e);if(!t.ok)return this._logger.zsymb(18,"xvERX1","Pruner getExpireItemsBefore failed",t.error),{ok:!1,error:null};const s=t.ok?t.value:[];return await this._pruneTTLItems(s)},this._pruneByMsgsBatch=[],this.pruneByMsgs=async e=>{const t=Object(gi.a)(e);this._pruneByMsgsBatch.push(...t),setTimeout((()=>{const e=this._pruneByMsgsBatch;this._pruneByMsgsBatch=[],e.length&&(this._logger.zsymb(15,"JC_2Yh",["running a batch {}","dsCMGf"],e.length),this._pruneByMsgs(e))}),2e3)},this._pruneByMsgs=async e=>{const t=Ct.default.getTimeNow();this._logger.zsymb(15,"5PYjSy",["deriving {}","_jXMkp"],e.length);let s=Dv.a.createFromCurrentSession().deriveTTLItems(e);this._logger.zsymb(15,"bH2yww",["ttlItems count: {}","u-sfck"],s.length),s=s.filter((e=>{const s=+e.expireOn+Ce.default.ttl.enable_delete_on_filter_minimum_overtime;return!isNaN(s)&&s<t})),this._logger.zsymb(15,"LcNNIb",["expired count: {}","fiThh6"],s.length),s=s.filter((e=>!this._hasPruneMsgCache(e))),s.forEach((e=>{this._setPruneMsgCache(e)})),this._logger.zsymb(15,"OqQ911",["no cache count: {}","FTGxhH"],s.length),s.length?(this._logger.zsymb(3,"7740RG",["pruning {}, {}","Yv3zKj"],s.length,s),await this._deleteMsgsAndEmit(s)):this._logger.zsymb(15,"6SCVRW",["no items to prune","6fyJCM"])},this._pruneMsgCache=new u.default({maxSize:1e4}),this._pruneTTLItems=async e=>{const t=e.map((e=>[e.msgId,e.ttlType]));this._logger.zsymb(3,"Ru7q5F",["pruning {} items: {}","-7Nbly"],t.length,t),await this._deleteMsgsAndEmit(e);const s=await Object(Ef.b)(this._ttl.deletes,t);return s.ok||this._logger.zsymb(18,"vjv5OB","Pruner deletes ttl failed",s.error),s},this._retryErrorMsgsIfNeeded=e=>{for(const s of e){var t;if(s.ok)continue;const{errorItems:e,toUid:a}=s.error;this._logger.zsymb(0,"RHCfXj","_retryErrorDelete "+a,null==e||null===(t=e[0])||void 0===t?void 0:t.msgId),setTimeout((()=>{Object(Ef.b)(this._deleteMsgsBelongToTTLItems,e)}),5e3)}},this._retryErrorDelete=e=>setTimeout((async()=>{const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(Ef.b)(this._deleteMsgsBelongToTTLItems,e);!s.ok&&this._logger.zsymb(18,"IRawQg","Pruner _retryErrorDelete",s.error),s.ok&&this._emitPruneResult(s.value,t)}),5e3),this._emitPruneResult=async(e,t)=>{for(const s of e)await Object(Ef.b)(Rv.instance.emitPerConversation,s,t)},this._deletePerConversation=async(e,t=[])=>{var s,a,i,n,r,o,c,l,d;const u=await Object(Ef.b)(Gu.b.vanishMessages,e,t);if(!u.ok)return{ok:!1,error:{toUid:e,allItems:[],errorItems:t,successItems:[]}};const h=null===(s=u.value.vanish)||void 0===s?void 0:s[0],g=null===(a=u.value.quote)||void 0===a?void 0:a[0];if(!h&&!g)return{ok:!1,error:{toUid:e,conversation:{},allItems:[],errorItems:t,successItems:[]}};const m=null===(i=u.value.vanish)||void 0===i||null===(n=i[0])||void 0===n||null===(r=n.conv)||void 0===r?void 0:r.conversation;let p=[...null!==(o=null===(c=u.value.vanish)||void 0===c?void 0:c.map((e=>e.res)).flat())&&void 0!==o?o:[],...null!==(l=null===(d=u.value.quote)||void 0===d?void 0:d.flat())&&void 0!==l?l:[]];p=p.filter((e=>e));const{success:f=[],error:v=[]}=Object(Cv.a)(p,Fv),_=f.map((e=>e.info)),b=v.map((e=>e.info)),I=[..._,...b];return b.length?{ok:!1,error:{toUid:e,conversation:m,allItems:I,successItems:_,errorItems:b}}:{ok:!0,value:{toUid:e,conversation:m,allItems:I,successItems:_}}},this._deleteMsgsBelongToTTLItems=async e=>{const t=Object(Cv.a)(e,Av),s=Object.keys(t).map((async e=>(Object(Ef.b)(this._sideEffect,e,t[e]),this._deletePerConversation(e,t[e]))));return await Promise.all(s)},this._sideEffect=async(e,t=[])=>setTimeout((async()=>{const s=await Object(Ef.b)(this._cancelSendingPerConversation,e,t);s.ok||this._logger.zsymb(18,"-Jc0Jq","cancelSendingPerConversation failed",s.error);const a=await Object(Ef.b)(this._syncDeletePerConversation,e,t);a.ok||this._logger.zsymb(18,"51mAxN","syncDeletePerConversation failed",a.error)}),0),this._cancelSendingPerConversation=async(e,t=[])=>{t.forEach((t=>Object(Ef.b)((()=>{}),e,null==t?void 0:t.cliMsgId)))},this._syncDeletePerConversation=async(e,t=[])=>{if(!Ce.default.ttl.enable_sync_delete)return;const s=t=>{+t.msgId&&Object(yv.e)(e,{cliMsgId:t.cliMsgId,msgId:t.msgId,sendDttm:t.sendDttm,toUid:e,fromUid:t.fromUid})};t.forEach((e=>Object(Ef.b)(s,e)))},this._pruning=!1,this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("utils",["ttl","destructor","pruner"])}_getPruneMsgKey(e){return e?`${e.msgId}|${e.ttlType}`:""}_hasPruneMsgCache(e){return this._pruneMsgCache.has(this._getPruneMsgKey(e))}_setPruneMsgCache(e){this._pruneMsgCache.set(this._getPruneMsgKey(e),void 0)}async _deleteMsgsAndEmit(e){const t=await this._ttl.getMappedMsgsByConvIdFromTTLItems(e),s=await Object(Ef.b)(this._deleteMsgsBelongToTTLItems,e);s.ok||(this._logger.zsymb(18,"AxbREP","Pruner","deleteMessages failed"),this._retryErrorDelete(e)),s.ok&&this._retryErrorMsgsIfNeeded(s.value),s.ok&&this._emitPruneResult(s.value,t)}})||wv)||wv);s("Ceyj");var kv,Nv=s("K0f4"),Pv=s("buT3");Object(m.j)()(kv=Object(m.f)()(kv=class{onAuthenticated(e){const{userId:t}=e.getSession();if(t){const e=Object(hr.d)(t),s=`${e}_${Nv.m}`,a=Pv.a.getItem(s);if(!(null!==a))return;const i=97124,n="1"===a,r=`${e}_${Nv.g}`,o=+(Pv.a.getItem(r)||"-1"),c=isNaN(o)?-1:o,l=`${e}_${Nv.i}`,d=+(Pv.a.getItem(l)||"-1"),u=isNaN(d)?-1:d;if(n)kc.default.increaseSuccess(i,0,c,[u]);else{const t=`${e}_${Nv.c}`,s=Pv.a.getItem(t),a=Number(s);kc.default.increaseFailed(i,0,c,a,Date.now(),[u])}Pv.a.removeItem(s),Pv.a.removeItem(r),Pv.a.removeItem(l)}}onStart(){const e=Nv.l,t=Pv.a.getItem(e);if(!(null!==t))return;const s="1"===t,a=Nv.f,i=+(Pv.a.getItem(a)||"-1"),n=isNaN(i)?-1:i,r=Nv.h,o=+(Pv.a.getItem(r)||"-1"),c=isNaN(o)?-1:o;if(s)kc.default.increaseSuccess(97123,0,n,[c]);else{const e=Pv.a.getItem(Nv.b),t=Number(e);kc.default.increaseFailed(97123,0,n,t,Date.now(),[c])}Pv.a.removeItem(e),Pv.a.removeItem(a),Pv.a.removeItem(r)}})||kv);var jv,Uv=s("l9L4"),Bv=s("CDcE");Object(m.d)()(jv=Object(a.injectable)()(jv=Object(a.singleton)(Uv.a)(jv=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(jv=Reflect.metadata("design:type",Function)(jv=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(jv=class{constructor(e){this._isFirstLoginMap=new Map,this._firstLoginTimeMap=new Map,this._logger=void 0,this._logger=e.createZLogger("utils",["first-login-checker"])}getFirstLoginTime(e){if(this.firstLoginTimeMap.has(e))return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime();try{const t=n.default.getInstance().getItemForCurrentUser(Y.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME);null!=t&&this.firstLoginTimeMap.set(e,parseInt(t))}catch(t){this.logger.zsymb(21,"qMfSqB",["getFirstLoginTime error {} - {}","pGZvJI"],e,Object(Bv.f)(t,2))}return this.firstLoginTimeMap.get(e)||this.getDefaultFirstLoginTime()}isFirstLogin(e){return!!this._isFirstLoginMap.get(e)}onApplicationReady(e){this.removeFirstLoginFlag()}setFirstLogin(e,t){this._isFirstLoginMap.set(e,t)}setFirstLoginTime(e,t){this.firstLoginTimeMap.set(e,t);try{n.default.getInstance().setItemForCurrentUser(Y.FirstLoginLocalStorageKeys.FIRST_LOGIN_TIME,t&&t.toString()||"")}catch(s){this.logger.zsymb(21,"cSstdb",["setFirstLoginTime error {} - {} - {}","_eOjFi"],e,t,Object(Bv.f)(s,2))}}removeFirstLoginFlag(){const e=Ii.default.getUidMe(),t=n.default.getInstance();t.getItem(Y.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)===e&&t.removeItem(Y.FirstLoginLocalStorageKeys.IS_FIRST_LOGIN)}getDefaultFirstLoginTime(){return Ct.default.getTimeNow()}get firstLoginTimeMap(){return this._firstLoginTimeMap}get logger(){return this._logger}})||jv)||jv)||jv)||jv)||jv);let zv=function(e){return e.USER_OFFLINE="USER_OFFLINE",e}({});class Gv extends hs.a{constructor(){super(zv.USER_OFFLINE)}}var xv,Vv=s("uGvo"),Hv=s("cHDa");Object(yo.e)()(xv=Object(yo.g)([{token:Ja.token,useFactory:()=>_e.default}])(xv=Object(xi.b)(Ya)(xv=function(e,t){return Object(a.inject)(Ja)(e,void 0,0)}(xv=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,1)}(xv=Reflect.metadata("design:type",Function)(xv=Reflect.metadata("design:paramtypes",[void 0===Vv.IEventBus?Object:Vv.IEventBus,"undefined"==typeof BaseApplication?Object:BaseApplication])(xv=class extends hs.b{constructor(e,t){super(),this.eventBus=e,this.prevNetworkState=void 0,this.onUserOffline=()=>{this.dispatchEvent(new Gv)},this.onUserActiveChanged=e=>{e===Hv.c.LOCK_SCREEN&&this.onUserOffline()},this.onNetworkStatusChanged=e=>{e!==this.prevNetworkState&&(this.prevNetworkState=e,e===le.a.DISCONNECT&&this.onUserOffline())},this.prevNetworkState=null,this.registerListener(t)}registerListener(e){this.eventBus.subscribe(((e,t)=>{switch(e){case ve.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t);case ve.GeneralActions.USER_ACTIVE_CHANGED:return this.onUserActiveChanged(t)}})),e.addEventListener(m.b.Exit,this.onUserOffline),e.addEventListener(m.b.BeforeUnload,this.onUserOffline),e.addEventListener(m.b.LogOut,this.onUserOffline)}})||xv)||xv)||xv)||xv)||xv)||xv);var Wv;const qv="last-ts-online",Kv="last-ts-online-prev-session";let Zv=Object(m.j)()(Wv=Object(m.h)()(Wv=Object(a.injectable)()(Wv=Object(yo.g)([{token:Ja.token,useFactory:()=>_e.default},{token:ti.token,useFactory:()=>Tu.default},{token:si.token,useFactory:()=>n.default.getInstance()}])(Wv=function(e,t){return Object(a.inject)(Ja)(e,void 0,0)}(Wv=function(e,t){return Object(a.inject)(St.b)(e,void 0,1)}(Wv=function(e,t){return Object(a.inject)(ti)(e,void 0,2)}(Wv=function(e,t){return Object(a.inject)(si)(e,void 0,3)}(Wv=Reflect.metadata("design:type",Function)(Wv=Reflect.metadata("design:paramtypes",["undefined"==typeof IEventBus?Object:IEventBus,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof ISocketPolling?Object:ISocketPolling,void 0===n.default?Object:n.default])(Wv=class{constructor(e,t,s,a){this.eventBus=e,this.systemTime=t,this.socketPolling=s,this.localStorage=a,this.lastTsOnline=void 0,this.intervalUpdate=void 0,this.prevNetworkState=void 0,this.lastTsOnlinePrevSession=void 0,this.startTsOnlineCurrSession=void 0,this.onNetworkStatusChanged=e=>{if(e!==this.prevNetworkState)switch(this.prevNetworkState=e,e){case le.a.CONNECTED:this.startIntervalUpdate();break;case le.a.DISCONNECT:this.updateLastTsUserOnline(),this.stopIntervalUpdate()}},this.onStartPullOffline=()=>{this.startTsOnlineCurrSession=this.systemTime.getTimeNow(),this.updateLastTsUserOnlineInPrevSession()},this.onDonePullOffline=()=>{this.updateLastTsUserOnline(),this.startIntervalUpdate()},this.updateLastTsUserOnline=()=>{const e=this.systemTime.getTimeNow();return this.lastTsOnline=e,this.localStorage.setItemForCurrentUserAsync(qv,e.toString())},this.updateLastTsUserOnlineInPrevSession=async()=>{const e=await this.getLastTsOnline();return this.lastTsOnlinePrevSession=e,this.localStorage.setItemForCurrentUserAsync(Kv,e.toString())},this.lastTsOnline=null,this.intervalUpdate=null,this.prevNetworkState=null,this.lastTsOnlinePrevSession=null,this.startTsOnlineCurrSession=null}onStart(){this.registerListener()}onDispose(){this.updateLastTsUserOnline(),this.stopIntervalUpdate()}async getLastTsOnline(){var e;return null!==(e=this.lastTsOnline)&&void 0!==e?e:this.lastTsOnline=Number(await this.localStorage.getItemForCurrentUserAsync(qv))||0}async getLastTsOnlinePrevSession(){var e;return null!==(e=this.lastTsOnlinePrevSession)&&void 0!==e?e:this.lastTsOnlinePrevSession=Number(await this.localStorage.getItemForCurrentUserAsync(Kv))||0}async getStartTsOnlineCurrSession(){var e;return null!==(e=this.startTsOnlineCurrSession)&&void 0!==e?e:this.startTsOnlineCurrSession=this.systemTime.getTimeNow()}registerListener(){this.eventBus.subscribe(((e,t)=>{if(e===ve.GeneralActions.NETWORK_STATUS)return this.onNetworkStatusChanged(t)})),this.socketPolling.addEventListener(Tu.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{var t,s;e.nextChatHandler.subcribe(Ru.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),e.nextChatHandler.subcribe(Ru.b.ON_DONE_OFFLINE,this.onDonePullOffline),null===(t=e.prevChatHandler)||void 0===t||t.unsubcribe(Ru.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),null===(s=e.prevChatHandler)||void 0===s||s.unsubcribe(Ru.b.ON_DONE_OFFLINE,this.onDonePullOffline)}))}startIntervalUpdate(){var e;null!==(e=this.intervalUpdate)&&void 0!==e||(this.intervalUpdate=setInterval((()=>{this.updateLastTsUserOnline()}),E.j.timeInMs("10m")))}stopIntervalUpdate(){this.intervalUpdate&&clearInterval(this.intervalUpdate),this.intervalUpdate=null}})||Wv)||Wv)||Wv)||Wv)||Wv)||Wv)||Wv)||Wv)||Wv)||Wv;a.ModuleContainer.registerSingleton(ei,Zv);var $v=s("/7c0");const Qv=Object(a.define)("transfer-data-suggestion-loader");var Yv=s("cgeJ"),Jv=s("XVri"),Xv=s("bAqL");var e_=class{constructor(e){this._logger=void 0,this._moduleName=void 0,this._moduleName=e}log(){this.Logger.zsymb(0,"pfNuAd",this.moduleTagName,...arguments)}logError(e,t){const s=null==t?"":this.stringifyDepthLevel(t);this.Logger.zsymb(18,"XEYO2-",this.moduleTagName,e,s)}stringifyDepthLevel(e){return Object(Xv.d)(e,Object(Xv.a)())}get Logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("msg-sync",[Jv.a])),this._logger}get moduleTagName(){return this._moduleName+" - "}};var t_,s_=class{constructor(e){this.moduleName=e,this._logger=void 0,this._logger=new e_(this.moduleName)}get Logger(){return this._logger}};function a_(e){try{return JSON.stringify(e)}catch(t){return""}}function i_(e){return JSON.parse(e)}Object(a.injectable)()(t_=Object(a.singleton)(Qv)(t_=Reflect.metadata("design:type",Function)(t_=Reflect.metadata("design:paramtypes",[])(t_=class extends s_{constructor(){super(Yv.f.LOADER),this._friendManager=void 0,this._groupManager=void 0}async loadLastCloseBannerDownloadPC(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load last close banner download pc failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Yv.b);return null!=t?i_(t):(this.Logger.logError("Load last close banner download pc failed null"),null)}catch(t){return this.Logger.logError("Load last close banner download pc failed",t),t}}async loadListConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load list conversations from DB failed cause invalid storage"),Promise.reject([]);try{const t=await e.getItemForCurrentUserAsync(Yv.d);return null!=t?i_(t):(this.Logger.logError("Load list conversations from DB failed null"),[])}catch(t){return this.Logger.logError("Load list conversations from DB failed",t),[]}}async loadRolledConversationsFromDB(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load rolled conversations from DB failed cause invalid storage"),Promise.reject([]);try{let t=[];const s=await e.getItemForCurrentUserAsync(Yv.e);null!=s&&(t=i_(s));const i=a.ModuleContainer.resolve(Nn.PreviewDataManager),n=await i.getAllPreviews(!0);for(let e=0;e<n.length;e++){const s=n[e].convId;if(s===Ce.default.sendToMeId)continue;if(-1!==t.indexOf(s))continue;const a=await $v.a.messageDBHandler.getOldestMsgsFromConv(s,Object(Mh.a)(),1);a&&a.items&&a.items.length>0&&t.push(s)}return this.Logger.logError("Load list rolled conversations from DB failed null"),t}catch(t){return this.Logger.logError("Load list rolled conversations from DB failed",t),[]}}async loadListFriends(){const e=this.getFriendManagerModule();if(e)try{return await e.getFriends()}catch(t){return this.Logger.logError("Load list friends failed",t),[]}return this.Logger.log("Load list friends empty"),[]}async loadListGroups(){const e=this.getGroupManagerModule();if(e)try{return await e.getGroupsList()}catch(t){return this.Logger.logError("Load list groups failed",t),[]}return this.Logger.log("Load list groups empty"),[]}async loadRegisteredData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load registered data failed cause invalid storage"),Promise.reject();try{let t=e.getItemForCurrentUser(Y.RegisterLocalStorageKeys.IS_REGISTERED_ON_THIS_DEVICE);return null!=t?{isRegisteredOnThisDevice:i_(t)}:(this.Logger.log("Load registered data null"),null)}catch(t){return this.Logger.logError("Load registered data failed",t),t}}async loadSyncMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load sync messages data failed cause invalid storage"),Promise.reject();try{const t=e.getItemForCurrentUser("sync_cross_settings");return t?i_(t):(this.Logger.log("Load sync messages data null"),null)}catch(t){return this.Logger.logError("Load sync messages data failed",t),t}}async loadTransferMessagesData(){const e=this.getSecureLocalStorageDB();if(!e)return this.Logger.logError("Load transfer messages data failed cause invalid storage"),Promise.reject();try{const t=await e.getItemForCurrentUserAsync(Yv.m);return t?i_(t):(this.Logger.logError("Load transfer messages data failed null"),null)}catch(t){return this.Logger.logError("Load transfer messages data failed",t),t}}async setLastCloseBannerDownloadPC(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Yv.b,a_(e)):Promise.reject("Invalid storage")}async setLastCloseFirstLoginTransferModal(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Yv.c,a_(e)):Promise.reject("Invalid storage")}async addRolledConversationToDB(e){const t=this.getSecureLocalStorageDB();if(!t)return Promise.reject("Invalid storage");let s=await this.loadRolledConversationsFromDB();return-1===s.indexOf(e)&&s.push(e),await t.setItemForCurrentUserAsync(Yv.e,a_(s))}async setListConversationsFirstLoginToDB(e){const t=this.getSecureLocalStorageDB();return t?await t.setItemForCurrentUserAsync(Yv.d,a_(e)):Promise.reject("Invalid storage")}async updateTransferMessagesData(e){const t={lastTransferSuccessTime:e.lastTransferSuccessTime||Date.now()};try{return await this.getSecureLocalStorageDB().setItemForCurrentUserAsync(Yv.m,a_(t))}catch(s){return s}}getFriendManagerModule(){var e;this._friendManager||(this._friendManager=null===(e=s("UiPd"))||void 0===e?void 0:e.default);return this._friendManager}getGroupManagerModule(){var e;this._groupManager||(this._groupManager=null===(e=s("Gm1y"))||void 0===e?void 0:e.default);return this._groupManager}getSecureLocalStorageDB(){return n.default.getInstance()}})||t_)||t_)||t_);var n_=s("n09q"),r_=s("31cx"),o_=s("a1r1"),c_=s("BO4k");var l_,d_=class extends s_{constructor(e,t){super(Jv.c.MANAGER),this._eventMap=new Map,this._fistLoginTime=void 0,this._listConversationsBeforeLogin=[],this._isTransferAfterLogin=void 0,this._rolledConversations=[],this._moduleLoader=void 0,this._moduleUIManager=void 0,this._moduleLoader=e,this._moduleUIManager=t,this._isTransferAfterLogin=!1,this.handleUpdateConfigs=this.handleUpdateConfigs.bind(this),this.isDisplayedBannerDownloadPCSuggestion=this.isDisplayedBannerDownloadPCSuggestion.bind(this),this.isDisplayedBubbleInfoEcard=this.isDisplayedBubbleInfoEcard.bind(this),this.isDisplayedCloseButtonBannerDownloadPC=this.isDisplayedCloseButtonBannerDownloadPC.bind(this),this.isDisplayedConversationFooter=this.isDisplayedConversationFooter.bind(this),this.isDisplayedGlobalSearchFooter=this.isDisplayedGlobalSearchFooter.bind(this),this.isDisplayedSearchInConversationFooter=this.isDisplayedSearchInConversationFooter.bind(this),this.isDisplayedMilestoneInPreviewMedia=this.isDisplayedMilestoneInPreviewMedia.bind(this),this.isDisplayedSuggestionInMediaList=this.isDisplayedSuggestionInMediaList.bind(this),this.isDisplayedTransferModal=this.isDisplayedTransferModal.bind(this),this.isValidForTransferMessages=this.isValidForTransferMessages.bind(this)}addEventListeners(e,t){this.eventMap.set(e,[...this.eventMap.get(e)||[],t])}callTransferMessages(e){}closeBannerDownloadPCSuggestion(){}getConversationFooterRendererHeight(){return this.isDisplayedConversationFooter()?Jv.b.CONVERSATION:0}getFirstLoginTime(){return this.firstLoginTime}getGlobalSearchFooterRendererHeight(){return this.isDisplayedConversationFooter()?Jv.b.GLOBAL_SEARCH:0}getLogger(){return this.Logger}getUrlDownloadPC(){return""}getIsTransferAfterLogin(){return this.isTransferAfterLogin}hasConversationBeforeFirstLogin(e){return e!==Ce.default.sendToMeId&&this._listConversationsBeforeLogin.includes(e)}hasRolledConversation(e){return e!==Ce.default.sendToMeId&&this._rolledConversations.includes(e)}hideTransferMessagesModal(){}async initialize(){this.firstLoginTime=a.ModuleContainer.resolve(o_.a).getFirstLoginTime(this.getUserId()),this.handleUpdateConfigs(c_.a()),this.registerSubscriptions(),await this.initializeListConversationsBeforeFirstLogin(),this.initListRolledConversations()}isDisplayedBannerDownloadPCSuggestion(){return!!this.isEnabledFeature()&&c_.e()}isDisplayedBubbleInfoEcard(e){return!!this.isEnabledFeature()&&(!!c_.f()&&!!this.hasConversationBeforeFirstLogin(e))}isRolledConversation(e){return!1}isDisplayedCloseButtonBannerDownloadPC(){return!!this.isEnabledFeature()&&c_.i()}isDisplayedConversationFooter(){return!!this.isEnabledFeature()&&c_.j()}isDisplayedCTADownloadPC(){return!!this.isEnabledFeature()&&c_.g()}isDisplayedCTATransferMessages(){return!!this.isEnabledFeature()&&c_.h()}isDisplayedGlobalSearchFooter(){return!!this.isEnabledFeature()&&c_.k()}isDisplayedSearchInConversationFooter(e){return!!this.isEnabledFeature()&&(!!c_.n()&&(this.hasConversationBeforeFirstLogin(e)||this.hasRolledConversation(e)))}isDisplayedMilestoneInPreviewMedia(e){return!!this.isEnabledFeature()&&(!!c_.m()&&this.hasConversationBeforeFirstLogin(e))}isDisplayedSuggestionInMediaList(e){return!!this.isEnabledFeature()&&(!!c_.l()&&(this.hasConversationBeforeFirstLogin(e)||this.hasRolledConversation(e)))}isDisplayedTransferModal(){return!!this.isEnabledFeature()&&c_.o()}isEnabledFeature(){return c_.p()}isValidSupportDownloadPC(){return!1}isValidForTransferMessages(){return this.isEnabledFeature()}needTransferMessages(){}removeEventListeners(e,t){const s=this.eventMap.get(e);if(Array.isArray(s)){const e=s.findIndex((e=>e===t));-1!==e&&s.splice(e,1)}}setFirstLoginTime(e){this.firstLoginTime=e}setIsTransferAfterLogin(e){this.isTransferAfterLogin=e}shouldTransferMessages(){return!1}showTransferMessagesModal(){}canShowFirstTimeLoginTransferMessageModal(){return!1}async addRolledConversationToDB(e){}registerSubscriptions(){Ce.$AppConfig.subscribe(this.handleUpdateConfigs)}isFirstLogin(){return a.ModuleContainer.resolve(o_.a).isFirstLogin(this.getUserId())}async initializeListConversationsBeforeFirstLogin(){this._listConversationsBeforeLogin=await this.loadListConversationsBeforeFirstLogin()}async initListRolledConversations(){}handleUpdateConfigs(e={}){const{data_content:t}=c_.b(e),{first_time_login_device:s}=e;t&&this.UIManager.updateDataContent(Object(r_.a)(t)),null!=s&&(this.firstLoginTime=s)}async loadListConversations(){const e=[],t=await this.loaderModule.loadListFriends();Array.isArray(t)&&t.forEach((t=>{e.push(t.userId)}));const s=await this.loaderModule.loadListGroups();return Array.isArray(s)&&s.forEach((t=>{e.push(t.userId)})),e}async loadListConversationsBeforeFirstLogin(){let e;if(this.isFirstLogin())e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e);else{const t=await this.loaderModule.loadListConversationsFromDB();e=t,(t||[]).length||(e=await this.loadListConversations(),this.loaderModule.setListConversationsFirstLoginToDB(e))}return e}notifyEvent(e,...t){const s=this.eventMap.get(e);Array.isArray(s)&&s.forEach((e=>Promise.resolve((()=>e(...t)))))}get firstLoginTime(){return this._fistLoginTime}set firstLoginTime(e){this._fistLoginTime=e}get isTransferAfterLogin(){return this._isTransferAfterLogin}set isTransferAfterLogin(e){this._isTransferAfterLogin=e}get eventMap(){return this._eventMap}get loaderModule(){return this._moduleLoader}get UIManager(){return this._moduleUIManager}getUserId(){const e=a.ModuleContainer.resolve(m.a),{userId:t}=e.getSession()||{};return t||""}},u_=s("mgoj"),h_=s("JCvM"),g_=s("y4fj");Object(a.injectable)()(l_=Object(m.d)()(l_=Object(a.singleton)(n_.a)(l_=function(e,t){return Object(a.inject)(Qv)(e,void 0,0)}(l_=function(e,t){return Object(a.inject)(u_.a)(e,void 0,1)}(l_=function(e,t){return Object(a.inject)(vm.a)(e,void 0,2)}(l_=Reflect.metadata("design:type",Function)(l_=Reflect.metadata("design:paramtypes",[Object,void 0===h_.ITransferDataSuggestionUIManager?Object:h_.ITransferDataSuggestionUIManager,void 0===vm.a?Object:vm.a])(l_=class extends d_{constructor(e,t,s){super(e,t),this._moduleSyncMessages=void 0,this._isImportedMessages=!1,this._isRegisteredOnThisDevice=!1,this._shouldTransferMessages=!1,this._transferMessagesData={lastTransferSuccessTime:void 0},this._moduleSyncMessages=s}callTransferMessages(e){this.Logger.log("call transfer messages",e);switch(this.syncMessagesModule.getCurrentSyncScreenState()){case Am.a.Hidden:case Am.a.SuggestNewSync:return void this.syncMessagesStartSync(e);case Am.a.SuggestResume:return void this.syncMessagesResume();case Am.a.SyncGuide:return this.syncMessagesModule.metricts.clickViewGuide(),void this.syncMessagesModule.showSuggestPopup();case Am.a.WaitForBackup:case Am.a.DownloadingBackup:case Am.a.DecryptingBackup:case Am.a.SyncInProgress:case Am.a.ClearData:case Am.a.SyncSuccess:return void this.syncMessagesShowToast();case Am.a.WaitForNetwork:case Am.a.Error:return void this.syncMessagesStartSync(e);default:return}}async initialize(){await super.initialize(),await this.loadTransferMessagesData(),await this.loadSyncMessagesData(),await this.loadRegisteredData(),this.loadImportMessagesData()}hideTransferMessagesModal(){const e=Ct.default.getTimeNow();this.UIManager.hideTransferMessagesModal(),this._moduleLoader.setLastCloseFirstLoginTransferModal(e)}isDisplayedBannerDownloadPCSuggestion(){return!1}isDisplayedBubbleInfoEcard(e){return!!super.isDisplayedBubbleInfoEcard(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedConversationFooter(){return!!super.isDisplayedConversationFooter()&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedGlobalSearchFooter(){return!!super.isDisplayedConversationFooter()&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedMilestoneInPreviewMedia(e){return!!super.isDisplayedMilestoneInPreviewMedia(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedSearchInConversationFooter(e){return!!super.isDisplayedSearchInConversationFooter(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}isDisplayedSuggestionInMediaList(e){return!!super.isDisplayedSuggestionInMediaList(e)&&(!this.isTransferredMessages()&&!this.isImportedMessages())}shouldTransferMessages(){return this._shouldTransferMessages}isValidForTransferMessages(){return!0}needTransferMessages(){this._shouldTransferMessages=!0}onApplicationReady(e){this.delayedCheckTransferMessagesSuggestionOnApplicationReady(),this.isEnabledFeature()&&(this.isRegisteredOnThisDevice()&&this.UIManager.turnOffDisplayingEntryPoints(),this.isTransferredMessages()||this.isImportedMessages()||this.isRegisteredOnThisDevice()||g_.a.logAction(g_.a.Common.DISPLAYED_NOT_ENOUGH_DATA_MESSAGE))}showTransferMessagesModal(){g_.a.logAction(g_.a.Modal.DISPLAYED),this.UIManager.showTransferMessagesModal()}isFullDiskStorage(){const e=Re.default.getFullDiskChatPopupNoti();return(null==e?void 0:e.level)===kn.g.FULL||!((null==e?void 0:e.level)!==kn.g.ALMOST_FULL_2||null!=e&&e.dismiss)}canShowFirstTimeLoginTransferMessageModal(){return Boolean(this.isEnabledFeature()&&this.isFirstLogin()&&!this.isTransferredMessages()&&this.shouldTransferMessages()&&this.isDBCorruptionNotDetected()&&!this.isFullDiskStorage())}checkTransferMessagesSuggestionOnApplicationReady(){!this.getIsTransferAfterLogin()&&this.canShowFirstTimeLoginTransferMessageModal()&&this.showTransferMessagesModal()}delayedCheckTransferMessagesSuggestionOnApplicationReady(){setTimeout((()=>this.checkTransferMessagesSuggestionOnApplicationReady()),Qm.a.transfer_when_login.time_wait_for_temp_key)}handleEvents(e,t){if(e===Yc.c.EXPORT_IMPORT_FINISHED){const{type:e,error:s}=t;e!==Yc.g.IMPORT_TYPE||s||this.handleImportMessagesSuccess()}}handleImportMessagesSuccess(){this._isImportedMessages=!0,this.UIManager.turnOffDisplayingEntryPoints(),a.ModuleContainer.resolve(rc.ConvListController).rerenderList()}handleSyncMessagesFailed(){this.UIManager.onProcessSync("sync-failed")}handleSyncMessagesStart(){this.UIManager.onProcessSync("syncing")}handleSyncMessagesResume(){this.UIManager.onProcessSync("syncing")}handleSyncMessagesRetry(){this.UIManager.onProcessSync("syncing")}handleSyncMessagesSuccess(){this.transferMessagesData={lastTransferSuccessTime:Ct.default.getTimeNow()},this.loaderModule.updateTransferMessagesData(this.transferMessagesData),this.UIManager.onProcessSync("synced"),this.UIManager.turnOffDisplayingEntryPoints(),a.ModuleContainer.resolve(rc.ConvListController).rerenderList()}isImportedMessages(){return this._isImportedMessages}isRegisteredOnThisDevice(){return this._isRegisteredOnThisDevice}isTransferredMessages(){return Boolean(this.transferMessagesData&&null!=this.transferMessagesData.lastTransferSuccessTime)}isDBCorruptionNotDetected(){return!J.p.getIsDBCorruptionDetected()}loadImportMessagesData(){const e=s("XSmZ").default;if(e){const t=e.getExportImportInformation();t&&null!=t.lastTimeImportSuccess&&(this._isImportedMessages=!0)}}async loadRegisteredData(){const e=await this.loaderModule.loadRegisteredData();e&&null!=e.isRegisteredOnThisDevice&&(this._isRegisteredOnThisDevice=e.isRegisteredOnThisDevice)}async loadSyncMessagesData(){try{const e=await this.loaderModule.loadSyncMessagesData();e&&e.lastSync&&0!=e.lastSync&&this.updateLastTransferSuccessTime(e.lastSync)}catch(e){}}async loadTransferMessagesData(){try{const e=await this.loaderModule.loadTransferMessagesData();e&&(this.transferMessagesData=e,this.UIManager.turnOffDisplayingEntryPoints())}catch(e){}}updateLastTransferSuccessTime(e){this.transferMessagesData.lastTransferSuccessTime=e}registerSubscriptions(){super.registerSubscriptions(),this.syncMessagesModule.addEventListener(Cm.e.ON_START,this.handleSyncMessagesStart.bind(this)),this.syncMessagesModule.addEventListener(Cm.e.ON_RETRY,this.handleSyncMessagesRetry.bind(this)),this.syncMessagesModule.addEventListener(Cm.e.ON_RESUME,this.handleSyncMessagesResume.bind(this)),this.syncMessagesModule.addEventListener(Cm.e.ON_SUCCESS,this.handleSyncMessagesSuccess.bind(this)),this.syncMessagesModule.addEventListener(Cm.e.ON_FAILED,this.handleSyncMessagesFailed.bind(this)),_e.default.subscribe(this.handleEvents.bind(this))}syncMessagesShowToast(){be.default.show({textKey:"STR_TRANSFERRING_MSG_TOAST",type:be.TOAST_TYPE.INFO,noBackground:!0,duration:c_.d()})}syncMessagesStartSync(e){let t;switch(e){case Jv.j.CONVERSATION:t=om.j.CSC_LIST;break;case Jv.j.BUBBLE_CSC:t=om.j.CSC;break;case Jv.j.SEARCH_IN_CONVERSATION:case Jv.j.GLOBAL_SEARCH:t=om.j.SEARCH;break;default:t=om.j.FIRST_TIME_LOGIN}this.syncMessagesModule.sync(t)}syncMessagesResume(){this.syncMessagesModule.resume()}get syncMessagesModule(){return this._moduleSyncMessages}get transferMessagesData(){return this._transferMessagesData}set transferMessagesData(e){this._transferMessagesData=e}})||l_)||l_)||l_)||l_)||l_)||l_)||l_);var m_,p_=class extends s_{constructor(){super(Jv.c.UI),this.key=h_.c,this.name=h_.c,this.dataState=Object(I.a)({},Jv.f),this.UIState=Object(I.a)({},Jv.g)}closeBannerDownloadPCSuggestion(){}hideTransferMessagesModal(){}init(e){}initialize(){const{data_content:e}=Object(c_.b)(Object(c_.a)());this.handleUpdateContent(e)}getItem(e,t){return e.key===Jv.e?this.dataState:e.key===Jv.h?this.UIState:{}}getList(e,t){return[]}turnOffDisplayingEntryPoints(){this.handleUpdateRenderer({isDisplayedEntryPoints:!1})}onGetItemFailure(e,t){}onGetListFailure(e,t){}onProcessSync(e){}showTransferMessagesModal(){}updateDataContent(e){this.handleUpdateContent(e)}setDataState(e){const t=Object(rm.a)(this.dataState,e);this.dataState!==t&&(this.dataState=t,Object(nc.h)(this.name,Jv.e))}setUIState(e){const t=Object(rm.a)(this.UIState,e);this.UIState!==t&&(this.UIState=t,Object(nc.h)(this.name,Jv.h))}handleUpdateContent(e){this.setDataState((t=>{t.version=e.version,t.content=e.content}))}handleUpdateRenderer(e){this.setUIState((t=>{for(const s in e)t[s]=e[s]}))}};Object(xi.b)(h_.b)(m_=class extends p_{hideTransferMessagesModal(){this.setUIState((e=>{e[Yv.l.TRANSFER_MODAL].isDisplayed=!1}))}getItem(e,t){const s=super.getItem(e,t);if(!s)return;let a={};if(e.key===Yv.h){const{content:e={}}=s;for(const t in e){const s=e[t];if(s)for(const e in s){var i;a[t]||(a[t]={}),a[t][e]=null===(i=s[e])||void 0===i?void 0:i.pc}}}else a=s;return a}showTransferMessagesModal(){this.setUIState((e=>{e[Yv.l.TRANSFER_MODAL].isDisplayed=!0}))}onProcessSync(e){"syncing"===e?this.setUIState((e=>{e.syncStatus="syncing"})):"sync-failed"===e?this.setUIState((e=>{e.syncStatus="sync-failed"})):"synced"===e&&this.setUIState((e=>{e.syncStatus="synced"}))}});var f_=Object(a.define)("forward-message-pool-factory"),v_=s("oAAg");var __=class{createPool(e,t){return Object(v_.createPool)(e,t)}};a.ModuleContainer.register(f_,__);var b_=s("iuM+"),I_=s("WOYD"),y_=s("qWd+");function S_(e){const t={success:[],failed:[]};for(const s of e)s.success&&s.success.length&&t.success.push(...s.success),s.failed&&s.failed.length&&t.failed.push(...s.failed);return t}function C_(e){let t=[],s=[],a="";return e.forEach((e=>{e===Ce.default.sendToMeId?a=e:e.startsWith(Y.GROUPID_PREFIX)?t.push(e):s.push(e)})),{groups:t,oneOnes:s,sendToMe:a}}function E_(e,t=50){let s=[];for(let a=0;a<e.length;a+=t)s.push(e.slice(a,a+t));return s}function O_(e,t,s,i){const{userId:n}=a.ModuleContainer.resolve(m.a).getSession()||{};let r=ui.default.getMsgIdSendingFromCliMsgId(t),o=e.startsWith(Y.GROUPID_PREFIX);const c=new hl.c(n,e,r,t,s,o,i);return gl.a.instance().isOnE2ee(e)&&(c.e2eeStatus=Y.MSG_E2EE),c}var M_=s("Eyfw");var T_=async function(e,t,s){const a=K.default.getChatBoxControllerByWindowId(Ar.c);if(s.failed.length){const i=s.failed[0].error,n=null==i?void 0:i.code;if(n===_g.a.DeleteConversationHasSendingMsg||n===_g.a.DeleteSendingMsg||n===_g.a.MsgArrivedBeforeAPIResponse)return;const r=s.failed[0].clientId;a._handleForwardedMessageFailure(i,{toUid:t.userId,message:e,clientId:r},t,e)}};const R_={USER:3,GROUP:6,OA:5};function w_(e){let t=e;return t&&t.startsWith(Y.GROUPID_PREFIX)&&(t=t.substr(Y.GROUPID_PREFIX.length)),t}function L_(e,t,s){if(!(e.fromUid&&e.cliMsgId&&e.msgId&&e.sendDttm&&t))return{};if(s!==Ce.default.sendToMeId)return{};let a=e.toUid||e.userId,i=function(e){if(!e)return!1;let t=e.userId||e.id;return"string"==typeof t&&!t.startsWith(Y.GROUPID_PREFIX)&&e.type>=1}({userId:s})?R_.OA:a.startsWith(Y.GROUPID_PREFIX)?R_.GROUP:R_.USER;return{tId:w_(a),srcType:i,srcId:"0"==e.fromUid?t:e.fromUid,cmi:e.cliMsgId,gmi:e.msgId,ts:e.sendDttm+""}}function D_(e){const t=K.default.getChatBoxControllerByWindowId(Ar.c)._getConversationInfo(e);if(!t){if(e.startsWith(Y.GROUPID_PREFIX)){return yn.default.getGroupByIdSync(e)}return Ii.default.getProfileFriendByIdSync(e)}return t}var A_=s("e2PW");var F_=async function(e,t,s){const a=(null==s?void 0:s.retry)||!1,i=a?e.cliMsgId:ul.a.next(),n=(a&&e.msgId,M_.a.preprocessMessage(i+"",e,void 0,!1,null)),r=Object(A_.b)(e,{send2Me:t===Ce.default.sendToMeId});n.reference=Object(A_.c)(r);const o={forwardRefLog:r,decorLog:Object(A_.a)(r)},c=D_(t),l={success:[],failed:[]};try{const e=await M_.a.forward(i+"",n,c,o);if(e){const s=e.msgId||e.minGlobalMsgId;l.success.push({clientId:i+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else l.failed.push({clientId:i+"",error:"invalid response",toUid:t})}catch(d){l.failed.push({clientId:i+"",error:d,toUid:t})}return T_(n,c,l),l},k_=s("/5+7"),N_=s("sANj"),P_=s("UyAE");var j_=async function(e,t,s=[],i=!1){const n={},r={},o=i?e.msgId:"",c=Object(A_.b)(e,{send2Me:!1}),l=Object(A_.b)(e,{send2Me:!0});for(let d=0;d<t.length;d++){let i=s[d]||ul.a.next();const u=t[d];n[u]=i;const h=O_(u,i,Y.MSG_FILE,Object(I.a)({},e.message)),g=u===Ce.default.sendToMeId?l:c;h.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(g)),h.localPath=e.localPath,h.folderPath=e.folderPath,r[u]=h;const m=K.default.getChatBoxControllerByWindowId(Ar.c),p=D_(u);if(Ce.default.forward_messages.enable_tracking_log){a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("forward-log",["track forward file"]).zsymb(18,"fGymgw","call _showLocalMessage: ",JSON.stringify(h))}m._showLocalMessage(h,p,e,o,Y.MSG_CHECKING_EXIST);const f=`${i}_${J.p.getSessionUserId()}_${t[d]}`;k_.a.dispatch(N_.FileActionType.ExtraInfo,{fileKey:k_.a.getFileKey(f),extraInfo:{sendFileError:void 0}}),P_.a.set(null==i?void 0:i.toString(),{localPath:e.localPath,folderPath:e.folderPath})}return{localMsgs:r}},U_=s("D5jy");var B_=async function(e,t,s){const a=K.default.getChatBoxControllerByWindowId(Ar.c),i={};for(const n in e)e[n]&&e[n].clientId&&(i[e[n].clientId]=e[n]);t.success.length&&t.success.forEach((e=>{a&&a._sentMessage(i[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{!async function(e,t,s,a){var i;const n=t.error;n===Y.FORWARD_ERR_CODE.EXPIRED||n===U_.a.FILE_EXPIRED||n===Y.FORWARD_ERR_CODE.SERVER_YAWNING||Y.FORWARD_ERR_CODE.SEND_FAIL;const r=null==t||null===(i=t.error)||void 0===i?void 0:i.code;r!==_g.a.DeleteConversationHasSendingMsg&&r!==_g.a.DeleteSendingMsg&&r!==_g.a.MsgArrivedBeforeAPIResponse&&s._handleForwardedMessageFailure(n,e,D_(e.conversationId),a)}(i[e.clientId],e,a,s)}))};var z_=async function(e,t,s){var a;const i={success:[],failed:[]},n=null!=s&&s.retry?parseInt(e.cliMsgId):ul.a.next(),{localMsgs:r}=await j_(e,[t],[n],null==s?void 0:s.retry),o=null===(a=r[t].reference)||void 0===a?void 0:a.data,c={forwardRefLog:o,decorLog:Object(A_.a)(o)};try{const s=await qc.default.forwardMessage(t,e,n,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,r[t],c);if(s){const e=s.msgId||s.minGlobalMsgId;i.success.push({clientId:n+"",msgId:e+"",minGlobalMsgId:s.minGlobalMsgId+"",toUid:t})}else i.failed.push({clientId:n+"",error:"invalid response",toUid:t})}catch(l){i.failed.push({clientId:n+"",error:l,toUid:t})}return await B_(r,i,e),i},G_=function(e){return async function(e,t,s={}){const a=y_.a.checkIsMessageFileE2ee(e),i=[];for(let n=0;n<t.length;n++){const r=gl.a.instance().isOnE2ee(t[n]);y_.a.checkIsForwardCrossConversation(a,r)?i.push(F_(e,t[n],s)):i.push(z_(e,t[n],s))}return S_(await Promise.all(i))}(e.message,e.toUids,e.options)},x_=s("dm9D"),V_=s("iEwR");const H_=(e,t)=>{const[s,i]=E.g.safeParseJson(null!=t?t:"");if(Number(null==i?void 0:i.is_original)){const t=Ce.default.file_photo_limit,s=gl.a.instance().isOnE2ee(e);if(t.enable_upload_original&&t.free_user_can_reupload_original)return{photoResolutionMode:zf.a.PHOTO_RESOLUTION_MODE.ORIGINAL,keepPhotoOriginalParamWhenForward:!0,isPhotoOriginal:1};switch(a.ModuleContainer.resolve(zf.a.IPhotoMessageProcessorDef).getCurrentPhotoResolutionMode()){case zf.a.PHOTO_RESOLUTION_MODE.ORIGINAL:return{photoResolutionMode:zf.a.PHOTO_RESOLUTION_MODE.ORIGINAL,keepPhotoOriginalParamWhenForward:!0,skipGenThumbForPhotoE2EE:s,isPhotoOriginal:1};case zf.a.PHOTO_RESOLUTION_MODE.HD:default:return t.keep_original_param_when_forward?{keepPhotoOriginalParamWhenForward:!0,skipGenThumbForPhotoE2EE:s,isPhotoOriginal:1}:{keepPhotoOriginalParamWhenForward:!1,isPhotoOriginal:1}}}return{}};var W_=async function(e,t,s={}){var i;const{userId:n}=a.ModuleContainer.resolve(m.a).getSession()||{},r={},o=(null==s?void 0:s.retry)||!1,c=o?e.msgId:"",l=Object(A_.b)(e,{send2Me:!1}),d=Object(A_.b)(e,{send2Me:!0});null!==(i=e.message)&&void 0!==i&&i.params&&(e.message.params=(e=>{const[t,s]=E.g.safeParseJson(null!=e?e:"");if(s.is_original){const e=a.ModuleContainer.resolve(zf.a.IPhotoMessageProcessorDef).getCurrentPhotoResolutionMode(),t=Ce.default.file_photo_limit;if(e===zf.a.PHOTO_RESOLUTION_MODE.HD&&!t.keep_original_param_when_forward)return delete s.is_original,JSON.stringify(s)}return e})(e.message.params));for(let a=0;a<t.length;a++){let s=o?e.cliMsgId:ul.a.next();const i=t[a],n=O_(i,s,Y.MSG_PHOTO,Object(I.a)({},e.message)),u=i===Ce.default.sendToMeId?d:l;n.updateMessageProp("properties",e.properties),n.updateMessageProp("localPath",e.localPath),n.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(u)),r[i]=n;const h=K.default.getChatBoxControllerByWindowId(Ar.c),g=D_(i);h._showLocalMessage(n,g,e,c,Y.MSG_CHECKING_EXIST)}return{localMsgs:r}},q_=s("tOSn");var K_=async function(e,t,s){const a=K.default.getChatBoxControllerByWindowId(Ar.c),i={};for(const n in e)e[n]&&e[n].clientId&&(i[e[n].clientId]=e[n]);s.success.length&&s.success.forEach((e=>{a&&a._sentMessage(i[e.clientId],e),q_.b.getInstance().end(q_.a.SendMsgPhotoHighQuality,{clientId:e.clientId,tsStopSubmitApi:performance.now(),sendStatus:"success"})})),s.failed.length&&s.failed.forEach((e=>{!async function(e,t,s,a){var i;const n=s.error;if(n===Y.FORWARD_ERR_CODE.EXPIRED||n===U_.a.FILE_EXPIRED);else{if(n===Y.FORWARD_ERR_CODE.SERVER_YAWNING)return;if(n===Y.FORWARD_ERR_CODE.SEND_FAIL)return}const r=null==s||null===(i=s.error)||void 0===i?void 0:i.code;r!==_g.a.DeleteConversationHasSendingMsg&&r!==_g.a.DeleteSendingMsg&&r!==_g.a.MsgArrivedBeforeAPIResponse&&a._handleForwardedMessageFailure(n,e,D_(e.conversationId),t)}(i[e.clientId],t,e,a),q_.b.getInstance().end(q_.a.SendMsgPhotoHighQuality,{clientId:e.clientId,tsStopSubmitApi:performance.now(),sendStatus:"fail",error:e.error})}))};var Z_=async function(e,t,s){const{localMsgs:i,forwardLogData:n,forwardLogDataMyCloud:r}=await W_(e,t,s),o={success:[],failed:[]},c=a.ModuleContainer.resolve(V_.TAIStickerMessageAppService);for(let a=0;a<t.length;a++){var l;const s=i[t[a]],n=s.clientId,r=Object(I.a)({},e);gl.a.instance().isOnE2ee(t[a])&&(r.e2eeStatus=Y.MSG_E2EE);const u=null===(l=s.reference)||void 0===l?void 0:l.data,h={forwardRefLog:u,decorLog:Object(A_.a)(u)};try{const e=await c.forwardAIStickerMessage(t[a],n,r,{retryTimeout:Y.RETRY_MSG_TIMEOUT_DEFAULT,lowPriority:!1,fwAdditional:h});o.success.push(Object(I.a)(Object(I.a)({},e),{},{clientId:n+"",toUid:t[a]}))}catch(d){o.failed.push({clientId:n+"",error:d,toUid:t[a]})}}return await K_(i,e,o),o},$_=s("Ullg");var Q_=async function(e,t,s){const{localMsgs:a}=await W_(e,t,s),i={success:[],failed:[]};for(let o=0;o<t.length;o++){var n;const s=t[o],c=a[s],l=c.clientId,d=Object(I.a)({},e);gl.a.instance().isOnE2ee(s)&&(d.e2eeStatus=Y.MSG_E2EE);const u=null===(n=c.reference)||void 0===n?void 0:n.data,h={forwardRefLog:u,decorLog:Object(A_.a)(u)};try{const e=await $_.a.Helper.forwardPhotoSticker(s,d,l,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,h);i.success.push(Object(I.a)(Object(I.a)({},e),{},{toUid:s,clientId:l+""}))}catch(r){i.failed.push({clientId:l+"",error:r,toUid:s})}}return await K_(a,e,i),i};var Y_=async function(e,t,s){var a;const i=(null==s?void 0:s.retry)||!1?e.cliMsgId:ul.a.next(),n=M_.a.preprocessMessage(i+"",e,s.photoBundle),r=D_(t),o=await async function(e,t){const s=Object(A_.b)(e,{send2Me:t===Ce.default.sendToMeId});return Object(I.a)({forwardRefLog:s,decorLog:Object(A_.a)(s)},H_(t,e.message.params))}(e,t),c={success:[],failed:[]};n.reference=Object(A_.c)(null==o?void 0:o.forwardRefLog),q_.b.getInstance().start(q_.a.SendMsgPhotoHighQuality,{clientId:i,resolution:null!==(a=o.photoResolutionMode)&&void 0!==a?a:"hd",convId:t,sendType:"forward",forwardType:"reupload"});try{const e=await M_.a.forward(i+"",n,r,o);if(e){let s=e.msgId||e.minGlobalMsgId;c.success.push({clientId:i+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else c.failed.push({clientId:i+"",error:"invalid response",toUid:t})}catch(l){c.failed.push({clientId:i+"",error:l,toUid:t})}return T_(n,r,c),c};var J_=async function(e,t,s){var a;const i={success:[],failed:[]};let n=ui.default.safeParseJson(null==e||null===(a=e.message)||void 0===a?void 0:a.params)||{};null!=n&&n.group_layout_id&&(delete n.group_layout_id,delete n.id_in_group,delete n.is_group_layout,delete n.total_item_in_group),s.photoBundle&&Object.assign(n,{is_group_layout:1,group_layout_id:s.photoBundle.groupLayoutId,id_in_group:s.photoBundle.idInGroup,total_item_in_group:s.photoBundle.totalItemInGroup});const r=Object(I.a)({},e.message);r.params=JSON.stringify(n);const o=Object(I.a)(Object(I.a)({},e),{},{message:r}),{localMsgs:c}=await W_(o,[t],s),l=c[t].clientId+"";try{var d,u;let a=!1;s.photoBundle&&(a=Object(I.a)(Object(I.a)({},s.photoBundle),{},{clientId:l}));const n=null===(d=c[t].reference)||void 0===d?void 0:d.data,o=Object(I.a)({forwardRefLog:n,decorLog:Object(A_.a)(n)},H_(t,e.message.params));q_.b.getInstance().start(q_.a.SendMsgPhotoHighQuality,{clientId:l,resolution:null!==(u=o.photoResolutionMode)&&void 0!==u?u:"hd",convId:t,sendType:"forward"});const h=await qc.default.forwardMessage(t,Object(I.a)(Object(I.a)({},e),{},{message:r,forwardInGroup:a}),l,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,c[t],o);if(h){let e=h.msgId||h.minGlobalMsgId;i.success.push({clientId:l,msgId:e+"",minGlobalMsgId:h.minGlobalMsgId+"",toUid:t,thumbUrl:h.thumbUrl,oriUrl:h.oriUrl||h.hdUrl||h.rawUrl,hdUrl:h.hdUrl,fileMsgParams:h.fileMsgParams})}else i.failed.push({clientId:l,error:"invalid response",toUid:t})}catch(h){i.failed.push({clientId:l,error:h,toUid:t})}return await K_(c,e,i),i};var X_=async function(e,t,s){const a=y_.a.checkIsMessageFileE2ee(e),i=[];for(let n=0;n<t.length;n++){const r=gl.a.instance().isOnE2ee(t[n]);y_.a.checkIsForwardCrossConversation(a,r)?i.push(Y_(e,t[n],s)):i.push(J_(e,t[n],s))}return S_(await Promise.all(i))},eb=function(e){return async function(e,t,s={}){return Object(x_.a)(e)?await Z_(e,t,s):Object(x_.E)(e)?await Q_(e,t,s):await X_(e,t,s)}(e.message,e.toUids,e.options)};var tb=async function(e,t,s){const a={success:[],failed:[]},i=(null==s?void 0:s.retry)||!1?e.cliMsgId:ul.a.next(),n=M_.a.preprocessMessage(i+"",e,s.photoBundle),r=Object(A_.b)(e,{send2Me:t===Ce.default.sendToMeId});n.reference=Object(A_.c)(r);const o={forwardRefLog:r,decorLog:Object(A_.a)(r)},c=D_(t);try{const e=await M_.a.forward(i+"",n,c,o);if(e){const s=e.msgId||e.minGlobalMsgId;a.success.push({clientId:i+"",msgId:s+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t})}else a.failed.push({clientId:i+"",error:"invalid response",toUid:t})}catch(l){a.failed.push({clientId:i+"",error:l,toUid:t})}return T_(n,c,a),a};var sb=async function(e,t,s){const a=(null==s?void 0:s.retry)||!1,i=a?e.msgId:"",n=a?e.cliMsgId:ul.a.next(),r=M_.a.preprocessMessage(n+"",e,s.photoBundle),o=O_(t,n,Y.MSG_VIDEO,Object(I.a)({},r.message)),c=Object(A_.b)(e,{send2Me:t===Ce.default.sendToMeId});o.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(c)),o.localPath=e.localPath;const l=K.default.getChatBoxControllerByWindowId(Ar.c),d=D_(t);return l._showLocalMessage(o,d,null,i,Y.MSG_CHECKING_EXIST),[o,r]};var ab=async function(e,t,s){const a=K.default.getChatBoxControllerByWindowId(Ar.c),i={};for(const n in e)e[n]&&e[n].clientId&&(i[e[n].clientId]=e[n]);s.success.length&&s.success.forEach((e=>{a&&a._sentMessage(i[e.clientId],e)})),s.failed.length&&s.failed.forEach((e=>{!async function(e,t,s,a){var i;const n=s.error;n===Y.FORWARD_ERR_CODE.EXPIRED||n===U_.a.FILE_EXPIRED||n===Y.FORWARD_ERR_CODE.SERVER_YAWNING||Y.FORWARD_ERR_CODE.SEND_FAIL;const r=null==s||null===(i=s.error)||void 0===i?void 0:i.code;r!==_g.a.DeleteConversationHasSendingMsg&&r!==_g.a.DeleteSendingMsg&&r!==_g.a.MsgArrivedBeforeAPIResponse&&a._handleForwardedMessageFailure(n,e,D_(e.conversationId),t)}(i[e.clientId],t,e,a)}))};var ib=async function(e,t,s){const a={success:[],failed:[]},[i,n]=await sb(e,t,s),r=i.clientId+"";let o=!1;s.photoBundle&&(o=Object(I.a)(Object(I.a)({},s.photoBundle),{},{clientId:r}));try{var c;const e=null===(c=i.reference)||void 0===c?void 0:c.data,s={forwardRefLog:e,decorLog:Object(A_.a)(e)},o=await qc.default.forwardMessage(t,n,r,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,i,s);if(o){const e=o.msgId||o.minGlobalMsgId;a.success.push({clientId:r,msgId:e+"",minGlobalMsgId:o.minGlobalMsgId+"",toUid:t,_msgObject:o._msgObject||null})}else a.failed.push({clientId:r,error:"invalid response",toUid:t})}catch(l){a.failed.push({clientId:r,error:l,toUid:t})}return await ab({[t]:i},e,a),a};var nb=async function(e,t,s={}){const a=[];for(let i=0;i<t.length;i++){const n=t[i],r=gl.a.instance().isOnE2ee(n),o=y_.a.checkIsMessageFileE2ee(e);y_.a.checkIsForwardCrossConversation(o,r)?a.push(tb(e,t[i],s)):a.push(ib(e,t[i],s))}return S_(await Promise.all(a))};var rb=async function(e){return nb(e.message,e.toUids,e.options)};var ob=async function(e,t,s={}){const a=e.message,i=[];for(let n=0;n<t.length;n++){const e=t[n];let r=ul.a.next();for(let t=0;t<a.length;t++){const n=a[t],o={isGroupLayout:1,groupLayoutId:r,totalItemInGroup:a.length,idInGroup:t};s.photoBundle=o,n.msgType===Y.MSG_VIDEO?i.push(rb({message:n,toUids:[e],options:s})):i.push(eb({message:n,toUids:[e],options:s}))}}return S_(await Promise.all(i))},cb=function(e){return ob(e.message,e.toUids,e.options)},lb=s("Hllb"),db=s("KZut");var ub=async function(e,t,s={}){var a;const i=e.message&&"object"==typeof e.message&&"rtf"===e.message.action,n=ui.default.getSubtypeMessage(e);let r=null;const o=(null==s?void 0:s.retry)||!1,c=o?e.msgId:"",l={},d={};let u=ui.default.ZSafeFunction((()=>-1==n||n==Y.MSG_SUBTYPE_LINK||i?ui.default.stripInvalidChar(e.message):e.message&&"object"==typeof e.message?e.message.title:""),"");if(!u)throw Object(lb.c)("Empty message",lb.a.EmptyString,e);let h=_o.default.findFirstUrl(u,!0,!1);h&&db.a.checkValidSuffix(h)&&e.shouldParseLinkOrContact&&(e.containType=2),i&&"object"==typeof e.message&&null!==(a=e.message)&&void 0!==a&&a.params&&(l.rtfProps=function(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return""}}(e.message.params),l.styles=l.rtfProps);const g=Object(A_.b)(e,{send2Me:!1}),m=Object(A_.b)(e,{send2Me:!0});for(let p=0;p<t.length;p++){const s=t[p];const a=O_(s,(o?e.cliMsgId:ul.a.next())+"",Y.MSG_TEXT),n=s===Ce.default.sendToMeId?m:g;a.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(n)),i&&"object"==typeof e.message?(a.updateMessageContentProp(hl.a.RTF,e.message),a.updateMessageContentProp(hl.a.TEXT,e.message.title)):a.updateMessageContentProp(hl.a.TEXT,u),e.containType&&(a.containType=e.containType,a.shouldParseLinkOrContact=e.shouldParseLinkOrContact),d[s]=a;const l=K.default.getChatBoxControllerByWindowId(Ar.c),f=D_(s);if(l._showLocalMessage(a,f,null,c),h&&e.shouldParseLinkOrContact){const t=Jo.c.create(h).withTimeout(me.a.ParserConfig.get("max_delay_send_message"));me.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[Jo.a.SHARE_MESSAGE,s]):t.do("parse",[Jo.a.SHARE_MESSAGE]);const i=await t.exec().toPromise();i&&(a.type=Y.MSG_LINK_CLIENT,a.updateMessageContentProp(hl.a.LINK,Object(I.a)({},i)),d[s]=a,r=a.convertToUIMessageObject(),l._showLocalMessage(a,f,null,c)),Jo.b.getInstance().report({key:null==e?void 0:e.msgId,href:h,entry:Jo.a.SHARE_MESSAGE,preview:i})}}return{localMsgs:d,additional:l,updatedForwardMsgItem:r}};async function hb(e,t){const s=K.default.getChatBoxControllerByWindowId(Ar.c),a={};for(const i in e)e[i]&&e[i].clientId&&(a[e[i].clientId]=e[i]);t.success.length&&t.success.forEach((e=>{s&&s._sentMessage(a[e.clientId],e)})),t.failed.length&&t.failed.forEach((e=>{var t;const i=null==e||null===(t=e.error)||void 0===t?void 0:t.code;if(i!==_g.a.DeleteConversationHasSendingMsg&&i!==_g.a.DeleteSendingMsg&&i!==_g.a.MsgArrivedBeforeAPIResponse&&s){const t=a[e.clientId],i=t.conversationId;Re.default.deleteMessageById(ui.default.getMsgIdSendingFromCliMsgId(e.clientId),i),s._handleForwardedMessageFailure(e.error,t,D_(i))}}))}async function gb(e,t,s){var a,i;const n=Ce.default.sendToMeId||"",r={forwardRefLog:null===(a=t.reference)||void 0===a?void 0:a.data,decorLog:Object(A_.a)(null===(i=t.reference)||void 0===i?void 0:i.data)};let o=s?Object(I.a)(Object(I.a)({},s),r):r,c=t.clientId;const l={success:[],failed:[]};try{const t=await qc.default.forwardMultiMessage([{clientId:c,toUid:n}],e,!1,1e4,!1,o);t.success&&t.success.length&&t.success.forEach((e=>{l.success.push(Object(I.a)(Object(I.a)({},e),{},{toUid:n}))})),t.failed&&t.failed.length&&t.failed.forEach((e=>{l.failed.push(Object(I.a)(Object(I.a)({},e),{},{toUid:n}))}))}catch(d){l.failed.push({clientId:""+c,error:d,toUid:n})}return l}var mb=s("A/lx");async function pb(e,t,s,a){const i=[],n=[],r={success:[],failed:[]};if(t.forEach((e=>{const t=yn.default.getGroupByIdSync(e);var a;t&&t.totalMember>=Ce.default.forward_group_limit_mem?n.push(e):i.push({clientId:(null===(a=s[e])||void 0===a?void 0:a.clientId)||ul.a.next(),grid:Object(mb.a)(e)})})),n.length)for(let l=0;l<n.length;l++){var o;const e=n[l],t=null===(o=s[Y.GROUPID_PREFIX+e].reference)||void 0===o?void 0:o.data,i={forwardRefLog:t,decorLog:Object(A_.a)(t)},d=a?Object(I.a)(Object(I.a)({},a),i):i;try{const t=await qc.default.sendMsgObject(s[e],null,null,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,d);r.success.push({clientId:s[e].clientId,msgId:t.msgId,toUid:Y.GROUPID_PREFIX+e})}catch(c){r.failed.push({clientId:s[e].clientId,error:c,toUid:Y.GROUPID_PREFIX+e})}}if(i.length){const t=E_(i),s={};i.forEach((e=>{s[e.clientId]=e.grid}));try{for(let i=0;i<t.length;i++){const n=await qc.default.forwardMultiMessage(t[i],e,!0,1e4,!1,a);n.success&&n.success.length&&n.success.forEach((e=>{r.success.push(Object(I.a)(Object(I.a)({},e),{},{toUid:Y.GROUPID_PREFIX+s[e.clientId]}))})),n.failed&&n.failed.length&&n.failed.forEach((e=>{r.failed.push(Object(I.a)(Object(I.a)({},e),{},{toUid:Y.GROUPID_PREFIX+s[e.clientId]}))}))}}catch(c){for(let e=0;e<i.length;e++)r.failed.push({clientId:""+i[e].clientId,error:c,toUid:Y.GROUPID_PREFIX+i[e].grid})}}return r}async function fb(e,t,s,a){const i=[];t.forEach((e=>{var t;i.push({clientId:(null===(t=s[e])||void 0===t?void 0:t.clientId)||ul.a.next(),toUid:e})}));const n={success:[],failed:[]},r=E_(i),o={};i.forEach((e=>{o[e.clientId]=e.toUid}));for(let l=0;l<r.length;l++){const t=r[l];try{const s=await qc.default.forwardMultiMessage(t,e,!1,1e4,!1,a);s.success&&s.success.length&&s.success.forEach((e=>{n.success.push(Object(I.a)(Object(I.a)({},e),{},{toUid:o[e.clientId]}))})),s.failed&&s.failed.length&&s.failed.forEach((e=>{n.failed.push(Object(I.a)(Object(I.a)({},e),{},{toUid:o[e.clientId]}))}))}catch(c){for(let e=0;e<t.length;e++)n.failed.push({clientId:""+t[e].clientId,error:c,toUid:t[e].toUid})}}return n}var vb=async function(e,t,s={}){const{groups:a,oneOnes:i,sendToMe:n}=C_(t),{localMsgs:r,additional:o,updatedForwardMsgItem:c}=await ub(e,t,Object(I.a)(Object(I.a)({},s),{},{send2Me:!!n})),l=c||e,d=[];if(n){const e=await gb(l,r[n],o);d.push(e)}if(a.length){const e=await pb(l,a,r,o);d.push(e)}if(i.length){const e=await fb(l,i,r,o);d.push(e)}const u=({success:[],failed:[]}=S_(d));return await hb(r,u),u};var _b=async function(e){return vb(e.message,e.toUids,e.options)};var bb=async function(e,t,s={}){const i={},n={},{userId:r}=a.ModuleContainer.resolve(m.a).getSession()||{},o=K.default.getChatBoxControllerByWindowId(Ar.c),c=(null==s?void 0:s.retry)||!1,l=c?e.msgId:"",d=Object(A_.b)(e,{send2Me:!1}),u=Object(A_.b)(e,{send2Me:!0});for(let a=0;a<t.length;a++){const s=t[a];const i=O_(s,c?e.cliMsgId:ul.a.next(),Y.MSG_STICKER),r=s===Ce.default.sendToMeId?u:d;i.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(r)),i.updateMessageContentProp(hl.a.STICKER,e.message),n[s]=i;const h=D_(s);o._showLocalMessage(i,h,null,l)}for(let a=0;a<t.length;a++){const s=L_(e,r||"",t[a]);i[t[a]]=s}return{localMsgs:n,additionalList:i}};var Ib=async function(e,t,s={}){const{groups:a,oneOnes:i,sendToMe:n}=C_(t),{localMsgs:r,additionalList:o}=await bb(e,t,s),c=[];if(n){const t=await gb(e,r[n]);c.push(t)}if(a.length){const t=await pb(e,a,r);c.push(t)}if(i.length){const t=await fb(e,i,r);c.push(t)}const l=({success:[],failed:[]}=S_(c));return await hb(r,l),l};var yb=async function(e){return Ib(e.message,e.toUids,e.options)};var Sb=async function(e,t,s={}){const[a,i]=_o.default.shouldReparseLink(e),n=K.default.getChatBoxControllerByWindowId(Ar.c),r=(null==s?void 0:s.retry)||!1,o=r?e.msgId:"";let c={localMsgs:{},preview:null};c=a&&s.isForwardSingleMsg?await async function(e,t,s,a){var i;const n=_o.default.isLongUrl(e||""),r=me.a.LinkPreviewRespository.getKey("meta-data",[e]),o=null===(i=me.a.LinkPreviewRespository.metaData.get(r))||void 0===i?void 0:i.value,c={localMsgs:{},preview:null};for(let g=0;g<s.length;g++){const i=s[g],r=O_(i,a?t.cliMsgId:ul.a.next(),Y.MSG_LINK_CLIENT),m=Object(A_.b)(t,{send2Me:i===Ce.default.sendToMeId});r.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(m)),o&&!n?(r.updateMessageContentProp(hl.a.TEXT,t.message.title),r.updateMessageContentProp(hl.a.LINK,o)):(r.updateMessageContentProp(hl.a.TEXT,t.message.title||t.message.href),r.type=Y.MSG_TEXT);let p=new Promise((e=>e(null)));if(n){Jo.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Jo.a.SHARE_MESSAGE,preview:null}),c.localMsgs[i]=r;continue}if(o){let t=!1;const s=Jo.c.create(e);if(me.a.ParserConfig.get("enable_upload_thumb_for_delay_send")){var l,d;const a=me.a.LinkPreviewRespository.getKey("meta-data",[e]);t=!(null===(l=me.a.LinkPreviewRespository.metaData.get(a))||void 0===l||null===(d=l.value)||void 0===d||!d.thumbOrigin),t&&s.do("download-thumb")}else{var u,h;const s=me.a.LinkPreviewRespository.getKey("thumb-local",[e]);t=!(null===(u=me.a.LinkPreviewRespository.thumbLocal.get(s))||void 0===u||null===(h=u.value)||void 0===h||!h.thumbLocal)}t&&(p=s.do("upload-thumb",[i]).exec().toPromise())}else if(null!==o){const t=Jo.c.create(e).withTimeout(me.a.ParserConfig.get("max_delay_send_message"));me.a.ParserConfig.get("enable_upload_thumb_for_delay_send")?t.do("full-process",[Jo.a.SHARE_MESSAGE,i]):t.do("parse",[Jo.a.SHARE_MESSAGE]),p=t.exec().toPromise()}const f=await p;Jo.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Jo.a.SHARE_MESSAGE,preview:f}),f&&(r.type=Y.MSG_LINK_CLIENT,r.updateMessageContentProp(hl.a.LINK,E.g.clone(f)),c.preview=f),c.localMsgs[i]=r}return c}(i||"",e,t,r):await async function(e,t,s,a){const i={localMsgs:{},preview:null},n=_o.default.isLongUrl(e||""),[,r]=E.g.safeParseJson(t.message.params);for(let o=0;o<s.length;o++){const c=a?t.cliMsgId:ul.a.next(),l=s[o],d=O_(l,c,Y.MSG_TEXT),u=Object(A_.b)(t,{send2Me:l===Ce.default.sendToMeId});d.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(u)),n||(d.type=Y.MSG_LINK_CLIENT,d.updateMessageContentProp(hl.a.LINK,{width:r.width,height:r.height,desc:t.message.description,href:t.message.href,src:r.src,media:r,thumb:t.message.thumb,title:r.mediaTitle})),Jo.b.getInstance().report({key:null==t?void 0:t.msgId,href:e,entry:Jo.a.SHARE_MESSAGE,preview:null}),t.message.title&&d.updateMessageContentProp("text",t.message.title),i.localMsgs[l]=d}return i}(i||"",e,t,r);for(let l in c.localMsgs){const t=c.localMsgs[l],s=D_(l);n._showLocalMessage(t,s,e,o)}return c};var Cb=async function(e,t,s={}){const{localMsgs:a,preview:i}=await Sb(e,t,s),n=Object(I.a)({},e);if(i){var r;const t=i.media||{};let s="";if(Object.keys(t).length>0)s=JSON.stringify(t);else{const[t,a]=E.g.safeParseJson(e.message.params);a.mediaTitle=i.title,s=JSON.stringify(a)}n.message={action:"recommened.link",childnumber:0,description:i.desc||"",href:i.href,params:s,thumb:i.thumb||"",title:e.message.title,type:(null===(r=i.media)||void 0===r?void 0:r.type)||""}}const{groups:o,oneOnes:c,sendToMe:l}=C_(t),d=[];if(l){const e=await gb(n,a[l]);d.push(e)}if(o.length){const e=await pb(n,o,a);d.push(e)}if(c.length){const e=await fb(n,c,a);d.push(e)}const u=({success:[],failed:[]}=S_(d));return await hb(a,u),u};var Eb=async function(e){return Cb(e.message,e.toUids,e.options)};var Ob=async function(e,t,s){const a={localMsgs:{}},i=K.default.getChatBoxControllerByWindowId(Ar.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"",o=Object(A_.b)(e,{send2Me:!1}),c=Object(A_.b)(e,{send2Me:!0});for(let l=0;l<t.length;l++){const s=t[l];const d=O_(s,(n?e.cliMsgId:ul.a.next())+"",e.msgType,e.message),u=s===Ce.default.sendToMeId?c:o;d.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(u)),a.localMsgs[s]=d;const h=D_(s);i._showLocalMessage(d,h,null,r)}return a};var Mb=async function(e,t,s={}){const{localMsgs:a}=await Ob(e,t,s),i={success:[],failed:[]};for(let o=0;o<t.length;o++){var n;const s=t[o],c=a[s],l=null===(n=c.reference)||void 0===n?void 0:n.data,d={forwardRefLog:l,decorLog:Object(A_.a)(l)};try{const a=await qc.default.forwardMessage(t[o],e,c.clientId,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,c,d);i.success.push({clientId:c.clientId+"",msgId:(a.msgId||a.minGlobalMsgId)+"",minGlobalMsgId:a.minGlobalMsgId+"",toUid:s})}catch(r){i.failed.push({clientId:c.clientId+"",error:r,toUid:s})}}return await hb(a,i),i};var Tb=async function(e){return Mb(e.message,e.toUids,e.options)};var Rb=async function(e,t,s={}){const a=[];for(let n=0;n<t.length;n++){const r={success:[],failed:[]},o=s.retry?e.cliMsgId:ul.a.next(),c=M_.a.preprocessMessage(o+"",e,null),l=D_(t[n]),d=t[n]===Ce.default.sendToMeId,u=Object(A_.b)(e,{send2Me:d}),h={forwardRefLog:u,decorLog:Object(A_.a)(u)};c.reference=Object(A_.c)(u);try{const e=await M_.a.forward(o+"",c,l,h);e?r.success.push({clientId:o+"",msgId:(e.msgId||e.minGlobalMsgId)+"",minGlobalMsgId:e.minGlobalMsgId+"",toUid:t[n]}):r.failed.push({clientId:o+"",error:"invalid response",toUid:t[n]})}catch(i){r.failed.push({clientId:o+"",error:i,toUid:t[n]})}T_(c,l,r),a.push(r)}return S_(a)};var wb=async function(e){return Rb(e.message,e.toUids,e.options)};var Lb=async function(e,t,s={}){const a={},i=K.default.getChatBoxControllerByWindowId(Ar.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"",o=Object(A_.b)(e,{send2Me:!1}),c=Object(A_.b)(e,{send2Me:!0});for(let l=0;l<t.length;l++){const s=t[l];const d=O_(s,n?e.cliMsgId:ul.a.next(),Y.MSG_GIF);let{oriUrl:u,normalUrl:h,params:g}=e.message;if(g){let e=k_.a.utils.safeParseJSON(g);const{width:t=0,height:s=0}=e,a={};u&&(a.original={width:t,height:s,url:u}),h&&(a.normal={width:t,height:s,url:h}),d.updateMessageContentProp(hl.a.GIF,a)}d.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(s===Ce.default.sendToMeId?c:o)),a[s]=d;const m=D_(s);i._showLocalMessage(d,m,e,r)}return{localMsgs:a}};var Db=async function(e,t,s={}){const a={success:[],failed:[]},{localMsgs:i}=await Lb(e,t,s);for(let o=0;o<t.length;o++){var n;const s=t[o],c=i[s],l=null===(n=c.reference)||void 0===n?void 0:n.data,d={forwardRefLog:l,decorLog:Object(A_.a)(l)};try{const t=await qc.default.forwardMessage(s,e,c.clientId,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,c,d);t?a.success.push({clientId:c.clientId+"",msgId:(t.msgId||t.minGlobalMsgId)+"",minGlobalMsgId:t.minGlobalMsgId+"",toUid:s}):a.failed.push({clientId:c.clientId+"",error:"invalid response",toUid:s})}catch(r){a.failed.push({clientId:c.clientId+"",error:r,toUid:s})}}return await hb(i,a),a};var Ab=async function(e){return Db(e.message,e.toUids,e.options)};var Fb=async function(e,t,s,a={}){const{localMsgs:i,additionalList:n}=s,r={success:[],failed:[]};for(let l=0;l<t.length;l++){var o;const s=t[l],a=i[s],d=null===(o=a.reference)||void 0===o?void 0:o.data,u=Object(I.a)(Object(I.a)({},n[s]||{}),{},{forwardRefLog:d,decorLog:Object(A_.a)(d)});try{const i=await qc.default.forwardMessage(t[l],e,a.clientId,Y.RETRY_MSG_TIMEOUT_DEFAULT,!1,a,u);r.success.push({clientId:a.clientId+"",msgId:(i.msgId||i.minGlobalMsgId)+"",minGlobalMsgId:i.minGlobalMsgId+"",toUid:s})}catch(c){r.failed.push({clientId:a.clientId+"",error:c,toUid:s})}}return r};var kb=class{constructor(e,t,s){this.message=e,this.toUids=t,this.options=s,this.preprocessResult=void 0,this.result=void 0,this.preprocessResult={},this.result={success:[],failed:[]}}async execute(){return this.preprocessResult=await this.preprocess(),this.result=await this.process(),this.postprocess(),this.result}};var Nb=async function(e,t,s){const a={localMsgs:{},additionalList:{}},i=K.default.getChatBoxControllerByWindowId(Ar.c),n=(null==s?void 0:s.retry)||!1,r=n?e.msgId:"";for(let o=0;o<t.length;o++){const s=t[o];const c=O_(s,(n?e.cliMsgId:ul.a.next())+"",e.msgType,e.message),l=Object(A_.b)(e,{send2Me:s===Ce.default.sendToMeId});c.updateMessageProp(hl.b.REFERENCE,Object(A_.c)(l)),a.localMsgs[s]=c;const d=D_(s);i._showLocalMessage(c,d,null,r)}return a};class Pb extends kb{async preprocess(){return Nb(this.message,this.toUids,this.options)}async process(){return Fb(this.message,this.toUids,this.preprocessResult,this.options)}async postprocess(){return hb(this.preprocessResult.localMsgs,this.result)}}var jb=async function(e){return new Pb(e.message,e.toUids,e.options).execute()};I_.a.registerHandler(b_.a.PHOTO,eb),I_.a.registerHandler(b_.a.FILE,G_),I_.a.registerHandler(b_.a.VIDEO,rb),I_.a.registerHandler(b_.a.TEXT,_b),I_.a.registerHandler(b_.a.STICKER,yb),I_.a.registerHandler(b_.a.LINK,Eb),I_.a.registerHandler(b_.a.CONTACT,Tb),I_.a.registerHandler(b_.a.VOICE,wb),I_.a.registerHandler(b_.a.GIF,Ab),I_.a.registerHandler(b_.a.GROUP_PHOTO,cb),I_.a.registerHandler(b_.a.DEFAULT,jb);class Ub{constructor(e){this._state=Ub.PENDING,this._resolve=void 0,this._reject=void 0,this._promise=void 0,this._reject=void 0,this._promise=new e(((e,t)=>{this._resolve=e,this._reject=t}))}reject(e){this._state===Ub.PENDING&&(this._state=Ub.REJECTED,this._reject(e))}resolve(e){this._state===Ub.PENDING&&(this._state=Ub.FULFILLED,this._resolve(e))}get state(){return this._state}get promise(){return this._promise}}Ub.PENDING="PENDING",Ub.FULFILLED="FULFILLED",Ub.REJECTED="REJECTED";var Bb=Ub;const zb={cancelledReason:"Task cancelled",timeoutReason:"Task timeout"};class Gb extends Bb{constructor(e,t=void 0,s=zb){super(Promise),this.executor=e,this.ttl=t,this.options=s,this._events=new Map,this._creationTimestamp=0,this._timeout=0,this.creationTimestamp=performance.now(),this.timeout=0,void 0!==t&&this.setTimeout()}addEventListener(e,t){let s=this.events.get(e);s||(s=[],this.events.set(e,s)),s.push(t)}cancel(){this.reject(this.getOptions().cancelledReason)}execute(...e){return this.executor.apply(this,e).then(this.resolve.bind(this)).catch(this.reject.bind(this)),this.promise}removeEventListener(e,t){const s=this.events.get(e);if(!s)return;this.events.set(e,s.filter((e=>e!==t)))}getOptions(){return Object(I.a)(Object(I.a)({},zb),this.options)}removeTimeout(){this.timeout&&clearTimeout(this.timeout),this.timeout=0}setTimeout(){if(this.state!==Gb.PENDING)return;if(isNaN(this.ttl)||this.ttl<=0)throw new Error("delay must be a positive int");const e=performance.now()-this.creationTimestamp;this.timeout&&this.removeTimeout(),this.timeout=window.setTimeout((()=>this.reject(this.getOptions().timeoutReason)),Math.max(this.ttl-e,0))}get events(){return this._events}get creationTimestamp(){return this._creationTimestamp}set creationTimestamp(e){this._creationTimestamp=e}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var xb=Gb,Vb=s("gOiJ"),Hb=s("1OYu");var Wb=function(e){const t=e.msgType;return t===Y.MSG_PHOTO_GROUP?[b_.a.GROUP_PHOTO,I_.a.getHandler(b_.a.GROUP_PHOTO)]:t===Y.MSG_PHOTO||t===Y.MSG_PHOTO_2||t===Y.MSG_DOODLE?[b_.a.PHOTO,I_.a.getHandler(b_.a.PHOTO)]:t===Y.MSG_FILE?[b_.a.FILE,I_.a.getHandler(b_.a.FILE)]:t===Y.MSG_VIDEO?[b_.a.VIDEO,I_.a.getHandler(b_.a.VIDEO)]:t===Y.MSG_TEXT?[b_.a.TEXT,I_.a.getHandler(b_.a.TEXT)]:t===Y.MSG_STICKER?[b_.a.STICKER,I_.a.getHandler(b_.a.STICKER)]:t===Y.MSG_CONTACT&&"recommened.link"==e.message.action||"link"===e.type?[b_.a.LINK,I_.a.getHandler(b_.a.LINK)]:t!==Y.MSG_CONTACT||"recommened.user"!=e.message.action&&"recommened.vip"!=e.message.action?t===Y.MSG_VOICE?[b_.a.VOICE,I_.a.getHandler(b_.a.VOICE)]:t===Y.MSG_GIF?[b_.a.GIF,I_.a.getHandler(b_.a.GIF)]:[b_.a.DEFAULT,I_.a.getHandler(b_.a.DEFAULT)]:[b_.a.CONTACT,I_.a.getHandler(b_.a.CONTACT)]};var qb,Kb=class{constructor(e,t){this.messages=e,this.toUids=t,this.startTime=0,this._Logger=void 0}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("forward-log",["track forward message"])),this._Logger}startForward(){this.startTime=performance.now()}endForward(e){for(let t=0;t<e.length;t++)this.logForMsg(this.messages[t],e[t]);this.logForwardDone()}logForwardDone(){let e=0,t=0,s=0,a=0;for(let i=0;i<this.toUids.length;i++){const n=this.toUids[i];n.startsWith(Y.GROUPID_PREFIX)?e++:n===Ce.default.sendToMeId?a++:(t++,Ii.default.isFriend(n)||s++)}for(let i=0;i<this.messages.length;i++){const n=this.messages[i];Ia.default.logActionInfoV2(Ia.FeaturesInfo.ForwardMessage,0,{src_id:n.toUid||n.userId,msgType:n.msgType,gapTime:Date.now()-+n.sendDttm,duration:performance.now()-this.startTime,totalConv:this.toUids.length,chatgroup:e,chat11:t,stranger:s,mycloud:a})}}logForMsg(e,t){t.success.length>0&&this.logSuccess(e,t.success),t.failed.length>0&&this.logFail(e,t.failed)}logSuccess(e,t){}logFail(e,t){const s=e.toUid||e.userId,a=gl.a.instance().isOnE2ee(s);for(let i=0;i<t.length;i++){const{error:n,toUid:r}=t[i],o=gl.a.instance().isOnE2ee(r);let c=0;c=a||o?a&&o?1:2:0;let l=1;r.startsWith(Y.GROUPID_PREFIX)?l=2:r===Ce.default.sendToMeId&&(l=3);let d=0;if(d="string"==typeof n||"number"==typeof n?n:(null==n?void 0:n.code)||(null==n?void 0:n.errorCode)||(null==n?void 0:n.error_code)||n.message,d===_g.a.DeleteConversationHasSendingMsg||d===_g.a.DeleteSendingMsg||d===_g.a.MsgArrivedBeforeAPIResponse)return;const u={fail_error:d,e2ee:c,msgtype:e.msgType,src_id:s,chat_type:l,duration:performance.now()-this.startTime,number_conversation:this.toUids.length};Ce.default.forward_messages.enable_tracking_log?this.Logger.zsymb(21,"Iwpm0d",["forwardMessageFromLocal fail : {} {}","WyKLXM"],JSON.stringify(u),e):this.Logger.zsymb(21,"msAr6E",["forwardMessageFromLocal fail : {}","XAu9R9"],JSON.stringify(u)),Ia.default.logActionInfoV2(Ia.FeaturesInfo.ForwardMsgFail,0,u)}}};Object(a.injectable)()(qb=Object(a.singleton)(Hb.a)(qb=function(e,t){return Object(a.inject)(f_)(e,void 0,0)}(qb=Reflect.metadata("design:type",Function)(qb=Reflect.metadata("design:paramtypes",[Object])(qb=class{constructor(e){this.poolFactory=e,this._pool=void 0}async forwardMessages(e,t,s={}){this.pool||this.initializePool(),e.forEach((e=>{e.toUid||(e.toUid=e.userId)}));const a=this.buildTask(e,t,s||{});return this.pool.use(a).then((e=>Promise.resolve(e)))}async retryForwardMessages(e,t={}){const s=Object(I.a)(Object(I.a)({},t),{},{retry:!0});this.pool||this.initializePool();const a=e.map((e=>e.toUid)),i=this.buildTask(e,a,s);return this.pool.use(i).then((e=>Promise.resolve(e)))}buildTask(e,t,s){return async()=>{try{return await this.runTaskInSerialization(e,t,s)}catch(a){return Promise.reject(a)}}}cleanUp(){this.pool&&this.pool.drain(),this.pool=void 0}initializePool(){const e={max:Object(Vb.b)(),min:Object(Vb.c)(),autostart:!0};this.pool=this.poolFactory.createPool({create:async()=>({}),destroy:async()=>{}},e)}async runSubTask(e,t,s){const[a,i]=Wb(e);if(null==i)return Promise.reject("Invalid handler");try{const a=new xb(i,Object(Vb.a)());return await a.execute({message:e,toUids:t,options:s})}catch(n){return Promise.reject(n)}}async runTaskInSerialization(e,t,s){const a=[];e.forEach((e=>{a.push(this.runSubTask.bind(null,Object(I.a)(Object(I.a)({},e),{},{mentions:null}),t,s))}));const i=new Kb(e,t);i.startForward();const n=await async function(e){if(!Array.isArray(e))return Promise.reject("Params functions is invalid");const t=[...e],s=[];for(const i of t)try{const e=await i();s.push({isSuccess:!0,data:e})}catch(a){s.push({isSuccess:!1,error:a})}return s}(a);try{const e=n.map(((e,t)=>e.data));i.endForward(e)}catch(o){}const r=n.map(((t,s)=>({id:e[s].msgId,isSuccess:t.isSuccess,data:t.data,error:t.error})));return Promise.resolve(r)}get pool(){return this._pool}set pool(e){this._pool=e}})||qb)||qb)||qb)||qb);const Zb=Object(a.define)("ACTIVE_CONVERSATION_INFO_LIST_FOR_PIN_TOPIC");var $b;Object(a.injectable)()($b=Object(a.singleton)(Zb)($b=class{constructor(){this._activeConversationInfoList=new Map}activateConversation(e,t){if(!e||!t)return;const s=this._activeConversationInfoList.get(e);if(s){const a=s.tokens.indexOf(this._getToken(e,t));-1===a&&s.tokens.push(this._getToken(e,t));const i=s.windowIds.indexOf(t);-1===i&&s.windowIds.push(t),-1!==a&&-1!==i||(s.lastModified=Date.now(),this._activeConversationInfoList.set(this._getKey(e),s))}else this._activeConversationInfoList.set(this._getKey(e),{lastModified:Date.now(),tokens:[this._getToken(e,t)],windowIds:[t]})}deactivateConversation(e,t){const s=this._activeConversationInfoList.get(e);if(s){s.lastModified=Date.now();let a=s.tokens.indexOf(this._getToken(e,t));a>-1&&s.tokens.splice(a,1);const i=s.windowIds.indexOf(t);i>-1&&s.windowIds.splice(i,1),0===s.windowIds.length&&0===s.tokens.length?this._activeConversationInfoList.delete(e):this._activeConversationInfoList.set(e,s)}}getActiveConversationInfo(e){const t=this._activeConversationInfoList.get(e);return t?{lastModified:t.lastModified,tokens:[...t.tokens],windowIds:[...t.windowIds]}:{lastModified:0,tokens:[],windowIds:[]}}getActiveConvIdList(){let e=[];return this._activeConversationInfoList.size>0&&(e=Array.from(this._activeConversationInfoList.keys())),e}_getKey(e){return e}_getToken(e,t){return`${e}_${t}`}})||$b);var Qb=s("+3r3"),Yb=s("YYsv"),Jb=s("3ZdV");var Xb=Object(a.define)("pin-topic-data-repository");var eI=Object(a.define)("pin-topic-message-loader"),tI=s("0URt"),sI=s("DRpF");function aI(e){return!(-1===Object(tI.g)().indexOf(e.msgType))&&!Object(sI.a)(e)}function iI(e,t,s){return s===e?1:s<t?0:-1}function nI(e){const t={needFetch:!1,reason:""};if(null==e||null==e||!e.lastFetch)return t.needFetch=!0,t.reason="empty",t;const{lastFetch:s}=e,a=function(e){return _p.a.isOverflowAtTime(e)}(s);if(a)return t.needFetch=!0,t.reason="overflow",t;const i=function(e){return Date.now()-e>Object(Jb.e)()}(s);if(i)return t.needFetch=!0,t.reason="expired",t;const r=function(e){const t=n.default.getInstance().getItemForCurrentUser(Yb.g.FORCE_FETCH_MILESTONE);return!(!t||isNaN(+t))&&e<+t}(s);return r?(t.needFetch=!0,t.reason="forcedByServer",t):t}function rI(e){const t=[];return e.forEach((e=>{t.push({topicId:e.id,topicType:e.type})})),t}var oI=s("UIHX");function cI(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.client_msg_id)||""}function lI(e){var t;return(null===(t=e.params)||void 0===t?void 0:t.global_msg_id)||""}function dI(e,t,s){let a=t;const{topics:i}=s;if(!Array.isArray(i))return a;switch(e){case oI.a.ADD:{const{index:e}=s;a=null==e?[...i,...t]:[...t.slice(0,e),...i,...t.slice(e)];break}case oI.a.REMOVE:{const e={};i.forEach((t=>{e[t.id]=t.type})),a=[],t.forEach((t=>{(!e.hasOwnProperty(t.id)||e.hasOwnProperty(t.id)&&e[t.id]!==t.type)&&a.push(t)}));break}}return a}function uI(e){const t=e=>{if(!Array.isArray(e))return e;const t=[];for(let s=0;s<e.length;s++){const a=e[s];a&&(null!=a.id&&(a.id=a.id.toString()),null!=a.topicId&&(a.topicId=a.topicId.toString()),null!=a.type&&(a.type=parseInt(a.type)),null!=a.topicType&&(a.topicType=parseInt(a.topicType)),t.push(a))}return t},s=Object(I.a)({},e);return null!=s.oldTopic&&(s.oldTopic=t([s.oldTopic])[0]),null!=s.topic&&(s.topic=t([s.topic])[0]),null!=s.topics&&(s.topics=t(s.topics)),s}function hI(e){let t={};if(!e.params)return e;try{t=JSON.parse(e.params)}catch(s){return}if(t.extra&&t.extra.constructor===String)try{t.extra=JSON.parse(t.extra)}catch(s){return}return e.params=t,e}function gI(e){return new Promise((t=>{let s=0,a=0,i={};for(let n in e)s++,e[n].then((e=>{i[n]=e,a++,a===s&&t(i)})).catch((()=>{i[n]=null,a++,a===s&&t(i)}));0===s&&t({})}))}function mI(e,t){return Object(Bv.f)(e,Number.isInteger(+t)?t:1/0)}var pI=Object(a.define)("pin-topic-one-on-one-controller");var fI=class{constructor(e,t){this.moduleName=e,this.instanceNames=t,this.instanceMap=new Map}error(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(18,"NUJ1nY",...t)}info(e,...t){const s=this.getLogger(e);void 0!==s&&s.zsymb(0,"NWgRgu",...t)}getLogger(e){if(this.instanceNames.includes(e)&&void 0===this.instanceMap.get(e)){const t=this.LoggerFactory.createZLogger(w.ZLoggerNametags.pinTopic,[this.moduleName,e]);this.instanceMap.set(e,t)}return this.instanceMap.get(e)}get LoggerFactory(){return a.ModuleContainer.resolve(es.ZLoggerFactory)}},vI=function(e){return e.CONTROL="control",e.CREATE="create",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(vI||{});var _I,bI=class extends fI{constructor(){super(oI.f.OneOnOneController,[vI.CONTROL,vI.CREATE,vI.LOAD,vI.REORDER,vI.UNPIN])}infoControl(...e){this.logInfo(vI.CONTROL,...e)}infoCreate(...e){this.logInfo(vI.CREATE,...e)}infoLoad(...e){this.logInfo(vI.LOAD,...e)}infoReorder(...e){this.logInfo(vI.REORDER,...e)}infoUnpin(...e){this.logInfo(vI.UNPIN,...e)}errorControl(...e){this.logError(vI.CONTROL,...e)}errorCreate(...e){this.logError(vI.CREATE,...e)}errorLoad(...e){this.logError(vI.LOAD,...e)}errorReorder(...e){this.logError(vI.REORDER,...e)}errorUnpin(...e){this.logError(vI.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Jb.g)()}};Object(a.injectable)()(_I=Object(a.singleton)(pI)(_I=function(e,t){return Object(a.inject)(Xb)(e,void 0,0)}(_I=function(e,t){return Object(a.inject)(eI)(e,void 0,1)}(_I=Reflect.metadata("design:type",Function)(_I=Reflect.metadata("design:paramtypes",[Object,Object])(_I=class{constructor(e,t){this.dataRepository=e,this.messageLoader=t,this.events={},this.logger=void 0,this.requestID=void 0,this.initialize(),this.logger=new bI,this.requestID=new De.a}getPinTopic(e,t,s){return new Promise(((a,i)=>{this.loadPinTopics(e).then((e=>{const{topics:n}=e,r=n.find((e=>e.id===(null==t?void 0:t.toString())&&e.type===s));r?a(r):i(null)})).catch(i)}))}getMessageFromTopic(e){return this.MessageLoader.getMessageFromTopic(e)}displayEntryPointPromotionalTooltip(){this.DataRepository.setEntryPointPromotionalTooltipShowedStatus(!0)}isDisplayedEntryPointPromotionalTooltip(){if(!Object(Jb.l)())return!0;const e=this.DataRepository.getEntryPointPromotionalTooltipShowedStatus();return null!==e&&Boolean(e)}async loadPinTopics(e,t=!1){if(!Object(Jb.k)())return Promise.reject({code:Yb.c.OFF_FEATURE,message:""});const s=this.getRequestID();try{var a;let i;t&&(i=Yb.e.OPEN_DIALOG),this.Logger.infoLoad(s,`call cId:${e}`,t);const n=await this.DataRepository.loadPinTopics(e,i);return this.Logger.infoLoad(s,`res cId:${e}`,!!n,n.conversationId,null===(a=n.topics)||void 0===a?void 0:a.length),{conversationId:n.conversationId,topics:n.topics}}catch(i){return this.Logger.errorLoad(s,`err cId:${e}`,mI(i,Object(Jb.a)())),Promise.reject(i)}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}removeEventListener(e,t){const s=this.events[e],a=(this.events[e]||[]).length;for(let i=0;i<a;i++)if(s[i]===t){s.splice(i,1);break}0===s.length&&delete this.events[e]}removeEventListeners(e){delete this.events[e]}handleEventControl(e){if(!Object(Jb.k)())return;const t=this.getRequestID();this.Logger.infoControl(t,"recv",e.act,mI(e.data,Object(Jb.a)())),this.DataRepository.handleReceivingEvent(e.act,e.data).then((s=>{if(this.Logger.infoControl(t,"res",e.act,mI(s,Object(Jb.a)())),e.act===Yb.d.UNPIN){let t=[];if(Array.isArray(e.data.topics)&&e.data.topics.forEach((e=>{s.topics.find((t=>t.id===e.topicId&&t.type===e.topicType))||t.push({topicId:e.topicId,topicType:e.topicType})})),t.length>0){const s={};t.forEach((t=>{s[`${t.topicId}_${t.topicType}`]=this.getPinTopic(e.data.conversationId,t.topicId,t.topicType)})),gI(s).then((e=>{const t=Object.keys(e).map((t=>e[t]));this.MessageLoader.removeMessages(t)}))}}this.MessageLoader.loadMessages(s.conversationId,s.topics),this.notifyChangeEvent(s.conversationId,s.topics)})).catch((s=>{this.Logger.errorControl(t,"err",e.act,mI(s,Object(Jb.a)()))}))}async createPinTopic(e,t,s=2){if(!Object(Jb.k)())return Promise.reject({code:Yb.c.OFF_FEATURE,message:""});const a=this.getRequestID();try{var i;if(this.Logger.infoCreate(a,`call cId:${e}`,!!t,s),!this.isValidNetwork())return Promise.reject({code:Yb.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processCreatePinTopic(e,t,s)));return this.Logger.infoCreate(a,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(i=n.topics)||void 0===i?void 0:i.length),n}catch(n){return this.Logger.errorCreate(a,`err cId:${e}`,mI(n,Object(Jb.a)())),Promise.reject(n)}}async reorderPinTopics(e,t,s=2){if(!Object(Jb.k)())return Promise.reject({code:Yb.c.OFF_FEATURE,message:""});const a=this.getRequestID();try{var i;if(this.Logger.infoReorder(a,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:Yb.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processReorderPinTopics(e,t,s)));return this.Logger.infoReorder(a,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(i=n.topics)||void 0===i?void 0:i.length),n}catch(n){return this.Logger.errorReorder(a,`err cId:${e}`,mI(n,Object(Jb.a)())),Promise.reject(n)}}async unpinPinTopics(e,t,s=2){if(!Object(Jb.k)())return Promise.reject({code:Yb.c.OFF_FEATURE,message:""});const a=this.getRequestID();try{var i;if(this.Logger.infoUnpin(a,`call cId:${e}`,t.length,s),!this.isValidNetwork())return Promise.reject({code:Yb.c.NO_NETWORK,message:"STR_CHECK_NET"});const n=await this.retryable(s,(()=>this.processUnpinPinTopics(e,t,s)));return this.Logger.infoUnpin(a,`res cId:${e}`,!!n,null==n?void 0:n.conversationId,null==n||null===(i=n.topics)||void 0===i?void 0:i.length),n}catch(n){return this.Logger.errorUnpin(a,`err cId:${e}`,mI(n,Object(Jb.a)())),Promise.reject(n)}}isMessagePinnable(e){return function(e){return aI(e)}(e)}initialize(){this.FriendManager.subscribeEventFriend(Y.EventFriend.REMOVE_FRIEND,(e=>{const{userId:t}=e;t&&this.clearTopics(t)})),Object(Qb.b)(this.clear)}clear(){this.DataRepository.clear(),this.MessageLoader.clear()}checkEnableToCreate(e,t,s){const a=(()=>{if(t.type===Yb.i.MESSAGE){const a=s.topics,i=t.params.global_msg_id,n=t.params.client_msg_id,r=t.params.senderUid;for(let t=0;t<a.length;t++){const s=a[t];if(s.type===Yb.i.MESSAGE){const t=this.MessageLoader.getMessageFromTopic(s);if(null!=t&&null!=i&&t.msgId===i)return s;if(null!=t&&null!=n&&t.cliMsgId===n&&t.fromUid===r&&t.toUid===e)return s}}}return null})();return s.topics.length<Object(Jb.c)()||a?{enable:!0,oldTopic:a}:{enable:!1,oldTopic:null}}clearTopics(e){this.DataRepository.loadPinTopics(e,Yb.e.NONE).then((t=>{this.DataRepository.clearPinTopicsForConversation(e,!0),this.MessageLoader.removeMessages(t.topics),this.notifyChangeEvent(e,[])})).catch()}getRequestID(){return this.requestID.next()}async fetchTopicsForHandleTopLevelErrors(e,t){return await this.DataRepository.loadPinTopics(e,t)}async handleTopLevelErrorInvalidBoardVersion(e,t,s){const{conversationId:a}=t;try{const e=await this.fetchTopicsForHandleTopLevelErrors(a,Yb.e.OUT_OF_DATE);return s?await s():e}catch(i){return Promise.reject(e)}}async handleTopLevelErrorRolledData(e,t){const{conversationId:s}=t;try{const t=await this.fetchTopicsForHandleTopLevelErrors(s,Yb.e.ROLLED_DATA);return this.notifyChangeEvent(t.conversationId,t.topics),Promise.reject({code:Yb.c.TOPIC_NOT_IN_PIN_LIST,message:e.message||"STR_PIN_GENERAL_ERROR"})}catch(a){return Promise.reject(e)}}async handleTopLevelErrorUserBlockFriend(e){return Promise.reject({code:Yb.c.USER_BLOCK_FRIEND,message:e.message||"STR_TOAST_BLOCK"})}async handleTopLevelErrorUserNonFriend(e){return Promise.reject({code:Yb.c.USER_NON_FRIEND,message:e.message||"STR_PIN_NOT_ZALO_FRIEND"})}async handleTopLevelErrors(e,t,s){return e.code===Yb.c.INVALID_BOARD_VERSION?await this.handleTopLevelErrorInvalidBoardVersion(e,t,s):e.code===Yb.c.TOPIC_NOT_IN_PIN_LIST?await this.handleTopLevelErrorRolledData(e,t):e.code===Yb.c.USER_BLOCK_FRIEND?await this.handleTopLevelErrorUserBlockFriend(e):e.code===Yb.c.USER_NON_FRIEND?await this.handleTopLevelErrorUserNonFriend(e):Promise.reject(e)}isValidNetwork(){return le.b.getStateNetwork()===le.a.CONNECTED}notifyEvent(e,...t){const s=this.events[e],a=(this.events[e]||[]).length;for(let i=0;i<a;i++)"function"==typeof s[i]&&s[i](...t)}notifyChangeEvent(e,t){this.notifyEvent("onchange",e,t)}notifyExceedEvent(e,t,s){this.notifyEvent("onexceed",e,t,s)}async processCreatePinTopic(e,t,s=2){if(!this.FriendManager.isFriend(e))return Promise.reject({code:Yb.c.USER_NON_FRIEND,message:"STR_PIN_NOT_ZALO_FRIEND"});if(this.FriendManager.isBlocked(e))return Promise.reject({code:Yb.c.USER_BLOCK_FRIEND,message:"STR_TOAST_BLOCK"});try{const s=await this.DataRepository.createPinTopic(e,t,{checkEnableToCreate:this.checkEnableToCreate.bind(this)});return this.MessageLoader.loadMessages(e,s.topics),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(i){try{const a=await this.handleTopLevelErrors(i,{conversationId:e},this.createPinTopic.bind(this,e,t,s-1));return{conversationId:a.conversationId,topics:a.topics}}catch(n){if(n.code===Yb.c.PINBOARD_OVER_MAXIMUM){var a;const s=null==n||null===(a=n.data)||void 0===a?void 0:a.cache;this.notifyExceedEvent(e,(null==s?void 0:s.topics)||[],t)}return Promise.reject(n)}}}async processReorderPinTopics(e,t,s=2){try{const s=await this.DataRepository.reorderPinTopics(e,t);return this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(a){try{const i=await this.handleTopLevelErrors(a,{conversationId:e},this.reorderPinTopics.bind(this,e,t,s-1));return{conversationId:i.conversationId,topics:i.topics}}catch(i){return Promise.reject(i)}}}async processUnpinPinTopics(e,t,s=2){try{const s=await this.DataRepository.unpinTopics(e,t);return this.MessageLoader.removeMessages(t),this.notifyChangeEvent(s.conversationId,s.topics),{conversationId:s.conversationId,topics:s.topics}}catch(a){try{const i=await this.handleTopLevelErrors(a,{conversationId:e},this.unpinPinTopics.bind(this,e,t,s-1));return{conversationId:i.conversationId,topics:i.topics}}catch(i){return Promise.reject(i)}}}async retryable(e,t){return null!=e&&e<0?Promise.reject({code:Yb.c.STOP_RETRY_CLIENT,message:"STR_PIN_GENERAL_ERROR"}):await t()}get DataRepository(){return this.dataRepository}get FriendManager(){return Ii.default}get Logger(){return this.logger}get MessageLoader(){return this.messageLoader}})||_I)||_I)||_I)||_I)||_I);var II,yI=s("74m0");Object(a.injectable)()(II=Object(a.singleton)(yI.a)(II=function(e,t){return Object(a.inject)(pI)(e,void 0,0)}(II=Reflect.metadata("design:type",Function)(II=Reflect.metadata("design:paramtypes",[Object])(II=class{constructor(e){this.oneOnOneController=e}addEventListener(e,t){this.OneOnOneController.addEventListener(e,t)}createPinTopic(e,t){return Object(sI.d)(e)?Promise.resolve():this.OneOnOneController.createPinTopic(e,t)}displayOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.displayEntryPointPromotionalTooltip()}getPinTopic(e,t,s){return Object(sI.d)(e)?Promise.resolve():this.OneOnOneController.getPinTopic(e,t,s)}getMessageFromTopic(e,t){if(!Object(sI.d)(e))return this.OneOnOneController.getMessageFromTopic(t)}handleEventControl(e){}handleOneOnOneEventsControl(e){this.OneOnOneController.handleEventControl(e)}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return this.OneOnOneController.isDisplayedEntryPointPromotionalTooltip()}isEnablePinTopicOneOnOneFeature(){return Jb.k()}isEnablePinTopicOneOnOneEntryPoint(){return Jb.j()}isMessagePinnable(e,t){return!!this.isMessagePinnableForAllConversations(e)&&(t!==Y.CONVERSATION_TYPE.FRIEND||this.OneOnOneController.isMessagePinnable(e))}loadPinTopics(e,t){return Object(sI.d)(e)?Promise.resolve():this.OneOnOneController.loadPinTopics(e,t)}removeEventListener(e,t){this.OneOnOneController.removeEventListener(e,t)}removeEventListeners(e){this.OneOnOneController.removeEventListeners(e)}reorderPinTopics(e,t){return Object(sI.d)(e)?Promise.resolve():this.OneOnOneController.reorderPinTopics(e,t)}unpinPinTopics(e,t){return Object(sI.d)(e)?Promise.resolve():this.OneOnOneController.unpinPinTopics(e,t)}isMessagePinnableForAllConversations(e){return aI(e)}get OneOnOneController(){return this.oneOnOneController}})||II)||II)||II)||II);var SI=Object(a.define)("pin-topic-storage"),CI=SI;var EI,OI=function(){const e={};return{clear:()=>{for(const t in e)delete e[t]},get:t=>e[t],getCache:()=>e,set:(t,s)=>{e[t]=s},has:t=>e.hasOwnProperty(t),remove:t=>{delete e[t]}}};var MI=Object(a.injectable)()(EI=function(e,t){return Object(a.inject)(CI)(e,void 0,0)}(EI=Reflect.metadata("design:type",Function)(EI=Reflect.metadata("design:paramtypes",[Object])(EI=class{constructor(e){this.storage=e,this.clientMsgCache=void 0,this.globalMsgCache=void 0,this.globalMsgCache=OI(),this.clientMsgCache=OI()}clear(e){switch(e){case oI.g.GLOBAL:return void this.globalMsgCache.clear();case oI.g.CLIENT:return void this.clientMsgCache.clear();default:return this.globalMsgCache.clear(),void this.clientMsgCache.clear()}}loadMessages(e,t){return new Promise(((s,a)=>{t&&0!==t.length||a("Invalid topics");const i=t.length;for(let n=0;n<i;n++){const s=t[n];if(!s)continue;let i=lI(s);if(i&&"0"!==i)this.getMessage(e,oI.g.GLOBAL,i).then().catch((e=>{a(e)}));else{let t=cI(s);if(t){let i=s.params&&s.params.senderUid;this.getMessage(e,oI.g.CLIENT,t,{userId:i}).then().catch((e=>{a(e)}))}}}s()}))}getMessageFromTopic(e){if(e.type!==oI.i.MESSAGE||!e.params)return{};let t=lI(e);if(this.globalMsgCache&&this.globalMsgCache.has(t))return this.globalMsgCache.get(t)||{};let s=cI(e);return this.clientMsgCache&&this.clientMsgCache.has(s)&&this.clientMsgCache.get(s)||{}}removeMessages(e){Array.isArray(e)&&e.forEach((e=>{const t=lI(e),s=cI(e);this.globalMsgCache.remove(t),this.clientMsgCache.remove(s)}))}getMessage(e,t,s,a={}){return new Promise(((i,n)=>{switch(t){case oI.g.GLOBAL:{let a=this.globalMsgCache.get(s);a?i(a):this.storage.getMessagesByIds(e,[s]).then((e=>{e?(this.setMessage(t,s,e),i(e)):n("Not found")})).catch((e=>{n(e)}));break}case oI.g.CLIENT:{const{userId:r}=a;let o=this.clientMsgCache.get(s);o?i(o):this.storage.getMessageByCliMsgId(e,s,{myUID:Ii.default.getUidMe(),userId:r}).then((e=>{e?(this.setMessage(t,s,e),i(e)):n("Not found")})).catch((e=>{n(e)}));break}default:n("Unknown")}}))}setMessage(e,t,s){switch(e){case oI.g.GLOBAL:return void this.globalMsgCache.set(t,s);case oI.g.CLIENT:return void this.clientMsgCache.set(t,s);default:return}}})||EI)||EI)||EI)||EI;a.ModuleContainer.register(eI,MI);var TI=s("vSga");var RI=function(){const e={},t=t=>e[t]||null;return{clear:()=>{for(const t in e)delete e[t]},get:t,getAll:()=>e,getLastFetch:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastFetch)||0},getLastModified:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.lastModified)||0},getTopics:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.topics)||[]},getVersion:e=>{var s;return(null===(s=t(e))||void 0===s?void 0:s.version)||0},has:t=>!!e[t],remove:t=>{delete e[t]},set:(t,s)=>{e[t]=s}}};var wI=function(e){const t=[];let s=!1;const a=e||(()=>{}),i=()=>t.length,n=e=>{s=e},r=()=>{if(s)return;if(!i())return void a();const e=t.shift();e&&(n(!0),e().then((()=>{n(!1),r()})).catch((()=>{n(!1),r()})))};return{enqueue:e=>{t.push(e),r()},dequeue:r,getLength:i}};var LI=function(){const e=[];let t;const s=()=>e.length,a=(i,n)=>{if(n&&(t=n),!s())return t&&t(i);const r=e.shift();r&&((e,t)=>{const{callback:s}=e;let i;"function"==typeof s&&(i=s(e.data,t)),a(i)})(r,i)};return{enqueue:t=>{e.push(t)},dequeue:a,getLength:s}},DI=s("u+F0");var AI=Object(a.define)("pin-topic-request-handler"),FI=function(e){return e.CONTROL="control",e.CREATE="create",e.FETCH="fetch",e.LOAD="load",e.REORDER="reorder",e.UNPIN="unpin",e}(FI||{});var kI,NI=class extends fI{constructor(){super(oI.f.DataRepository,[FI.CONTROL,FI.CREATE,FI.FETCH,FI.LOAD,FI.REORDER,FI.UNPIN])}infoControl(...e){this.logInfo(FI.CONTROL,...e)}infoCreate(...e){this.logInfo(FI.CREATE,...e)}infoFetch(...e){this.logInfo(FI.FETCH,...e)}infoLoad(...e){this.logInfo(FI.LOAD,...e)}infoReorder(...e){this.logInfo(FI.REORDER,...e)}infoUnpin(...e){this.logInfo(FI.UNPIN,...e)}errorControl(...e){this.logError(FI.CONTROL,...e)}errorCreate(...e){this.logError(FI.CREATE,...e)}errorFetch(...e){this.logError(FI.FETCH,...e)}errorLoad(...e){this.logError(FI.LOAD,...e)}errorReorder(...e){this.logError(FI.REORDER,...e)}errorUnpin(...e){this.logError(FI.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Jb.h)()}};var PI=Object(a.injectable)()(kI=function(e,t){return Object(a.inject)(CI)(e,void 0,0)}(kI=function(e,t){return Object(a.inject)(AI)(e,void 0,1)}(kI=Reflect.metadata("design:type",Function)(kI=Reflect.metadata("design:paramtypes",[Object,Object])(kI=class{constructor(e,t){this.storage=e,this.fetcher=t,this.cache=void 0,this.eventQueue=void 0,this.logger=void 0,this.pendingWhenLoadQueue=void 0,this.requestID=void 0,this.cache=RI(),this.eventQueue={},this.pendingWhenLoadQueue={},this.logger=new NI,this.requestID=new De.a}clear(){this.cache.clear();for(const e in this.pendingWhenLoadQueue)delete this.pendingWhenLoadQueue[e];for(const e in this.eventQueue)delete this.eventQueue[e]}clearPinTopicsForConversation(e,t=!1){this.cache.remove(e),delete this.pendingWhenLoadQueue[e],delete this.eventQueue[e],this.Storage.clearTopics(e,t)}createPinTopic(e,t,s={}){return new Promise(((a,i)=>{const n=this.getRequestID();this.Logger.infoCreate(n,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((r=>{const{checkEnableToCreate:o}=s||{};let c=null;if(o){const{enable:s,oldTopic:a}=o(e,t,r);if(!s)return this.Logger.infoCreate(n,`cId:${e} react limit`),i({code:DI.a.PINBOARD_OVER_MAXIMUM,message:"",data:{cache:r}});a&&(c=a)}const{version:l}=r;this.Logger.infoCreate(n,`cId:${e}`,l),this.Fetcher.createTopic(e,t,l).then((t=>{this.Logger.infoCreate(n,`cId:${e}, create topic success`);let s=t.response.data;s.oldVersion=l,c&&(s.oldTopic={topicId:c.id,topicType:c.type}),s=uI(s),this.enqueueEvent(e,this.addTopic.bind(this,e,s,(e=>a(e))))})).catch((t=>{const s=t.error;s.data=Object(I.a)(Object(I.a)({},null==s?void 0:s.data),{},{cache:r}),this.Logger.errorCreate(n,`cId:${e}, create topic fail`,mI(t,Object(Jb.b)())),i(s)}))}))}))}getEntryPointPromotionalTooltipShowedStatus(){return this.Storage.getEntryPointPromotionalTooltipShowedStatus()}handleReceivingEvent(e,t){return new Promise(((s,a)=>{if(this.Logger.infoControl(`call ${e}`,mI(t,Object(Jb.b)())),e===oI.c.FORCE_SYNC){const{conversationIds:e}=t;if(!Array.isArray(e))return a("Invalid conversationIds for force all");if(0===e.length)this.Storage.setForcedFetchMilestone(Date.now());else for(let t=0;t<e.length;t++){var i;const n=null===(i=e[t])||void 0===i?void 0:i.toString();n&&(this.clearPinTopicsForConversation(n),this.fetchTopics(n).then((e=>{s(e)})).catch(a))}}else{const{conversationId:i}=t;this.loadDataFromCacheOrDB(i).then((i=>{this.processEventControl(e,t,i,s,a)}))}}))}loadPinTopics(e,t){return new Promise(((s,a)=>{e||a({status:oI.h.ERROR,error:{code:DI.a.INVALID_PARAMETERS,message:"ConversationId not valid"}});const i=this.getRequestID();if(this.Logger.infoLoad(i,`call cId:${e}`),t&&t!==oI.d.NONE)return this.Logger.infoLoad(i,`force fetch cId:${e}`,t),this.fetchTopics(e).then((e=>{s(e)}));this.loadDataFromCacheOrDB(e).then((n=>{if(this.Logger.infoLoad(i,`cId:${e}`),t===oI.d.NONE)return s(n);this.doCheckAndFetchData(n).then((e=>{s(e)})).catch(a)}))}))}reorderPinTopics(e,t){return new Promise(((s,a)=>{const i=this.getRequestID();this.Logger.infoReorder(i,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((n=>{const{version:r}=n,o=rI(t);this.Logger.infoReorder(i,`cId:${e}`,r),this.Fetcher.reorderTopics(e,o,r).then((a=>{this.Logger.infoReorder(i,`cId:${e}, reorder topic success`);let n=a.response.data;n.oldVersion=r,n.topics=t,n=uI(n),this.enqueueEvent(e,this.setTopics.bind(this,e,n,(e=>s(e))))})).catch((t=>{this.Logger.errorReorder(i,`cId:${e}, reorder topic fail`,mI(t,Object(Jb.b)())),a(t.error)}))}))}))}setEntryPointPromotionalTooltipShowedStatus(e){this.Storage.setEntryPointPromotionalTooltipShowedStatus(e)}unpinTopics(e,t){return new Promise(((s,a)=>{const i=this.getRequestID();this.Logger.infoUnpin(i,`call cId:${e}`),this.loadDataFromCacheOrDB(e).then((n=>{const{version:r}=n,o=rI(t);this.Logger.infoUnpin(i,`cId:${e}`,r),this.Fetcher.unpinTopics(e,o,r).then((a=>{this.Logger.infoUnpin(i,`cId:${e} unpin topic success`);let n=a.response.data;n.oldVersion=r,n.topics=t,n=uI(n),this.enqueueEvent(e,this.removeTopics.bind(this,e,n,(e=>s(e))))})).catch((t=>{this.Logger.errorUnpin(i,`cId:${e}, unpin topic fail`,mI(t,Object(Jb.b)())),a(t.error)}))}))}))}setPendingQueue(e,t){t&&!this.pendingWhenLoadQueue[e]?this.pendingWhenLoadQueue[e]=LI():delete this.pendingWhenLoadQueue[e]}isInPending(e){return!!this.pendingWhenLoadQueue[e]}openPendingQueue(e){this.setPendingQueue(e,!0)}closePendingQueue(e){this.setPendingQueue(e,!1)}enqueuePending(e,t){this.pendingWhenLoadQueue[e]&&this.pendingWhenLoadQueue[e].enqueue(t)}loadTopicsFromDB(e){this.openPendingQueue(e);return new Promise((t=>{const s=this.getRequestID();this.Logger.infoLoad(s,`DB call cId:${e}`),this.Storage.loadTopics(e).then((a=>{const i=this.handleLoadDBFinish(e,a);this.Logger.infoLoad(s,`DB cId:${e} success`),t({status:oI.h.SUCCESS,response:{data:i}})})).catch((a=>{const i=this.handleLoadDBFinish(e,null);this.Logger.errorLoad(s,`DB cId:${e} fail`,mI(null==a?void 0:a.error,Object(Jb.b)())),t({status:oI.h.ERROR,response:{data:i}})}))}))}getRequestID(){return this.requestID.next()}handleLoadDBFinish(e,t){var s;let a;var i;t&&(a={conversationId:(i=t).conversationId,topics:i.topics,version:i.boardVersion,lastFetch:i.lastFetch,lastModified:Date.now()}),t&&(null===(s=a)||void 0===s?void 0:s.conversationId)===e||(a=function(e){return{conversationId:e,topics:[],version:0,lastFetch:0,lastModified:0}}(e));let n=a;if(!nI(n).needFetch&&this.isInPending(e)){const t=e=>{e&&(n=e)};this.pendingWhenLoadQueue[e].dequeue(a,t)}return this.closePendingQueue(e),n}fetchTopics(e,t=0){this.openPendingQueue(e);return new Promise(((s,a)=>{const i=this.getRequestID();this.Logger.infoFetch(i,`call cId:${e}`,t),this.Fetcher.fetchTopics(e,t).then((t=>{this.Logger.infoFetch(i,`cId:${e} success`),this.closePendingQueue(e);const{response:a}=t,n=a.data.topics;for(let e=0;e<n.length;e++)n[e]=hI(n[e]);this.loadExtraDataForTopics(n).then((t=>{const i={conversationId:e,topics:t,version:a.data.version,lastFetch:Date.now(),lastModified:Date.now()};this.setToCache(e,i),this.setTopicsToDB(i),s(i)}))})).catch((t=>{this.Logger.errorFetch(i,`cId:${e} fail`,mI(t,Object(Jb.b)())),this.closePendingQueue(e)}))}))}doCheckAndFetchData(e){return new Promise(((t,s)=>{const a=nI(e);if(this.Logger.infoFetch(`cId:${e.conversationId} needFetch:${a.needFetch} reason:${a.reason}`),!a.needFetch)return t(e);this.fetchTopics(e.conversationId).then((s=>{t(s||e)})).catch(s)}))}getDataInPendingQueueAfterMutation(e,t){if(e.conversationId!==t.conversationId)return t;if(e.oldVersion!=t.version)return t;return{topics:dI(e.type,t.topics,{index:e.index,topics:e.topics}),version:e.version,conversationId:e.conversationId,lastModified:Date.now(),lastFetch:t.lastFetch}}setToCache(e,t){return null==t.lastModified&&(t.lastModified=Date.now()),this.cache.set(e,t),t}addToCache(e,t,s=0){const a=this.getCache(e),{topic:i,version:n}=t;let r=Date.now(),o=[];a?(o=dI(oI.a.ADD,a.topics,{topics:[i],index:s}),r=a.lastFetch):o.push(i),t.lastFetch&&(r=t.lastFetch);const c={conversationId:e,topics:o,version:n,lastModified:Date.now(),lastFetch:r};return this.setToCache(e,c)}removeInCache(e,t,s=0){if(!this.cache.has(e))return null;const a=this.getCache(e),{topics:i}=a;if(t.topic)for(let r=0;r<i.length;r++){const e=i[r];if(e.id===t.topic.id&&e.type===t.topic.type){i.splice(r,1);break}}else i.splice(s,1);const n={conversationId:e,topics:i,version:t.version,lastModified:Date.now(),lastFetch:a.lastFetch};return this.setToCache(e,n)}enqueueEvent(e,t){if(!this.eventQueue[e]){const t=()=>{delete this.eventQueue[e]};this.eventQueue[e]=wI(t)}this.eventQueue[e].enqueue(t)}addTopic(e,t,s){return new Promise(((a,i)=>{if(this.isInPending(e)){const s={data:{type:oI.a.ADD,conversationId:e,oldTopic:t.oldTopic,topics:[t.topic],version:t.version,oldVersion:t.oldVersion,index:t.index},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),a()}const n=i=>{const{oldVersion:n,version:r}=t,o=iI(n,r,i.version);if(this.Logger.infoCreate(`add call cId:${e} actCode:${o}`,n,r,i.version),1===o){const{oldTopic:i,index:n,topic:o}=t;i&&i.topicId&&this.removeInCache(e,{topic:{id:i.topicId,type:i.topicType},version:r}),hI(o),this.loadExtraDataForTopics([o]).then((i=>{const r={topic:i[0],version:t.version},o=this.addToCache(e,r,n);this.setTopicsToDB(o),a(),s&&s(this.getCache(e))})).catch((()=>{a()}))}else 0===o?this.fetchTopics(e).then((e=>{s&&s(e),a()})).catch((()=>{s&&s(this.getCache(e)),a()})):a()};this.loadDataFromCacheOrDB(e).then((e=>{n(e)}))}))}removeTopics(e,t,s){return new Promise((a=>{if(this.isInPending(e)){const s={data:{type:oI.a.REMOVE,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),a()}const i=i=>{const{oldVersion:n,version:r}=t,o=iI(n,r,i.version);if(this.Logger.infoUnpin(`remove call cId:${e} actCode:${o}`,n,r,i.version),1===o){const{topics:n}=t;let o=i;for(let t=0;t<n.length;t++)o=this.removeInCache(e,{topic:n[t],version:r});return this.setTopicsToDB(o),s&&s(this.getCache(e)),a()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),a()})).catch((()=>{s&&s(this.getCache(e)),a()})):a()};this.loadDataFromCacheOrDB(e).then((e=>{i(e)}))}))}setTopics(e,t,s){return new Promise((a=>{if(this.isInPending(e)){const s={data:{type:oI.a.REORDER,conversationId:e,topics:t.topics,version:t.version,oldVersion:t.oldVersion},callback:this.getDataInPendingQueueAfterMutation};return this.enqueuePending(e,s),a()}const i=i=>{const{oldVersion:n,version:r}=t,o=iI(n,r,i.version);if(this.Logger.infoReorder(`set call cId:${e} actCode:${o}`,n,r,i.version),1===o){const n=i.topics,r=[];for(let e=0;e<t.topics.length;e++){const s=t.topics[e],a=n.find((e=>e.id===s.id&&e.type===s.type));a&&r.push(a)}const o={conversationId:e,topics:r,version:t.version,lastModified:Date.now(),lastFetch:(null==i?void 0:i.lastFetch)||0};return this.setToCache(e,o),this.setTopicsToDB(o),s&&s(this.getCache(e)),a()}0===o?this.fetchTopics(e).then((e=>{s&&s(e),a()})).catch((()=>{s&&s(this.getCache(e)),a()})):a()};this.loadDataFromCacheOrDB(e).then((e=>{i(e)}))}))}loadDataFromCacheOrDB(e){return new Promise((t=>{const s=this.getCache(e);s?t(s):this.loadTopicsFromDB(e).then((s=>{const a=s.response.data;this.setToCache(e,a),t(a)}))}))}setTopicsToDB(e){return new Promise(((t,s)=>{const a={conversationId:e.conversationId,boardVersion:e.version,topics:e.topics,lastFetch:e.lastFetch};this.Storage.setTopics(a).then(t).catch(s)}))}processEventControl(e,t,s,a,i){const{conversationId:n}=t;let r={oldVersion:t.oldVersion,version:t.version};const o=uI(t);switch(e){case oI.c.CREATE:r=Object(I.a)(Object(I.a)({},r),{},{oldTopic:o.oldTopic,topic:o.topic,index:0}),this.enqueueEvent(n,this.addTopic.bind(this,n,r,(e=>a(e))));break;case oI.c.UNPIN:{const e=o.topic,t=[];e&&null!=e.topicId&&null!=e.topicType&&t.push({id:e.topicId,type:e.topicType}),r=Object(I.a)(Object(I.a)({},r),{},{topics:t}),this.enqueueEvent(n,this.removeTopics.bind(this,n,r,(e=>a(e))));break}case oI.c.REORDER:{var c;const e=[],t=(null===(c=o.topics)||void 0===c?void 0:c.length)||0;for(let a=0;a<t;a++){var l;const t=null===(l=o.topics)||void 0===l?void 0:l[a];if(t&&null!=t.topicId&&null!=t.topicType){const a=s.topics.find((e=>e.id===t.topicId&&e.type===t.topicType));a&&e.push(a)}}r=Object(I.a)(Object(I.a)({},r),{},{topics:e}),this.enqueueEvent(n,this.setTopics.bind(this,n,r,(e=>a(e))));break}}}loadStickerThumb(e){const t=e=>`${e.id}_${e.type}`;return new Promise((s=>{const a={};for(let o=0;o<e.length;o++){var i,n;const s=e[o];if((null===(i=s.params)||void 0===i?void 0:i.msg_type)===Y.MSG_STICKER||(null===(n=s.params)||void 0===n?void 0:n.msg_type)===Y.CLI_MSG_TYPE_STICKER){var r;const e=null===(r=s.params)||void 0===r?void 0:r.extra;e&&null!=e.catId&&null!=e.id&&(a[t(s)]=this.StickerManager.getStickerIfNotExist(e.catId,e.id))}}Object.keys(a).length>0?gI(a).then((a=>{for(let s=0;s<e.length;s++){const i=e[s],n=a[t(i)];n&&n.id===parseInt(i.params.extra.id)&&n.cateId===parseInt(i.params.extra.catId)&&(i.params.thumb=n.stickerUrl||"",e[s]=i)}s(e)})):s(e)}))}loadExtraDataForTopics(e){return new Promise((t=>{this.loadStickerThumb(e).then((e=>{t(e)}))}))}getCache(e){return this.cache.get(e)}get Fetcher(){return this.fetcher}get Logger(){return this.logger}get StickerManager(){return TI.g}get Storage(){return this.storage}})||kI)||kI)||kI)||kI)||kI;a.ModuleContainer.register(Xb,PI);var jI=class{createOneOnOneTopic(e="",t,s=0,a="vi"){let i={conversationId:e,topic:t,version:s,lang:a};ui.default.logCoreInfo("[PinTopic] - createOneOnOneTopic params: ",i);const n=H.b.getFriendBoardDomain()+"/api/friendboard/create?"+this.getCommonParams()+"&params="+this.getEncodedParams(i);return this.getRequest(n,null,12067)}getListOneOnOnePinTopics(e="",t=0){let s={conversationId:e,version:t};ui.default.logCoreInfo("[PinTopic] - getListOneOnOnePinTopics params: ",s);const a=H.b.getFriendBoardDomain()+"/api/friendboard/list?"+So.default._getCommonParams()+"&params="+this.getEncodedParams(s);return this.getRequest(a,null,12065)}reorderOneOnOnePinTopics(e="",t,s=0,a="vi"){let i={conversationId:e,topics:t,version:s,lang:a};ui.default.logCoreInfo("[PinTopic] - reorderOneOnOnePinTopics params: ",i);const n=H.b.getFriendBoardDomain()+"/api/friendboard/reorder?"+this.getCommonParams()+"&params="+this.getEncodedParams(i);return this.getRequest(n,null,12068)}unpinOneOnOneTopics(e="",t,s=0,a="vi"){let i={conversationId:e,topics:t,version:s,lang:a};ui.default.logCoreInfo("[PinTopic] - unpinOneOnOneTopics params: ",i);const n=H.b.getFriendBoardDomain()+"/api/friendboard/multi_unpin?"+this.getCommonParams()+"&params="+this.getEncodedParams(i);return this.getRequest(n,null,12069)}getCommonParams(){return So.default._getCommonParams()}getEncodedParams(e){return So.default.getEncodedParams(e)}getRequest(e,t,s,a,i,n,r,o,c){return So.default._get(e,t,s,a,i,n,r,o,c)}};var UI=function(){let e;function t(){return e||(e=new jI),e}const s=e=>new Promise(((t,s)=>{e.then(Co.a).then(t).catch(s)}));return{createOneOnOneTopic:(e,a,i=0)=>{const n=Object(I.a)({},a),{params:r}=n;r&&r.extra&&r.extra.constructor===Object&&(r.extra=JSON.stringify(r.extra)),r&&(n.params=JSON.stringify(r)),null==n.src&&(n.src=-1),null==n.pinAct&&(n.pinAct=1);const o=ce.a.getCurrentLanguageName();return s(t().createOneOnOneTopic(e,n,i,o))},getListOneOnOnePinTopics:(e,a=0)=>s(t().getListOneOnOnePinTopics(e,a)),reorderOneOnOnePinTopics:(e,a,i=0)=>{const n=ce.a.getCurrentLanguageName();return s(t().reorderOneOnOnePinTopics(e,a,i,n))},unpinOneOnOneTopics:(e,a,i=0)=>{const n=ce.a.getCurrentLanguageName();return s(t().unpinOneOnOneTopics(e,a,i,n))}}},BI=function(e){return e.CREATE="create",e.FETCH="fetch",e.REORDER="reorder",e.UNPIN="unpin",e}(BI||{});var zI=class extends fI{constructor(){super(oI.f.Network,[BI.CREATE,BI.FETCH,BI.REORDER,BI.UNPIN])}infoCreate(...e){this.logInfo(BI.CREATE,...e)}infoFetch(...e){this.logInfo(BI.FETCH,...e)}infoReorder(...e){this.logInfo(BI.REORDER,...e)}infoUnpin(...e){this.logInfo(BI.UNPIN,...e)}errorCreate(...e){this.logError(BI.CREATE,...e)}errorFetch(...e){this.logError(BI.FETCH,...e)}errorReorder(...e){this.logError(BI.REORDER,...e)}errorUnpin(...e){this.logError(BI.UNPIN,...e)}logInfo(e,...t){this.isEnableLog()&&super.info(e,...t)}logError(e,...t){this.isEnableLog()&&super.error(e,...t)}isEnableLog(){return Object(Jb.i)()}};var GI,xI=class{constructor(){this.apiClient=void 0,this.logger=void 0,this.requestID=void 0,this.apiClient=UI(),this.logger=new zI,this.requestID=new De.a}async fetchTopics(e,t=0){const s=this.getRequestId();this.Logger.infoFetch(s,`call cId:${e}`,t);try{const a=await this.apiClient.getListOneOnOnePinTopics(e,t);return this.Logger.infoFetch(s,`cId:${e} success`,a.version),{status:oI.h.SUCCESS,response:{data:{topics:a.data,version:a.version}}}}catch(a){return this.Logger.errorFetch(s,`cId:${e} fail`,mI(a,Object(Jb.d)())),Promise.reject({status:oI.h.ERROR,error:{code:a.code||a.error_code,message:a.error_message}})}}async createTopic(e,t,s=0){const a=this.getRequestId();this.Logger.infoCreate(a,`call cId:${e}`,s);try{const i=await this.apiClient.createOneOnOneTopic(e,t,s);return this.Logger.infoCreate(a,`cId:${e} success`,i.version),{status:oI.h.SUCCESS,response:{data:{topic:i.data,version:i.version}}}}catch(i){return this.Logger.errorCreate(a,`cId:${e} fail`,mI(i,Object(Jb.d)())),Promise.reject({status:oI.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}async unpinTopics(e,t,s=0){const a=this.getRequestId();this.Logger.infoUnpin(a,`call cId:${e}`,s);try{const i=await this.apiClient.unpinOneOnOneTopics(e,t,s);return this.Logger.infoUnpin(a,`cId:${e} success`,i.version),{status:oI.h.SUCCESS,response:{data:i}}}catch(i){return this.Logger.errorUnpin(a,`cId:${e} fail`,mI(i,Object(Jb.d)())),Promise.reject({status:oI.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}async reorderTopics(e,t,s=0){const a=this.getRequestId();this.Logger.infoReorder(a,`call cId:${e}`,s);try{const i=await this.apiClient.reorderOneOnOnePinTopics(e,t,s);return this.Logger.infoReorder(a,`cId:${e} success`,i.version),{status:oI.h.SUCCESS,response:{data:i}}}catch(i){return this.Logger.errorUnpin(a,`cId:${e} fail`,mI(i,Object(Jb.d)())),Promise.reject({status:oI.h.ERROR,error:{code:i.code||i.error_code,message:i.error_message}})}}getRequestId(){return this.requestID.next()}get Logger(){return this.logger}};a.ModuleContainer.register(AI,xI);var VI=Object(a.singleton)(SI)(GI=class{constructor(){this._storage=void 0}async clearTopics(e,t=!1){try{let s;if(t)s=this.storage.removeConversationTopics(e);else{const t={conversationId:e,topics:[]},a=["topics"];s=this.storage.updateGroupTopic(t,a)}return await s,e}catch(s){return Promise.reject(s)}}async loadTopics(e){try{return(await this.loadTopicsFromDB(e)).response.data}catch(t){return Promise.reject(t)}}async setTopics(e){try{return await this.setTopicsToDB(e)}catch(t){return Promise.reject(t)}}getEntryPointPromotionalTooltipShowedStatus(){const e=n.default.getInstance().getItemForCurrentUser(oI.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED);if(null===e)return null;try{return JSON.parse(e)}catch(t){return!1}}async getMessagesByIds(e,t){try{const s=await this.storage.getMessagesByIds(e,t);let a;t&&t.length>0&&(a=t[0]);let i=null;return a&&(i=s[a]),i||Promise.reject("Not found")}catch(s){return Promise.reject(s)}}async getMessageByCliMsgId(e,t,s={}){try{const{myUID:a,userId:i}=s;if(i){let s=i;a==i&&(s="0");const n=await this.storage.getMessageByCliMsgIdOwnerId(e,t,s);return n||Promise.reject("Not found")}const n=await this.storage.getMessageByCliMsgId(t,e);if(!n||!n.length)return Promise.reject("Not found");n.length;const r=n&&n[0];return r||Promise.reject("Not found")}catch(a){return Promise.reject(a)}}setEntryPointPromotionalTooltipShowedStatus(e){n.default.getInstance().setItemForCurrentUser(oI.e.ONE_ON_ONE_ENTRY_POINT_PROMOTIONAL_TOOLTIP_SHOWED,JSON.stringify(e))}setForcedFetchMilestone(e){n.default.getInstance().setItemForCurrentUser(oI.e.FORCE_FETCH_MILESTONE,e.toString())}async loadTopicsFromDB(e){try{const t=await this.storage.getGroupTopic(e);return{status:oI.h.SUCCESS,response:{data:t}}}catch(t){return Promise.reject({status:oI.h.ERROR,error:{code:null==t?void 0:t.code,message:(null==t?void 0:t.message)||(null==t?void 0:t.error_message),data:t}})}}async setTopicsToDB(e){return await this.storage.setGroupTopic(e)}get storage(){return this._storage||(this._storage=s("XS0u").default),this._storage}})||GI;a.ModuleContainer.register(CI,VI);var HI=s("RF0b"),WI=s("z7jJ"),qI=s("3ZsK"),KI=s("oEIH");function ZI(e,t,s,a=Ar.c){let i;switch(t){case"error":i=be.TOAST_TYPE.ERROR;break;case"info":default:i=be.TOAST_TYPE.INFO;break;case"success":i=be.TOAST_TYPE.SUCCESS;break;case"warning":i=be.TOAST_TYPE.WARNING}be.ZToastManagerHolder.getZToastManagerByWindowId(a).show({duration:s,noBackground:!0,textKey:e,type:i})}var $I={error:function(e,t,s){ZI(e,"error",null!=s?s:3e3,t)},info:function(e,t,s){ZI(e,"info",null!=s?s:3e3,t)},success:function(e,t,s){ZI(e,"success",null!=s?s:3e3,t)},warning:function(e,t,s){ZI(e,"warning",null!=s?s:3e3,t)}},QI=s("AyM1"),YI=s("3Ewa");var JI,XI=class{constructor(e,t){this.conversationId=e,this.windowId=t,this.dispatch=null,this.events={},this.topics=[],this.toDispatch=e=>{"function"==typeof this.dispatch&&this.dispatch(Object(I.a)({windowId:this.windowID},e))}}addEventListener(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}cancelLimitationModal(e){Object(sI.d)(this.conversationID)||(e===Yb.f.CONFIRM?KI.a.logAction(KI.a.OneOnOne.LimitationModal.CLOSE_MODAL):e===Yb.f.MULTI_UNPIN&&KI.a.logAction(KI.a.OneOnOne.LimitationMultipleUnpinModal.CLOSE_MODAL))}cancelUnpinModal(){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.CLOSE_UNPIN_MODAL)}cleanUp(){this.events={},this.setDispatch(null)}clickCancelOnLimitationModal(e){Object(sI.d)(this.conversationID)||(e===Yb.f.CONFIRM?KI.a.logAction(KI.a.OneOnOne.LimitationModal.CLICK_CANCEL):e===Yb.f.MULTI_UNPIN&&KI.a.logAction(KI.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_CANCEL))}clickCancelUnpinTopic(){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.CLICK_NOT_UNPIN_FROM_MODAL)}clickConfirmOnLimitationModal(e,t,s){if(Object(sI.d)(this.conversationID)||(s===Yb.f.CONFIRM?KI.a.logAction(KI.a.OneOnOne.LimitationModal.CLICK_CONFIRM):s===Yb.f.MULTI_UNPIN&&KI.a.logAction(KI.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_CONFIRM)),Array.isArray(e)&&e.length>0)this.unpinTopics(e).then((()=>{if(Array.isArray(t)&&t.length>0){const e=t[0];this.createPinTopic(e).then((()=>{this.getMessageFromTopic(this.getConversationID(),e).then((e=>{if(e){const t=Object(tI.a)(e,Yb.b.UNPIN_MODAL);KI.a.locActionDetails(t)}}))}))}}));else if(Array.isArray(t)&&t.length>0){const e=t[0];this.createPinTopic(e).then((()=>{this.getMessageFromTopic(this.getConversationID(),e).then((e=>{if(e){const t=Object(tI.a)(e,Yb.b.UNPIN_MODAL);KI.a.locActionDetails(t)}}))}))}}clickConfirmUnpinTopic(e){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.CLICK_UNPIN_FROM_MODAL),this.unpinTopic(e)}clickCopyTopic(e){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.CLICK_COPY),this.copyTopic(e)}clickTopic(e){switch(Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.LEFT_CLICK),e.type){case Y.TEXT_TOPIC:case Y.LINK_TOPIC:break;case Y.MSG_TOPIC:this.jumpToMessage(this.conversationID,e,this.toDispatch);case Y.POLL_TOPIC:case Y.REMINDER_TOPIC:}}clickRaiseTopic(e){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.CLICK_PUSH_TO_TOP),this.raiseTopic(e)}clickShowMoreIcon(){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.CLICK_THREE_DOT)}clickSwitchToMultipleUnpinTopicsMode(){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.LimitationModal.CLICK_CHANGE_OPTION)}clickTopicToSelectForUnpin(e){Object(sI.d)(this.conversationID)||e&&KI.a.logAction(KI.a.OneOnOne.LimitationMultipleUnpinModal.CLICK_TOPIC_TO_SELECT_FOR_UNPIN)}clickUnpinTopic(e){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.CLICK_UNPIN),this.showUnpinTopicModal(e)}collapseBoard(e){const t=Object(sI.d)(this.conversationID);switch(e){case Yb.a.BUTTON_CLICKED:t||KI.a.logAction(KI.a.OneOnOne.Board.COLLAPSE_BY_CLICK_BUTTON);break;case Yb.a.BY_ESC:t||KI.a.logAction(KI.a.OneOnOne.Board.COLLAPSE_BY_ESC);break;case Yb.a.OUTSIDE_CLICKED:t||KI.a.logAction(KI.a.OneOnOne.Board.COLLAPSE_BY_CLICK_OUTSIDE)}}copyTopic(e){if(!e)return;let t="";const s=e.params;switch(e.type){case Y.MSG_TOPIC:s&&(t=s.title);break;case Y.LINK_TOPIC:case Y.TEXT_TOPIC:s&&(s.linkCaption?t=s.linkCaption:s.title&&(t=s.title))}t.length>0?ui.default.copyTextToClipboard(t):$I.error(ce.a.str("STR_ERROR_UNKNOWN"),this.windowId)}createPinTopic(e){return Yb.j.GetManager().createPinTopic(this.conversationId,e).catch((e=>{if(e.code===Yb.c.FULL_THREAD_PIN_TOPIC&&!e.message){const t=Ii.default.getDName(this.conversationID);if(t)return mc.default.createError(ce.a.trans("STR_PIN_FRIEND_REACH_PIN_LIMIT",[t]),5e3),Promise.reject(e)}return e.message&&$I.error(ce.a.str(e.message),this.windowId),Promise.reject(e)}))}createPinTopicFromMessage(e,t=Yb.b.UNKNOWN){var s;let i=null===(s=Ce.default.settings.group.topic_colors)||void 0===s?void 0:s[0],n=Y.MSG_TOPIC;const r=Object(I.a)({},e);let o=r.fromUid;if(!o||"0"===o){const e=a.ModuleContainer.resolve(m.a);var c;if(e)o=null===(c=e.getSession())||void 0===c?void 0:c.userId}const l=ui.default.getUnicodeCorrMSGType(r);let d={client_msg_id:r.cliMsgId,global_msg_id:r.msgId,senderUid:o,senderName:r.dName||""};switch(r.msgType){case Y.MSG_CONTACT:switch(r.message.action){case"recommened.link":case"recommened.user":case"recommened.stickerset":case"recommened.vip":if(d.href=r.message.href,d.thumb=r.message.thumb,d.title=r.message.title,d.linkCaption=r.message.title,"recommened.link"===r.message.action&&r.message.params){let e=JSON.parse(r.message.params);!d.title&&e&&e.mediaTitle&&(d.title=e.mediaTitle),d.redirect_url=e.redirect_url?e.redirect_url:"",d.streamUrl=e.streamUrl?e.streamUrl:"",d.artist=e.artist?e.artist:"",d.stream_icon=e.stream_icon?e.stream_icon:"",d.type=e.type?e.type:""}}d.extra={action:r.message.action},"recommened.user"===r.message.action?d.extra.dpn=d.title:"recommened.link"===r.message.action&&r.message.params&&(d.extra.params=r.message.params),d.msg_type=Y.CLI_MSG_TYPE_CONTACT;break;case Y.MSG_TEXT:"string"==typeof r.message?d.title=r.message:r.message&&r.message.title&&(d.title=r.message.title),d.msg_type=Y.CLI_MSG_TYPE_TEXT;break;case Y.MSG_DOODLE:d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.title=r.message.title,d.msg_type=Y.CLI_MSG_TYPE_DOODLE;break;case Y.MSG_PHOTO:{let e=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl;const t=Object(rf.d)(e),s=Object(rf.g)(e);if(s&&(t||zp.a.jxl.enable_pin_jxl?e=Object(rf.k)(e):(e=Object(rf.o)(e),d.convertible="jxl")),d.thumb=e,d.title=r.message.title,d.msg_type=Y.CLI_MSG_TYPE_PHOTO,r.properties&&r.properties.type===Y.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER){const e={msgBubbleLayoutType:Y.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER,pStickerType:0},a=r.message.params;if(a){let i=null;if("string"==typeof a)try{i=JSON.parse(a)}catch(p){ui.default.logCoreError("Try to parse params has failed",p)}else a.webp&&(i=a);var u,h;if(i)s&&(t||zp.a.jxl.enable_pin_jxl?i=Object(rf.l)(i):(i=Object(rf.m)(i),d.convertible="jxl")),e.webpUrl=(null===(u=i.webp)||void 0===u?void 0:u.url)||"",e.subType=1,e.pStickerType=null!==(h=i.pStickerType)&&void 0!==h?h:0}d.extra=e}break}case Y.MSG_FILE:d.title=r.message.title,d.extra=r.message.params,d.msg_type=Y.CLI_MSG_TYPE_FILE;break;case Y.MSG_GIF:d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.msg_type=Y.CLI_MSG_TYPE_GIF;break;case Y.MSG_STICKER:d.extra=r.message,d.msg_type=Y.CLI_MSG_TYPE_STICKER;break;case Y.MSG_VOICE:d.msg_type=Y.CLI_MSG_TYPE_VOICE;break;case Y.MSG_LOCATION:d.msg_type=Y.CLI_MSG_TYPE_LOCATION,d.title=r.message.desc;break;case Y.MSG_VIDEO:d.msg_type=Y.CLI_MSG_TYPE_VIDEO,d.thumb=r.message.thumbUrl||r.message.normalUrl||r.message.oriUrl,d.title=r.message.title;break;case Y.MSG_UNDO:return void mc.default.createWarning(ce.a.str("STR_TOAST_UNDO_MESSAGE"));case Y.MSG_POLL:{let e=null;if(e){let t=e.pollData;t&&(d.title=t.question)}n=Y.POLL_TOPIC;break}case Y.MSG_ZINSTANT_OLD:case Y.MSG_ZINSTANT:{const e=QI.default.getZInstantData(r);d.msg_type=Y.MSG_ZINSTANT,e&&e.customMsg&&(d.extra=Object(I.a)({},e.customMsg));break}default:d.msg_type=r.msgType}const g={color:i,duration:-1,emoji:l,params:d,repeat:0,startTime:-1,type:n};this.createPinTopic(g).then((()=>{const s=Object(tI.a)(e,t);KI.a.locActionDetails(s)}))}editTopic(e,t){}expandBoard(){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Board.EXPAND_BOARD),this.fetchTopics()}fetchTopics(e){let t=e;null==t&&(t=this.conversationID),Yb.j.GetManager().loadPinTopics(t,!0).then((e=>{this.onUpdateTopics(t,e.topics)}))}getConversationID(){return this.conversationID}getTopics(){return this.topics}openBoard(e){}openPinLimitModal(e,t){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.LimitationModal.DISPLAY_MODAL),Ie.ModalManagerV2.openModal({windowId:this.windowID,name:Y.ModalIdentitiesDefine.PIN_LIMIT_MODAL,params:{conversationID:this.conversationID,limitNumber:3,currentTopics:e,pinTopic:t}})}raiseTopic(e){let t=this.topics.slice();const s=t.findIndex((t=>t.id===e.id&&t.type===e.type));s>-1&&(t.splice(s,1),t.unshift(e),Yb.j.GetManager().reorderPinTopics(this.conversationID,t).catch((e=>{e.message&&$I.error(ce.a.str(e.message),this.windowId)})))}removeEventListener(e,t){const s=this.events[e];if(!s)return;const a=(s||[]).length;for(let i=0;i<a;i++)if(s[i]===t){s.splice(i,1);break}0===s.length&&delete this.events[e]}rightClick(){Object(sI.d)(this.conversationID)||KI.a.logAction(KI.a.OneOnOne.Content.RIGHT_CLICK)}setDispatch(e){this.dispatch=e}showContextMenu(){}showUnpinTopicModal(e){Ie.ModalManagerV2.openModal({windowId:this.windowID,name:Y.ModalIdentitiesDefine.UNPIN_MODAL,params:{conversationID:this.conversationID,unpinTopic:e}})}unpinTopic(e){return this.unpinTopics([e])}unpinTopics(e){return Yb.j.GetManager().unpinPinTopics(this.conversationID,e).catch((e=>(e.message&&$I.error(ce.a.str(e.message),this.windowId),Promise.reject(e))))}updateConversation(e){this.conversationID!==e&&Yb.j.GetManager().loadPinTopics(e).then((t=>{this.onUpdateTopics(e,t.topics)}))}updateTopics(e){this.onUpdateTopics(this.conversationID,e)}async getMessageFromTopic(e,t){var s;const a=t.params.global_msg_id,i=t.params.client_msg_id,n=t.params.senderUid;return null===(s=lo.b.messageCache)||void 0===s?void 0:s.getMessageAsync(a,e,i,n)}jumpToMessage(e,t,s){let i,n="0",r="0";t.params.global_msg_id&&(n=t.params.global_msg_id),t.params.client_msg_id&&(r=t.params.client_msg_id),null!=t.params.senderUid&&(i=t.params.senderUid),"0"===n&&(n=0);try{const e=YI.a.Tracking.getInstance();e.reset().getBuilder().setEntryPoint(YI.a.EntryPoint.PINNED_MESSAGE),e.track(n)}catch(o){}ho.default.jumpToMessage({msgId:n,cliMsgId:r,fromUid:i},e,s).catch((()=>{if(t&&t.params){var s;const i={allowDelete:!1,allowEdit:!1,allowPin:!1},n=null===(s=a.ModuleContainer.resolve(Tg.a))||void 0===s?void 0:s.getWindowIdFromConvId(e);if(!n)return;Ie.ModalManagerV2.openModal({windowId:n,name:Y.ModalIdentitiesDefine.VIEW_NOTICE,params:{viewNoticeMsgAction:Y.VIEW_NOTICE_MSG_ACTION.PIN_MSG,payload:t.params,setting:i}})}else $I.success(ce.a.str("STR_MESSAGE_NOT_FOUND"),this.windowId);Object(qI.e)(qI.a.JT_PIN_MSG_NOT_AT_LOCAL)}))}notifyEvent(e,...t){const s=this.events[e],a=(this.events[e]||[]).length;for(let i=0;i<a;i++)"function"==typeof s[i]&&s[i](...t)}onUpdateTopics(e,t){this.conversationID===e&&(this.setTopics(t),this.notifyEvent("onchange",t))}setTopics(e){this.topics=e}get conversationID(){return this.conversationId}get windowID(){return this.windowId}},ey=s("JOr/");Object(a.singleton)(ey.a)(JI=cu()(JI=ou()(JI=Reflect.metadata("design:type",Function)(JI=Reflect.metadata("design:paramtypes",[])(JI=class{constructor(){this._activeConversationInfoList=void 0,this._controllersMap=new Map,this.isDisplayedOneOnOneEPPromotionalTooltip=void 0,this.isRegisteredEvents=!1,this.modalControllers={},this._activeConversationInfoList=a.ModuleContainer.resolve(Zb),this.onChangeData=this.onChangeData.bind(this),this.onExceed=this.onExceed.bind(this)}activateConversation(e,t){const s=this.getToken(e,t);if(!this.isActivatedController(s)){const a=new XI(e,t);this.registerController(s,a),this._activeConversationInfoList.activateConversation(e,t)}}deactivateConversation(e,t){const s=this.getToken(e,t);if(this.isActivatedController(s)){const a=this.controllersMap.get(s);a&&a.cleanUp(),this.unregisterController(s),this._activeConversationInfoList.deactivateConversation(e,t)}}displayOneOnOneEntryPointPromotionalTooltip(){this.isDisplayedOneOnOneEPPromotionalTooltip||(this.isDisplayedOneOnOneEPPromotionalTooltip=!0,Yb.j.GetManager().displayOneOnOneEntryPointPromotionalTooltip())}isDisplayedOneOnOneEntryPointPromotionalTooltip(){return void 0!==this.isDisplayedOneOnOneEPPromotionalTooltip?this.isDisplayedOneOnOneEPPromotionalTooltip:this.isDisplayedOneOnOneEPPromotionalTooltip=Yb.j.GetManager().isDisplayedOneOnOneEntryPointPromotionalTooltip()}loadAndRegisterToDisplayBanner(e){Yb.j.GetManager().loadPinTopics(e).then((t=>{t&&t.conversationId===e&&t.topics&&t.topics.length>0&&this.onChangeData(e,t.topics)})).catch((()=>{}))}onConversationDidClose(e){this.deactivateConversation(e.conversationID,e.windowID)}onConversationWillOpen(e){this.activateConversation(e.conversationID,e.windowID)}getController(e,t){const s=this.getToken(e,t);return this.controllersMap.get(s)}registerController(e,t){this.registerEventListeners(),this.controllersMap.set(e,t)}unregisterController(e){this.controllersMap.delete(e),this.unregisterEventListeners()}getModalController(e){return this.modalControllers[e]}registerModalController(e,t){this.modalControllers[e]=t}unregisterModalController(e){delete this.modalControllers[e]}registerEventListeners(){this.isRegisteredEvents||(this.isRegisteredEvents=!0,Yb.j.GetManager().addEventListener("onchange",this.onChangeData),Yb.j.GetManager().addEventListener("onexceed",this.onExceed))}unregisterEventListeners(){this.isRegisteredEvents&&0===this.controllersMap.size&&(this.isRegisteredEvents=!1,Yb.j.GetManager().removeEventListener("onchange",this.onChangeData),Yb.j.GetManager().removeEventListener("onexceed",this.onExceed))}getActiveControllers(){return Array.from(this.controllersMap.values())}getToken(e,t){return t+"_"+e}isActivatedController(e){return this.controllersMap.has(e)}onChangeData(e,t){var s;const a=this.getActiveControllers();a.length>0&&a.forEach((s=>{s&&s.getConversationID()===e&&s.updateTopics(t.slice())}));const i=null===(s=this.activeConversationInfoList.getActiveConversationInfo(e))||void 0===s?void 0:s.windowIds;Array.isArray(i)&&i.forEach((s=>{this.isActivatedController(this.getToken(e,s))&&(t&&t.length>0?this.requestShowBanner(e,s):this.requestHideBanner(e,s))}))}onExceed(e,t,s){const a=this.getActiveControllers();a.length>0&&a.forEach((a=>{a&&a.getConversationID()===e&&a.openPinLimitModal(t.slice(),Object(I.a)({},s))}))}requestShowBanner(e,t){if(!this.isActivatedController(this.getToken(e,t)))return;this.ChatBoxBannerModule.ChatBoxBannerManager().isBannerDisplaying(HI.a.PIN_TOPIC_BANNER,e)||this.ChatBoxBannerModule.ChatBoxBannerManager().requestShowBanner(HI.a.PIN_TOPIC_BANNER,{convId:e})}requestHideBanner(e,t){if(!this.isActivatedController(this.getToken(e,t)))return;this.ChatBoxBannerModule.ChatBoxBannerManager().isBannerDisplaying(HI.a.PIN_TOPIC_BANNER,e)&&this.ChatBoxBannerModule.ChatBoxBannerManager().requestHideBanner(HI.a.PIN_TOPIC_BANNER,{convId:e})}get activeConversationInfoList(){return this._activeConversationInfoList}get controllersMap(){return this._controllersMap}get ChatBoxBannerModule(){return{ChatBoxBannerManager:()=>a.ModuleContainer.resolve(WI.a)}}})||JI)||JI)||JI)||JI);var ty,sy=s("CPou"),ay=s("MnxE"),iy=s("1rNO"),ny=s("NDwn");Object(xi.b)(pu.b)(ty=Reflect.metadata("design:type",Function)(ty=Reflect.metadata("design:paramtypes",[])(ty=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.onlyAdminChatSettings,[this.name])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.settings=new Map,this.me="",this._Logger=void 0,this.name=pu.a,this.key=pu.a,1===Ce.default.only_admin_chat_setting.enable_only_admin_chat_setting&&this._addPublicGroupSettingEventListener(),this._addPublicFriendEventListener(),ny.a||ay.a.signalCallback(this.onSettingsUpdate.bind(this))}_filterSettingKeys(e,t,s){let a={lockSendMsg:!1};for(let i in e)Object.keys(sy.a).includes(i)&&i===sy.a.lockSendMsg&&(a[sy.a.lockSendMsg]=!t&&!s&&Boolean(e[sy.a.lockSendMsg]));return a}_onUpdateSettings(e,t,s,a){this.me||(this.me=Ii.default.getUidMe());const i=this.me===t,n=this._filterSettingKeys(a,i,s);return this.settings.set(e,n),Object(nc.h)(this.name,e),n}showNoti(e){if("TOAST"===e.type)be.ZToastManagerHolder.getZToastManagerByWindowId(e.windowId||Ar.c).show(Object(I.a)({},e.config))}verifySetting(e){const{convId:t,field:s,showNoti:a}=e,i=this.settings.get(t);return i?(a&&a.triggerValue===i[s]&&this.showNoti(a),i&&i[s]):null}onSettingsUpdate(e,t){let s=this.settings.get(e)||{lockSendMsg:!1};for(let a in t)Object.keys(sy.a).includes(a)&&(s[a]=t[a]);this.settings.set(e,s),Object(nc.h)(this.name,e)}_addPublicGroupSettingEventListener(){yn.default.subscribeEventGroup(Y.EventGroup.CHANGE_OWNER,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),yn.default.subscribeEventGroup(Y.EventGroup.ADD_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),yn.default.subscribeEventGroup(Y.EventGroup.REMOVE_ADMIN,(e=>{const{groupId:t}=e;t&&this.onLoadGroupSetting(t)})),yn.default.subscribeEventGroup(Y.EventGroup.GROUP_INFO_CHANGED,(e=>{if(null!=e&&e.length)for(let t=0;t<e.length;t++)this.onLoadGroupSetting(e[t])})),K.default.subscribe(Ar.a.CHILD_WINDOW_ALIVE,(e=>{null!=e&&e.windowId&&this.onLoadSetting(e.windowId)})),_e.default.subscribe(((e,t)=>{switch(e){case ve.FetchActions.UPDATE_GROUP_SETTING:{var s,a;const e=null!=t&&null!==(s=t.data)&&void 0!==s&&null!==(a=s.groupId)&&void 0!==a&&a.startsWith("g")?t.data.groupId:"g"+t.data.groupId;e&&this.onLoadGroupSetting(e);break}}}))}updateFriendBLockSetting(e,t){const s=t||Ii.default.isBlocked(e),a=1===Ce.default.block_msg_call_setting.enable_block_msg_call_setting;let i=Boolean(s)&&a;if(!i&&Ii.default.isOA(e,!1)){const t=iy.a(Ii.default.getOAStatus(e));t&&t.enable&&(i=!0)}this.onSettingsUpdate(e,{[sy.a.lockSendMsg]:i})}_addPublicFriendEventListener(){Ii.default.subscribeEventFriend(Y.EventFriend.BLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!0)})),Ii.default.subscribeEventFriend(Y.EventFriend.UNBLOCK_FRIEND,(e=>{this.updateFriendBLockSetting(e.userId,!1)})),_e.default.subscribe(((e,t)=>{if(e===ve.FriendsAction.FRIENDS_CHANGE_INFO)t&&Array.isArray(t)&&t.forEach((({userId:e})=>{this.updateFriendBLockSetting(e)}))}))}_checkGroupAdmin(e){var t;return this.me||(this.me=Ii.default.getUidMe()),(null==e||null===(t=e.topMember)||void 0===t?void 0:t.filter((e=>e.id===this.me&&e.isAdmin)).length)>0}onLoadGroupSetting(e){return new Promise(((t,s)=>{yn.default.getFullInfoGroupById(e).then((s=>{if(!s)return this.Logger.zsymb(18,"GJnQas","[GroupSetting]: Load GroupInfo from manager faily "+s+", GroupId: "+e),t(null);const a=s.setting,i=s.creatorId,n=this._checkGroupAdmin(s),r=this._onUpdateSettings(e,i,n,a);a&&!a.hasOwnProperty("lockSendMsg")&&this.Logger.zsymb(18,"fO1snt","[GroupSetting]: Dont have field lockSendMsg in setting data"),t(r)})).catch((s=>{this.Logger.zsymb(18,"ldyD5j","[GroupSetting]: Have error in loadiing GroupInfo from manager: "+JSON.stringify(s)+", GroupId: "+e),t(null)}))}))}async onLoadSetting(e){return e.startsWith("g")?1!==Ce.default.only_admin_chat_setting.enable_only_admin_chat_setting?null:await this.onLoadGroupSetting(e):(this.updateFriendBLockSetting(e),ny.a?null:void ay.a.signalIfUnlock(e))}init(e){throw new Error("Method not  .")}getCurrentItem(e){return this.settings.get(e)}getItem(e,t){return this.settings.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||ty)||ty);s("daJc");var ry=s("t5n0"),oy=s("aQZC");var cy,ly=new class{constructor(){this.focusManager=void 0,this.focusStatus=void 0,this.focusService=void 0}get FSV(){return this.focusService||(this.focusService=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.appStatus,[w.ZLoggerNametags.focusDetectorManager])),this.focusService}get FM(){return this.focusManager||(this.focusManager=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.appStatus,[w.ZLoggerNametags.focusDetectorManager])),this.focusManager}get FSTT(){return this.focusStatus||(this.focusStatus=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.appStatus,[w.ZLoggerNametags.focusStatus])),this.focusStatus}};let dy=Object(a.injectable)()(cy=Object(m.f)()(cy=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(cy=Reflect.metadata("design:type",Function)(cy=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a])(cy=class extends hs.b{constructor(e){super(),this.config=e,this.detectors=void 0,this.lostFocusHandler=void 0,this.reFocusHandler=void 0,this.lastFirer=void 0,this.enableLog=void 0,this.listenDetector=(e,t)=>{t&&(this.detectors.set(e,t),this.lostFocusHandler.set(e,(()=>{this.onLostFocus(e)})),this.reFocusHandler.set(e,(()=>{this.onRefocus(e)})),t.idle(this.lostFocusHandler.get(e)),t.wakeup(this.reFocusHandler.get(e)))},this.disposeDetector=e=>{const t=this.detectors.get(e);this.enableLog&&ly.FM.zsymb(0,"cY0ari","disposeDetector",e,!!t),t&&(t.removeIdle(this.lostFocusHandler.get(e)),t.removeWakeup(this.reFocusHandler.get(e)),t.ifvisible=null,t._window=null,t.removeAllIpc(),this.lostFocusHandler.delete(e),this.reFocusHandler.delete(e),this.detectors.delete(e))},this.onLostFocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&ly.FM.zsymb(0,"slPm3D","onlostFocus",e);let t=!0,s=Number.MAX_SAFE_INTEGER,a="unknown";this.detectors.forEach((e=>{if(e.isActive())t=!1;else{const t=e.getIdleInfo();t.idleFor<s&&(s=t.idleFor,a=t.idleByTimeout?"no-action-timeout":"unknown")}})),t&&this.dispatchEvent(new ry.a(ry.b.LostFocus,{scope:"app",reason:a})),this.lastFirer=null}),200)},this.onRefocus=e=>{this.lastFirer&&(clearTimeout(this.lastFirer),this.lastFirer=null),this.lastFirer=setTimeout((()=>{this.enableLog&&ly.FM.zsymb(0,"lM9CtP","onRefocus",e),this.dispatchEvent(new ry.a(ry.b.Focus,e)),this.lastFirer=null}),200)},this.detectors=new Map,this.lostFocusHandler=new Map,this.reFocusHandler=new Map,this.enableLog=!0}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&ly.FM.zsymb(0,"vKRiR9","onAuthenticated",t),this.init()}acquire(e,t,s){if(!e||e==Ar.c)return oy.b;if(this.detectors.has(e))return ly.FM.zsymb(0,"JpIqQv","acquire exists",e),this.detectors.get(e);this.enableLog&&ly.FM.zsymb(0,"3i9jvg","acquire new",e);const a=new oy.a(e,t,s);return this.listenDetector(e,a),a}release(e){this.disposeDetector(e)}getAppIdleTime(){let e=Number.MAX_SAFE_INTEGER;return this.detectors.forEach((t=>{const s=t.getIdleInfo();s.idleFor<e&&(e=s.idleFor)})),e}updateIdleTimeout(e){this.detectors.forEach((t=>{t.setIdleTimeout(e)}))}isAppFocus(){let e=!1;return this.detectors.forEach((t=>{t.isActive()&&(e=!0)})),e}init(){this.listenDetector(Ar.c,oy.b)}})||cy)||cy)||cy)||cy)||cy;const uy=Object(a.define)("lost-focus-service"),hy=Object(a.define)("active-service");var gy,my=function(e){return e[e.Focus=0]="Focus",e[e.LostFocus=1]="LostFocus",e}(my||{});let py=Object(a.injectable)()(gy=Object(m.f)()(gy=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(gy=function(e,t){return Object(a.inject)(uy)(e,void 0,1)}(gy=Reflect.metadata("design:type",Function)(gy=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a,void 0===uy?Object:uy])(gy=class{constructor(e,t){this.config=e,this.service=t,this.enableLog=void 0,this.currentState=void 0,this.enableLog=!0,this.currentState=my.LostFocus}onAuthenticated(e){const{userId:t}=e.getSession();this.enableLog&&ly.FSTT.zsymb(0,"32Q1mp","onAuthenticated",t),this.init()}init(){const e=a.ModuleContainer.resolve(ry.c);e.addEventListener(ry.b.LostFocus,(e=>{const{scope:t,reason:s}=e.payload;this.currentState==my.Focus&&"app"===t&&(this.service.notiLostFocus(),this.config.get("online_configs.enable_focus_manager")&&Hv.b.setAppStatus(Hv.a.BACKGROUND),this.currentState=my.LostFocus)})),e.addEventListener(ry.b.Focus,(e=>{this.currentState==my.LostFocus&&this.config.get("online_configs.enable_focus_manager")&&Hv.b.setAppStatus(Hv.a.FOREGROUND),this.currentState=my.Focus}))}})||gy)||gy)||gy)||gy)||gy)||gy;var fy;let vy=Object(a.injectable)()(fy=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(fy=Reflect.metadata("design:type",Function)(fy=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a])(fy=class{constructor(e){this.config=e}notiLostFocus(){this.config.get("online_configs.enable_lost_focus")?So.default.lostFocus().then(Co.a).then((()=>{ly.FSV.zsymb(0,"QmbUfK","send noti lost success")})).catch((e=>{ly.FSV.zsymb(0,"XseBW3","send noti lost fail",JSON.stringify(e))})):ly.FSV.zsymb(0,"U57dgn","call send noti lost but feat disable")}})||fy)||fy)||fy)||fy;var _y,by=s("a8HX");let Iy=Object(a.injectable)()(_y=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(_y=function(e,t){return Object(a.inject)(hy)(e,void 0,1)}(_y=Reflect.metadata("design:type",Function)(_y=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===hy?Object:hy])(_y=class extends bm.a{constructor(e,t){super(),this.loggerFactory=e,this.service=t}createMachine(){return e=this.loggerFactory.createZLogger(w.ZLoggerNametags.activeDeactive,[w.ZLoggerNametags.stateMachine]),t=this.service,Object(Pm.a)({strict:!0,id:"active-deactive",context:{},initial:"unset",states:{unset:{entry:()=>e.zsymb(3,"EnuwO-",["unset","zGnQRs"]),on:{FOCUS:{actions:()=>{e.zsymb(3,"UuYeY4",["start life cycle normal case!","wIN4Cj"])},target:"foreground_active"},APP_UNLOCK:{actions:()=>{e.zsymb(3,"zsJd0j",["start life cycle app auto lock case!","xaxHKr"])},target:"foreground_active"},LOST_FOCUS:{actions:()=>{e.zsymb(3,"Gvr2IE",["start life cycle lost focus case!","J-erVF"])},target:"background_active"}}},foreground_active:{entry:s=>{e.zsymb(3,"eUk1YY",["state: foreground_active","iJ8fHF"]),t.startForegroundMode()},on:{IDLE:{actions:()=>{},target:"background_deactive"},LOST_FOCUS:{actions:()=>{},target:"background_active"},INAPP_INTERACT:{actions:()=>{t.keepForegroundMode()}},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},APP_LOCK:{target:"background_deactive"},APP_UNLOCK:{actions:()=>{t.startForegroundMode()}},LOG_OFF:{target:"background_deactive"},OUTAPP_IDLE:{target:"background_deactive"}}},background_active:{entry:s=>{e.zsymb(3,"TSdK3o",["state: background_active","u0GVVc"]),t.startBackgroundMode()},on:{FOCUS:{target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)}},OUTAPP_IDLE:{target:"background_deactive"},APP_LOCK:{target:"background_deactive"},LOG_OFF:{target:"background_deactive"}}},background_deactive:{entry:(s,a)=>{e.zsymb(3,"LQK_tW",["state: background_deactive","VAFov0"],a.status),t.startDeactive(a.status)},on:{FOCUS:{actions:()=>{},target:"foreground_active"},OUTAPP_INTERACT:{actions:(e,s)=>{t.activeInBackground(s.isOsEvt)},target:"background_active"},APP_UNLOCK:{target:"foreground_active"}}}},on:{RESET:{target:"unset",actions:()=>{}}}});var e,t}isUnset(){var e;return"unset"===(null===(e=this.interpreter)||void 0===e?void 0:e.state.value)}onceDeactive(e){var t;if("background_deactive"===(null===(t=this.interpreter)||void 0===t?void 0:t.state.value))e();else{let t=()=>{var s,a;"background_deactive"===(null===(s=this.interpreter)||void 0===s?void 0:s.state.value)&&(null===(a=this.interpreter)||void 0===a||a.off(t),e())};this.onChange(t)}}})||_y)||_y)||_y)||_y)||_y;var yy,Sy=s("4zJP");const Cy=new Map([["0","LOCK_SCREEN"],["1","UNLOCK_SCREEN"],["2","LOG_ON"],["3","LOG_OFF"],["4","SLEEP"],["5","RESUME"]]);let Ey=Object(a.injectable)()(yy=Object(m.j)()(yy=Object(m.h)()(yy=Object(a.singleton)(by.a)(yy=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(yy=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(yy=function(e,t){return Object(a.inject)(hy)(e,void 0,2)}(yy=Reflect.metadata("design:type",Function)(yy=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===hy?Object:hy])(yy=class{constructor(e,t,s){this.config=e,this.service=s,this.logger=void 0,this.machine=void 0,this.authenticated=void 0,this.appLocked=void 0,this.isRunning=void 0,this.lastConfig=void 0,this.onAppLock=()=>{this.logger.zsymb(0,"ojiaf5","app locked",this.authenticated),this.appLocked=!0,this.authenticated&&(this.machine.send({type:"APP_LOCK",status:2}),$zInAppPayment.closeInAppPayment())},this.onAppUnLock=()=>{this.logger.zsymb(0,"j_DQ7x","app unlocked",this.authenticated),this.appLocked=!1,this.authenticated&&this.machine.send({type:"APP_UNLOCK",status:0})},this.onConfigChanged=e=>{Ce.default.stagingAccount&&(window._activeController=this),e&&this.config.set("online_configs",e);const t=this.isConfigsReallyChanged();if(this.logger.zsymb(0,"i1HKJx","onConfigChanged",t),!t)return;this.lastConfig=this.config.get("online_configs");const s=this.config.get("online_configs.idle_time");a.ModuleContainer.resolve(ry.c).updateIdleTimeout(s/1e3),this.service.onConfigUpdated(),this.isEnable()?this.setup():this.onDispose()},this.onLostFocus=async e=>{const{scope:t,reason:s}=e.payload;"app"===t&&(this.logger.zsymb(0,"qSrKMW","lost focus",s),"no-action-timeout"!=s||await this.service.isUserHasAction(this.idleTime)?this.machine.send({type:"LOST_FOCUS"}):this.machine.send({type:"IDLE",status:0}))},this.onFocus=e=>{this.isUsingApp()&&(this.logger.zsymb(0,"a_erPP","active-deactive focus"),this.machine.send({type:"FOCUS"}))},this.onActiveFromBackground=(e,t)=>{this.logger.zsymb(0,"vBl2ir","onActiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_INTERACT",isOsEvt:t})},this.onDeactiveFromBackground=(e,t)=>{this.logger.zsymb(0,"871rfA","onDeactiveFromBackground",t),this.isUsingApp()&&this.machine.send({type:"OUTAPP_IDLE",status:t})},this.machine=a.ModuleContainer.resolveToken(Iy),this.logger=t.createZLogger(w.ZLoggerNametags.activeDeactive,[w.ZLoggerNametags.controller]),this.config=e,this.service=s,this.authenticated=!1,this.appLocked=!1,this.isRunning=!1,this.lastConfig={},J.p.listenEvent(J.m,this.onConfigChanged);try{this.machine.create()}catch(i){return void this.logger.zsymb(18,"ISvvlG",(()=>["create error",{error:i}]))}}createMachine(){}onStart(){this.isEnable()||this.logger.zsymb(0,"NKCSIX","feature is not enable")}setup(){if(this.logger.zsymb(0,"4-OaN8","setup",this.isRunning),this.clearBackgroundTracking(),this.isEnableBackgroundTrack()&&this.setupBackgroundTracking(),this.isRunning)return;this.isRunning=!0,this.machine.start();const e=a.ModuleContainer.resolve(ry.c);this.machine.isUnset()&&(e.isAppFocus()?this.machine.send({type:"FOCUS"}):this.machine.send({type:"LOST_FOCUS"})),e.addEventListener(ry.b.LostFocus,this.onLostFocus),e.addEventListener(ry.b.Focus,this.onFocus),this.appLocked=J.p.getAppLock(),Sy.b.on(Sy.a.APP_LOCKED,this.onAppLock),Sy.b.on(Sy.a.APP_UNLOCKED,this.onAppUnLock)}onAuthenticated(){this.authenticated=!0,this.isEnable()&&this.service.onLogin()}onDispose(){if(!this.isRunning)return;this.isRunning=!1,this.machine.stop();const e=a.ModuleContainer.resolve(ry.c);e.removeEventListener(ry.b.LostFocus,this.onLostFocus),e.removeEventListener(ry.b.Focus,this.onFocus),Sy.b.off(Sy.a.APP_LOCKED,this.onAppLock),Sy.b.off(Sy.a.APP_UNLOCKED,this.onAppUnLock),this.clearBackgroundTracking()}isConfigsReallyChanged(){for(const e in this.config.get("online_configs"))if(e&&this.lastConfig[e]!==this.config.get(`online_configs.${e}`))return!0;return!1}setupBackgroundTracking(){$zFeatures.activeDeactive.setup({delta:Ce.default.online_configs.idle_interval_check,inactiveTime:Ce.default.online_configs.idle_time,trackActive:Ce.default.online_configs.track_inactive_alive_back,currStatus:this.service.getStatus(),backgroundTracking:Ce.default.online_configs.enable_background_tracking,fullBgTracking:this.isEnableFullBackgroundTrack()}),$zsub.$zFeatures.activeDeactive.onActiveFromBackground(this.onActiveFromBackground),$zsub.$zFeatures.activeDeactive.onDeactiveFromBackground(this.onDeactiveFromBackground)}clearBackgroundTracking(){$zFeatures.activeDeactive.clearTimer(this.isEnableBackgroundTrack()),$zsub.$zFeatures.activeDeactive.offActiveFromBackground(this.onActiveFromBackground),$zsub.$zFeatures.activeDeactive.offDeactiveFromBackground(this.onDeactiveFromBackground)}onUserSendMessage(){this.isEnable()&&this.machine.send("INAPP_INTERACT")}onUserLogOff(){return new Promise((e=>{if(!this.isEnable()||!this.isUsingApp())return e(!1);this.machine.onceDeactive((()=>{e(!0)})),this.machine.send({type:"LOG_OFF",status:3}),this.onDispose(),setTimeout((()=>{e(!0)}),1e3)}))}onOSEvent(e){if(!this.isEnable())return;const t=Cy.get(e);_e.default.send(ve.GeneralActions.USER_ACTIVE_CHANGED,t),this.logger.zsymb(3,"RMzt4M",["handle event os ","UIE98w"],t)}isUsingApp(){const e=this.appLocked||J.p.getWaitRestart();return this.authenticated&&!e}isEnable(){return this.config.get("online_configs.enable_active_deactive_v2")}isEnableBackgroundTrack(){return this.config.get("online_configs.enable_background_tracking")}isEnableFullBackgroundTrack(){return this.config.get("online_configs.enable_full_bg_tracking")}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get idleTime(){return this.config.get("online_configs.idle_time")}})||yy)||yy)||yy)||yy)||yy)||yy)||yy)||yy)||yy;var Oy,My=s("8RMw"),Ty=s("oQzU"),Ry=function(e){return e[e.ActiveBackground=0]="ActiveBackground",e[e.KeepActiveForeground=1]="KeepActiveForeground",e[e.FirstActiveForeground=2]="FirstActiveForeground",e[e.ToBackground=3]="ToBackground",e[e.KeepActiveBackground=4]="KeepActiveBackground",e}(Ry||{}),wy=function(e){return e[e.Idle=0]="Idle",e[e.ComputerLock=1]="ComputerLock",e[e.AppLock=2]="AppLock",e[e.LogOff=3]="LogOff",e}(wy||{}),Ly=function(e){return e[e.Foreground=0]="Foreground",e[e.BackgroundActive=1]="BackgroundActive",e[e.BackgroundDeactive=2]="BackgroundDeactive",e}(Ly||{});const Dy={[Ly.Foreground]:Ry.KeepActiveForeground,[Ly.BackgroundActive]:Ry.KeepActiveBackground};let Ay=Object(a.injectable)()(Oy=function(e,t){return Object(a.inject)(Yl.a)(e,void 0,0)}(Oy=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(Oy=function(e,t){return Object(a.inject)(ry.c)(e,void 0,2)}(Oy=Reflect.metadata("design:type",Function)(Oy=Reflect.metadata("design:paramtypes",[void 0===Yl.a?Object:Yl.a,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===ry.c?Object:ry.c])(Oy=class{constructor(e,t,s){this.config=e,this.focusManager=s,this.logger=void 0,this.pingTimer=void 0,this.deactiveTimer=void 0,this.status=void 0,this.configChanged=void 0,this.countPingWssFail=0,this.logger=t.createZLogger(w.ZLoggerNametags.activeDeactive,[w.ZLoggerNametags.service]),this.status=Ly.Foreground,this.configChanged=!1}get pingInterval(){return this.config.get("online_configs.update_action_interval")}get deactiveTimeout(){return this.config.get("online_configs.idleTime")}get enableSendDeactiveOnBgIdle(){return this.config.get("online_configs.enable_deact_on_bg_idle")}get enableSendDeactiveOnFgIdle(){return this.config.get("online_configs.enable_deact_on_fg_idle")}get enSendActiveToKeepAlive(){return this.config.get("online_configs.send_active_to_keep_live")}get enActiveUsingSocket(){return this.config.get("online_configs.send_active_using_socket")}get enableBackgroundTracking(){return this.config.get("online_configs.enable_background_tracking")}get enableFeature(){return this.config.get("online_configs.enable_active_deactive_v2")}get enableFullBackgroundTrack(){return this.config.get("online_configs.enable_full_bg_tracking")}onLogin(){this.sendActiveToServer(Ry.ActiveBackground)}startTrackIdle(e=!0){this.enableBackgroundTracking?(this.logger.zsymb(0,"0FUVNB","startTrackIdle"),$zFeatures.activeDeactive.createTimer(e)):this.logger.zsymb(0,"nKKQly","in startTrackIdle but flag off")}stopTrackIdle(){this.logger.zsymb(0,"2VqRNk","stopTrackIdle"),$zFeatures.activeDeactive.clearTimer(this.enableBackgroundTracking)}startForegroundMode(){this.status=Ly.Foreground,this.sendActiveToServer(Ry.FirstActiveForeground),this.clearPingTimer(),this.createPingTimer(),this.enableFullBackgroundTrack||this.stopTrackIdle()}keepForegroundMode(){this.sendActiveToServer(Ry.KeepActiveForeground,{additionText:"[Send Msg] "})}startBackgroundMode(){this.status=Ly.BackgroundActive,this.enableBackgroundTracking||this.clearPingTimer(),this.enableBackgroundTracking&&this.createPingTimer(),this.startTrackIdle()}activeInBackground(e){const t=e?Ry.ActiveBackground:Ry.KeepActiveBackground;this.pingTimer?this.logger.zsymb(0,"ywzaIH","user action bg but dont need ping because in ping interval"):this.sendActiveToServer(t)}startDeactive(e){let t=-1;switch(e){case 0:t=wy.Idle;break;case 1:t=wy.ComputerLock;break;case 2:t=wy.AppLock;break;case 3:t=wy.LogOff}this.clearPingTimer(),-1!==t&&this.canSendDeactive(t)&&this.sendDeactiveToServer(t),this.status===Ly.Foreground&&t==wy.Idle&&this.startTrackIdle(!1),t!=wy.ComputerLock&&t!=wy.AppLock||this.stopTrackIdle(),this.status=Ly.BackgroundDeactive}onConfigUpdated(){this.configChanged=!0,this.enableFeature||this.clearPingTimer()}getStatus(){return this.status}createPingTimer(){!this.pingTimer&&this.enableFeature&&(this.logger.zsymb(0,"9iph3c","createPingTimer"),this.configChanged=!1,this.pingTimer=setInterval((()=>{const e=Dy[this.status];e?this.sendPingActive(e):this.logger.zsymb(0,"lIqETv","call ping invalid state!"),this.configChanged&&(this.clearPingTimer(),this.createPingTimer())}),this.pingInterval))}clearPingTimer(){this.logger.zsymb(0,"qLEL6X","clearPingTimer"),clearInterval(this.pingTimer),this.pingTimer=null}async isUserHasAction(e){let t=this.focusManager.getAppIdleTime();{const e=await $zFeatures.activeDeactive.getIdleTime();t=Math.min(t,e)}return t<e}canSendDeactive(e){return e!==wy.Idle||(this.status===Ly.Foreground&&this.enableSendDeactiveOnFgIdle||this.status===Ly.BackgroundActive&&this.enableSendDeactiveOnBgIdle)}async sendPingActive(e){await this.isUserHasAction(this.pingInterval)?this.sendActiveToServer(e):this.logger.zsymb(3,"tdv5V3",["call ping but discard, because the user don't have action!","5GDaN4"])}sendActiveToServer(e,t={additionText:""}){const{additionText:s}=t;if(!this.enActiveUsingSocket||Tu.default.getMsgSrcType()!==Y.MsgSources.SOCKET)return kc.default.increaseFailed(88888,0,0,e,Date.now()),this.sendActiveViaHttp(e,s).then((e=>(e&&(this.countPingWssFail=0),e)));let a=null;return a=this.enSendActiveToKeepAlive?My.default.pingActiveViaKeepAlive(e):Ty.a.instance().pingActive(e),a.then((()=>(this.countPingWssFail=0,this.logger.zsymb(3,"pZrcls",["{}Call active app SUCCESS: socket - {}","KAeYy1"],s,e),!0))).catch((t=>(this.logger.zsymb(21,"lMXxwA",["{}Call active fail: socket - {} - {}","XQut4-"],s,e,JSON.stringify(t)),this.countPingWssFail++,kc.default.increaseFailed(88888,1,0,e,Date.now()),this.sendActiveViaHttp(e).then((t=>(t&&this.countPingWssFail>=3&&(this.countPingWssFail=0,kc.default.increaseFailed(88888,2,0,e,Date.now())),t))))))}sendActiveViaHttp(e,t=""){return new Promise((s=>{So.default.active(e).then(Co.a).then((()=>{this.logger.zsymb(3,"V3w6nv",["{}Call active app SUCCESS: http - {}","OHyb7p"],t,e),s(!0)})).catch((a=>{this.logger.zsymb(21,"2cjHf1",["{}Call active fail: http - {} - {}","EN4ubJ"],t,e,JSON.stringify(a)),s(!1)}))}))}sendDeactiveToServer(e){return So.default.deactiveV2().then(Co.a).then((()=>(this.logger.zsymb(3,"nR6uio",["Call deactive app SUCCESS {}","_DruWf"],e),!0))).catch((e=>(this.logger.zsymb(21,"vmfFpL",["Call deactive fail: ","3UsNfI"],JSON.stringify(e)),!1)))}})||Oy)||Oy)||Oy)||Oy)||Oy)||Oy;a.ModuleContainer.registerSingleton(uy,vy),a.ModuleContainer.registerSingleton(ry.c,dy),a.ModuleContainer.registerSingleton(hy,Ay),a.ModuleContainer.resolve(ry.c),a.ModuleContainer.resolveToken(py),a.ModuleContainer.resolveToken(Ey);s("rBRb");var Fy,ky=s("jbAT"),Ny=s("zLd2"),Py=s("5txd");Object(a.injectable)()(Fy=Object(a.singleton)(Ny.c)(Fy=function(e,t){return Object(a.inject)(ky.b)(e,void 0,0)}(Fy=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(Fy=Reflect.metadata("design:type",Function)(Fy=Reflect.metadata("design:paramtypes",[void 0===ky.a?Object:ky.a,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Fy=class{constructor(e,t){this._utilsMediaAppService=void 0,this._logger=void 0,this._log=void 0,this._utilsMediaAppService=e,me.a.ConvInfoDataManager.addEventListener(ai.b.DeleteConv,this._onDeleteConversation.bind(this)),me.a.ConvInfoDataManager.addEventListener(ai.b.EmptyConv,this._onEmptyConversation.bind(this)),this._logger=t.createZLogger(Ny.b,["manage-utils-media-in-ui"]),this._log=Object(Py.b)(this._logger)}create(e){return this._utilsMediaAppService.create(e)}createOrUpdate(e){return this._utilsMediaAppService.createOrUpdate(e)}async createOrUpdateFromMedias(e){return this._utilsMediaAppService.createOrUpdateFromMedias(e)}_onDeleteConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}_onEmptyConversation(e){const{convId:t}=e;this._utilsMediaAppService.deleteUtilsMediasByConvId(t)}})||Fy)||Fy)||Fy)||Fy)||Fy);s("37f1");var jy,Uy=s("lT2C"),By=s("C8zZ"),zy=s("wmCV");let Gy=Object(xi.b)(By.GroupPollManager)(jy=function(e,t){return a.ModuleContainer.inject(Nn.ConvInfoDataManager)(e,void 0,0)}(jy=Reflect.metadata("design:type",Function)(jy=Reflect.metadata("design:paramtypes",[void 0===Nn.ConvInfoDataManager?Object:Nn.ConvInfoDataManager])(jy=class{constructor(e){this.convDataManager=e,this._Logger=void 0,this.pollCache=void 0,this.pollCache=new u.default({maxSize:1e4}),this.setUpEvent()}get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.pollV3,[w.ZLoggerNametags.groupPollManager])),this._Logger}updatePollCache(e,t){this.pollCache.set(e,t)}removePollCacheBelongsToConv(e){Array.from(this.pollCache.entriesAscending()).forEach((([t,s])=>{s.group_id===ui.default.getGroupIdFromConversationId(e)&&this.pollCache.delete(t)}))}setUpEvent(){this.convDataManager.addEventListener(ai.b.DeleteConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(ai.b.EmptyConv,(e=>{this.removePollCacheBelongsToConv(e.convId)})),this.convDataManager.addEventListener(ai.b.LeaveGroup,(e=>{this.removePollCacheBelongsToConv(e.convId)}))}isAdmin(e,t){var s;const a=yn.default.getGroupByIdSync(e);if(!a)return!1;if(t===a.creatorId)return!0;let i=!1;return null===(s=a.topMember)||void 0===s||s.forEach((e=>{e.id===t&&e.isAdmin&&(i=!0)})),i}isAllowSetTopic(e){var t;const s=yn.default.getGroupByIdSync(e);return!!s&&!(!Ce.default.group_topics.enable||null!==(t=s.setting)&&void 0!==t&&t.setTopicOnly)}isEnablePin(e){return this.isAdmin(e,Ii.default.getUidMe())||this.isAllowSetTopic(e)}isEnableClose(e,t){const s=Ii.default.getUidMe();return this.isAdmin(e,s)||s===t}createPollRequestData(e){const{pollData:t,groupId:s,src:a}=e,i={question:t.question,options:t.options,expired_time:t.expiredTime,pinAct:t.pinAct,allow_multi_choices:t.allowMultiChoices,allow_add_new_option:t.allowAddNewOption,is_hide_vote_preview:t.isHideVotePreview,is_anonymous:t.isAnonymous,poll_type:t.pollType};return{groupId:ui.default.getGroupIdFromConversationId(s),pollData:i,src:a}}async createPoll(e){const t=e.pollData.pinAct,{groupId:s,pollData:a,src:i}=this.createPollRequestData(e);try{const n=await qc.default.createPoll(s,a,i);t&&this.pinPoll(n.poll_id,e.groupId,n.question)}catch(n){throw this.Logger.zsymb(18,"G06EAw",n),n}}getPollDetailSync(e){return this.pollCache.get(e)}async getPollDetail(e,t){let s=this.getPollDetailSync(e);if(s)return s;if(s=await Re.default.getPollInfo(e),!s){if(t)return this.getPollDetailFromServer(e);throw Error("Poll isn't existed in DB")}return this.pollCache.set(e,s),s}async getPollDetailFromServer(e,t){const s=await qc.default.getPollDetail(t,e,!1);if(!s)throw Error("Poll isn't existed in Server");return this.pollCache.set(e,s),s}async pinPoll(e,t,s){let a=s;if(!a){let t=this.getPollDetailSync(e);if(t||(t=await this.getPollDetail(e)),!t)throw Error("Poll isn't existed");a=t.question}zy.a.pinFromBoard({userId:t},{poll_id:e,isPoll:!0,question:a},null,null,uo.a.getWinIdByConvId(t))}unpinPoll(e,t){zy.a.unpinFromBoard(t,{poll_id:e,isPoll:!0})}async lockPoll(e){const t=this.getPollDetailSync(e);if(!t||!t.closed)try{qc.default.lockPoll(e)}catch(s){this.Logger.zsymb(18,"y8m8nY","[lockPoll] ",e,s)}}async sharePollInGroup(e){try{qc.default.sharePoll(e)}catch(t){this.Logger.zsymb(18,"XTm131","[sharePollInGroup] ",e,t)}}async votePoll(e){const{newOptions:t,pollId:s,votedOptionIds:a}=e,i=ui.default.getGroupIdFromConversationId(e.groupId);try{t.length>0?await qc.default.addNewOptionPoll(i,s,JSON.stringify(t),a):await qc.default.vote(i,s,a)}catch(n){throw this.Logger.zsymb(18,"Q2y6QZ","[votePoll] ",n,s),n}}})||jy)||jy)||jy)||jy;var xy,Vy=s("ILDi");let Hy=Object(xi.b)(By.GroupPollInfoManager)(xy=Reflect.metadata("design:type",Function)(xy=Reflect.metadata("design:paramtypes",[])(xy=class{constructor(){this.updateEmitter=void 0,this.viewedMoreFromMsgIds=void 0,this.updateEmitter=new Sp.a,this.viewedMoreFromMsgIds=new Set}getPollParams(e){let t=null;try{var s;t=JSON.parse(null==e||null===(s=e.message)||void 0===s?void 0:s.params)}catch(a){t={}}return t}getLastMessagePoll(e,t,s){let a=t;return s.forEach((s=>{s.msgType!==t.msgType||this.getPollParams(s).pollId!==e||(a=s)})),a}getContinuosPollInfoSection(e,t){const s=[];let a=0;return t.forEach((t=>{var i;t.msgType===Y.MSG_POLL&&this.getPollParams(t).pollId===e?(s[a]||(s[a]=[]),s[a].push(t)):null!==(i=s[a])&&void 0!==i&&i[0]&&(a+=1)})),s.filter((e=>e.length>Ce.default.groupPoll.max_info_msg_display))}isShowPollCard(e,t,s){const a=this.getLastMessagePoll(e,t,s);return Ku.b.isSameMsg(t,a)}getPollInfoShowStatus(e,t,s){const a=this.getContinuosPollInfoSection(e,s);for(const i of a)for(let e=i.length-1;e>=0;e--)if(Ku.b.isSameMsg(t,i[e]))return e!==i.length-1?"HIDE":i[e-1]&&this.viewedMoreFromMsgIds.has(i[e-1].msgId)?"SHOW":"SHOW_VIEW_MORE";return"SHOW"}viewMore(e,t,s){let a=[];const i=this.getContinuosPollInfoSection(e,s);for(const n of i)if(n[n.length-1].msgId===t){a=n.map((e=>e.msgId));break}this.updateEmitter.emit("EXPAND_MSG_INFO",{msgIds:a}),this.viewedMoreFromMsgIds.add(t)}clearViewedMoreHistory(e){this.viewedMoreFromMsgIds.delete(e)}})||xy)||xy)||xy;a.ModuleContainer.registerSingleton(Uy.a,Gy),a.ModuleContainer.registerSingleton(Vy.a,Hy);var Wy,qy,Ky=s("qLo6");Object(m.f)()(Wy=class{onAuthenticated(e){Ce.default.e2ee.enable_wasm&&Ky.AesGcmWasmFactory.instance.installAndTestWasm().then((()=>{})).catch((e=>{}))}}),Object(m.f)()(qy=class{onAuthenticated(e){try{WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))?kc.default.increaseSuccess(97136,0,0):kc.default.increaseFailed(97136,0,0,0,0)}catch{kc.default.increaseFailed(97136,0,0,1,0)}}});var Zy,$y=s("3+ZU"),Qy=s("MEZx");a.ModuleContainer.registerSingleton($y.a,class{getDebugMenu(){return Ce.default.mediaStatus.debug.enable?{type:Qy.MENU_ITEM_TYPE.SUBMENU,text:"Media Status",items:[{text:"Disable expired soon status",onclick:()=>{Ce.default.mediaStatus.enable_expired_soon=!Ce.default.mediaStatus.enable_expired_soon},checked:!Ce.default.mediaStatus.enable_expired_soon},{text:"Revert media status",onclick:()=>{Ce.default.mediaStatus.enable_media_status=!Ce.default.mediaStatus.enable_media_status},checked:!Ce.default.mediaStatus.enable_media_status},{text:"Disable view in folder for auto download",onclick:()=>{Ce.default.mediaStatus.enable_view_folder_option_for_auto_download=!Ce.default.mediaStatus.enable_view_folder_option_for_auto_download},checked:!Ce.default.mediaStatus.enable_view_folder_option_for_auto_download},{text:"Disable inview file download",onclick:()=>{Ce.default.mediaStatus.enable_file_inview_download=!Ce.default.mediaStatus.enable_file_inview_download},checked:!Ce.default.mediaStatus.enable_file_inview_download},{text:"Open Media Status Debugger Modal",onclick:()=>{const e=s("h0sc");e&&e.ModalManagerV2&&e.ModalManagerV2.openModal({windowId:"1",name:Y.ModalIdentitiesDefine.MEDIA_STATUS_DEBUGGER,params:{show:!0}})}}]}:null}});let Yy=Object(a.injectable)()(Zy=function(e,t){return Object(a.inject)(nt)(e,void 0,0)}(Zy=Reflect.metadata("design:type",Function)(Zy=Reflect.metadata("design:paramtypes",[Object])(Zy=class{constructor(e){this.queue=e}push(e,t,s){const a={convId:e,msgId:t,action:s};this.queue.push(a)}})||Zy)||Zy)||Zy)||Zy;class Jy extends Error{constructor({message:e,name:t,options:s}){super(e),this.code=void 0,this.name=void 0,this.name=t,s&&s.code&&(this.code=s.code),s&&s.stack&&(this.stack=(new Error).stack),Object.setPrototypeOf(this,Jy.prototype)}}var Xy=(e,t)=>{const s={code:e.code,stack:t};return new Jy({name:e.name,options:s,message:e.message})};const eS={name:"CANNOT_GET_MSG_FROM_DB",code:1,message:"Cannot get message from Message Core database"},tS={name:"QUEUE_TASK_EMPTY",code:2,message:"Action log info queue is empty"},sS={name:"TASK_IS_RUNNING",code:3,message:"Media action log info queue has task is running"},aS={name:"TEMP_DISABLE_LOG_PHOTO_SUBTYPE_2",code:4,message:"Temporary disable actionlog info for photo in subType 2"};var iS=s("tmLI"),nS=s("jjJf"),rS=s("eZ5W");function oS(e){return e===Y.MSG_E2EE?it.c.YES:it.c.NO}function cS(e){return"0"!=e?it.d.RECEIVER:it.d.SENDER}var lS=s("HPXo");class dS{build(e,t){var s,a;const i={msg_type:it.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:oS(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:cS(null===(a=e.msg)||void 0===a?void 0:a.fromUid),conv_type:it.f[e.convType],sync_source:it.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(i.group_size=e.groupSize),t){case it.j.MediaExpiredWhenAction:i.original_status=lS.a.get(e.msg.msgId);break;case it.j.MediaStatusInView:null!=e&&e.forceStatus?i.file_status=null==e?void 0:e.forceStatus:i.file_status=null==e?void 0:e.mediaStatus}return i}}class uS{build(e,t){var s,a;const i={msg_type:it.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:oS(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:cS(null===(a=e.msg)||void 0===a?void 0:a.fromUid),conv_type:it.f[e.convType],sync_source:it.g[e.msg.src],is_zCloud:e.isZCloud};switch(null!=e&&e.groupSize&&(i.group_size=e.groupSize),t){case it.j.MediaExpiredWhenAction:i.original_status=lS.a.get(e.msg.msgId);break;case it.j.MediaStatusInView:i.file_status=null==e?void 0:e.forceStatus}return i}}class hS{build(e,t){var s,a;const i={msg_type:it.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:oS(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:cS(null===(a=e.msg)||void 0===a?void 0:a.fromUid),conv_type:it.f[e.convType],sync_source:it.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(i.group_size=e.groupSize),t){case it.j.MediaExpiredWhenAction:i.original_status=lS.a.get(e.msg.msgId);break;case it.j.MediaStatusInView:i.file_status=e.mediaStatus}return i}}class gS{build(e,t){var s,a;const i={msg_type:it.h[e.msg.msgType],entry_point:e.entryPoint,size:e.size,sent_time:e.msg.sendDttm,is_e2ee:oS(null===(s=e.msg)||void 0===s?void 0:s.e2eeStatus),is_sender:cS(null===(a=e.msg)||void 0===a?void 0:a.fromUid),conv_type:it.f[e.convType],sync_source:it.g[e.msg.src],is_zCloud:e.isZCloud,msg_id:e.msg.msgId};switch(null!=e&&e.groupSize&&(i.group_size=e.groupSize),t){case it.j.MediaExpiredWhenAction:i.original_status=lS.a.get(e.msg.msgId);break;case it.j.MediaStatusInView:i.file_status=e.mediaStatus}return i}}class mS{constructor(){this.msg=void 0,this.subType=void 0,this.entryPoint=void 0,this.convType=void 0,this.mediaStatus=void 0,this.forceStatus=void 0,this.isZCloud=void 0}withMessage(e){return this.msg=e,this}withSubType(e){return this.subType=e,this}withEntryPoint(e){return this.entryPoint=e,this}withStatus(e){return this.mediaStatus=e&&function(e){var t,s,a,i,n,r,o;let c="";var l,d,u,h,g,m;return null!==(t=e)&&void 0!==t&&t.isExpired&&(c=Og.e.Expired),null!==(s=e)&&void 0!==s&&s.isExpiredSoon&&(c=Og.e.ExpiredSoon),Object(nS.b)().isEnableViewPCloudFileStatus()&&null!==(a=e)&&void 0!==a&&a.personalCloud&&null!==(l=e)&&void 0!==l&&null!==(d=l.personalCloud)&&void 0!==d&&null!==(u=d.status)&&void 0!==u&&u.isUncloud&&e===Og.e.ExpiredSoon&&(e=Og.e.ExpiredSoon),Object(nS.b)().isEnableViewPCloudFileStatus()&&null!==(i=e)&&void 0!==i&&i.personalCloud&&null!==(h=e)&&void 0!==h&&null!==(g=h.personalCloud)&&void 0!==g&&null!==(m=g.status)&&void 0!==m&&m.isClouded&&(c=Og.d.CloudSaved),null!==(n=e)&&void 0!==n&&n.autoDownloadPath&&(c=Og.e.DownloadedAuto),(null!==(r=e)&&void 0!==r&&r.localPath||null!==(o=e)&&void 0!==o&&o.folderPath)&&(c=Og.e.DownloadedManual),c}(e),this}withForceStatus(e=""){return this.forceStatus=e,this}withZCloud(e=0){return this.isZCloud=e?1:0,this}build(){var e,t;const s=function(e){const t=Object(iS.n)(null==e?void 0:e.params)||"";return t?(null==t?void 0:t.fileSize)&&+t.fileSize/1024:-1}(this.msg.message),a=(null===(e=this.msg)||void 0===e?void 0:e.toUid)&&(i=null===(t=this.msg)||void 0===t?void 0:t.toUid,ui.default.isOAType(Ii.default.getProfileFriendSync(i))?it.a.OA:ui.default.getConversationType(i));var i;const n=a===it.a.GROUP&&function(e){let t;const s=yn.default.getGroupByIdSync(e);return null!=s&&s.topMember&&(null==s?void 0:s.topMember.length)>0&&(t=null==s?void 0:s.topMember.length),t}(this.msg.toUid),r=a===it.a.CLOUD?function(e,t){let s=e;return e!==Og.d.DownloadedAuto&&e!==Og.d.DownloadedManual&&t<=rS.b.getCloudLimitBigFileInBytes()&&(s=Og.d.CloudSaved),s}(this.mediaStatus,s):this.mediaStatus;let o={};const c={msg:this.msg,size:s,isZCloud:this.isZCloud,mediaStatus:r,convType:a,forceStatus:this.forceStatus,entryPoint:this.entryPoint,groupSize:n};switch(this.msg.msgType){case Y.MSG_PHOTO:case Y.MSG_PHOTO_2:o=(new uS).build(c,this.subType);break;case Y.MSG_FILE:o=(new dS).build(c,this.subType);break;case Y.MSG_VIDEO:o=(new hS).build(c,this.subType);break;case Y.MSG_VOICE:o=(new gS).build(c,this.subType)}return o}}var pS=class{verify(e){return!!e.file_status&&(!!Object.values(it.c).includes(e.is_e2ee)&&(!!Object.values(it.d).includes(e.is_sender)&&(!!Object.values(it.d).includes(e.is_sender)&&(!!Object.values(it.f).includes(e.conv_type)&&(!!Object.values(it.g).includes(e.sync_source)&&!!Object.values(it.h).includes(e.msg_type))))))}},fS=s("a4lh");Y.MSG_FILE,Y.MSG_VIDEO,Y.MSG_VOICE;const vS=[Y.MSG_PHOTO,Y.MSG_PHOTO_2];var _S;let bS=Object(a.injectable)()(_S=function(e,t){return Object(a.inject)(nt)(e,void 0,0)}(_S=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(_S=function(e,t){return Object(a.inject)(lt)(e,void 0,2)}(_S=Reflect.metadata("design:type",Function)(_S=Reflect.metadata("design:paramtypes",[Object,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,Object])(_S=class{constructor(e,t,s){this.queue=e,this.mediaActionLogInfoCronToGroupData=s,this.logger=void 0,this.DB=void 0,this.isRunning=void 0,this.logger=t.createZLogger(w.ZLoggerNametags.mediaStatus,["action-log-consumer"]),this.DB=Xt.default.getInstance(),this.isRunning=!1}async run(){if(!(this.queue.length<=0)){if(this.isRunning)return Xy(sS);this.isRunning=!0,requestAnimationFrame((async()=>{try{const e=this.queue.pop();if(!e)return Xy(tS);const t=e.msgId,s=e.action,a=e.convId,i=await this.DB.Core.Message.get(t,{partition:a});let n;if(!i)return Xy(eS);if((i.msgType===Y.MSG_PHOTO||i.msgType===Y.MSG_PHOTO_2)&&!Ce.default.mediaStatus.actionLogInfo.enable_sub_type_2_for_photo&&s.subType===it.j.MediaStatusInView)return aS;const r=(new mS).withEntryPoint(s.entryPoint).withSubType(s.subType).withMessage(i).withStatus(n).withForceStatus((null==s?void 0:s.forceStatus)||"").withZCloud((null==s?void 0:s.isZCloud)||0).build();if((new pS).verify(r))if(vS.includes(i.msgType)){const e=Object(I.a)({},r);delete e.sent_time,delete e.size;const t=JSON.stringify(e);this.mediaActionLogInfoCronToGroupData.runCron({key:t,data:Object(I.a)(Object(I.a)({},r),{},{subType:s.subType})})}else fS.a.LogActionInfo(s.subType,r)}catch(e){this.logger.zsymb(3,"l0zQjv",["error {}","UWv-0f"],JSON.stringify(e))}finally{this.isRunning=!1,this.run()}}))}}})||_S)||_S)||_S)||_S)||_S)||_S;var IS;let yS=Object(a.injectable)()(IS=function(e,t){return Object(a.inject)(rt)(e,void 0,0)}(IS=function(e,t){return Object(a.inject)(ct)(e,void 0,1)}(IS=Reflect.metadata("design:type",Function)(IS=Reflect.metadata("design:paramtypes",[Object,Object])(IS=class{constructor(e,t){this.producer=e,this.consumer=t}run(e,t,s){}})||IS)||IS)||IS)||IS)||IS;var SS=s("z97J");const CS=new class{constructor(e){this.lru=void 0,this.lru=new u.default({maxSize:e.maxSize()})}set(e,t){if(t)if(this.has(e)){const s=this.lru.get(e);s.sent_time=`${parseInt(s.sent_time)+parseInt(t.sent_time)}`,s.size&&t.size&&(s.size=`${parseInt(s.size)+parseInt(t.size)}`),++s.count,this.lru.set(e,s)}else this.lru.set(e,Object(I.a)(Object(I.a)({},t),{},{count:1}))}get(e){return this.lru.get(e)}has(e){return this.lru.has(e)}delete(e){return this.lru.delete(e)}getAll(){return[...this.lru.values()]}clear(){this.lru.clear()}}({maxSize:()=>Ce.default.maxSizeMemCacheMediaStatusPhotoActionLogInfo});a.ModuleContainer.registerSingleton(nt,class{constructor(){this.queue=void 0,this.queue=[]}push(e){this.queue.push(e)}pop(){return this.queue.pop()}get length(){return this.queue.length}}),a.ModuleContainer.registerSingleton(rt,Yy),a.ModuleContainer.registerSingleton(lt,class{constructor(){this.startCron=void 0,this.startCron=!1}setStart(){this.startCron||(this.startCron=!0)}isStartCron(){return this.startCron}runCron(e){const t=new SS.CronJob(Ce.default.mediaStatus.actionLogInfo.time_to_log_photo,(()=>{const e=CS.getAll();if(e.length){for(const s of e){var t;const e=s.subType;delete s.subType,s.sent_time=Math.round(s.sent_time/s.count),s.size=(null!==(t=s.size)&&void 0!==t?t:0)/s.count,fS.a.LogActionInfo(e,s)}CS.clear()}}));this.isStartCron()?CS.set(e.key,e.data):(CS.set(e.key,e.data),t.start(),this.setStart())}}),a.ModuleContainer.registerSingleton(ct,bS),a.ModuleContainer.registerSingleton(ot,yS);var ES=s("imbw"),OS=s("1EWQ");const MS=1,TS=2,RS=3;let wS=function(e){return e[e.TEXT=0]="TEXT",e[e.STICKER=1]="STICKER",e[e.PHOTO=2]="PHOTO",e[e.LINK=3]="LINK",e[e.FILE=4]="FILE",e[e.GIF=5]="GIF",e[e.CONTACT=6]="CONTACT",e}({}),LS=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),DS=function(e){return e[e.SINGLE=0]="SINGLE",e[e.GROUP=1]="GROUP",e}({}),AS=function(e){return e[e.CONTEXT_MENU=0]="CONTEXT_MENU",e[e.BUBBLE=1]="BUBBLE",e}({}),FS=function(e){return e[e.RESEND=1]="RESEND",e[e.DELETE=2]="DELETE",e}({}),kS=function(e){return e[e.NO_RESEND=1]="NO_RESEND",e[e.RESEND_SINGLE=2]="RESEND_SINGLE",e[e.RESEND_ALL=3]="RESEND_ALL",e}({}),NS=function(e){return e[e.NO_DELETE=1]="NO_DELETE",e[e.DELETE_SINGLE=2]="DELETE_SINGLE",e[e.DELETE_ALL=3]="DELETE_ALL",e}({});var PS;let jS=Object(xi.b)(ES.a)(PS=Reflect.metadata("design:type",Function)(PS=Reflect.metadata("design:paramtypes",[])(PS=class{constructor(){this.lastNetworkBannerAppearTime=void 0,this.logger=void 0,this.lastNetworkBannerAppearTime=null}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("auto-retry",["action-log"])),this.logger}logAction999(e){const{type:t,payload:s}=e;let a;switch(t){case"ShowManualRetry":a=MS;break;case"InteractManualRetry":a=TS;break;case"ShowBannerNetwork":a=RS}Ia.default.logActionInfoV2(Ia.FeaturesInfo.AutoRetry,a,s)}getChatTypeFromConvId(e){return ui.default.isGroup(e)?LS.CHAT_GROUP:OS.a.isSendToMe(e)?LS.MY_CLOUD:LS.CHAT_11}getRetryMsgType(e){switch(e){case Y.MSG_TEXT:return wS.TEXT;case Y.MSG_GIF:return wS.GIF;case Y.MSG_FILE:case Y.MSG_VIDEO:return wS.FILE;case Y.MSG_PHOTO:case Y.MSG_PHOTO_GROUP:return wS.PHOTO;case Y.MSG_CONTACT:return wS.CONTACT;case Y.MSG_STICKER:case Y.MSG_STICKER_GROUP:case Y.MSG_STICKER_2:return wS.STICKER;case Y.MSG_LINK_CLIENT:return wS.LINK;default:return}}getMsgCombineType(e){return[Y.MSG_PHOTO_GROUP,Y.MSG_STICKER_GROUP].includes(e)?DS.GROUP:DS.SINGLE}showManualRetryReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"ShowManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),error_id:e.errorCode,is_groupping:this.getMsgCombineType(e.msgType),is_manual_btn:e.errorMessageInfo?0:1}})}networkBannerAppearCapture(){this.lastNetworkBannerAppearTime=Ct.default.getTimeNow()}networkBannerDisappearReport(){const e=Ct.default.getTimeNow();if(null===this.lastNetworkBannerAppearTime)return;const t=e-this.lastNetworkBannerAppearTime;t<=0||(this.logAction999({type:"ShowBannerNetwork",payload:{showed_time:this.lastNetworkBannerAppearTime,off_time:e,duration:t}}),this.lastNetworkBannerAppearTime=null)}resendErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:AS[e.source],is_resend:this.getMsgCombineType(e.msgType)===DS.GROUP?kS.RESEND_ALL:kS.RESEND_SINGLE,is_deleted:NS.NO_DELETE,action_type:FS.RESEND}})}deleteErrorMessageReport(e){const t=this.getRetryMsgType(e.msgType);void 0!==t&&this.logAction999({type:"InteractManualRetry",payload:{msg_type:t,chat_type:this.getChatTypeFromConvId(e.conversationId),is_groupping:this.getMsgCombineType(e.msgType),is_entrypoint:AS[e.source],is_resend:kS.NO_RESEND,is_deleted:this.getMsgCombineType(e.msgType)===DS.GROUP?NS.DELETE_ALL:NS.DELETE_SINGLE,action_type:FS.DELETE}})}})||PS)||PS)||PS;a.ModuleContainer.registerSingleton(ES.a,jS);var US,BS=s("Z1oQ"),zS=s("QbTC"),GS=s("xtzN"),xS=s("n32m"),VS=s("hKna");let HS=Object(xi.b)(xS.RetryErrorController)(US=Reflect.metadata("design:type",Function)(US=Reflect.metadata("design:paramtypes",[])(US=class{constructor(){this.logger=void 0,this.errNetworkCounterMap=void 0,this.errNetworkCounterMap=new Map}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.autoRetry,["retry-error-controller"])),this.logger}getErrNetworkRetryCount(e){if(!e)return 0;const t=this.errNetworkCounterMap.get(e);if(void 0!==t)return 0===t?(this.errNetworkCounterMap.delete(e),0):t;const s=Ce.default.retryConfig.max_err_network_retry_count;return this.errNetworkCounterMap.set(e,s),s}decreaseErrNetworkRetryCount(e){if(!e)return;const t=this.getErrNetworkRetryCount(e);t>0?this.errNetworkCounterMap.set(e,t-1):this.errNetworkCounterMap.delete(e)}deleteErrNetworkRetryCountItem(e){e&&this.errNetworkCounterMap.delete(e)}logRetryError(e,t){this.Logger.zsymb(18,"_UP_GY",e,t)}shouldRetry(e,t,s){if(!e||VS.a.includes(e.code))return!1;if(!VS.c.includes(e.code))return!1;const a=VS.d.NO_NETWORK_ERROR_CODE.includes(e.code);if(a&&(!Ce.default.retry_err_no_network||le.b.getStateNetwork()!==le.a.CHECKING&&le.b.getStateNetwork()!==le.a.DISCONNECT))return!1;const i=this.getRetryErrorCodeGroupName(e.code);if(i&&this.getRetryErrorCodeMapping()[i].off)return!1;const n=a&&this.getErrNetworkRetryCount(s)>0;if(0===t.count&&!n)return!1;const r=this.getRetryTimeout(t);return!!(r&&Ct.default.getTimeNow()-t.timestamp<r)&&(t.count&&!a&&t.count--,a&&this.decreaseErrNetworkRetryCount(s),!0)}getRetryTimeout(e){let t=0;return Ce.default.retryConfig&&Ce.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===Y.RETRY_MSG_TIMEOUT_DEFAULT?t=Ce.default.retryConfig.time_retry_default:e.timeout===Y.RETRY_MSG_TIMEOUT_LONG&&(t=Ce.default.retryConfig.time_retry_long)),t}getRetryErrorCodeGroupName(e){return Object.keys(VS.d).find((t=>VS.d[t].includes(e)))}getNoRetryErrorCodeGroupName(e){return Object.keys(VS.b).find((t=>VS.b[t].includes(e)))}getRetryErrorCodeMapping(){return Ce.default.retryConfig.retry_strategy&&"object"==typeof Ce.default.retryConfig.retry_strategy?Object.keys(Ce.default.retryConfig.retry_strategy).reduce(((e,t)=>(e[t.toUpperCase()]=Ce.default.retryConfig.retry_strategy[t],e)),{}):VS.e}})||US)||US)||US;var WS,qS=s("yoj5");let KS=Object(xi.b)(zS.a)(WS=Reflect.metadata("design:type",Function)(WS=Reflect.metadata("design:paramtypes",[])(WS=class{constructor(){this.logger=void 0,this.waitingSocketOpenQueue=void 0,this.retryCountMapping=void 0,this.isDoneOffline=void 0,this.handleWaitingConnectionRetry=()=>{const e=[...this.waitingSocketOpenQueue];this.waitingSocketOpenQueue=[];for(const t of e){const e=qS.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.unlockProcessOffline=()=>{this.isDoneOffline=!0,My.default.getSocketState()===VS.g.OPEN&&this.handleWaitingConnectionRetry()},this.waitingSocketOpenQueue=[],this.retryCountMapping=new Map,this.isDoneOffline=!1,_e.default.subscribe(((e,t)=>{if(e===ve.WebsocketActions.CONNECTION_STATE_CHANGE){const{state:e,prevState:s}=t;void 0!==s&&e===VS.g.OPEN&&this.isDoneOffline&&this.handleWaitingConnectionRetry()}})),My.default.getChatHandler().subcribe(Ru.b.ON_DONE_OFFLINE,this.unlockProcessOffline)}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("auto-retry-socket",["retry-error-controller"])),this.logger}getRetryTimeout(e){let t=0;return Ce.default.retryConfig&&Ce.default.retryConfig.setting_feature&&e.timestamp&&e.timeout&&(e.timeout===Y.RETRY_MSG_TIMEOUT_DEFAULT?t=Ce.default.retryConfig.time_retry_default:e.timeout===Y.RETRY_MSG_TIMEOUT_LONG&&(t=Ce.default.retryConfig.time_retry_long)),t}getErrorCode(e){let t=e.code;return e.code===VS.f.ERR_CONNECTION_TIMED_OUT&&le.b.getStateNetwork()!==le.a.CONNECTED&&(t=VS.f.ERR_NO_NETWORK),t}shouldRetry(e,t,s){if(!e||!t||!s||s.count<=0)return!1;let a=this.getErrorCode(e);if(a===VS.f.ERR_CONNECTION_TIMED_OUT||a===VS.f.ERR_SOCKET_CLOSED||a===VS.f.ERR_NO_NETWORK){var i;const e=null!==(i=this.retryCountMapping.get(t))&&void 0!==i?i:0;let n=Ce.default.retryConfig.max_retry_count;if(a===VS.f.ERR_SOCKET_CLOSED&&(n=Ce.default.retryConfig.max_err_network_retry_count),void 0!==e&&e<n){const e=this.getRetryTimeout(s);return!!(e&&Ct.default.getTimeNow()-s.timestamp<e)&&(s.count&&s.count--,!0)}return!1}return!1}pushToRetryQueue(e,t,s){const i=a.ModuleContainer.resolve(BS.a).getRetryErrorCodeMapping();this.logRetryError(e.code,s);const n=this.getErrorCode(e);if(n!==VS.f.ERR_CONNECTION_TIMED_OUT){var r;if(n===VS.f.ERR_SOCKET_CLOSED||n===VS.f.ERR_NO_NETWORK)return this.retryCountMapping.set(s,null!==(r=this.retryCountMapping.get(s))&&void 0!==r?r:1),void this.waitingSocketOpenQueue.push(t)}else{var o,c;const e=(null!==(o=this.retryCountMapping.get(s))&&void 0!==o?o:0)+1,a=(null!==(c=i.CONNECTION_TIMED_OUT_ERROR_CODE.delay)&&void 0!==c?c:3e4)*e+qS.getGapTime();setTimeout((()=>{this.retryCountMapping.set(s,e),t()}),a)}}logRetryError(e,t){this.Logger.zsymb(18,"pRUugw",e,t)}cleanUpItemQueue(e){this.retryCountMapping.delete(e)}})||WS)||WS)||WS;a.ModuleContainer.registerSingleton(BS.a,HS),a.ModuleContainer.registerSingleton(zS.a,KS),a.ModuleContainer.registerSingleton(GS.a,class{constructor(){this.waitingNetworkQueue=void 0,this.waitingCheckStatusQueue=void 0,this.waitingTimeout=void 0,this.onConnectionBack=()=>{const e=[...this.waitingNetworkQueue];this.waitingNetworkQueue=[];for(const t of e){const e=qS.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.clearWaitingStatusTimeout=()=>{null!==this.waitingTimeout&&(window.clearTimeout(this.waitingTimeout),this.waitingTimeout=null)},this.moveWaitingCheckStatusToWaitingConnection=()=>{this.clearWaitingStatusTimeout(),this.waitingNetworkQueue.push(...this.waitingCheckStatusQueue),this.waitingCheckStatusQueue=[]},this.processWaitingCheckStatus=()=>{this.clearWaitingStatusTimeout();const e=[...this.waitingCheckStatusQueue];this.waitingCheckStatusQueue=[];for(const t of e){const e=qS.getGapTime();window.requestIdleCallback((()=>{t()}),{timeout:e})}},this.waitingNetworkQueue=[],this.waitingCheckStatusQueue=[],this.waitingTimeout=null,J.p.listenEvent(J.k,(e=>{e===le.a.CONNECTED?(this.processWaitingCheckStatus(),this.onConnectionBack()):e===le.a.DISCONNECT&&this.moveWaitingCheckStatusToWaitingConnection()}))}pushToRetryQueue(e){le.b.getStateNetwork()===le.a.CONNECTED?(this.waitingCheckStatusQueue.push(e),null===this.waitingTimeout&&(this.waitingTimeout=window.setTimeout((()=>{this.waitingTimeout=null,this.processWaitingCheckStatus()}),Ce.default.retryConfig.max_waiting_check_status_time))):this.waitingNetworkQueue.push(e)}});class ZS{static getMinNumberOfE2eeConvs(){var e;return null===(e=Ce.default.notify_missing_e2ee_message.conditions)||void 0===e?void 0:e.min_number_of_e2ee_convs}static isEnableEntryTransferFromE2ee(){return!0===Ce.default.notify_missing_e2ee_message.enable}}var $S;const QS=Object(a.define)("entries-transfer-metrics");let YS=Object(a.injectable)()($S=class{receiveChangeDeviceOnE2eeConvsSignal(){this.logAction(2090211)}receiveOverqueueMsgSignal(){this.logAction(2090210)}logAction(e){Ia.default.logAction(e)}logActionInfo(e){}})||$S;var JS;a.ModuleContainer.registerSingleton(QS,YS);Object(m.f)()(JS=Object(a.injectable)()(JS=Object(xi.b)(ym.b)(JS=function(e,t){return Object(a.inject)(QS)(e,void 0,0)}(JS=Reflect.metadata("design:type",Function)(JS=Reflect.metadata("design:paramtypes",[void 0===QS?Object:QS])(JS=class extends hs.b{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.entriesTransferManager,[w.ZLoggerNametags.e2eeNotifyMissingMsg])),this._Logger}constructor(e){super(),this.name=void 0,this.syncSourceQueueForSuggestTransfer=void 0,this._missingMessageEventList=void 0,this._Logger=void 0,this.metricts=void 0,this.name=ym.a,this.syncSourceQueueForSuggestTransfer=[],this._missingMessageEventList=[],this.metricts=e}get missingMessageEventList(){return this._missingMessageEventList}enSyncSourceQueueForSuggestTransfer(e){this.syncSourceQueueForSuggestTransfer.includes(e)||this.syncSourceQueueForSuggestTransfer.push(e),this.Logger.zsymb(0,"jSBXQr","[enSyncSourceQueueForSuggestTransfer] Push entry transfer in queue: "+JSON.stringify(e))}isEmptySyncSourceQueueForSuggestTransfer(){return 0===this.syncSourceQueueForSuggestTransfer.length}deSyncSourceQueueForSuggestTransfer(){return this.syncSourceQueueForSuggestTransfer.shift()}detectEntryTransferFromE2ee(){const e=ZS.isEnableEntryTransferFromE2ee();try{const t=gl.a.instance().getListUserE2ee();if(t&&t.length>=ZS.getMinNumberOfE2eeConvs())return e&&(this.enSyncSourceQueueForSuggestTransfer(om.j.E2EE_MISSING_MESSAGE),this.dispatchEvent(new $m.b($m.a.NotifyE2eeConvChangeDevice))),this.dispatchEvent(new $m.b($m.a.HasE2eeConvChangeDevice)),this.metricts.receiveChangeDeviceOnE2eeConvsSignal(),void this._missingMessageEventList.push(om.j.E2EE_MISSING_MESSAGE);this.dispatchEvent(new $m.b($m.a.NoE2eeConvChangeDevice))}catch(t){}}detectEntryTransferOverQueue(){const e=Ce.default.cross_setting.enableOverQueue;this._missingMessageEventList.push(om.j.OVERFLOW),e&&(this.enSyncSourceQueueForSuggestTransfer(om.j.OVERFLOW),this.dispatchEvent(new $m.b($m.a.NotifyOverqueue))),this.metricts.receiveOverqueueMsgSignal()}handlePublicEvents(e){switch(e.type){case $m.a.NotifyE2eeSessionChange:{var t;const s=null===(t=e.payload)||void 0===t?void 0:t.hasChanged;this.Logger.zsymb(0,"_21Lpa",`[handlePublicEvents] Receive notify e2e session change. isE2eeKeyChanged ${s}`),s?(this.Logger.zsymb(0,"3jUplG","[handlePublicEvents] Event change device"),this.detectEntryTransferFromE2ee()):this.dispatchEvent(new $m.b($m.a.NoE2eeConvChangeDevice));break}}}handleEventShowSuggestion(){this.detectEntryTransferOverQueue(),this.Logger.zsymb(0,"qEOzON","")}addPublicListeners(){this.addEventListener($m.a.NotifyE2eeSessionChange,this.handlePublicEvents.bind(this)),a.ModuleContainer.resolve(Jm.AFMC_TModule).get(Jm.AFMC_TController).addEventListener(Ym.a.SHOW_SYNC_MESSAGE_SUGGESTION,this.handleEventShowSuggestion.bind(this))}onAuthenticated(e){this.addPublicListeners()}getSyncSource(){const e=this.deSyncSourceQueueForSuggestTransfer();return e&&this.Logger.zsymb(0,"yW8kb2","[getSyncSource] Get sync source in queue: "+JSON.stringify(e)),e}})||JS)||JS)||JS)||JS)||JS);var XS=s("dhS6"),eC=s("WzIS"),tC=s("sLvT");const sC=e=>new Promise(((t,s)=>{setTimeout((()=>{t(e||3e3)}),e||3e3)}));var aC;let iC=Object(xi.b)(XS.a)(aC=Reflect.metadata("design:type",Function)(aC=Reflect.metadata("design:paramtypes",[])(aC=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.uiBannerController,[w.ZLoggerNametags.uiBannerQueue])),this._Logger}constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.queue=void 0,this.uiState=new Map,this.isFirtTriggerShowOnQueueCycle=void 0,this.timeoutNextBanner=void 0,this._Logger=void 0,this.name=XS.b,this.key="convId",this.queue=[],this.isFirtTriggerShowOnQueueCycle=!0,this.timeoutNextBanner=null}enBannerQueue(e,t){const s=this.queryBannerQueueItem(e.key);switch(s&&this.doRemoveBannerQueueItem(s.key),t){case eC.a.NORMAL:this.queue.push(e);break;case eC.a.HIGH:this.queue.unshift(e)}}isEmptySyncSourceQueue(){return 0===this.queue.length}deBannerQueue(){return this.queue.shift()}removeBannerQueueItem(e){this.queue=[...this.queue].filter((t=>t.key!==e))}doRemoveBannerQueueItem(e){this.removeBannerQueueItem(e),0===this.queue.length&&(this.isFirtTriggerShowOnQueueCycle=!0)}queryBannerQueueItem(e){return this.queue.find((t=>t.key===e))}handleShowUIBanner(e,t){Object(tC.b)().isEnableSingleUIBanner()?this.showSingleUI(e,t):this.showMultiUI(e,t)}isExistingShow(){try{const e=Object.fromEntries(this.uiState);for(const t in e)if(e[t])return t;return null}catch(e){return null}}async showSingleUI(e,t){let s;this.enBannerQueue({key:e,priority:t},t);const a=this.isExistingShow();if(a&&(s=this.queryBannerQueueItem(a)),Object(tC.b)().isEnableForceCloseNormalBanner()&&a&&t===eC.a.HIGH&&s)return this.uiState.set(s.key,!1),Object(nc.h)(this.name,s.key),this.uiState.set(e,!0),void Object(nc.h)(this.name,e);a||(this.uiState.set(e,!0),Object(nc.h)(this.name,e),this.Logger.zsymb(0,"pNF53k","[showSingleUI] Dont have displaying banner so show: "+e+", current queue = "+JSON.stringify(this.queue)))}showMultiUI(e,t){this.enBannerQueue({key:e,priority:t},t),this.uiState.set(e,!0),Object(nc.h)(this.name,e)}handleHideUIBanner(e){Object(tC.b)().isEnableSingleUIBanner()?this.hideSingleUI(e):this.hideMultiUI(e)}hideSingleUI(e){this.doRemoveBannerQueueItem(e),this.uiState.get(e)&&(this.uiState.set(e,!1),Object(nc.h)(this.name,e),this.timeoutNextBanner&&clearTimeout(this.timeoutNextBanner),this.timeoutNextBanner=setTimeout((()=>{const e=this.queue[0];e&&!this.isExistingShow()&&(this.uiState.set(e.key,!0),Object(nc.h)(this.name,e.key),this.Logger.zsymb(0,"JAlA0s","[hideSingleUI] Pop next banner to show: "+e.key+", current queue = "+JSON.stringify(this.queue)))}),Object(tC.b)().getTimeDelayOnNextBanner()))}hideMultiUI(e){this.doRemoveBannerQueueItem(e),this.uiState.set(e,!1),Object(nc.h)(this.name,e)}async onShowBanner(e,t,s){s&&await sC(s);const a=Object(tC.b)().getTimeDelayOnStartApp();this.isFirtTriggerShowOnQueueCycle&&a?(await sC(a),this.handleShowUIBanner(e,t)):this.handleShowUIBanner(e,t),this.isFirtTriggerShowOnQueueCycle=!1}async onHideBanner(e,t){t&&await sC(t),this.handleHideUIBanner(e)}getBannerList(){return this.queue}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this.uiState.get(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||aC)||aC)||aC;a.ModuleContainer.registerSingleton(XS.a,iC);var nC=s("LvDl"),rC=s.n(nC);var oC=()=>({version:1,max_num:2,enabled_banners:[{name:HI.a.PIN_TOPIC_BANNER,on:[HI.b.ONE_TO_ONE,HI.b.GROUP]},{name:HI.a.MY_CLOUD_BANNER,on:[HI.b.MY_CLOUD]},{name:HI.a.COMMUNITY_ENCOURAGE_BANNER,on:[HI.b.GROUP]},{name:HI.a.MUTE_BANNER,on:[HI.b.GROUP,HI.b.ONE_TO_ONE]},{name:HI.a.STRANGER_BANNER,on:[HI.b.ONE_TO_ONE]},{name:HI.a.BLOCKED_BANNER,on:[HI.b.ONE_TO_ONE]}],order_by:"desc",priority_matrix:[["6_6","6_6","5_6","6_4","6_5","6_6"],["0_0","0_0","6_6","6_5","0_0","0_0"]]});const cC=Object(a.define)("cbb-configuration");var lC;Object(a.injectable)()(lC=Object(a.singleton)(cC)(lC=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(lC=Reflect.metadata("design:type",Function)(lC=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(lC=class extends X.ZFeatureConfig{constructor(e){super({default:oC(),valiator:new X.ObjectValidator({version:X.Rule.field().number().min(1),max_num:X.Rule.field().number().min(0),enabled_banners:X.Rule.field().array("object"),order_by:X.Rule.field().string().oneOf(["asc","desc"]),priority_matrix:X.Rule.field().array("object")})}),this.chatBoxBannerConfigData_=void 0,this.logger_=void 0,this.logger_=e.createZLogger(w.ZLoggerNametags.cbbConfiguration,[w.ZLoggerNametags.manageCbbConfig])}getVersion(){return this.getChatBoxBannerConfigData_().version}getOrderingType(){return this.getChatBoxBannerConfigData_().orderBy}getMaxBannerCount(){return this.getChatBoxBannerConfigData_().maxBannerCount}getEnabledBannerConfigList(){return this.getChatBoxBannerConfigData_().enabledBannerConfigs}getEnabledBannerNameList(){return this.getChatBoxBannerConfigData_().enabledBannerConfigs.map((e=>e.name))}getDefaultBannerPriorities(){return this.getChatBoxBannerConfigData_().defaultBannerPriorities}getBannerPrioritiesMatrixByFullAppearences(){return this.getChatBoxBannerConfigData_().bannerPrioritiesMatrixByFullAppearences}getChatBoxBannerConfigData(){return this.getChatBoxBannerConfigData_()}getChatBoxBannerConfigData_(){return this.chatBoxBannerConfigData_||this.updateConfig_(),this.chatBoxBannerConfigData_}updateConfig_(){this.chatBoxBannerConfigData_||(this.chatBoxBannerConfigData_={});const{version:e,enabled_banners:t,priority_matrix:s,order_by:a,max_num:i}=this.config;this.chatBoxBannerConfigData_.version=e,this.chatBoxBannerConfigData_.orderBy=a,this.chatBoxBannerConfigData_.maxBannerCount=i,this.chatBoxBannerConfigData_.enabledBannerConfigs=t.map((e=>{var t,s;return{name:null!==(t=e.name)&&void 0!==t?t:"",enabledOn:null!==(s=e.on)&&void 0!==s?s:[]}}));const n=s.reduce(((e,s)=>{if(Array.isArray(s)&&s.length===t.length){const t=s.map((e=>this.parseCellStringToMatrixCellObject_(e)));e.push(t)}return e}),[]);this.chatBoxBannerConfigData_.defaultBannerPriorities=n[0],this.chatBoxBannerConfigData_.bannerPrioritiesMatrixByFullAppearences=n.slice(1)}parseCellStringToMatrixCellObject_(e){const t={priority:0,subPriority:0};if(!e||"string"!=typeof e)return t;const s=e.split("_"),a=(e,t)=>{try{const t=parseInt(e);if(!isNaN(t))return t}catch(s){this.logger_.zsymb(18,"dJfoOZ",`[parseIntSafely]: ${s.message}`)}return t};return t.priority=a(s[0],0),t.subPriority=a(s[1],0),t}generateDefaultMatrixCellObjectArray_(e){return Array.from({length:e},(()=>({priority:0,subPriority:0})))}selector(e){return e.chat_box_banner||{}}listener(e){const t=this.selector(e);if(!t)return;if(null==t.version)return;let s=null;if(t.version!==oC().version)s=oC();else{let e="Valid"===this.options.valiator.validate(t);if(e){const s=t.enabled_banners.length;for(let a=0;a<t.priority_matrix.length;a++){if(s!==t.priority_matrix[a].length){e=!1;break}}}s=e?t:null}if(!s)return;this.shouldConfigUpdate(this.config,s)&&(this.config=s,this.updateConfig_(),this.dispatchEvent(new X.UpdateConfigEvent(s)))}shouldConfigUpdate(e,t){return!new E.g.Comparer(e,t,!0).AND("version").AND("max_num").AND("order_by").AND("enabled_banners",rC.a.isEqual).AND("priority_matrix",rC.a.isEqual).exec()}})||lC)||lC)||lC)||lC);const dC=Object(a.define)("cbb-app-service");var uC;Object(a.injectable)()(uC=Object(a.singleton)(dC)(uC=function(e,t){return Object(a.inject)(cC)(e,void 0,0)}(uC=Reflect.metadata("design:type",Function)(uC=Reflect.metadata("design:paramtypes",["undefined"==typeof IChatBoxBannerConfiguration?Object:IChatBoxBannerConfiguration])(uC=class{constructor(e){this.chatBoxBannerConfiguration_=void 0,this.chatBoxBannerConfiguration_=e}isBannerEnabled(e,t){const{convType:s}=t;let a=this.chatBoxBannerConfiguration_.getEnabledBannerConfigList().find((t=>t.name===e));if(!a)return!1;const{enabledOn:i}=a;return i.includes(s)||i.includes(HI.b.ALL)}addBannerNameToBannerNameList(e,t){if(!Array.isArray(t)||t.length<=0)return[e];return this.processRawBannerNameList_([...t,e],e)}removeBannerNameFromBannerNameList(e,t){if(!Array.isArray(t)||t.length<=0)return[];if((t=t.filter((t=>t!==e))).length<=1)return t;return this.processRawBannerNameList_(t)}getMaxBannerCount(){return this.chatBoxBannerConfiguration_.getMaxBannerCount()}getVersion(){return this.chatBoxBannerConfiguration_.getVersion()}getOrderingType(){return this.chatBoxBannerConfiguration_.getOrderingType()}getChatBoxBannerConfigData(){return this.chatBoxBannerConfiguration_.getChatBoxBannerConfigData()}processRawBannerNameList_(e,t){const s={};e.forEach((e=>{s[e]=!0}));const a=this.chatBoxBannerConfiguration_.getEnabledBannerNameList(),i=this.chatBoxBannerConfiguration_.getBannerPrioritiesMatrixByFullAppearences();let n=!1,r=Array.from({length:a.length},(()=>({priority:0,subPriority:0,bannerName:HI.a.UNKNOWN})));if(i.length>0)for(let h=0;h<i.length&&!n;h++){const e=i[h];for(let t=0;t<e.length;t++){const i=e[t],o=a[t];if(!(s[o]&&i.priority>0&&i.subPriority>0||!s[o]&&0===i.priority&&0===i.subPriority)){n=!1;break}if(r[t]=Object(I.a)(Object(I.a)({},i),{},{bannerName:o}),t===e.length-1){n=!0;break}}}if(!n){this.chatBoxBannerConfiguration_.getDefaultBannerPriorities().forEach(((e,t)=>{const i=a[t];s[i]?r[t]=Object(I.a)(Object(I.a)({},e),{},{bannerName:i}):r[t]={priority:0,subPriority:0,bannerName:HI.a.UNKNOWN}}))}r=r.filter((e=>e.bannerName!==HI.a.UNKNOWN&&0!==e.priority&&0!==e.subPriority));const o={};r.forEach((e=>{const s=e.priority;(!o[s]||o[s].subPriority<e.subPriority||o[s].subPriority===e.subPriority&&o[s].bannerName!==t&&e.bannerName===t)&&(o[s]=e)}));const c=Object.values(o),l="asc"===this.chatBoxBannerConfiguration_.getOrderingType()?1:-1,d=c.sort(((e,t)=>(e.priority-t.priority)*l)),u=this.chatBoxBannerConfiguration_.getMaxBannerCount();return d.slice(0,u).map((e=>e.bannerName))}})||uC)||uC)||uC)||uC);var hC=s("ShRB"),gC=s("wx14"),mC=s("AZMc"),pC=s("XnQq"),fC=s("eHWI");const vC=e=>{const{toggleBlock:t,reportUser:s,topBannerRef:a,pendingFriendRequest:i}=e,n=Object(fC.a)(t,i?2390304:2390104),r=Object(fC.a)(s,i?2390305:2390105);return Mr.a.createElement(pC.a,{status:"info",iconOptions:{name:"Block_24_Line"},titleTextKey:"STR_YOU_BLOCK_TITLE",contentTextKey:"STR_YOU_BLOCK_DESC",htmlTitle:ce.a.str("STR_YOU_BLOCK_DESC"),maxContentLines:1,closable:!1,alignment:"space-between",actions:[{type:"button",variant:"neutral",textKey:"STR_UNBLOCK",onClick:n},{type:"button",variant:"secondary-danger",textKey:"STR_REPORT_USER",onClick:r}],ref:a})};var _C=Mr.a.forwardRef(((e,t)=>Mr.a.createElement(vC,Object(gC.a)({},e,{topBannerRef:t})))),bC=s("AHNY"),IC=s("o5gc"),yC=s("sB1e");const SC=(e,t,s)=>{const[a,i]=Mr.a.useState(Ii.default.isBlocked(t));return Object(bC.a)(((e,s)=>{switch(e){case ve.ConversationListActions.BLOCK_CONVERSATION:s&&s.userId===t&&i(s.blocked);break;case ve.FetchActions.STATUS_BLOCKED_CHANGED:s&&s.includes(t)&&i(Ii.default.isBlocked(t))}}),[t]),Mr.a.useEffect((()=>{i(Ii.default.isBlocked(t))}),[t]),Mr.a.useEffect((()=>{s&&i(s.isBlocked)}),[s]),{isBlocked:a,toggleBlock:()=>{if(le.b.getStateNetwork()==le.a.DISCONNECT)mc.default.createWarning(ce.a.str("STR_NET_SSL_DATE_ERROR_TITLE"));else{let s=a;i(!s),Ii.default.blockFriend(t,s?Y.UNSET_BLOCK:Y.SET_BLOCK).then((()=>{s||mc.default.createSuccess(ce.a.str("STR_YOU_BLOCK_SUCCESS")),e({type:ve.ConversationListActions.BLOCK_CONVERSATION,payload:{blocked:!s,userId:t}})})).catch((()=>{i(s)}))}}}},CC=(e,t)=>Mr.a.useCallback(((e,t,s)=>{a.ModuleContainer.resolve(IC.d).onOpenReport(e);const i={userId:e,report:{item:s,view:Y.PROFILE_INIT_MODE.REPORT_USER}};Ie.ModalManagerV2.openModal({windowId:t,name:Y.ModalIdentitiesDefine.FRIEND_PROFILE,params:i})}),[e,t]);var EC=s("7okM"),OC=s("+JmS");const MC=Mr.a.forwardRef(((e,t)=>{const{convId:s,windowId:a}=e,{isPendingFriendRequest:i}=Object(EC.g)(s),{friendInfo:n}=Object(EC.d)(s),r=Object(OC.a)(),o=CC(a,s),{toggleBlock:c}=SC(r,s,n);return Mr.a.createElement(_C,{ref:t,reportUser:()=>o(s,a,{}),toggleBlock:c,pendingFriendRequest:i})}));var TC=s("/MKj");var RC=Mr.a.forwardRef((function(e,t){const{convId:s,myId:i,windowId:n,pendingFriendRequest:r,friendRequestSent:o=!1,dispatch:c,toggleBlock:l,reportUser:d}=e,u=Mr.a.useRef(null),h=Mr.a.useRef(a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger("messageView",["stranger-banner"])),{userRank:g,fallback:m}=((e,t,s=!1,a)=>{const[i,n]=Mr.a.useState(yC.f),[r,o]=Mr.a.useState(!1),c=Mr.a.useCallback((()=>{n(yC.f),o(!0)}),[]);return Mr.a.useEffect((()=>{let i=!1;return Ng.a.getStrangerBannerInfo(e,t).then((e=>{if(!i)if(e.data_render)n(e);else switch(e.rank_type||e.userRank){case yC.e.GRAY:n(s?yC.d:yC.c);break;case yC.e.BLACK:n(s?yC.b:yC.a);break;case yC.e.WHITE:default:n(yC.f)}})).catch((e=>{a(e)})),()=>{i=!0}}),[e,t,s]),{userRank:i,fallback:r,fallbackDefault:c}})(s,i,!!r,(e=>h.current.zsymb(20,"oErvx4","[error get rank user] "+(null==e?void 0:e.err_msg)))),[,p]=Mr.a.useState(!1);Mr.a.useEffect((()=>{r&&a.ModuleContainer.resolve(Jf.c).onSeenBannerFriendRequest(s)}),[r,s]);const f=Object(fC.a)((()=>{d()}),r?2390306:2390106,r?7:3,{rank:g.rank_type}),v=Object(fC.a)((e=>{const t=e[0];u&&u.current&&u.current.show(t,t.target),t.preventDefault(),t.stopPropagation()}),r?2390302:2390102),_=Object(fC.a)(Mr.a.useCallback((()=>{a.ModuleContainer.resolve(Fg.b).acceptFriendRequest(s,n)}),[s]),2390301,5,{rank:g.rank_type}),b=Mr.a.useCallback(((e,t)=>{ye.a.setFriendRequestSource(e,Y.FRIEND_REQUEST_SRC_CHAT,{uidTo:e}),Ng.a.doAddFriend(e,Y.FRIEND_REQUEST_SRC_CHAT,t,n)}),[]),I=Object(fC.a)((()=>{b(s,c)}),2390101,r?7:1,{rank:g.rank_type}),y=Object(fC.a)((()=>{l()}),r?2390303:2390103,r?6:2,{rank:g.rank_type}),S=Mr.a.useCallback((e=>{e.preventDefault(),e.stopPropagation(),pc.ConfirmManagerV2.openConfirm({windowId:n,name:Y.MODAL_CONFIRM.confirmIdentities,params:{title:ce.a.str("STR_CONTACT_TAB_TITLE_RECALL_REQ"),message:ce.a.str("STR_CONTACT_TAB_CONFIRM_RECALL_REQ"),okText:ce.a.str("STR_CONTACT_TAB_OKE_TEXT_RECALL_REQ"),cancelText:ce.a.str("STR_CONTACT_TAB_CANCEL_TEXT_RECALL_REQ"),okType:"danger",cancelType:"neutral",onOk:()=>{a.ModuleContainer.resolve(Jf.o).onRemoveFriendSent({userId:s})}}})}),[s]),C=Mr.a.useCallback((()=>p((e=>!e))),[]);var E;E=C,Mr.a.useEffect((()=>(ce.a.callUpdate(E),()=>{ce.a.removeUpdate(E)})),[]);const O=Mr.a.useMemo((()=>({block:{textKey:"STR_BLOCK_USER",onclick:y},report:{textKey:"STR_REPORT_USER",onclick:f}})),[s,n,!!r]),M=[];g.data_render&&g.data_render.menu&&Array.from(Object.keys(g.data_render.menu)).forEach((e=>{var t,s;!g.data_render.menu[e].show||g.data_render.buttons&&null!==(t=g.data_render)&&void 0!==t&&null!==(s=t.buttons[e])&&void 0!==s&&s.show||M.push(O[e])}));let T="",R="";const w=ce.a.getCurrentLanguageName();g.data_render&&(g.data_render.title&&g.data_render.title.vi&&(T=g.data_render.title[w]),g.data_render.desc&&g.data_render.desc.vi&&(R=g.data_render.desc[w]));const L=e=>Mr.a.createElement(Qy.default,{popoverProps:{identity:{windowId:n,name:Y.PopoverIdentitiesDefine.CHAT_BOX_LIST_1},placement:"bottom-right",deltaPosition:{top:"8px",left:"5px"}},ref:u,items:e});let D=null;if(g.rank_type===yC.e.WHITE||m)if(o)D=Mr.a.createElement(pC.a,{status:"info",iconOptions:{name:"FriendReq_24_Line"},closable:!1,contentTextKey:"STR_PROFILE_FRIEND_REQ_SENT",alignment:"start",maxContentLines:1,ref:t});else{let e="btn_Chat_AddFrd",s="AddUser_24_Line",a="STR_PROFILE_ADD_FRIEND_LONG";r&&(e="btn_Chat_AcceptFrdReq",s="FriendReq_24_Line",a="STR_FRIEND_REQ_ACCEPT_DESC"),D=Mr.a.createElement(Mr.a.Fragment,null,Mr.a.createElement(pC.a,{status:"info",iconOptions:{name:s},contentTextKey:a,"data-id":e,closable:!1,maxContentLines:1,alignment:"space-between",actions:[{type:"button",variant:r?"secondary":"neutral",textKey:r?"STR_ACCEPT":"STR_FRIEND_REQ_SEND",onClick:r?_:I},{type:"button",variant:"tertiary-neutral",icon:"More_24_Line",onClick:v}],ref:t}),L(Object.values(O)))}else{var A,F;let e="STR_FRIEND_REQ_SEND",s=I;o?(e="STR_UNDO_REQUEST",s=S):r&&(e="STR_ACCEPT",s=_);const a=[];a.push({textKey:e,onClick:s,type:"button",variant:(null===(A=g.data_render.buttons)||void 0===A||null===(F=A.add)||void 0===F?void 0:F.type)||"neutral"}),g.data_render.buttons.block&&g.data_render.buttons.block.show&&a.push({textKey:"STR_BLOCK_STRANGER_BANNER",onClick:y,type:"button",variant:g.data_render.buttons.block.type||"neutral"}),g.data_render.buttons.report&&g.data_render.buttons.report.show&&a.push({textKey:"STR_REPORT_USER",onClick:f,type:"button",variant:g.data_render.buttons.report.type||"secondary-danger"}),M.length&&a.push({type:"button",variant:"tertiary-neutral",icon:"More_24_Line",onClick:v}),D=Mr.a.createElement(Mr.a.Fragment,null,Mr.a.createElement(pC.a,{status:"info",iconOptions:{name:"Warning_Circle_24_Line"},titleTextKey:T,contentTextKey:R,maxContentLines:1,closable:!1,actions:a,alignment:"space-between",ref:t}),M.length?L(M):null)}return D}));const wC=e=>e.user.userId,LC=Mr.a.forwardRef(((e,t)=>{const{windowId:s,convId:a}=e,{friendInfo:i}=Object(EC.d)(a),{isPendingFriendRequest:n}=Object(EC.g)(a),{isFriendRequestSent:r}=Object(EC.f)(a),o=Object(OC.a)(),c=CC(s,a),{toggleBlock:l}=SC(o,a,i),d=Object(TC.g)(wC);return Mr.a.createElement(RC,{ref:t,reportUser:()=>c(a,s,{}),convId:a,myId:d,windowId:s,toggleBlock:l,pendingFriendRequest:n,friendRequestSent:r,dispatch:o})})),DC=Mr.a.forwardRef(((e,t)=>{const{convId:s}=e,{startTime:a,duration:i}=Object(nc.l)(Nn.MuteDataManager,s,(e=>e?{startTime:e.startTime,duration:e.duration}:{startTime:0,duration:-1})),n=Mr.a.useMemo((()=>ui.default.getHMTime(a,i)||""),[a,i]),r=n?`${ce.a.str("STR_MUTE_TIME_LIMIT_V2")} ${n}`:`${ce.a.str("STR_MUTE_TIME_LIMIT_FULL_V2")}`;return Mr.a.createElement(pC.a,{ref:t,className:"mute-banner",htmlTitle:r,maxContentLines:1,status:"info",iconOptions:{name:"Notif_Off_24_Line"},alignment:"space-between",content:n?Mr.a.createElement(Mr.a.Fragment,null,Mr.a.createElement(Rr.a,{textKey:"STR_MUTE_TIME_LIMIT_V2"})," ",` ${n}`):Mr.a.createElement(Rr.a,{textKey:"STR_MUTE_TIME_LIMIT_FULL_V2"}),actions:[{onClick:()=>(e=>{me.a.MuteDataManager.onUnMute(e),Ia.default.logAction(1065101)})(s),textKey:"STR_REOPEN_0",type:"button",variant:"secondary"}],closable:!1})}));var AC=s("YCoq"),FC=s("ro+J"),kC=s("17x9"),NC=s.n(kC),PC=s("iuhU"),jC=s("i8i4"),UC=s.n(jC),BC=s("dRu9"),zC=s("2pdp"),GC=s("yh7P"),xC=s("n39p");const VC=function(e){const{conversationId:t,textContent:s="",hasCollapseButton:a}=e;let i=null;return a&&(i=Mr.a.createElement(wr.a,{className:"collapse-button-container",onClick:e=>{e&&e.stopPropagation(),Object(eg.c)(xC.a.PinBoard.COLLAPSE_BY_CLICK_BUTTON),GC.a.getInstance(t).collapseBoard()},textKey:"STR_COLLAPSE",postIcon:"Chevron_Up_24_Line",size:"small",type:"tertiary-neutral"})),Mr.a.createElement("div",{className:"title-container"},Mr.a.createElement(Rr.a,{className:"title-content",textKey:`${s}`}),i)};VC.propTypes={conversationId:NC.a.string,textContent:NC.a.string.isRequired,hasCollapseButton:NC.a.bool};var HC=VC;const WC=function(e){const{topic:t={},hasCollapseButton:s}=e;return Mr.a.createElement(Mr.a.Fragment,null,t?Mr.a.createElement("div",{className:"upcoming"},Mr.a.createElement(HC,{textContent:"Sắp diễn ra",hasCollapseButton:s}),Mr.a.createElement(zC.a,{windowId:e.windowId,topic:t,isShowFullTime:!0})):null)};WC.propTypes={topic:NC.a.object,hasCollapseButton:NC.a.bool};var qC=WC,KC=s("vA3+"),ZC=s("c7k8"),$C=s("YbZ6"),QC=s("1CKO");const YC=function(e){const{conversationId:t,topics:s=[],hasUpcoming:a}=e,{selfWindow:i}=Object(QC.a)(),[n,r]=Object(Or.useState)(i.innerHeight),o=Object(Or.useRef)(),c=Object(Or.useRef)(),l=Object(Or.useRef)(),d=Object(Or.useCallback)((()=>{var e;null===(e=o.current)||void 0===e||e._onResize()}),[o.current]),u=Object(Or.useCallback)(Object($C.a)((()=>{const e=i.innerHeight;e&&r(e)}),150),[i.innerHeight]),h=Object(Or.useCallback)((()=>{GC.a.getInstance(t).closePopover()}),[]);Object(Or.useEffect)((()=>(i.addEventListener("resize",d),i&&o&&(l.current=o.current._parentNode,c.current=new i.ResizeObserver(d),c.current.observe(l.current)),()=>{i.removeEventListener("resize",d),l.current&&c.current.unobserve(l.current)})),[i]);let g=[];for(let f=0;f<s.length;f++){const a=s[f];a&&g.push(Mr.a.createElement(zC.a,{windowId:e.windowId,conversationId:t,key:f,topic:a,index:f,isShowFullTime:a.startTime>0,size:xC.i.LARGE,mode:xC.h.EXPAND}))}const m=s.length*xC.b,p=Object(eg.f)(n,a);return Mr.a.createElement("div",{className:"board-list",style:{maxHeight:p,height:m}},Mr.a.createElement(ZC.a,{onResize:u,ref:o},(({width:e,height:t})=>Mr.a.createElement(KC.c,{onScroll:h,noVScroll:!1,noHScroll:!0,autoHide:!0,style:{width:e+1,height:t+2}},Mr.a.createElement("div",{tabIndex:"100"},g)))))};YC.propTypes={conversationId:NC.a.string,topics:NC.a.array.isRequired,hasUpcoming:NC.a.bool};var JC=YC,XC=s("AbDx"),eE=s("zRkS");const tE=function(e){const{conversationId:t}=e,s=Object(XC.a)(Object(OC.b)(),t);return Mr.a.createElement("div",{className:"view-all-board-container",onClick:e=>{Object(eg.c)(xC.a.PinBoard.CLICK_VIEW_ALL_GROUP_BOARD),GC.a.getInstance(t).closePopover(),s.emit(ve.GeneralActions.OPEN_MEDIA_BOARD,{type:ve.GeneralActions.OPEN_GROUP_BOARD_ALL,uid:t}),GC.a.getInstance(t).collapseBoard(),e&&(e.preventDefault(),e.stopPropagation())}},Mr.a.createElement("div",{className:"view-all-board-content"},Mr.a.createElement(Rr.a,{className:"view-all-board-text-content",textKey:_v.a.get("STR_VIEW_ALL_IN_BOARD",t)}),Mr.a.createElement(eE.a,{icon:"Chevron_Right_24_Line",className:"view-all-board-icon"})))};tE.propTypes={conversationId:NC.a.string};var sE=tE;function aE(e,t){const{conversationId:s,topics:a=[],upcomingEvent:i}=e,n=a;let r=null;return Object(AC.i)()&&i&&(r=Mr.a.createElement(qC,{windowId:e.windowId,topic:i,hasCollapseButton:!0})),Mr.a.createElement("div",{ref:t,className:"topic-board-details"},r,Mr.a.createElement(HC,{conversationId:s,textContent:ce.a.trans("STR_PIN_BOARD",[n.length]),hasCollapseButton:!r}),Mr.a.createElement(JC,{windowId:e.windowId,conversationId:s,topics:n,hasUpcoming:!!r}),Mr.a.createElement(sE,{conversationId:s}))}const iE=Mr.a.forwardRef(aE);iE.propTypes={conversationId:NC.a.string,topics:NC.a.array.isRequired,upcomingEvent:NC.a.object};var nE=iE,rE=s("Cl2u");const oE="topic-board-details-wrapper",cE={Block:oE,Modifiers:{Transitioning:"--"},Elements:{Overlay:`${oE}__overlay`}},lE=e=>{var t;const{selfWindow:s}=Object(QC.a)(),a=null!==(t=s.document.getElementById("messageView"))&&void 0!==t?t:s.document.body,i=Mr.a.useRef(null);return Mr.a.createElement(BC.d,{nodeRef:i,in:e.show,appear:!0,unmountOnExit:!0,addEndListener:e=>{var t;null===(t=i.current)||void 0===t||t.addEventListener("transitionend",e,!1)}},(t=>UC.a.createPortal(Mr.a.createElement("div",{className:Object(PC.a)(cE.Block,e.className,`${cE.Modifiers.Transitioning}${t}`)},Mr.a.createElement(rE.a,{nodeRef:i,state:t},((t,s)=>Mr.a.createElement(nE,{ref:s,windowId:e.windowId,conversationId:e.convId,topics:e.topics,dispatch:e.dispatch,upcomingEvent:e.upcomingEvent}))),Mr.a.createElement("div",{className:cE.Elements.Overlay,onClick:e.onCollapse})),a)))};const dE=function(e){const{conversationId:t,topic:s,numberOfMoreTopics:a,hasUnread:i,isHighlighted:n}=e;return Mr.a.createElement("div",{className:"chat-group-topic__preview"},Mr.a.createElement("div",null,Mr.a.createElement(zC.a,{windowId:e.windowId,conversationId:t,topic:s,isInPreview:!0,numberOfMoreTopics:a,hasUnread:i,size:xC.i.LARGE,mode:xC.h.PREVIEW,isHighlighted:n,index:-1,isShowFullTime:!0,emitter:e.emitter})))};dE.propTypes={conversationId:NC.a.string,topic:NC.a.object.isRequired,numberOfMoreTopics:NC.a.number,hasUnread:NC.a.bool,isHighlighted:NC.a.bool};var uE=dE,hE=s("kQ1Y"),gE=s("Lqdh");const mE="Preview",pE="Details";function fE(e,t){const{conversationId:s,topics:a=[],upcomingEvent:i,dispatch:n=(()=>{}),confirm:r=(()=>{}),settings:o={}}=e;if(0===(null==a?void 0:a.length)&&!i)return null;const[c,l]=Object(Or.useState)(mE),[d,u]=Object(Or.useState)(!1),h=()=>{l(mE)},g=()=>{var e;const t=null===(e=Xh.a.getInstance(s).getConversation())||void 0===e?void 0:e.userId;Xh.a.getInstance(s).fetchTopicsOnOpenBoardDetails(t);l(pE)},m=e=>{u(e)},p=e=>{var t;if(c===mE)return;let s=!0;if(null!=e&&null!==(t=e.detail)&&void 0!==t&&t.from&&"PopoverButton"===e.detail.from&&(s=!1),s){{const e=Re.default.getFullDiskChatPopupNoti();if((null==e?void 0:e.level)===kn.g.FULL&&(null==e||!e.dissmis))return}Object(eg.c)(xC.a.PinBoard.COLLAPSE_BY_CLICK_OUTSIDE),h()}};function f(){return e.selfWindow||window}Object(Or.useEffect)((()=>{hE.a.setDispatch(s,n),hE.a.setConfirm(s,r),hE.a.setCollapse(s,h),hE.a.setExpandBoard(s,g),hE.a.setToggleHighlightPreview(s,m);const e=gE.default.registerFunc(Y.K_ESC,(()=>{{const e=Re.default.getFullDiskChatPopupNoti();if((null==e?void 0:e.level)===kn.g.FULL&&(null==e||!e.dissmis))return}Object(eg.c)(xC.a.PinBoard.COLLAPSE_BY_ESC),h()}));return()=>{gE.default.unregister(Y.K_ESC,e),hE.a.removeCallbacks(s)}}),[s]),Object(Or.useEffect)((()=>(f().addEventListener("click",p),()=>{f().removeEventListener("click",p)})),[c]),Object(Or.useEffect)((()=>{GC.a.getInstance(s).callUpdateComp()}),[o]);const v=Object(eg.g)(a)||i,_=null!=a&&a.length?a.length-1:0,b=Object(eg.l)(a);return Mr.a.createElement(FC.a,null,Mr.a.createElement("div",{className:"chat-group-topic",onClick:e=>{e&&e.stopPropagation()},ref:t},Mr.a.createElement(uE,{windowId:e.windowId,conversationId:s,topic:v,numberOfMoreTopics:_,dispatch:n,confirm:r,hasUnread:b,isHighlighted:d,emitter:e.emitter}),Mr.a.createElement(lE,{show:c===pE,windowId:e.windowId,convId:s,topics:a,dispatch:n,upcomingEvent:i,onCollapse:h})))}const vE=Object(Or.forwardRef)(fE);vE.propTypes={conversationId:NC.a.string,topics:NC.a.array.isRequired,upcomingEvent:NC.a.object,dispatch:NC.a.func,confirm:NC.a.func,settings:NC.a.object};var _E=vE,bE=s("medu"),IE=s("Ssn2");const yE=Mr.a.forwardRef(((e,t)=>{const{convId:s,windowId:a,confirm:i}=e,{selfWindow:n}=Object(QC.a)(),r=Object(Or.useMemo)((()=>Object(IE.a)(s)),[s]),o=Jh.a.getTopics(s),{groupInfo:c}=Object(EC.e)(s),l=Object(OC.a)(),d=Object(OC.b)();let u=null;if(r){let e=!1,r=null;var h;if(o.length>0)e=!0;else if(Object(AC.i)())r=Xh.a.getInstance(s).getUpcomingEvent(),null!==(h=r)&&void 0!==h&&h.id&&(e=!0);e&&(u=Mr.a.createElement(FC.a,null,Mr.a.createElement("div",{ref:t,className:"chat-group-topic-outer"},Mr.a.createElement(_E,{key:s,confirm:i,conversationId:s,dispatch:l,emitter:d,selfWindow:n,settings:null==c?void 0:c.setting,upcomingEvent:r,topics:o,windowId:a}))))}else u=Mr.a.createElement(bE.b,{key:s,ref:t,conversationId:s,dispatch:l});return u}));var SE=s("Sn9s");const CE=Mr.a.forwardRef(((e,t)=>{const s=Object(nc.l)(el.e,e.convId);return Mr.a.createElement(SE.e,{ref:t,windowId:e.windowId,position:el.f.CHAT_BOX,type:null==s?void 0:s.bannerStatus.type,groupId:e.convId})}));var EE=s("YbKq"),OE=s("85uQ"),ME=s("Ilka"),TE=s("FLoU"),RE=s("Ov6d"),wE=s("93l+"),LE=s("KJYm"),DE=s("4ZGW");const AE=Mr.a.forwardRef(((e,t)=>{const{windowId:s,convId:a}=e,{status:i,showBanner:r,dismissBanner:o}=Object(wE.a)();let{usage:c=0,quota:l=0}=Object(DE.a)()||{usage:0,quota:0};const d=Math.round(c/l*100),u=ui.default.sizeToStringV2(l-c),h=Mr.a.useMemo((()=>Math.pow(Object(ME.d)(),2)),[]);Mr.a.useEffect((()=>{r&&(i===OE.a.NEARY_FULL?LE.a.logViewMyCloudBanner({quota_warning_name:"yellow"}):i===OE.a.FULL?LE.a.logViewMyCloudBanner({quota_warning_name:"full"}):i===OE.a.ALMOST_FULL&&LE.a.logViewMyCloudBanner({quota_warning_name:"red"}))}),[i,r]);const g={source:TE.b.CSC,mycloud_size:c/h};function m(){Object(RE.a)(s),ue.a.getInstance().loadMyCloudMessagesInBackground(),function(){let e;const t=n.default.getInstance(),s="1st_cl_tool";t.getItemForCurrentUser(s)||(e=(new Date).toLocaleDateString("fr-CA").replaceAll("-",""),t.setItemForCurrentUser(s,e))}(),LE.a.logClickBannerButtons()}function p(){o()}return(e=>{let s,a,i,n,r,o,c="info",l=!1;switch(e){case OE.a.NEARY_FULL:s=EE.a.NEARLY,a="STR_CLOUD_BANNER_NEARLY_FULL_TITLE",i="STR_CLOUD_BANNER_NEARLY_FULL_DESC",n="STR_CLOUD_MANAGE_DATA",l=!0,r=[d,Ii.default.getDName(Ce.default.sendToMeId)],o=[Ii.default.getDName(Ce.default.sendToMeId)],g.warning=TE.d.YELLOW,c="warning";break;case OE.a.ALMOST_FULL:s=EE.a.ALMOST,a="STR_CLOUD_BANNER_ALMOST_FULL_TITLE",i="STR_CLOUD_BANNER_ALMOST_FULL_DESC",n="STR_CLOUD_MANAGE_DATA",r=[u,Ii.default.getDName(Ce.default.sendToMeId)],g.warning=TE.d.RED,c="error";break;case OE.a.FULL:s=EE.a.FULL,a="STR_CLOUD_BANNER_FULL_TITLE",i="STR_CLOUD_BANNER_FULL_DESC",n="STR_CLOUD_MANAGE_DATA",r=[Ii.default.getDName(Ce.default.sendToMeId)],g.warning=TE.d.FULL,c="error";break;default:return null}return Mr.a.createElement(Mr.a.Fragment,null,Mr.a.createElement(pC.a,{ref:t,className:"cloud-banner",titleTextKey:a,titleArgs:r,contentTextKey:i,contentArgs:o,status:c,iconOptions:{name:"warning-24"},alignment:"space-between",actions:n?[{onClick:m,textKey:n,type:"button",variant:"outline-tertiary-neutral"}]:void 0,closable:l,onClose:p}))})(i)}));var FE=s("ZSw7");class kE{constructor(){this.version=void 0}render(e,t){return this.checkIfShouldShowBannersOrNot(e),this.createChatBoxBannerView(e,t)}checkIfShouldShowBannersOrNot(e){const{convId:t,windowId:s}=e;var i;Object(Or.useEffect)((()=>{const e=a.ModuleContainer.resolve(mC.a).getBannerManagers();if(e.length>0){const i=a.ModuleContainer.resolve(WI.a);e.forEach((e=>{e.checkShowMyBanners(t,s).forEach((e=>{e.shouldShow?i.requestShowBanner(e.bannerName,{convId:t}):i.requestHideBanner(e.bannerName,{convId:t})}))}))}}),[t,s]),(e=>{const{friendInfo:t}=Object(EC.d)(e),{isBlocked:s}=SC((()=>{}),e,t),i=Object(Or.useMemo)((()=>Object(IE.a)(e)),[e]);Object(Or.useEffect)((()=>{const n=a.ModuleContainer.resolve(WI.a);0!==Ce.default.block_msg_call_setting.enable_block_msg_call_setting||!s||i||ui.default.isOAType(t)?n.requestHideBanner(HI.a.BLOCKED_BANNER,{convId:e}):n.requestShowBanner(HI.a.BLOCKED_BANNER,{convId:e})}),[s,e,t])})(t),(e=>{const{friendInfo:t}=Object(EC.d)(e),{isBlocked:s}=SC((()=>{}),e,t);Object(Or.useEffect)((()=>{if(t){const{isFr:i,type:n}=t,r=!i&&n===Y.FRIEND_TYPE_NORMAL,o=a.ModuleContainer.resolve(WI.a);r&&!s?o.requestShowBanner(HI.a.STRANGER_BANNER,{convId:e}):o.requestHideBanner(HI.a.STRANGER_BANNER,{convId:e})}}),[e,s,t])})(t),i=t,Object(Or.useEffect)((()=>{const e=Object(IE.a)(i);if(e){const e=Ii.default.getUidMe();Xh.a.getInstance(i).changeConversation(i,e)}else Yb.j.GetUIManager().loadAndRegisterToDisplayBanner(i);return()=>{e&&Xh.a.freeInstance(i)}}),[i]),(e=>{const t=Object(nc.l)(Nn.MuteDataManager,e);Mr.a.useEffect((()=>{let s=!1,i=!1,n=null,r=!1;if(t&&-1==t.duration&&Object(FE.a)().hide_endless_mute_banner_after_seconds>=0){const s=1e3*Object(FE.a)().hide_endless_mute_banner_after_seconds-(Date.now()-1e3*t.startTime);s>0?n=setTimeout((()=>{const t=a.ModuleContainer.resolve(WI.a),s={convId:e};t.requestHideBanner(HI.a.MUTE_BANNER,s)}),s):r=!0}i=r,s=!!t&&!i;const o=a.ModuleContainer.resolve(WI.a),c={convId:e};return s?o.requestShowBanner(HI.a.MUTE_BANNER,c):o.requestHideBanner(HI.a.MUTE_BANNER,c),()=>{n&&clearTimeout(n)}}),[t,e])})(t),(e=>{const t=Object(nc.l)(el.e,e);Mr.a.useEffect((()=>{var s;const i=Object(IE.a)(e)&&Ce.default.group_privacy.community.enable_upgrade&&(null==t?void 0:t.bannerStatus.show)&&(null===(s=t.bannerStatus.position)||void 0===s?void 0:s.has(el.f.CHAT_BOX)),n=a.ModuleContainer.resolve(WI.a),r={convId:e};i?n.requestShowBanner(HI.a.COMMUNITY_ENCOURAGE_BANNER,r):n.requestHideBanner(HI.a.COMMUNITY_ENCOURAGE_BANNER,r)}),[t,e])})(t),(e=>{const{showBanner:t}=Object(wE.a)();Object(Or.useEffect)((()=>{const s=a.ModuleContainer.resolve(WI.a);t?s.requestShowBanner(HI.a.MY_CLOUD_BANNER,{convId:e}):s.requestHideBanner(HI.a.MY_CLOUD_BANNER,{convId:e})}),[e,t])})(t)}}class NE extends kE{constructor(...e){super(...e),this.version=1}createChatBoxBannerView(e,t){return Mr.a.createElement(PE,Object(gC.a)({ref:t},e))}}const PE=Mr.a.memo(Mr.a.forwardRef(((e,t)=>{const{convId:s,windowId:a,chatBoxBannerState:i,confirm:n}=e,r=Mr.a.useRef(null),{chatBoxBannerObjectPool:o}=Object(EC.a)();Mr.a.useImperativeHandle(t,(()=>({getChatBoxBannerHeight:()=>{var e,t;return null!==(e=null===(t=r.current)||void 0===t?void 0:t.clientHeight)&&void 0!==e?e:0}})),[]);const c=null==i?void 0:i.bannerNameList;return null!=c&&c.length?Mr.a.createElement("div",{ref:r,className:"list-chat-box-banner"},Mr.a.createElement("div",{className:"list-chat-box-banner__content"},c.map((e=>o.getBannerComponent(e,{windowId:a,convId:s,confirm:n}))))):null})));var jE;Object(a.injectable)()(jE=Object(a.singleton)(hC.a)(jE=class{constructor(){this._bannerManagerContainer=new Map,this._isLoadedBannerManagers=!1}getBannerComponent(e,t,s){let a=null;switch(e){case HI.a.PIN_TOPIC_BANNER:a=Mr.a.createElement(yE,{key:e,ref:s,windowId:t.windowId,convId:t.convId,confirm:t.confirm});break;case HI.a.MUTE_BANNER:a=Mr.a.createElement(DC,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case HI.a.BLOCKED_BANNER:a=Mr.a.createElement(MC,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case HI.a.STRANGER_BANNER:a=Mr.a.createElement(LC,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case HI.a.COMMUNITY_ENCOURAGE_BANNER:a=Mr.a.createElement(CE,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;case HI.a.MY_CLOUD_BANNER:a=Mr.a.createElement(AE,{key:e,ref:s,windowId:t.windowId,convId:t.convId});break;default:a=null}return null==a&&zconsole.zsymb(18,"7gUYp_",`[getBannerComponent] ${e} is null!`),a}getChatBoxBannerFactory(){return new NE}getBannerManagers(){const e=Array.from(this._bannerManagerContainer.values());return e.length||this._isLoadedBannerManagers?e:(this._loadBannerManagers(),this.getBannerManagers())}_loadBannerManagers(){this._isLoadedBannerManagers||(this._isLoadedBannerManagers=!0)}})||jE);var UE,BE=s("QCfS"),zE=s("l9M7");Object(a.singleton)(BE.b)(UE=Object(xi.b)(BE.b)(UE=function(e,t){return Object(a.inject)(dC)(e,void 0,0)}(UE=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,1)}(UE=Reflect.metadata("design:type",Function)(UE=Reflect.metadata("design:paramtypes",[Object,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(UE=class{constructor(e,t){this.type=void 0,this.key=BE.a,this.name=BE.a,this.chatBoxBannerUIStateMap_=new Map,this.requestingBannerNameListMap_=new Map,this.chatBoxBannerAppService_=void 0,this.logger_=void 0,this.chatBoxBannerAppService_=e,this.logger_=t.createZLogger(w.ZLoggerNametags.cbbManager,[w.ZLoggerNametags.manageCbbUiState])}init(){}getItem(e,t){if(e.key&&Object(zE.b)(e.key)){return this.getChatBoxBannerUIState_(e.key)}}getList(e,t){return[]}onGetItemFailure(e,t){this.logger_.zsymb(21,"jwJkDr",["[onGetItemFailure] key: {}, error: {}","_BBweL"],e,t.message)}onGetListFailure(e,t){this.logger_.zsymb(21,"kbuPNc",["[onGetListFailure] key: {}, error: {}","HWSk9R"],e,t.message)}isBannerDisplaying(e,t){if(!t){const e=`[isBannerDisplaying] Invalid required parameter convId: ${t}.`;return this.logger_.zsymb(0,"UItkCZ",e),!1}const s=Object(zE.a)(t);return this.getChatBoxBannerUIState_(s).bannerNameList.includes(e)}requestShowBanner(e,t){const s=t.convId;if(!s){const e=`[requestShowBanner] Invalid required parameter convId: ${s}.`;return this.logger_.zsymb(0,"uyq_Ma",e),!1}return this.processShowBanner_(e,s)}requestHideBanner(e,t){const s=t.convId;if(s)this.processHideBanner_(e,s);else{const e=`[requestHideBanner] Invalid required parameter convId: ${s}.`;this.logger_.zsymb(0,"86ZVA8",e)}}createDefaultChatBoxBannerUIState_(){return{lastModifiedTime:Date.now(),bannerNameList:[]}}getConvType_(e){return e?e===Ce.default.sendToMeId?HI.b.MY_CLOUD:e.startsWith("g")?HI.b.GROUP:HI.b.ONE_TO_ONE:HI.b.UNKNOWN}processShowBanner_(e,t){const s={convType:this.getConvType_(t)};if(!this.chatBoxBannerAppService_.isBannerEnabled(e,s))return this.logger_.zsymb(3,"BdERBm",["[processShowBanner_] {} is not enabled.","gf8Rar"],e),!1;if(!this.isBannerDisplaying(e,t)){const s=Object(zE.a)(t),a=this.getChatBoxBannerUIState_(s),i=this.getRequestingBannerNameList_(s),n=Object(rm.a)(a,(t=>{const s=this.chatBoxBannerAppService_.addBannerNameToBannerNameList(e,[...i]);t.bannerNameList=s,t.lastModifiedTime=Date.now()}));this.chatBoxBannerUIStateMap_.set(s,n),Object(nc.h)(this.name,s)}return this.refreshRequestingBannerInList_(e,t,"add_new"),!0}refreshRequestingBannerInList_(e,t,s){const a=Object(zE.a)(t);const i=this.getRequestingBannerNameList_(a).filter((t=>t!==e));"add_new"===s&&i.push(e),this.requestingBannerNameListMap_.set(a,i)}processHideBanner_(e,t){const s={convType:this.getConvType_(t)};if(this.chatBoxBannerAppService_.isBannerEnabled(e,s)){if(this.isBannerDisplaying(e,t)){const s=Object(zE.a)(t),a=this.getRequestingBannerNameList_(s),i=this.getChatBoxBannerUIState_(s),n=Object(rm.a)(i,(t=>{const s=this.chatBoxBannerAppService_.removeBannerNameFromBannerNameList(e,[...a]);t.bannerNameList=s,t.lastModifiedTime=Date.now()}));this.chatBoxBannerUIStateMap_.set(s,n),Object(nc.h)(this.name,s)}this.refreshRequestingBannerInList_(e,t,"remove")}else this.logger_.zsymb(3,"tOurYH",["[processHideBanner_] {} is not enabled.","4b3c6g"],e)}getChatBoxBannerUIState_(e){let t=this.chatBoxBannerUIStateMap_.get(e);return t||(t=this.createDefaultChatBoxBannerUIState_(),this.chatBoxBannerUIStateMap_.set(e,t)),t}getRequestingBannerNameList_(e){let t=this.requestingBannerNameListMap_.get(e);return t||(t=[],this.requestingBannerNameListMap_.set(e,t)),t}getChatBoxBannerUIState(e){const t=Object(zE.a)(e);return this.getChatBoxBannerUIState_(t)}getRequestingChatBoxBanners(e){const t=Object(zE.a)(e);return this.getRequestingBannerNameList_(t)}getShowingChatBoxBanners(e){const t=Object(zE.a)(e);return this.getChatBoxBannerUIState_(t).bannerNameList}getChatBoxBannerConfigData(){return this.chatBoxBannerAppService_.getChatBoxBannerConfigData()}})||UE)||UE)||UE)||UE)||UE);var GE,xE=s("pqQ2"),VE=s("1Pg6"),HE=s("0NOU");Object(xi.b)(VE.a)(GE=Reflect.metadata("design:type",Function)(GE=Reflect.metadata("design:paramtypes",[])(GE=class extends Wr.a{constructor(){super(xE.a,xE.b),this.key=void 0,this.key=xE.a}startDownloadProgress(e,t){this.updateItem((e=>{e.isDownloading=!0,e.progress=0,e.entry=t}),e)}updateProgress(e,t){this.updateItem((e=>{e.isDownloading=!0,e.progress=Math.min(Math.max(t,0),100)}),e)}completeDownloadProgress(e){this.removeDownloadProgress(e)}handleAfterDownloadError(e){this.removeDownloadProgress(e)}removeDownloadProgress(e){this.removeItem(e)}getDownloadInfo(e){return this.getItem({key:e,version:0,extraData:{}},{})}getDownloadInfoByMessage(e){const t=Object(HE.a)(e);return this.getItem({key:t,version:0,extraData:{}},{})}isDownloading(e){var t;const s=this.getItem({key:e,version:0,extraData:{}},{});return null!==(t=null==s?void 0:s.isDownloading)&&void 0!==t&&t}})||GE)||GE);var WE=s("kZZr"),qE=s("VteK"),KE=s("zNPY"),ZE=s("UwMY"),$E=s("bWos"),QE=s("/YHU");class YE{constructor(e){var t,s,a,i,n,r;this.noiseId=void 0,this.zCloudKey=void 0,this.size=void 0,this.ts=void 0,this.extraInfo=void 0,this.message=void 0,this.isDuplicated=void 0,this.noiseId=e.noiseId,this.zCloudKey=$E.a.getZCloudKeyFromCloudItem(e),this.size=e.mediaInfo.mediaSize,this.ts=e.msgInfo.ts,this.isDuplicated=e.isDuplicated||!1;const o=(null==e||null===(t=e.msgInfo)||void 0===t?void 0:t.destId)==Ce.default.sendToMeId?null===(s=e.mediaInfo)||void 0===s||null===(a=s.mediaExtInfo)||void 0===a?void 0:a.data:null===(i=e.mediaInfo)||void 0===i||null===(n=i.mediaExtInfo)||void 0===n?void 0:n.decryptedData;if(o){const e=Object(QE.a)(o);e&&(this.extraInfo={title:e.title,thumbUrl:e.thumbUrl,params:o})}const c=ui.default.normalizeMessageType(e.msgInfo.msgType);var l;(this.message={cliMsgId:e.msgInfo.cliMsgId+"",fromUid:e.msgInfo.srcId+"",toUid:$E.a.getConversationIdFromCloudItem(e,Re.default.getUserId()),msgType:c,msgId:e.msgInfo.glbMsgId+"",isE2EE:!!e.msgInfo.isE2EE},null!==(r=this.extraInfo)&&void 0!==r&&r.thumbUrl)&&(this.message.message={thumbUrl:null===(l=this.extraInfo)||void 0===l?void 0:l.thumbUrl})}static transfer(e){const t=new YE(e);return Object.assign({},t)}}var JE=s("JP/W"),XE=s("na98"),eO=s("Qf4l"),tO=s("lGS6"),sO=s("iA9X"),aO=s("4LiO"),iO=s("oG6Z"),nO=s("sNf9");const rO="enable_view_mode",oO="enable_view_mode_for_free_user",cO={[`${rO}`]:!1,[`${oO}`]:!1},lO=new X.ObjectValidator({[`${rO}`]:X.Rule.field().boolean(),[`${oO}`]:X.Rule.field().boolean()}),dO=new X.AdvancedRemoteConfigs("zcloud_management_tool",cO,{validator:lO});var uO,hO=s("t9fU");const gO="cloud",mO={verifyQueueDone:!1,cloudItems:null,displayData:null,selectedItems:{},lastClickSelectItem:null,currentFilter:EE.e.ALL,currentSort:EE.g.SIZE_DESCENDING,status:null,fetching:!1,fetchLimit:null,hasMore:!1,lastItemInfo:null,queryError:null,cloudThumbItemMode:nO.a.ViewMode};Object(a.injectable)()(uO=Object(a.singleton)(WE.b)(uO=Object(xi.b)(WE.b)(uO=function(e,t){return Object(a.inject)(KE.a)(e,void 0,0)}(uO=function(e,t){return Object(a.inject)(KE.b)(e,void 0,1)}(uO=Reflect.metadata("design:type",Function)(uO=Reflect.metadata("design:paramtypes",[void 0===KE.a?Object:KE.a,void 0===KE.b?Object:KE.b])(uO=class extends Wr.a{constructor(e,t){super(),this.zCloudConversationController=e,this.zCloudSideBarController=t,this.config=void 0,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.cloudViewItems=void 0,this.getDefaultCloudState=()=>Object(I.a)(Object(I.a)({},mO),{},{cloudThumbItemMode:this.isViewModeEnabled()?nO.a.ViewMode:nO.a.SelectableMode}),this.toggleCloudThumbItemMode=e=>{this._toggleCloudThumbItemMode(e)},this._toggleCloudThumbItemMode=e=>{this.updateItem((t=>{t.cloudThumbItemMode=e}),gO),this.resetSelectedItem()},this.config=dO,this.name=WE.a,this.key=WE.a,this.data.set(gO,this.getDefaultCloudState()),this.cloudViewItems=null}_getState(e=gO){return this.data.get(e)}async _sort(e){this.updateItem((t=>{t.currentSort=e}),gO)}_filter(e){try{this.updateItem((t=>{t.currentFilter=e}),gO)}catch(t){}}_getCurrentSort(){const{currentSort:e}=this._getState();return e}isSortedBySize(e){return[EE.g.SIZE_ASCENDING,EE.g.SIZE_DESCENDING].includes(e)}getMappingTypeFromFilter(e){switch(e){case EE.e.ALL:return[Y.MSG_PHOTO,Y.MSG_PHOTO_2,Y.MSG_DOODLE,Y.MSG_VIDEO,Y.MSG_FILE,Y.MSG_VOICE];case EE.e.PHOTO:return[Y.MSG_PHOTO,Y.MSG_PHOTO_2,Y.MSG_DOODLE];case EE.e.VIDEO:return[Y.MSG_VIDEO];case EE.e.FILE:return[Y.MSG_FILE];case EE.e.VOICE:return[Y.MSG_VOICE]}}isSameFilterType(e){const{currentFilter:t}=this._getState(),s=this.getMappingTypeFromFilter(t),a=ui.default.normalizeMessageType(e.msgInfo.msgType);return s&&Array.isArray(s)&&s.includes(a)}getConsideredItems(e){if(!e||!Array.isArray(e))return null;let t=[...e];this.zCloudSideBarController.getCurrentView()!==eO.b.MY_CLOUD&&(t=t.filter((e=>e.zConv!==Ce.default.sendToMeId)));const s=this.zCloudConversationController.getCurrentSelectedConvId();return s&&(t=t.filter((e=>e.zConv===s))),t=t.filter((e=>!In.a.isThreadHidden(e.zConv))),t=t.filter((e=>this.isSameFilterType(e))),t}checkIsInRange(e,t,s){return e>=t&&e<=s}addCloudItemSizeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let a;if(0===s.length)a=e;else{const i=s[0].size,n=s[s.length-1].size;a=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,n,i)||(s>i||!!(null!=t&&t.isStopIndex&&s<n))}))}if(!a||!Array.isArray(a)||0===a.length)return;const i=[...s,...a].sort(((e,t)=>{const s=e.size;return t.size-s}));this.updateItem((e=>{e.displayData=i}),gO)}addCloudItemSizeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let a;if(0===s.length)a=e;else{const i=s[0].size,n=s[s.length-1].size;a=e.filter((e=>{const s=e.size;return!!this.checkIsInRange(s,i,n)||(s<i||!!(null!=t&&t.isStopIndex&&s>n))}))}if(!a||!Array.isArray(a)||0===a.length)return;const i=[...s,...a].sort(((e,t)=>{const s=e.size;return-(t.size-s)}));this.updateItem((e=>{e.displayData=i}),gO)}addCloudItemTimeDescending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let a;if(0===s.length)a=e;else{const i=s[0].ts,n=s[s.length-1].ts;a=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,n,i)||(s>i||!!(null!=t&&t.isStopIndex&&s<n))}))}if(!a||!Array.isArray(a)||0===a.length)return;const i=[...s,...a].sort(((e,t)=>{const s=e.ts;return t.ts-s}));this.updateItem((e=>{e.displayData=i}),gO)}addCloudItemTimeAscending(e){const{viewPortItemInfo:t,displayData:s}=this._getState();if(!s||!Array.isArray(s))return;let a;if(0===s.length)a=e;else{const i=s[0].ts,n=s[s.length-1].ts;a=e.filter((e=>{const s=e.ts;return!!this.checkIsInRange(s,i,n)||(s<i||!!(null!=t&&t.isStopIndex&&s>n))}))}if(!a||!Array.isArray(a)||0===a.length)return;const i=[...s,...a].sort(((e,t)=>{const s=e.ts;return-(t.ts-s)}));this.updateItem((e=>{e.displayData=i}),gO)}filter(e){this._filter(e),this.isViewModeEnabled()&&this.toggleCloudThumbItemMode(nO.a.ViewMode)}sort(e){this._sort(e)}getCurrentFilter(){const{currentFilter:e}=this._getState();return e}getCurrentSort(){const{currentSort:e}=this._getState();return e}setVerifyQueueDone(e){this.updateItem((t=>{t.verifyQueueDone=e}),gO)}setViewPortItemInfo(e){this.updateItem((t=>{t.viewPortItemInfo=e}),gO)}async addCloudItems(e){const{currentSort:t}=this._getState();let s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;Object(nS.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&qE.a.getInstance().updateExtMediaInfo(s),a.ModuleContainer.resolve(nS.c).calculateZCloudStatusByCloudItems(s);const i=s.map((e=>YE.transfer(e)));t===EE.g.SIZE_DESCENDING?this.addCloudItemSizeDescending(i):t===EE.g.SIZE_ASCENDING?this.addCloudItemSizeAscending(i):t===EE.g.TIME_DESCENDING?this.addCloudItemTimeDescending(i):t===EE.g.TIME_ASCENDING&&this.addCloudItemTimeAscending(i)}updateCloudItems(e){const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=this.getConsideredItems(e);if(!s||!Array.isArray(s))return;const a=t.flatMap((t=>{const a=s.findIndex((e=>$E.a.getZCloudKeyFromCloudItem(e)===t.zCloudKey));return-1===a?t:YE.transfer(e[a])}));a&&Array.isArray(a)&&this.updateItem((e=>{e.displayData=a}),gO)}removeCloudItems(e){if(!e||!Array.isArray(e))return;const{displayData:t}=this._getState();if(!t||!Array.isArray(t))return;const s=e;Object(JE.b)("removeCloudItems | displayData before remove: ",t);const a=t.filter((e=>!s.includes(e.zCloudKey)));this.updateItem((e=>{e.displayData=a}),gO),Object(JE.b)("removeCloudItems | displayData after remove: ",t)}getCurrentQueryIdentity(){const e=this.zCloudSideBarController.getCurrentView(),{currentFilter:t,currentSort:s}=this._getState();return`${e||e+""}_${t}_${s}`}async getAllByTypeSizeOrDate(e,t,s,a,i=!0){try{const{currentSort:n,currentFilter:r,lastItemInfo:o}=this._getState(),c=r===EE.e.ALL;let l=null;switch(n){case EE.g.SIZE_DESCENDING:l=c?await qE.a.getInstance().getAllByTypeSize("",i?XE.c:t,s,a,O.c.PREV,o?o.offset:0):await qE.a.getInstance().getAllByTypesSize(e,i?XE.c:t,s,a,O.c.PREV,o?o.offset:0);break;case EE.g.SIZE_ASCENDING:l=c?await qE.a.getInstance().getAllByTypeSize("",t,s,a,O.c.NEXT,o?o.offset:0):await qE.a.getInstance().getAllByTypesSize(e,t,s,a,O.c.NEXT,o?o.offset:0);break;case EE.g.TIME_DESCENDING:l=c?await qE.a.getInstance().getAllByTypeDate("",i?XE.b:t,s,a,O.c.PREV,o?o.offset:0):await qE.a.getInstance().getAllByTypesDate(e,i?XE.b:t,s,a,O.c.PREV,o?o.offset:0);break;case EE.g.TIME_ASCENDING:l=c?await qE.a.getInstance().getAllByTypeDate("",t,s,a,O.c.NEXT,o?o.offset:0):await qE.a.getInstance().getAllByTypesDate(e,t,s,a,O.c.NEXT,o?o.offset:0);break;default:l=null}return{result:l,identity:this.getCurrentQueryIdentity()}}catch(n){throw{error:n,identity:this.getCurrentQueryIdentity()}}}async getAllConvByTypeSizeOrDate(e,t,s,a,i,n=!0){try{const{currentFilter:r,currentSort:o,lastItemInfo:c}=this._getState(),l=r===EE.e.ALL;let d=null;switch(o){case EE.g.SIZE_DESCENDING:d=l?await qE.a.getInstance().getAllByConversationTypeSize(e,"",n?XE.c:s,a,i,O.c.PREV,c?c.offset:0):await qE.a.getInstance().getAllByConversationTypesSize(e,t,n?XE.c:s,a,i,O.c.PREV,c?c.offset:0);break;case EE.g.SIZE_ASCENDING:d=l?await qE.a.getInstance().getAllByConversationTypeSize(e,"",s,a,i,O.c.NEXT,c?c.offset:0):await qE.a.getInstance().getAllByConversationTypesSize(e,t,s,a,i,O.c.NEXT,c?c.offset:0);break;case EE.g.TIME_DESCENDING:d=l?await qE.a.getInstance().getAllByConversationTypeDate(e,"",n?XE.b:s,a,i,O.c.PREV,c?c.offset:0):await qE.a.getInstance().getAllByConversationTypesDate(e,t,n?XE.b:s,a,i,O.c.PREV,c?c.offset:0);break;case EE.g.TIME_ASCENDING:d=l?await qE.a.getInstance().getAllByConversationTypeDate(e,"",s,a,i,O.c.NEXT,c?c.offset:0):await qE.a.getInstance().getAllByConversationTypesDate(e,t,s,a,i,O.c.NEXT,c?c.offset:0);break;default:d=null}return{result:d,identity:this.getCurrentQueryIdentity()}}catch(r){throw{error:r,identity:this.getCurrentQueryIdentity()}}}updateLastItemInfo(e,t){if(!e)return;const s=this._getCurrentSort();this.updateItem((a=>{a.lastItemInfo={type:e.zType,sizeOrDate:this.isSortedBySize(s)?e.zSize:e.zDate,noiseId:e.noiseId,offset:t}}),gO)}setLastItemFromQueryData(e){if(!e||!Array.isArray(e))return;const t=e[e.length-1];Object(JE.b)("currLastItem: ",t);const{lastItemInfo:s}=this._getState();(null==t?void 0:t.noiseId)!==(null==s?void 0:s.noiseId)&&this.updateLastItemInfo(t,((null==s?void 0:s.offset)||0)+e.length)}checkHasMoreCloudMedia(e,t){return e&&Array.isArray(e)&&e.length>=t}setHasMoreFromQueryData(e,t){if(!e||!Array.isArray(e))return;const s=this.checkHasMoreCloudMedia(e,t);Object(JE.b)("hasMore: ",s),this.updateItem((e=>{e.hasMore=s}),gO)}filterNonMyCloudMediaItem(e){return e&&Array.isArray(e)?e.filter((e=>e.zConv!==Ce.default.sendToMeId)):null}filterInvalidCloudItems(e){if(!e||!Array.isArray(e))return null;let t;t=e.filter((e=>!In.a.isThreadHidden(e.zConv)));return this.zCloudSideBarController.getCurrentView()!==eO.b.MY_CLOUD&&(t=this.filterNonMyCloudMediaItem(t)),t}setDisplayDataFromQueryData(e,t,s){if(!e||!Array.isArray(e))return;const a=e,{displayData:i}=this._getState();!t&&i&&Array.isArray(i)?this.updateItem((e=>{e.displayData=[...i,...a]}),gO):this.updateItem((e=>{e.displayData=a}),gO)}filterDuplicatedItems(e){if(!e||e.length<=0)return e;let t={},s=[];for(let a=0;a<e.length;a++){let i=e[a];if(!i)continue;let{zKey:n}=i;if(n)if(t.hasOwnProperty(n)){let{index:e}=t[n],{actionType:a}=i;Object(sO.d)("found dup item",n,i,e),a===ZE.b.add_new?s.splice(e,1,Object(I.a)(Object(I.a)({},i),{},{isDuplicated:!0})):s[e].isDuplicated=!0}else s.push(i),t[n]=Object(I.a)(Object(I.a)({},i),{},{index:s.length-1})}return s}async fetchAllCloudMedia(e,t,s,i,n,r=!1,o=-1){try{var c;const l=this.zCloudSideBarController.getCurrentView();this.updateItem((e=>{e.fetching=!0,e.fetchLimit=n,e.queryError=null,r&&(e.selectedItems={}),i||(e.lastItemInfo=null)}),gO);let d=null;if(l===eO.b.MEDIA_TYPE?d=await this.getAllByTypeSizeOrDate(t,s,i,n,r):l===eO.b.CONVERSATION?d=await this.getAllConvByTypeSizeOrDate(e+"",t,s,i,n,r):l===eO.b.MY_CLOUD&&(d=await this.getAllConvByTypeSizeOrDate(Ce.default.sendToMeId+"",t,s,i,n,r)),Object(JE.b)("fetchAllCloudMedia | data from db: ",d),!d)return void this.updateItem((e=>{e.fetching=!1}),gO);let{result:u,identity:h}=d;if(!u||!Array.isArray(u))return void this.updateItem((e=>{e.fetching=!1}),gO);if(this.setHasMoreFromQueryData(u,n),this.setLastItemFromQueryData(u),u=this.filterInvalidCloudItems(u),l!==eO.b.CONVERSATION&&(u=this.filterDuplicatedItems(u)),!u||!Array.isArray(u))return void this.updateItem((e=>{e.fetching=!1}),gO);Object(nS.b)().isEnableSubmitExtraInfoEntry("view_on_quota_tool")&&qE.a.getInstance().updateExtMediaInfo(u),a.ModuleContainer.resolve(nS.c).calculateZCloudStatusByCloudItems(u);const g=u.map((e=>YE.transfer(e)));this.setDisplayDataFromQueryData(g,r,h),-1==o?o=g.length:o+=g.length,null!==(c=this._getState())&&void 0!==c&&c.hasMore&&o<n?this.handleFetchMore(n,o):this.updateItem((e=>{e.fetching=!1}),gO)}catch(l){this.updateItem((e=>{e.fetching=!1,r&&(e.queryError=l)}),gO)}}forceGetCloudMedia(){const{currentFilter:e,fetchLimit:t}=this._getState(),s=this.zCloudConversationController.getCurrentSelectedConvId();if(!e||null===s||!t)return;const a=tO.a.getCurrentMappingQueryType(e);this.fetchAllCloudMedia(s,a,0,"",t,!0)}handleFetchMore(e,t=-1){const{currentFilter:s,lastItemInfo:a,hasMore:i,fetching:n}=this._getState(),r=tO.a.getCurrentMappingQueryType(s),o=this.zCloudConversationController.getCurrentSelectedConvId();Object(JE.b)("call fetch more... ",a),n&&-1===t||!a||!i||this.fetchAllCloudMedia(o,r,a.sizeOrDate,a.noiseId,e,!1,t)}isSelectedAll(){const{displayData:e,selectedItems:t}=this._getState();return Object.keys(t).length===(null==e?void 0:e.length)}handleSelectAll(){const{displayData:e,selectedItems:t}=this._getState();if(!e)return;const s=Object(I.a)({},t);e.forEach((e=>{const t=e.zCloudKey;s[t]||(s[t]=e)})),this.updateItem((e=>{e.selectedItems=s}),gO)}handleDeselectAll(){this.resetSelectedItem()}handleToggleSelectAll(){this.isSelectedAll()?this.handleDeselectAll():this.handleSelectAll()}handleSelectItem(e){const{selectedItems:t,currentFilter:s}=this._getState(),a=Object(I.a)({},t);let i;const n=e.zCloudKey;if(a[n])delete a[n],i=null,Object(nS.b)().isEnableUserPCloud()&&aO.a.logClickUncheckItem({unselect_type:"single_unselect"});else{var r;if((null===(r=Object.keys(a))||void 0===r?void 0:r.length)>Ce.default.max_msg_per_del-1)return void mc.default.createSuccess(ce.a.trans("STR_MY_CLOUD_MAX_SELECTED_ITEMS",[Ce.default.max_msg_per_del.toString()]));if(a[n]=e,i=e,Object(nS.b)().isEnableUserPCloud()){var o;const{extension:t}=Object(iO.b)((null==e||null===(o=e.extraInfo)||void 0===o?void 0:o.title)||""),a=this.zCloudSideBarController.getCurrentView();aO.a.logClickCheckItem({tab_filter:s,file_extension:t,file_size:e.size,source_tab:a})}}this.updateItem((e=>{e.selectedItems=a,e.lastClickSelectItem=i}),gO)}resetSelectedItem(){this.updateItem((e=>{e.selectedItems={}}),gO)}resetAllStates(){this.data.set(gO,this.getDefaultCloudState()),Object(nc.h)(this.name,gO)}isViewModeEnabled(){try{return hO.a.getInstance().isPaidUser()||hO.a.getInstance().isInGracePeriod()?this.config.key(rO).boolean:!!hO.a.getInstance().isFreev2()&&this.config.key(oO).boolean}catch(e){return Object(JE.a)("daivd error when check view mode enabled: ",e),!1}}init(e){throw new Error("Method not implemented.")}getItem(e,t){return this._getState(e.key)}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||uO)||uO)||uO)||uO)||uO)||uO);var pO,fO=s("tP1L"),vO=s("9XoL"),_O=s("bO3J"),bO=s("cCVI"),IO=s("k+eZ"),yO=s("CBkG");const SO="1",CO="zcloud-promo",EO={showPromoTooltip:!1,showPromoPopover:!1,showTip:!1,showEntry:!1};Object(a.injectable)()(pO=Object(a.singleton)(IO.b)(pO=Object(xi.b)(IO.b)(pO=function(e,t){return Object(a.inject)(vO.b)(e,void 0,0)}(pO=function(e,t){return Object(a.inject)(bO.a)(e,void 0,1)}(pO=function(e,t){return Object(a.inject)(rc.SidebarController)(e,void 0,2)}(pO=Reflect.metadata("design:type",Function)(pO=Reflect.metadata("design:paramtypes",[void 0===vO.b?Object:vO.b,void 0===bO.a?Object:bO.a,void 0===rc.SidebarController?Object:rc.SidebarController])(pO=class extends Wr.a{constructor(e,t,s){super(),this.eventsResolver=e,this.onboardEventsResolver=t,this.sidebarController=s,this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=IO.a,this.key=IO.a,this.data.set(SO,EO),this.blockOnboardingHandler=this.blockOnboardingHandler.bind(this),this.triggerOnboardingHandler=this.triggerOnboardingHandler.bind(this),this.pcDoneOnboardingHandler=this.pcDoneOnboardingHandler.bind(this),this.offPlanHandler=this.offPlanHandler.bind(this),this.upgradePlanHandler=this.upgradePlanHandler.bind(this),this.receiveKeyHandler=this.receiveKeyHandler.bind(this)}save(){n.default.getInstance().setItemForCurrentUser(CO,JSON.stringify(this.getState()))}load(){let e=n.default.getInstance().getItemForCurrentUser(CO);e&&this.data.set(SO,JSON.parse(e))}getLocal(){let e=n.default.getInstance().getItemForCurrentUser(CO);return e?JSON.parse(e):void 0}getState(e=SO){return this.data.get(e)}blockOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!1,e.showTip=!1}),SO),this.save()}triggerOnboardingHandler(e){if(Object(JE.a)("trigger onboarding event: ",e),e.type===_O.b.MOBILE_COMPLETED_BEFORE)this.updateItem((e=>{e.showEntry=!0,e.showTip=!0}),SO),this.save()}pcDoneOnboardingHandler(e){this.updateItem((e=>{e.showEntry=!0,e.showTip=!1}),SO),this.save()}offPlanHandler(e){Object(JE.a)("off plan | current: FREE"),this.sidebarController.changeTab(rc.SidebarTab.MESSAGE_TAB),this.sidebarController.updateSelectedId(null),this.removeSubmitOnboaringDoneKey(),this.updateItem((e=>{e.showEntry=!1,e.showTip=!1,e.showPromoTooltip=Object(nS.b)().isEnablePromoTooltip()&&hO.a.getInstance().isFreev2(),e.showPromoPopover=Object(nS.b)().isEnablePromoPopover()&&hO.a.getInstance().isFreev2()}),SO),this.save()}upgradePlanHandler(e){Object(JE.a)("upgrade plan | current: PAID"),this.updateItem((e=>{e.showPromoTooltip=!1,e.showPromoPopover=!1}),SO),this.save()}receiveKeyHandler(e){}doesSubmitOnboardingDoneBefore(){return!!n.default.getInstance().getItemForCurrentUser("zcl_sm_ob")}setSubmitOnboardingDone(){n.default.getInstance().setItemForCurrentUser("zcl_sm_ob","true")}removeSubmitOnboaringDoneKey(){n.default.getInstance().removeItemForCurrentUser("zcl_sm_ob")}setShowPromoTooltip(e){this.updateItem((t=>{t.showPromoTooltip=e}),SO),this.save()}setShowPromoPopover(e){this.updateItem((t=>{t.showPromoPopover=e}),SO),this.save()}initPromoStates({showPromoTooltip:e,showPromoPopover:t}){this.updateItem((s=>{s.showPromoTooltip=e,s.showPromoPopover=t}),SO),this.save()}initShouldShowEntry(e){Object(JE.a)("init check zcloud user: ",e),this.updateItem((t=>{t.showEntry=e}),SO),this.save()}addListener(){this.onboardEventsResolver.addEventListener(_O.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.addEventListener(_O.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.addEventListener(yO.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.addEventListener(yO.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(yO.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.addEventListener(yO.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}removeListener(){this.onboardEventsResolver.removeEventListener(_O.b.MOBILE_COMPLETED_BEFORE,this.triggerOnboardingHandler),this.onboardEventsResolver.removeEventListener(_O.b.PC_COMPLETED_BEFORE,this.pcDoneOnboardingHandler),this.eventsResolver.removeEventListener(yO.a.UPGRADE_ZCLOUD_PLAN,this.upgradePlanHandler),this.eventsResolver.removeEventListener(yO.a.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(yO.g.HAVE_KEY,this.receiveKeyHandler),this.eventsResolver.removeEventListener(yO.a.OFF_PERSONAL_CLOUD_PLAN,this.offPlanHandler)}onDoneOnboarding(){this.submitDoneOnboarding(),this.updateItem((e=>{e.showTip=!1}),SO),this.save()}async submitDoneOnboarding(){Object(JE.a)("submit done onboarding");try{if(this.doesSubmitOnboardingDoneBefore())return;await fO.a.submitOnboardingInfo(),this.setSubmitOnboardingDone()}catch(e){}}})||pO)||pO)||pO)||pO)||pO)||pO)||pO);var OO=s("NoK8"),MO=s("u/Xa"),TO=s("3/Az");class RO{static closeZCloudPhotoViewer(){a.ModuleContainer.resolve(MO.b).emit("CLOSE_VIEWER",{conversationId:"",openSource:TO.l.ZCloudManagementTool})}}const wO=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloudManagementTool,["PreviewUtils","daivd"]);class LO{static closePhotoAndFilePreview(){try{RO.closeZCloudPhotoViewer()}catch(e){wO.zsymb(18,"8hh9Rv","Error closing photo and file preview: ",e)}}}var DO;const AO="1",FO={currentView:null,pageStack:[]};Object(a.injectable)()(DO=Object(a.singleton)(OO.b)(DO=Object(xi.b)(OO.b)(DO=Reflect.metadata("design:type",Function)(DO=Reflect.metadata("design:paramtypes",[])(DO=class extends Wr.a{constructor(){super(),this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.lastMediaView=void 0,this.name=OO.a,this.key=OO.a,this.data.set(AO,FO),this.lastMediaView=null}_getState(e=AO){return this.data.get(e)}setInitView(e){this.updateItem((t=>{t.currentView=e}),AO)}changeView(e){null===e&&LO.closePhotoAndFilePreview(),this.updateItem((t=>{t.currentView=e}),AO),e!==eO.b.SETTING&&(this.lastMediaView=e)}closeSetting(){this.changeView(this.lastMediaView||eO.b.MEDIA_TYPE)}getCurrentView(){const{currentView:e}=this._getState();return e}getPageStack(){const{pageStack:e}=this._getState();return e}pushPageStack(e){const{pageStack:t}=this._getState();this.updateItem((s=>{s.pageStack=[...t,e]}),AO)}setPageStack(e){e&&Array.isArray(e)&&this.updateItem((t=>{t.pageStack=e}),AO)}popPageStack(){const{pageStack:e}=this._getState(),t=[...e];t.pop(),this.updateItem((e=>{e.pageStack=t}),AO)}})||DO)||DO)||DO)||DO);s("umN7");var kO=s("5y3u");a.ModuleContainer.registerSingleton(kO.a,kO.b);var NO=s("iyDo"),PO=s("UDME"),jO=s("A9no"),UO=s("bKXo"),BO=s("tIXy");var zO=class{constructor(){this.data=void 0,this.data=new Map}startCapture(e,t={}){this.data.set(e,{start:Ct.default.getTimeNow(),end:null,params:t})}finishCapture(e,t={}){const s=this.data.get(e);if(s){const a=Object(I.a)(Object(I.a)({},s),{},{end:Ct.default.getTimeNow(),params:Object(r_.a)(s.params,t)});return this.data.set(e,a),a}return s}getItem(e){return this.data.get(e)}clearItem(e){this.data.delete(e)}};let GO=function(e){return e[e.NORMAL=0]="NORMAL",e[e.SILENTLY=1]="SILENTLY",e[e.BLOCKING=2]="BLOCKING",e[e.SILENTLY_BLOCKING=3]="SILENTLY_BLOCKING",e}({}),xO=function(e){return e[e.OFF=0]="OFF",e[e.ON=1]="ON",e}({}),VO=function(e){return e[e.MEMBER=0]="MEMBER",e[e.OWNER=1]="OWNER",e[e.ADMIN=2]="ADMIN",e}({}),HO=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({}),WO=function(e){return e[e.MANUAL=0]="MANUAL",e[e.DEFAULT=1]="DEFAULT",e[e.NOT_SILENTLY=-1]="NOT_SILENTLY",e}({}),qO=function(e){return e[e.LEAVE_GROUP=1]="LEAVE_GROUP",e[e.CHANGE_HIDE_MEMBER_SETTING=1]="CHANGE_HIDE_MEMBER_SETTING",e[e.CLICK_GROUP_LINK=1]="CLICK_GROUP_LINK",e[e.UPGRADE_COMMUNITY=1]="UPGRADE_COMMUNITY",e[e.VERIFY_ACCOUNT=2]="VERIFY_ACCOUNT",e[e.CLICK_LEARN_MORE=3]="CLICK_LEARN_MORE",e[e.ENTER_UPGRADE_FLOW=4]="ENTER_UPGRADE_FLOW",e[e.ENTER_KYC_FLOW=5]="ENTER_KYC_FLOW",e[e.ACTION_KYC_FLOW=6]="ACTION_KYC_FLOW",e[e.AFTER_ACTION_KYC_FLOW=7]="AFTER_ACTION_KYC_FLOW",e[e.PREVENT_UPGRADE_FLOW=8]="PREVENT_UPGRADE_FLOW",e[e.ACTION_ZBIZ_REGISTER=9]="ACTION_ZBIZ_REGISTER",e}({});a.ModuleContainer.registerSingleton(NO.a,class{constructor(){this.upgradeCommunityCapture=void 0,this.verificationCapture=void 0,this.upgradeCommunityCapture=new zO,this.verificationCapture=new zO}logAction999(e){const{type:t,payload:s,noisedIds:a}=e;let i;switch(t){case"LEAVE_GROUP":i=qO.LEAVE_GROUP,Ia.default.logActionInfoV2(Ia.FeaturesInfo.LeaveGroupSilently,i,s,a);break;case"CHANGE_HIDE_MEMBER_SETTING":i=qO.CHANGE_HIDE_MEMBER_SETTING,Ia.default.logActionInfoV2(Ia.FeaturesInfo.HideMemberPresence,i,s,a);break;case"CLICK_GROUP_LINK":i=qO.CLICK_GROUP_LINK,Ia.default.logActionInfoV2(Ia.FeaturesInfo.ClickGroupLink,i,s,a);break;case"UPGRADE_COMMUNITY":i=qO.UPGRADE_COMMUNITY,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"VERIFY_ACCOUNT":i=qO.VERIFY_ACCOUNT,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"CLICK_LEARN_MORE":i=qO.CLICK_LEARN_MORE,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"ENTER_KYC_FLOW":i=qO.ENTER_KYC_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"ENTER_UPGRADE_FLOW":i=qO.ENTER_UPGRADE_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"ACTION_KYC_FLOW":i=qO.ACTION_KYC_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"AFTER_ACTION_KYC_FLOW":i=qO.AFTER_ACTION_KYC_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"PREVENT_UPGRADE_FLOW":i=qO.PREVENT_UPGRADE_FLOW,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a);break;case"ACTION_ZBIZ_REGISTER":i=qO.ACTION_ZBIZ_REGISTER,Ia.default.logActionInfoV2(Ia.FeaturesInfo.Community,i,s,a)}}getChatTypeFromConvId(e){return ui.default.isGroup(e)?HO.CHAT_GROUP:OS.a.isSendToMe(e)?HO.MY_CLOUD:HO.CHAT_11}getMemberRole(e,t){return PO.GroupSettingHelper.isOwner(e,t)?VO.OWNER:PO.GroupSettingHelper.isAdmin(e,t)?VO.ADMIN:VO.MEMBER}isDefaultLeaveSilently(e){return!(!Ce.default.group_privacy.hide_member.enable||!PO.GroupSettingHelper.isLockViewMember(e))||!(!Ce.default.group_privacy.leave_group_silently.enable||!jO.isCommunity(e))}getLeaveGroupSilentlyType(e,t){return this.isDefaultLeaveSilently(e)?WO.DEFAULT:"SILENTLY"===t?WO.MANUAL:WO.NOT_SILENTLY}changeHideMemberSettingReport(e){const t=ui.default.getGroupIdFromConversationId(e.groupId),s=Ii.default.getUidMe();this.logAction999({type:"CHANGE_HIDE_MEMBER_SETTING",payload:{mode:e.value?xO.ON:xO.OFF,des_id:t,src_id:s},noisedIds:[t,s]})}clickGroupLinkReport(e){const t=ui.default.getGroupIdFromConversationId(e.groupId),s=Ii.default.getUidMe();this.logAction999({type:"CLICK_GROUP_LINK",payload:{chat_type:e.conversationId?this.getChatTypeFromConvId(e.conversationId):null,src_id:s,des_id:t,lobby_version:Ce.default.group_privacy.hide_member.enable?1:0},noisedIds:[s,t]})}leaveGroupReport(e){let t=e.groupId;t.startsWith(Y.GROUPID_PREFIX)||(t=Y.GROUPID_PREFIX+t);const s=ui.default.getGroupIdFromConversationId(e.groupId),i=Ii.default.getUidMe(),n=this.getMemberRole(t,i);this.logAction999({type:"LEAVE_GROUP",payload:{des_id:s,src_id:i,user_role:n,status:this.isDefaultLeaveSilently(t)?GO.SILENTLY:GO[e.leaveType],silent_default:this.getLeaveGroupSilentlyType(t,e.leaveType)},noisedIds:[s,i]}),a.ModuleContainer.resolve(UO.b).onLeaveGroup({groupId:t,actorId:i,memberId:i,leaveType:e.leaveType,memberRole:n})}openPreventUpgradeCommunityReport(e){const{groupId:t,entryPoint:s,currentPkgId:a,errorCode:i}=e,n=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"PREVENT_UPGRADE_FLOW",payload:{des_id:n,entrypoint:s,error_code:i,user_type:a},noisedIds:[n]})}openPopupUpgradeCommunityReport(e){const{groupId:t,entryPoint:s}=e;this.upgradeCommunityCapture.startCapture(t,{entryPoint:s})}getVerificationStatusLogNumber(e){switch(e){case BO.b.NEED_VERIFY:return 0;case BO.b.VERIFIED:return 1;default:return 3}}actionBusinessRegistrationReport(e){const{groupId:t,pkgId:s,action:a}=e,i=this.upgradeCommunityCapture.finishCapture(t);if(!i)return;const n=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"ACTION_ZBIZ_REGISTER",payload:"close"===a?{des_id:n,action:a,entrypoint:i.params.entryPoint}:{des_id:n,action:a,register_package:s,entrypoint:i.params.entryPoint},noisedIds:[n]})}closePopupUpgradeCommunityReport(e){const{groupId:t,verificationStatus:s,upgradeStatus:a,errorCode:i,currentPkgId:n}=e,r=this.upgradeCommunityCapture.finishCapture(t);if(!r)return;const o=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"UPGRADE_COMMUNITY",payload:{des_id:o,upgrade_status:a,fail_error:i,duration:r.end-r.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:r.params.entryPoint,action:i?"confirm_upgrade":"close",user_type:n},noisedIds:[o]}),this.upgradeCommunityCapture.clearItem(t)}openPopupVerificationReport(e){const{groupId:t,entryPoint:s}=e;this.verificationCapture.startCapture(t,{entryPoint:s})}actionPopupVerificationReport(e){const{groupId:t,action:s,currentPkgId:a,totalMember:i,isAfterAction:n}=e,r=this.verificationCapture.getItem(t);if(!r)return;const o=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:n?"AFTER_ACTION_KYC_FLOW":"ACTION_KYC_FLOW",payload:{des_id:o,action:s,entrypoint:r.params.entryPoint,member_size:i,user_type:a},noisedIds:[o]})}closePopupVerificationReport(e){const{groupId:t,verificationStatus:s,action:a,currentPkgId:i}=e,n=this.verificationCapture.finishCapture(t);if(!n)return;const r=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"VERIFY_ACCOUNT",payload:{des_id:r,duration:n.end-n.start,is_kyc:this.getVerificationStatusLogNumber(s),entrypoint:n.params.entryPoint,action:a||"close",user_type:i},noisedIds:[r]}),this.verificationCapture.clearItem(t)}clickCommunityLearnMoreReport(e){const{groupId:t,entryPoint:s,currentPkgId:a}=e,i=ui.default.getGroupIdFromConversationId(t);this.logAction999({type:"CLICK_LEARN_MORE",payload:{des_id:i,entrypoint:s,user_type:a},noisedIds:[i]})}mapGroupEntryToCommunity(e){switch(e){case"gr_add_member":return"comm_add_member";case"gr_member_approval":return"comm_member_approval";case"message_info":return"msg_info";default:return e}}openPreventAddMemberReport(e){const{entryPoint:t,groupId:s,type:a,currentPkgId:i,totalMember:n}=e,r=ui.default.getGroupIdFromConversationId(s);this.logAction999({type:"need_kyc"===a?"ENTER_KYC_FLOW":"ENTER_UPGRADE_FLOW",payload:{des_id:r,entrypoint:this.mapGroupEntryToCommunity(t),user_type:i,member_size:n},noisedIds:[r]})}});var KO=s("sEfC"),ZO=s.n(KO);var $O,QO=class{constructor(e){this.key=void 0,this._data=void 0,this.key=e}get data(){if(!this._data){const e=n.default.getInstance().getItemForCurrentUser(this.key);let t=[];if(null!==e){try{t=JSON.parse(e)}catch{t=[]}Array.isArray(t)||(t=[])}this._data=new Set(t)}return this._data}addItem(e){this.data.has(e)||(this.data.add(e),n.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}removeItem(e){this.data.has(e)&&(this.data.delete(e),n.default.getInstance().setItemForCurrentUser(this.key,JSON.stringify(Array.from(this.data.values()))))}clear(){this.data.clear(),n.default.getInstance().removeItemForCurrentUser(this.key)}hasItem(e){return this.data.has(e)}},YO=s("+jN4"),JO=s("Ei7k");Object(a.injectable)()($O=Object(m.j)()($O=Object(m.h)()($O=Object(xi.b)(el.e)($O=function(e,t){return Object(a.inject)(el.h)(e,void 0,0)}($O=Reflect.metadata("design:type",Function)($O=Reflect.metadata("design:paramtypes",[void 0===el.h?Object:el.h])($O=class{constructor(e){this.onboardController=e,this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.verification=void 0,this.hiddenChatBoxBannerGroups=void 0,this.handleUpdateDataItemImmediately=({groupId:e})=>{const t={groupId:e,bannerStatus:this.getBannerStatusForItem(e)};this.data.set(e,t),this.signalUpdateItem(e)},this.handleUpdateDataItem=ZO()(this.handleUpdateDataItemImmediately,300,{leading:!1,trailing:!0}),this.handleUsagedGroupInfoChange=({groupId:e},t)=>{if(!t&&!PO.GroupSettingHelper.isOwner(e,Ii.default.getUidMe()))return;const s=K.default.isOpenChildWindowByConvId(e),i=e==a.ModuleContainer.resolve(rc.SidebarController).getCurrMainConvId();(s||i)&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItem({groupId:e})})),this.verification.loaded=!0):this.handleUpdateDataItem({groupId:e}))},this.handleChangeOwnnerEvent=({groupId:e,ownerId:t})=>{(t==Ii.default.getUidMe()||this.data.has(e))&&this.handleUsagedGroupInfoChange({groupId:e},!0)},this.handleMultiGroupInfoChange=e=>{for(const t of e)this.handleUsagedGroupInfoChange({groupId:t})},this.handleProfileVerificationChange=e=>{this.verification={loaded:!0,status:e};const t=[];this.data.forEach((e=>{t.push([e.groupId,Object(I.a)(Object(I.a)({},e),{},{bannerStatus:this.getBannerStatusForItem(e.groupId)})])})),this.data=new Map(t),this.signalUpdateAllItems()},this.handleLeaveGroupEvent=e=>{for(const t of e)this.data.delete(t),this.hiddenChatBoxBannerGroups.removeItem(t)},this.name=el.a,this.key="groupId",this.data=new Map,this.verification={loaded:!1,status:null},this.hiddenChatBoxBannerGroups=new QO(el.c)}init(){throw new Error("Method not implemented.")}onStart(){yn.default.subscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),yn.default.subscribeEventGroup(Y.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),yn.default.subscribeEventGroup(Y.EventGroup.CHANGE_OWNER,this.handleChangeOwnnerEvent),yn.default.subscribeEventGroup(Y.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),yn.default.subscribeEventGroup(Y.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),Ii.default.subscribeEventFriend(Y.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}onDispose(){yn.default.unsubscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),yn.default.unsubscribeEventGroup(Y.EventGroup.UPGRADE_COMMUNITY,this.handleUsagedGroupInfoChange),yn.default.unsubscribeEventGroup(Y.EventGroup.CHANGE_OWNER,this.handleUsagedGroupInfoChange),yn.default.unsubscribeEventGroup(Y.EventGroup.SIZE_CHANGE,this.handleUsagedGroupInfoChange),yn.default.unsubscribeEventGroup(Y.EventGroup.GROUP_INFO_CHANGED,this.handleMultiGroupInfoChange),Ii.default.unsubscribeEventFriend(Y.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(nc.h)(this.name,e)}signalUpdateAllItems(){this.data.forEach((e=>{this.signalUpdateItem(e.groupId)}))}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.community,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"dx3r9B","Get community data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"xwVr_J","Get community data list failed",e)}getOwnedCommunities(){const e=yn.default.getGroupsListSync(),t=Ii.default.getUidMe(),s=[];for(const a of e)a.creatorId===t&&el.q.isCommunityFromInfo(a)&&s.push(a);return s}getJoinedCommunities(){const e=yn.default.getGroupsListSync(),t=[];for(const s of e)el.q.isCommunityFromInfo(s)&&t.push(s);return t}getProfileVerificationStatus(){return this.verification.status}getBannerStatusForItem(e){if(null===this.verification.status)return{show:!1};const t=yn.default.getGroupByIdSync(e);if("number"!=typeof(null==t?void 0:t.totalMember)||t.creatorId!=Ii.default.getUidMe())return{show:!1};const s=el.q.isCommunityFromInfo(t);let a,i=!1;const n=new Set([el.f.CHAT_BOX,el.f.RIGHT_BAR]);return this.verification.status===BO.b.VERIFIED?(i=!s&&t.totalMember>=Ce.default.group_privacy.community.grouptype_threshold,a=el.g.REACHED_UPGRADE):(i=s||t.totalMember>=Ce.default.group_privacy.community.minimum_warn_upgrade,a=s?el.g.UPGRADED_VERIFY:t.totalMember>=Ce.default.group_privacy.community.grouptype_threshold?el.g.REACHED_VERIFY:el.g.NEARLY_REACH_VERIFY),this.hiddenChatBoxBannerGroups.hasItem(e)&&n.delete(el.f.CHAT_BOX),{show:i,type:a,position:n}}getAccountVerificationStatus(e){Ii.default.getVerificationStatusMe().then((t=>{this.verification.status=t,null==e||e(t)})).catch((e=>{this.Logger.zsymb(18,"Cz5XRg","Get account verification status failed",e)}))}upgradeToCommunity(e){return new Promise(((t,s)=>{qc.default.upgradeGroupToCommunity(e).then((()=>{this.Logger.zsymb(18,"6m9Ecd","Upgrade community succeed",e),t()})).catch((t=>{this.Logger.zsymb(18,"Hs35Zb","Upgrade community failed",e,t),s(t)}))}))}shouldLoadVerificationStatus(e){if(this.verification.loaded&&this.verification.status===BO.b.VERIFIED)return!1;const t=yn.default.getGroupByIdSync(e);return"number"==typeof(null==t?void 0:t.totalMember)&&(el.q.isCommunityFromInfo(t)||t.totalMember>=Ce.default.group_privacy.community.minimum_warn_upgrade)}onConversationDidOpen(e){this.onboardController.onConversationDidOpen(e),Qu.a.isGroup(e)&&PO.GroupSettingHelper.isOwner(e,Ii.default.getUidMe())&&(this.shouldLoadVerificationStatus(e)?(this.getAccountVerificationStatus((()=>{this.handleUpdateDataItemImmediately({groupId:e})})),this.verification.loaded=!0):this.data.has(e)||this.handleUpdateDataItemImmediately({groupId:e}))}onReceivedCommunityError({groupId:e,errorCode:t,windowId:s,src:i}){const n=PO.GroupSettingHelper.isOwner(e,Ii.default.getUidMe());switch(t){case Y.GROUP_MEMBER_ERROR.OWNER_NEED_VERIFY_PROFILE:n?(YO.b(s,e,i),i&&a.ModuleContainer.resolve(el.p).openPreventAddMemberReport({groupId:e,type:"need_kyc",entryPoint:i,currentPkgId:Ii.default.getPkgIdCurrent(),totalMember:yn.default.getTotalMember(e)})):Ie.ModalManagerV2.openModal({windowId:s,name:Y.ModalIdentitiesDefine.COMMUNITY_PREVENT_ADD_MEMBER,params:{groupId:e,errorCode:t,src:i}});break;case Y.GROUP_MEMBER_ERROR.REACHED_LIMIT_MEMBER_GROUP:Ie.ModalManagerV2.openModal({windowId:s,name:Y.ModalIdentitiesDefine.COMMUNITY_PREVENT_ADD_MEMBER,params:{groupId:e,errorCode:t,src:i}}),i&&n&&a.ModuleContainer.resolve(el.p).openPreventAddMemberReport({groupId:e,type:"need_upgrade",entryPoint:i,currentPkgId:Ii.default.getPkgIdCurrent(),totalMember:yn.default.getTotalMember(e)})}}closeChatBoxBanner(e){this.hiddenChatBoxBannerGroups.addItem(e),this.handleUpdateDataItemImmediately({groupId:e})}async checkCommunityQuota(e){const t=await qc.default.getQuotaCommunity(e);if(t&&t.canUpgr)return!0;throw{data:t}}async checkUpgradeCondition(e){const t=Ce.default.group_privacy.community_zbiz.base_pkg;if(!Ii.default.isMeBAAccount()){const s=this.getOwnedCommunities(),a=JO.a.getQuotaCommunity(t);return!(s.length>=a)||this.checkCommunityQuota(e)}return this.checkCommunityQuota(e)}async checkCommunityMemberQuota(e,t){try{const s=await qc.default.checkQuotaCommunityMember(e,t);this.Logger.zsymb(0,"UmUVfU","check member quota ok",e,t,s);const a={isQualified:s.canUpgr,content:s.content};if(s.canUpgr||s.othersCanUpgr)return a;throw{data:a}}catch(s){throw this.Logger.zsymb(18,"Yv5OQV","check member quota fail",e,t,s),s}}async checkCreateCondition(e){const t=Ii.default.getPkgIdCurrent();if(e===el.n.COMMUNITY){const e=JO.a.getQuotaCommunity(t),s=this.getOwnedCommunities().length;if(s>=e)throw{error_code:Y.GROUP_APPOINTMENT_ERROR.REACHED_LIMIT_OWNED_COMMUNITY,data:{error_message_localize:el.q.getReachedQuotaErrorMessageLocalize(e,s)}};return!0}const s=JO.a.getQuotaGroup(t);if(yn.default.getGroupsListSync().length>=s)throw{error_code:Y.GROUP_MEMBER_ERROR.REACHED_LIMIT_GROUP,data:{error_message_localize:ce.a.trans("STR_GROUP_PRIVACY_CANNOT_CREATE_GROUP_COMMUNITY_LIMIT",[String(s)])}};return!0}})||$O)||$O)||$O)||$O)||$O)||$O);var XO,eM=s("7Ull");Object(m.j)()(XO=Object(m.h)()(XO=Object(a.singleton)(el.h)(XO=Reflect.metadata("design:type",Function)(XO=Reflect.metadata("design:paramtypes",[])(XO=class{constructor(){this.onboardedGroups=void 0,this.lastOnboardedGroupId=void 0,this.onboardingCounter=void 0,this.status=void 0,this.emitter=void 0,this.recentUpgradedGroups=void 0,this.closeOnboard=e=>{this.status[e]&&(this.status=Object(I.a)(Object(I.a)({},this.status),{},{[e]:!1}),this.emitter.emit("change",this.status))},this.isCanShowOnboard=e=>{const t=this.onboardingCounter.getItem(e);return"number"!=typeof t||t<Ce.default.group_privacy.community.max_onboard_times},this.handleGroupUpgradeEvent=({groupId:e})=>{this.recentUpgradedGroups.add(e);const t=K.default.isOpenChildWindowByConvId(e),s=e==a.ModuleContainer.resolve(rc.SidebarController).getCurrMainConvId();Ce.default.group_privacy.community.enable_ui&&(t||s)&&(PO.GroupSettingHelper.isOwner(e,Ii.default.getUidMe())?(this.status=Object(I.a)(Object(I.a)({},this.status),{},{popup:!0,tip:!1}),this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,el.i.POPUP)):this.isCanShowOnboard(el.i.TIP)&&(this.status=Object(I.a)(Object(I.a)({},this.status),{},{tip:!0,popup:!1}),this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),Ce.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,el.i.TIP)))},this.handleLeaveGroupEvent=e=>{for(const t of e)this.recentUpgradedGroups.delete(t)},this.handleOpenChildWindow=({windowId:e})=>{const t=K.default.getConvIdFromWindowId(e);this.onConversationDidOpen(t)},this.onboardedGroups=new Set,this.lastOnboardedGroupId=null,this.onboardingCounter=new eM.a(el.d),this.status={tip:!1,popup:!1},this.recentUpgradedGroups=new Set,this.emitter=new Sp.a}onStart(){yn.default.subscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),yn.default.subscribeEventGroup(Y.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),K.default.subscribe(Ar.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow)}onDispose(){yn.default.unsubscribeEventGroup(Y.EventGroup.LEAVE_GROUP,this.handleLeaveGroupEvent),yn.default.unsubscribeEventGroup(Y.EventGroup.UPGRADE_COMMUNITY,this.handleGroupUpgradeEvent),K.default.unsubscribe(Ar.a.CHILD_WINDOW_ALIVE,this.handleOpenChildWindow),this.recentUpgradedGroups.clear()}getStatus(){return this.status}hasOnboardedGroupId(e){return this.onboardedGroups.has(e)}getLastOnboardedGroupId(){return this.lastOnboardedGroupId}isDoneOnboard(){return!Object.values(el.i).some(this.isCanShowOnboard)}getStatusForGroup(e){return this.recentUpgradedGroups.has(e)?{tip:!1,popup:this.isCanShowOnboard(el.i.POPUP)}:{tip:this.isCanShowOnboard(el.i.TIP),popup:!1}}onConversationDidOpen(e){Ce.default.group_privacy.community.enable_ui&&Qu.a.isGroup(e)&&el.q.isCommunity(e)&&!this.onboardedGroups.has(e)&&(this.status=this.getStatusForGroup(e),this.status.tip&&(this.emitter.emit("change",this.status),setTimeout((()=>{this.closeOnboard("tip")}),Ce.default.group_privacy.community.onboard_tip_time),this.onDoneNewOnboardingLevel(e,el.i.TIP)),this.status.popup&&(this.emitter.emit("change",this.status),this.onDoneNewOnboardingLevel(e,el.i.POPUP)))}onDoneNewOnboardingLevel(e,t){if(this.isDoneOnboard())return;this.lastOnboardedGroupId=e,e&&this.onboardedGroups.add(e);let s=this.onboardingCounter.getItem(t);"number"!=typeof s&&(s=0),this.onboardingCounter.setItem(t,s+1)}resetOnboardFlagFromLocal(){this.lastOnboardedGroupId=null,this.onboardedGroups.clear(),this.onboardingCounter.clear()}})||XO)||XO)||XO)||XO);var tM,sM=s("eCBG");Object(m.h)()(tM=Object(m.j)()(tM=Object(a.singleton)(el.o)(tM=Reflect.metadata("design:type",Function)(tM=Reflect.metadata("design:paramtypes",[])(tM=class extends hs.b{constructor(){super(),this.cachedGroupOwnerInfo=void 0,this.logger=void 0,this.onOpenConvChildWindow=e=>{const t=K.default.getConvIdFromWindowId(e);this.onOpenConversation(t)},this.cachedGroupOwnerInfo=new Set}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.community,[el.k])),this.logger}handlePreloadOwnerInfo(e){const t=yn.default.getMiniInfoGroup(e);null!=t&&t.creatorId&&!this.cachedGroupOwnerInfo.has(e)&&a.ModuleContainer.resolve(sM.PersonalController).getUserInfo(t.creatorId).then((t=>{this.cachedGroupOwnerInfo.add(e),this.dispatchEvent(new el.m("done-preload-owner-info",e,{info:t}))})).catch((e=>{this.Logger.zsymb(18,"9InIkf","Load owner info fail",t,e)}))}onStart(){K.default.subscribe(Ar.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow)}onDispose(){K.default.unsubscribe(Ar.a.CHILD_WINDOW_ALIVE,this.onOpenConvChildWindow),this.cachedGroupOwnerInfo.clear()}onOpenConversation(e){ui.default.isGroup(e)&&Ce.default.group_privacy.group_created_by_oa&&this.handlePreloadOwnerInfo(e)}getMiniGroupInfo(e){return yn.default.getMiniInfoGroup(e)}})||tM)||tM)||tM)||tM);const aM=["groupId","memberId","actorId"],iM=["groupId","memberId","actorId"];var nM;Object(a.singleton)(el.l)(nM=Reflect.metadata("design:type",Function)(nM=Reflect.metadata("design:paramtypes",[])(nM=class{constructor(){this.name=void 0,this.logger=void 0,this.name=el.j}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.group,[this.name])),this.logger}onAppointAdmin(e){const{groupId:t,memberId:s,actorId:a}=e;this.Logger.zsymb(0,"094pak",`add admin group=${t} mem=${s} actor=${a}`)}onRemoveAdmin(e){const{groupId:t,memberId:s,actorId:a}=e;this.Logger.zsymb(0,"2Zr68Y",`remove admin group=${t} mem=${s} actor=${a}`)}onLeaveGroup(e){const{groupId:t,memberId:s,actorId:a}=e,i=Object($i.a)(e,aM);this.Logger.zsymb(0,"qKY2rj",`leave group=${t} mem=${s} actor=${a}`,i)}onRemoveMember(e){const{groupId:t,memberId:s,actorId:a}=e,i=Object($i.a)(e,iM);this.Logger.zsymb(0,"95fQrA",`kickout group=${t} mem=${s} actor=${a}`,i)}})||nM)||nM);var rM=s("P+Nn");let oM=function(e){return e[e.SEND_FSS=4]="SEND_FSS",e[e.SEND_CARD=5]="SEND_CARD",e}({}),cM=function(e){return e[e.CHAT_11=1]="CHAT_11",e[e.CHAT_GROUP=2]="CHAT_GROUP",e[e.MY_CLOUD=3]="MY_CLOUD",e}({});var lM=s("nmtd");a.ModuleContainer.registerSingleton(rM.a,class{logAction999(e){const{type:t,payload:s,noisedIds:a}=e;switch(t){case lM.a.CARD:Ia.default.logActionInfoV2(Ia.FeaturesInfo.SendFSS,oM.SEND_CARD,s,a);break;case lM.a.STICKER:Ia.default.logActionInfoV2(Ia.FeaturesInfo.SendFSS,oM.SEND_FSS,s,a)}}getChatTypeFromConvId(e){return ui.default.isGroup(e)?cM.CHAT_GROUP:OS.a.isSendToMe(e)?cM.MY_CLOUD:cM.CHAT_11}getRawDestinationId(e,t){return t===cM.CHAT_GROUP?ui.default.getGroupIdFromConversationId(e):e}sendCardReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),a=Ii.default.getUidMe();this.logAction999({type:lM.a.CARD,payload:{src_id:a,des_id:s,chat_type:t,group_id:t===cM.CHAT_GROUP?s:null,ecard:{background_id:e.backgroundId,char_count:e.charCount,list_title_id:e.listTitleId,tagline_id:e.taglineId}},noisedIds:[a,s]})}sendFSSReport(e){const t=this.getChatTypeFromConvId(e.toUid),s=this.getRawDestinationId(e.toUid,t),a=Ii.default.getUidMe();this.logAction999({type:lM.a.STICKER,payload:{src_id:a,des_id:s,chat_type:t,cate_id:e.categoryId,sticker_id:e.stickerId,group_id:t===cM.CHAT_GROUP?s:null},noisedIds:[a,s]})}});var dM,uM=s("dgg9"),hM=s("MjbT"),gM=s("xn9U");class mM{constructor(){this.didChangeBusinessInfo=e=>{if(e&&e.bizInfo){const t=e.bizInfo.pkgId,s=a.ModuleContainer.resolve(uM.f);s.getBannerPositions().forEach((e=>{var a;const i=s.getBannerAtPosition(e);i&&i.type===uM.a.BUSINESS&&null!==(a=i.targetPkgIds)&&void 0!==a&&a.includes(t)&&s.closeBannerAtPosition(e)}))}}}onStart(){Ii.default.subscribeEventFriend(Y.EventFriend.UPGRADE_BIZ_PROFILE,this.didChangeBusinessInfo),Ii.default.subscribeEventFriend(Y.EventFriend.DOWNGRADE_BIZ_PROFILE,this.didChangeBusinessInfo)}onDispose(){Ii.default.unsubscribeEventFriend(Y.EventFriend.UPGRADE_BIZ_PROFILE,this.didChangeBusinessInfo),Ii.default.unsubscribeEventFriend(Y.EventFriend.DOWNGRADE_BIZ_PROFILE,this.didChangeBusinessInfo)}allowAddBannerAtPosition(e,t){if(e.type===uM.a.BUSINESS){var s;const t=Ii.default.getPkgInfo(Ii.default.getUidMe());if(t&&null!==(s=e.targetPkgIds)&&void 0!==s&&s.includes(t.pkgId))return"number"==typeof e.targetPkgRenewThreshold&&e.targetPkgRenewThreshold>0&&"number"==typeof t.expired&&t.expired-Ct.default.getTimeNow()<=e.targetPkgRenewThreshold}return!0}}class pM{constructor(){this.didChangeZCloudPlan=e=>{const t=a.ModuleContainer.resolve(uM.f);t.getBannerPositions().forEach((s=>{var a;const i=t.getBannerAtPosition(s);i&&i.type===uM.a.ZCLOUD&&null!==(a=i.targetPkgIds)&&void 0!==a&&a.includes(e)&&t.closeBannerAtPosition(s)}))}}onStart(){qE.a.getInstance().addListener(ZE.c.CHANGE_PLAN,this.didChangeZCloudPlan)}onDispose(){qE.a.getInstance().removeListener(ZE.c.CHANGE_PLAN,this.didChangeZCloudPlan)}allowAddBannerAtPosition(e,t){if(e.type===uM.a.ZCLOUD){var s;const t=hO.a.getInstance().plan;if(null!==(s=e.targetPkgIds)&&void 0!==s&&s.includes(t)){if("number"==typeof e.targetPkgRenewThreshold&&e.targetPkgRenewThreshold>0){var a;const t=gM.a.getInstance().getInfoSync(),s=null==t||null===(a=t.subscription_info)||void 0===a?void 0:a.expire_time;if("number"==typeof s&&s-Ct.default.getTimeNow()<=e.targetPkgRenewThreshold)return!0}return!1}}return!0}}Object(m.d)()(dM=Object(m.j)()(dM=Object(m.h)()(dM=Object(a.singleton)(uM.f)(dM=Reflect.metadata("design:type",Function)(dM=Reflect.metadata("design:paramtypes",[])(dM=class{constructor(){this.logger=void 0,this.cacheBanners=void 0,this.hiddenBanners=void 0,this.repushedTimeCache=void 0,this.repushTimeout=void 0,this.businessManager=void 0,this.zcloudManager=void 0,this.isAppReady=void 0,this.businessManager=new mM,this.zcloudManager=new pM,this.cacheBanners=new Map,this.hiddenBanners=new eM.a(uM.j),this.repushedTimeCache=new eM.a(uM.k),this.repushTimeout=new Map}onStart(){this.businessManager.onStart(),this.zcloudManager.onStart()}onApplicationReady(){this.isAppReady=!0}onDispose(){this.businessManager.onDispose(),this.zcloudManager.onDispose()}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(es.ZLoggerNametags.operationBanner)),this.logger}allowAddBannerAtPosition(e,t){switch(e.type){case uM.a.BUSINESS:return this.businessManager.allowAddBannerAtPosition(e,t);case uM.a.ZCLOUD:return this.zcloudManager.allowAddBannerAtPosition(e,t);default:return!0}}checkForRepushingBannerItem(e){const t=this.cacheBanners.get(e);if(t&&t.max_repush&&hM.default._isValidEventData(t)){this.Logger.zsymb(0,"UOMYXq","check repush hidden",e);let s=this.repushedTimeCache.getItem(e)||0;const a=this.hiddenBanners.getItem(e),i=t.delay_time_repush||0;if(a&&i>0&&s<t.max_repush){const n=a+i-Ct.default.getTimeNow();this.Logger.zsymb(0,"hET-EC",`do repush ${e} remaining_time=${n}`),n<=0?(s+=1,this.repushedTimeCache.setItem(e,s),this.hiddenBanners.removeItem(e),this.showBannerAtPosition(t,t.displayPosition)):this.repushTimeout.set(t.displayPosition,window.setTimeout((()=>this.checkForRepushingBannerItem(e)),n))}else this.Logger.zsymb(0,"rGikoV",`not allow repush ${e}`,`delay=${i}`,`repushed=${s} max_repush=${t.max_repush}`)}}checkForRepushing(){this.hiddenBanners.keys().forEach((e=>{this.checkForRepushingBannerItem(e)}))}bannerWillProcess(){this.cacheBanners.clear(),this.repushTimeout.forEach((e=>{window.clearTimeout(e)})),this.repushTimeout.clear()}async bannerDidProcess(e){if(this.isAppReady){var t;const a=await gM.a.getInstance().getInfo();if(null==a||null===(t=a.subscription_info)||void 0===t||!t.expire_time)try{await gM.a.getInstance().getExpireTime()}catch(s){this.Logger.zsymb(18,"C7EOFx","get cloud expire time err",s)}setTimeout((()=>{e.forEach(this.showBannerAtPosition.bind(this)),this.checkForRepushing()}),200)}else a.ModuleContainer.resolve(m.a).addEventListenerOnce(m.b.ServicesReady,(()=>{this.isAppReady=!0,this.bannerDidProcess(e)}))}comparePriority(e,t){if(!t)return!0;const s=e.priority||0,a=t.priority||0;return s>a||!(s<a)&&e.startTimeInMillis>=t.startTimeInMillis}addPrioritizedBannerToMap(e,t,s){const a=this.getGlobalBannerId(t);return!(n.default.getInstance().getItemForCurrentUser(a)||this.hiddenBanners.hasItem(a))&&this.allowAddBannerAtPosition(t,e)&&this.comparePriority(t,s.get(e))?s.set(e,t):s}getGlobalBannerId(e){let t=e.displayPosition+"_"+e.id;return e.actionContent&&e.actionContent.version&&(t=t+"_"+e.actionContent.version),t}processBannerFromServerInfo(e){this.bannerWillProcess();const t=new Map;if(!e||"object"!=typeof e)return this.bannerDidProcess(t),this.Logger.zsymb(0,"NNKbIA","invalid data banner!",e),t;for(const s in e)if(Array.isArray(e[s]))for(let a=0;a<e[s].length;a++){const i=e[s][a];if(!i)continue;try{i.actionContent=JSON.parse(i.actionContent)}catch{}if(!hM.default._isValidEventData(i))continue;const n=this.getGlobalBannerId(i);if(i.displayPosition===Y.BANNER_POS_CSC_HEADER||i.displayPosition===Y.BANNER_POS_EMPTY_SCREEN){const e=i.displayPosition===Y.BANNER_POS_CSC_HEADER?i.actionContent.topBanners:i.actionContent.emptyBanners;if(e){const s=[];for(let t=0;t<e.length;t++){const a=e[t];!a||a.condition&&!ui.default.userMeetConditions(hM.default._fnCallbackTmp?hM.default._fnCallbackTmp():hM.default._getUserData(),a.condition)||s.push(a)}if(s.length>0){const e=s[Math.floor(Math.random()*s.length)];this.addPrioritizedBannerToMap(i.displayPosition,e,t),this.cacheBanners.set(n,e)}}}else this.addPrioritizedBannerToMap(i.displayPosition,i,t),this.cacheBanners.set(n,i)}return this.bannerDidProcess(t),t}getBannerAtPosition(e){switch(e){case Y.BANNER_POS_TAB_MSG_HEADER:return Ce.default.messageBanner;case Y.SIDEBAR_TOP_AVATAR:return Ce.default.santa_hat;case Y.SIDEBAR_LEFT_MENU:return Ce.default.leftMenu;case Y.BANNER_POS_CSC_HEADER:return Ce.default.topBanner;case Y.BANNER_POS_EMPTY_SCREEN:return Ce.default.emptyBanner;default:return null}}getBannerPositions(){return[Y.BANNER_POS_TAB_MSG_HEADER,Y.SIDEBAR_TOP_AVATAR,Y.SIDEBAR_LEFT_MENU,Y.BANNER_POS_CSC_HEADER,Y.BANNER_POS_EMPTY_SCREEN]}closeBannerAtPosition(e){const t=this.getBannerAtPosition(e);if(t){const s=this.getGlobalBannerId(t);this.hiddenBanners.setItem(s,Ct.default.getTimeNow()),hM.default._setBannerAtPosition(null,e);const i=t.delay_time_repush||0;return e===Y.BANNER_POS_TAB_MSG_HEADER&&a.ModuleContainer.resolve(rc.ConvListController).rerenderList(),i>0&&this.repushTimeout.set(e,window.setTimeout((()=>this.checkForRepushingBannerItem(s)),i)),this.Logger.zsymb(0,"DLXxTW","closed banner",s,e,`delay repush=${i}`),!0}return!1}showBannerAtPosition(e,t){if(this.Logger.zsymb(0,"aGTiP_","request show banner",e.id,t),this.allowAddBannerAtPosition(e,t)){const s=this.getBannerAtPosition(t);if(this.comparePriority(e,s))return hM.default._setBannerAtPosition(e,t),t===Y.BANNER_POS_TAB_MSG_HEADER&&a.ModuleContainer.resolve(rc.ConvListController).rerenderList(),this.Logger.zsymb(0,"_dJ1BA","done show banner",e.id),!0}return!1}})||dM)||dM)||dM)||dM)||dM);var fM=s("yQd5");const vM=`${fM.b}-network-manager`;var _M=Object(a.define)(vM),bM=s("DPHK");var IM=class{constructor(){}updateMyAvatar(e,t,s,a={},i=!1){return Ii.default.updateMyAvatar(e,s,t,a)}updateGroupAvatar(e,t,s,a,i){let n=fM.a.w,r=fM.a.h;return i&&(i.originWidth&&(n=i.originWidth),i.originHeight&&(r=i.originHeight)),this.resolveRequest(So.default.updateAvatar(e,t,a,s,n,r))}updateAvatar(e,t,s=120,a={},i=!1){const n=e+bM.a.getFullTimeFromMilisecond((new Date).getTime());return ui.default.isGroup(e)?this.updateGroupAvatar(e,s,t,n,a):this.updateMyAvatar(s,t,n,a,i)}async reuseAvatar(e,t){let s={photoId:e,isPostSocial:t?1:0};const a=H.b.getProfileDomain()+"/api/social/reuse-avatar?"+this._getCommonParams()+"&params="+this.getEncodedParams(s);return this.resolveRequest(this._get(a,null,12453))}async getAvatarHistory(e,t,s,a){let i={page:e,albumId:s,count:a};t&&(i.photoId=t);const n=H.b.getProfileDomain()+"/api/social/avatar-list?"+this._getCommonParams()+"&params="+this.getEncodedParams(i);return this.resolveRequest(this._get(n,null,12451))}deleteAvatarHistory(e){let t={delPhotos:JSON.stringify(e.map((e=>({photoId:e.toString()}))))};const s=H.b.getProfileDomain()+"/api/social/del-avatars?"+this._getCommonParams()+"&params="+this.getEncodedParams(t);return this.resolveRequest(this._get(s,null,12452))}_get(e,t,s){return So.default._get(e,t,s)}_getCommonParams(){return So.default._getCommonParams()}getEncodedParams(e){return So.default.getEncodedParams(e)}resolveRequest(e){return new Promise(((t,s)=>{e.then(Co.a).then(t).catch(s)}))}};a.ModuleContainer.register(_M,class{get api(){return this._api||(this._api=new IM),this._api}constructor(){this._api=void 0,this._logger=void 0,this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(fM.b,["network-manager"])}async updateAvatar(e,t,s,a,i){this._logger.zsymb(0,"rESg1N",`updateAvatar [convId: ${e}], [s: ${t.size}] [share: ${i}] [meta:`,a);try{return await this.api.updateAvatar(e,t,s,a,i),Promise.resolve(!0)}catch(n){return this._logger.zsymb(18,"aLi5JF",`updateAvatar [convId: ${e}], [err:`,n),Promise.reject(n)}}async getAvatarHistory(e,t,s,a){return this._logger.zsymb(0,"Vi8Yyn",`getAvatarHistory [p:${e}], [pId:${t}], [aId:${s}], [c:${a}]`),this.api.getAvatarHistory(e,t,s,a)}async reuseAvatar(e,t){return this._logger.zsymb(0,"BOB9S2",`reuseAvatar [photoId: ${e}], [isPostSocial:`,t,"]"),this.api.reuseAvatar(e,t)}async deleteAvatarHistory(e){this._logger.zsymb(0,"nBCUDM","deleteAvatarHistory [photoIds: ",e);try{return await this.api.deleteAvatarHistory(e),Promise.resolve(!0)}catch(t){return Promise.reject(t)}}});const yM=`${fM.b}-repository`;var SM=Object(a.define)(yM);const CM=`${fM.b}-storage`;var EM,OM=Object(a.define)(CM),MM=s("nKYX"),TM=s("dVwc");let RM=Object(a.injectable)()(EM=function(e,t){return Object(a.inject)(OM)(e,void 0,0)}(EM=function(e,t){return Object(a.inject)(_M)(e,void 0,1)}(EM=Reflect.metadata("design:type",Function)(EM=Reflect.metadata("design:paramtypes",[Object,Object])(EM=class{constructor(e,t){this.storage=e,this.fetcher=t}reuseAvatar(e,t){return this.fetcher.reuseAvatar(e,t)}updateAvatar(e,t,s,a,i){return this.fetcher.updateAvatar(e,t,s,a,i)}async getAvatarHistory(e=0,t="",s="0",a=50){try{const i=await this.fetcher.getAvatarHistory(e,t,s,a);return this.mapApiDataToBackup(i),this.mapApiDataToModel(i)}catch(i){let e=MM.a.ERR_GET_AVA_HISTORY;return i&&i.code&&(e=i.code),Promise.reject({code:e,message:(null==i?void 0:i.message)||i})}}deleteAvatarHistory(e){return this.fetcher.deleteAvatarHistory(e)}mapApiDataToBackup(e){e.photos.length&&e.photos.forEach((({url:e,bkUrl:t})=>{TM.a.getInstance().setBackup(e,t)}))}mapApiDataToModel(e){return{albumId:e.albumId,hasMore:Boolean(e.hasMore),nextPhotoId:e.nextPhotoId,photos:e.photos.length?e.photos.map((e=>({photoId:e.photoId,thumb:e.thumbnail,url:e.url}))):[]}}})||EM)||EM)||EM)||EM)||EM;a.ModuleContainer.register(SM,RM);var wM;a.ModuleContainer.register(OM,class{constructor(){this._storage=void 0,this._logger=void 0}get storage(){return this._storage||(this._storage=Xt.default.getInstance()),this._storage}get logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(fM.b,["storage"])),this._logger}async getAvatarHistory(){return new Promise((async(e,t)=>{try{e(await this.storage.Core.AvaHistory.getAll())}catch(s){return this.logger.zsymb(18,"VRet06","getAvatarHistory",s),t(s)}}))}addNewAvatarToHistory(e){const t=(new Date).getTime();return this.storage.Core.AvaHistory.insert(Object(I.a)(Object(I.a)({},e),{},{submit_dttm:t}),{replace:!0})}deleteAvatarHistory(e){return this.storage.Core.AvaHistory.delete(e)}});let LM=Object(a.injectable)()(wM=function(e,t){return Object(a.inject)(SM)(e,void 0,0)}(wM=Reflect.metadata("design:type",Function)(wM=Reflect.metadata("design:paramtypes",[Object])(wM=class{get logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(fM.b,[w.ZLoggerNametags.controller])),this._logger}constructor(e){this.repository=e,this._logger=void 0,this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._historyAvatars=[],this._retryLoadMore=1}getFrameList(e){return e?Ce.default.operation_frame_list.group:Ce.default.operation_frame_list.personal}getDefaultAvatarList(){var e,t;return(null===Ce.default||void 0===Ce.default||null===(e=Ce.default.settings)||void 0===e||null===(t=e.group)||void 0===t?void 0:t.avt_group_template)||null}async getInitialAvatarHistory(e=50){return this._avatarHistoryMeta={page:1,photoId:"",albumId:"0",hasMore:!0},this._retryLoadMore=1,await this.getAvatarHistory(e)}async loadMoreAvatarHistory(){if(this._avatarHistoryMeta.hasMore&&this._retryLoadMore<3)try{return await this.getAvatarHistory()}catch(e){return this.logger.zsymb(0,"E9vofW","loadMoreAvatarHistory error",e),this.logger.zsymb(0,"aGurHz","retry loadmore",this._retryLoadMore),this._retryLoadMore++,this.loadMoreAvatarHistory()}return[]}async getAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:MM.a.ERR_NO_NETWORK,message:""});try{const t=await this.repository.getAvatarHistory(this._avatarHistoryMeta.page,this._avatarHistoryMeta.photoId,this._avatarHistoryMeta.albumId,e||50);return this._avatarHistoryMeta={albumId:t.albumId,page:this._avatarHistoryMeta.page+1,photoId:t.nextPhotoId,hasMore:t.hasMore},Array.prototype.push.apply(this._historyAvatars,t.photos),t.photos}catch(t){return this.logger.zsymb(18,"6tFZSr","Error getting avatar history",t),Promise.reject({code:MM.a.ERR_GET_AVA_HISTORY,message:(null==t?void 0:t.msg)||(null==t?void 0:t.message)})}}async deleteAvatarHistory(e){if(!this.isValidNetwork())return Promise.reject({code:MM.a.ERR_NO_NETWORK,message:""});try{return await this.repository.deleteAvatarHistory([e]),this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),!0}catch(t){if(this.logger.zsymb(18,"yO-wXU","deleteAvatarHistory",t),t&&t.errMap){const s=t.errMap;return Promise.reject({code:s[e],message:""})}return Promise.reject({code:MM.a.DELETE_AVATAR_ERROR,message:""})}}updateAvatar(e,t,s,a,i){return this.isValidNetwork()?this.repository.updateAvatar(e,t,s,a,i):Promise.reject({code:MM.a.ERR_NO_NETWORK,message:""})}async reuseAvatar(e,t){try{await this.repository.reuseAvatar(e,t);const s=this._historyAvatars.find((t=>t.photoId===e));return s&&(this._historyAvatars=this._historyAvatars.filter((t=>t.photoId!==e)),this._historyAvatars.unshift(s)),!0}catch(s){return Promise.reject(!1)}}isValidNetwork(){return le.b.getStateNetwork()===le.a.CONNECTED}})||wM)||wM)||wM)||wM;var DM=s("TGcW").a;a.ModuleContainer.registerSingleton(DM,LM);var AM=s("jB3n");class FM extends AM.a{constructor(){super()}}var kM=FM;var NM,PM=Object(a.define)("chat-list-manager-event-emitter");Object(a.singleton)(PM)(NM=Reflect.metadata("design:type",Function)(NM=Reflect.metadata("design:paramtypes",[])(NM=class extends kM{constructor(){super()}})||NM)||NM);var jM,UM=Object(a.define)("chat-list-ui-event-emitter");Object(a.singleton)(UM)(jM=Reflect.metadata("design:type",Function)(jM=Reflect.metadata("design:paramtypes",[])(jM=class extends kM{constructor(){super(),this.broadcastEventChanged=e=>{this.emit($.ChatListRenderEvent.OnDataChange,e)},a.ModuleContainer.resolve(PM).on($.ChatListRenderEvent.OnDataChange,this.broadcastEventChanged)}})||jM)||jM);var BM=class{constructor(e){this._token=void 0,null!=e&&(this.token=e)}isValidated(){return Boolean(this._token)}setToken(e){this.token=e}toString(){return void 0===this.token||null===this.token?"":String(this.token)}get token(){return this._token}set token(e){this._token=e}},zM=s("dA2Z");var GM=class{constructor(e){this._chatID="",this._messages=[],this._name="",void 0!==e.chatID&&e.chatID,this.chatID=e.chatID,e.name&&(this.name=e.name)}cleanUp(){}getMessages(){return Object(gc.a)(this.chatID).messages||[]}async requestMessages(e,t){const{amount:s=this.getDefaultLoadMoreMessagesAmount(),direction:a=zM.d.Backwards,fromMessageID:i}=e||{},{events:n,opts:r}=t||{};return i?a===zM.d.Backwards?ho.default.loadTopMessagesForConversation(this.chatID,n,r):a===zM.d.Forwards?ho.default.loadBottomMessagesForConversation(this.chatID,n,r):a===zM.d.Around?ho.default.jumpToMessage():[]:ho.default.getLastMessagesForConversation(this.chatID)}getDefaultLoadMoreMessagesAmount(){return Ce.default.numberMessage}get chatID(){return this._chatID}set chatID(e){this._chatID=e}get messages(){return this._messages}set messages(e){this._messages=e}get name(){return this._name}set name(e){this._name=e}};var xM,VM=Object(a.define)("chat-list-controller-factory");Object(a.singleton)(VM)(xM=class{constructor(){this._instanceMap=new Map,this._localID=new De.a}createController(e,t,s){if(t){if(this.isExistingController(t)){const e=this.instanceMap.get(t);if(e)return[t,e]}const s=new GM({chatID:e,name:t.toString()});return this.mapControllerToToken(t,s),[t,s]}const a=this.getUniqueToken(),i=new GM({chatID:e,name:a.toString()});return this.mapControllerToToken(a,i),[a,i]}deleteController(e){if(!this.isExistingController(e))return!1;return this.getExistingController(e).cleanUp(),this.instanceMap.delete(e.toString()),!0}getController(e){if(this.isExistingController(e))return this.getExistingController(e)}getExistingController(e){return this.instanceMap.get(e.toString())}getUniqueToken(){return new BM(this.localID.next().toString())}isExistingController(e){return this.instanceMap.has(e.toString())}mapControllerToToken(e,t){this.instanceMap.set(e.toString(),t)}get instanceMap(){return this._instanceMap}set instanceMap(e){this._instanceMap=e}get localID(){return this._localID}set localID(e){this._localID=e}});var HM=VM;var WM,qM=class{constructor(){this._map=new Map}deleteToken(e){this.map.delete(e)}hasToken(e){return this.map.has(e)}getToken(e){return this.map.get(e)}setToken(e,t){this.isValidatedToken(t)&&this.map.set(e,t)}isValidatedToken(e){return Boolean(e&&"function"==typeof e.isValidated&&e.isValidated())}get map(){return this._map}set map(e){this._map=e}},KM=s("wv5Y");Object(a.injectable)()(WM=Object(a.singleton)(KM.a)(WM=function(e,t){return Object(a.inject)(HM)(e,void 0,0)}(WM=function(e,t){return Object(a.inject)(PM)(e,void 0,1)}(WM=Reflect.metadata("design:type",Function)(WM=Reflect.metadata("design:paramtypes",[Object,Object])(WM=class{constructor(e,t){this.controllerFactory=e,this.eventEmitter=t,this._tokenManager=new qM}closeConversation(e,t){const s=this.createTokenForController(e,t);this.controllerFactory.deleteController(s),this.deleteTokenFromWindowID(t,s)}getMessages(e,t){const s=this.getController(e,t);return s?s.getMessages():[]}openConversation(e,t){const s=this.createTokenForController(e,t),[a,i]=this.controllerFactory.createController(e,s);this.mapTokenToWindowID(t,a),i.requestMessages().then((()=>{const e={messages:i.getMessages()};this.notifyEventRender(zM.b.OnDataChange,e)})).catch((e=>{}))}async requestMessages(e,t,s,a){const i=this.getController(e,t);return i?i.requestMessages(s,a):[]}transformMessages(e){return e}createTokenForController(e,t){return new BM(t+"_"+e)}deleteTokenFromWindowID(e,t){this.tokenManager.deleteToken(e)}getController(e,t){const s=this.createTokenForController(e,t);return this.controllerFactory.getController(s)}notifyEvent(e,t){this.eventEmitter.emit(e,t)}notifyEventRender(e,t){this.notifyEvent(e,t)}mapTokenToWindowID(e,t){this.tokenManager.setToken(e,t)}get tokenManager(){return this._tokenManager}set tokenManager(e){this._tokenManager=e}})||WM)||WM)||WM)||WM)||WM);var ZM=s("7w+8");var $M,QM=class{constructor(e){this.key="",this.name="",this._state={messages:[]},void 0!==e.key&&e.key,this.key=e.key,void 0!==e.name&&e.name,this.name="ChatListUIController_"+e.name,this.handleEventDataChanged=this.handleEventDataChanged.bind(this),this.init(e)}cleanUp(){Object(nc.k)(this),this.unregisterEventListeners()}getItem(e,t){if(e.key===zM.c.Messages)return this.state.messages}getList(e,t){return[]}init(e){Object(nc.e)(this),this.registerEventListeners()}onGetItemFailure(e,t){}onGetListFailure(e,t){}handleEventDataChanged(e){e.messages&&this.setState((t=>{t.messages=e.messages}),[zM.c.Messages])}registerEventListeners(){a.ModuleContainer.resolve(UM).on(zM.b.OnDataChange,this.handleEventDataChanged)}setState(e,t){const s=Object(rm.a)(this.state,e);this.state!==s&&(this.updateState(s),Array.isArray(t)&&t.forEach((e=>{Object(nc.h)(this.name,e)})))}unregisterEventListeners(){a.ModuleContainer.resolve(UM).off(zM.b.OnDataChange,this.handleEventDataChanged)}updateState(e){this.state=e}get state(){return this._state}set state(e){this._state=e}};Object(a.singleton)(ZM.a)($M=class{constructor(){this._existingTokenMap=new Map,this._instanceMap=new Map,this._localID=new De.a}createController(e,t){let s=this.getExistingToken(e,t);if(void 0!==s&&this.isExistingController(s)){const e=this.getController(s);if(e)return[s,e]}s=this.generateToken(e,t);const a=new QM({key:s.toString(),name:s.toString()});return this.createControllerWithNewToken(e,t,s,a),[s,a]}deleteController(e,t){const s=this.getExistingToken(e,t);if(void 0!==s&&this.isExistingController(s)){const e=this.getController(s);e&&e.cleanUp(),this.removeController(s)}this.removeExistingToken(e,t)}addExistingToken(e,t,s){const a=this.getKeyFrom(e,t);this.existingTokenMap.set(a,s)}createControllerWithNewToken(e,t,s,a){this.addExistingToken(e,t,s),this.mapController(s,a)}getController(e){return this.instanceMap.get(e.toString())}getExistingToken(e,t){const s=this.getKeyFrom(e,t);return this.existingTokenMap.get(s)}getKeyFrom(e,t){return t+"_"+e}generateToken(e,t){const s=t+"_"+e+"_"+this.localID.next();return new BM(s)}isExistingController(e){return this.instanceMap.has(e.toString())}mapController(e,t){this.instanceMap.set(e.toString(),t)}removeController(e){this.instanceMap.delete(e.toString())}removeExistingToken(e,t){const s=this.getKeyFrom(e,t);this.existingTokenMap.delete(s)}get existingTokenMap(){return this._existingTokenMap}get instanceMap(){return this._instanceMap}get localID(){return this._localID}});var YM=Object(a.define)("chat-list-render-service"),JM=s("1Kge"),XM=s("rJdt"),eT=s("vUxW"),tT=s("g7V2"),sT=s("dMXo");class aT{constructor(){this.isAvatarShown=!1,this.isDateChanged=!1,this.isFirstInBlock=!1,this.isFirstInList=!1,this.isLastInBlock=!1,this.isLastInList=!1,this.isTimeSeparatorShown=!1,this.timestamp=0,this.vanishMode=void 0}setAvatarShown(e){return this.isAvatarShown=Boolean(e),this}setDateChanged(e){return this.isDateChanged=Boolean(e),this}setFirstInBlock(e){return this.isFirstInBlock=Boolean(e),this}setFirstInList(e){return this.isFirstInList=Boolean(e),this}setLastInBlock(e){return this.isLastInBlock=Boolean(e),this}setLastInList(e){return this.isLastInList=Boolean(e),this}setTimeSeparatorShown(e){return this.isTimeSeparatorShown=Boolean(e),this}setTimestamp(e){const t="number"==typeof e||!isNaN(Number(e));return Object(ua.b)(t,"Timestamp should be a number"),t&&(this.timestamp=+e),this}setVanishModeEnded(){return this.vanishMode="end",this}setVanishModeStarted(){return this.vanishMode="start",this}build(){return{isAvatarShown:this.isAvatarShown,isDateChanged:this.isDateChanged,isFirstInBlock:this.isFirstInBlock,isFirstInList:this.isFirstInList,isLastInBlock:this.isLastInBlock,isLastInList:this.isLastInList,isTimeSeparatorShown:this.isTimeSeparatorShown,timestamp:this.timestamp,vanishMode:this.vanishMode}}}class iT{constructor(e,t){this.type=void 0,this.data=void 0,this.UIDataBuilder=new aT,sT.a.isChatItem(e)?this.type=e:this.type=sT.a.for(String(e)),this.data=t}getData(){return this.data}getType(){return this.type}getUIBuilder(){return this.UIDataBuilder}getUIData(){return this.UIDataBuilder.build()}}var nT=s("x/wQ");function rT(e){return e.msgType}function oT(e){return e.message}function cT(e,t,s){if(!e)return[];let a=[];const i=rT(e);if(i===Y.MSG_INFO_CHAT)a.push(new iT(sT.a.MessageInfo,e));else if(i===Y.MSG_INFO||i===Y.MSG_GROUP_NOTI||i===Y.MSG_FRIEND_SENT_REQUEST||i===Y.MSG_SUGGEST_IN_CHAT){let i=!1;Ce.default.e2ee.invisible&&"update_e2ee"===e.act&&(i=!0),i||(a.push(new iT(sT.a.MessageEvent,e)),Ce.default.enable_hi_group_member&&e.msgType===Y.MSG_INFO&&"join"===e.act&&e.updateMemberIds&&e.updateMemberIds.indexOf(J.p.getSessionUserId())>=0&&s.length-t<=15&&a.push(new iT(sT.a.Guide,e)))}else if(i===Y.MSG_ECARD){const t=function(e,t){let s=!0;if(oT(e).type===Y.ECARD_TYPE.FRIEND_ACCEPT||oT(e).type===Y.ECARD_TYPE.FRIEND_ACCEPT_PASSIVE){const a=t.findIndex((t=>t.msgId===e.msgId));for(let e=a+1;e<a+15;e++){const a=t[e];if(!a)break;if(rT(a)===Y.MSG_ECARD&&oT(a).type===Y.ECARD_TYPE.BIRTHDAY){s=!1;break}}}return s?new iT(sT.a.Ecard,e):null}(e,s);t&&a.push(t)}else if(i===Y.MSG_POLL)a.push(new iT(sT.a.Poll,e));else if(i===Y.MSG_TODO)a.push(new iT(sT.a.Todo,e));else if(Object(x_.X)(e)){let t=!1;const i=s.findIndex((t=>t.msgId===e.msgId));let n,r=s[i+1];r&&Object(x_.X)(r)&&(n=r),tT.isZInstantTypeSupported(e)&&(tT.shouldCollapseZInstantMsg(e,n)||tT.shouldRenderDefaultLayout(e))&&(t=!0);let o=null;o=new iT(!0===t?sT.a.ZInstant:sT.a.MessageItem,e),o&&a.push(o)}else a.push(new iT(sT.a.MessageItem,e));return a.length>0&&a.forEach((t=>{var s;t.getUIBuilder().setTimestamp(null!==(s=e.sendDttm)&&void 0!==s?s:e.ts)})),a}var lT=function(e,t,s){return Array.isArray(e)?e.map(((e,t)=>cT(e,t,s))).flat().map(((e,s,a)=>{var i;return 0===s&&(e.getUIBuilder().setFirstInBlock(!0),t.forEach((s=>{s===nT.a.VanishModeStarted?e.getUIBuilder().setVanishModeStarted():s===nT.a.VanishModeEnded?e.getUIBuilder().setVanishModeEnded():s===nT.a.SentTimeTooLong?e.getUIBuilder().setTimeSeparatorShown(!0):s===nT.a.DateChanged?e.getUIBuilder().setTimeSeparatorShown(!0).setDateChanged(!0):s===nT.a.FirstBlock?e.getUIBuilder().setTimeSeparatorShown(!0):s===nT.a.DifferentSender||s===nT.a.StandaloneTypeChanged&&(e.getUIBuilder().setTimeSeparatorShown(!0),e.getType()!==sT.a.MessageInfo&&e.getType()!==sT.a.MessageEvent&&e.getType()!==sT.a.Poll||t.includes(nT.a.SentTimeTooLong)||t.includes(nT.a.DateChanged)||e.getUIBuilder().setTimeSeparatorShown(!1)),s&&e.getUIBuilder().setAvatarShown(!0)}))),s===a.length-1&&e.getUIBuilder().setLastInBlock(!0),e.getType()===sT.a.MessageItem&&(null===(i=a[s-1])||void 0===i?void 0:i.getType())===sT.a.ZInstant&&e.getUIBuilder().setAvatarShown(!0),e})):[]},dT=s("XkoV"),uT=s("Gy64"),hT=s("CFkE");function gT(e){try{return parseInt(e.cliMsgId)}catch(t){return 0}}var mT=function(e,t,s){const a=new Map;if(e.length<=0)return e;const i={},n={},r={},o=[];for(let d=0;d<e.length;d++){if(i[d])continue;const u=e[d];let h=u;const g=null!=n[d]?n[d]:t.getGroupPhotoId(u);if(g){var c;let a=u;const o=[u];let l=t.getTotalGroupPhotoItem(u)-1;if(l<=0)continue;for(let s=d+1;s<e.length;s++){if(i[s])continue;let a,r=e[s];if(null!=n[s]?a=n[s]:(a=t.getGroupPhotoId(r),n[s]=a),!a||g!=a)break;if(o.push(r),i[s]=!0,l--,0==l)break}o.sort(((e,t)=>gT(e)-gT(t)));const m=o.reduce(((e,t)=>t.e2eeStatus===Y.MSG_E2EE||e),!1);let p;a=o[o.length-1],o.some((e=>{const t=Object(fe.i)(e);return uT.a.getInstance().isExisted(s,t)&&(p=uT.a.getInstance().getGroupId(s,t)),!!p})),p||(p=Object(fe.i)(o[0]));let f=p;r[f]&&(f=p+"_"+uT.a.getInstance().getRandKey()),r[f]=!0,o.forEach((e=>{const t=Object(fe.i)(e);uT.a.getInstance().setGroupId(s,t,f)})),h=Object(I.a)({msgId:f,cliMsgId:f,msgType:Y.MSG_PHOTO_GROUP,sendDttm:a.sendDttm,status:null!==(c=t.getGroupStickerPhotoStatus(o))&&void 0!==c?c:a.status,fromUid:a.fromUid,toUid:a.toUid,message:o},m&&{e2eeStatus:Y.MSG_E2EE})}const m=t.isStickerButNotNewFSSMessage(u),p=t.isNewFSSMessage(u),f=!m&&!p&&t.isAIStickerMessage(u),v=!m&&!p&&!f&&t.isPhotoStickerMessage(u),_=!m&&!p&&!f&&!v&&t.isNoBorderPhotoStickerMessage(u);if(m||v||f||p||_){var l;let s=u,n=s.cliMsgId;const r=[s];let o=u.status===Y.MSG_FAIL;const c=t.getGroupStickerId(u.msgId),g=c&&!a.has(c)?c:"grp"+h.msgId,m=v?hT.e.PhotoSticker:f?hT.e.AISticker:p?hT.e.NewFSSticker:_?hT.e.NoBorderPhotoSticker:hT.e.Sticker,b=dT.a.isAuditBubbleMessageEnabled()&&t.isDFEOrUndoNewFSSMessage(u),I=t.getMaxStickerItemInGroup(b?hT.e.Sticker:m);for(let a=d+1;a<e.length;a++){if(i[a])continue;if(r.length>=I)break;let n=e[a];const c=t.isStickerButNotNewFSSMessage(n)||dT.a.isAuditBubbleMessageEnabled()&&t.isDFEOrUndoNewFSSMessage(n);if(!(n.sendDttm-s.sendDttm<3e5&&c))break;s=n,r.push(s),i[a]=!0,o&&n.status!==Y.MSG_FAIL&&(o=!1)}r.length>1&&r.sort(((e,t)=>gT(e)-gT(t))),a.set(g,!0),h={msgId:g,cliMsgId:n,msgType:Y.MSG_STICKER_GROUP,sendDttm:s.sendDttm,status:o?Y.MSG_FAIL:null!==(l=t.getGroupStickerPhotoStatus(r))&&void 0!==l?l:s.status,fromUid:s.fromUid,toUid:s.toUid,message:r,UIContent:r,UIStickerTypeInGroup:m}}o.push(h)}return o};var pT,fT=function(e,t){var s,a;const i=[];if(!Array.isArray(e)||0===e.length)return i;const n=e.reduce(((e,t)=>(Array.prototype.push.apply(e,t.messages),e)),[]),r=e.length;let o,c=[];for(let g=0;g<r;g++){var l,d,u,h;const{messages:s,reasons:a}=e[g],r=null!==(l=null===(d=t.rules)||void 0===d||null===(u=d[eT.a.GroupMessages])||void 0===u||null===(h=u[Y.MSG_STICKER_GROUP])||void 0===h?void 0:h.max)&&void 0!==l?l:1,m="function"==typeof r?r:()=>r,p=mT(s,{getGroupPhotoId:_o.default.isGroupPhoto,getTotalGroupPhotoItem:_o.default.getTotalItem,getMaxStickerItemInGroup:m,isStickerButNotNewFSSMessage:x_.M,isDFEOrUndoNewFSSMessage:e=>Object(x_.h)(e)||Object(x_.R)(e),isAIStickerMessage:x_.a,isNewFSSMessage:x_.y,isPhotoStickerMessage:x_.E,isNoBorderPhotoStickerMessage:x_.z,getGroupStickerPhotoStatus:XM.d.getGroupStickerPhotoStatus,getGroupStickerId:JM.a.getGroupId.bind(JM.a),setGroupStickerId:JM.a.setGroupId.bind(JM.a)},t.windowId);c.push(...lT(p,a,n)),Array.prototype.push.apply(i,c),c=[],o=p[p.length-1]}return null===(s=i[0])||void 0===s||s.getUIBuilder().setFirstInList(!0),null===(a=i[i.length-1])||void 0===a||a.getUIBuilder().setLastInList(!0),i};function vT(e){return e.sendDttm}function _T(e){return e.msgType}function bT(e){return dT.a.getStandaloneMessageTypes().includes(e.msgType)}function IT(e){var t;return void 0!==(null===(t=e.eventInfo)||void 0===t?void 0:t.ttl)}function yT(e,t){return{messages:e,reasons:t}}function ST(e,t,s){if(void 0===e)return{isInContinuousBlock:!0,reasons:[]};const a=null==s?void 0:s[eT.a.BreakItem];let i=!0;const n=new Set,r=function(e,t){const s=_T(e),a=_T(t),i=s===Y.MSG_INFO_CHAT||s===Y.MSG_INFO&&"update_ttl"===s.act,n=a===Y.MSG_INFO_CHAT||a===Y.MSG_INFO&&"update_ttl"===t.act;return i&&n}(e,t),o=null==a?void 0:a[nT.a.SentTimeTooLong.toString()];var c,l,d;!r&&Boolean(o)&&(c=e,l=t,d="app-config"!==(null==o?void 0:o.time_to_break)?+o.time_to_break:dT.a.getTimeToBreakBlockMessages(),Math.abs(vT(l)-vT(c))>d)&&(i=!1,n.add(nT.a.SentTimeTooLong));const u=null==a?void 0:a[nT.a.DifferentSender.toString()];r||!Boolean(u)||function(e,t){return e.fromUid===t.fromUid}(e,t)||(i=!1,n.add(nT.a.DifferentSender));const h=null==a?void 0:a[nT.a.VanishModeStarted.toString()];!r&&Boolean(h)&&IT(t)&&(i=!1,!function(e){return null!=e.eventInfo&&e.eventInfo.ttl>0}(t)?n.add(nT.a.VanishModeEnded):n.add(nT.a.VanishModeStarted));const g=null==a?void 0:a[nT.a.StandaloneTypeChanged.toString()];return!r&&Boolean(g)&&function(e,t){return bT(e)!==bT(t)}(e,t)&&(i=!1,n.add(nT.a.StandaloneTypeChanged)),r||function(e,t){const s=vT(e),a=vT(t);if(!s||!a)return!1;let i=new Date(parseInt(s.toString())),n=new Date(parseInt(a.toString()));return i.getFullYear()===n.getFullYear()&&i.getMonth()===n.getMonth()&&i.getDate()===n.getDate()}(e,t)||(i=!1,n.add(nT.a.DateChanged)),{isInContinuousBlock:i,reasons:Array.from(n)}}function CT(e){return Object(I.a)({},e)}Object(a.singleton)(YM)(pT=class{buildChatItems(e,t){const s=function(e,t){if(!Array.isArray(e))return[];const s=e.filter((e=>Boolean(e))),a=[];let i=[];for(let n=s.length-1;n>=0;n--){const e=s[n];if(0===i.length){i.unshift(CT(e));continue}const r=i[0],{isInContinuousBlock:o,reasons:c}=ST(e,r,t.rules);o?i.unshift(CT(e)):(a.unshift(yT(i,c)),i=[CT(e)])}return i.length>0&&a.unshift(yT(i,[nT.a.FirstBlock])),a}(e,t);return fT(s,t)}});var ET=s("5xVU");var OT=function(e){const{conversation:t,data:s}=e;return Mr.a.createElement(ET.a,{isGroup:Boolean(null==t?void 0:t.isGroup),fromUid:null==s?void 0:s.fromUid})},MT=s("VHye");var TT=function(e){return Mr.a.createElement(MT.a,null)},RT=s("j7nq");var wT=function(e,t){var s;if(!e)return;let a={message:""};if("string"==typeof e.msg)a.message=e.msg;else try{const t=e.msg;a=Object(I.a)(Object(I.a)({},t),{},{message:t.title||""})}catch(r){}const i=null!==(s=e.ownerId)&&void 0!==s?s:e.fromUid,n=function(e,t){let s="";const a=e.fromUid||e.ownerId;if(a===J.p.getSessionUserId()){const e=Ii.default.getMiniProfileMe();s=(null==e?void 0:e.dName)||""}else if(Object(Cu.a)(t)){const e=Ii.default.getDName(a);if(e)s=e;else{var i;const e=(null===(i=yn.default.getMiniInfoGroup(t))||void 0===i?void 0:i.topMember)||[];for(let t of e)if(t.id===a){s=t.dName;break}}}return s||(s=Ii.default.getDName(a)||""),s}(e,t);return{attach:"string"==typeof e.attach?RT.a.noExceptions(e.attach):e.attach,cliMsgId:e.cliMsgId,cliMsgType:e.cliMsgType,rootContent:a,msg:e.msg,globalMsgId:e.globalMsgId,ts:+e.ts,fromD:n,ownerId:i,ttl:e.ttl}};var LT=function(e){if(e)return{fromID:e.fromId,icon:e.icon,isGroup:Boolean(e.isGroup),isMessageInfo:Boolean(e.isMsgInfo),senderAvatar:e.senderAvatar,senderDisplayName:e.senderDisplayName,threadID:e.threadId,timestamp:e.ts,ttl:e.ttl}};var DT=function(e){if(e)return Object(I.a)(Object(I.a)({},e),{},{eventInfo:LT(e.eventInfo),quote:wT(e.quote,e.toUid),type:-1})};var AT=function(e){var t,s,a;if(!e)return;let i=e.params;if("string"==typeof i)try{i=JSON.parse(i)}catch(l){}i||(i={});const n=function(e){switch(e){case 1:return Z.a.CALLEE_BUSY;case 2:return Z.a.TIMEOUT_HAVE_RINGING;case 3:return Z.a.CALLEE_REJECT;case 4:return Z.a.CALLER_REJECT_HAVE_RINGING;case 5:return Z.a.CALLER_REJECT_NOT_RINGING;default:return Z.a.DEFAULT}}(i.reason),r=e.action===Y.CallMessageAction.MissCall?Z.b.MISSCALL:Z.b.CALLTIME,o=null!=i.isCaller?!!i.isCaller?Z.c.CALLER:Z.c.CALLEE:function(e){return e===Y.CallMessageAction.Calling?Z.c.CALLER:Z.c.CALLEE}(e.action),c=function(e){return 1===e?Z.d.VIDEO:Z.d.AUDIO}(i.calltype);return{duration:null!==(t=null!==(s=i.duration)&&void 0!==s?s:e.duration)&&void 0!==t?t:0,isEnabledCallback:null!==(a=Boolean(i.isEnableCallback))&&void 0!==a&&a,reason:n,status:r,subject:o,type:c}};var FT=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:AT(e.message)})};var kT=function(e){if(!e)return;let t=e.description,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(i){s={}}else"object"==typeof t&&(s=t);let a=-1;return e.action===Y.MessageContentAction.User?a=hT.b.User:e.action===Y.MessageContentAction.OA&&(a=hT.b.OA),{name:e.title,phone:s.phone,QRCodeURL:s.qrCodeUrl,gUid:s.gUid,oaShortLink:s.oaShortLink,href:e.href,thumb:e.thumb,type:a,userId:e.params}};var NT=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:kT(e.message)})};var PT=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:e.message})};var jT=function(e){if(e)return{pArtist:e.artist,pCount:e.count,pMediaTitle:e.mediaTitle,pSource:e.src,pStreamUrl:e.streamUrl,pStreamIcon:e.stream_icon,pType:e.type}};var UT=function(e){if(!e)return;const t=e.params;let s;if("string"==typeof t)try{const e=JSON.parse(t);s=jT(e)}catch(a){}else"object"==typeof t&&(s=jT(t));return Object(I.a)({title:e.title,description:e.description,href:e.href,thumb:e.thumb},s)};var BT=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:UT(e.message)})};var zT=function(e){if(!e)return;let t=e.params,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(a){s={}}else"object"==typeof t&&(s=t);return{title:e.title,description:e.desc,isUserLocation:e.isUserLocation||s.isUserLocation||0,latitude:e.lat||s.latitude,longitude:e.lo||s.longitude,sourceID:e.sourceID||s.srcId||""}};var GT=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:zT(e.message)})};var xT=function(e){if(e)return Object(I.a)(Object(I.a)({},e),{},{id:e.id,cateId:e.catId,type:e.type,extInfo:e.extInfo})};var VT=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:xT(e.message),msgType:e.msgType,UIType:hT.e.Sticker,src:e.src})};var HT=function(e){return{thumb_height:e.thumb_height,thumb_width:e.thumb_width,width:e.width,height:e.height,contentId:e.contentId,webp:{hd:e.webp.hd,url:e.webp.url,width:e.webp.width,height:e.webp.height}}};var WT=function(e){const t=e.params;let s={};if("string"==typeof t)try{s=HT(JSON.parse(t))}catch(a){}else"object"==typeof t&&(s=HT(t));return Object(I.a)(Object(I.a)({},e),{},{thumbUrl:e.thumbUrl,oriUrl:e.oriUrl,hdUrl:e.hdUrl,normalUrl:e.normalUrl,params:e.params,parsedParams:s})};var qT=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:WT(e.message),msgType:e.msgType,UIType:hT.e.PhotoSticker,properties:{color:e.properties.color,size:e.properties.size,type:e.properties.type,subType:e.properties.subType,ext:e.properties.ext}})},KT=s("z80d");var ZT=function(e){return{contentId:e.contentId,pStickerType:KT.c.AI_STICKER,height:e.height,width:e.width,thumb_height:e.thumb_height,thumb_width:e.thumb_width,webp:{url:e.webp.url,width:e.webp.width,height:e.webp.height}}};var $T=function(e){const t=e.params;let s={contentId:"",thumb_height:-1,thumb_width:-1,width:-1,height:-1,pStickerType:KT.c.AI_STICKER,webp:{url:"",width:-1,height:-1}};if("string"==typeof t)try{s=ZT(JSON.parse(t))}catch(a){0}else"object"==typeof t&&(s=ZT(t));return{title:e.title,description:e.description,thumbUrl:e.thumbUrl,oriUrl:e.oriUrl,hdUrl:e.hdUrl,normalUrl:e.normalUrl,params:e.params,UIParsedParams:s}};var QT=function(e){let t={sSrcStr:"",sSrcType:-1};const s=e.properties.ext;if("string"==typeof s)try{t=JSON.parse(s)}catch(a){0}else"object"==typeof s&&(t=s);return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:$T(e.message),msgType:e.msgType,src:e.src,UIType:hT.e.AISticker,properties:{color:e.properties.color,size:e.properties.size,type:e.properties.type,subType:e.properties.subType,ext:e.properties.ext,UIParsedExt:t}})};function YT(e){const t=e.params,s=function(e){let t={};try{"string"==typeof e?t=JSON.parse(e):"object"==typeof e&&(t=e)}catch(s){zconsole.zsymb(3,"PYn7aR",["[transformMessageContent::NBPSParsedParams] failed: {}","F32f-m"],null==s?void 0:s.message)}return{width:t.width,height:t.height}}(t);return{oriUrl:e.oriUrl,normalUrl:e.normalUrl,thumbUrl:e.thumbUrl,params:t,parsedParams:s}}var JT=function(e){return Array.isArray(e)?e.map((e=>{return Object(x_.E)(e)?qT(e):Object(x_.N)(e)?VT(e):Object(x_.a)(e)?QT(e):Object(x_.z)(e)?(t=e,Object(I.a)(Object(I.a)({},DT(t)),{},{UIContent:YT(t.message),msgType:t.msgType,UIType:hT.e.NoBorderPhotoSticker,properties:{color:t.properties.color,size:t.properties.size,type:t.properties.type,subType:t.properties.subType,ext:t.properties.ext}})):e;var t})):[]};var XT=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:JT(e.message),msgType:Y.MSG_STICKER_GROUP,UIType:hT.e.StickerGroup})};var eR=function(e){return Object(I.a)(Object(I.a)({},e),{},{id:e.id,name:e.name,desc:e.desc,isFree:e.isFree,iconUrl:e.iconUrl,iconPreview:e.iconPreview,thumbUrl:e.thumbUrl,totalImage:e.totalImage,group:e.group,version:e.version,permission:e.permission,isHidden:e.is_hidden,thumbImg:e.thumbImg,expireTime:e.expireTime})};var tR=function(e){let t=e.params,s={};if("string"==typeof t)try{s=eR(JSON.parse(t))}catch(a){}else"object"==typeof t&&(s=eR(t));return{title:e.title||s.name,thumb:e.thumb,action:e.action,href:e.href,description:e.description||s.desc,parsedParams:s}};var sR=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:tR(e.message),UIType:hT.e.StickerSet})};var aR=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:e.message})};var iR=function(e){var t,s,a,i;if(!e)return;let n=e.params,r={};if("string"==typeof n)try{r=JSON.parse(n)}catch(o){r={}}else"object"==typeof n&&(r=n);return{caption:null!==(t=e.title)&&void 0!==t?t:"",duration:null!==(s=null!==(a=r.duration)&&void 0!==a?a:e.duration)&&void 0!==s?s:0,fileSize:r.fileSize,height:r.video_height,quality:1===r.isHD?"HD":void 0,rotation:r.video_rotation,width:r.video_width,thumbUrl:null!==(i=e.thumbUrl)&&void 0!==i?i:"",parsed:r.parsed}};var nR=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:iR(e.message)})};var rR=function(e){if(!e)return;let t=e.params,s={};if("string"==typeof t)try{s=JSON.parse(t)}catch(a){s={}}else"object"==typeof t&&(s=t);return{source:e.href,duration:s.duration||0,formats:{m4a:s.m4a}}};var oR=function(e){return Object(I.a)(Object(I.a)({},DT(e)),{},{UIContent:rR(e.message)})};var cR=s("ZTgy"),lR=s("3nWQ");const dR="call-message",uR={Caller:dR+"--caller",Callee:dR+"--callee",Selected:dR+"--selected",HasFooter:dR+"--has-footer"},hR=dR+"__title-wrapper",gR={Red:hR+"--red"},mR=dR+"__content-container",pR=dR+"__icon-wrapper",fR=dR+"__content-txt-wrapper",vR=dR+"__separator",_R=dR+"__callback-wrapper";var bR=s("z5gp"),IR=s("7veT");function yR(e){const{subject:t}=e;return t===Z.c.CALLER?function(e){const{reason:t,status:s,type:a}=e;return s===Z.b.CALLTIME?a===Z.d.AUDIO?ce.a.str("STR_CALL_TITLE_OUTGOING_CALL_AUDIO"):ce.a.str("STR_CALL_TITLE_OUTGOING_CALL_VIDEO"):s===Z.b.MISSCALL?t===Z.a.CALLER_REJECT_NOT_RINGING||t===Z.a.CALLER_REJECT_HAVE_RINGING?ce.a.str("STR_CALL_TITLE_OUTGOING_CALL_CANCEL"):t===Z.a.CALLEE_REJECT?ce.a.str("STR_CALL_TITLE_OUTGOING_CALL_REJECTED"):t===Z.a.CALLEE_BUSY?ce.a.str("STR_CALL_TITLE_OUTGOING_CALL_BUSY"):a===Z.d.AUDIO?ce.a.str("STR_CALL_TITLE_OUTGOING_CALL_AUDIO"):ce.a.str("STR_CALL_TITLE_OUTGOING_CALL_VIDEO"):""}(e):t===Z.c.CALLEE?function(e){const{reason:t,status:s,type:a}=e;return s===Z.b.CALLTIME?a===Z.d.AUDIO?ce.a.str("STR_CALL_TITLE_INCOMING_CALL_AUDIO"):ce.a.str("STR_CALL_TITLE_INCOMING_CALL_VIDEO"):s===Z.b.MISSCALL?t===Z.a.CALLEE_REJECT?ce.a.str("STR_CALL_TITLE_INCOMING_CALL_REJECTED"):ce.a.str("STR_CALL_TITLE_INCOMING_CALL_MISSED"):""}(e):""}const SR={IncomingAudio:"call-incoming-audio",IncomingMissedAudio:"call-incoming-missed-audio",IncomingMissedAudioGrayscale:"call-incoming-missed-audio-grayscale",IncomingMissedVideo:"call-incoming-missed-video",IncomingMissedVideoGrayscale:"call-incoming-missed-video-grayscale",IncomingVideo:"call-incoming-video",OutgoingAudio:"call-outgoing-audio",OutgoingMissedAudio:"call-outgoing-missed-audio",OutgoingMissedVideo:"call-outgoing-missed-video",OutgoingVideo:"call-outgoing-video",RejectedAudio:"call-rejected-audio",RejectedVideo:"call-rejected-video"};function CR(e,t=!1){const{subject:s}=e;return s===Z.c.CALLER?function(e){const{reason:t,status:s,type:a}=e;if(s===Z.b.CALLTIME){if(a===Z.d.AUDIO)return SR.OutgoingAudio;if(a===Z.d.VIDEO)return SR.OutgoingVideo}else if(s===Z.b.MISSCALL){if(a===Z.d.AUDIO)return t===Z.a.CALLEE_REJECT?SR.RejectedAudio:SR.OutgoingMissedAudio;if(a===Z.d.VIDEO)return t===Z.a.CALLEE_REJECT?SR.RejectedVideo:SR.OutgoingMissedVideo}return""}(e):s===Z.c.CALLEE?function(e,t=!1){const{reason:s,status:a,type:i}=e;if(a===Z.b.CALLTIME){if(i===Z.d.AUDIO)return SR.IncomingAudio;if(i===Z.d.VIDEO)return SR.IncomingVideo}else if(a===Z.b.MISSCALL){if(i===Z.d.AUDIO)return s===Z.a.CALLEE_REJECT?SR.RejectedAudio:t?SR.IncomingMissedAudioGrayscale:SR.IncomingMissedAudio;if(i===Z.d.VIDEO)return s===Z.a.CALLEE_REJECT?SR.RejectedVideo:t?SR.IncomingMissedVideoGrayscale:SR.IncomingMissedVideo}return""}(e,t):""}function ER(e){const t=e||0,s=t%60,a=Math.floor(t/60)%60,i=Math.floor(t/3600);const n=`${s} ${ce.a.str("STR_SEC")}`;let r=`${`${a} ${a>1?ce.a.str("STR_MINS"):ce.a.str("STR_MIN")}`} ${n}`;if(i>0){r=`${`${i} ${i>1?ce.a.str("STR_HOURS"):ce.a.str("STR_HOUR")}`} ${r}`}return r}var OR=function(e){const t=CR(e),s=function(e){const{duration:t,reason:s,status:a,subject:i,type:n}=e;if(a===Z.b.CALLTIME)return ER(t);if(a===Z.b.MISSCALL){if(i===Z.c.CALLER&&(s===Z.a.DEFAULT||s===Z.a.TIMEOUT_HAVE_RINGING))return ER(0);if(n==Z.d.AUDIO)return ce.a.str("STR_CALL_CONTENT_AUDIO");if(n==Z.d.VIDEO)return ce.a.str("STR_CALL_CONTENT_VIDEO")}return""}(e);return Mr.a.createElement("div",{className:mR},Mr.a.createElement("div",null,Mr.a.createElement("div",{className:pR},Mr.a.createElement(bR.a,{icon:t,size:"medium"})),Mr.a.createElement("div",{className:fR},Mr.a.createElement("span",null,s))))};var MR=function(e){const t=e.subject===Z.c.CALLEE&&e.status===Z.b.MISSCALL;return Mr.a.createElement("div",{className:Object(PC.a)(hR,t&&gR.Red)},yR(e))};const TR=()=>null;function RR(e){return e.visible?Mr.a.createElement("div",{className:vR}):Mr.a.createElement(TR,null)}function wR(e){return e.visible?Mr.a.createElement("div",{className:_R,onClick:e.onClick},ce.a.str("STR_CALL_CALL_BACK")):Mr.a.createElement(TR,null)}var LR=function(e){const{data:t,isSelected:s,observeIntersectionForReading:a}=e,i=t.ttl,n=t.UIContent,{duration:r,isEnabledCallback:o,reason:c,status:l,subject:d,type:u}=n,h=Mr.a.useRef(null);Object(cR.a)(h,a);const g=o,m=Object(PC.a)(dR,s&&uR.Selected,d===Z.c.CALLER&&uR.Caller,d===Z.c.CALLEE&&uR.Callee,g&&uR.HasFooter);return Mr.a.createElement(lR.a,{border:6,className:Object(PC.a)(m,!Boolean(t.ttl)&&"shadow-bubble"),ttl:i,variant:"common"},Mr.a.createElement("div",{ref:h,"data-qId":Object(fe.g)(t)},Mr.a.createElement(MR,{reason:c,status:l,subject:d,type:u}),Mr.a.createElement(OR,{duration:r,reason:c,status:l,subject:d,type:u}),Mr.a.createElement(RR,{visible:g}),Mr.a.createElement(wR,{onClick:e=>{const{makeCall:s}=Object(q.c)();"function"==typeof s&&function(e,t,s){const a=IR.a.ActionLog.getCallbackActionLog(t);Ia.default.logAction(a),"function"==typeof s&&s(e,t.type)}(e,n,s.bind(null,{chatID:t.toUid,callType:u}))},visible:g})))},DR=s("3jpH");const AR="contact-message",FR=AR+"__container",kR={HighlightFromPrivilegedUser:FR+"--highlight-from-privileged-user"},NR=AR+"__footer-container",PR={Blue:NR+"--blue",Selected:NR+"--selected"},jR=AR+"__footer-item-container",UR=AR+"__footer-item",BR=AR+"__footer-item-separator";let zR="";function GR(e){e&&(e.stopPropagation(),e.preventDefault())}function xR(e,t){var s;const i=e.data;if(!i)return[];const n=(null===(s=i.UIContent)||void 0===s?void 0:s.userId)||"",r=[];if(n===Ce.default.sendToMeId){const e={id:"ShareToMyCloudButton",text:"STR_SEND2ME_SHARE",textArguments:[{textKey:"KEY_NAME_SEND2ME"}],handler:t.shareToMyCloud};return r.push(e),r}if(n===function(){if(!zR){const t=a.ModuleContainer.resolve(m.a);var e;t&&(zR=(null===(e=t.getSession())||void 0===e?void 0:e.userId)||"")}return zR}())return r;const o=Ii.default.isFriend(n);if(!(i.UIContent.type===hT.b.OA))if(o){if(fl.d.isSupport()){const e={id:"CallButton",text:"STR_CONTACT_CARD_CALL_BTN",handler:t.makeCall};r.push(e)}}else{const e={id:"AddFriendButton",text:"STR_CONTACT_CARD_ADD_FRIEND_BTN",handler:t.addFriend};r.push(e)}const c={id:"ChatBtn",text:"STR_CONTACT_CARD_CHAT_BTN",handler:t.openChat,type:"secondary"};return r.push(c),r}function VR({item:e}){return Mr.a.createElement("div",{className:jR,onClick:e.handler},Mr.a.createElement(Rr.a,{className:Object(PC.a)(UR,e.type&&UR+`--${e.type}`),textKey:e.text,textArguments:e.textArguments,textTransform:"capital-case"}))}function HR(e){const{items:t,isSelected:s,isSentFromMe:a,isShowShadow:i}=e;return Mr.a.createElement("div",{className:Object(PC.a)(NR,a&&PR.Blue,s&&PR.Selected,i&&"shadow-bubble")},t.map(((e,t)=>Mr.a.createElement(Mr.a.Fragment,null,0!==t&&Mr.a.createElement("div",{className:BR}),Mr.a.createElement(VR,{key:e.id,item:e})))))}var WR=function(e){var t,s;const{data:a,isFocused:i,isHighlightedByPrivilegedUser:n,isMultiSel:r,MessageQuickActionRenderer:o,observeIntersectionForReading:c,selectedMsg:l={},windowId:d}=e,u=a.UIContent,h="0"===a.fromUid,g=Boolean(r&&l[a.msgId]),m=Boolean(r),p=null===(t=e.conversation)||void 0===t?void 0:t.userId,f=(null===(s=a.UIContent)||void 0===s?void 0:s.userId)||"",v=Ii.default.getDName(f)||(null==u?void 0:u.name)||"",_=Mr.a.useRef(null);Object(cR.a)(_,c);const b=xR(e,{addFriend:e=>{if(m)return;GR(e);const{addFriend:t}=Object(q.c)();t&&t({userID:f,chatID:p,windowID:d})},makeCall:e=>{if(m)return;GR(e);const{makeVoiceCall:t}=Object(q.c)();t&&t({chatID:f,windowID:d})},openChat:e=>{if(m)return;GR(e);const{openChat:t}=Object(q.c)();t&&t({chatID:f,source:Q.a.MessageOnMessaging})},shareToMyCloud:e=>{if(m)return;GR(e);const{makeVoiceCall:t}=Object(q.c)();t&&t({chatID:f,windowID:d})}}),I=b.length>0;return Mr.a.createElement(lR.a,{border:6,className:Object(PC.a)(FR,n&&(null==a.ttl||0==a.ttl)&&kR.HighlightFromPrivilegedUser,"rounded-6","focused-item",i&&"focused-item--highlight-border"),isAdmin:n,variant:"common",ttl:a.ttl},Mr.a.createElement("div",{ref:_,"data-qId":Object(fe.g)(a),onContextMenu:function(t){if("function"!=typeof e.showContextMenu)return;e.showContextMenu({event:t,message:e.data})}},Mr.a.createElement(DR.ContactCard,{className:Object(PC.a)("rounded-t-6","cursor-pointer",!I&&"rounded-b-6"),avatarURL:u.thumb,name:v,description:u.phone||u.oaShortLink,isSelected:g,QRCodeURL:u.QRCodeURL,type:u.type,onClick:e=>{if(!m)if(GR(e),f===Ce.default.sendToMeId){const{openChat:e}=Object(q.c)();e&&e({chatID:f})}else{const{openProfileModal:e}=Object(q.c)();e&&e({userId:f,selectConversationSource:178003,windowId:d})}},userId:u.userId}),I&&Mr.a.createElement(HR,{items:b,isSelected:g,isSentFromMe:h,isShowShadow:!Boolean(a.ttl)}),o&&Mr.a.createElement(o,null)))};var qR=function(e){const{className:t,data:s}=e;let a;return a=s.uidSenderDel?Mr.a.createElement("div",null,s.uidSenderDel==Ii.default.getUidMe()||"0"==s.uidSenderDel?Mr.a.createElement(Rr.a,{textKey:"STR_ME_DEL"}):Mr.a.createElement("span",null,Ii.default.getDName(s.uidSenderDel)),Mr.a.createElement(Rr.a,{textKey:"STR_DEL_EVERYONE_MSG"})):Mr.a.createElement(Rr.a,{textKey:"STR_DEL_EVERYONE"}),Mr.a.createElement("div",{className:Object(PC.a)("dfe-message__container",t)},a)},KR=s("F1UR"),ZR=s("Wwxf"),$R=s("hIA4"),QR=s("t77n"),YR=s("ggG7"),JR=s("/Z5y"),XR=s("EIuX"),ew=s("QMJy"),tw=s("SzKC"),sw=s("yhYV");class aw extends tw.a{constructor(e){super(e),this.state=Object(I.a)({},this.state)}shouldComponentUpdate(e,t){return this.props.message.reacts!==e.message.reacts||this.props.shouldShowStatus!==e.shouldShowStatus||this.state.store.params!==t.store.params||this.props.message.status!==e.message.status||this.props.message.isLastMsg!==e.message.isLastMsg||this.props.message.isErrorInfo!==e.message.isErrorInfo||this.props.message.sendError!==e.message.sendError||this.props.onContextMenu!==e.onContextMenu||this.props.showInFolder!==e.showInFolder||this.props.className!==e.showInFolder}_loading(){return this._utils.loading({store:this.state.store,props:this.props})}render(){const{onContextMenu:e,onDoubleClick:t,onMouseOver:s,onMouseLeave:a,onTouchStart:i,onTouchEnd:n}=this.props,r={onMouseOver:s,onMouseLeave:a,onTouchStart:i,onTouchEnd:n},{fileIcon:o,fileThumb:c,fileTitle:l,fileTextInfo:d,fileActionDisplay:u,cloudDownloadingOrUploading:h,clickAction:g,isMe:m,notLoading:p}=this._loading();return p?Mr.a.createElement(sw.a,Object(gC.a)({isMe:m},this.props)):Mr.a.createElement("div",Object(gC.a)({className:"file-message-v2 file-message__container"},r,{onClick:g,onContextMenu:e,onDoubleClick:t}),c,Mr.a.createElement("div-13",{className:"file-message__content-container",style:{minHeight:"49px"}},o,Mr.a.createElement("div",{className:"file-message__content"},l,Mr.a.createElement("div-13",{className:"file-message__content-info-container"},d,u),h)))}}var iw=s("mE0M");function nw(e){e&&(e.preventDefault(),e.stopPropagation())}function rw(e,t){const s=Mr.a.useMemo((()=>function(e){var t,s;const a=e.message||e.file;let i=""+a.msgId,n="0"==a.fromUid?J.p.getSessionUserId():a.fromUid;const r=QR.a.utils.getPrimaryId(a),{FileChatModel:o}=QR.a.models,c=QR.a.getFileKey(r),l=QR.a.get(c);let d=Object(XR.o)(l);d||!a.isErrorInfo&&a.status!=Y.MSG_FAIL||a.cancelled||(d=a.subType&&23==a.subType?{strKey:"STR_ERR_UPLOAD_FILE_FOLDER_ERROR",strKeyParams:[]}:{strKey:"STR_ERR_UPLOAD_FILE_ERROR",strKeyParams:[]});const u=QR.a.utils.getMessageFileParams(a),h=Object(QE.a)(u),g=(null==h?void 0:h.fdata)&&Object(QE.a)(null==h?void 0:h.fdata),m=null!==(t=null==g?void 0:g.upSrc)&&void 0!==t?t:a.upSrc,p=null!==(s=null==g?void 0:g.reader)&&void 0!==s?s:a.reader,f=null==a?void 0:a.originMsgType,v={fromUid:n,localPath:QR.a.utils.getLocalPath(e),folderPath:QR.a.utils.getFolderPath(e),sendTime:a.sendDttm,cancelUpload:a.cancelled,sendFileError:d,upSrc:m,reader:p,originMsgType:f};Object.keys(v).forEach((e=>void 0===v[e]&&delete v[e]));const _=new o({params:u,conversationId:QR.a.utils.getMessageConversationId(a),fileUrl:QR.a.utils.getFileMessageUrl(a),status:QR.a.utils.getFileMessageStatus(a),indicatorState:QR.a.utils.getFileMessageIndicatorState(a),extraInfo:v});return QR.a.dispatch(N_.FileActionType.Init,{data:_,id:{p:r,s:i}}),r}(e)),[e.message.folderPath,e.message.localPath]),{windowId:a}=Object(QC.a)(),{setTrustedFileMsg:i}=e;e=Object(I.a)(Object(I.a)({},e),{},{pIdOrMsgId:s,windowKey:a});const{status:n,flag:r}=Object(iw.a)(e.message),o=function(e){const{showActionInjectable:t,pIdOrMsgId:s}=e,a=Object(YR.a)(e),i=Object(JR.a)(s||"",XR.j),n=Object(JR.a)(s||"",XR.i);return Mr.a.useCallback((e=>null==t?void 0:t(e,{contextMenu:!0,message:a,localPath:i,folderPath:n})),[a,t,i,n])}(Object(I.a)(Object(I.a)({},e),{},{status:n,flag:r})),c=Object(YR.a)(e);Mr.a.useEffect((()=>{i&&i(c)}),[c,i]);const l=function(e){return Object(ew.a)(e)}(Object(I.a)(Object(I.a)({},e),{},{status:n,flag:r}));return Mr.a.createElement(aw,Object(gC.a)({ref:t},e,{onContextMenu:o,onDoubleClick:nw,showInFolder:l}))}var ow=Mr.a.memo(Mr.a.forwardRef(rw));var cw=Mr.a.forwardRef((function(e,t){return Mr.a.createElement(FC.a,null,Mr.a.createElement(ow,Object(gC.a)({},e,{ref:t})))}));const lw=ui.default.isWeb();let dw,uw;lw||(dw=s("Dprd").default,uw=$znode.path);var hw=function(e){var t,s,i;const n=e.data,[r,o]=Object(Or.useState)(n.localPath||""),[c,l]=Object(Or.useState)(n.folderPath||""),[d,u]=Object(Or.useState)(!(null==n||!n.msgId)&&void 0!==(null===(t=dw)||void 0===t?void 0:t.getDownloadProgress(n.msgId))),[h,g]=Object(Or.useState)(null!=n&&n.msgId&&(null===(s=dw)||void 0===s?void 0:s.getDownloadProgress(n.msgId))||0),[m,p]=Object(Or.useState)(0),[f,v]=Object(Or.useState)(!1),[_,b]=Object(Or.useState)(!1);return Object(Or.useEffect)((()=>{(null==n?void 0:n.localPath)&&o(n.localPath),(null==n?void 0:n.folderPath)&&l(n.folderPath)}),[null==n?void 0:n.localPath,null==n?void 0:n.folderPath]),Object(Or.useEffect)((()=>{$R.a.getInstance().push(n,$R.b.chatview)}),[]),Object(Or.useEffect)((()=>{const e=(e,t)=>{if(e===ve.ChatBoxActions.FILEPATH_UPDATED){if(t.msgId!==n.msgId)return;t.localPath!==r&&o(t.localPath)}};return _e.default.subscribe(e),()=>{_e.default.unsubscribe(e)}}),[r,n.msgId]),Object(Or.useEffect)((()=>{var e;if(lw)return;const t=n.msgId;null===(e=a.ModuleContainer.resolve(we.a))||void 0===e||e.getMultiMedias("file",n.toUid,[t]).then((e=>{let s=e[0];s&&s.msgId===t&&(s.localPath&&o(s.localPath),s.folderPath&&l(s.folderPath),(s.localPath||s.folderPath)&&u(!1),s.downloadError&&v(!0))}))}),[n.msgId]),Mr.a.createElement(cw,{windowId:e.windowId,conversation:e.conversation,isOnline:e.isOnline,dispatch:e.dispatch,emitter:e.emitter,uploadFiles:e.uploadFiles,uploadFilesNative:e.uploadFilesNative,scrollToBottom:e.scrollToBottom,message:n,userId:null===(i=e.user)||void 0===i?void 0:i.userId,senderName:function(){var t,s,a,i;if(null!==(t=e.conversation)&&void 0!==t&&null!==(s=t.userId)&&void 0!==s&&s.startsWith(Y.GROUPID_PREFIX))return null==e?void 0:e.senderName;return"0"==(null==n?void 0:n.fromUid)?null===(i=e.user)||void 0===i?void 0:i.displayName:null==e||null===(a=e.friendInfo)||void 0===a?void 0:a.displayName}(),localPath:r||"",folderPath:c||"",isDownloading:d,downloadProgress:h,progressInBytes:m,downloadError:f,showShareError:_,showInFolder:function(e){e.preventDefault(),e.stopPropagation(),Object(KR.default)(n),Ia.default.logAction(107190901)},manualDownload:function(e){e.preventDefault(),e.stopPropagation()},resendMessage:()=>{var t;null===(t=e.resendHandler)||void 0===t||t.call(e,n.resend,n)},showActionInjectable:(t,s)=>{!function(t,s){if("function"==typeof e.showContextMenu){const a=`openCtxMenu_File_${e.data.cliMsgId}`;ZR.a.stopAll(),ZR.a.for(a);const i={event:t,message:s.message,detail:{trackingCmdId:a,fileData:{localPath:s.localPath||r,folderPath:s.folderPath||c},fileHandler:{saveToDeviceHandler:(e,t)=>{"update"===e&&t.hasOwnProperty("isDownloading")&&u(t.isDownloading)}}}};e.showContextMenu(i)}}(t,s)}})},gw=s("ymth");var mw=s("Hscn"),pw=s("QG4v"),fw=s("xvBE");var vw=function(e){const{children:t,className:s,isSelected:a}=e;return t?Mr.a.cloneElement(t,{style:t.props.style,className:Object(PC.a)(a&&"selected-message-overlay",s,t.props.className)}):Mr.a.createElement(Mr.a.Fragment,null)};const _w="gif-message__container",bw={HighlightFromPrivilegedUser:_w+"--highlight-from-privileged-user"};var Iw=s("39bE"),yw=s("H/0Q");function Sw(e){const t=e=>"string"==typeof e?e:"";return[t(null==e?void 0:e.oriUrl),t(null==e?void 0:e.normalUrl),t(null==e?void 0:e.thumbUrl)]}var Cw=function(e){const{containerWidth:t,data:s,isFocused:a,isHighlightedByPrivilegedUser:i,isSelected:n=!1,observeIntersectionForReading:r}=e,[o,c]=Mr.a.useState(s.localPath),l=Mr.a.useRef(null),d=`${null==s?void 0:s.cliMsgId}.${null==s?void 0:s.fromUid}.${null==s?void 0:s.toUid}`;Object(cR.a)(l,r);const u=function(e,t=-1,s=0){const a=160+s,i=110,n=368;let r=Math.min(798,isNaN(t)?798:t);t<=-1&&(r=n);let o=!1;if(e.message&&e.message.params)try{let t=JSON.parse(e.message.params),s=-1,c=-1;if(s=e.width?e.width:t.width,c=e.height?e.height:t.height,void 0!==s&&null!=c||(s=n,c=n,o=!0),s>0&&c>0){let e=s,l=c;if(s<a&&c<i)l=i,e=a;else if(s>r&&c>n){let t=n/c;if(l=n,e=Math.round(s*t),e>r){t=r/e,e=r;let s=Math.round(l*t);l=Math.max(s,i)}e=Math.max(e,a)}else if(c>n){let t=n/c;l=n;let i=Math.round(s*t);e=Math.max(a,i)}else if(c>=i&&c<=n){if(s>r){let t=r/s;e=r;let a=Math.round(c*t);l=Math.max(i,a)}else if(s<a){e=a;let t=a/s,r=Math.round(c*t);l=Math.min(Math.max(i,r),n)}}else if(c<i){l=i;let t=i/c,n=Math.round(t*s);e=s>r?r:Math.min(Math.max(a,n),r)}return{height:l,width:e,defaultSize:o,rotation:t.rotation,flip:t.flip}}}catch(c){}return{width:n,height:n,defaultSize:!0}}(s,t-192),h=Sw(s.message).map((e=>({src:e}))),g=Mr.a.useMemo((()=>({backgroundColor:"transparent",borderRadius:"4px",height:u.height+"px",width:u.width+"px"})),[u.height,u.width]);async function m(){return Object(yw.a)(s)}return Mr.a.createElement(fw.a,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryClick:t=>{var a;t.preventDefault(),t.stopPropagation(),null===(a=e.resendMessage)||void 0===a||a.call(e,t,s)}},Mr.a.createElement(vw,{isSelected:n},Mr.a.createElement(lR.a,{border:6,className:Object(PC.a)(_w,i&&(null==s.ttl||0==s.ttl)&&bw.HighlightFromPrivilegedUser,"rounded-6","focused-item",a&&"focused-item--highlight-border"),isAdmin:i,variant:"common",ttl:s.ttl,style:{height:u.height+2+"px",width:u.width+2+"px"},onContextMenu:t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:e.data,detail:{handleManualDownloadSuccess:e=>{c(e)},handleUpdateFilePath:e=>{c(e)},localPath:o}};e.showContextMenu(s)}},Mr.a.createElement("div",{ref:l,"data-qId":Object(fe.g)(s)},Mr.a.createElement("div",{style:g},2===nf.a.image_loader.version&&Mr.a.createElement(Iw.a.CenterBox,{className:"image-box",width:"100%",height:"100%"},Mr.a.createElement(Iw.a.Loader,{entry:Np.k.MESSAGE_LIST,mediaId:d,srcs:h,retryWhenOnline:!0,useHttpsSource:!0},Mr.a.createElement(Iw.a.Image,null),Mr.a.createElement(Iw.a.LoaderErrorCatch,{expiryCheck:m,manualRetryOnClick:!0,render:e=>Mr.a.createElement(Iw.a.DefaultImageError,{mediaId:d,error:e,style:{width:"inherit",height:"inherit"}})}))),1===nf.a.image_loader.version&&Mr.a.createElement(pw.a,{entry:Np.k.MESSAGE_LIST,mediaId:d,urls:Object(mw.a)(Sw(s.message)),imageStyle:g,status:s.status,expiryCheck:m}))))))},Ew=s("blq4"),Ow=s("O7EA"),Mw=s("0cNv"),Tw=s("OONb"),Rw=s("UZOM");const ww=["CHAT_BOX_LIST_LOAD_MORE_2"];class Lw extends Mr.a.Component{constructor(e){super(e),this._timer=null,this.state={statusText:"CHAT_BOX_LIST_LOAD_MORE_1"}}componentDidMount(){const e=()=>{"function"==typeof this.props.onShow&&this.props.onShow()};this.props.delayedTime?(this.setConfigTimer(),this._timer=setTimeout((()=>{this.domRef&&(this.domRef.className=this.domRef.className.replace("hidden",""),this.props.updateShowSpinner&&this.props.updateShowSpinner(this.domRef.clientHeight),this._setStatusText(),e())}),this.props.delayedTime)):e()}shouldComponentUpdate(e,t){return this.state.statusText!==t.statusText}componentWillUnmount(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._clearTimerStatusText(),"function"==typeof this.props.onHide&&this.props.onHide()}setConfigTimer(){const e=Ce.default.cloud.loading_text_timer;this.arStatusConfig=[],e.length&&e.forEach(((e,t)=>{const s=t>1?1:t;e&&this.arStatusConfig.push({timer:parseInt(e),text:ww[s]})}))}_clearTimerStatusText(){this.setTextTimer&&(clearTimeout(this.setTextTimer),this.setTextTimer=null)}_setStatusText(){this._clearTimerStatusText();const e=this.arStatusConfig.shift();e&&e.timer&&e.text&&(this.setTextTimer=setTimeout((()=>{this.setState({statusText:e.text}),this._setStatusText()}),e.timer))}render(){const{statusText:e}=this.state,{isPinedTop:t=!1,title:s="",delayedTime:a,hideTitle:i=!1}=this.props;return Mr.a.createElement("div",{ref:e=>this.domRef=e,className:`z-chat-loading ${a?"hidden":""} ${t?"z-chat-loading-pined":""}`,id:""+(t?"z-chat-loading-pined":""),style:{paddingBottom:i?0:void 0}},Mr.a.createElement(Tw.a,{className:`chat-loading-icon ${this.props.outerClassname}`,size:this.props.size,style:this.props.style}),i?null:Mr.a.createElement(Rr.a,{className:"z-chat-loading__text "+this.props.outerClassname,textKey:s||e}))}}Lw.defaultProps={outerClassname:""};var Dw=Object(Rw.a)(Lw,97128),Aw=s("ncjs"),Fw=s("qJfJ"),kw=s("dGAM"),Nw=s("1PLK"),Pw=s("30XY"),jw=s("/sDj"),Uw=s("QQLV"),Bw=s("UFGt"),zw=s("YbIt"),Gw=s("J0AE");const xw={bigThumb:{width:375,height:212},smallThumb:{width:64,height:64}};function Vw(){const e=Ce.default.message_bubble.link.big_thumb_width_threshold;return isNaN(Number(e))?380:e}function Hw(){Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.SETTINGS,params:{data:{tab:Ow.f.MESSAGES}},forceCloseAll:!0})}var Ww=function(e){var t,s;null===(t=e.quickMessageActionFunc)||void 0===t||t.call(e,{localPath:"",folderPath:"",downloadFileFunc:()=>{}});const a=e.data,i=null==a?void 0:a.message,n=Object(Or.useRef)(Ar.c);n.current=e.windowId||n.current;const r=Object(Or.useRef)(!(!i||!i.thumb)&&-1!==Object.values(ui.DEFAULT_THUMB_URLS).indexOf(i.thumb)),o=Object(Or.useRef)(null),[c,l]=Object(Or.useState)(function(){const e=R();if(void 0!==e)return e;return!(r.current||null==i||!i.thumb)||!(null!=i&&i.href&&(ui.default.checkGoogleDriveLinks(i.href)||ui.default.isThumbFail(i.thumb)))}()),[d,u]=Object(Or.useState)(!1),[h,g]=Object(Or.useState)(Me.g.getYoutubePreview(e.userId)),[m,p]=Object(Or.useState)(!0),[f,v]=Object(Or.useState)(xw.bigThumb),_=Object(Ew.a)((()=>{var t;if(!c)return;let s;if(void 0===(s=null===(t=o.current)||void 0===t?void 0:t.clientWidth))return;let a;if(a=e.containerWidth&&e.containerWidth-200>xw.bigThumb.width?xw.bigThumb.width:s,void 0===a)return;const i=9*a/16;a===(null==f?void 0:f.width)&&i===(null==f?void 0:f.height)||v({width:a,height:i})}),200);Object(Or.useEffect)((()=>{let e;return _e.default.subscribe(w),_(),o.current&&(e=new ResizeObserver((()=>{_()})),e.observe(o.current)),()=>{var t;_e.default.unsubscribe(w),null===(t=e)||void 0===t||t.disconnect()}}),[]),Object(Or.useEffect)((()=>{_()}),[e.containerWidth]),Object(Or.useEffect)((()=>{!function(){if(c&&null!=i&&i.thumb){let[,e]=E.g.safeParseJson(i.params);e&&e.width?e.width<Vw()&&l(!1):me.a.MediaSizeParserManager.parseAsync(i.thumb).then((t=>{let s=t;if(s&&"number"==typeof s.width&&"number"==typeof s.height){s.width<Vw()&&l(!1);const t=Ce.default.file_photo_limit;if(s.width<=t.width&&s.height<=t.height){const t=Object(I.a)({},a);t.status!==Y.MSG_LOCAL&&t.status!==Y.MSG_FAIL&&(e.width=s.width,e.height=s.height,t.message.params=JSON.stringify(e),Re.default.updateMessageParams(t.msgId,{width:e.width,height:e.height},t))}else u(!0)}else l(!1)})).catch((()=>{l(!1)}))}}()}),[null==i?void 0:i.thumb]);let b={};if(""!==(null==a||null===(s=a.message)||void 0===s?void 0:s.params))try{var y;b=JSON.parse(null==a||null===(y=a.message)||void 0===y?void 0:y.params)}catch(j){return ui.default.logCoreError(j),Mr.a.createElement("div",{className:e.className},e.displayName,Mr.a.createElement("div",null,"Tin nhắn không hiển thị được"),e.sendTime)}let S=e.className||"";S+=" card--link"+(c?" has-big-thumb":"");const C=function(){let e=null;if(h){var t;const s={width:"640",height:"360"},i=null==a||null===(t=a.message)||void 0===t?void 0:t.href;let n=null;switch(b.src){case kw.a.mp3Src:case kw.a.mp3SrcNewBeta:case kw.a.mp3SrcNew:n=kw.b.getMp3CodeFromUrl(i),s.height="180";break;case kw.a.youtubeShortlinkSrc:case kw.a.youtubeSrc:n=kw.b.getYoutubeCodeFromUrl(i);break;case kw.a.soundcloudSrc:n=kw.b.getSoundCloudUrl(i)}n&&(e=Mr.a.createElement(Aw.a,{className:"video-youtube__frame",scrolling:"no",width:s.width,height:s.height,src:n,frameBorder:"0",allowFullScreen:!1,additionalSandboxPolicy:"allow-presentation"}))}return e}(),O=a.status===Y.MSG_LOCAL,M=!_o.default.isMultiURL(null==i?void 0:i.title,!0,null),T="0"===(null==a?void 0:a.fromUid)&&((null==a?void 0:a.isLastMsg)?"div_LastSentMsg_Link":"div_SentMsg_Link")||(null==a?void 0:a.isLastMsg)&&"div_LastReceivedMsg_Link"||"div_ReceivedMsg_Link";return Mr.a.createElement("div",{id:P(),className:"link-message-v2 "+S,"data-id":T,onContextMenu:k},e.displayName,Mr.a.createElement(Fw.a,{urgency:null==a?void 0:a.urgency}),function(){var t,s,r,l,u;const h=null==a||null===(t=a.message)||void 0===t?void 0:t.href,g="string"==typeof h?ui.default.extractDomain(h):"",v=(null==a||null===(s=a.message)||void 0===s?void 0:s.description)||"",_=v.split("..."),y=!(null==a||!a.extra||!a.extra.todoInfo||ui.default.isEmptyObject(a.extra.todoInfo)||1!==(null===(r=Re.default.getTaskSetting())||void 0===r?void 0:r.ui_v2)),S=(null==a||null===(l=a.message)||void 0===l?void 0:l.title)||"",E=Object(Gw.a)(S,e);let T=Mr.a.createElement("div",null,E?Mr.a.createElement("div",{style:M?{marginBottom:"8px"}:{},className:"text",onDoubleClick:F},function(e){if(!e)return null;const t=e.props.children?e.props.children:[];return Mr.a.createElement(e.type,e.props,t&&t.length>0?t:null)}(E)):null,M?Mr.a.createElement("div",{id:N(),onContextMenu:k,onDoubleClick:F},null!=C&&!0!==y?Mr.a.createElement("div",{key:"player",className:"flx flx-al-s "+(null!=C?" video-youtube":"")+" clickable"},Mr.a.createElement("div",{className:"video-youtube__config"},Mr.a.createElement("i",{className:"video-youtube__config__btn fa fa-chat-video-icon-setting",onClick:Hw}),n.current==Ar.c&&Mr.a.createElement("i",{className:"video-youtube__config__close fa fa-chat-video-icon-float",onClick:D})),C):!0===y?null:Mr.a.createElement("div",{key:"player",className:"flx flx-al-s card--link-content text-is-card-link"+(null!=C?" video-youtube":"")+" clickable"+(c&&!d?" has-big-thumb":""),onClick:L},Mr.a.createElement("div",{ref:o,style:{width:c?"100%":void 0}},function(){if(M&&Boolean(""!==(null==i?void 0:i.thumb)&&!d)){if(void 0===R())return null;const e=c?f:xw.smallThumb;return m?Mr.a.createElement("div",{className:"card--link-loading card--link-img flx flx-center flx-al-c",style:Object(I.a)({},e)},Mr.a.createElement(Dw,{hideTitle:!0,delayedTime:1e3})):null}return null}(),Mr.a.createElement("div",{className:Object(PC.a)("card--link-container",d&&"card--link-container--error"),style:{visibility:m?"hidden":"visible",overflow:"hidden",height:m?0:"auto"}},function(){let t=null;if(M&&Boolean(""!==(null==i?void 0:i.thumb)&&!d)){var s,r;const o=null!==(s=e.chatId)&&void 0!==s?s:null===(r=e.conversation)||void 0===r?void 0:r.userId,l=c?f:xw.smallThumb;t=Mr.a.createElement(zw.a,{key:"link-thumb",ctxWindow:window,enableCheckSize:!0,windowId:n.current,entry:"LINK_PREVIEW_THUMB",className:"card--link-img",thumbUrl:i.thumb,width:"number"==typeof(null==l?void 0:l.width)?l.width:0,height:"number"==typeof(null==l?void 0:l.height)?l.height:0,mediaId:`${a.cliMsgId}.${a.fromUid}.${a.toUid}`,localPathMapper:async(e,t)=>await Object(Bw.b)(o,a.msgId,e,O&&i.href)||"",conversationId:o,msgId:a.msgId,containerWidth:e.containerWidth||0,onLoad:()=>{p(!1)},onError:A,renderError:()=>Mr.a.createElement("div",{className:"card--link-img link-placeholder flx flx-center flx-al-c",style:Object(I.a)({},l)})})}else t=Mr.a.createElement("div",{className:"card--link-img link-placeholder flx flx-center flx-al-c"});return t}())),Mr.a.createElement("div-15",{key:"link-content",className:Object(PC.a)("card-content",d&&"ml-0")},Mr.a.createElement("span-b14",{className:"card-title on-hover"},b.mediaTitle||h),v&&(null==a||null===(u=a.message)||void 0===u||!u.title||a.message.title&&"string"==typeof a.message.title&&a.message.title.indexOf(_[0])<0)?Mr.a.createElement("span-14",{className:"card--link__sub clp clp--two"},v):null,Mr.a.createElement("span-13",{className:"card--link__src clp clp--one"},b.src||g)))):null);!0===y&&(T=Mr.a.createElement(Mw.a,{windowId:n.current,data:null==a?void 0:a.extra.todoInfo,htmlInner:T,user:{userId:e.userId},confirm:e.confirm,dispatch:e.dispatch,focusId:e.focusId}));return T}(),e.isLast||M?Mr.a.createElement("div",{className:"flx"},e.sendTime,e.thread):null,e.msgAction,e.reaction);function R(){let e;try{e=JSON.parse(i.params)}catch(j){}if(e&&"number"==typeof e.width)return e.width>=Vw()}function w(e,t){e===ve.GeneralActions.CHANGE_YOUTUBE_PREVIEW&&g(t)}function L(t){var s,r;t.preventDefault(),t.stopPropagation();const o=null!==(s=e.chatId)&&void 0!==s?s:null===(r=e.conversation)||void 0===r?void 0:r.userId;Ce.default.cloud_send2me.enable&&o==Ce.default.sendToMeId&&jw.b.log(jw.a.OPEN,1,a);const c=(null==i?void 0:i.href)||"",l=Qc.a.parseUriInApp(c);if(Ce.default.groupLinkRegEx.test(c))Ie.ModalManagerV2.openModal({windowId:n.current,name:Y.ModalIdentitiesDefine.GROUP_PREVIEW,params:c});else if(Uw.a.checkLinkZaloShop(c)){var d;Uw.a.setLinkOpen(c),null===(d=e.dispatch)||void 0===d||d.call(e,{type:ve.SideBarActions.SELECT_TAB_ZALO_SHOP})}else if(Pw.b.isCatalogProductLink(c)){var u,h,g;const t=null==o?void 0:o.startsWith(Y.GROUPID_PREFIX);null===(u=e.emitter)||void 0===u||u.emit(ve.GeneralActions.OPEN_MEDIA_BOARD,{type:ve.GeneralActions.OPEN_LINK_CATALOG,uid:null!==(h=e.chatId)&&void 0!==h?h:null===(g=e.conversation)||void 0===g?void 0:g.userId,url:c,src:e.isOA?33:t?31:30}),Ia.default.logActionInfoV2(Ia.FeaturesInfo.BusinessCatalog,1,{source:1})}else l?Qc.a.handleUriAction(l,e.dispatch,o||null,(()=>Nw.b.open(c))):Nw.b.open(c,!0,!1,null,n.current)}function D(t){var s,i,n,r;t.preventDefault(),t.stopPropagation();const o=JSON.parse(null==a||null===(s=a.message)||void 0===s?void 0:s.params),c={id:null==a?void 0:a.msgId,title:o.mediaTitle||(null==a||null===(i=a.message)||void 0===i?void 0:i.description),artist:o.artist,original:o.mediaTitle,url:null==a||null===(n=a.message)||void 0===n?void 0:n.href,src:o.src,originalMessage:a};null===(r=e.dispatch)||void 0===r||r.call(e,{type:ve.PopupActions.MP3_PREVIEW,payload:c})}function A(){l(!1),u(!0),p(!1)}function F(e){e.preventDefault(),e.stopPropagation()}function k(t){if("function"!=typeof e.showContextMenu)return;const s=`openCtxMenu_Link_${e.data.cliMsgId}`;ZR.a.stopAll(),ZR.a.for(s);const a={event:t,message:e.data,detail:{trackingCmdId:s,linkMessageContainerId:P(),linkContentContainerId:N()}};e.showContextMenu(a)}function N(){return`link-content-container_${a.cliMsgId}_${a.fromUid}_${a.toUid}`}function P(){return Y.UIMessagePrefixElementID.LinkMessage+Object(fe.j)(a)}},qw=s("dbb5"),Kw=s("Qd2S");const Zw="location-message",$w=Zw+"__container",Qw={Blue:$w+"--blue",Focusing:$w+"--focusing",Selected:$w+"--selected",HighlightFromPrivilegedUser:$w+"--highlight-from-privileged-user"},Yw=Zw+"__map-container",Jw=Zw+"__map",Xw=Zw+"__marker-icon-container",eL=Zw+"__marker-icon",tL=Zw+"__info-container",sL=Zw+"__info-title-container",aL={Center:sL+"--center"},iL=Zw+"__info-description-container";function nL(e){const{isUserLocation:t,senderAvatarURL:s}=e;return t?Mr.a.createElement("div",{className:Xw},Mr.a.createElement("div",{className:eL,style:{backgroundImage:"url('"+s+"')"}})):null}var rL=function(e){const{latitude:t,longitude:s,onClick:a}=e;let i="";return 1===Ce.default.map_embeded_mode?i="https://maps.google.com/maps?ll="+t+","+s+"&z=14&output=embed":2===Ce.default.map_embeded_mode&&Ce.default.map_api_key&&(i=`https://www.google.com/maps/embed/v1/view?key=${Ce.default.map_api_key}&center=${t},${s}&zoom=14`),i?Mr.a.createElement("div",{className:Yw,onClick:e=>{a&&a(e)}},Mr.a.createElement(nL,e),Mr.a.createElement(Aw.a,{additionalSandboxPolicy:"allow-presentation",className:Jw,src:i,frameBorder:0,marginHeight:0,marginWidth:0,scrolling:"no",style:{pointerEvents:"none"}})):null},oL=s("AM4K");function cL(e){return"https://maps.google.com/maps?q="+e.latitude+","+e.longitude+"&z=14&t=m&mapclient=embed"}var lL=function(e){const{latitude:t,longitude:s,onClick:a}=e,i=cL({latitude:t,longitude:s});return Mr.a.createElement("div",null,oL.a.getHtmlFromText(i,!0,a))};function dL(e){const{data:t,senderName:s}=e,a=t.UIContent,i="0"===t.fromUid,n=Boolean(a.isUserLocation);return Object(qw.b)(),Mr.a.createElement("div",{className:tL},Mr.a.createElement("div",{className:Object(PC.a)(sL,n&&aL.Center)},Mr.a.createElement("span",null,function(e,t,s,a){return t?s?ce.a.str("STR_MY_LOCATION"):ce.a.str("STR_LOCATION_OF")+` ${a}`:e}(a.title,n,i&&n,s))),!n&&Mr.a.createElement("div",{className:iL},Mr.a.createElement("span",null,a.description)))}function uL(e){const{data:t,senderAvatar:s,windowId:a}=e,i=t.UIContent,n=(e,t)=>{e.stopPropagation(),e.preventDefault(),null==t&&(t=cL({latitude:i.latitude,longitude:i.longitude})),Nw.b.open(t,!1,!0,null,a)},r=Boolean(i.isUserLocation),o=rL({isUserLocation:r,latitude:i.latitude,longitude:i.longitude,onClick:n,senderAvatarURL:s||""});return null==o?Mr.a.createElement(lL,{latitude:i.latitude,longitude:i.longitude,onClick:n}):Mr.a.createElement(Mr.a.Fragment,null,o,Mr.a.createElement(dL,e))}var hL=function(e){const{data:t,isHighlightedByPrivilegedUser:s,isFocused:a,isMultiSel:i,selectedMsg:n={},observeIntersectionForReading:r}=e,o="0"===t.fromUid,c=i&&n[t.msgId],l=Mr.a.useRef(null);Object(cR.a)(l,r);const d=Object(Kw.a)((()=>Y.UIMessagePrefixElementID.LocationMessage+Object(fe.j)(t))),u=Object(Kw.a)((t=>{"function"==typeof e.showContextMenu&&e.showContextMenu({event:t,message:e.data})}));return Mr.a.createElement(lR.a,{border:6,className:Object(PC.a)($w,o&&Qw.Blue,c&&Qw.Selected,s&&(null==t.ttl||0==t.ttl)&&Qw.HighlightFromPrivilegedUser,!Boolean(t.ttl)&&"shadow-bubble","rounded-6","focused-item",a&&"focused-item--highlight-border"),isAdmin:s,variant:"common",ttl:t.ttl},Mr.a.createElement("div",{ref:l,"data-qId":Object(fe.g)(t),id:d(),onContextMenu:u},Mr.a.createElement(uL,e)))};var gL=s("oxAw"),mL=s("anH1");var pL=function(e){var t,s,a;const i=e.data,n=null===(t=e.conversation)||void 0===t||null===(s=t.userId)||void 0===s?void 0:s.startsWith(Y.GROUPID_PREFIX);let r="";var o;(null==i?void 0:i.msgType)===Y.MSG_PHOTO&&null!=i&&null!==(a=i.message)&&void 0!==a&&a.title&&(r=gL.a.isCardTitle(null==i||null===(o=i.message)||void 0===o?void 0:o.title,n));const c=e.focusId&&(null==i?void 0:i.msgId)&&e.focusId.indexOf(i.msgId)>=0&&1===e.focusType;return Mr.a.createElement(mL.a,{windowId:e.windowId||"",ctxWindow:e.selfWindow||window,containerWidth:e.containerWidth||0,message:i,imageClickHandler:e.imageClickHandler||(()=>{}),renderHtmlMessage:()=>{var t;return Object(Gw.a)((null==i||null===(t=i.message)||void 0===t?void 0:t.title)||"",e)},selectedType:e.selectedType,forceShowCardBtnTitle:r,selectedMsg:e.selectedMsg,isMultiSel:e.isMultiSel||!1,onChooseMsg:e.onChooseMsg,isSignAdminMsg:e.isHighlightedByPrivilegedUser||!1,highlight:c||!1,isFocused:e.isFocused,onFilePathUpdated:e.onFilePathUpdated||(()=>{}),showContextMenu:e.showContextMenu,resendMessage:e.resendMessage,sendTime:e.SentTimeCompRenderer,observeIntersectionForReading:e.observeIntersectionForReading})},fL=s("/PwA"),vL=s("oRa2"),_L=s("5tQl"),bL=s("oNsl"),IL=s("7fJY"),yL=s("Wb+/"),SL=s("9/5/"),CL=s.n(SL),EL=s("x0gP"),OL=s("yfqh"),ML=s("IMYd"),TL=s("GzlV"),RL=s("116d"),wL=s("ADT0"),LL=s("apzQ"),DL=s("yhZf"),AL=s("yyM+"),FL=s("z+wX"),kL=s("pWOx");const NL=ui.default.isWeb();let PL,jL;NL||(PL=s("Dprd").default,jL=$znode.path);class UL extends Mr.a.Component{constructor(e){super(e),this._handleUpdateLayoutConfig=e=>{LL.a.updateConfig(Object(I.a)({},e)),this.setState((t=>Object(I.a)(Object(I.a)({},t),{},{layoutConfig:Object(I.a)(Object(I.a)({},t.layoutConfig),e)})))},this.isCloud=e=>!(!e||"string"!=typeof e||e!==Ce.default.sendToMeId),this.windowId=e.windowId||Ar.c,this.imageLocalPath={},this.state={checkedLocalPath:!1,resetLayout:!1,forceRender:!1,layoutConfig:LL.a.config},this.limitShowDynamic=Ce.default.dynamic_layout_photo.total_limit,this.border=4,Ce.default.dynamic_layout_photo&&!0!==AL.a.media_group_layout.enable&&this.props.photos&&this._preGridPhoto(this.props.photos),this.maxWidth=this.computeMaxWidth(),this.focusedElement=[],this._groupPhotoRowRefs=new Map,this.selectedPhoto={},this._onFilePathUpdated=this._onFilePathUpdated.bind(this),this.findPhotoByIdInGroup=this.findPhotoByIdInGroup.bind(this),this.onResize=ui.default.throttle((()=>{var e;if(1==AL.a.media_group_layout.enable)return this.maxWidth=this.computeMaxWidth(),void this.setState({forceRender:!this.state.forceRender});(null===(e=this.props.photos)||void 0===e?void 0:e.length)<4&&(this._preGridPhoto(this.props.photos),this.maxWidth=this.computeMaxWidth(),this.setState({forceRender:!this.state.forceRender}))}),500),this.enableFileStoreComp=bL.a.isActivated("enable_file_store_comp"),this.localedPhotosRef=Mr.a.createRef(),this.localedPhotosRef.current=[]}_equalSendTime(e,t){return!e&&!t||!(!e&&t||!t&&e)&&(!(!e||!t)&&e.key==t.key)}shouldComponentUpdate(e,t){var s,a,i,n,r,o,c,l,d,u;return!this.props.photos.equals(e.photos)||!this._equalSendTime(this.props.sendTime,e.sendTime)||this.props.className!==e.className||!ui.default.arraysEqual(this.props.focusId,e.focusId)||this.state.resetLayout!==t.resetLayout||this.state.checkedLocalPath!==t.checkedLocalPath||this.props.isSelected!==e.isSelected||this.state.forceRender!==t.forceRender||this.props.isMultiSel!==e.isMultiSel||this.props.selectedMsg!==e.selectedMsg||this.props.isMouseMoveSelecting!==e.isMouseMoveSelecting||this.props.containerWidth!==e.containerWidth||this.props.focusedMessageId!==e.focusedMessageId||(null===(s=this.state.layoutConfig)||void 0===s?void 0:s.scaleFactor)!==(null===(a=t.layoutConfig)||void 0===a?void 0:a.scaleFactor)||(null===(i=this.state.layoutConfig)||void 0===i?void 0:i.containerWidth)!==(null===(n=t.layoutConfig)||void 0===n?void 0:n.containerWidth)||(null===(r=this.state.layoutConfig)||void 0===r?void 0:r.targetItemHeight)!==(null===(o=t.layoutConfig)||void 0===o?void 0:o.targetItemHeight)||(null===(c=this.state.layoutConfig)||void 0===c?void 0:c.borderRadius)!==(null===(l=t.layoutConfig)||void 0===l?void 0:l.borderRadius)||(null===(d=this.state.layoutConfig)||void 0===d?void 0:d.spacing)!==(null===(u=t.layoutConfig)||void 0===u?void 0:u.spacing)}componentWillMount(){var e;this.props.selfWindow.addEventListener("resize",this.onResize),this.emitter=null===(e=this.context.zemitter)||void 0===e?void 0:e.on(wL.a.UPDATE_LAYOUT_CONFIG,this._handleUpdateLayoutConfig),ui.default.log("image-group-message: Mount");const t=this.props.message;t&&t.msgId&&t.message&&t.message.length&&kL.a.startLoad(t.msgId,t.message)}componentWillUpdate(e){this.props.photos.equals(e.photos)||!0===AL.a.media_group_layout.enable||this.props.photos.length!==e.photos.length&&this.props.message&&(_L.default.disableGroupPhotoSkeleton(this.props.message),this._preGridPhoto(e.photos),this.maxWidth=this.computeMaxWidth(e)),e.containerWidth!==this.props.containerWidth&&(this.maxWidth=this.computeMaxWidth(e))}componentDidMount(){for(let[e,t]of this._groupPhotoRowRefs.entries()){const s=Ap.a.getInViewController(this.windowId);null==s||s.observe(t,{identifier:e,onIntersect:this.props.onMsgIntersect.bind(null,e),threshold:.9})}this.mountCallback(this.props.focusHandler)}componentWillUnmount(){this.timeoutSkeleton&&(clearTimeout(this.timeoutSkeleton),this.cacheId&&_L.default.deleteCache(this.cacheId)),this.props.selfWindow.removeEventListener("resize",this.onResize),ui.default.log("image-group-message: componentWillUnmount");for(let[e,t]of this._groupPhotoRowRefs.entries()){const e=Ap.a.getInViewController(this.windowId);null==e||e.unobserve(t)}this.emitter.remove(),kL.a.onUnmount(this.props.message.msgId)}componentWillReceiveProps(e){if(this.props.focusId!==e.focusId&&(this.focusedElement=[]),e.selectedMsg&&0!==Object.keys(e.selectedMsg).length){var t,s;const a={};null===(t=this.props.message)||void 0===t||null===(s=t.message)||void 0===s||s.forEach((t=>{e.selectedMsg[t.msgId]&&(a[t.msgId]=!0)}));let i=!1;const n=Object.keys(this.selectedPhoto),r=Object.keys(a);if(n.length!==r.length)i=!0;else for(const e of r)if(!this.selectedPhoto[e]){i=!0;break}i&&(this.selectedPhoto=a,this.setState({forceRender:!this.state.forceRender}))}else this.selectedPhoto={}}componentDidUpdate(e,t){var s;(this.mountCallback(this.props.focusHandler),e.photos.length!==this.props.photos.length)&&kL.a.onReLayout(null===(s=this.props.message)||void 0===s?void 0:s.msgId)}computeMaxWidth(e){var t,s,a,i,n,r;e=null!==(t=e)&&void 0!==t?t:this.props;let o=(null!==(s=null!==(a=null===(i=this.props)||void 0===i?void 0:i.containerWidth)&&void 0!==a?a:null===(n=this.props.selfWindow.document.getElementById("messageViewContainer"))||void 0===n?void 0:n.clientWidth)&&void 0!==s?s:400)-170;const c=this.gridPhotoMap?_L.default.getLengthSkeleton(this.gridPhotoMap):this.props.photos.length;return(c<4&&!(null!==(r=e.photos)&&void 0!==r&&r.length)<4||c<Ce.default.dynamic_layout_photo.total_limit)&&(o=Math.min(o,450)),o=this.gridPhotoMap&&this.gridPhotoMap.length==_L.default.getLengthSkeleton(this.gridPhotoMap)?Math.min(o,335):Math.min(o,450),o}mountCallback(e){if(ui.default.log("image-group-focus: not mounted"),this.focusedElement&&this.focusedElement.length){let t=[],s=[];this.focusedElement.forEach((e=>{e.element&&(s.push(e.messageID),t.push({ele:e.element,ref:null}))})),e(s,t,null,!0)}}_onFilePathUpdated(e,t){var s;(null==e?void 0:e.status)<Y.MSG_SENT||e&&e.msgId&&(this.imageLocalPath[e.msgId]=t,this.setState({checkedLocalPath:!this.state.checkedLocalPath}),(e.msgType===Y.MSG_VIDEO||e.subType===Y.MSG_SUBTYPE_MEDIA_VIDEO||e.msgType===Y.MSG_PHOTO)&&(null===(s=a.ModuleContainer.resolve(we.a))||void 0===s||s.updateMedia("image",e.toUid,e.msgId,{localPath:t},["localPath"]),Re.default.updateMessage(e.msgId,{msgId:e.msgId,localPath:t},["localPath"],this.props.conversation.userId),this.props.dispatch({type:ve.ChatBoxActions.FILEPATH_UPDATED,payload:e})))}_resendMessage(e,t,s={}){this.props.resendMessage(e,t)}_showInFolder(e,t){t&&(t.preventDefault(),t.stopPropagation());let s=this.imageLocalPath[e.msgId];PL&&s&&PL.fileExists(s).then((t=>{t?PL.showInFolder(s):(mc.default.createError(ce.a.str("STR_TOAST_FILE_NOT_FOUND")),this.imageLocalPath[e.msgId]="",this.setState({checkedLocalPath:!this.state.checkedLocalPath}))})),Ia.default.logAction(107190903)}_onDownloadFileDone(e,t,s,a=!0,i=""){if(!e&&ui.default.isWindows()&&(s||i)){const e=Date.now();Ce.default.recent_photo.enableFeature&&ui.default.isWindows()&&Oe.a.setPhotoDownload({isLocalFile:!0,path:s,lastModified:e,name:jL.basename(s),shortenPath:ui.default.getShortenPath(s,40),fromSource:"DownloadedPhoto"})}}showAction(e,t){t&&(t=Object(IL.a)(t),this.props.showMessageAction(e,!0,t,this.imageLocalPath[t.msgId],this._resendMessage.bind(this),this._showInFolder.bind(this,t),(e=>{if(e&&(e.preventDefault(),e.stopPropagation()),!NL&&t&&(t.msgType===Y.MSG_PHOTO||t.msgType===Y.MSG_DOODLE||t.msgType===Y.MSG_VIDEO)&&t.message.oriUrl){var s;const e=t.msgType===Y.MSG_VIDEO?tt.default.constants.DownloadType.Video:tt.default.constants.DownloadType.Photo;let a=ui.default.getConversationType(null===(s=this.props.conversation)||void 0===s?void 0:s.userId),i=new oe.c(oe.a.ChatBoxView).getBuilder().withType(t.msgType===Y.MSG_VIDEO?oe.f.Video:oe.f.Photo).withMode(oe.e.Manual).withCode(oe.d.CBVPhotoGr).withConvType(oe.b[a]).build();ue.a.downloadWithMultiSrc("runByMsg",t,{entry:i,type:e,options:{srcAction:tt.default.constants.srcAction.Manual,saveAs:!0,showProgress:{progressBar:!1,taskBar:!0},duplicate:!1}}).then((e=>{this.setState({isDownloading:!1});const{isFolder:s,savePath:a}=e||{};let i=s?"":a,n=s?n:"";this._onDownloadFileDone(!1,t&&t.msgId,i,!1,n)})).catch((e=>{this._onDownloadFileDone(e)}))}})))}_extractThumbUrl(e){return ui.default.removeProtocol(e&&e.message&&e.message.thumbUrl)}_renderDuration(e){if(!e||isNaN(e))return null;let t=Math.round(e/1e3),s=Math.floor(t/60);return t-=60*s,ui.default.strPadLeft(s+"","0",2)+":"+ui.default.strPadLeft(t+"","0",2)}_onClickNoPhoto(e){}_preGridPhoto(e){if(this.isDynamicLayout=this.props.photos.length<=this.limitShowDynamic,e&&e.length){const t=QR.a.utils.safeParseJSON(e[0].message.params);let s=null;const a=e=>{this.gridPhotoMap=_L.default.genSkeleton(e,this.props.message.msgId)};if(null!=t&&t.group_layout_id&&(this.cacheId=t.group_layout_id+"_"+e[0].fromUid,s=_L.default.getGroupPhotoSkeleton(this.cacheId)),s){let i=_L.default.normalizeSkeleton(s),n=_L.default.getLengthSkeleton(i);this.hasSkeleton=!0,i&&n>=e.length?(n>e.length&&!this.timeoutSkeleton?this.timeoutSkeleton=setTimeout((()=>{_L.default.getLengthSkeleton(this.gridPhotoMap)!==this.props.photos.length&&(_L.default.deleteCache(t.group_layout_id+"_"+e[0].fromUid),a(this.props.photos),this.hasSkeleton=!1,this.setState({forceRender:!this.state.forceRender}))}),Ce.default.time_clear_cache_skeleton_group_photo):n==e.length&&this.timeoutSkeleton&&(clearTimeout(this.timeoutSkeleton),this.timeoutSkeleton=null),this.gridPhotoMap=i,this.isDynamicLayout=n<=this.limitShowDynamic):a(e)}else this.hasSkeleton=!1,a(e)}}findPhotoByIdInGroup(e){if(this.hasSkeleton){for(let s of this.props.photos)try{let t=JSON.parse(s.message.params);if(t.id_in_group>=0&&t.id_in_group==e)return s}catch(t){ui.default.logCoreError("show dynamic layout",t)}return null}return this.props.photos[e]}extractDimensions(e){return e.map((e=>{var t;let s=90,a=90;const i=QR.a.utils.safeParseJSON(null==e||null===(t=e.message)||void 0===t?void 0:t.params);s=+(null==i?void 0:i.width)||+(null==i?void 0:i.video_width),a=+(null==i?void 0:i.height)||+(null==i?void 0:i.video_height),(isNaN(s)||s<=0)&&(s=Np.b),(isNaN(a)||a<=0)&&(a=Np.b);const n=null!=i&&i.hasOwnProperty("video_width")||null!=i&&i.hasOwnProperty("video_height")?"video":"image";return{width:s,height:a,group_layout_id:null==i?void 0:i.group_layout_id,type:n}}))}getGroupImageMessageContainerID(){return Y.UIMessagePrefixElementID.GroupImageMessage+Object(fe.j)(this.props.message)}render(){var e;ui.default.log("image-group-message: render "+this.props.photos.length),this.focusedElement=[];let t=Object(PC.a)(this.props.className,"card--group-photo","-bg-v-"+Ce.default.image.bg_v),s=0,a=!1,i=0,n=[],r={};n=this.extractDimensions(this.props.photos),r=TL.a.layout(n,{aspectRatio:this.state.layoutConfig.aspectRatio,containerWidth:this.state.layoutConfig.containerWidth,borderRadius:this.state.layoutConfig.borderRadius,spacing:this.state.layoutConfig.spacing,targetItemHeight:this.state.layoutConfig.targetItemHeight,isCloud:this.isCloud(null===(e=this.props.conversation)||void 0===e?void 0:e.userId)});const o=Math.min(this.maxWidth,this.state.layoutConfig.containerWidth,r.width),c=Math.min(o/r.width,1)||1;r=TL.a.fullLayoutScale(r,c),s<Object.keys(this.selectedPhoto).length&&(this.reMapSelected=!0,s=0);let l=(e=>!e.message||!e.message.every((e=>e.msgType===Y.MSG_UNDO||e.msgType===Y.MSG_DEL_EVERYONE)))(this.props.message),d=null,u=this.props.sendTime?null:this.props.thread,h=this.props.message.fromUid===this.props.userId||"0"===this.props.message.fromUid,g="thread-photo-ico thr-photo"+(this.props.message.root>0&&!this.props.message.refMessageId?" rootmsg":"");l?(d=!this.props.isMultiSel&&u?Mr.a.createElement("div",{className:"rl-react-thread"},this.props.reaction,Mr.a.createElement("div",{className:g,style:h?null:{margin:0}},u)):u?Mr.a.createElement("div",{style:{height:16}},this.props.reaction,Mr.a.createElement("div",{className:g,style:h?null:{margin:0}},u)):Mr.a.createElement("div",{style:this.props.sendTime?{height:16}:void 0},this.props.reaction),Object(DL.a)().ENABLE_REACTION_V2&&(d=null)):d=null;const m="0"===this.props.photos[0].fromUid&&([...this.props.photos].pop().isLastMsg?"div_LastSentMsg_GrpPhoto":"div_SentMsg_GrpPhoto")||[...this.props.photos].pop().isLastMsg&&"div_LastReceivedMsg_GrpPhoto"||"div_ReceivedMsg_GrpPhoto";let p=null;if(Object(DL.a)().ENABLE_REACTION_V2&&1==AL.a.media_group_layout.enable&&r&&r.layout){var f,v,_,b;const e=180,t=r.layout[r.layout.length-2],s=r.layout[r.layout.length-1],i=(null==t?void 0:t.y)!==(null==s?void 0:s.y),n=(null==s?void 0:s.width)||0;a=0==this.props.message.fromUid||i&&n<e;const o={position:"absolute",left:s.x+s.width,bottom:0};null===(f=(v=this.props).changeReactionPosition)||void 0===f||f.call(v,{left:s.x+s.width,bottom:4}),null===(_=(b=this.props).toggleReactionSpace)||void 0===_||_.call(b,a),p=Mr.a.createElement("div",{style:o},this.props.reaction)}return Mr.a.createElement("div",{className:t,"data-id":m},this.props.displayName,Mr.a.createElement("div",{id:"album-container",style:{position:"relative"}},Mr.a.createElement(RL.a,{layout:r,renderItem:({rowId:e,position:t,style:a})=>{let n=this.props.photos[i],r=!1;this.isDynamicLayout&&(n=this.findPhotoByIdInGroup(i));let o=t.width,c=t.height,l=a.objectFit,d=(n&&ui.default.removeProtocol(n.message.oriUrl),n?ui.default.removeProtocol(n.message.thumbUrl):null),u=(n&&ui.default.removeProtocol(n.message.normalUrl),null),h=e=>{if(e.stopPropagation(),!this.props.isMultiSel||this.props.isMouseMoveSelecting){if(!this.props.isMultiSel){if(n.msgType===Y.MSG_VIDEO){[].push(n);const e={user:this.props.user,selectedId:n.msgId,oriUrl:n.message.oriUrl,userId:this.props.userId,isVideo:n.msgType===Y.MSG_VIDEO||2===n.subType,message:n,conversation:this.props.conversation,isMessageConv:!0,images:this.props.photos,iconMap:rh.b.getIconMap(),appConfig:Object(Ce.getPVConfigs)()};return void me.a.OpenPhoto.openPhotoViewer(e)}this.props.onClickImage(n)}}else{if(this.props.selectedMsg.hasOwnProperty(this.props.message.msgId)){let t=!1,s=Object.assign({},this.props.selectedMsg[this.props.message.msgId]);for(let a=0;a<s.message.length;a++){let i=s.message[a];if(i.msgId==n.msgId){s.message.splice(a,1),delete this.selectedPhoto[i.msgId],s.message.length&&Object.keys(this.selectedPhoto).length?this.props.increaseCountMsg&&!ui.default.isPreventCountSelectMessage(i)&&this.props.increaseCountMsg(-1):(this.props.onChooseMsg(s,e),this.selectedPhoto={},t=!0),this.setState({forceRender:!this.state.forceRender});break}if(a==s.message.length-1){this.props.increaseCountMsg&&!ui.default.isPreventCountSelectMessage(n)&&this.props.increaseCountMsg(1)&&(s.message.push(n),this.selectedPhoto[n.msgId]=!0,this.setState({forceRender:!this.state.forceRender}));break}}t||this.props.onMultiSelGroupPhoto(this.props.message.msgId,s)}else{let t=Object.assign({},this.props.message);for(let e=0;e<t.message.length;e++){let s=t.message[e];if(s.msgId==n.msgId){t.message=[s],this.selectedPhoto[n.msgId]=!0,this.setState({forceRender:!this.state.forceRender});break}}this.props.onChooseMsg(t,e)}e.preventDefault()}},g=this.props.isMultiSel&&n&&this.selectedPhoto.hasOwnProperty(n.msgId);g&&s++;let m=!1;var p;void 0!==this.props.focusedMessageId&&(m=(null===(p=n)||void 0===p?void 0:p.msgId)===this.props.focusedMessageId);let f="row_"+i;if(n){if(n.msgType===Y.MSG_UNDO||n.msgType===Y.MSG_DEL_EVERYONE)u=Mr.a.createElement(lR.a,{border:8,isAdmin:this.props.isHighlightedByPrivilegedUser,variant:"photo",ttl:n.ttl},Mr.a.createElement("div",{key:"gimgu_"+n.cliMsgId,onClick:this.props.isMultiSel?h:this._onClickNoPhoto.bind(this),style:{width:o,height:c,borderRadius:"0px",textAlign:"center"},className:Object(PC.a)("card--group-photo__row__item__img chat-message-picture__photooverlay no-shadow-border undo flx flx-col flx-al-c flx-center","recalled-bg-color","0"==n.fromUid?" me":"",g?" selected-overlay":"")},Mr.a.createElement("i",{className:"fa fa-icon-outline-picture recalled-icon-color",style:{fontSize:"var(--f24)"}}),Mr.a.createElement(Rr.a,{className:"recalled-text-color",style:{fontSize:"var(--f14)"},textKey:n.msgType===Y.MSG_UNDO?"STR_RECALLED":"STR_DEL_EVERYONE_GROUP_PHOTO"})));else if(n.status===Y.MSG_FAIL);else if(n.msgType===Y.MSG_PHOTO){var v,_;EL.a.logActionMediaCaption(this.props.conversation,n,o),OL.a.logOldLayoutAction(this.props.conversation,n,i,{width:o,height:c,fit:"cover"});const e={overflow:"hidden",width:o,height:c,borderRadius:"0px",objectFit:l};u=Mr.a.createElement("div",{className:Object(PC.a)("chat-message-picture__photooverlay",g&&"selected-overlay","no-shadow-border",n.message.hdUrl&&!this.props.isMultiSel&&!this.enableFileStoreComp&&"card--picture__high-definition-group"),key:`msg_photo-${n.cliMsgId}`,style:e},Mr.a.createElement(ML.a,{windowId:this.windowId,ctxWindow:this.props.selfWindow,key:n.cliMsgId,groupPhotoId:(null===(v=this.props.message)||void 0===v?void 0:v.msgId)||"",onClick:h,onClickCapture:e=>{Object(FL.b)(n,FL.a.LEFT_CLICK_BUBBLE_MESSAGE)},onContextMenuCapture:e=>{Object(FL.b)(n,FL.a.RIGHT_CLICK_BUBBLE_MESSAGE)},message:n,isMultiSelect:this.props.isMultiSel,onFilePathUpdated:e=>this._onFilePathUpdated(n,e),containerWidth:o,containerHeight:c,width:e.width,height:e.height,objectFit:e.objectFit,total:null===(_=this.props.photos)||void 0===_?void 0:_.length}))}else if(n.msgType===Y.MSG_VIDEO){if(EL.a.logActionMediaCaption(this.props.conversation,n,o),OL.a.logOldLayoutAction(this.props.conversation,n,i,{width:o,height:c,fit:"cover"}),Ce.default.e2ee.debug.show_indicator_video_v2&&Ce.default.stagingAccount&&Ku.b.getMsgE2eeStatus(n)===Y.MSG_E2EE){const e=n.message.oriUrl;r="2"===ui.default.getQueryParamFromUrl(e,"version")}u=Mr.a.createElement(vL.a,{onClick:h.bind(this),onClickCapture:e=>{Object(FL.b)(n,FL.a.LEFT_CLICK_BUBBLE_MESSAGE)},onContextMenuCapture:e=>{Object(FL.b)(n,FL.a.RIGHT_CLICK_BUBBLE_MESSAGE)},selectedPhoto:g,key:n.cliMsgId,className:"card--group-photo__row__item__img card--group-photo__row__item__video clickable "+("0"==n.fromUid?" me":""),style:{width:o,height:c,borderRadius:"0px"},userId:this.props.userId,indexInGroup:i,cacheFolderName:"Cache",src:d,message:n,msgId:n.msgId,onFilePathUpdated:(e,t)=>this._onFilePathUpdated(n,t),conversation:this.props.conversation})}}else u=Mr.a.createElement("div",{key:"msg_skeleton",style:{width:o,height:c,borderRadius:"0px",textAlign:"center"},className:"card--group-photo__row__item__img chat-message-picture__photooverlay no-shadow-border undo flx flx-col flx-al-c flx-center"+(g?" selected-overlay":"")});let b=null;return Ce.default.e2ee.debug.show_msg_src&&Ce.default.stagingAccount&&(b=Ku.b.getMsgE2eeStatus(n)===Y.MSG_E2EE),i++,Mr.a.createElement(zL,{key:f,ancestorProps:this.props,content:u,focusedElement:this.focusedElement,groupPhotoRowRefs:this._groupPhotoRowRefs,height:c,isDynamicLayout:this.isDynamicLayout,isItemFocused:m,isOnFocusedMode:this.props.isMultiSel,mClickAction:h,msgSrcDev:b,photo:n,resendMessage:this._resendMessage.bind(this),selectedPhoto:g,showAction:this.showAction.bind(this),showVideov2Indicator:r,style:a,width:o})},scaleFactor:this.state.layoutConfig.scaleFactor}),p),d,a&&this.props.reactionV2Space,this.props.sendTime)}}UL.contextType=tc.a,UL.propTypes={userId:NC.a.string.isRequired};var BL=UL;function zL(e){const{ancestorProps:t,content:s,focusedElement:a,groupPhotoRowRefs:i,height:n,isDynamicLayout:r,isItemFocused:o,isOnFocusedMode:c,key:l,mClickAction:d,msgSrcDev:u,photo:h,resendMessage:g,selectedPhoto:m,showAction:p,showVideov2Indicator:f,style:v,width:_}=e,b=Mr.a.useRef(null);return Object(cR.a)(b,t.observeIntersectionForReading),Mr.a.createElement("div",{key:l,className:Object(PC.a)("album__item","card--group-photo","card--group-photo-v2","focused-background",o&&" focused-background--focused"),ttl:null==h?void 0:h.ttl,isAdmin:t.isSignAdminMsg,width:_,height:n,style:v},Mr.a.createElement("div",{key:l,ref:e=>{b.current=e,h&&i.set(h.msgId,e),h&&t.focusId.indexOf(h.msgId)>=0&&a.push({messageID:h.msgId,element:e})},className:Object(PC.a)("card--group-photo__row__item",!r&&"no-dynamic","focused-item",o&&"focused-item--highlight-border focused-item--animation focused-item--higher-index"),"data-component":Y.DataAttributes.Component.PHOTO,"data-qId":Object(fe.g)(h),style:{width:_,height:n,borderRadius:v.borderRadius,zIndex:c?3:null},onContextMenu:e=>p(e,h)},u?Mr.a.createElement("i",{style:Object(I.a)(Object(I.a)({position:"absolute",fontSize:10,top:3,zIndex:1,color:"var(--text-information)"},"0"===h.fromUid&&{right:3}),"0"!==h.fromUid&&{left:3}),className:"fa fa-icon-solid-lock-2"}):null,f?Mr.a.createElement("i",{style:Object(I.a)(Object(I.a)({position:"absolute",fontSize:14,top:2,zIndex:1,color:"var(--text-information)"},"0"===h.fromUid&&{right:3}),"0"!==h.fromUid&&{left:3})},"v2"):null,Mr.a.createElement(fw.a,{type:"overlay",msgStatus:h.status,sendDttm:h.sendDttm,onRetryClick:e=>g(e,h,{fromBubble:!0})},s),(h&&h.loadSrc,null),c?Mr.a.createElement("div",{className:"select-btn",style:{lefImgLoaderCtx:"5px",top:"6px"},onClick:d},Mr.a.createElement("i",{className:m?"fa fa-multiselect_checkbox_hover selected-msg ":" fa fa-multiselect-stroke-checkbox unselect-msg"}),m?null:Mr.a.createElement("i",{className:"fa fa-multiselect_checkbox_hover hover-unselected-msg"})):null))}const GL=new u.default({maxSize:20});const xL=Object(yL.a)(UL,((e,t,s)=>{var a;const i=null===(a=t.message)||void 0===a?void 0:a.cliMsgId;if(!i)return void e();const n=function(e){if(GL.has(e))return GL.get(e);let t=CL()((e=>e()),300,{maxWait:1e3}),s={batch:(e,s,a)=>{var i,n,r;(null===(i=s.photos)||void 0===i?void 0:i.length)>1&&(null===(n=s.photos)||void 0===n?void 0:n.length)!==(null==a||null===(r=a.photos)||void 0===r?void 0:r.length)?t(e):(t.cancel(),e())}};return GL.set(e,s),s}(i);n.batch(e,t,s)}));var VL=function(e){var t,s;const a=e.data,i=Ce.default.image.enable_image_group_batch?xL:BL,n=Object(fL.b)(),r=Mr.a.useMemo((()=>{var e;if(void 0!==(null==n||null===(e=n.state)||void 0===e?void 0:e.focusedMessageId)&&Array.isArray(null==a?void 0:a.message)){const e=a.message.find((e=>e.msgId===n.state.focusedMessageId));if(e)return e.msgId}}),[null==n||null===(t=n.state)||void 0===t?void 0:t.focusedMessageId,null==a?void 0:a.message]);return Mr.a.createElement(i,{showMessageAction:(t,s,a,i,n,r,o,c,l,d)=>{if("function"==typeof e.showContextMenu){const s={event:t,message:a,detail:{localPath:i,resendFunc:n,showInFolder:r,downloadFunc:o,onExtension:c,indexOAChild:l,folderPath:d}};e.showContextMenu(s)}},userId:null===(s=e.user)||void 0===s?void 0:s.userId,user:e.user,conversation:e.conversation,photos:null==a?void 0:a.message,replyMessage:e.replyMessage,deleteMessage:e.deleteMessage,recallMessage:e.recallMessage,shareMessage:e.shareMessage,resendMessage:e.resendMessage,onClickImage:e.onClickImage,focusId:e.focusId,focusType:e.focusType,focusedMessageId:r,message:a,selectedMsg:e.selectedMsg,isMultiSel:e.isMultiSel,isSelected:e.isSelected,isMouseMoveSelecting:e.isMouseMoveSelecting,onMultiSelGroupPhoto:e.onMultiSelGroupPhoto,onChooseMsg:e.onChooseMsg,dispatch:e.dispatch,increaseCountMsg:e.increaseCountMsg,onMsgIntersect:()=>{},isSignAdminMsg:e.isAdmin,selfWindow:e.selfWindow||window,windowId:e.windowId,changeReactionPosition:e.changeReactionPosition,toggleReactionSpace:e.toggleReactionSpace,containerWidth:e.containerWidth,isHighlightedByPrivilegedUser:e.isHighlightedByPrivilegedUser,focusHandler:e.focusHandler,observeIntersectionForReading:e.observeIntersectionForReading})};var HL=function(e){const t=e.data,[s,i]=Object(Or.useState)(null==t?void 0:t.localPath),n=Object(Or.useRef)(null);Mr.a.useEffect((()=>{$R.a.getInstance().push(t,$R.b.chatview)}),[]);let r=Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_UNSELECTED;null!=t&&t.msgId&&e.isSelected&&e.selectedMsg&&e.selectedMsg[t.msgId]&&(r=e.selectedMsg[t.msgId].multipleSelectedType||Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_SELECTED_FULL);const o=Object(I.a)(Object(I.a)({},e),{},{imageClickHandler:function(s){if(!t||null!=t&&t.isErrorInfo)return;s&&s.stopPropagation();n.current&&(clearTimeout(n.current),n.current=null);n.current=setTimeout((()=>{var s,a;n.current&&clearTimeout(n.current),n.current=null,null===(s=e.onClickImage)||void 0===s||s.call(e,t),Ce.default.cloud_send2me.enable&&(null===(a=e.conversation)||void 0===a?void 0:a.userId)==Ce.default.sendToMeId&&jw.b.log(jw.a.OPEN,1,t)}),200)},onFilePathUpdated:function(s){i(s),function(e,t,s,i){if(!e)return;if(e.status<Y.MSG_SENT)return;const n=a.ModuleContainer.resolve(we.a),r=e.toUid;e.msgType===Y.MSG_FILE&&(e.localPath=t,e.folderPath=s,n.updateFile(r,e.msgId,{localPath:t,folderPath:s},["localPath","folderPath"])),e.msgType!==Y.MSG_VIDEO&&e.msgType!==Y.MSG_PHOTO||n.updateMedia("image",r,e.msgId,{localPath:t},["localPath"]),Re.default.updateMessage(e.msgId,{msgId:e.msgId,localPath:t,folderPath:s},["localPath","folderPath"],r),null==i||i({type:ve.ChatBoxActions.FILEPATH_UPDATED,payload:e})}(t,s,void 0,e.dispatch)},selectedType:r});return(null==t?void 0:t.msgType)===Y.MSG_PHOTO||(null==t?void 0:t.msgType)===Y.MSG_DOODLE?Mr.a.createElement(pL,o):(null==t?void 0:t.msgType)===Y.MSG_PHOTO_GROUP?Mr.a.createElement(VL,o):null};var WL=s("NuRm"),qL=s("9hee");var KL=function(e){const{conversation:t,data:s,isFocused:a,observeIntersectionForReading:i}=e,n=Object(OC.a)(),r=Object(OC.b)(),o=Object(WL.a)(),c=Mr.a.useRef(null);Object(cR.a)(c,i);const l=Object(Kw.a)(((t,s)=>{if("function"!=typeof e.showContextMenu)return;const a={event:t,message:e.data,detail:{indexOAChild:s}};e.showContextMenu(a)}));return Mr.a.createElement(qL.a,{containerRef:c,oaContextMenu:l,className:"card",content:s.message,dispatch:n,conversation:t,emitter:r,isFocused:a,message:s,windowId:o})};const ZL=e=>{if(!e)return null;let t=null;try{var s;let a="string"==typeof e?JSON.parse(e):"object"==typeof e?e:null;null!=a&&a.params&&("string"==typeof a.params?t=JSON.parse(a.params):"object"==typeof a.params&&(t=a.params)),null!==(s=t)&&void 0!==s&&s.thumbUrl||(t=null)}catch(a){t=null}return t},$L=e=>e===Y.MSG_UNDO,QL=e=>e===Y.MSG_DEL_EVERYONE,YL=e=>(e=>e===Y.MSG_FAIL)(e)||(e=>e===Y.MSG_LOCAL)(e);let JL=function(e){return e.DEFAULT="default",e.STICKER="sticker",e.NEW_FSS_STICKER="new-fss-sticker",e.UNDO="undo",e.DEL_EVERYONE="del-everyone",e}({});const XL=(e,t)=>QL(e.msgType)?JL.DEL_EVERYONE:$L(e.msgType)?JL.UNDO:t?((e,t)=>{var s,a,i;if(!Ce.default.enable_new_fss)return!1;if(null==e||null===(s=e.UIContent)||void 0===s||!s.extInfo)return!1;let n=ZL(null!==(a=null!==(i=e.UIContent.extInfo)&&void 0!==i?i:null==t?void 0:t.fssInfo)&&void 0!==a?a:"");return Boolean(n)&&!((null==e?void 0:e.src)===Y.MSG_SRC.SYNC_MOBILE_DB&&0==(null==n?void 0:n.subtype))})(e,t)?JL.NEW_FSS_STICKER:JL.STICKER:JL.DEFAULT,eD="sticker-message-selectable",tD={Selected:"--selected"},sD=e=>{const{isSelected:t=!1}=e;return Mr.a.createElement(vw,{isSelected:t},Mr.a.createElement("div",{className:Object(PC.a)(eD,t&&tD.Selected,e.className),onClick:s=>{var a;null===(a=e.onSelectClick)||void 0===a||a.call(e,s,t)},onContextMenu:s=>{var a;null===(a=e.onSelectContextMenu)||void 0===a||a.call(e,s,t)}},e.children))},aD=()=>{const e=Object(Or.useRef)(!1);return Object(Or.useEffect)((()=>()=>{e.current=!0}),[]),{unmountedHolder:e}},iD=e=>{var t;const{identity:{id:s,cateId:a}}=e,{unmountedHolder:i}=aD(),[n,r]=Object(Or.useState)((()=>TI.g.getStickerFromCache(a,s)));return Object(Or.useMemo)((()=>{if(!n||n.id!==s||n.cateId!==a){if(n&&(n.id!==s||n.cateId!==a)){const e=TI.g.getStickerFromCache(a,s);if(e)return void r(e)}TI.g.getStickerIfNotExist(a,s).then((e=>{i.current||r(e)}))}}),[s,a]),Mr.a.createElement(Mr.a.Fragment,null,null===(t=e.children)||void 0===t?void 0:t.call(e,n))};var nD=s("dI1f");const rD=e=>{const[t,s]=Object(Or.useState)((()=>Object(nD.d)({msgId:e.msgId,toUid:e.toUid,sendDttm:e.sendDttm})));return Object(Or.useEffect)((()=>{const t=a.ModuleContainer.resolve(nD.a);return t.addUpdateOperationCallback(e.msgId,(function(e){s(e)})),()=>{t.removeUpdateOperationCallback(e.msgId)}}),[e.msgId]),{showOperation:t}},oD=(e,t)=>"0"===e&&(t?"div_LastSentMsg_Sticker":"div_SentMsg_Sticker")||t&&"div_LastReceivedMsg_Sticker"||"div_ReceivedMsg_Sticker",cD=ui.default.isWeb(),lD=!cD&&s("Dprd").default,dD=e=>{const{fssUrl:t,msgId:s,convId:a}=e,[i,n]=Object(Or.useState)(""),r=Object(Or.useRef)("unknown"),{unmountedHolder:o}=aD();return Object(Or.useEffect)((()=>{const e=async()=>{if(!cD&&Ce.default.enable_cache_fss){r.current="downloading";const e=await Object(wi.getZaloDownloadsCacheDir)("g",J.p.getSessionUserId()),i=lD.getCachedFileName(t);tt.default.run({type:tt.default.constants.DownloadType.Photo,data:{url:t,fileName:i,msgId:s,conversationId:a},options:{srcAction:tt.default.constants.srcAction.Dev,saveDir:e,caching:!0}}).then((e=>{o.current||(r.current="downloaded",n(e.savePath?"file://"+e.savePath:t))})).catch((e=>{o.current||(r.current="failed",n(t))}))}else r.current="not-supported",n(t)};"unknown"===r.current&&t&&e()}),[t,s,a]),{preview:i}},uD=e=>e.overlay?Mr.a.createElement("div",{className:"preload-spinner-overlay"},e.children,Mr.a.createElement("div",{className:"preload-spinner-wrapper"},Mr.a.createElement("div",{className:"preload-spinner"}))):Mr.a.createElement(Mr.a.Fragment,null,e.children),hD=e=>{const{showTitle:t=!0,disablePlay:s=!1,content:a,msgInfo:i}=e,n=a.thumb,{preview:r}=dD({msgId:i.msgId,convId:i.convId,fssUrl:a.fssUrl}),[o,c]=Object(Or.useState)(!1);return Mr.a.createElement("div",{className:Object(PC.a)("fullscreen-sticker",e.className)},Mr.a.createElement(uD,{overlay:e.showOverlay},Mr.a.createElement("div",{className:"fullscreen-sticker__content",onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},!r||s||o?Mr.a.createElement("img",{className:"fullscreen-sticker__preview",src:n,onLoad:t=>{"function"==typeof e.onLoadThumb&&e.onLoadThumb(n)},onError:t=>{"function"==typeof e.onLoadThumbError&&e.onLoadThumbError(n)}}):Mr.a.createElement("img",{className:"fullscreen-sticker__preview",src:r,onLoad:t=>{c(!1),"function"==typeof e.onLoadPreview&&e.onLoadPreview(r)},onError:t=>{c(!0),"function"==typeof e.onLoadPreviewError&&e.onLoadPreviewError(r)}}),t&&Mr.a.createElement("div",{className:"fullscreen-sticker__title"},Mr.a.createElement(eE.a,{className:"fullscreen-sticker__icon",icon:"Sticker_24_Line"}),Mr.a.createElement(Rr.a,{textKey:"STR_CLICK_TO_VIEW_2"})))))},gD="fullscreen-sticker-message-content",mD={Block:gD,Modifiers:{NoBorderBottomRadius:"--no-border-bottom-radius"},Elements:{FullscreenSticker:`${gD}__fullscreen-sticker`}},pD=e=>{var t,s,a;const{sticker:i,messageInfo:n}=e,r=null!==(t=n.UIContent.id)&&void 0!==t?t:i.id,o=null!==(s=n.UIContent.cateId)&&void 0!==s?s:i.cateId,{showOperation:c}=rD({msgId:n.msgId,toUid:n.toUid,sendDttm:n.sendDttm}),l=Mr.a.useMemo((()=>{var e,t;return ZL(null!==(e=null!==(t=n.UIContent.extInfo)&&void 0!==t?t:i.fssInfo)&&void 0!==e?e:"")}),[n.UIContent.extInfo,i.fssInfo]);return Mr.a.createElement("div",{"data-id":oD(n.fromUid,null!==(a=n.isLastMsg)&&void 0!==a&&a),className:Object(PC.a)(mD.Block,c&&mD.Modifiers.NoBorderBottomRadius,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},Mr.a.createElement(hD,{className:mD.Elements.FullscreenSticker,showOverlay:!!e.isLoadingFSSToPlay,disablePlay:e.disablePlay,content:{id:r,cateId:o,thumb:l.thumbUrl,fssUrl:i.fss},msgInfo:{msgId:n.msgId,convId:n.toUid}}),c&&Mr.a.createElement(nD.c,{windowId:e.windowId||Ar.c,convId:n.toUid,fromUid:n.fromUid}))};var fD=s("cuiR");const vD=130,_D=80,bD="default-sticker-message-content",ID={Block:bD,Modifiers:{},Elements:{ThumbIcon:`${bD}__thumb-icon`}},yD=e=>{const{size:t=vD,thumbSize:s,thumbPercentage:a=_D}=e,i=Mr.a.useMemo((()=>`${Math.round(null!=s?s:t*a/100)}px`),[t,s,a]);return Mr.a.createElement("div",{className:Object(PC.a)(ID.Block,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu,style:{width:`${t}px`,height:`${t}px`}},Mr.a.createElement(eE.a,{icon:"ThumbSticker_24_Filled",className:ID.Elements.ThumbIcon,style:{fontSize:i,width:i,height:i}}))};var SD=s("+ou9");const CD="normal-sticker-message-content",ED={Block:CD,Modifiers:{},Elements:{Sticker:`${CD}__sticker`}},OD=e=>{var t,s,a,i,n;const{sticker:r,messageInfo:o,disablePlay:c=!1}=e,l=(null!==(t=o.UIContent.id)&&void 0!==t||r.id,null!==(s=o.UIContent.cateId)&&void 0!==s||r.cateId,Object(fL.b)()),d=Mr.a.useMemo((()=>{var e;return void 0!==(null==l||null===(e=l.state)||void 0===e?void 0:e.focusedMessageId)&&l.state.focusedMessageId===o.msgId}),[null==l||null===(a=l.state)||void 0===a?void 0:a.focusedMessageId,o.msgId]),{showOperation:u}=rD({msgId:o.msgId,toUid:o.toUid,sendDttm:o.sendDttm});return Mr.a.createElement("div",{"data-id":oD(o.fromUid,null!==(i=o.isLastMsg)&&void 0!==i&&i),className:Object(PC.a)(ED.Block,e.className,d&&"focused-item focused-item--animation"),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},Mr.a.createElement(SD.a,{key:String(c),className:Object(PC.a)(ED.Elements.Sticker,"sticker-message "),autoStop:!0,sticker:r,thumbSize:vD,stickerView:!0,display:!0,interation:5,fullScreenEffectId:e.isLoadingFSSToPlay,highPriority:!0,autoPlay:!0,isFlip:null!==(n=e.isSentFromMe)&&void 0!==n&&n,disablePlay:c}),u&&Mr.a.createElement(nD.c,{windowId:e.windowId||Ar.c,convId:o.toUid,fromUid:o.fromUid}))};var MD=s("1Luk"),TD=s("5A7B");const RD="sticker-message-content-wrapper",wD=Mr.a.forwardRef((function(e,t){const{sticker:s,data:a,observeIntersectionForReading:i}=e,n=Mr.a.useRef(null);if(Object(cR.a)(n,i),!a)return null;const r=Mr.a.useMemo((()=>XL(a,s)),[a,s]),o=r===JL.NEW_FSS_STICKER,c=YL(a.status),l=Boolean(e.isMultiSel),{handleClick:d,isLoadingFSSToPlay:u}=(e=>{const{unmountedHolder:t}=aD(),[s,a]=Mr.a.useState(!1);return{handleClick:(s,i)=>{if(!s.shiftKey&&!e.isMultiSel){const{message:n,contentType:r}=i,{id:o,cateId:c}=n.UIContent;switch(r){case JL.NEW_FSS_STICKER:case JL.STICKER:case JL.DEFAULT:{const i=(s,i)=>{let n=!1;const r=Re.default.getStickerEffectCache(s,i);return r&&"function"==typeof e.dispatch&&(Object(MD.d)(MD.c.PLAY_SS),e.dispatch({type:ve.PopupActions.TOGGLE_COCOS_SCREEN,payload:{effectId:r},windowId:e.windowId||Ar.c}),TD.a.register("fullscreensticker"+r,(()=>{t.current||a(!1)}),5e3),n=!0,a(!0)),n};i(o,c)||"function"!=typeof e.showStickerSet||(e.showStickerSet({stickerId:o,id:c}),s&&(s.preventDefault(),s.stopPropagation()));break}case JL.DEL_EVERYONE:case JL.UNDO:s&&(s.preventDefault(),s.stopPropagation())}}},isLoadingFSSToPlay:s}})(e),{handleToggleSelection:h}=(e=>({handleToggleSelection:(t,s)=>{const{isMultiSel:a=!1}=e,{message:i}=s;t.shiftKey||a&&(e.isMouseMoveSelecting||(e.selectMessage(t,i),t.preventDefault(),t.stopPropagation()))}}))(e),g=t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:a};e.showContextMenu(s)},m={onClick:e=>{const t={message:a,contentType:r};l?h(e,t):d(e,t)},onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onContextMenu:g};return Mr.a.createElement("div",{ref:e=>{n.current=e,null==t||t(e)},className:Object(PC.a)(RD,e.className),"data-component":Y.DataAttributes.Component.STICKER,"data-qId":Object(fe.g)(a),onClickCapture:e.onClickCapture,onContextMenuCapture:e.onContextMenuCapture},Mr.a.createElement(fw.a,{type:o?l?void 0:"side":"overlay",msgStatus:a.status,sendDttm:a.sendDttm,onRetryContextMenu:g,onSendingContextMenu:g,onRetryClick:t=>{var s;t.preventDefault(),t.stopPropagation(),null===(s=e.resendMessage)||void 0===s||s.call(e,t,a)}},Mr.a.createElement(sD,{isSelected:e.isSelected,onSelectClick:e=>{h(e,{message:a,contentType:r})},onSelectContextMenu:t=>{if("function"!=typeof e.showContextMenu)return;const s={event:t,message:a};e.showContextMenu(s)}},(()=>{switch(r){case JL.STICKER:return Mr.a.createElement(OD,Object(gC.a)({windowId:e.windowId,isLoadingFSSToPlay:u,disablePlay:c,sticker:s,messageInfo:{msgId:a.msgId,fromUid:a.fromUid,toUid:a.toUid,cliMsgId:a.cliMsgId,UIContent:a.UIContent,isLastMsg:a.isLastMsg}},m));case JL.NEW_FSS_STICKER:return Mr.a.createElement(pD,Object(gC.a)({windowId:e.windowId,isLoadingFSSToPlay:u,disablePlay:c,sticker:s,messageInfo:{cliMsgId:a.cliMsgId,msgId:a.msgId,toUid:a.toUid,UIContent:a.UIContent,fromUid:a.fromUid,sendDttm:a.sendDttm,isLastMsg:a.isLastMsg}},m));case JL.UNDO:case JL.DEL_EVERYONE:return Mr.a.createElement(fD.a,Object(gC.a)({messageInfo:{msgId:a.msgId,msgType:a.msgType,cliMsgId:a.cliMsgId,fromUid:a.fromUid,toUid:a.toUid}},m));case JL.DEFAULT:default:return Mr.a.createElement(yD,Object(gC.a)({thumbPercentage:80,messageInfo:{msgId:a.msgId,fromUid:a.fromUid,toUid:a.toUid,cliMsgId:a.cliMsgId}},m))}})())))}));var LD=Mr.a.forwardRef(((e,t)=>{const s=e.data.UIContent.id,a=e.data.UIContent.cateId;return Mr.a.createElement(iD,{identity:{id:s,cateId:a}},(s=>Mr.a.createElement(wD,Object(gC.a)({ref:t},e,{sticker:s}))))}));const DD={Block:"core-image",Modifiers:{NonSelectable:"--non-selectable",NonDraggable:"--non-draggable"}},AD=e=>{const{width:t,height:s,draggable:a=!1,selectable:i=!1}=e,n=a?{draggable:!0}:{draggable:!1,onDragStart:e=>{a||(e.preventDefault(),e.stopPropagation())}};return Mr.a.createElement("img",Object(gC.a)({className:Object(PC.a)(e.className,DD.Block,!a&&DD.Modifiers.NonDraggable,!i&&DD.Modifiers.NonSelectable),alt:"",src:e.src,width:t,height:s,onLoad:e.onLoad,onError:e.onError},n))},FD="loading-image",kD={Block:FD,Modifiers:{Loading:"--loading"},Elements:{DefaultThumb:`${FD}__default-thumb`,EmbededImage:`${FD}__embeded-image`}},ND=80,PD=e=>{const{useDefaultThumb:t=!0,initialLoading:s=!0,draggable:a=!1,selectable:i=!1,width:n=0,height:r=0,MaxDefaultThumbSize:o,MaxDefaultThumbPercentage:c=ND}=e,[l,d]=Mr.a.useState(s),u=o,h=c;return Mr.a.createElement("div",{className:Object(PC.a)(kD.Block,l&&kD.Modifiers.Loading,e.className)},t&&l&&Mr.a.createElement(yD,{className:kD.Elements.DefaultThumb,messageInfo:e.messageInfo,thumbPercentage:h,thumbSize:u}),Mr.a.createElement(AD,{className:Object(PC.a)(kD.Elements.EmbededImage),src:e.src,height:r,width:n,draggable:a,selectable:i,onLoad:t=>{var s;l&&d(!1),null===(s=e.onLoad)||void 0===s||s.call(e,t)},onError:t=>{var s;null===(s=e.onError)||void 0===s||s.call(e,t)}}))};var jD=s("aKpv");const UD=$_.a.Constant.DisplayModeProps,BD="Preview",zD="Play",GD=function(e,t){e===BD?t(zD):e===zD&&t(BD)},xD=function(e,t){e&&GD(BD,t)},VD=function(e,t,s,a,i){e&&$_.a.Helper.parseInt(s)&&(i.current&&clearTimeout(i.current),i.current=setTimeout((()=>{a.current=!1,function(e,t){e&&GD(zD,t)}(e,t),i.current&&clearTimeout(i.current),i.current=null}),s))},HD="photo-sticker",WD={Block:HD,Elements:{PreviewImage:`${HD}__preview-image`,PlayImage:`${HD}__play-image`}};function qD(e){const{data:t,width:s=0,height:a=0,mode:i=UD.PLAY_FIRST,useDefaultThumb:n=!0,onlyLoadLocal:r=!1,animationDuration:o=5e3,draggable:c=!1,selectable:l=!1}=e,[d,u]=function(e){return e===UD.PREVIEW_ONLY?[BD,!1]:e===UD.PLAY_ONLY?[zD,!1]:e===UD.PREVIEW_FIRST?[BD,!0]:e===UD.PLAY_FIRST?[zD,!0]:[BD,!1]}(i),[h,g]=Object(Or.useState)(d),m=Object(Or.useRef)(!0),p=Object(Or.useRef)(!1),f=Object(Or.useRef)(null),v=$_.a.Helper.getStickerThumbUrl(t,{onlyUseLocal:r,usingFileProtocol:!0}),_=$_.a.Helper.getStickerUrl(t,{onlyUseLocal:r,usingFileProtocol:!0}),b=e=>{e&&(xD(u,g),!p.current&&VD(u,g,o,m,f))};return Mr.a.createElement("div",{id:"pSticker_"+t.id,key:"pSticker_"+t.id,className:Object(PC.a)(WD.Block,e.className),draggable:c,style:{width:s,height:a},onClick:t=>{var s;null===(s=e.onClick)||void 0===s||s.call(e,t)},onDoubleClick:t=>{var s;null===(s=e.onDoubleClick)||void 0===s||s.call(e,t)},onContextMenu:t=>{var s;null===(s=e.onContextMenu)||void 0===s||s.call(e,t)},onMouseEnter:()=>{m.current=!0,p.current=!0,xD(u,g)},onMouseOut:()=>{p.current=!1,VD(u,g,o,m,f)}},h===BD?Mr.a.createElement(PD,{className:WD.Elements.PreviewImage,messageInfo:e.messageInfo,useDefaultThumb:n,MaxDefaultThumbPercentage:e.MaxDefaultThumbPercentage,initialLoading:!t.localPreview,src:ui.default.transformLocalUrl(v),width:s,height:a,draggable:c,selectable:l,onLoad:()=>{b(i===UD.PLAY_FIRST&&m.current)}}):Mr.a.createElement(PD,{className:WD.Elements.PlayImage,messageInfo:e.messageInfo,useDefaultThumb:n,MaxDefaultThumbPercentage:e.MaxDefaultThumbPercentage,initialLoading:!t.localUrl,src:ui.default.transformLocalUrl(_),width:s,height:a,selectable:l,draggable:c,onLoad:()=>{b(i===UD.PLAY_FIRST&&m.current)}}),Mr.a.createElement(jD.b,{message:e.messageInfo,devSrc:"PhotoSticker",visible:!1}))}const KD=e=>{const[,t]=Mr.a.useState(0),{data:s}=e,a=$_.a.Cache.FileToPath,i=a.getPathById(s.id,s.url),n=a.getPathById(s.id,s.pngUrl),r=a.getPathById(s.id,s.previewUrl);return i&&(s.localUrl=i),n&&(s.localPng=n),r&&(s.localPreview=r),Mr.a.useEffect((()=>{$_.a.Helper.runDownload(s,(()=>t((e=>1^e))))}),[s.id,s.url,s.pngUrl,s.previewUrl]),Mr.a.createElement(qD,Object(gC.a)({},e,{data:s}))},ZD="photo-sticker-message-content",$D={Block:ZD,Elements:{PhotoSticker:`${ZD}__photo-sticker`}},QD=(e,t)=>{const{data:s,observeIntersectionForReading:a}=e,i=Mr.a.useRef(null);Object(cR.a)(i,a);const n=Mr.a.useMemo((()=>$_.a.Helper.convertMessageToPhotoStickerData(s)),[s]),r=Mr.a.useMemo((()=>{const[e,t]=$_.a.Helper.getRenderedPhotoStickerSizeAtChatList(n.width,n.height),[s,a]=$_.a.Config.getRenderedMessageSize();return{photoSticker:{width:e,height:t},message:{width:s,height:a}}}),[n.width,n.height]),o=t=>{"function"==typeof e.showContextMenu&&(t.stopPropagation(),t.preventDefault(),e.showContextMenu({event:t,message:s}))},c=$_.a.Constant.DisplayModeProps.PLAY_FIRST,l=$_.a.Config.getMessageAnimationDuration();return Mr.a.createElement(fw.a,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryContextMenu:o,onSendingContextMenu:o,onRetryClick:t=>{var a;t.preventDefault(),t.stopPropagation(),null===(a=e.resendMessage)||void 0===a||a.call(e,t,s)}},Mr.a.createElement(sD,{isSelected:e.isSelected},Mr.a.createElement("div",{id:Y.UIMessagePrefixElementID.PhotoStickerMessage+Object(fe.j)(s),ref:e=>{i.current=e,null==t||t(e)},className:Object(PC.a)($D.Block,e.className),"data-component":Y.DataAttributes.Component.PHOTO_STICKER,"data-qId":Object(fe.g)(s),style:Object(I.a)({},r.message),onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onClickCapture:t=>{var a;null==e||null===(a=e.onClickCapture)||void 0===a||a.call(e,t,s)},onContextMenu:o,onContextMenuCapture:e.onContextMenuCapture},Mr.a.createElement(KD,{mode:c,messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,sendDttm:s.sendDttm},className:$D.Elements.PhotoSticker,width:r.photoSticker.width,height:r.photoSticker.height,data:n,MaxDefaultThumbPercentage:_D,animationDuration:l,onlyLoadLocal:!0}))))},YD=Mr.a.forwardRef(QD),JD="no-border-photo-sticker-message-content",XD={Block:JD,Modifiers:{},Elements:{ImageContainer:`${JD}__image-container`,Image:`${JD}__image`}},eA=e=>{var t,s;const{fromUid:a,toUid:i,cliMsgId:n,UIContent:r,msgId:o}=e.messageInfo,c=null!==(t=r.parsedParams.width)&&void 0!==t?t:0,l=null!==(s=r.parsedParams.height)&&void 0!==s?s:0,d=`${n}::${a}::${i}`,u=ui.default.removeProtocol(r.oriUrl),h=Mr.a.useMemo((()=>{const[e,t]=$_.a.Helper.getRenderedPhotoStickerSizeAtChatList(c,l),[s,a]=$_.a.Config.getRenderedMessageSize();return{photoSticker:{width:e,height:t},message:{width:s,height:a}}}),[c,l]);return Mr.a.createElement("div",{className:Object(PC.a)(XD.Block,e.className),style:h.message,onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},Mr.a.createElement("div",{className:XD.Elements.ImageContainer,style:h.photoSticker},Mr.a.createElement(pw.a,{className:XD.Elements.Image,mediaId:d,mediaSize:h.photoSticker,urls:Object(mw.a)([u]),loadStrategy:{type:"Instant"},entry:"MESSAGE_LIST",preloadStrategy:"Async",renderPlaceholder:()=>Mr.a.createElement(yD,{thumbPercentage:80,messageInfo:{msgId:o,fromUid:a,toUid:i,cliMsgId:n}}),renderError:()=>Mr.a.createElement(yD,{thumbPercentage:80,messageInfo:{msgId:o,fromUid:a,toUid:i,cliMsgId:n}})}),Mr.a.createElement(jD.b,{message:e.messageInfo,visible:!1,devSrc:"NoBorderPhotoStickerMessageContent"})))};class tA{static getInstance(){return tA.instance_||(tA.instance_=new tA),tA.instance_}constructor(){if(this.trackingData_=new u.default({maxSize:1e3}),this._LogThreshold_=1,tA.instance_)return tA.instance_;tA.instance_=this}onNoBorderStickerDisplayedAtWhere(e){if(!e)return;const t=this.getTrackingId_(e);if(!t)return;const s=this.updateTrackingData_(t);this.submitLogIfNeeded_({id:t,count:s,where:e.where})}getTrackingId_(e){if(e.id&&e.where)return`[${e.where}]:${e.id}`}updateTrackingData_(e){let t=this.trackingData_.get(e);return t=null==t?1:t+1,this.trackingData_.set(e,t),t}submitLogIfNeeded_(e){this.shouldSubmitLog_(e)&&this.$ubmitLog_()}shouldSubmitLog_(e){return!!(e&&e.id&&e.where)&&e.count===this._LogThreshold_}$ubmitLog_(){Ia.default.logAction(107150334)}}tA.instance_=void 0;const sA="no-border-photo-sticker-message-content-wrapper",aA=Mr.a.forwardRef(((e,t)=>{const{data:s,observeIntersectionForReading:a}=e,i=Mr.a.useRef(null);Object(cR.a)(i,a);var n;return n={msgId:s.msgId},Object(Or.useEffect)((()=>{tA.getInstance().onNoBorderStickerDisplayedAtWhere({id:n.msgId,where:"csc"})}),[]),Mr.a.createElement("div",{ref:e=>{i.current=e,null==t||t(e)},className:Object(PC.a)(sA),"data-component":Y.DataAttributes.Component.PHOTO_STICKER,"data-qId":Object(fe.g)(s),onClickCapture:e.onClickCapture,onContextMenuCapture:e.onContextMenuCapture},Mr.a.createElement(fw.a,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryClick:t=>{var a;t.preventDefault(),t.stopPropagation(),null===(a=e.resendMessage)||void 0===a||a.call(e,t,s)}},Mr.a.createElement(sD,{isSelected:e.isSelected},Mr.a.createElement(eA,{onContextMenu:t=>{"function"==typeof e.showContextMenu&&(t.stopPropagation(),t.preventDefault(),e.showContextMenu({event:t,message:s}))},messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,ttl:s.ttl,localPath:s.localPath,UIContent:s.UIContent,isLastMsg:s.UIIsLastInList,sendDttm:s.sendDttm}}))))}));var iA=s("gXIT"),nA=s("05R2");const rA="ai-sticker-message-content",oA={Block:rA,Modifiers:{Audit:"--audit"},Elements:{Sticker:`${rA}__sticker`,Badge:`${rA}__badge`}},cA=e=>{const[t,s]=Mr.a.useState(!1),a=e.sticker.thumb||"",i=e.sticker.url;return Mr.a.createElement("div",{className:Object(PC.a)(oA.Block,oA.Modifiers.Audit,e.className),onClick:e.onClick,onDoubleClick:e.onDoubleClick,onContextMenu:e.onContextMenu},Mr.a.createElement(iA.a,{thumb:a,src:i,className:oA.Elements.Sticker,width:e.sticker.renderedWidth,height:e.sticker.renderedHeight,thumbPercentage:80,draggable:e.draggable,selectable:e.selectable,onLoad:(e,t,a)=>{s("src"===t)}}),Object(V_.$AIStickerConfiguration)().isEnable("AIStickerMessage")&&t&&Mr.a.createElement(nA.a,{className:oA.Elements.Badge}),Mr.a.createElement(jD.b,{message:e.messageInfo,devSrc:"AIStickerMessageContent#2",visible:!1}))};let lA=function(e){return e.STICKER="sticker",e.UNDO="undo",e.DEL_EVERYONE="del-everyone",e}({});const dA="ai-sticker-message-content-wrapper",uA=(e,t)=>{const{data:s,observeIntersectionForReading:i}=e,n=(e=>e.msgType===Y.MSG_UNDO?lA.UNDO:e.msgType===Y.MSG_DEL_EVERYONE?lA.DEL_EVERYONE:lA.STICKER)(s),r=Mr.a.useRef(null);Object(cR.a)(r,i);const o=Mr.a.useMemo((()=>a.ModuleContainer.resolve(V_.TAIStickerAppService).transformFromAIStickerMessage(s)),[s]),c=t=>{"function"==typeof e.showContextMenu&&(t.preventDefault(),t.stopPropagation(),e.showContextMenu({event:t,message:s}))};return Mr.a.createElement("div",{ref:e=>{r.current=e,null==t||t(e)},className:Object(PC.a)(dA,e.className),"data-component":Y.DataAttributes.Component.STICKER,"data-qId":Object(fe.g)(s),onClick:e=>{},onClickCapture:e.onClickCapture,onContextMenu:c,onContextMenuCapture:e.onContextMenuCapture,onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()}},Mr.a.createElement(fw.a,{type:"overlay",msgStatus:s.status,sendDttm:s.sendDttm,onRetryContextMenu:c,onSendingContextMenu:c,onRetryClick:t=>{var a;t.preventDefault(),t.stopPropagation(),null===(a=e.resendMessage)||void 0===a||a.call(e,t,s)}},Mr.a.createElement(sD,{isSelected:e.isSelected},(()=>{switch(n){case lA.STICKER:return Mr.a.createElement(cA,{messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId,UIContent:s.UIContent,isLastMsg:s.isLastMsg,ttl:s.ttl,sendDttm:s.sendDttm},sticker:o,draggable:!1,selectable:!1});case lA.UNDO:case lA.DEL_EVERYONE:return Mr.a.createElement(fD.a,{messageInfo:{msgId:s.msgId,msgType:s.msgType,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId}});default:return Mr.a.createElement(yD,{thumbPercentage:80,messageInfo:{msgId:s.msgId,fromUid:s.fromUid,toUid:s.toUid,cliMsgId:s.cliMsgId}})}})())))},hA=Mr.a.forwardRef(uA);var gA=s("NWd+"),mA=s("VeD8");const pA=Object.values||(e=>Object.keys(e).map((t=>e[t])));function fA(e){return(Array.isArray||(e=>"[object Array]"===Object.prototype.toString.call(e)))(e)}class vA extends mA.a{constructor(e,t){super(e,t),this.isMounted_=!1}static getDerivedStateFromProps(e,t){return mA.a.getDerivedStateFromProps(e,t)}render(){return super.render()}componentDidMount(){super.componentDidMount(),this.isMounted_=!0}DEFAULT_checkShouldRunUpdateState(e,t,s){const{prevChildren:a,nextChildren:i}=s;return n=pA(a).map((e=>e.key)),r=pA(i).map((e=>e.key)),!(fA(n)&&fA(r)&&(n===r||n.length===r.length&&n.every(((e,t)=>e===r[t]))));var n,r}enableUpdateState_(e,t){const s={prevProps:e,nextProps:this.props},a={prevState:t,nextState:this.state},i={prevChildren:t.children,nextChildren:this.state.children};return(!0===this.props.update?this.DEFAULT_checkShouldRunUpdateState:"function"==typeof this.props.update?this.props.update:()=>!1)(s,a,i)}getSnapshotBeforeUpdate(e,t){if(this.enableUpdateState_(e,t)){return pA(t.children).reduce(((e,t)=>{var s;const a=null===(s=t.props.nodeRef)||void 0===s?void 0:s.current;if(a){var i;const s=a.getBoundingClientRect(),n=t.key,r={reactKey:n,clientRect:s};e[n]=r,(null!==(i=t.props.onUpdateFlipMove)&&void 0!==i?i:function(){})(n,a,s)}return e}),{})}return null}componentDidUpdate(e,t,s){if(this.enableUpdateState_(e,t)){const e=pA(this.state.children).reduce(((e,t)=>{var s;const a=null===(s=t.props.nodeRef)||void 0===s?void 0:s.current;if(a){const s=a.getBoundingClientRect(),i=t.key,n={reactKey:i,clientRect:s};e[i]=n}return e}),{}),t=pA(s).reduce(((t,s)=>{const{reactKey:a}=s,i=e[a];return i&&(t[a]={prev:s,next:i}),t}),{});pA(t).forEach((({prev:e,next:t})=>{let[s,a]=[t.clientRect.x-e.clientRect.x,t.clientRect.y-e.clientRect.y];if([s,a].some((e=>Math.abs(e)>0))){var i;const e=this.state.children[t.reactKey],r=null==e||null===(i=e.props.nodeRef)||void 0===i?void 0:i.current;if(r){var n;(null!==(n=e.props.onUpdatingFlipMove)&&void 0!==n?n:function(){})(e.key,r,t.clientRect);const i=r.animate([{transform:`translate(${-s}px, ${-a}px)`},{transform:"none"}],{duration:300,easing:"cubic-bezier(.29,.91,.52,1)"});i.onfinish=()=>{var e;if(!this.isMounted_)return;const s=this.state.children[t.reactKey],a=null==s||null===(e=s.props.nodeRef)||void 0===e?void 0:e.current;var n;a&&(null!==(n=s.props.onUpdatedFlipMove)&&void 0!==n?n:function(){})(s.key,a,t.clientRect);i.cancel()}}}}))}}componentWillUnmount(){this.isMounted_=!1}}BC.d;var _A=s("pQ8y");class bA extends _A.a{}const IA=["className","children","nodeRef"],yA="burrow-up-transition",SA=e=>{const{className:t,children:s,nodeRef:a=Mr.a.useRef(null)}=e,i=Object($i.a)(e,IA);return Mr.a.createElement(bA,Object(gC.a)({},i,{nodeRef:a,classNames:yA,unmountOnExit:!0,addEndListener:e=>{var t;null===(t=a.current)||void 0===t||t.addEventListener("transitionend",e,!1)}}),Mr.a.createElement("div",{ref:a,className:Object(PC.a)(yA,t)},s))};class CA extends vA{static getDerivedStateFromProps(e,t){const s=t.firstRender;let a=vA.getDerivedStateFromProps(e,t);if(s){const t=pA(a.children).reduce(((e,t)=>(t.props.in&&(e[t.key]=t),e)),Object.create(null));if(Object.keys(t).length>=2){let s=null;Mr.a.Children.map(e.children,(e=>e)).forEach(((e,a)=>{t[e.key]&&(!s||s.index<a)&&(s={index:a,child:e})})),pA(t).forEach((e=>{s&&e.key===s.child.key||(a.children[e.key]=Mr.a.cloneElement(e,{appear:!1,enter:!1}))}))}}return a}componentDidMount(){super.componentDidMount()}}const EA=["className","items","children","component"],OA="animated-sticker-group-message",MA=e=>{const{className:t,items:s,children:a,component:i="div"}=e,n=Object($i.a)(e,EA),r=Mr.a.useMemo((()=>s.map((e=>({nodeRef:Mr.a.createRef(),item:e})))),[s]);return Mr.a.createElement(CA,Object(gC.a)({className:Object(PC.a)(OA,t),component:i},n),r.map((({item:e,nodeRef:t})=>Mr.a.createElement(SA,{key:e.cliMsgId,nodeRef:t},a(e)))))};var TA=s("Hi8h");const RA=e=>{var t,s;const{data:a}=e,i=null!==(t=a.UIContent)&&void 0!==t?t:[],n=i.map((e=>({fromUid:e.fromUid,toUid:e.toUid,cliMsgId:e.cliMsgId}))),r=Boolean(a.UIIsLastInList),o=Mr.a.useMemo((()=>{const e=a.toUid,t=Object(gA.a)(),s=t.getASetOfJustAddedMessage(e);return void 0!==n.find((e=>{var a;const i=t.buildJustAddedMessageStateKey({fromUid:e.fromUid,toUid:e.toUid,cliMsgId:e.cliMsgId}),n=null===(a=s[i])||void 0===a?void 0:a.src,r=["just-sent","just-received"].includes(n);return r&&t.removeJustAddedMessage(i,!1),r}))}),[r,n.map((e=>e.cliMsgId)).join("_")]),c=Boolean(Object(TA.b)().enable),l=null!==(s=e.component)&&void 0!==s?s:"div";return Mr.a.createElement(Mr.a.StrictMode,null,r&&c?Mr.a.createElement(MA,{component:l,appear:o,enter:o,update:o,exit:!1,className:e.className,items:i,children:e.children}):Mr.a.createElement(l,{className:e.className},i.map((t=>e.children(t)))))};var wA=s("ptyt");function LA(e){const t=Object(Or.useRef)(e||null),s=()=>(t.current||(t.current=new Map),t.current),a=(e,t)=>{s().has(e)||s().set(e,t)},i=e=>{s().delete(e)};return{getItemRefList:s,addItemRefToList:a,removeItemRefFromList:i,clearAllItemRefFromList:()=>{s().clear()},getItemRefFromList:e=>s().get(e),updateItemRefInList:(e,t)=>{t?a(e,t):i(e)}}}var DA=s("ynGT");const AA=e=>{const{noVisible:t=!1}=e;return Mr.a.createElement("div",{className:Object(PC.a)("download-entry-point",t&&"--no-visible",e.className),title:ce.a.str("STR_DOWNLOAD_STICKER"),onClick:e.onDownloadClick,onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()}},Mr.a.createElement(eE.a,{icon:"Download-bold_24_Filled",className:"download-entry-point__download-icon"}))};function FA(e){if(!function(e){const t=Boolean(e&&e.msgType===Y.MSG_STICKER_GROUP&&e.message&&1===e.message.length);if(!t)return t;const s=e.message[0];return Boolean(s&&(s.msgType===Y.MSG_STICKER||s.msgType===Y.MSG_STICKER_2))}(e))return null;const t=e.message[0];return{id:t.message.id,catId:t.message.catId}}function kA(e,t){return new Promise(((s,a)=>{var i;if(!e)return s(!1);if(null==t||null===(i=t.signal)||void 0===i?void 0:i.aborted)return a("Aborted");TI.g.getDownloadedCateIds().then((i=>{var n;return(null==t||null===(n=t.signal)||void 0===n?void 0:n.aborted)?a("Aborted"):i&&i.length&&-1!==i.indexOf(e)?s(!1):void TI.g.getStickerCategoriesV2().then((i=>{var n;if(null==t||null===(n=t.signal)||void 0===n?void 0:n.aborted)return a("Aborted");let r=!1;return i&&i.length&&(r=i.some((t=>t&&t.id===e&&![DA.g.OFF].includes(t.is_hidden)))),s(r)})).catch(a)})).catch(a)}))}const NA=e=>{const{stickerGroupMessage:t}=e,s=FA(t),[a,i]=Mr.a.useState(!1);Mr.a.useEffect((()=>{let e=null,t=null;const a=null==s?void 0:s.catId;return a?(e=new AbortController,kA(a,{signal:e.signal}).then((t=>{var s;null!==(s=e)&&void 0!==s&&s.signal.aborted||i(t)})).catch((e=>{zconsole.zsymb(21,"gMPuxi",["[checkCanDownloadStickerCateOrNot] error: {}","RWt_Xp"],null==e?void 0:e.message)})),t=t=>{const s=-1===t.findIndex((e=>e===a));i(!!s&&(t=>{var s;t||(null===(s=e)||void 0===s||s.abort(),e=new AbortController,kA(a,{signal:e.signal}).then((t=>{var s;null!==(s=e)&&void 0!==s&&s.signal.aborted||i(t)})).catch((e=>{zconsole.zsymb(21,"GqOWex",["[checkCanDownloadStickerCateOrNot] error: {}","RWt_Xp"],null==e?void 0:e.message)})));return t}))},TI.g.addPersonalStickerListener(t)):i(!1),()=>{e&&e.abort(),t&&TI.g.removePersonalStickerListener(t)}}),[null==s?void 0:s.catId]);const n=!s||!s.catId,r="0"==t.fromUid,o=Boolean(e.isMultiSel),c=r?"left":"right",l=!n&&a;return Mr.a.createElement("div",{className:Object(PC.a)("sticker-message-downloadable","left"===c?"--left-side":"--right-side")},l&&Mr.a.createElement(AA,{noVisible:o,onDownloadClick:t=>{s&&"function"==typeof e.showStickerSet&&(t.preventDefault(),t.stopPropagation(),e.showStickerSet({id:s.catId}))}}),e.children)},PA={Block:"sticker-group-message",Modifiers:{SentFromMe:"--from-me"},Elements:{}},jA=Mr.a.forwardRef(((e,t)=>{const{data:s,MessageQuickActionRenderer:a}=e,i="0"==s.fromUid,{isSelectedStickerMessage:n}=(e=>({isSelectedStickerMessage:t=>Boolean(e.isMultiSel&&e.selectedMsg&&e.selectedMsg[t])}))(e),{isFocusedStickerMessage:r}=(e=>({isFocusedStickerMessage:t=>{var s;return!(null===(s=e.focusId)||void 0===s||!s.length)&&e.focusId.includes(t)}}))(e),{bindStickerMessageItemRefs:o}=(e=>{const{getItemRefList:t,updateItemRefInList:s}=LA();return Object(Or.useEffect)((()=>{var s;const a={ids:[],elements:[]};var i;null===(s=e.focusId)||void 0===s||s.forEach((e=>{const s=t().get(e);s&&(a.ids.push(e),a.elements.push({ele:s,ref:null}))})),a.ids.length>0&&(null===(i=e.focusHandler)||void 0===i||i.call(e,a.ids,a.elements,null,!0))}),[e.focusId]),{bindStickerMessageItemRefs:s}})(e),{bindStickerMessageItemRefs:c}=(e=>{const{windowId:t}=Object(QC.a)(),s=(t,s)=>{"function"==typeof e.onSeeMsg&&e.onSeeMsg(s),s&&e.newMsgIds&&e.newMsgIds.length>0&&e.newMsgIds.includes(s)&&"function"==typeof e.clearLatestMessageAction&&e.clearLatestMessageAction();const a=wA.a.getLastSavedPosition(t);if(a){const{msgId:e}=a;e===s&&wA.a.clearSavedPosition(t)}},{getItemRefList:a,updateItemRefInList:i}=LA();return Mr.a.useEffect((()=>{const e=a();for(let[a,i]of Array.from(e)){const e=Ap.a.getInViewController(t);null==e||e.observe(i,{identifier:a,onIntersect:(...e)=>s("",a),threshold:.9})}return()=>{for(let[s,a]of Array.from(e)){const e=Ap.a.getInViewController(t);null==e||e.unobserve(a)}}}),[e.data,t]),{bindStickerMessageItemRefs:i}})(e);(e=>{Mr.a.useEffect((()=>()=>{var t;const s=e.data;s&&(null===(t=s.UIContent)||void 0===t||t.forEach((e=>{JM.a.clearGroupId(e.msgId)})))}),[])})(e);const l=(e,t)=>{Object(FL.b)(t,FL.a.LEFT_CLICK_BUBBLE_MESSAGE)},d=(e,t)=>{Object(FL.b)(t,FL.a.RIGHT_CLICK_BUBBLE_MESSAGE)};return Mr.a.createElement("div",{ref:t,className:"sticker-group-message-wrapper"},Mr.a.createElement(RA,{component:"div",className:Object(PC.a)(PA.Block,i&&PA.Modifiers.SentFromMe,e.className),data:s},(t=>{const a=n(t.msgId),i=r(t.msgId);switch(t.UIType){case hT.e.PhotoSticker:return Mr.a.createElement(YD,Object(gC.a)({key:t.cliMsgId},e,{ref:e=>{o(t.msgId,e),c(t.msgId,e)},onClickCapture:e=>l(0,t),onContextMenuCapture:e=>d(0,t),isSelected:a,isFocused:i,data:t}));case hT.e.NoBorderPhotoSticker:return Mr.a.createElement(aA,Object(gC.a)({},e,{ref:e=>{o(t.msgId,e),c(t.msgId,e)},onClickCapture:e=>l(0,t),onContextMenuCapture:e=>d(0,t),isSelected:a,isFocused:i,data:t}));case hT.e.AISticker:return Mr.a.createElement(hA,Object(gC.a)({key:t.cliMsgId},e,{ref:e=>{o(t.msgId,e),c(t.msgId,e)},onClickCapture:e=>l(0,t),onContextMenuCapture:e=>d(0,t),isSelected:a,isFocused:i,data:t}));case hT.e.Sticker:return Mr.a.createElement(NA,{stickerGroupMessage:s,isMultiSel:e.isMultiSel,showStickerSet:e.showStickerSet},Mr.a.createElement(LD,Object(gC.a)({key:t.cliMsgId,ref:e=>{o(t.msgId,e),c(t.msgId,e)}},e,{onClickCapture:e=>l(0,t),onContextMenuCapture:e=>d(0,t),windowId:e.windowId||Ar.c,isSelected:a,isFocused:i,data:t})))}})),a&&Mr.a.createElement(a,null))})),UA=e=>{const{data:t}=e,a="0"==t.fromUid;return Mr.a.createElement("div",{className:Object(PC.a)("sticker-set-message",e.className),onClick:()=>{var e;const a=null===(e=s("k+R1"))||void 0===e?void 0:e.default;if(a){var i;const e=t.toUid,s=a.getChatBoxControllerByConvId(e);null==s||null===(i=s._showStickerSet)||void 0===i||i.call(s,{id:t.UIContent.parsedParams.id})}},onDoubleClick:e=>{e.preventDefault(),e.stopPropagation()},onContextMenu:s=>{if("function"!=typeof e.showContextMenu)return;const a={event:s,message:t};e.showContextMenu(a)}},Mr.a.createElement("div",{className:"sticker-set-message__content"},Mr.a.createElement("div",{title:ce.a.str("STR_STICKER_SET"),className:"sticker-set-message__thumb",style:{backgroundImage:`url(${ui.default.removeProtocol(t.UIContent.thumb)})`}}),Mr.a.createElement("div",{className:"sticker-set-message__info"},Mr.a.createElement(Rr.a,{textKey:"STR_STICKER_SET",tagName:"span",className:"sticker-set-message__title"}),Mr.a.createElement("span",{className:"sticker-set-message__name"},t.UIContent.title))),!a&&Mr.a.createElement(Mr.a.Fragment,null,Mr.a.createElement("div",{className:"sticker-set-message__separator"}),Mr.a.createElement("div",{className:"sticker-set-message__downloadable"},Mr.a.createElement(eE.a,{icon:"Download_24_Line",className:"sticker-set-message__download-icon mr-4"}),Mr.a.createElement(Rr.a,{textKey:"STR_FREE_DOWNLOAD_STICKER_SET",tagName:"span",className:"sticker-set-message__download-title"}))))};var BA=e=>{var t;const{data:s,isFocused:a,observeIntersectionForReading:i}=e,n="0"==s.fromUid,r=Mr.a.useRef(null);Object(cR.a)(r,i);const o=Object(nc.l)(pu.b,null===(t=e.conversation)||void 0===t?void 0:t.userId,(e=>{var t;return null!==(t=null==e?void 0:e.lockSendMsg)&&void 0!==t&&t}));return Mr.a.createElement(lR.a,{border:6,isAdmin:e.isHighlightedByPrivilegedUser,variant:"common",ttl:s.ttl},Mr.a.createElement("div",{ref:r,className:Object(PC.a)("sticker-set-message-wrapper",n&&"--blue",e.isHighlightedByPrivilegedUser&&!s.ttl&&"--highlighted-from-admin",!1,o&&"--none-clickable","shadow-bubble","rounded-6","focused-item",a&&"focused-item--highlight-border"),"data-qId":Object(fe.g)(s)},Mr.a.createElement(UA,e)))},zA=s("mVVk"),GA=s("f08i");var xA=s("Xvtx");const VA=e=>{const[t,s]=Mr.a.useState(null);Mr.a.useEffect((()=>{if(!t)return;if(!e.conversation||!e.conversation.userId)return;if([Y.MSG_LOCAL,Y.MSG_FAIL].includes(e.message.status))return;if(e.message.subType===Y.MSG_SUBTYPE_LINK)return;const s=new AbortController;return((e,t,s={})=>new Promise(((i,n)=>{const{signal:r}=s,o=e=>{null!=r&&r.aborted||e()};if(r){const e=()=>i({status:"aborted",payload:null});if(r.aborted)return e();r.addEventListener("abort",e)}(e=Object(I.a)({},e)).subType=Y.MSG_SUBTYPE_LINK,Re.default.updateMessage(e.msgId,{subType:e.subType},["subType"],e.toUid).then((()=>{o((()=>{const s=a.ModuleContainer.resolve(we.a),r={newId:`${e.cliMsgId}_${e.fromUid}_${e.toUid}`,oldId:e.msgId};s.isExistedMedia("link",r).then((s=>{o((()=>{if(s)i({status:"success",payload:{updatedMessage:e,linkMediaMessage:null}});else{const s=Object(zA.a)(e,t),a={msgId:e.msgId,userId:e.toUid,message:s.message,sendDttm:e.sendDttm,cliMsgId:e.cliMsgId,fromUid:e.fromUid,type:"link",ttl:e.ttl};GA.a.receiveMediaFromMessage(e.toUid,[],[],[a]),i({status:"success",payload:{updatedMessage:e,linkMediaMessage:s}})}}))})).catch((e=>{zconsole.zsymb(21,"Qe6PbP",["Failed to check existed {} media: {}","UpWVM4"],JSON.stringify(r),null==e?void 0:e.message),n(e)}))}))})).catch((t=>{zconsole.zsymb(21,"m5477H",["Failed to update text {} contains link message: {}","YNPyOV"],e.msgId,null==t?void 0:t.message),n(t)}))})))(e.message,t,{signal:s.signal}).then((t=>{if("success"===t.status&&t.payload){const{updatedMessage:s,linkMediaMessage:a}=t.payload;s&&e.dispatch&&e.dispatch({type:ve.ChatBoxActions.UPDATE_MSG_STATE_LITE,payload:{message:{cliMsgId:s.cliMsgId},attrs:{subType:s.subType},conversation:{userId:e.conversation.userId}}}),a&&_e.default.send(ve.ChatBoxActions.ADD_MESSAGE_LINK,{conversation:e.conversation,conversationId:e.conversation.userId,messages:[a]})}})),()=>s.abort()}),[t,e.conversation,e.message]);return{updateFirstLink:Object(xA.a)((e=>{e&&e!==t&&s(e)}))}};var HA=s("GGl6");const WA="text-message__container",qA={HasStatus:WA+"--has-status"};function KA(e){const{conversationID:t,isSelected:s,message:a,topMember:i}=e,n=a.quote;return null==n?null:(""===n.fromD&&(n.fromD=function(e,t){const s=e.quote||{fromUid:"",ownerId:"",fromD:""};let a=s.fromD;if(!a)return a;const i=s.fromUid||s.ownerId;if(i===J.p.getSessionUserId()){const e=Ii.default.getMiniProfileMe();a=(null==e?void 0:e.dName)||""}else if(Array.isArray(t)){const e=Ii.default.getDName(i);if(e)a=e;else for(let s of t)if(s.id===i){a=s.dName;break}}else a=Ii.default.getDName(i)||"";return a}(a,i)),Mr.a.createElement(DR.MessageQuoteFragment,{conversationID:t,deprecated:{message:a},quote:n,isSelected:s}))}function ZA(e){return void 0===e.urgency||null===e.urgency?null:Mr.a.createElement(DR.MessageUrgencyIndicator,{urgency:e.urgency})}function $A(e){const{contentRenderer:t,message:s}=e,a=Object(OC.a)(),i=Object(WL.a)();return Mr.a.createElement(Mw.a,{windowId:i,message:s,data:s.extra.todoInfo,htmlInner:t,user:{userId:J.p.getSessionUserId()},dispatch:a})}var QA=function(e){const{conversation:t,data:s,isFocusing:a,isMultiSel:i,selectedMsg:n={},topMember:r}=e,o=Boolean(i&&n[s.msgId]),{updateFirstLink:c}=VA({conversation:e.conversation,message:s,dispatch:e.dispatch});if(Object(x_.H)(s))return Mr.a.createElement(HA.a,Object(gC.a)({},e,{data:s,isHighlighted:a,isSelected:o}));const l=Y.UIMessagePrefixElementID.TextMessage+Object(fe.j)(s),d=(null==t?void 0:t.userId)||"",u=Object(Gw.a)(s.UIContent,e,c),h=function(e){const t=[];return e.shouldShowStatus&&t.push(qA.HasStatus),Object(PC.a)(t)}(e),g=function(e,t){return e.extra&&e.extra.todoInfo?"0"===e.extra.fromUid?"div_TskASGD_Msg":"div_TskRECD_Msg":"0"===e.fromUid?t.isLastMsg?"div_LastSentMsg_Text":"div_SentMsg_Text":t.isLastMsg?"div_LastReceivedMsg_Text":"div_ReceivedMsg_Text"}(s,{isLastMsg:!1});let m=null;return s.extra&&s.extra.todoInfo&&(m=Mr.a.createElement($A,{contentRenderer:u,message:s})),Mr.a.createElement("div",{id:l,className:Object(PC.a)(WA,h),"data-id":g},Mr.a.createElement(KA,{conversationID:d,isSelected:o,message:s,topMember:r}),Mr.a.createElement(ZA,{urgency:s.urgency}),m||Mr.a.createElement("div",null,u))};var YA=function(e){e.data;const t=Rr.a;return Mr.a.createElement(t,{className:"undo-message",textKey:"STR_UNDO_MSG"})};var JA=function(e){return e.data,Mr.a.createElement("div",null,"Tin nhắn không hiển thị được")};var XA=(e=!1)=>{const[t,s]=Object(Or.useState)(e);return[t,Object(Or.useCallback)((()=>{s(!0)}),[]),Object(Or.useCallback)((()=>{s(!1)}),[])]};const eF=368;var tF=s("sOq/"),sF=s("8sI6"),aF=s("h9Os");var iF=function(e){const{hasCaption:t=!1,convId:s}=e,a=Mr.a.useMemo((()=>t?{boxShadow:"initial",borderTopLeftRadius:"inherit",borderTopRightRadius:"inherit",borderBottomLeftRadius:0,borderBottomRightRadius:0}:{boxShadow:"initial"}),[t]);return Mr.a.createElement("div",{className:"lqip -error lqip-video-error lqip-video clickable",style:a},Mr.a.createElement(aF.b,{isVideo:!0}))},nF=s("IzMZ"),rF=s("s1dB");const oF="bubble-message-sending-indicator-button",cF={Block:oF,Modifiers:{black:"--black",grey:"--grey",sm:"--sm",md:"--md",lg:"--lg"}};var lF=function(e){const{bg:t="black",size:s="md",ringThick:a}=e,i=Mr.a.useMemo((()=>({size:"sm"===s?16:"md"===s?28:46,baseRingColor:"var(--WA100)",ringColor:"var(--NG70)",ringThick:isNaN(+a)?"sm"===s?2:3:+a})),[s]);return Mr.a.createElement("div",{className:Object(PC.a)(cF.Block,t&&cF.Modifiers[t],s&&cF.Modifiers[s])},Mr.a.createElement(rF.a,Object(gC.a)({},i,{className:`${oF}__loading`})))};var dF=function(e){const{variant:t}=e;let s=null;return"play"===t?s=Mr.a.createElement("div",{className:sF.j},Mr.a.createElement("i",{className:"fa fa-play"})):"loading"===t&&(s=Mr.a.createElement(lF,{size:"md",ringThick:2})),Mr.a.createElement("div",{className:sF.e},s)};var uF=function(e){const{children:t,className:s,isClickable:a,isHoverDeactivated:i,isNoBackgroundColor:n,isSelected:r}=e;return Mr.a.createElement("div",{className:Object(PC.a)(sF.a,r&&sF.b.Selected,a&&sF.b.Clickable,i&&sF.b.HoverDeactivated,s)},t)};function hF(e){return Ee.l||e.localPath?"play":e.isDownloadError?"loading":"play"}var gF=s("eZmn");function mF(e,t){const{className:s,conversation:a,handleDownloadResult:i,message:n,onLoad:r,style:o,thumbUrl:c,userId:l}=e;return Mr.a.createElement(gF.a,{ref:t,className:s,onLoad:r,style:o,src:c,cacheFolderName:"Cache",userId:l,message:n,downloadCallback:i,conversation:a,showPlayButton:!1})}var pF=Mr.a.forwardRef(mF);const fF=Mr.a.forwardRef((function(e,t){var s,a;const{clickVideo:i,contentSize:n,conversation:r,data:o,handleDownloadResult:c,isDownloadError:l,isExpired:d,isMultiSel:u,isNonPersonalCloudKeyError:h,isSelected:g,localPath:m,onLoadVideo:p}=e,{UIContent:f}=o,v=f.thumbUrl,_=f.duration,b=Mr.a.useMemo((()=>({height:n.height-2+"px",maxHeight:eF+"px",width:n.width-2+"px"})),[n]);return h?Mr.a.createElement("div",{className:"relative flx",onClick:i},Mr.a.createElement(nS.e,{className:Object(PC.a)("outline-bubble","rounded-5",sF.h,g&&sF.i.Selected),disableEvents:u,msgIds:[null==o?void 0:o.msgId],style:b,type:"video",windowId:"1",entry:tF.a.CSC,message:o,devSrc:"VideoMessageNonCaption"})):d?Mr.a.createElement("div",{className:Object(PC.a)("relative",d?"":"clickable"),onClick:i,style:Object(I.a)(Object(I.a)({},b),{},{borderRadius:"inherit"})},Mr.a.createElement(iF,{convId:null==o?void 0:o.toUid})):Mr.a.createElement("div",{className:"relative flx",onClick:i},Mr.a.createElement(pF,{ref:t,className:Object(PC.a)(sF.k,"rounded-5"),conversation:r,handleDownloadResult:c,message:o,onLoad:p,style:b,thumbUrl:v,userId:null!==(s=null!==(a=null==r?void 0:r.userId)&&void 0!==a?a:o.toUid)&&void 0!==s?s:""}),Mr.a.createElement(uF,{className:Object(PC.a)("rounded-t-5","rounded-b-5"),isClickable:!0,isHoverDeactivated:Boolean(u),isSelected:g},Mr.a.createElement(nF.a,{duration:_}),Mr.a.createElement(dF,{variant:hF({isDownloadError:l,localPath:m})})),Mr.a.createElement(jD.b,{entry:jD.a.csc,message:o,devSrc:"VideoMessageNonCaption"}))}));function vF(e,t){const{data:s,doubleClick:a,isHighlightedByPrivilegedUser:i,isFocused:n,observeIntersectionForReading:r,showMessageContextMenu:o}=e,{UIContent:c}=s,l=Mr.a.useRef(null);return Object(cR.a)(l,r),c?Mr.a.createElement(lR.a,{className:Object(PC.a)(sF.f,i&&(null==s.ttl||0==s.ttl)&&sF.g.HighlightFromPrivilegedUser,"focused-item",n&&"focused-item--highlight-border"),border:6,isAdmin:i,ttl:s.ttl,variant:"photo"},Mr.a.createElement("div",{ref:l,"data-qId":Object(fe.g)(s),onContextMenu:o,onDoubleClick:a},Mr.a.createElement(fF,Object(gC.a)({},e,{ref:t})))):null}var _F=Mr.a.forwardRef(vF);const bF=Mr.a.forwardRef((function(e,t){const{clickVideo:s,contentSize:a,conversation:i,data:n,doubleClick:r,handleDownloadResult:o,isDownloadError:c,isExpired:l,isMultiSel:d,isNonPersonalCloudKeyError:u,isSelected:h,localPath:g,onLoadVideo:m}=e,{UIContent:p}=n,f=p.thumbUrl,v=p.duration,_=Mr.a.useMemo((()=>({height:a.height-2+"px",maxHeight:eF+"px",width:a.width-2+"px"})),[a]),b=p.caption;let y=null;if(u||"non-personal-cloud"===b)y=Mr.a.createElement(nS.e,{className:Object(PC.a)("outline-bubble","rounded-t-5",sF.h,h&&sF.i.Selected),disableEvents:d,msgIds:[null==n?void 0:n.msgId],style:Object(I.a)(Object(I.a)({},_),{},{borderRadius:"inherit"}),type:"video",windowId:"1",entry:tF.a.CSC,message:n,devSrc:"VideoMessageWithCaption"});else if(l||"is-expired"===b)y=Mr.a.createElement(iF,{hasCaption:!0,convId:null==n?void 0:n.toUid});else{var S,C;y=Mr.a.createElement(Mr.a.Fragment,null,Mr.a.createElement(pF,{ref:t,className:Object(PC.a)(sF.k),conversation:i,handleDownloadResult:o,message:n,onLoad:m,style:_,thumbUrl:f,userId:null!==(S=null!==(C=null==i?void 0:i.userId)&&void 0!==C?C:n.toUid)&&void 0!==S?S:""}),Mr.a.createElement(uF,{className:Object(PC.a)("rounded-t-5"),isClickable:!0,isHoverDeactivated:Boolean(d),isSelected:h},Mr.a.createElement(nF.a,{duration:v}),Mr.a.createElement(dF,{variant:hF({isDownloadError:c,localPath:g})})),Mr.a.createElement(jD.b,{entry:jD.a.csc,message:n,devSrc:"VideoMessageWithCaption"}))}return Mr.a.createElement("div",{className:sF.m,onClick:s,onDoubleClick:r,style:_},y)}));function IF(e,t){const{contentSize:s,data:a,isFocused:i,isHighlightedByPrivilegedUser:n,isMultiSel:r,isSelected:o,observeIntersectionForReading:c,SentTimeCompRenderer:l,showMessageContextMenu:d}=e,{UIContent:u}=a,h=Mr.a.useRef(null);if(Object(cR.a)(h,c),!u)return null;const g="0"===a.fromUid,m=Mr.a.useMemo((()=>({height:s.height-2+"px",maxHeight:eF+"px",width:s.width-2+"px"})),[s]),p=Y.UIMessagePrefixElementID.VideoMessage+Object(fe.j)(a),f=Mr.a.useCallback((e=>{d(e,{captionContainerElementId:p})}),[]);return Mr.a.createElement(lR.a,{className:Object(PC.a)(sF.n,n&&(null==a.ttl||0==a.ttl)&&sF.o.HighlightFromPrivilegedUser,!Boolean(a.ttl)&&"shadow-bubble","rounded-6","focused-item",g&&sF.o.Blue,o&&sF.o.Selected,i&&"focused-item--highlight-border"),border:6,isAdmin:n,variant:"photo",ttl:a.ttl},Mr.a.createElement("div",{ref:h,"data-qId":Object(fe.g)(a),onContextMenu:d},Mr.a.createElement(bF,Object(gC.a)({},e,{ref:t})),Mr.a.createElement("div",{id:p,className:Object(PC.a)(sF.l,"rounded-bl-6","rounded-br-6",r&&"clickable"),onContextMenu:f,style:{width:m.width}},Object(Gw.a)(u.caption,e),l?Mr.a.createElement(l,null):null)))}var yF=Mr.a.forwardRef(IF),SF=s("9+7Y");var CF=function(e){var t;const{chatId:s,containerWidth:i,conversation:n,data:r,isMultiSel:o,selectedMsg:c={},SentTimeCompRenderer:l,showContextMenu:d,turnOnMultipleSelectionMode:u,user:h}=e,g=Boolean(o&&c[r.msgId]),{status:m}=Object(iw.a)(r,"VideoMessage"),p=Object(SF.a)(r),[f,v,_]=XA(!1),[b,y]=Mr.a.useState(null!==(t=r.localPath)&&void 0!==t?t:""),S=Mr.a.useRef(),C=Mr.a.useRef(!1),E=Object(OC.a)();Mr.a.useEffect((()=>{$R.a.getInstance().push(r,$R.b.chatview)}),[]);const O=Object(Kw.a)(((e,t)=>{!0!==e&&(e?v():M(t))})),M=Object(Kw.a)((e=>{var t;if(r.status<Y.MSG_SENT)return;y(e),null===(t=a.ModuleContainer.resolve(we.a))||void 0===t||t.updateMedia("image",r.toUid,r.msgId,{localPath:e},["localPath"]);const s=r.toUid;Re.default.updateMessage(r.msgId,{msgId:r.msgId,localPath:e},["localPath"],s),E({type:ve.ChatBoxActions.FILEPATH_UPDATED,payload:Object(I.a)(Object(I.a)({},r),{},{localPath:e})})})),[T]=function(e,t=200){const s=Object(Ew.a)(e,t);return[s,s.cancel]}((e=>{(()=>{const e=JSON.parse(JSON.stringify(r));b&&(e.localPath=b);const t={user:h,selectedId:e.msgId,oriUrl:e.message.oriUrl,userId:e.userId,isVideo:e.msgType===Y.MSG_VIDEO||2===e.subType,message:e,conversation:n,isMessageConv:!0,images:[r],iconMap:rh.b.getIconMap(),appConfig:Object(Ce.getPVConfigs)()};me.a.OpenPhoto.openPhotoViewer(t)})(),Object(ge.c)(r,ge.a.UserAction),Ce.default.cloud_send2me.enable&&s==Ce.default.sendToMeId&&jw.b.log(jw.a.OPEN,1,r),_()})),R=Object(Kw.a)((e=>{e&&e.stopPropagation(),o?u(e,r):T(e)})),w=Object(Kw.a)((()=>{if(!0===C.current)return;const e=JSON.parse(JSON.stringify(r));let t;if(e.UIContent&&e.status!=Y.MSG_LOCAL&&e.status!=Y.MSG_FAIL&&S.current&&"function"==typeof S.current.getThumbEle&&(t=S.current.getThumbEle()))try{const s=e.UIContent.width,a=e.UIContent.height;if(s!==t.naturalWidth||a!==t.naturalHeight){const s={video_width:t.naturalWidth,video_height:t.naturalHeight,parsed:1};C.current=!0,Re.default.updateMessageParams(e.msgId,s,e)}}catch(s){}})),L=Object(Kw.a)((e=>{e&&e.stopPropagation()})),D=Y.UIMessagePrefixElementID.VideoMessage+Object(fe.j)(r);let A=Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_UNSELECTED;g&&c[r.msgId]&&(A=c[r.msgId].multipleSelectedType||Y.MULTI_PHOTO_SELECTED_TYPE.TYPE_SELECTED_FULL);const F=Object(Kw.a)(((e,t)=>{"function"==typeof d&&d({event:e,message:r,detail:Object(I.a)({},t)})})),k=function(e,t=-1){const s=160,a=110,i=368;let n=Math.min(798,isNaN(t)?798:t);t<=-1&&(n=i);let r=!1;const o={width:i+"px",height:i+"px",defaultSize:!0};if(!e)return o;let c=e.width,l=e.height;if(void 0!==c&&null!=l||(c=i,l=i,r=!0),!e.parsed&&qp.a(e.rotation)&&Boolean(+e.rotation/90%2)){const e=c;c=l,l=e}if(c>0&&l>0){let t=c,o=l;if(c<s&&l<a)o=a,t=s;else if(c>n&&l>i){let e=i/l;if(o=i,t=Math.round(c*e),t>n){e=n/t,t=n;let s=Math.round(o*e);o=Math.max(s,a)}t=Math.max(t,s)}else if(l>i){let e=i/l;o=i;let a=Math.round(c*e);t=Math.max(s,a)}else if(l>=a&&l<=i){if(c>n){let e=n/c;t=n;let s=Math.round(l*e);o=Math.max(a,s)}else if(c<s){t=s;let e=s/c,n=Math.round(l*e);o=Math.min(Math.max(a,n),i)}}else if(l<a){o=a;let e=a/l,i=Math.round(e*c);t=c>n?n:Math.min(Math.max(s,i),n)}return{height:o+"px",width:t+"px",defaultSize:r,rotation:e.rotation}}return o}(r.UIContent,i-201),N=Mr.a.useMemo((()=>{if(k.width){const e=parseInt(k.height),t=parseInt(k.width);return{height:isNaN(e)?eF:e,width:isNaN(e)?eF:t}}return{width:eF,height:eF}}),[k.width,k.height]),P=Object(Kw.a)((()=>{EL.a.logActionMediaCaption(n,r,k.width)}));Mr.a.useEffect((()=>{P()}),[k.width]);const j=Boolean(r.message&&r.message.title);let U=r.UIContent&&r.status!=Y.MSG_LOCAL&&r.status!=Y.MSG_FAIL&&"none"===m;return j?Mr.a.createElement(yF,Object(gC.a)({},e,{ref:S,clickVideo:R,containerId:D,contentSize:N,doubleClick:L,isDownloadError:f,isExpired:U,isNonPersonalCloudKeyError:p,isSelected:g,handleDownloadResult:O,localPath:b,onLoadVideo:w,SentTimeCompRenderer:l,showMessageContextMenu:F})):Mr.a.createElement(_F,Object(gC.a)({},e,{ref:S,clickVideo:R,containerId:D,contentSize:N,doubleClick:L,isDownloadError:f,isExpired:U,isNonPersonalCloudKeyError:p,isSelected:g,handleDownloadResult:O,localPath:b,onLoadVideo:w,showMessageContextMenu:F}))};var EF=Ge;let OF;var MF={GetManager:()=>{var e;return null!==(e=OF)&&void 0!==e?e:OF=a.ModuleContainer.resolve(EF)}};const TF="voice-message-loading",RF=TF+"__indicator-wrapper",wF=TF+"__indicator",LF="voice-message-expired",DF=LF+"__icon-wrapper",AF=LF+"__content-wrapper",FF="voice-message-invalid",kF=FF+"__title-container",NF=FF+"__title-icon-wrapper",PF=FF+"__title-content-wrapper",jF=FF+"__description-container",UF=FF+"__description-icon-wrapper",BF=FF+"__description-content-wrapper",zF="voice-message-normal",GF=zF+"__content-container",xF=zF+"__player-control-wrapper",VF=zF+"__waveform-wrapper",HF=zF+"__waveform-col-one",WF={Playing:HF+"--playing"},qF=zF+"__waveform-col-two",KF={Playing:qF+"--playing"},ZF=zF+"__waveform-col-three",$F={Playing:ZF+"--playing"},QF=zF+"__duration-wrapper";var YF=function(e){let{toUid:t}=null==e?void 0:e.message,s=t===Ce.default.sendToMeId;const a=hO.a.getInstance().isPaidUser()||s?"STR_ZCLOUD_VOICE_UNAVAILABLE":"STR_CLOUD_VOICE_EXPIRED_ALL",i=Object(qw.c)(a);return Mr.a.createElement("div",{className:LF},Mr.a.createElement("div",{className:DF},Mr.a.createElement("i",{className:"fa fa-Mic-off_24_Filled"})),Mr.a.createElement("div",{className:AF},i))};var JF=function(e){const t=Object(qw.c)("STR_VOICE_MESSAGE"),s=Object(qw.c)("STR_E2EE_VOICE_NOT_SUPPORT");return Mr.a.createElement("div",{className:FF},Mr.a.createElement("div",{className:kF},Mr.a.createElement("div",{className:NF},Mr.a.createElement("i",{className:"fa fa-Mic_24_Line"})),Mr.a.createElement("div",{className:PF},t)),Mr.a.createElement("div",{className:jF},Mr.a.createElement("div",{className:UF},Mr.a.createElement("i",{className:"fa fa-Warning_Circle_24_Line"})),Mr.a.createElement("div",{className:BF},s)))},XF=s("Nd7d");var ek=function(){return Mr.a.createElement("div",{className:zF},Mr.a.createElement("div",{className:GF},Mr.a.createElement("div",{className:RF},Mr.a.createElement(XF.a,{className:wF,color:"var(--B50)",size:20})),Mr.a.createElement("div",{className:VF},Mr.a.createElement("div",{className:HF}),Mr.a.createElement("div",{className:qF}),Mr.a.createElement("div",{className:ZF})),Mr.a.createElement("div",{className:QF},"--:--")))};const tk=function(){let e=null;return{GetFactory:()=>(null===e&&(e=a.ModuleContainer.resolve(Le)),e)}}();var sk={Audio:MF,MediaPlayer:tk};var ak=s("WKSW"),ik=s("LkXv");const nk="readyplay",rk="loading";var ok=function(e){const{duration:t,message:s,source:i,reloadResource:n}=e,[r,o]=Mr.a.useState(null),[c,l]=Mr.a.useState(t),[d,u]=Mr.a.useState(!1),[h,g]=Mr.a.useState(rk),[m,p]=Mr.a.useState(!1);Mr.a.useEffect((()=>{const e=sk.MediaPlayer.GetFactory().createAudioPlayer();return o(e),()=>{sk.MediaPlayer.GetFactory().deleteMediaPlayer(e.getToken())}}),[]),Mr.a.useEffect((()=>(r&&(i!==r.getSource()&&(r.release(),r.setSource(i)),r.prepare(),r.addEventListener("canplay",((e,t)=>{g(nk)})),r.addEventListener("durationchange",((e,t)=>{l(1e3*t)})),r.addEventListener("ended",(()=>{u(!1)})),r.addEventListener("timeupdate",((e,t)=>{l(1e3*t.remainingTime)})),r.addEventListener("onabort",((e,t)=>{Object(ik.c)("onabort",null==s?void 0:s.msgId)})),r.addEventListener("onerror",((e,t)=>{var a;Object(ik.c)("onerror",null==s?void 0:s.msgId),a=e,Object(ik.c)("onerror",null==s?void 0:s.msgId,a),null==r||r.stop(),u(!1)}))),()=>{})),[i,r]),Mr.a.useEffect((()=>{m?v():p(!1)}),[m]);const f=function(e){return e<0?"--:--":bM.a.getMinutesFromSeconds(Math.round(e))}(c/1e3),v=()=>{Object(ak.a)(s)?a.ModuleContainer.resolve(nS.c).getErrorPCloudHandler({msgIds:[null==s?void 0:s.msgId],windowId:Ar.c,error:{hasNoKey:!0},showNoti:!0,type:"audio"})():h===nk?(u(!d),r&&(d?r.stop():r.play())):(n((e=>{g(nk),p(!0)}),(e=>{})),u(!1),null==r||r.stop())};return Mr.a.createElement("div",{className:zF,onClick:v,id:i},Mr.a.createElement("div",{className:GF},Mr.a.createElement("div",{className:xF},d?Mr.a.createElement("i",{className:"fa fa-StopCircle_24_Filled"}):Mr.a.createElement("i",{className:"fa fa-PlayCircle_24_Filled"})),Mr.a.createElement("div",{className:VF},Mr.a.createElement("div",{className:Object(PC.a)(HF,d&&WF.Playing)}),Mr.a.createElement("div",{className:Object(PC.a)(qF,d&&KF.Playing)}),Mr.a.createElement("div",{className:Object(PC.a)(ZF,d&&$F.Playing)})),Mr.a.createElement("div",{className:QF},f)),Mr.a.createElement(jD.b,{entry:jD.a.csc,message:s,devSrc:"VoiceMessageNormal"}))},ck=s("YHwM");function lk(e){var t,s;if(!e)return 0;let a=null==e||null===(t=e.message)||void 0===t?void 0:t.params;if("string"==typeof a)try{a=JSON.parse(a)}catch(i){}return null!==(s=a)&&void 0!==s&&s.duration?Math.round(+a.duration/1e3):0}var dk=function(e){const{data:t}=e,[s,a]=Mr.a.useState(null),i=Object(WL.a)(),{flag:n,status:r}=Object(iw.a)(t,"VoiceMessage"),o=Mr.a.useCallback(((e,s)=>{try{MF.GetManager().reloadResourceFromMessage(t).then((i=>{a({localURL:i.localURL,URL:i.URL,status:i.status}),"playable"===(null==i?void 0:i.status)?null==e||e(i.localURL||i.URL):(null==s||s(),Object(ck.a)(t))})).catch((e=>{null==s||s(e)}))}catch(i){null==s||s(i)}}),[t]);Mr.a.useEffect((()=>{MF.GetManager().loadResourceFromMessage(Object(I.a)(Object(I.a)({},t),{},{content:t.UIContent}),{windowId:i}).then((e=>{a({localURL:e.localURL,URL:e.URL,status:e.status})}))}),[t.msgId]),Mr.a.useEffect((()=>{$R.a.getInstance().push(t,$R.b.chatview)}),[]);let c=null;if("none"===r)c=Mr.a.createElement(YF,{message:t});else if(null==s)c=Mr.a.createElement(ek,null);else if("playable"===s.status||"clouded"===r||n&It.d.server_temp){var l;c=Mr.a.createElement(ok,{duration:null!==(l=t.UIContent.duration)&&void 0!==l?l:lk(t),message:t,source:s.localURL||s.URL,reloadResource:o})}else c="expired"===s.status?Mr.a.createElement(YF,{message:t}):"not-supported"===s.status?Mr.a.createElement(JF,null):Mr.a.createElement(YF,{message:t});return Mr.a.createElement("div",{id:Y.UIMessagePrefixElementID.VoiceMessage+Object(fe.j)(t),className:"voice-message"},c)};var uk=s("PWbL");var hk=function(e){const{conversation:t,data:s,isFocused:a,sendTimeComp:i,user:n}=e,r=Object(WL.a)();return Mr.a.createElement(uk.b,{key:s.msgId,message:s,user:n,conversation:t,windowId:r,isFocused:a,sourceRender:uk.a.MESSAGE_WIDGET,sendTime:i})};var gk,mk={[hT.e.Call]:{configs:{layoutType:hT.d.NoFrame,canReact:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:LR,transformData:FT},[hT.e.Contact]:{configs:{layoutType:hT.d.NoFrame,layout:{maxWidth:306,width:"100%"}},component:WR,transformData:NT},[hT.e.DFE]:{configs:{canReact:!1,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:qR},[hT.e.E2eeDecryptFailed]:{configs:{hasDynamicBorder:!0,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:OT},[hT.e.E2eePendingData]:{configs:{hasDynamicBorder:!0,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:TT},[hT.e.File]:{configs:{layout:{maxWidth:400,width:"100%"},hasDynamicBorder:!0,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object(gw.a)(e))}}},component:hw,transformData:PT},[hT.e.GIF]:{configs:{layoutType:hT.d.NoFrame,shouldShowMessageStatusSideIndicator:!1},component:Cw},[hT.e.Link]:{"recommened.link":{configs:{layout:{maxWidth:400,minWidth:220}},component:Ww,transformData:BT}},[hT.e.Location]:{configs:{layoutType:hT.d.NoFrame},component:hL,transformData:GT},[hT.e.OA]:{configs:{layoutType:hT.d.NoFrame,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:KL},[hT.e.Photo]:{configs:{disablePointerEvent:!1,layoutType:hT.d.NoFrame,reaction:{},messageQuickActionConfig:{canReply:function(e){return!!e&&e.msgType!==Y.MSG_PHOTO_GROUP},canForward:function(e){if(!e)return!1;if(e.msgType===Y.MSG_PHOTO_GROUP){const t=e.message;for(let e=0;e<t.length;e++)if(Object(gw.a)(t[e]))return!0;return!1}return!!Object(gw.a)(e)}},shouldShowMessageStatusSideIndicator:e=>{if(!Object(x_.x)(e))return!1;if(!Object(x_.o)(e))return!1;const t=e.message;if(!t||t.length<=1)return!1;return t.every(x_.l)}},component:HL},[hT.e.StickerGroup]:{configs:{canReact:!1,canDoubleClick:!1,disablePointerEvent:!1,messageQuickActionConfig:{canReply:e=>{const t=e.message;if(null==t||!t.length)return!1;if(t.length>1)return!1;const s=t[0];return!!s&&(s.status!==Y.MSG_FAIL&&s.status!==Y.MSG_LOCAL&&(s.msgType!==Y.MSG_UNDO&&s.msgType!==Y.MSG_DEL_EVERYONE))},canForward:e=>{const t=e.message;if(null==t||!t.length)return!1;if(t.length>1)return!1;const s=t[0];return!!s&&(s.status!==Y.MSG_FAIL&&s.status!==Y.MSG_LOCAL&&(s.msgType!==Y.MSG_UNDO&&s.msgType!==Y.MSG_DEL_EVERYONE))}},layoutType:hT.d.NoFrame,shouldShowMessageStatusSideIndicator:e=>{if(!Object(x_.x)(e))return!1;if(!Object(x_.p)(e))return!1;const t=e.message;if(!t||t.length<=1||Object(x_.y)(t[0]))return!1;return t.every(x_.l)}},component:jA,transformData:XT},[hT.e.StickerSet]:{configs:{canReact:!1,messageQuickActionConfig:{canForward:!1},layoutType:hT.d.NoFrame},component:BA,transformData:sR},[hT.e.Text]:{configs:{hasDynamicBorder:!0},component:QA,transformData:aR},[hT.e.Undo]:{configs:{canReact:!1,canDoubleClick:!1,messageQuickActionConfig:{canReply:!1,canForward:!1},isEditable:e=>{var t;if("string"!=typeof e.message)return!1;return Date.now()-e.sendDttm<(null===(t=s("NDmK"))||void 0===t?void 0:t.default).time_enable_edit_undo_msg}},component:YA},[hT.e.Unknown]:{configs:{canReact:!1,canClick:!1,canDoubleClick:!1,canContextMenu:!1},component:JA},[hT.e.Video]:{configs:{layoutType:hT.d.NoFrame,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object(gw.a)(e))}}},component:CF,transformData:nR},[hT.e.Voice]:{configs:{alwaysShowTimeOutSide:!0,messageQuickActionConfig:{canReply:function(e){return!0},canForward:function(e){return!(!e||!Object(gw.a)(e))}}},component:dk,transformData:oR},[hT.e.ZInstant]:{configs:{layoutType:hT.d.NoFrame,canReact:!1,messageQuickActionConfig:{canReply:!1,canForward:!1}},component:hk}},pk=s("uave");Object(xi.b)(pk.b)(gk=Object(a.injectable)()(gk=Reflect.metadata("design:type",Function)(gk=Reflect.metadata("design:paramtypes",[])(gk=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.messageContents=void 0,this.name=pk.a,this.key=pk.a,this.data=new Map,this.messageContents=new Map,this.setupMessageContents()}async onChangeMessages(e){const t=(new Date).getTime().toString();Object(nc.j)(t),e.forEach((e=>{e.msgId&&(this.data.set(e.msgId,e),Object(nc.g)(t,this.name,e.msgId))})),Object(nc.c)(t)}onRemoveMessages(e){e.forEach((e=>{this.data.delete(e)}))}getMessageAction(e,t){const s=this.messageContents.get(e);return s?s.configs?s:t?s[t]:null:null}getItem(e,t){return this.data.get(e.key)}setupMessageContents(){for(const[e,t]of Object.entries(mk))this.messageContents.set(e,t)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||gk)||gk)||gk);var fk,vk=s("Vh8h"),_k=s("kEG/");function bk(){return"number"==typeof Ce.default.async_forward.checked_url_cache_expiration_time?Ce.default.async_forward.checked_url_cache_expiration_time:36e5}function Ik(){return!Ce.default.async_forward.disable_cache_check_exist}function yk(){return Oa.a.now()}var Sk=Object(a.injectable)()(fk=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(fk=Reflect.metadata("design:type",Function)(fk=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(fk=class{constructor(e){this._checkedMap=new Map,this._currentCheckingRequestAmount=0,this._urlChangedMap=new Map,this._logger=void 0,this._isQueueExecuting=!1,this._queue=[],J.p.listenEvent(J.k,this.onNetworkChange.bind(this)),this.Logger=e.createZLogger("utils",["share-file-handler"])}check(e){return new Promise(((t,s)=>{Ik()&&this.checkedMap.has(e)&&yk()-this.checkedMap.get(e)<bk()?(t(!0),this.executeQueue()):this.enqueueExecution(e,t,s)}))}getNewUrl(e){return this.urlChangedMap.get(e)||e}updateFileUrl(e,t){this.urlChangedMap.set(e,t),this.checkedMap.set(t,yk())}decreaseRequestAmount(){this._currentCheckingRequestAmount--}enqueueExecution(e,t,s,a=!0){this.executionQueue.push({url:e,resolve:t,reject:s,shouldRetry:a}),this.executeQueue()}executeQueue(){if(!this.isQueueExecuting()){for(this.setExecutionQueueWorking();this.getCurrentNetworkStatus()!==le.a.DISCONNECT&&this.getCurrentRequestAmount()<=("number"==typeof Ce.default.async_forward.maximum_requests_in_a_while?Ce.default.async_forward.maximum_requests_in_a_while:5)&&this.executionQueue.length>0;){let e=this.executionQueue.shift();this.increaseRequestAmount(),this.processCheckingRequest(e).then((()=>{this.handleResponse(e,!0,null)})).catch((t=>{var s;this.handleResponse(e,!1,null===(s=t.data)||void 0===s?void 0:s.status)}))}this.setExecutionQueueFree()}}getCurrentNetworkStatus(){return le.b.getStateNetwork()}getCurrentRequestAmount(){return this._currentCheckingRequestAmount}increaseRequestAmount(){this._currentCheckingRequestAmount++}isQueueExecuting(){return this._isQueueExecuting}onNetworkChange(){this.getCurrentNetworkStatus()===le.a.CONNECTED&&(this.Logger.zsymb(21,"VYqmTN",["network was connected, start executing check-exist queue","e6BNqQ"]),this.executeQueue())}setExecutionQueueFree(){this._isQueueExecuting=!1}setExecutionQueueWorking(){this._isQueueExecuting=!0}handleResponse(e,t,s){this.decreaseRequestAmount(),t?(this.checkedMap.set(e.url,yk()),this.executeQueue()):s===_k.b.ClientError.RequestTimeout&&e.shouldRetry?this.enqueueExecution(e.url,e.resolve,e.reject,!1):(this.checkedMap.set(e.url,0),this.executeQueue()),e.resolve(t)}tryToLoadUrl(e){return new Promise(((t,s)=>{const a=91047;!function(e,t={}){const s=Date.now(),a=yk();let i=e.replace("http://","https://");i=ui.default.removeE2eeProtocol(i);const{onabort:n=null,onerror:r=null,onload:o=null,ontimeout:c=null,timeout:l=1e4}=t,d=new XMLHttpRequest;d.open("HEAD",i),d.responseType="arraybuffer",d.timeout=l,Ee.l||d.setRequestHeader("Cache-Control","no-cache");const u=()=>({duration:yk()-a,startTime:s});d.onload=e=>{o&&o(e,u())},d.onerror=e=>{r&&r(e,u())},d.ontimeout=e=>{c&&c(e,u())},d.onabort&&(d.onabort=e=>{n&&n(e,u())}),d.send()}(e,{onabort:(e,t)=>{kc.default.increaseFailed(a,0,t.duration,4,t.startTime),s(e.target.status)},onerror:(e,t)=>{this.Logger.zsymb(21,"Hx_x-1",["check-exist error: {}","BPanko"],e),kc.default.increaseFailed(a,0,t.duration,2,t.startTime),s(e.target.status)},onload:(e,i)=>{e.target.status>=400?(kc.default.increaseFailed(a,0,i.duration,3,i.startTime),s(e.target.status)):e.target.responseURL&&e.target.responseURL.indexOf("default")>=0?(kc.default.increaseFailed(a,0,i.duration,5,i.startTime),s(e.target.status)):(kc.default.increaseSuccess(a,0,i.duration),t(!0))},ontimeout:(e,t)=>{kc.default.increaseFailed(a,0,t.duration,1,t.startTime),s(e.target.status)}})}))}async processCheckingRequest(e){if(!e)return Promise.reject({message:"Invalid request item",data:null});const{url:t}=e;if(Ik()&&this.checkedMap.has(t)){let e=this.checkedMap.get(t);if(yk()-e<bk())return Promise.resolve()}if(Ee.l&&!ui.default.isConnectSrc(t))try{return await Object(vk.b)(t,"number"==typeof Ce.default.async_forward.checking_url_timeout?Ce.default.async_forward.checking_url_timeout:1e4),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:0}})}try{return await this.tryToLoadUrl(t),Promise.resolve()}catch(s){return Promise.reject({message:"",data:{status:s}})}}get checkedMap(){return this._checkedMap}get executionQueue(){return this._queue}get urlChangedMap(){return this._urlChangedMap}get Logger(){return this._logger}set Logger(e){this._logger=e}})||fk)||fk)||fk)||fk,Ck=s("vyPS");a.ModuleContainer.register(Ck.a,Sk);s("Ws6j");var Ek=s("GaKD"),Ok=s("Y65e");const Mk=a.ModuleContainer.resolve(zs.b),Tk=(e,t)=>(s,a,i)=>{const n=i.value;i.value=function(...s){const a=performance.now(),i=n.apply(this,s);if(i instanceof Promise)return E.c.catchAsyncFn((()=>i)).then((([i,n])=>{const r=performance.now()-a,o=Object(I.a)({commandId:e,success:!i,errorCode:null==i?void 0:i.code,duration:r},null==t?void 0:t(s,[i,n],r));if(Mk.log(o),i)throw i;return n}));{const n=performance.now()-a,r=Object(I.a)({commandId:e,success:!0,duration:n},null==t?void 0:t(s,[null,i],n));return Mk.log(r),i}}};let Rk=function(e){return e[e.CLIENT_PARSER=111026]="CLIENT_PARSER",e[e.SERVER_PARSER=111027]="SERVER_PARSER",e[e.NOOP_PARSER=111028]="NOOP_PARSER",e[e.DOWNLOAD_THUMB=111029]="DOWNLOAD_THUMB",e[e.UPLOAD_THUMB=111030]="UPLOAD_THUMB",e[e.PREVIEW_INTEGRITY=111031]="PREVIEW_INTEGRITY",e}({});var wk,Lk,Dk,Ak,Fk;let kk=(wk=Tk(Rk.NOOP_PARSER,(([e])=>({params:[e]}))),Lk=Reflect.metadata("design:type",Function),Dk=Reflect.metadata("design:paramtypes",[String]),Fk=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e){return!0}async parse(e){return null}},Fk.instance=null,Ak=Fk,Object(Ok.a)(Ak.prototype,"parse",[wk,Lk,Dk],Object.getOwnPropertyDescriptor(Ak.prototype,"parse"),Ak.prototype),Ak);var Nk=s("G95d"),Pk=s("dXzg");let jk=function(e){return e[e.UNKNOWN_ERROR=100]="UNKNOWN_ERROR",e[e.URL_ERROR=101]="URL_ERROR",e[e.HTTP_STATUS_ERROR=102]="HTTP_STATUS_ERROR",e[e.REDIRECT_ERROR=103]="REDIRECT_ERROR",e[e.PARSE_XML_HEAD_ERROR=104]="PARSE_XML_HEAD_ERROR",e[e.HTTP_REQUEST_ERROR=105]="HTTP_REQUEST_ERROR",e[e.EMPTY_METADATA=106]="EMPTY_METADATA",e[e.HTTP_TIMEOUT_REQUEST_ERROR=107]="HTTP_TIMEOUT_REQUEST_ERROR",e[e.HTTP_NOTFOUND_ERROR=108]="HTTP_NOTFOUND_ERROR",e[e.HTTP_CONNREFUSED_ERROR=109]="HTTP_CONNREFUSED_ERROR",e[e.HTTP_CONNRESET_ERROR=110]="HTTP_CONNRESET_ERROR",e[e.CLOUDFLARE_MITIGATED_ERROR=111]="CLOUDFLARE_MITIGATED_ERROR",e[e.PARSE_LINK_SERVER_ERROR=200]="PARSE_LINK_SERVER_ERROR",e[e.DOWNLOAD_THUMB_ERROR=300]="DOWNLOAD_THUMB_ERROR",e[e.THUMB_SIZE_ERROR=301]="THUMB_SIZE_ERROR",e[e.THUMB_TYPE_ERROR=302]="THUMB_TYPE_ERROR",e[e.WEBP_THUMB_TYPE_ERROR=303]="WEBP_THUMB_TYPE_ERROR",e[e.UPLOAD_THUMB_ERROR=400]="UPLOAD_THUMB_ERROR",e[e.COMPRESS_THUMB_ERROR=401]="COMPRESS_THUMB_ERROR",e[e.GET_PARSER_ERROR=500]="GET_PARSER_ERROR",e}({});const Uk=(e,t)=>{if(e)throw t};class Bk extends Error{constructor(e,t,s,a=[]){super(s),this.code=void 0,this.qosParams=void 0,this.name=e,this.qosParams=[...a,s],this.code=t}setStack(e){const t=`${this.name}: ${this.message}`;this.stack=t+(e||"")}toObject(){return{name:this.name,code:this.code,message:this.message,stack:this.stack,qosParams:this.qosParams}}static createFromObject(e){const{name:t="UnknownError",code:s=jk.UNKNOWN_ERROR,message:a,stack:i,qosParams:n=[]}=e,r=new Bk(t,s,a);return r.qosParams=n,r.setStack(i),r}}class zk extends Bk{constructor(e,t,s){super("ParseLinkServerError",jk.PARSE_LINK_SERVER_ERROR,`Parse link server failed. Url: ${e}. Message: ${t}`,s)}}class Gk extends Bk{constructor(e,t){super("UploadThumbError",jk.UPLOAD_THUMB_ERROR,`Upload thumb failed. Message: ${e}`,t)}}class xk extends Bk{constructor(e,t){super("CompressThumbError",jk.COMPRESS_THUMB_ERROR,`Compress thumb failed. Message: ${e}`,t)}}const Vk=1048576,Hk={GB:1073741824,MB:Vk,KB:1024,byte:1};let Wk;var qk;(qk=Wk||(Wk={})).sizeInByte=e=>{const t=/(\d+)(byte|KB|MB|GB)/g;let s,a=0;for(;s=t.exec(e);)a+=parseInt(s[1])*Hk[s[2]];return a},qk.getFileSizeByHead=async(e,t)=>{const s=await fetch(e,{method:"HEAD"}),a=s.headers.get("content-length"),i=s.headers.get("content-type");if(t&&t!=i)throw new Error(`An error occurred when trying to get file size. Error: unexpected content-type.Content-type expectation is "${t}" but received Content-type is "${i}".`);return Number(null!=a?a:0)};var Kk=function(e){return e[e.META_TITLE=0]="META_TITLE",e[e.META_DESCRIPTION=1]="META_DESCRIPTION",e[e.META_THUMB=2]="META_THUMB",e[e.DOCUMENT=3]="DOCUMENT",e}(Kk||{}),Zk=function(e){return e[e.NOT_FOUND=0]="NOT_FOUND",e[e.INVALID_FORMAT=1]="INVALID_FORMAT",e[e.DOWNLOAD_ERROR=2]="DOWNLOAD_ERROR",e}(Zk||{});class $k{constructor(){}async fetch(e){const[t,s]=await E.c.catchAsyncFn((()=>this.fetchLinkInfoFromServer(e)));Uk(!!t,t&&new zk(e,null==t?void 0:t.message));const[a,i]=await this.transformResponse(e,s);return Uk(!!a,a),i}fetchLinkInfoFromServer(e){return So.default.getLinkInformation(e).then(Co.a)}async transformResponse(e,t){var s,i,n;if(a.ModuleContainer.resolve(Pk.a).get("enable_verify_parse_link_server")&&E.g.isNotEmptyObject(t.error_maps))return[new zk(e,JSON.stringify(t.error_maps)),null];if((null===(s=t.error_maps)||void 0===s?void 0:s[Kk.DOCUMENT])===Zk.DOWNLOAD_ERROR)return[new zk(e,JSON.stringify(t.error_maps)),null];if(e.endsWith(".pdf")){var r;const s=await Wk.getFileSizeByHead(e);return t.data=null!==(r=t.data)&&void 0!==r?r:{},t.data.title=qf.a.getFileNameFromUrl(e),t.data.desc=ui.default.sizeToString(s),t.data.thumb=ui.DEFAULT_THUMB_URLS.ICON_PDF,[null,t.data]}return t.data.thumb&&!((null===(i=t.error_maps)||void 0===i?void 0:i[Kk.META_THUMB])in Zk)||t.data.thumb||t.data.title&&t.data.desc?((null===(n=t.error_maps)||void 0===n?void 0:n[Kk.META_THUMB])in Zk&&(t.data.thumb=""),[null,t.data]):[new zk(e,JSON.stringify(t)),null]}}var Qk,Yk,Jk,Xk,eN,tN=s("o2mE"),sN=s("/vDv");let aN=(Qk=Tk(Rk.SERVER_PARSER,(([e],t,s)=>(a.ModuleContainer.resolve(tN.b).linkParser.zsymb(12,"JYfsHP","ParseLinkMetric",Rk[Rk.SERVER_PARSER],e,s),{params:[e]}))),Yk=Reflect.metadata("design:type",Function),Jk=Reflect.metadata("design:paramtypes",[String]),(eN=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){const s=a.ModuleContainer.resolve(Pk.a);if(s.get("enable_force_parse_link_server"))return!0;if(!s.get("enable_parse_link_server"))return!1;const i=s.get("white_list_domain");for(const a of i)if(qf.a.isHrefMatchDomain(e,a))return!0;if((null==t?void 0:t.entry)===Nk.a.MESSAGE_WIDGET)return!0;if(!s.get("enable_parse_link_client")){if(null!=t&&t.convId){if(!sN.a.isE2eeConv(t.convId))return!0}if((null==t?void 0:t.entry)===Nk.a.SHARE_MESSAGE)return!0}return!1}async parse(e){const[t,s]=await E.c.catchAsyncFn((()=>(new $k).fetch(e)));return Uk(!!t,t),{typeParse:Nk.b.SERVER,href:e,desc:null==s?void 0:s.desc,media:null==s?void 0:s.media,src:null==s?void 0:s.src,stream_icon:null==s?void 0:s.stream_icon,thumb:null==s?void 0:s.thumb,title:null==s?void 0:s.title}}}).instance=null,Xk=eN,Object(Ok.a)(Xk.prototype,"parse",[Qk,Yk,Jk],Object.getOwnPropertyDescriptor(Xk.prototype,"parse"),Xk.prototype),Xk);var iN=s("poQk");let nN;var rN,oN,cN,lN,dN;!function(e){e.toSafeLowerCase=e=>"string"==typeof e?e.toLowerCase():e,e.toSafeUpperCase=e=>"string"==typeof e?e.toUpperCase():e,e.safeSplit=(e,...t)=>"string"==typeof e?e.split(...t):[];const t=e.trim=e=>e.trim().replace(/ +/g," ");e.truncateWord=(e,s)=>{const a=t(e);if(a.length<=s)return a;let i=s;for(;i>=0&&" "!==a[i];)i--;return i<=0?a.slice(0,s)+"…":a.slice(0,i)+"…"}}(nN||(nN={}));rN=Tk(Rk.CLIENT_PARSER,(([e],[t,s],i)=>{a.ModuleContainer.resolve(tN.b).linkParser.zsymb(12,"gsc0Vf","ParseLinkMetric",Rk[Rk.CLIENT_PARSER],e,i);const n={params:[e]};return t&&Array.isArray(null==t?void 0:t.qosParams)&&(n.params=t.qosParams),t||s||(n.success=!1,n.errorCode=jk.EMPTY_METADATA),s&&a.ModuleContainer.resolve(zs.b).log({commandId:Rk.PREVIEW_INTEGRITY,subCommandId:0,duration:0,success:!!s.thumb,params:[e]}),n})),oN=Reflect.metadata("design:type",Function),cN=Reflect.metadata("design:paramtypes",[String]),(dN=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){return!!a.ModuleContainer.resolve(Pk.a).get("enable_parse_link_client")&&(null==t?void 0:t.entry)!==Nk.a.MESSAGE_WIDGET}async parse(e){var t;const s=a.ModuleContainer.resolve(Pk.a),i=s.get("max_redirect"),n=s.get("max_title_character"),r=s.get("max_desc_character"),{enable_log_metric:o,delay_parse_client:c}=s.get("debug"),l=globalThis.__configParseLinkTest__;t=null==l?void 0:l.mockRedirect,null==l||l.mockPreview;let d;{const t={};0;const[s,n]=await E.c.catchAsyncFn((()=>iN.b.exec("parseLink",[e,{maxRedirect:i},t],{priority:iN.a.HIGH})));if(Uk(!!s,s&&Bk.createFromObject(s)),[d]=n,o){const[t,s]=n;a.ModuleContainer.resolve(tN.b).linkParser.zsymb(12,"CIyl6E","ParseLinkMetric: ",Rk[Rk.CLIENT_PARSER],"DETAIL",e,{fetch:s.endFetch-s.startFetch,parse:s.endParseMetaData-s.startParseMetaData,total:s.endParseMetaData-s.startFetch,htmlSize:s.htmlSize})}}const u=this.sanitizeMetaData(d,{maxTitleLength:n,maxDescLength:r});return this.isMetaDataFailed(u)?null:{typeParse:Nk.b.CLIENT,href:qf.a.getUrlWithHttpProtocol(e),title:u.title,desc:u.desc,thumb:"",thumbOrigin:u.thumb,media:{},src:u.src}}isMetaDataFailed(e){return!(e.title||e.desc||e.thumb)}sanitizeMetaData(e,t){const{maxTitleLength:s,maxDescLength:a}=t,{title:i="",desc:n=""}=e,r=E.g.clone(e);return r.title=nN.truncateWord(i||"",s),r.desc=nN.truncateWord(n||"",a),r}}).instance=null,lN=dN,Object(Ok.a)(lN.prototype,"parse",[rN,oN,cN],Object.getOwnPropertyDescriptor(lN.prototype,"parse"),lN.prototype);var uN,hN,gN,mN,pN;let fN=(uN=Tk(Rk.CLIENT_PARSER,(([e],[t,s],i)=>{a.ModuleContainer.resolve(tN.b).linkParser.zsymb(12,"En88GY","ParseLinkMetric",Rk[Rk.CLIENT_PARSER],e,i);const n={params:[e]};return t&&Array.isArray(null==t?void 0:t.qosParams)&&(n.params=t.qosParams),t||s||(n.success=!1,n.errorCode=jk.EMPTY_METADATA),s&&a.ModuleContainer.resolve(zs.b).log({commandId:Rk.PREVIEW_INTEGRITY,subCommandId:0,duration:0,success:!!s.thumb,params:[e]}),n})),hN=Reflect.metadata("design:type",Function),gN=Reflect.metadata("design:paramtypes",[String]),(pN=class e{constructor(){}static getInstance(){return null===e.instance&&(e.instance=new e),e.instance}isMatchParser(e,t){return!!a.ModuleContainer.resolve(Pk.a).get("enable_parse_link_client")&&(null==t?void 0:t.entry)!==Nk.a.MESSAGE_WIDGET}async parse(e){const t=a.ModuleContainer.resolve(Pk.a),s=t.get("max_redirect"),i=t.get("max_title_character"),n=t.get("max_desc_character"),{enable_log_metric:r}=t.get("debug"),[o,c]=await E.c.catchAsyncFn((()=>iN.b.exec("parseLink",[e,{maxRedirect:s}],{priority:iN.a.HIGH})));Uk(!!o,o&&Bk.createFromObject(o));const[l,d]=c;if(r){a.ModuleContainer.resolve(tN.b).linkParser.zsymb(12,"dOZeUf","ParseLinkMetric",Rk[Rk.CLIENT_PARSER],"DETAIL",e,{fetch:d.endFetch-d.startFetch,parse:d.endParseMetaData-d.startParseMetaData,total:d.endParseMetaData-d.startFetch,htmlSize:d.htmlSize})}const u=this.sanitizeMetaData(l,{maxTitleLength:i,maxDescLength:n});return this.isMetaDataFailed(u)?null:{typeParse:Nk.b.CLIENT,href:qf.a.getUrlWithHttpProtocol(e),title:u.title,desc:u.desc,thumb:"",thumbOrigin:u.thumb,media:{},src:u.src}}isMetaDataFailed(e){return!(e.title||e.desc||e.thumb)}sanitizeMetaData(e,t){const{maxTitleLength:s,maxDescLength:a}=t,{title:i="",desc:n=""}=e,r=E.g.clone(e);return r.title=nN.truncateWord(i||"",s),r.desc=nN.truncateWord(n||"",a),r}}).instance=null,mN=pN,Object(Ok.a)(mN.prototype,"parse",[uN,hN,gN],Object.getOwnPropertyDescriptor(mN.prototype,"parse"),mN.prototype),mN);var vN;Object(a.injectable)()(vN=Object(a.singleton)(Ek.a)(vN=Reflect.metadata("design:type",Function)(vN=Reflect.metadata("design:paramtypes",[])(vN=class{constructor(){}getLinkParser(e,t){return aN.getInstance().isMatchParser(e,t)?aN.getInstance():fN.getInstance().isMatchParser(e,t)?fN.getInstance():kk.getInstance()}})||vN)||vN)||vN);var _N,bN,IN,yN,SN=s("TQME");class CN{constructor(){}static getInstance(){return CN.instance||(CN.instance=new CN),CN.instance}async process(e){return e}}CN.instance=null;let EN=(_N=Tk(Rk.DOWNLOAD_THUMB,(([e,t])=>({params:[e,t]}))),bN=Reflect.metadata("design:type",Function),IN=Reflect.metadata("design:paramtypes",[String,Number]),yN=class{async download(e,t=1/0){const[s,a]=await E.c.catchAsyncFn((()=>this.doDownload(e,t)));return Uk(!!s,s&&this.transformError(s)),a}async doDownload(e,t){const[s,a]=await $zdownload.downloadThumbTemp(e,t);return Uk(s,s),a}transformError(e){return Bk.createFromObject(e)}},Object(Ok.a)(yN.prototype,"download",[_N,bN,IN],Object.getOwnPropertyDescriptor(yN.prototype,"download"),yN.prototype),yN);class ON{constructor(){this.config=void 0,this.logger=void 0,this.logger=a.ModuleContainer.resolve(tN.b).linkParser,this.config=a.ModuleContainer.resolve(Pk.a)}static getInstance(){return ON.instance||(ON.instance=new ON),ON.instance}async process(e){const t=null==e?void 0:e.thumbOrigin;if(t){const s=this.config.get("max_thumb_size"),[a,i]=await E.c.catchAsyncFn((()=>(new EN).download(t,s)));if(a&&this.logger.zsymb(18,"zpfOY8",`Download link failed. Url: ${e.href}. ThumbUrlOrigin: ${t}. Error: ${a}`),i){const t=E.g.clone(e);return t.thumbLocal=i.path,t.thumbMeme=i.meme,t}}return e}}ON.instance=null;var MN,TN,RN,wN,LN=s("vPsb"),DN=s("1+6A"),AN=s("PTkj");class FN{constructor(e){this.localPath=e}async read(){const e=await $zFileManager.getFileArrayBuffer(this.localPath),t=$znode.path.basename(this.localPath);return new File([e],t)}}class kN{constructor(e){this.localPath=e}async compress(){try{const e=await new FN(this.localPath).read(),{blob:t,width:s,height:a,fileName:i}=await Object(AN.e)(e,e.name),n=this.calcNewSize(s,a),r=await Object(jp.a)(t,{quality:.9,width:n.width,height:n.height});return new File([r],i)}catch(e){throw new xk(null==e?void 0:e.message)}}calcNewSize(e,t){const s=Ce.default.file_photo_limit.width,a=Ce.default.file_photo_limit.height;let i=e,n=t;return(e>s||t>a)&&(e-s>t-a?(i=s,n=Math.round(s/e*t)):(n=a,i=Math.round(a/t*e))),{width:i,height:n}}}let NN=(MN=Tk(Rk.UPLOAD_THUMB),TN=Reflect.metadata("design:type",Function),RN=Reflect.metadata("design:paramtypes",[String,String]),wN=class{constructor(){}async upload(e,t){const s=a.ModuleContainer.resolve(tN.b).uploadThumb,[i,n]=await E.c.catchAsyncFn((()=>this.doCompress(e)));Uk(i,i),s.zsymb(12,"vzjdpM","Compress done");const[r,o]=await E.c.catchAsyncFn((()=>this.doUpload(n,t)));Uk(r,r),s.zsymb(12,"13nAwn","Upload done");const[c,l]=this.transformResponse(o);return Uk(c,c),l}async doCompress(e){return await new kN(e).compress()}async doUpload(e,t){try{const s=sN.a.isGroupConv(t),a=sN.a.isE2eeConv(t),i=await vl.b.uploadFile({toUid:t,isGroup:s,rawFile:e,clientId:ul.a.next(),extData:{uploadMainType:DN.c.PhotoThumb,fType:Y.FILE_FTYPE.FILE,e2ee:a},feature:DN.a.SendMsg},{},{signalProgress:()=>{}});return a&&LN.c.enrichEncryptUrlV2(i),i}catch(s){throw this.transformUploadError(s)}}transformUploadError(e){const t=new Gk(`Error: ${JSON.stringify(e)}.`);return null!=e&&e.stack&&t.setStack(null==e?void 0:e.stack),t}transformResponse(e){var t,s,a,i,n,r,o,c;const l=(null==e||null===(t=e.urlRes)||void 0===t||null===(s=t.fileAsync)||void 0===s?void 0:s.oriUrl)||(null==e||null===(a=e.urlRes)||void 0===a||null===(i=a.fileAsync)||void 0===i?void 0:i.hdUrl)||(null==e||null===(n=e.urlRes)||void 0===n||null===(r=n.fileAsync)||void 0===r?void 0:r.normalUrl)||(null==e||null===(o=e.urlRes)||void 0===o||null===(c=o.fileAsync)||void 0===c?void 0:c.thumbUrl);return l?[null,l]:[new Gk(`Cannot get thumbUrl from response. Response ${e}`),null]}},Object(Ok.a)(wN.prototype,"upload",[MN,TN,RN],Object.getOwnPropertyDescriptor(wN.prototype,"upload"),wN.prototype),wN);class PN{constructor(){this.logger=void 0,this.logger=a.ModuleContainer.resolve(tN.b).linkParser}static getInstance(){return PN.instance||(PN.instance=new PN),PN.instance}async process(e,t){const s=null==e?void 0:e.thumbLocal;if(s){const[a,i]=await E.c.catchAsyncFn((()=>(new NN).upload(s,t)));if(a&&this.logger.zsymb(18,"cCOkJu",`Upload link failed. Url: ${e.href}. ConvId: ${t} ThumbUrlLocal: ${s}. Error: ${a}`),i){const t=E.g.clone(e);return t.thumb=i,t}}return e}}var jN;PN.instance=null;Object(a.injectable)()(jN=Object(a.singleton)(SN.a)(jN=class{getDownloadProcessor(e){switch(e){case Nk.b.CLIENT:return ON.getInstance();case Nk.b.SERVER:default:return CN.getInstance()}}getUploadProcessor(e){switch(e){case Nk.b.CLIENT:return PN.getInstance();case Nk.b.SERVER:default:return CN.getInstance()}}})||jN);const UN=Object(a.define)("parser-config-event-emitter");var BN;a.ModuleContainer.registerFactory(UN,yo.f((()=>new Sp.a)));Object(a.injectable)()(BN=Object(a.singleton)(Pk.b)(BN=function(e,t){return Object(a.inject)(UN)(e,void 0,0)}(BN=Reflect.metadata("design:type",Function)(BN=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigEventEmitter?Object:IParserConfigEventEmitter])(BN=class{constructor(e){this.eventEmitter=e,this.config={}}setConfig(e){this.isConfigChange(e)&&(this.config=this.mergeConfig(e),this.eventEmitter.emit("on-config-change",this.config))}mergeConfig(e){return Object(I.a)(Object(I.a)({},this.config),e)}isConfigChange(e){return!new E.g.Comparer(this.config,e,!0).AND("enable_force_parse_link_server").AND("enable_parse_link_server").AND("enable_parse_link_client").AND("enable_auto_download_thumb").AND("enable_parse_link_receiver").AND("enable_parse_link_sender").AND("enable_upload_thumb_for_delay_send").AND("enable_download_partial_media_e2ee").AND("enable_verify_parse_link_server").AND("enable_show_loading_thumb").AND("white_list_domain",rC.a.isEqual).AND("white_list_domain_mode").AND("max_time_reparse").AND("max_thumb_size").AND("max_age_cache_preview").AND("max_item_cache").AND("max_url_character").AND("max_title_character").AND("max_desc_character").AND("max_delay_send_message").AND("max_redirect").AND("debug",rC.a.isEqual).exec()}})||BN)||BN)||BN)||BN);var zN,GN=s("1e0e");const xN={enable_force_parse_link_server:!0,enable_parse_link_server:!0,enable_parse_link_client:!0,enable_auto_download_thumb:!0,enable_parse_link_receiver:!0,enable_parse_link_sender:!1,enable_upload_thumb_for_delay_send:!1,enable_download_partial_media_e2ee:!0,enable_verify_parse_link_server:!1,enable_show_loading_thumb:!0,white_list_domain:[".zalo.me",".zaloapp.com","s120.avatar.talk.zdn.vn","cover.talk.zdn.vn","qr.talk.zdn.vn","f22.w640.photo.talk.zdn.vn","res-zalo.zadn.vn","vng.com.vn","stg-shop.zalo.me",".zingplay.me","zalopay.vn","kaka.me","api-internal.mp3.zalo","zstudio.io","123c.vn","adtimaserver.vn","adtima.vn","ad.zing.vn","baomoi.com","baomoi.vn","brand.zing.vn","chat-talk.zing.vn","click.123.vn","epi.com.vn","epi.vn","kakaapp.me","laban.vn","lab.zing.vn","mp3.zing.vn","m.zing.vn","news.zing.vn","nhatkyzalo.vn","playzing.vn","plo.com.vn","plo.vn","stc-tv.zing.vn","sukien.net.vn","tachthongtin.com","talk.zing.vn","trithuctructuyen.com.vn","trithuctructuyen.vn","tv.zing.vn","xdn.vn","xone.fm","zagoo.vn","zalo.ai","zalo.careers","zalochat.com","zalo.cx","zalo.gg","zalo.me","zalomusic.com","zalonews.net","zaloplus.vn","zalo-shop.vn","zalo.vn","zamoji.vn","zapps.vn","zavatar.vn","zavi.me","za.zdvn.vn","zdn.vn","zingmp3.com","zingmp3.vn","zingnews.com.vn","zingnews.vn","zingtv.vn","zstudio.io","zaloshop.me","dr.zapps.vn","hc.zalo.me"],white_list_domain_mode:"append",max_time_reparse:GN.a.timeInMs("24h"),max_thumb_size:Wk.sizeInByte("2MB"),max_age_cache_preview:GN.a.timeInMs("24h"),max_item_cache:300,max_url_character:500,max_title_character:80,max_desc_character:200,max_delay_send_message:GN.a.timeInMs("2s"),max_redirect:2,debug:{enable_log_metric:!1,delay_parse_client:GN.a.timeInMs("0s")}};Object(a.injectable)()(zN=Object(a.singleton)(Pk.a)(zN=Reflect.metadata("design:type",Function)(zN=Reflect.metadata("design:paramtypes",[])(zN=class{constructor(){this.config=void 0,this.configValidator=void 0,this.config=xN,this.configValidator=new ee.a({enable_force_parse_link_server:ee.b.field().boolean(),enable_parse_link_server:ee.b.field().boolean(),enable_parse_link_client:ee.b.field().boolean(),enable_auto_download_thumb:ee.b.field().boolean(),enable_parse_link_receiver:ee.b.field().boolean(),enable_parse_link_sender:ee.b.field().boolean(),enable_download_partial_media_e2ee:ee.b.field().boolean(),enable_verify_parse_link_server:ee.b.field().boolean(),enable_show_loading_thumb:ee.b.field().boolean(),white_list_domain:ee.b.field().array("string"),white_list_domain_mode:ee.b.field().string().oneOf(["append","override"]),max_time_reparse:ee.b.field().number().min(0),max_thumb_size:ee.b.field().number().min(0),max_age_cache_preview:ee.b.field().number().min(0),max_item_cache:ee.b.field().number().min(0),max_url_character:ee.b.field().number().min(0),max_title_character:ee.b.field().number().min(0),max_desc_character:ee.b.field().number().min(0),max_delay_send_message:ee.b.field().number().min(0),max_redirect:ee.b.field().number().min(0),debug:ee.b.field().object({enable_log_metric:ee.b.field().boolean(),delay_parse_client:ee.b.field().number()})})}get(e,t){var s;return null!==(s=this.config[e])&&void 0!==s?s:t}setConfig(e){const t=this.configValidator.validateWithFallback(e,xN);this.config=Object(I.a)(Object(I.a)(Object(I.a)({},this.config),t),this.mergeWhiteListDomainConfig(t))}mergeWhiteListDomainConfig(e){const t=e.white_list_domain_mode,s=e.white_list_domain,a=this.config.white_list_domain;switch(t){case"append":default:return{white_list_domain:a.concat(s)};case"override":return{white_list_domain:s}}}})||zN)||zN)||zN);a.ModuleContainer.resolve(UN).on("on-config-change",(e=>{a.ModuleContainer.resolve(Pk.a).setConfig(e)}));class VN{constructor(e){this.maxAge=e,this.mapTsItemIsSet=void 0,this.mapTsItemIsSet=new Map}hookBeforeGet(e,t){const s=this.mapTsItemIsSet.get(e);if(!s)return;Date.now()-s>=this.maxAge&&t(e)}hookAfterSet(e){this.mapTsItemIsSet.set(e,Date.now())}hookAfterDelete(e){this.mapTsItemIsSet.delete(e)}hookAfterClear(){this.mapTsItemIsSet.clear()}}class HN{constructor(e){this.maxItem=e,this.mapTsItemIsVisited=void 0,this.mapTsItemIsVisited=new Map}hookBeforeGet(e){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()})}hookAfterSet(e,t){this.mapTsItemIsVisited.set(e,{key:e,ts:Date.now()});let s=Math.max(this.mapTsItemIsVisited.size-this.maxItem,0);if(s>0){Array.from(this.mapTsItemIsVisited.values()).sort(((e,t)=>t.ts>e.ts?-1:0)).slice(0,s).forEach((e=>t(e.key)))}}hookAfterDelete(e){this.mapTsItemIsVisited.delete(e)}hookAfterClear(){this.mapTsItemIsVisited.clear()}}class WN{constructor(...e){this.strategies=void 0,this.repository=void 0,this.repositoryDeadItem=void 0,this.markDeadItem=e=>{const t=this.repository.get(e);t&&(t.isAlive=!1,this.repositoryDeadItem.push(e))},this.strategies=e,this.repository=new Map,this.repositoryDeadItem=[]}get(e){this.beforeGet(e);const t=this.repository.get(e);return t&&t.isAlive?t.value:null}set(e,t){const s={isAlive:!0,key:e,value:t};this.repository.set(e,s),this.afterSet(e)}delete(e){this.repository.delete(e),this.afterDelete(e)}reset(){this.repository.clear(),this.afterClear()}beforeGet(e){this.strategies.forEach((t=>t.hookBeforeGet(e,this.markDeadItem))),this.doGC()}afterSet(e){this.strategies.forEach((t=>t.hookAfterSet(e,this.markDeadItem))),this.doGC()}afterDelete(e){this.strategies.forEach((t=>t.hookAfterDelete(e)))}afterClear(){this.strategies.forEach((e=>e.hookAfterClear()))}doGC(){this.repositoryDeadItem.length&&(this.repositoryDeadItem.forEach((e=>this.delete(e))),this.repositoryDeadItem=[])}}var qN;Object(a.injectable)()(qN=Object(a.singleton)(Ek.c)(qN=function(e,t){return Object(a.inject)(Pk.a)(e,void 0,0)}(qN=Reflect.metadata("design:type",Function)(qN=Reflect.metadata("design:paramtypes",["undefined"==typeof IParserConfigConsumer?Object:IParserConfigConsumer])(qN=class{constructor(e){this.metaData=void 0,this.thumbLocal=void 0,this.thumbLive=void 0;const t=e.get("max_item_cache"),s=e.get("max_age_cache_preview");this.metaData=new WN(new HN(t),new VN(s)),this.thumbLocal=new WN(new HN(t),new VN(s)),this.thumbLive=new WN(new HN(t),new VN(s))}getKey(e,t){switch(e){case"meta-data":case"thumb-local":{const[e]=t;return qf.a.removeProtocol(e)}case"thumb-live":{const[e,s=""]=t;return[sN.a.getPrefixConv(s),sN.a.isE2eeConv(s)?"e2ee":"none-e2ee",qf.a.removeProtocol(e)].join("_")}default:return t.join(".")}}})||qN)||qN)||qN)||qN);var KN,ZN=s("WOja");Object(a.injectable)()(KN=Object(a.singleton)(Ek.b)(KN=function(e,t){return Object(a.inject)(tN.b)(e,void 0,0)}(KN=function(e,t){return Object(a.inject)(Ek.c)(e,void 0,1)}(KN=function(e,t){return Object(a.inject)(Ek.a)(e,void 0,2)}(KN=function(e,t){return Object(a.inject)(Pk.a)(e,void 0,3)}(KN=Reflect.metadata("design:type",Function)(KN=Reflect.metadata("design:paramtypes",[void 0===tN.IParserLogger?Object:tN.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof ILinkParserFactory?Object:ILinkParserFactory,void 0===ZN.IParserConfigConsumer?Object:ZN.IParserConfigConsumer])(KN=class{constructor(e,t,s,a){this.repository=t,this.linkParserFactory=s,this.config=a,this.logger=void 0,this.logger=e.linkParser}parse(e){var t;const s=this.repository.getKey("meta-data",[e]);return(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.value)||null}async preparseAsync(e,t){await this.parseAsync(e,t)}async parseAsync(e,t){if(!this.config.get("enable_parse_link_client")){const e=(null==t?void 0:t.entry)!==Nk.a.SHARE_MESSAGE,s=sN.a.isE2eeConv((null==t?void 0:t.convId)||"");if(e&&s)return null}const s=this.repository.getKey("meta-data",[e]),a=this.repository.metaData.get(s);if(a&&null!==a.value)return a.promise;const i=new E.c.Container;this.repository.metaData.set(s,i);const[n,r]=await E.c.catchAsyncFn((()=>this.linkParserFactory.getLinkParser(e,t).parse(e)));return n&&this.logger.zsymb(18,"YnMvMu",`parse link failed ${n}`),i.resolve(r),i.promise}})||KN)||KN)||KN)||KN)||KN)||KN)||KN);var $N;Object(a.injectable)()($N=Object(a.singleton)(SN.b)($N=function(e,t){return Object(a.inject)(tN.b)(e,void 0,0)}($N=function(e,t){return Object(a.inject)(Ek.c)(e,void 0,1)}($N=function(e,t){return Object(a.inject)(SN.a)(e,void 0,2)}($N=Reflect.metadata("design:type",Function)($N=Reflect.metadata("design:paramtypes",[void 0===tN.IParserLogger?Object:tN.IParserLogger,"undefined"==typeof ILinkPreviewRepository?Object:ILinkPreviewRepository,"undefined"==typeof IPreviewLinkProcessorFactory?Object:IPreviewLinkProcessorFactory])($N=class{constructor(e,t,s){this.repository=t,this.linkProcessorFactory=s,this.logger=void 0,this.logger=e.linkParser}async processDownload(e){var t;const s=this.repository.getKey("meta-data",[e]),a=this.repository.getKey("thumb-local",[e]),i=this.repository.thumbLocal.get(a);if(i&&null!==i.value){if(!i.value)return i.promise;{const e=i.value.thumbLocal;if(e){const[t,s]=await E.c.catchAsyncFn((()=>{var t,s;return null===(t=$znode)||void 0===t||null===(s=t.fsPromise)||void 0===s?void 0:s.stat(e)}));if(!t&&s)return i.promise}}}const n=new E.c.Container;this.repository.thumbLocal.set(a,n);const r=await(null===(t=this.repository.metaData.get(s))||void 0===t?void 0:t.promise)||null,o=await this.linkProcessorFactory.getDownloadProcessor(null==r?void 0:r.typeParse).process(r);return n.resolve(o),n.promise}async processUpload(e,t){var s;const a=this.repository.getKey("thumb-local",[e]),i=this.repository.getKey("thumb-live",[e,t]),n=this.repository.thumbLive.get(i);if(n&&null!==n.value)return n.promise;const r=new E.c.Container;this.repository.thumbLive.set(i,r);const o=await(null===(s=this.repository.thumbLocal.get(a))||void 0===s?void 0:s.promise)||null,c=await this.linkProcessorFactory.getUploadProcessor(null==o?void 0:o.typeParse).process(o,t);return r.resolve(c),r.promise}})||$N)||$N)||$N)||$N)||$N)||$N);class QN{constructor(){}async getDimension(e){const t={key:Date.now(),file:e,srcAction:3},[s,a]=await E.c.catchAsyncFn((()=>uf.default.getDimension(t)));return Uk(s,s&&this.transformError(s)),this.transformResponse(a)}transformError(e){return e}transformResponse(e){return{width:e.width,height:e.height,rotation:e.orientation}}}var YN=s("8I6r"),JN=s("oSk7"),XN=s("taJj");class eP{constructor(){}async download(e){const[t,s]=ui.default.parseE2eeProtocol(e),i=new Headers;if(t){let e="unsafe-flush";a.ModuleContainer.resolve(Pk.a).get("enable_download_partial_media_e2ee")&&(i.set("Range",`bytes=0-${Wk.sizeInByte("64KB")}`),e="safe-flush");const[n,r]=await E.c.catchAsyncFn((()=>fetch(s,{headers:i})));Uk(n,n);const o=new JN.a(r.body).pipe(new XN.a(Wk.sizeInByte("1MB"))).pipe(new tP(new YN.b(t,"decrypt"),e)).getStream();return await new Response(o,{headers:r.headers}).blob()}i.set("Range",`bytes=0-${Wk.sizeInByte("64KB")}`);const[n,r]=await E.c.catchAsyncFn((()=>fetch(e,{headers:i})));return Uk(n,n),await r.blob()}}class tP{constructor(e,t){this.zaes=e,this.modeFlush=t,this.transform=(e,t)=>{const s=this.zaes.update(e);t.enqueue(s)},this.flush=e=>{if("safe-flush"!==this.modeFlush)try{this.zaes.end()}catch(t){e.error(t)}}}}const sP={"image/gif":Y.IMAGE_TYPE_GIF,"image/jpg":Y.IMAGE_TYPE_JPEG,"image/jpeg":Y.IMAGE_TYPE_JPEG,"image/png":Y.IMAGE_TYPE_PNG};class aP{constructor(){}static getInstance(){return aP.instance||(aP.instance=new aP),aP.instance}isMatchParser(e){return Object.keys(sP).includes(e)}async parse(e){const[t,s]=await E.c.catchAsyncFn((()=>(new eP).download(e)));Uk(t,t);const[a,i]=await E.c.catchAsyncFn((()=>(new QN).getDimension(s)));return Uk(a,a),Object(I.a)(Object(I.a)({},i),{},{type:this.transformType(s)})}transformType(e){return sP[e.type]}}aP.instance=null;class iP{constructor(){}static getInstance(){return iP.instance||(iP.instance=new iP),iP.instance}isMatchParser(e){return!0}async parse(e){return null}}iP.instance=null;const nP={"application/pdf":Y.LINK_TYPE_PDF};class rP{constructor(){}static getInstance(){return rP.instance||(rP.instance=new rP),rP.instance}isMatchParser(e){return Object.keys(nP).includes(e)}async parse(e){try{const t=ui.default.removeE2eeProtocol(e),s=(await fetch(t,{method:"HEAD"})).headers.get("content-length");return null===s?null:{size:Number(s),name:qf.a.getFileNameFromUrl(e),type:nP["application/pdf"]}}catch(t){throw t}}}var oP;rP.instance=null;Object(a.singleton)(Ek.d)(oP=class{async getSizeParser(e){const[t,s]=await E.c.catchAsyncFn((()=>this.tryGetContentType(e)));return t||!s?iP.getInstance():aP.getInstance().isMatchParser(s)?aP.getInstance():rP.getInstance().isMatchParser(s)?rP.getInstance():iP.getInstance()}async tryGetContentType(e){if(!qf.a.isBlobUrl(e)){const[t,s]=await E.c.catchAsyncFn((()=>this.tryGetContentTypeByHead(e)));if(!t)return s}return this.tryGetContentTypeByGet(e)}async tryGetContentTypeByHead(e){const t=ui.default.removeE2eeProtocol(e);return(await fetch(t,{method:"HEAD"})).headers.get("content-type")}async tryGetContentTypeByGet(e){const t=ui.default.removeE2eeProtocol(e),s=new AbortController,a=await fetch(t,{signal:s.signal});s.abort();return a.headers.get("content-type")}});var cP;Object(a.injectable)()(cP=Object(a.singleton)(Ek.e)(cP=function(e,t){return Object(a.inject)(tN.b)(e,void 0,0)}(cP=function(e,t){return Object(a.inject)(Ek.d)(e,void 0,1)}(cP=Reflect.metadata("design:type",Function)(cP=Reflect.metadata("design:paramtypes",[void 0===tN.IParserLogger?Object:tN.IParserLogger,"undefined"==typeof ISizeParserFactory?Object:ISizeParserFactory])(cP=class{constructor(e,t){this.sizeParserFactory=t,this.cache=void 0,this.cacheDedupe=void 0,this.logger=void 0,this.cache=new WN(new HN(300)),this.logger=e.mediaSizeLogger,this.cacheDedupe=new Map}parse(e){const t=this.getCacheKey(e);return this.cache.get(t)}async preparseAsync(e){await E.c.catchAsyncFn((()=>this.parseAsync(e)))}async parseAsync(e){const t=this.getCacheKey(e),s=this.cache.get(t);if(s)return s;const a=this.cacheDedupe.get(t);if(a)return a;const i=(await this.sizeParserFactory.getSizeParser(e)).parse(e);this.cacheDedupe.set(t,i);const[n,r]=await E.c.catchAsyncFn((()=>i));return this.cacheDedupe.delete(t),Uk(null!==n,n),null===r?null:(this.cache.set(t,r),r)}getCacheKey(e){return e}})||cP)||cP)||cP)||cP)||cP);var lP,dP=s("2fgy"),uP=s("dG4g"),hP=s("DBGg"),gP=s("bGlS");Object(xi.b)(dP.b)(lP=Object(a.injectable)()(lP=Reflect.metadata("design:type",Function)(lP=Reflect.metadata("design:paramtypes",[])(lP=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=void 0,this.currentConvId=void 0,this.name=dP.a,this.key=dP.a,this.data={list:new gu.a(Object(DL.a)().MAX_CONVERSATION_QUEUE_SIZE),photoViewData:void 0}}initialize(){}destroy(){}async onChangeMessages(e,t,s,a){this.currentConvId=e;const i={};t.forEach((e=>{let t=_o.default.isGroupPhoto(e);Object(uP.b)(e)&&(i[e.msgId]=t&&uT.a.getInstance().getGroupId(null!=a?a:"1",Object(fe.i)(e))||"")})),await this.getDataFromCache(i,s)}onChangeReactionDataList(e,t,s){const a=(new Date).getTime(),i=a.toString();Object(nc.j)(i),e.forEach(((e,n)=>{var r,o,c;const l=null===(r=this.getCurrentDataOfConversation())||void 0===r?void 0:r.get(n);if((null===(o=this.data.photoViewData)||void 0===o?void 0:o.rMsgId)===n&&(this.data.photoViewData=Object(I.a)(Object(I.a)({},this.data.photoViewData),e),Object(nc.g)(i,this.name,gP.a)),!s&&!l)return;const d=Object.keys((null==l?void 0:l.reactions)||{}).length>Object.keys((null==e?void 0:e.reactions)||{}).length,u=!t||Object(hP.a)(e.reactions)||d?0:a,h=Object(I.a)(Object(I.a)(Object(I.a)({},l),e),{},{lastUpdateEffects:u});null===(c=this.getCurrentDataOfConversation())||void 0===c||c.set(n,h);const g=null==h?void 0:h.groupPhotoMsgId;var m;g?(null===(m=this.getCurrentDataOfConversation())||void 0===m||m.set(g,{isGroupPhotoMsg:!0,groupPhotoMsgId:g,lastUpdate:a,lastUpdateEffects:u}),Object(nc.g)(i,this.name,g),Object(nc.g)(i,this.name,n)):Object(nc.g)(i,this.name,n)})),Object(nc.c)(i)}getReactedListFromMessage(e,t){if(t){if(!e.msgId||!this.data.photoViewData)return{};const t=new Map;return t.set(e.msgId,this.data.photoViewData),Object(uP.d)(e,t)}return Object(uP.d)(e,this.getCurrentDataOfConversation())}removeReactionDataFromList(e){var t,s;if(!e.msgId)return;const a=null===(t=this.getCurrentDataOfConversation())||void 0===t?void 0:t.get(e.msgId);var i;null!=a&&a.isGroupPhotoMsg&&(null===(i=this.getCurrentDataOfConversation())||void 0===i||i.forEach(((t,s)=>{var a;t.groupPhotoMsgId===e.msgId&&(null===(a=this.getCurrentDataOfConversation())||void 0===a||a.delete(s))})));null===(s=this.getCurrentDataOfConversation())||void 0===s||s.delete(e.msgId)}async onChangePhotoViewData(e){if(!e.msgId)return;const t=[e.msgId],s=await rh.b.get(t);s&&(this.data.photoViewData=s[e.msgId],Object(nc.h)(this.name,gP.a))}removePhotoViewData(){this.data.photoViewData=void 0}async resyncReactionData(){}async getDataFromCache(e,t){const s=Object.keys(e),a=await rh.b.get(s);if(!a)return;const i=new Map;for(const n in a)i.set(n,Object(I.a)(Object(I.a)({},a[n]),{},{groupPhotoMsgId:e[n]}));this.onChangeReactionDataList(i,!1,!0),null==t||t(Object.keys(a))}getCurrentDataOfConversation(){if(this.currentConvId)return this.data.list.get(this.currentConvId)||this.data.list.push(this.currentConvId,new Map),this.data.list.get(this.currentConvId)}clearData(e){this.data.list.delete(e)}clearAllData(){this.data.list.clearAll(),this.data.photoViewData=void 0}getData(e){var t;return null===(t=this.getCurrentDataOfConversation())||void 0===t?void 0:t.get(e)}getLastUpdateEffects(e,t){var s;return null===(s=this.getData(t||e))||void 0===s?void 0:s.lastUpdateEffects}setLastUpdateEffects(e,t){const s=this.getData(t||e);var a;s&&(null===(a=this.getCurrentDataOfConversation())||void 0===a||a.set(t||e,Object(I.a)(Object(I.a)({},s),{},{lastUpdateEffects:0})))}getItem(e,t){var s;return e.key===gP.a?this.data.photoViewData:null===(s=this.getCurrentDataOfConversation())||void 0===s?void 0:s.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||lP)||lP)||lP);var mP,pP=s("VhZi");function fP(e){return e||gP.b.windowId}Object(xi.b)(pP.b)(mP=Object(a.injectable)()(mP=Object(a.singleton)()(mP=Reflect.metadata("design:type",Function)(mP=Reflect.metadata("design:paramtypes",[])(mP=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data=new Map,this.name=pP.a,this.key=pP.a}initialize(e){const t=fP(e);Ie.ModalManagerV2.addModal({windowId:t,name:gP.b.name,altWindowId:void 0}),Ie.ModalManagerV2.subscribeTriggers({windowId:t,name:gP.b.name,trigger:e=>{}}),this.data.set(t,{message:void 0})}destroy(e){const t=fP(e);this.data.delete(t),Ie.ModalManagerV2.delModal({windowId:t,name:gP.b.name})}toggleReactionPopup(e,t){const s=fP(e);this.data.set(s,{message:t}),t?Ie.ModalManagerV2.openModal(Object(I.a)(Object(I.a)({},gP.b),{},{windowId:s,params:null})):Ie.ModalManagerV2.closeModal(Object(I.a)(Object(I.a)({},gP.b),{},{windowId:s})),Object(nc.h)(this.name,s)}getItem(e,t){return this.data.get(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||mP)||mP)||mP)||mP);var vP=s("NmZm"),_P=s("66W5"),bP=s("xU41");var IP;Object(a.injectable)()(IP=Object(a.singleton)()(IP=Object(xi.b)(vP.b)(IP=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(IP=Reflect.metadata("design:type",Function)(IP=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(IP=class{constructor(e){this.type=void 0,this.key=_P.c,this.name=vP.a,this._chatBoxInputDOMMap=new Map,this._chatBoxInputStateMap=new Map,this._logger=void 0,this._logger=e.createZLogger(w.ZLoggerNametags.cbiController,[w.ZLoggerNametags.controllCbi])}init(){}getItem(e,t){if((s=e.key)&&s.startsWith(_P.c))return this._getChatBoxInputState(e.key);var s}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"AzkntW",["[onGetItemFailure] key: {}, error: {}","_BBweL"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"OFmnwT",["[onGetListFailure] key: {}, error: {}","HWSk9R"],e,t.message)}setChatInputType(e,t,s,a=!0){if(!e||!t)return this._logger.zsymb(21,"XuXKUP",["[setChatInputType] {} or {} isn't valid!","SvRRF9"],e,t);if(!s)return this._logger.zsymb(21,"FfE0GB",["[setChatInputType] chatInputType isn't existed!","WUr5Ob"]);let i=this._getChatBoxInputState(Object(bP.a)(e,t));const n=Object(rm.a)(i,(e=>{e.chatInputType=Object(I.a)({},s)}));this._chatBoxInputStateMap.set(Object(bP.a)(e,t),n),a&&n!==i&&Object(nc.h)(this.name,Object(bP.a)(e,t))}getChatInputType(e,t){return this._getChatBoxInputState(Object(bP.a)(e,t)).chatInputType}getDefaultChatInputType(){return{name:_P.g.NORMAL,info:{}}}getChatInputTypeInfo(e,t){return this._getChatBoxInputState(Object(bP.a)(e,t)).chatInputType.info}getChatInputTypeName(e,t){return this._getChatBoxInputState(Object(bP.a)(e,t)).chatInputType.name}bindChatInputScroller(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputScroller=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatInputContent(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatInputContent=t,this._chatBoxInputDOMMap.set(e,s)}}bindChatBoxInputContainer(e){return t=>{const s=this._getChatBoxInputDOM(e);s.chatBoxInputContainer=t,this._chatBoxInputDOMMap.set(e,s)}}getChatInputScroller(e,t){if(e){var s;return null!==(s=this._getChatBoxInputDOM(e).chatInputScroller)&&void 0!==s?s:null==t?void 0:t.document.getElementById(_P.f)}return null}getChatInputContent(e){if(e){return this._getChatBoxInputDOM(e).chatInputContent}return null}getChatBoxInputContainer(e){if(e){return this._getChatBoxInputDOM(e).chatBoxInputContainer}return null}_getChatBoxInputState(e){let t=this._chatBoxInputStateMap.get(e);return t||(t=this._getDefaultChatBoxInputState(),this._chatBoxInputStateMap.set(e,t)),t}_getDefaultChatBoxInputState(){return{chatInputType:this.getDefaultChatInputType()}}_getChatBoxInputDOM(e){let t=this._chatBoxInputDOMMap.get(e);return t||(t=this._getDefaultChatBoxInputDOM(),this._chatBoxInputDOMMap.set(e,t)),t}_getDefaultChatBoxInputDOM(){return{chatBoxInputContainer:null,chatInputScroller:null,chatInputContent:null}}})||IP)||IP)||IP)||IP)||IP);var yP=s("/ApO"),SP=s("DIKB"),CP=s("/wiu"),EP=s("WJhq");function OP(e,t){var s,a;const i=null!==(s=t.duration)&&void 0!==s?s:0,n=null!==(a=t.easing)&&void 0!==a?a:"ease",r=t.animId;return e.animate([{height:t.fromHeight},{height:t.toHeight}],{id:r,duration:i,fill:t.fill,easing:n})}var MP=s("gn4y");let TP=function(e){return e.NORMAL_TO_RTF="normal-to-rtf",e.RTF_TO_NORMAL="rtf-to-normal",e.MINI_TO_EXPAND="mini-to-expand",e.EXPAND_TO_MINI="expand-to-mini",e.RESIZE_WHEN_WINDOW_RESIZE="resize-when-window-resize",e.FADE_IN_RTF_TOOLBAR="fade-in-rtf-toolbar",e.FADE_OUT_RTF_TOOLBAR="fade-out-rtf-toolbar",e}({});var RP,wP=s("dZd7");const LP=new De.a(0);Object(a.injectable)()(RP=Object(a.singleton)(yP.a)(RP=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(RP=Reflect.metadata("design:type",Function)(RP=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(RP=class{constructor(e){this._chatBoxInputAnimsMap=new Map,this._logger=void 0,this._isDevelopment=void 0,this._logger=e.createZLogger(w.ZLoggerNametags.cbiAnimationController,[w.ZLoggerNametags.manageCBIAnimation]),this._isDevelopment=!1}applyChatInputType(e,t,s){this._isDevelopment&&this._logger.zsymb(0,"G1spEW","(@=@)! >>>applyChatInputType<<<");const{windowId:a,convId:i,selfWindow:n,hasAnim:r}=s;if(this._isDevelopment&&this._logger.zsymb(3,"R2y-ef",["from: {} to: {}","VxCwBa"],JSON.stringify(e),JSON.stringify(t)),CP.e(e,t)){if(CP.d(t))return this.switchNormalModeToRTFMode(a,i,n,r);if(CP.c(t))return this.switchRTFModeToNormalMode(a,i,n,r)}else if(CP.c(e)&&CP.d(t)){if(t.info.mode===_P.h.MINI)return this.switchNormalModeToRTFMode(a,i,n,r);t.info.mode,_P.h.EXPAND}else{if(CP.d(e)&&CP.c(t))return this.switchRTFModeToNormalMode(a,i,n,r);if(CP.d(e)&&CP.d(t)){if(e.info.mode===_P.h.EXPAND&&t.info.mode===_P.h.MINI)return this.switchExpandModeToMiniModeInRTFMode(a,i,n,r);if(e.info.mode===_P.h.MINI&&t.info.mode===_P.h.EXPAND)return this.switchMiniModeToExpandModeInRTFMode(a,i,n,r)}}this._isDevelopment&&this._logger.zsymb(3,"8trl53",["Do not support this case!","j21U8i"])}switchNormalModeToRTFMode(e,t,s,a=!0){if(this._isDevelopment&&this._logger.zsymb(0,"PcQDI9","(@=@)! >>>switchNormalModeToRTFMode<<<"),!e||!t)return;const i=null!=s?s:K.default.getWindow(e);if(!Object(MP.a)(!!i,"window isn't existed."))return;const n=this._getChatInputContainerEl(i);if(!Object(MP.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(i);if(!Object(MP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=()=>{n.classList.add("--rtf-mode","--rtf-mini-mode"),r.classList.add("--visible"),this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.RTF,info:{mode:_P.h.MINI}})};if(this._cancelAllAnimation(e,!0),!a)return o();const c=n.clientHeight,l=Math.round(2*EP.c.PADDING_TOP_BOTTOM+5.5*EP.e+EP.g+EP.b);this._isDevelopment&&this._logger.zsymb(3,"1VGZ5K",["heights: {} {}","2b2yft"],c,l);let d=this._getTransitionDuration(l,c);if(this._isDevelopment&&this._logger.zsymb(3,"SJOnPH",["duration: {}","kocSHu"],d),d>0){const s=this._getChatInputContentEl(i);if(!Object(MP.a)(!!s,"chatInputContentEl isn't existed."))return;const a=s.clientHeight/EP.e>=2;a||n.classList.add("--animate-from-smallest-height"),n.classList.add("--rtf-mode");const o=OP(n,{animId:`${TP.NORMAL_TO_RTF}::${LP.next()}`,duration:d,easing:"ease",fromHeight:`${c}px`,toHeight:`${l}px`});this._setAnimationById(e,o.id,o),o.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"EL7tQm",["finished: {}","jCgWDV"],o.id),a||n.classList.remove("--animate-from-smallest-height"),n.classList.add("--rtf-mini-mode"),o.cancel()},o.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"-gOb8A",["canceled: {}","UboCDU"],o.id),a||n.classList.remove("--animate-from-smallest-height"),n.classList.add("--rtf-mini-mode"),this._deleteAnimationById(e,o.id),this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.RTF,info:{mode:_P.h.MINI}})};const u=function(e,t){var s,a,i;const n=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(a=t.delay)&&void 0!==a?a:0;return e.animate([{opacity:0},{opacity:1}],{id:n,duration:r,fill:t.fill,delay:o,easing:null!==(i=t.easing)&&void 0!==i?i:"ease"})}(r,{animId:`${TP.FADE_IN_RTF_TOOLBAR}::${LP.next()}`,duration:d,easing:"ease"});this._setAnimationById(e,u.id,u),u.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"zXSqiY",["finished: {}","jCgWDV"],u.id),r.classList.add("--visible"),u.cancel()},u.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"vgyAuT",["canceled: {}","UboCDU"],u.id),r.classList.add("--visible"),this._deleteAnimationById(e,u.id)},this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.SWITCHING,info:{inputType:_P.g.RTF,from:_P.g.NORMAL,to:_P.g.RTF}})}else o()}switchRTFModeToNormalMode(e,t,s,a=!0){if(this._isDevelopment&&this._logger.zsymb(0,"Ov6aLN","(@=@)! >>>switchRTFModeToNormalMode<<<"),!e||!t)return;const i=null!=s?s:K.default.getWindow(e);if(!Object(MP.a)(!!i,"window isn't existed."))return;const n=this._getChatInputContainerEl(i);if(!Object(MP.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(i);if(!Object(MP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(i);if(!Object(MP.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const c=()=>{n.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.NORMAL,info:{}})};if(this._cancelAllAnimation(e,!0),!a)return c();const l=this._getChatInputContentEl(i);if(!Object(MP.a)(!!l,"chatInputContentEl isn't existed."))return;const d=l.clientHeight,u=n.clientHeight,h=d/EP.e>=2;let g=EP.c.SMALLEST_HEIGHT_IN_NORMAL,m=!1;h||(n.classList.add("--simple-normal-mode"),m=l.clientHeight/EP.e>=2,n.classList.remove("--simple-normal-mode")),g=h||m?Math.round((d>EP.d.NORMAL.MAX?EP.d.NORMAL.MAX:d)+EP.g+2*EP.c.PADDING_TOP_BOTTOM+EP.b):EP.c.SMALLEST_HEIGHT_IN_NORMAL,this._isDevelopment&&this._logger.zsymb(3,"AkoWKT",["heights: {} {}","2b2yft"],u,g);let p=this._getTransitionDuration(g,u);if(this._isDevelopment&&this._logger.zsymb(3,"gmPw57",["duration: {}","kocSHu"],p),p>0){h||m||n.classList.add("--animate-to-smallest-height"),n.classList.add("--switching-rtf-to-normal-mode"),n.classList.remove("--rtf-mode","--rtf-mini-mode"),r.classList.remove("--visible"),o.style.height="";const s=OP(n,{animId:`${TP.RTF_TO_NORMAL}::${LP.next()}`,duration:p,easing:"ease",fromHeight:`${u}px`,toHeight:`${g}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"vzVH2j",["finished: {}","jCgWDV"],s.id),n.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"Ipt0Nt",["canceled: {}","UboCDU"],s.id),n.classList.remove("--switching-rtf-to-normal-mode","--animate-to-smallest-height"),this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.NORMAL,info:{}}),this._deleteAnimationById(e,s.id)};const a=function(e,t){var s,a,i;const n=t.animId,r=null!==(s=t.duration)&&void 0!==s?s:0,o=null!==(a=t.delay)&&void 0!==a?a:0;return e.animate([{opacity:1},{opacity:0}],{id:n,duration:r,fill:t.fill,delay:o,easing:null!==(i=t.easing)&&void 0!==i?i:"ease"})}(r,{animId:`${TP.FADE_OUT_RTF_TOOLBAR}::${LP.next()}`,duration:Math.max(p-50,0),easing:"ease-in"});this._setAnimationById(e,a.id,a),a.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"ZpCPgO",["finished: {}","jCgWDV"],a.id),a.cancel()},a.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"dNQkgB",["canceled: {}","UboCDU"],a.id),this._deleteAnimationById(e,a.id)},this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.SWITCHING,info:{inputType:_P.g.NORMAL,from:_P.g.RTF,to:_P.g.NORMAL}})}else c()}switchMiniModeToExpandModeInRTFMode(e,t,s,a=!0){var i,n;if(this._isDevelopment&&this._logger.zsymb(0,"HKQE1L","(@=@)! >>>switchMiniModeToExpandModeInRTFMode<<<"),!e||!t)return;const r=null!=s?s:K.default.getWindow(e);if(!Object(MP.a)(!!r,"window isn't existed."))return;const o=this._getChatInputContainerEl(r);if(!Object(MP.a)(!!o,"chatInputContainerEl isn't existed."))return;const c=this._getRTFToolbarEl(r);if(!Object(MP.a)(!!c,"rtfToolbarEl isn't existed."))return;const l=this._getChatBoxInputContainerEl(r);if(!Object(MP.a)(!!l,"chatBoxInputContainerEl isn't existed."))return;let d=l.clientHeight,u=Math.round((null!==(i=null===(n=this._getChatViewEl(r))||void 0===n?void 0:n.clientHeight)&&void 0!==i?i:0)*EP.a);const h=()=>{o.classList.replace("--rtf-mini-mode","--rtf-expand-mode"),l.style.height=`${u}px`,this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.RTF,info:{mode:_P.h.EXPAND}})};if(this._cancelAllAnimation(e,!0),!a)return h();d>=u&&(u=d),this._isDevelopment&&this._logger.zsymb(3,"QcnzSM",["heights: {} {}","2b2yft"],d,u);let g=this._getTransitionDuration(u,d);if(this._isDevelopment&&this._logger.zsymb(3,"XyJcc8",["duration: {}","kocSHu"],g),g>0){this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.SWITCHING,info:{inputType:_P.g.RTF,from:_P.h.MINI,to:_P.h.EXPAND}}),o.classList.replace("--rtf-mini-mode","--rtf-expand-mode");const s=OP(l,{animId:`${TP.MINI_TO_EXPAND}::${LP.next()}`,duration:g,fromHeight:`${d}px`,toHeight:`${u}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"65sYdc",["finished: {}","jCgWDV"],s.id),l.style.height=`${u}px`,s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"criG-u",["canceled: {}","UboCDU"],s.id),l.style.height=`${u}px`,this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.RTF,info:{mode:_P.h.EXPAND}})}}else h()}switchExpandModeToMiniModeInRTFMode(e,t,s,a=!0){if(this._isDevelopment&&this._logger.zsymb(0,"LZ04uv","(@=@)! >>>switchExpandModeToMiniModeInRTFMode<<<"),!e||!t)return;const i=null!=s?s:K.default.getWindow(e);if(!Object(MP.a)(!!i,"window isn't existed."))return;const n=this._getChatInputContainerEl(i);if(!Object(MP.a)(!!n,"chatInputContainerEl isn't existed."))return;const r=this._getRTFToolbarEl(i);if(!Object(MP.a)(!!r,"rtfToolbarEl isn't existed."))return;const o=this._getChatBoxInputContainerEl(i);if(!Object(MP.a)(!!o,"chatBoxInputContainerEl isn't existed."))return;const c=()=>{n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.RTF,info:{mode:_P.h.MINI}})};if(this._cancelAllAnimation(e,!0),!a)return c();const l=o.clientHeight,d=n.clientHeight,u=Math.round(l-d+EP.d.RTF.MIN+EP.g+2*EP.c.PADDING_TOP_BOTTOM+EP.b);this._isDevelopment&&this._logger.zsymb(3,"pKS-QL",["heights: {} {}","2b2yft"],l,u);let h=this._getTransitionDuration(u,l);if(this._isDevelopment&&this._logger.zsymb(3,"rIT8Cw",["duration: {}","kocSHu"],h),h>0){this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.SWITCHING,info:{inputType:_P.g.RTF,from:_P.h.EXPAND,to:_P.h.MINI}});const s=OP(o,{animId:`${TP.EXPAND_TO_MINI}::${LP.next()}`,duration:h,fromHeight:`${l}px`,toHeight:`${u}px`});this._setAnimationById(e,s.id,s),s.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"-TXsw-",["finished: {}","jCgWDV"],s.id),n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",s.cancel()},s.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"uAGa1Z",["canceled: {}","UboCDU"],s.id),n.classList.replace("--rtf-expand-mode","--rtf-mini-mode"),o.style.height="",this._deleteAnimationById(e,s.id),this._chatBoxInputController.setChatInputType(e,t,{name:_P.g.RTF,info:{mode:_P.h.MINI}})}}else c()}resizeChatBoxInputWhenWindowResize(e,t,s=!0){var a,i;if(this._isDevelopment&&this._logger.zsymb(0,"P7KTCD","(@=@)! >>>resizeChatBoxInputWhenWindowResize<<<"),!e)return;const n=null!=t?t:K.default.getWindow(e);if(!Object(MP.a)(!!n,"window isn't existed."))return;const r=this._getChatBoxInputContainerEl(n);if(!Object(MP.a)(!!r,"chatBoxInputContainerEl isn't existed."))return;const o=r.clientHeight,c=Math.round((null!==(a=null===(i=this._getChatViewEl(n))||void 0===i?void 0:i.clientHeight)&&void 0!==a?a:0)*EP.a),l=()=>{r.style.height=`${c}px`};if(this._cancelAllAnimation(e,!0),!s)return l();this._isDevelopment&&this._logger.zsymb(3,"ssPp1o",["heights: {} {}","2b2yft"],o,c);let d=this._getTransitionDuration(c,o);if(this._isDevelopment&&this._logger.zsymb(3,"Rz1FZV",["duration: {}","kocSHu"],d),d>0){const t=OP(r,{animId:`${TP.RESIZE_WHEN_WINDOW_RESIZE}::${LP.next()}`,duration:d,fromHeight:`${o}px`,toHeight:`${c}px`});this._setAnimationById(e,t.id,t),t.onfinish=()=>{this._isDevelopment&&this._logger.zsymb(3,"T3KI8N",["finished: {}","jCgWDV"],t.id),r.style.height=`${c}px`,t.cancel()},t.oncancel=()=>{this._isDevelopment&&this._logger.zsymb(3,"Ns4L0q",["canceled: {}","UboCDU"],t.id),r.style.height=`${c}px`,this._deleteAnimationById(e,t.id)}}else l()}get _chatBoxInputController(){return a.ModuleContainer.resolve(SP.a)}_getChatInputContainerEl(e){return e.document.getElementById(_P.d)}_getRTFToolbarEl(e){return e.document.getElementById(_P.i)}_getChatBoxInputContainerEl(e){return e.document.getElementById(_P.b)}_getChatInputContentEl(e){return e.document.getElementById(_P.f)}_getChatViewEl(e){return e.document.getElementById(EP.f)}_getTransitionDuration(e=0,t=0){if(!e||e<=0||!t||t<=0)return 0;const s=Object(wP.a)(),a=Math.abs(e-t);return a<=1?0:Math.round(s*Math.log(a))}_getAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);if(s)return s[t]}_setAnimationById(e,t,s){if(!e||!t||!s)return;let a=this._chatBoxInputAnimsMap.get(e);a||(a={}),a[t]=s,this._chatBoxInputAnimsMap.set(e,a)}_deleteAnimationById(e,t){const s=this._chatBoxInputAnimsMap.get(e);s&&(delete s[t],this._chatBoxInputAnimsMap.set(e,s))}_cancelAnimation(e,t,s=!1){let a=this._chatBoxInputAnimsMap.get(e);if(!a)return;a=Object(I.a)({},a);const i=a[t];i&&(i.cancel(),s&&(delete a[t],this._chatBoxInputAnimsMap.set(e,a)))}_cancelAllAnimation(e,t=!1){const s=this._chatBoxInputAnimsMap.get(e);if(s&&0!==Object.keys(s).length){for(const e in s){var a;if(s[e])null===(a=s[e])||void 0===a||a.cancel(),t&&delete s[e]}this._chatBoxInputAnimsMap.set(e,s)}}})||RP)||RP)||RP)||RP);var DP=s("CkSj"),AP=s("uUhV"),FP=s("I9t9");const kP="qrw",NP=`${kP}__extension`,PP=`${kP}__main`,jP=`${PP}--bd`,UP=`${PP}--content`,BP=`${UP}--c`,zP=`${UP}__title`,GP=`${UP}__desc`,xP=`${UP}__act`,VP=`${kP}__step`,HP=`${VP}--slider`,WP=`${VP}--indicator-c`,qP=`${VP}--indicator`,KP=`${VP}--content`,ZP=`${KP}--c`,$P=`${KP}__title`,QP=`${KP}__desc`,YP=`${KP}__act`;var JP=s("aUrs"),XP=s("/3IL");const ej=["className","style","children","noWrap"];function tj(e){const{className:t,style:s,children:a,noWrap:i=!1}=e,n=Object($i.a)(e,ej),r=Object(PC.a)(t,"flx",i?"flex-nowrap":"flex-wrap");return Mr.a.createElement("div",Object(gC.a)({},n,{className:r,style:s}),a)}tj.propTypes={className:NC.a.string,style:NC.a.object,noWrap:NC.a.bool};var sj=tj,aj=s("h/gz"),ij=s("UUop");function nj(e){const{onClick:t}=e;return Mr.a.createElement(XP.a,{className:PP},Mr.a.createElement(XP.a,{className:jP},Mr.a.createElement("img",{src:"assets/quick-reply-welcome-backdrop.6662d0752f1924cff174a9a07123f9e3.svg",alt:"welcome"})),Mr.a.createElement(XP.a,{className:UP},Mr.a.createElement(XP.a,{className:BP},Mr.a.createElement(XP.a,{className:zP},Mr.a.createElement(Rr.a,{textKey:"STR_TITLE_QUICK_MESSAGES"})),Mr.a.createElement(XP.a,{className:GP},Mr.a.createElement(Rr.a,{textKey:"STR_QR_WELCOME_MAIN"})),Mr.a.createElement(XP.a,{className:xP},Mr.a.createElement(sj,null,Mr.a.createElement(wr.a,{className:"w-100",type:"primary",size:"medium",onClick:()=>{Object(ij.b)(ij.a.Welcome.CLICK_LEARN_MORE),Object(aj.n)(t)()}},Mr.a.createElement(Rr.a,{textKey:"STR_LEARN_MORE"})))))))}nj.propTypes={onClick:NC.a.func};var rj=nj;const oj="One",cj="Two";function lj(e){const{onComplete:t}=e,[s,a]=Object(Or.useState)(oj),i=Object(qw.b)();let n=null;return"vi"===i?n=s===oj?"assets/QM_Guide_Vi_1.85c6702df7df6f98bdfc2f7a2933c807.gif":"assets/QM_Guide_Vi_2.ef56a79e86131f474069999be3d6c90e.gif":"en"===i&&(n=s===oj?"assets/QM_Guide_En_1.f24dd518213dc12288c678ce20fb006f.gif":"assets/QM_Guide_En_2.4b0370616555dffd006442bb44328358.gif"),Mr.a.createElement(XP.a,{className:VP},Mr.a.createElement(XP.a,{className:HP},Mr.a.createElement("img",{src:n,alt:"Tip"})),Mr.a.createElement(XP.a,{className:KP},Mr.a.createElement(XP.a,{className:WP},Mr.a.createElement(sj,{className:qP},Mr.a.createElement(eE.a,{className:"red_dot "+(s===oj?"active":"")}),Mr.a.createElement(eE.a,{className:"red_dot "+(s===cj?"active":"")}))),Mr.a.createElement(XP.a,{className:ZP},Mr.a.createElement(XP.a,{className:$P},Mr.a.createElement(Rr.a,{textKey:ce.a.trans("STR_STEP",[""+(s===oj?"1":"2"),"2"])})),Mr.a.createElement(XP.a,{className:QP},Mr.a.createElement(Rr.a,{textKey:""+(s===oj?"STR_CLICK":"STR_TYPE_TO")}),Mr.a.createElement(Rr.a,{className:`${QP}--bold`,textKey:""+(s===oj?"STR_MANAGE":"/")}),Mr.a.createElement(Rr.a,{textKey:""+(s===oj?"STR_QR_WELCOME_STEP_1":"STR_QR_WELCOME_STEP_2")}),"."),Mr.a.createElement(XP.a,{className:YP},Mr.a.createElement(sj,{className:`${YP}${s===oj?"--end":"--bw"}`},s===cj?Mr.a.createElement(wr.a,{type:"neutral",size:"medium",onClick:()=>{s===cj&&a(oj)}},Mr.a.createElement(Rr.a,{textKey:""+(s===oj?"STR_SKIP":"STR_BACK")})):null,Mr.a.createElement(wr.a,{className:"ml-8",type:"primary",size:"medium",onClick:()=>{s===oj?a(cj):s===cj&&(Object(ij.b)(ij.a.Welcome.CLICK_COMPLETE),Object(aj.n)(t)())}},Mr.a.createElement(Rr.a,{textKey:""+(s===oj?"STR_CONTINUE":"STR_DONE_2")})))))))}lj.propTypes={onComplete:NC.a.func};var dj=lj;function uj(e,t){const{windowContainer:s,onReject:a,onSkip:i,windowId:n}=e,r=[{textKey:"STR_QM_SKIP",onclick:i},{type:Qy.MENU_ITEM_TYPE.SEPARATE},{textKey:"STR_QM_OFF_FEATURE",onclick:a}];return Mr.a.createElement(Qy.default,{ref:t,items:r,popoverProps:{identity:{windowId:n,name:Y.PopoverIdentitiesDefine.QM_WELCOME_EXT_MENU},placement:"bottom-right",windowContainer:s}})}const hj=Object(Or.forwardRef)(uj);hj.propTypes={windowContainer:NC.a.node,onReject:NC.a.func,onSkip:NC.a.func,windowId:NC.a.string};var gj=hj,mj=s("oBev"),pj=s("WvqV"),fj=s("Jmku");const vj={MAIN:"Main",STEP:"Step"},_j=Y.PopoverIdentitiesDefine.QM_WELCOME;function bj(e){const{anchor:t,eventHandler:s,isOpen:a,initMode:i,onCompleteWelcome:n,onClosePopover:r,windowId:o}=e,c=Object.values(vj).indexOf(i)>-1,[l,d]=Object(Or.useState)(c&&i||vj.MAIN),u=Object(Or.useRef)(null),h=()=>{d(vj.STEP)},g=()=>{Object(aj.e)(),Object(aj.n)(n)()},m=()=>{g()};if(Object(Or.useEffect)((()=>{const e={windowId:o,name:_j},t=()=>{Object(aj.n)(r)()};return fj.a.on("beforeClose",e,t),()=>{fj.a.removeListener("beforeClose",e,t)}}),[]),Object(Or.useEffect)((()=>{a&&(Object(ij.b)(ij.a.Welcome.SHOW),Object(pj.b)(o,_j))}),[a]),!a)return null;let p;p=l===vj.MAIN?Mr.a.createElement(rj,{onClick:h}):l===vj.STEP?Mr.a.createElement(dj,{onComplete:m}):null;const f=Mr.a.createElement(Mr.a.Fragment,null,Mr.a.createElement("div",null,Mr.a.createElement("div",{className:NP,onClick:e=>{var t;Object(ij.b)(ij.a.Welcome.CLICK_EXT),null===(t=u.current)||void 0===t||t.show(e)}},Mr.a.createElement("i",{className:"fa fa-solid-more"})),p),Mr.a.createElement(gj,{ref:u,onReject:e=>{Object(ij.b)(ij.a.Welcome.CLICK_NO_NEED),Object(aj.n)(r)();mj.a.onUpdateFeatureStatus(!1,(()=>{mj.a.showSettings(o,{show:!0,data:{tab:Ow.f.MESSAGES,showQRToolTipTime:Date.now()}})}))},onSkip:()=>{Object(ij.b)(ij.a.Welcome.CLICK_SKIP_EXT),g()},windowId:o}));return Mr.a.createElement(fj.b,{anchorEl:t,identity:{windowId:o,name:_j},className:kP,content:f,deltaPosition:{top:-8},placement:"top-right",style:{borderRadius:"4px",padding:0}})}bj.propTypes={refCB:NC.a.object,onCompleteWelcome:NC.a.func,onClosePopover:NC.a.func};var Ij=Object(JP.b)(bj),yj=s("4mSp"),Sj=s("bB2L"),Cj=s("JKN4");const Ej="qrcb-popover-container",Oj=`${Ej}__header`,Mj=`${Oj}__title`,Tj=Oj+"__manage-btn",Rj=`${Ej}__body`,wj=`${Rj}__hint-c`,Lj=`${wj}__tip`,Dj=`${wj}__desc`;var Aj=s("tjM/");function Fj(){return Mr.a.createElement("div",{className:wj},Mr.a.createElement("div",{className:Lj},Mr.a.createElement(Cj.a,{textKey:"STR_TIP"}),":"),Mr.a.createElement("div",{className:Dj},Mr.a.createElement(Cj.a,{textKey:"STR_INPUT"}),Mr.a.createElement(Aj.a,{className:"ml-4 mr-4",size:"small"}),Mr.a.createElement(Cj.a,{textKey:"STR_INPUT_QR_LIST"}),"."))}Fj.propTypes={};var kj=Fj,Nj=s("QJeg"),Pj=s("egaF"),jj=s("huGB");const Uj={top:0,left:0,right:window.innerWidth-10,bottom:window.innerHeight},Bj=Y.PopoverIdentitiesDefine.QM_DASHBOARD;const zj=Object(JP.b)((function(e){var t,s;const{anchor:a,conversationId:i,data:n={},isOpen:r,onClosePopover:o,windowId:c,popupDocument:l}=e,{selfWindow:d}=Object(QC.a)(),u=Object(OC.b)();let h=Object(aj.p)();const[g,m]=Object(Or.useState)(h),p=e=>{const t={item:e,conversationId:i,sendSrc:"dashboard"};u.emit(ve.GeneralActions.REPLACE_QR_KEYWORD_TO_CHAT_INPUT,t),Object(aj.n)(o)()},f=null!==(t=null==n||null===(s=n.list)||void 0===s?void 0:s.length)&&void 0!==t?t:0;if(Object(Or.useEffect)((()=>{const e={windowId:c,name:Bj},t=()=>{m(!1),Object(aj.n)(o)()};return fj.a.on("beforeClose",e,t),()=>{fj.a.removeListener("beforeClose",e,t)}}),[]),Object(Or.useEffect)((()=>{r&&Object(pj.b)(c,Bj)}),[r]),!r)return null;const v=Mr.a.createElement("div",{className:jj.q},Mr.a.createElement(Rr.a,{textKey:"STR_QR_DASHBOARD_TOOLTIPS_1"})," ",Mr.a.createElement(Rr.a,{textKey:"STR_MANAGE"})," ",Mr.a.createElement(Rr.a,{textKey:"STR_QR_DASHBOARD_TOOLTIPS_2"}),"."),_=Mr.a.createElement("div",{className:Ej},Mr.a.createElement("div",{className:Oj},Mr.a.createElement("div",{className:Mj,"data-id":"div_QuickMsg_QMTitle"},ce.a.trans("STR_TITLE_QUICK_MESSAGES_WITH_COUNTING",[f])),Mr.a.createElement(yj.a,{title:v,boundary:Uj,open:g,delay:100,placement:"top-center",popupDocument:d},Mr.a.createElement("div",{className:"rel"},Mr.a.createElement(wr.a,{className:Tj,"data-id":"btn_QuickMsg_Manage",type:"tertiary-primary",size:"medium",onClick:()=>{h&&Object(aj.b)(),Object(pj.a)(c,Bj),Object(ij.b)(ij.a.Management.ON_OPEN_IN_DASHBOARD),mj.a.showManagerModal(c,{from:"dashboard"})}},Mr.a.createElement(Rr.a,{textKey:"STR_MANAGE"}))))),Mr.a.createElement("div",{className:Rj,style:{height:Object(aj.g)(f)}},Mr.a.createElement(Pj.b,{autoHide:!0,noHScroll:!0,noVScroll:!1},Mr.a.createElement("div",{"data-id":"div_QuickMsg_QMList",style:{flex:1,height:"100%"}},(e=>{let t=null==e?void 0:e.list;if(!t||!Array.isArray(t)||!t.length)return Mr.a.createElement(Nj.a,{mode:"dashboard"});const s=t.map((e=>Mr.a.createElement(Sj.a,{borders:{bottom:!0},canActions:!1,className:"clickable",data:e,dataId:"div_QuickMsg_QMItem",onClick:p})));return t.length<=3&&s.push(Mr.a.createElement(kj,null)),s})(n)))));return Mr.a.createElement(fj.b,{anchorEl:a,identity:{windowId:c,name:Bj},className:"qrcb-popover",content:_,deltaPosition:{top:-4},placement:"top-left",zIndex:9999})}));zj.propTypes={anchor:NC.a.element,conversationId:NC.a.string,data:NC.a.object,isOpen:NC.a.bool,onClosePopover:NC.a.func,windowId:NC.a.string};var Gj=zj;var xj=function(e){const{showWelcome:t}=e;return t?Mr.a.createElement(Ij,e):Mr.a.createElement(Gj,e)},Vj=s("aloy");function Hj(e,t){const{onClick:s,isOpen:a}=e,[i,n]=Object(Or.useState)(Object(aj.q)());return Mr.a.createElement("div",{className:jj.n},Mr.a.createElement("div",null,Mr.a.createElement(Vj.b,{ref:t,key:"quick-msg",id:"QR_ChatBar-Btn",isActive:a,onClick:e=>{i&&(n(!1),Object(aj.c)()),Object(aj.n)(s)(e)},icon:"Quick-msg",title:"STR_QR_INSERT","data-id":"btn_QuickMsg_Entry"}),i?Mr.a.createElement("div",{className:Object(PC.a)(jj.m)},Mr.a.createElement("i",{className:`fa fa-red_dot ${jj.l}`})):null))}Hj.propTypes={onClick:NC.a.func};var Wj=Object(Or.forwardRef)(Hj),qj=s("RwJP"),Kj=s("Bdpz");function Zj(e){const{conversationId:t}=e,{windowId:s,selfDocument:a}=Object(QC.a)(),[i,n]=Object(Or.useState)(!1),[,r]=Object(Or.useState)({}),o=Object(Or.useRef)(),c=Object(Or.useRef)(),l=Object(OC.b)(),[,d]=Object(qj.a)(),u=()=>{n(!1)};Object(Or.useEffect)((()=>{const e=()=>{r({})};return ce.a.callUpdate(e),()=>{ce.a.removeUpdate(e)}}),[]),Object(Or.useEffect)((()=>{const e=()=>{u()};return a.addEventListener("resize",e),()=>{a.removeEventListener("resize",e)}}),[]),Object(Or.useEffect)((()=>{const e=l.on(ve.GeneralActions.OPEN_QM_DASHBOARD,((e,t)=>{o.current&&"function"==typeof o.current.click&&e===s&&o.current.click()}));return()=>{e.remove()}}),[]),Object(Or.useEffect)((()=>{const e=l.on(ve.GeneralActions.UPDATE_QUICK_MESSAGE_STATUS,(()=>{r({})}));return()=>{e.remove()}}),[]);const h=Object(aj.s)(d);return Kj.a.Config.isEnableQuickReply()&&Kj.a.FeatureSettings.getFeatureStatus()?Mr.a.createElement(Mr.a.Fragment,null,Mr.a.createElement(xj,{anchor:o.current,conversationId:t,data:d,eventHandler:c.current,isOpen:i,onCompleteWelcome:()=>{n(!1),setTimeout((()=>{n(!0)}),100)},onClosePopover:u,showWelcome:h,windowId:s,popupDocument:a}),Mr.a.createElement(Wj,{ref:e=>o.current=e,onClick:e=>{c.current=Object(I.a)({},e),n(!i),Object(ij.b)(ij.a.Feature.CLICK_ENTRYPOINT)},isOpen:i})):null}Zj.propTypes={conversationId:NC.a.string,onClickEP:NC.a.func,onClosePopover:NC.a.func,refCB:NC.a.any,refEP:NC.a.any,windowId:NC.a.string};var $j,Qj=Zj;Object(a.singleton)(AP.a)($j=Reflect.metadata("design:type",Function)($j=Reflect.metadata("design:paramtypes",[])($j=class{constructor(){this._chatBoxToolbarButtonsMap=new Map,this._registerChatBoxToolbarButtons()}_registerChatBoxToolbarButtons(){this._chatBoxToolbarButtonsMap.set(DP.b.SEND_STICKER_ITEM,(e=>Mr.a.createElement(FP.r,e))),this._chatBoxToolbarButtonsMap.set(DP.b.PICK_PHOTO_ITEM,(e=>Mr.a.createElement(FP.l,e))),this._chatBoxToolbarButtonsMap.set(DP.b.PICK_FILE_ITEM,(e=>Mr.a.createElement(FP.j,e))),this._chatBoxToolbarButtonsMap.set(DP.b.SCREEN_CAPTURE_ITEM,(e=>Mr.a.createElement(FP.n,e))),this._chatBoxToolbarButtonsMap.set(DP.b.SCREEN_CAPTURE_OPTIONS_ITEM,(e=>Mr.a.createElement(FP.p,e))),this._chatBoxToolbarButtonsMap.set(DP.b.SHARE_CONTACT_ITEM,(e=>Mr.a.createElement(FP.s,e))),this._chatBoxToolbarButtonsMap.set(DP.b.CREATE_REMINDER_ITEM,(e=>Mr.a.createElement(FP.d,e))),this._chatBoxToolbarButtonsMap.set(DP.b.CREATE_TODO_ITEM,(e=>Mr.a.createElement(FP.e,e))),this._chatBoxToolbarButtonsMap.set(DP.b.TOGGLE_RTF_MODE_ITEM,(e=>Mr.a.createElement(FP.u,e))),this._chatBoxToolbarButtonsMap.set(DP.b.MARK_IMPORTANT_MESSAGE_ITEM,(e=>Mr.a.createElement(FP.g,e))),this._chatBoxToolbarButtonsMap.set(DP.b.QUICK_MESSAGE_ITEM,(e=>Mr.a.createElement(Qj,{conversationId:e.convId}))),this._chatBoxToolbarButtonsMap.set(DP.b.MORE_ITEM,(e=>Mr.a.createElement(FP.h,e)))}getChatBoxToolbarButton(e){return this._chatBoxToolbarButtonsMap.get(e)}})||$j)||$j);var Yj,Jj=s("RPT1"),Xj=s("TsEa"),eU=s("Y25x"),tU=s("7fvu");Object(xi.b)(Jj.b)(Yj=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(Yj=Reflect.metadata("design:type",Function)(Yj=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(Yj=class{constructor(e){this.type=void 0,this.key=tU.a,this.name=Jj.a,this._chatBoxCommandUIStateMap=new Map,this._isSupportCommandModeMap=new Map,this._logger=void 0,this._logger=e.createZLogger(w.ZLoggerNametags.cbiCommandController,[w.ZLoggerNametags.cbiCommandMode])}init(){}getItem(e,t){if(!e.key)return;const s=this._chatBoxCommandUIStateMap.get(e.key);if(s)return s;if(Object(eU.b)(e.key)){const t=this._initDefaultState();return this._chatBoxCommandUIStateMap.set(e.key,t),t}}getList(e,t){return[]}onGetItemFailure(e,t){this._logger.zsymb(21,"T8stpf",["[onGetItemFailure] key: {}, error: {}","_BBweL"],e,t.message)}onGetListFailure(e,t){this._logger.zsymb(21,"wIFBft",["[onGetListFailure] key: {}, error: {}","HWSk9R"],e,t.message)}getChatBoxCommandModeOfConv(e){if(!e){const t=`[getChatBoxCommandModeOfConv] ${e} is invalid!`;return this._logger.zsymb(18,"C_Qv6W",t),-1}let t=this._chatBoxCommandUIStateMap.get(Object(eU.a)(e));return t||(t=this._initDefaultState(),this._chatBoxCommandUIStateMap.set(Object(eU.a)(e),t)),t.currentMode}setNewChatBoxCommandModeOfConv(e,t){if(!t){const e=`[setNewChatBoxCommandModeOfConv] ${t} is invalid!`;return void this._logger.zsymb(18,"drgc3X",e)}let s=this._chatBoxCommandUIStateMap.get(Object(eU.a)(t));s||(s=this._initDefaultState());let a=Object(rm.a)(s,(t=>{t.currentMode=e}));a!==s&&(this._chatBoxCommandUIStateMap.set(Object(eU.a)(t),a),Object(nc.h)(this.name,Object(eU.a)(t)))}resetChatBoxCommandModeToNormalModeOfConv(e){this.setNewChatBoxCommandModeOfConv(Xj.b.NORMAL,e)}getPlaceholderOfMode(e){if(!e||-1===e)return"";const t=Xj.c[e];return t.hasOwnProperty("placeholder")&&t.placeholder?t.placeholder:""}_initDefaultState(){return{currentMode:Xj.b.NORMAL}}})||Yj)||Yj)||Yj);var sU,aU,iU,nU,rU,oU,cU,lU,dU,uU,hU,gU,mU=s("0EGn"),pU=s("ETgL"),fU=s("xHgQ"),vU=s("PflS"),_U=s("pr8J");const bU={conversationId:"",showSlider:!1,items:[],selectedId:null,hasOlder:!0,hasNewer:!0,entry:TO.l.Unknown,showCaption:!0};sU=Object(a.injectable)(),aU=Object(xi.b)(MO.b),iU=Reflect.metadata("design:type",Function),nU=Reflect.metadata("design:paramtypes",[]),rU=function(e,t,s){const a=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await a.apply(this,e);return t(),s}catch(s){throw t(),s}},s},oU=Reflect.metadata("design:type",Function),cU=Reflect.metadata("design:paramtypes",[void 0===_U.LoadConfig?Object:_U.LoadConfig,String,Boolean]),lU=function(e,t,s){const a=s.value;return s.value=async function(...e){const t=this.onFunctionDone||function(){};try{const s=await a.apply(this,e);return t(),s}catch(s){throw t(),s}},s},dU=Reflect.metadata("design:type",Function),uU=Reflect.metadata("design:paramtypes",[void 0===_U.LoadConfig?Object:_U.LoadConfig]),sU(hU=aU(hU=iU(hU=nU((gU=class{constructor(){this._runningTasks=new Map,this._eventEmitter=new Uf.a,this._abortedTask=new Set,this.dispose=()=>{this._runningTasks.forEach((e=>e.abort())),this._runningTasks.clear(),this._abortedTask.clear(),this._eventEmitter.removeAllListeners(),a.ModuleContainer.resolve(Rf.b).removeActiveWindowContext()},this.toggleSlider=e=>{this.ensureInitState(e);let t=this.data.get(e);t=Object(I.a)(Object(I.a)({},t),{},{showSlider:!t.showSlider}),this.data.set(e,t),this._signalRenderItem(this.name,e)},this.ensureInitState=(e,t=!0)=>{this.data.get(e)||(this.data.set(e,Object(I.a)(Object(I.a)({},bU),{},{conversationId:e})),t||this._signalRenderItem(this.name,e))},this.getSelectedItem=e=>{const t=this.data.get(e);if(!t)return null;const s=t.selectedId;if(!s)return null;return t.items.find((e=>e.msgId===s||(null==e?void 0:e.fakeMsgId)===s))},this.manualDownload=async(e,t,s,a)=>{Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload);const i=this.getSelectedItem(s);let n;var r;(Object(ua.a)(!!i,`imageViewer: download item not found for ${s} ${a}`),Ia.default.logActionPhotoViewer(1830904),(null==i?void 0:i.msgType)===Y.MSG_VIDEO&&Ia.default.logActionPhotoViewer(1831306),(null==i?void 0:i.msgType)===Y.MSG_FILE)&&(n=null==i||null===(r=i.message)||void 0===r?void 0:r.title);if(Object(he.a)()){const e=ui.default.getConversationType(s);let t=new oe.c(oe.a.PhotoView).getBuilder().withMode(oe.e.Manual).withConvType(oe.b[e]).withType(oe.f.Photo).withCode(oe.d.PTVButton);if(i.constructor===String)await tt.default.run({entry:t.build(),type:tt.default.constants.DownloadType.Photo,data:{url:i,msgId:Date.now()+""},options:{saveAs:!0,srcAction:tt.default.constants.srcAction.Manual,duplicate:!1,showProgress:{taskBar:!1,showProgress:!1}}});else{const e=Object(I.a)({},i);(null==e?void 0:e.msgType)!=Y.MSG_VIDEO&&(null==e?void 0:e.subType)!=Y.MSG_SUBTYPE_MEDIA_VIDEO||(t.withType(oe.f.Video),(null==e?void 0:e.msgType)!==Y.MSG_VIDEO&&(e.msgType=Y.MSG_VIDEO)),await tt.default.runByMsg(e,{entry:t.build(),options:{saveAs:!0,srcAction:tt.default.constants.srcAction.Manual,duplicate:!1,showProgress:{taskBar:!1,showProgress:!1}}})}}else{var o,c;const s="string"==typeof i?i:null!=i&&null!==(o=i.message)&&void 0!==o&&o.href?i.message.href:null==i||null===(c=i.message)||void 0===c?void 0:c.oriUrl,a=null!=i&&i.message?i.message:{};Object(fU.downloadWebV2)(e,t.document,n,void 0,s,!1,Object(I.a)(Object(I.a)({},a),{},{msgType:null==i?void 0:i.msgType,type:null==i?void 0:i.type,subType:null==i?void 0:i.subType}))}},this.resetShowSlider=e=>{const t=this.data.get(e);t&&(this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{showSlider:!0})),this._signalRenderItem(this.name,e))},this._signalRenderItem=(...e)=>{Object(nc.h)(...e)},this._abortRunningTasks=(e,t=(()=>!1))=>{Array.from(this._runningTasks.keys()).filter((s=>s.startsWith(e)&&!t(s))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e),this._abortedTask.add(e)}))},this._isValidMessage=e=>(null==e?void 0:e.msgType)!==Y.MSG_UNDO&&(null==e?void 0:e.msgType)!==Y.MSG_DEL_EVERYONE,this._filterDuplicatedImages=e=>{let t=new Map;return e.reduce(((e,s)=>{if(!s)return e;if(null==s.cliMsgId||null==s.fromUid){if(s.msgType&&!isNaN(s.msgType)){let t=+s.msgType;if(t<=0||[Y.MSG_TODO,Y.MSG_TODO_DONE,Y.MSG_FRIEND_SENT_REQUEST,Y.MSG_SUGGEST_IN_CHAT].includes(t))return e.push(s),e}return e.push(s),e}const a=`${s.cliMsgId}_${s.fromUid}`,i=`[${a}]|[${s.msgId}][${s.sendDttm}|${s.src}]`;if(t.has(a)){const{msg:i}=t.get(a);return i.src===Y.MSG_SRC.SYNC_MOBILE_DB&&(s.fakeMsgId=i.msgId,Object.assign(i,s)),e}return t.set(a,{data:i,msg:s}),e.push(s),e}),[])},this._eventBusHandler=(e,t)=>{},this.name=MO.a,this.data=new Map,this.key="conversationId",this.init()}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){switch(e){case vU.a.ROTATE_LEFT:{const e=null==t?void 0:t.mediaId;Object(ua.a)("string"==typeof e,"payload must be an object with mediaId property"),a.ModuleContainer.resolve(Rf.b).rotateMedia(e,-90);break}case vU.a.ROTATE_RIGHT:{const e=null==t?void 0:t.mediaId;Object(ua.a)("string"==typeof e,"payload must be an object with mediaId property"),a.ModuleContainer.resolve(Rf.b).rotateMedia(e,90);break}default:this._eventEmitter.emit(e,t)}}undoDeleteMulti(e,t){const s=this.data.get(e);if(!s||!t.length)return;const a=[...s.items,...t];let i=this._filterDuplicatedImages(a.sort(((e,t)=>+e.sendDttm-+t.sendDttm)));i=this._filterDeletingMessages(e,i),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{items:i})),this._signalRenderItem(this.name,e)}removeItem(e,t){var s;const a=this.data.get(e);if(!a||!t)return;let i=a.items.findIndex((e=>e.msgId===a.selectedId));const n=a.items.filter((e=>e.msgId!==t.msgId));i=Math.min(i,n.length-1);const r=null===(s=n[i])||void 0===s?void 0:s.msgId;this.data.set(e,Object(I.a)(Object(I.a)({},a),{},{items:n,selectedId:r})),0===n.length&&this.emit("CLOSE_VIEWER",{conversationId:e}),this._signalRenderItem(this.name,e)}removeMulti(e,t){var s;const a=this.data.get(e);if(!a||!t.length)return;const i=a.items.filter((e=>!t.includes(e.msgId)));if(0===i.length)return void this.emit("CLOSE_VIEWER",{conversationId:e});let n=a.items.findIndex((e=>e.msgId===a.selectedId));n=-1===n?i.length-1:n,n=Math.min(n,i.length-1);const r=null===(s=i[n])||void 0===s?void 0:s.msgId;this.data.set(e,Object(I.a)(Object(I.a)({},a),{},{items:i,selectedId:r})),this._signalRenderItem(this.name,e)}async loadSlider(e){const{conversationId:t}=e;Object(ua.a)("string"==typeof t,"conversationId must be provided");try{await this._refreshSliderData(e)}catch(s){}}async loadMore(e,t,s){const{conversationId:a,entry:i,isMessageConv:n}=e;Object(ua.a)("string"==typeof a&&a.length>0,`conversationId must be provided. Got ${a}`),Object(ua.a)("backward"===t||"forward"===t,`direction must be backward or forward. Got ${t}`);const r=this.data.get(a);if(Object(ua.a)(!!r,"imageViewer: load more failed. SliderState must be initialized"),"backward"===t){var o,c;let t=r.hasOlder||s;if(!t)return;const d=`${a}-${i}-backward`;var l;if(this._abortRunningTasks(a,(e=>e!==d)),this._runningTasks.has(d))return void(await(null===(l=this._runningTasks.get(d))||void 0===l?void 0:l.promise));this.onFunctionDone=()=>{this._runningTasks.delete(d),this._abortedTask.delete(d)};const u=_f(this._loadMore,{conversationId:a,limit:20,message:r.items[0],options:{backward:!0,forward:!1,isMessageConv:n}});this._runningTasks.set(d,u);let h=await u.promise;if(this._abortedTask.has(d))return void this._abortedTask.delete(d);e.isMessageConv&&(h=h.result||h);const g=h;let m=this._filterDuplicatedImages([...g,...r.items]);m=this._filterDeletingMessages(a,m),t=g.length>0,this.data.set(a,Object(I.a)(Object(I.a)({},r),{},{items:m,hasOlder:t,selectedId:null!==(o=null===(c=this.data.get(a))||void 0===c?void 0:c.selectedId)&&void 0!==o?o:null})),this._signalRenderItem(this.name,a)}else{var d,u;let t=r.hasNewer||s;if(!t)return;const o=`${a}-${i}-forward`;var h;if(this._abortRunningTasks(a,(e=>e!==o)),this._runningTasks.has(o))return void(await(null===(h=this._runningTasks.get(o))||void 0===h?void 0:h.promise));this.onFunctionDone=()=>{this._runningTasks.delete(o)};const c=_f(this._loadMore,{conversationId:a,limit:20,message:r.items[r.items.length-1],options:{backward:!1,forward:!0,isMessageConv:n}});this._runningTasks.set(o,c);let l=await c.promise;if(this._abortedTask.has(o))return void this._abortedTask.delete(o);e.isMessageConv&&(l=l.result||l);const g=l;let m=this._filterDuplicatedImages([...r.items,...g]);m=this._filterDeletingMessages(a,m),t=g.length>0,this.data.set(a,Object(I.a)(Object(I.a)({},r),{},{items:m,hasNewer:t,selectedId:null!==(d=null===(u=this.data.get(a))||void 0===u?void 0:u.selectedId)&&void 0!==d?d:null})),this._signalRenderItem(this.name,a)}}selectPreviousItem(e){const t=this.data.get(e);Object(ua.a)(!!t,"imageViewer: select previous item failed. SliderState must be initialized");const s=Object(Py.d)(t.items),a=s.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(0===a||!s.length)return;const i=s[a-1],n=i.msgId;i.cliMsgId,i.fromUid;this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedId:n})),this._signalRenderItem(this.name,e)}selectNextItem(e){const t=this.data.get(e);Object(ua.a)(!!t,"imageViewer: select next item failed. SliderState must be initialized");const s=Object(Py.d)(t.items),a=s.findIndex((e=>e.msgId===t.selectedId||(null==e?void 0:e.fakeMsgId)===t.selectedId));if(a===s.length-1||!s.length)return;const i=s[a+1],n=i.msgId;i.cliMsgId,i.fromUid;this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedId:n})),this._signalRenderItem(this.name,e)}selectItem(e,t){const s=this.data.get(e);Object(ua.a)(!!s,"imageViewer: select item failed. SliderState must be initialized"),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedId:t})),this._signalRenderItem(this.name,e)}reset(e){Array.from(this._runningTasks.keys()).filter((t=>t.startsWith(e))).forEach((e=>{const t=this._runningTasks.get(e);null==t||t.abort(),this._runningTasks.delete(e)})),this._abortedTask.clear(),this.data.has(e)&&this.data.delete(e)}toggleCaption(e,t){if(!this.data.has(e))return;const s=this.data.get(e),a=Object(I.a)({},s);a.showCaption=void 0!==t?t:!s.showCaption,this.data.set(e,a),this._signalRenderItem(this.name,e)}_secureSliderState(e){var t;let{conversationId:s,selectedId:a,defaultItems:i,entry:n,disableSlider:r}=e,o=this.data.get(e.conversationId);const c=null===(t=o)||void 0===t?void 0:t.items.some((e=>e.msgId===a||e.fakeMsgId===a));let l=!0;if(e.disableLoadMore)return n===TO.l.Profile&&(i=i.slice().reverse()),o=Object(I.a)(Object(I.a)({},bU),{},{conversationId:s,items:i,selectedId:a,showSlider:!r,hasOlder:!1,hasNewer:!1,entry:e.entry}),this.data.set(e.conversationId,o),this._signalRenderItem(this.name,s),l;const d=this._filterDeletingMessages(s,i);return o&&c?a!==o.selectedId&&(o=Object(I.a)(Object(I.a)({},o),{},{selectedId:a,entry:e.entry}),l=!1):(o=Object(I.a)(Object(I.a)({},bU),{},{conversationId:s,items:d,selectedId:a,showSlider:!r,hasOlder:!0,hasNewer:!0,entry:e.entry}),l=!1),l||(this.data.set(e.conversationId,o),this._signalRenderItem(this.name,s)),l}async _refreshSliderData(e){const{conversationId:t,isMessageConv:s,entry:a,defaultItems:i}=e;let n=e.selectedId;let r=this._secureSliderState(e);if(e.disableLoadMore)return;let o=this.data.get(e.conversationId),c=o.items.findIndex((e=>e.msgId===n||e.fakeMsgId===n));if(-1===c){const e=o.items.map((e=>e.msgId||e.fakeMsgId));if(zconsole.zsymb(18,"qBmu4Y",`MVR:refreshSlider: something wrong: selectedId ${n} not found in ${e}`),!o.items.length)return zconsole.zsymb(0,"3WmRDU","MVR:refreshSlider: we don't have any items to view so close MVR early."),void this.emit("CLOSE_VIEWER",{conversationId:t});c=o.items.length-1}const l=o.items[c];n=null==l?void 0:l.msgId;const d=`${t}-${a}-${n}`;this._abortRunningTasks(t);let u=o.hasOlder,h=o.hasNewer;const g=c<10&&u,m=c>=o.items.length-10&&h;if(!g&&!m)return void(r||this._signalRenderItem(this.name,t));this.onFunctionDone=()=>{this._runningTasks.delete(d),this._abortedTask.delete(d)};const p=async t=>{const s=_f(this._loadMore,t);this._runningTasks.set(d,s);let a=await s.promise;if(e.isMessageConv&&(a=a.result||a),!this._abortedTask.has(d))return a;this._abortedTask.delete(d)};if(g){const e={conversationId:t,limit:10,message:l,options:{backward:!0,forward:!1,isMessageConv:s}},a=await p(e),i=this.data.get(t),o=i.items;let c=this._filterDuplicatedImages([...a,...o]);c=this._filterDeletingMessages(t,c),0==a.length&&(u=!1),this.data.set(t,Object(I.a)(Object(I.a)({},i),{},{selectedId:n,items:c,hasOlder:u,hasNewer:h})),r=!1}if(m){const e={conversationId:t,limit:10,message:l,options:{backward:!1,forward:!0,isMessageConv:s}},a=await p(e),i=this.data.get(t),o=i.items;let c=this._filterDuplicatedImages([...o,...a]);c=this._filterDeletingMessages(t,c),0==a.length&&(h=!1),this.data.set(t,Object(I.a)(Object(I.a)({},i),{},{selectedId:n,items:c,hasOlder:u,hasNewer:h})),r=!1}r||this._signalRenderItem(this.name,t);const f=this.data.get(t);null!=f&&f.items.length||this.emit("CLOSE_VIEWER",{conversationId:t})}async _loadMore(e){var t;const{conversationId:s,message:i,limit:n,options:{forward:r=!0,backward:o=!1,filter:c=null,isMessageConv:l=!1}={}}=e,d=i.msgId,u=(null===(t=Object(Py.a)(i))||void 0===t?void 0:t.total_item_in_group)||0;if(!1===l){let e;try{e=await a.ModuleContainer.resolve(mU.a).getImageMessagesForPhotoViewer(s,d,Math.max(n,u),r,o,c)}catch(h){}const t=pU.b.getOneBannedGroup(s);return t&&(e=pU.b.filterBannedMediaGroup(t.groupId,e)),e}return await Re.default.getImagesForPhotoViewerFromMessage(i.toUid||s,i.sendDttm,d,Math.max(n,u),r,o)}_filterDeletingMessages(e,t){return t.filter((t=>!vo.d.isDeleteMessage(e,t)&&this._isValidMessage(t)&&!ui.default.ZSafeFunction((()=>Object(x_.E)(t)),!1)&&!ui.default.ZSafeFunction((()=>Object(x_.z)(t)),!1)))}listenEvents(){_e.default.subscribe(this._eventBusHandler)}init(){this.listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}},Object(Ok.a)(gU.prototype,"loadMore",[rU,oU,cU],Object.getOwnPropertyDescriptor(gU.prototype,"loadMore"),gU.prototype),Object(Ok.a)(gU.prototype,"_refreshSliderData",[lU,dU,uU],Object.getOwnPropertyDescriptor(gU.prototype,"_refreshSliderData"),gU.prototype),hU=gU))||hU)||hU)||hU);var IU=s("DRxf"),yU=s("ftrm"),SU=s("pDj3");const CU="zcloud-status-service",EU=Object(a.define)(CU),OU="zcloud-key-service",MU=Object(a.define)(OU),TU="zcloud-plan-service-key",RU=Object(a.define)(TU);var wU=s("2T8k"),LU=s("nTk7");const DU=Object(a.define)("zcloud-status-manager");let AU=function(e){return e[e.ADD_CLOUDS=0]="ADD_CLOUDS",e[e.REMOVE_CLOUDS=1]="REMOVE_CLOUDS",e[e.ADD_TEMP_CLOUDS=2]="ADD_TEMP_CLOUDS",e[e.REMOVE_THREAD=3]="REMOVE_THREAD",e}({});class FU extends LU.a{constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this.queue=e,this.numberOfRunningTasks=0}get cloudDataManager(){return ue.a.getInstance()}get controller(){return a.ModuleContainer.resolve(nS.c)}get openedConvs(){const e=K.default.getAllCurrentOpens();if(!e||0===e.length)return[];let t=e.map((e=>e===Ar.c?a.ModuleContainer.resolve(rc.SidebarController).getCurrMainConvId():K.default.getConvIdFromWindowId(e)));return t=t.filter((e=>!!e)),t}get inInCloudOrZCloudView(){return[eO.b.MEDIA_TYPE,eO.b.CONVERSATION,eO.b.MY_CLOUD].includes(a.ModuleContainer.resolve(KE.b).getCurrentView())}calculateFromAddClouds(e){if(this.inInCloudOrZCloudView||(e=nS.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const a of e)if(a){const e=s,i=nS.d.transferCloudItemRes(!0,a,e),n=Object(nS.p)(a);n&&i&&(t[n]={personalCloud:i})}return t}calculateFromRemoveZCloudKeys(e){const t={};for(const s of e)if(s){s&&(t[s]={personalCloud:void 0})}return t}calculateFromTempClouds(e){if(this.inInCloudOrZCloudView||(e=nS.d.filterCloudItemsStatus(this.openedConvs,e)),!e.length)return null;const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const a of e)if(a){const e=a.msgInfo.isE2EE?null:s,i=nS.d.transferCloudItemRes(!1,a,e),n=Object(nS.p)(a);n&&i&&(t[n]={personalCloud:i})}return t}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const e=this.queue.shift();if(!e)break;this.numberOfRunningTasks++;const{data:t,resolve:s,reject:a}=e,{clouds:i=[],removeZCloudKeys:n=[],pCloudUpdate:r,updateSource:o}=t;let c=null;switch(o){case AU.ADD_CLOUDS:c=this.calculateFromAddClouds(i);break;case AU.ADD_TEMP_CLOUDS:c=this.calculateFromTempClouds(i);break;case AU.REMOVE_CLOUDS:c=this.calculateFromRemoveZCloudKeys(n)}c&&this.controller.onZCloudStatus(c),r&&this.controller.onZCloudStatus(r),s(),await new Promise((e=>setTimeout(e,100))),this.numberOfRunningTasks--,this.run()}}}const kU=[],NU=new LU.b(kU),PU=new FU(kU),jU=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}splitIntoBatches(e,t){const s=[];for(let a=0;a<e.length;a+=t)s.push(e.slice(a,a+t));return s}async calculateStatus(e){const{clouds:t=[],removeZCloudKeys:s=[],pCloudUpdate:a,updateSource:i}=e,n=new Promise(((e,n)=>{const r={data:{clouds:t,removeZCloudKeys:s,pCloudUpdate:a,updateSource:i},resolve:e,reject:n};this.provider.send(r),this.consumer.run()}));return n.catch((()=>{})).finally((()=>{})),n}async syncStatus(e,t=!1){if(t)this.calculateStatus({pCloudUpdate:e});else for(const s in e){const t={};t[s]=e[s],this.calculateStatus({pCloudUpdate:t})}}}(NU,PU);a.ModuleContainer.registerValue(DU,jU);var UU,BU=jU;let zU=Object(m.d)()(UU=Object(a.injectable)()(UU=function(e,t){return Object(a.inject)(SU.a)(e,void 0,0)}(UU=function(e,t){return Object(a.inject)(EU)(e,void 0,1)}(UU=function(e,t){return Object(a.inject)(MU)(e,void 0,2)}(UU=function(e,t){return Object(a.inject)(RU)(e,void 0,3)}(UU=Reflect.metadata("design:type",Function)(UU=Reflect.metadata("design:paramtypes",[void 0===SU.a?Object:SU.a,void 0===EU?Object:EU,void 0===MU?Object:MU,void 0===RU?Object:RU])(UU=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloud,[w.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e,t,s,a){this.metrics=e,this.statusService=t,this.keyService=s,this.planService=a,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=IU.a,this.key=IU.a}onApplicationReady(){}onBizConfigReady(){if(!Object(yU.a)().isEnableUserPCloud())return this.Logger.zsymb(3,"OamQ0Q",["requestRSAKey but no permission!","0XK1xS"]),void this.keyService.removeRSAKey();this.metrics.setGetKeyAfterLoginTime(),this.keyService.requestRSAKey(yO.c.LOGIN)}async calculateZCloudStatusByMessages(e,t){if(!yU.b.shouldLoadInitStatus(t))return;let s=yU.b.filterValidMsgs(e);if(s=yU.b.normalizedMsgs(s),!s||!s.length)return;const a=await this.statusService.getStatusByMessages(s,t);BU.syncStatus(a,!0)}async calculateZCloudStatusByCloudItems(e){const t=await this.statusService.getStatusByCloudItems(e);BU.syncStatus(t,!0)}getErrorPCloudHandler(e,t){const{error:s,msgIds:a,windowId:i,showNoti:n,type:r}=e;return s&&null!=s&&s.hasNoKey?()=>this.onInteractMediaWithoutKey({msgIds:a,windowId:i,showNoti:n,type:r},t):()=>{}}checkPCloudWithoutKey(e){return this.keyService.checkPCloudWithoutKey(e)}onZCloudStatus(e){if(Object(wU.d)(e))return;Object.keys(e);this.statusService.syncCachePCloudInfo(e),this.statusService.signalUIPCloudInfo(e),this.statusService.shareUpdatePCloudAction(e)}onHandleHaveKey(){const e=this.keyService.createPCloudUpdateWithValidRSAKey();this.keyService.shareHaveKeyPCloudAction(e)}async onInteractMediaWithoutKey(e,t){if(this.keyService.showToastWarningNoKey(e),!Object(yU.a)().isEnableUserPCloud())return void this.Logger.zsymb(3,"QmcBe7",["requestRSAKey but no permission!","0XK1xS"]);const s=t||yO.c.RETRY;s===yO.c.INVIEW?this.metrics.setGetKeyAfterInviewTime():s===yO.c.RETRY&&this.metrics.setGetKeyAfterRetryTime(),this.keyService.requestRSAKey(s)}onZCloudFreePlan(){const e=this.statusService.createEmptyPCloudUpdate();this.keyService.removeRSAKey(),BU.syncStatus(e,!0),this.planService.shareOffPlanEvent()}onUpgradeZCloudPlan(){this.metrics.setGetKeyAfterChangePlanTime(),this.keyService.requestRSAKey(yO.c.CHANGE_PLAN),this.planService.shareUpgradePlanEvent()}onGracePeriodPlan(){this.planService.shareGracePeriodPlanEvent()}onRemoveThreads(e){for(const t of e){const e=this.statusService.createEmptyGroupPCloudUpdate(t);BU.syncStatus(e)}}})||UU)||UU)||UU)||UU)||UU)||UU)||UU)||UU;var GU,xU=s("0VmO");const VU={valid:!1,status:{isClouded:!0,isUncloud:!1},error:{hasNoKey:!0}},HU={valid:!1,status:{isClouded:!1,isUncloud:!0},error:null},WU={valid:!0,status:{isClouded:!0,isUncloud:!1},error:null};let qU=Object(m.d)()(GU=Object(a.injectable)()(GU=function(e,t){return Object(a.inject)(xU.a)(e,void 0,0)}(GU=Reflect.metadata("design:type",Function)(GU=Reflect.metadata("design:paramtypes",[void 0===xU.a?Object:xU.a])(GU=class extends hs.b{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloud,[w.ZLoggerNametags.zCloudStatusEventsResolver])),this._Logger}get controller(){return a.ModuleContainer.resolve(IU.b)}get cloudDataManager(){return ue.a.getInstance()}constructor(e){super(),this.zaloCloudConfig=e,this.name=void 0,this.key=void 0,this.msgs=void 0,this.convId=void 0,this._Logger=void 0,this.name=vO.a,this.key=vO.a,this.msgs=[],this.convId=null}onApplicationReady(){(Object(ME.i)()||Object(yU.a)().isEnableBizPCloud())&&(this.addDataCloudListeners(),this.addTestListeners())}addTestListeners(){this.addEventListener(yO.g.INIT_DATA,this.handleTestCloudEvents.bind(this)),this.addEventListener(yO.g.NO_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(yO.g.HAVE_KEY,this.handleTestCloudEvents.bind(this)),this.addEventListener(yO.g.NOT_YET_CLOUDED,this.handleTestCloudEvents.bind(this))}addDataCloudListeners(){this.cloudDataManager.addListener(ZE.c.ADD_CLOUD_ITEMS,this.handleAddedCloudItems.bind(this)),this.cloudDataManager.addListener(ZE.c.UPDATE_CLOUD_ITEMS,this.handleUpdatedCloudItems.bind(this)),this.cloudDataManager.addListener(ZE.c.TEMP_CLOUD_ITEMS,this.handleTempCloudItems.bind(this)),this.cloudDataManager.addListener(ZE.c.REMOVE_CLOUD_ITEMS,this.handleCloudRemoveItems.bind(this)),this.cloudDataManager.addListener(ZE.c.UPDATE_CLOUD_KEY_STATUS,this.handleHaveCloudKey.bind(this)),this.cloudDataManager.addListener(ZE.c.REMOVE_THREAD_CLOUD,this.handleCloudRemoveThread.bind(this))}async handleTestCloudEvents(e){const t={};switch(e.type){case yO.g.INIT_DATA:for(const s of e.payload){t[Object(wU.f)(s)]={personalCloud:Object(I.a)({},WU)}}this.controller.onZCloudStatus(t);break;case yO.g.NO_KEY:for(const s of e.payload){t[Object(wU.f)(s)]={personalCloud:Object(I.a)({},VU)}}this.controller.onZCloudStatus(t);break;case yO.g.HAVE_KEY:this.controller.onHandleHaveKey();break;case yO.g.NOT_YET_CLOUDED:for(const s of e.payload){t[Object(wU.f)(s)]={personalCloud:Object(I.a)({},HU)}}this.controller.onZCloudStatus(t)}}handleAddedCloudItems(e){const t=BU.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)BU.calculateStatus({clouds:t[s],updateSource:AU.ADD_CLOUDS})}handleUpdatedCloudItems(e){}handleTempCloudItems(e){const t=BU.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)BU.calculateStatus({clouds:t[s],updateSource:AU.ADD_TEMP_CLOUDS})}handleCloudRemoveItems(e){const t=BU.splitIntoBatches(e,10);for(let s=0;s<t.length;s++)BU.calculateStatus({removeZCloudKeys:t[s],updateSource:AU.REMOVE_CLOUDS})}handleCloudRemoveThread(e){this.controller.onRemoveThreads(e)}handleHaveCloudKey(e){e&&(this.Logger.zsymb(3,"jlPPfE",["handleHaveCloudKey","o0tuGi"]),this.controller.onHandleHaveKey())}bindMsg(e,t){this.msgs=e,this.convId=t}})||GU)||GU)||GU)||GU)||GU;var KU,ZU=s("3+fW");let $U=Object(xi.b)(ZU.a)(KU=Object(a.injectable)()(KU=function(e,t){return Object(a.inject)(SU.a)(e,void 0,0)}(KU=Reflect.metadata("design:type",Function)(KU=Reflect.metadata("design:paramtypes",[void 0===SU.a?Object:SU.a])(KU=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloud,[w.ZLoggerNametags.zCloudStatusController])),this._Logger}constructor(e){this.name=void 0,this.type=void 0,this.key=void 0,this.data=new Map,this.metrics=void 0,this._Logger=void 0,this.name=ZU.b,this.key=ZU.b,this.metrics=e}_getState(e){return this.data.get(e)}setPCloudInfo(e,t){e?this.data.set(t,e):this.data.delete(t)}signalUIPCloudInfo(e){Object(nc.h)(this.name,e)}getListPCloudInfo(){return this.data.entries()}getPCloudBizState(e){var t,s,a;let i;i="string"==typeof e?e:Object(wU.f)(e);const n=this.data.get(i);return n&&n.status?{valid:n.valid,hasNoKey:(null===(t=n.error)||void 0===t?void 0:t.hasNoKey)||!1,isClouded:null===(s=n.status)||void 0===s?void 0:s.isClouded,isUncloud:null===(a=n.status)||void 0===a?void 0:a.isUncloud,error:n.error,isFreeCloudItem:n.isFreeCloudItem}:null}getPCloudInfo(e){let t;return t="string"==typeof e?e:Object(wU.f)(e),this._getState(t)}getItem(e){return this._getState(e.key)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||KU)||KU)||KU)||KU)||KU;const QU="zcloud-repository",YU=Object(a.define)(QU);var JU;let XU=Object(a.injectable)()(JU=Reflect.metadata("design:type",Function)(JU=Reflect.metadata("design:paramtypes",[])(JU=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloud,[w.ZLoggerNametags.zCloudStatusRepository])),this._Logger}constructor(){this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=QU,this.key=QU}get cloudDataManager(){return ue.a.getInstance()}getZCloudList(e,t){return 0===t.length?Promise.resolve({cloudedItems:[],tempCloudItems:[]}):new Promise((e=>{this.cloudDataManager.getCloudItems(t).then((s=>{let a=[];for(const e of s)e&&a.push(e);const i=a,n=i.map((e=>Object(wU.g)(e))),r=t.filter((e=>!n.includes(Object(wU.f)(e))));e({cloudedItems:i,tempCloudItems:r})})).catch((t=>{this.Logger.zsymb(3,"48Sxg8",["getZCloudList, err:","EmVPqZ"],t),e({cloudedItems:[],tempCloudItems:[]})}))}))}})||JU)||JU)||JU;var eB;let tB=Object(a.injectable)()(eB=function(e,t){return Object(a.inject)(SU.a)(e,void 0,0)}(eB=function(e,t){return Object(a.inject)(ZU.a)(e,void 0,1)}(eB=function(e,t){return Object(a.inject)(vO.b)(e,void 0,2)}(eB=function(e,t){return Object(a.inject)(YU)(e,void 0,3)}(eB=Reflect.metadata("design:type",Function)(eB=Reflect.metadata("design:paramtypes",[void 0===SU.a?Object:SU.a,void 0===ZU.a?Object:ZU.a,void 0===vO.b?Object:vO.b,void 0===YU?Object:YU])(eB=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloud,[w.ZLoggerNametags.zCloudStatusServices])),this._Logger}get cloudDataManager(){return ue.a.getInstance()}constructor(e,t,s,a){this.name=void 0,this.key=void 0,this.metrics=void 0,this.zCloudInfo=void 0,this.eventsResolver=void 0,this.zCloudStatusRepository=void 0,this._Logger=void 0,this.name=CU,this.key=CU,this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.zCloudStatusRepository=a}async getStatusByMessages(e,t){const s={},{cloudedItems:a,tempCloudItems:i}=await this.zCloudStatusRepository.getZCloudList(t,e),n=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const r of a){const e=r.msgInfo.isE2EE?null:n,t=Object(wU.g)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const a=yU.b.transferCloudItemRes(!0,r,e);a&&(s[t]={personalCloud:a})}}for(const r of i){const e=Ku.b.isMsgE2ee(r)?null:n,t=Object(wU.f)(r);if(!this.zCloudInfo.getPCloudInfo(t)&&t){const a=yU.b.transferCloudItemRes(!1,r,e);a&&(s[t]={personalCloud:a})}}return Promise.resolve(s)}getStatusByCloudItems(e){const t={},s=this.cloudDataManager.checkUpgraded()?null:{hasInvalidKey:!0};for(const a of e){const e=a.msgInfo.isE2EE?null:s,i=Object(wU.g)(a);if(!this.zCloudInfo.getPCloudInfo(i)&&i){const s=yU.b.transferCloudItemRes(!0,a,e);s&&(t[i]={personalCloud:s})}}return Promise.resolve(t)}syncCachePCloudInfo(e){for(const t in e){const s=e[t].personalCloud;this.zCloudInfo.setPCloudInfo(s,t)}}signalUIPCloudInfo(e){for(const t in e)this.zCloudInfo.signalUIPCloudInfo(t)}shareUpdatePCloudAction(e){this.eventsResolver.dispatchEvent(new yO.b(yO.a.UPDATE_STATUS,e))}createEmptyPCloudUpdate(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,a]of t)s&&a&&(a.isFreeCloudItem||(e[s]={personalCloud:void 0}));return e}createEmptyGroupPCloudUpdate(e){const t={},s=this.zCloudInfo.getListPCloudInfo();for(let[a,i]of s)a&&i&&a.includes(e)&&(t[a]={personalCloud:void 0});return t}})||eB)||eB)||eB)||eB)||eB)||eB)||eB;var sB;let aB=Object(a.injectable)()(sB=function(e,t){return Object(a.inject)(SU.a)(e,void 0,0)}(sB=function(e,t){return Object(a.inject)(ZU.a)(e,void 0,1)}(sB=function(e,t){return Object(a.inject)(vO.b)(e,void 0,2)}(sB=Reflect.metadata("design:type",Function)(sB=Reflect.metadata("design:paramtypes",[void 0===SU.a?Object:SU.a,void 0===ZU.a?Object:ZU.a,void 0===vO.b?Object:vO.b])(sB=class{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloud,[w.ZLoggerNametags.zCloudKeyServices])),this._Logger}get cloudDataManager(){return ue.a.getInstance()}constructor(e,t,s){this.metrics=e,this.zCloudInfo=t,this.eventsResolver=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=OU,this.key=OU}removeRSAKey(){this.cloudDataManager.checkUpgraded()&&this.cloudDataManager.removeKey()}requestRSAKey(e){this.cloudDataManager.checkUpgraded()&&e!==yO.c.CHANGE_PLAN||(e===yO.c.LOGIN||e===yO.c.CHANGE_PLAN?(this.cloudDataManager.updateZCloudKey(!1,e),this.metrics.onAutoRequestKey()):e===yO.c.RETRY&&(this.cloudDataManager.updateZCloudKey(!0,e),this.metrics.onManualRequestKey()))}checkPCloudWithoutKey(e){var t;const s=this.zCloudInfo.getPCloudInfo(e);return Boolean(null==s||null===(t=s.error)||void 0===t?void 0:t.hasNoKey)}createPCloudUpdateWithValidRSAKey(){const e={},t=this.zCloudInfo.getListPCloudInfo();for(let[s,a]of t){if(!s||!a)continue;if(a.isFreeCloudItem)continue;const t=Object(I.a)(Object(I.a)({},a.error),{},{hasNoKey:!1}),i=a.status,n={valid:yU.b.checkValidFromBizState(t,i),status:i,error:t};e[s]={personalCloud:n}}return e}shareHaveKeyPCloudAction(e){this.eventsResolver.dispatchEvent(new yO.b(yO.a.HAVE_KEY,e))}showToastWarningNoKey(e){const{showNoti:t=!0,windowId:s=Ar.c}=e,a=be.ZToastManagerHolder.getZToastManagerByWindowId(s);t&&a.show({noBackground:!0,textKey:"STR_PERSONAL_CLOUD_NO_KEY_TOAST",type:be.TOAST_TYPE.INFO,duration:3e3,styles:{width:"400px"},styleText:{whiteSpace:"pre-line"}})}})||sB)||sB)||sB)||sB)||sB)||sB;var iB;let nB=Object(a.injectable)()(iB=function(e,t){return Object(a.inject)(vO.b)(e,void 0,0)}(iB=Reflect.metadata("design:type",Function)(iB=Reflect.metadata("design:paramtypes",[void 0===vO.b?Object:vO.b])(iB=class{constructor(e){this.eventsResolver=e,this.name=void 0,this.key=void 0,this.name=TU,this.key=TU}shareUpgradePlanEvent(e){this.eventsResolver.dispatchEvent(new yO.b(yO.a.UPGRADE_ZCLOUD_PLAN,e||{}))}shareOffPlanEvent(e){this.eventsResolver.dispatchEvent(new yO.b(yO.a.OFF_PERSONAL_CLOUD_PLAN,e||{}))}shareGracePeriodPlanEvent(e){this.eventsResolver.dispatchEvent(new yO.b(yO.a.GRACE_PERIOD_ZCLOUD_PLAN,e||{}))}})||iB)||iB)||iB)||iB;var rB=s("MNOV");a.ModuleContainer.registerSingleton(IU.b,zU),a.ModuleContainer.registerSingleton(vO.b,qU),a.ModuleContainer.registerSingleton(ZU.a,$U),a.ModuleContainer.registerSingleton(YU,XU),a.ModuleContainer.registerSingleton(EU,tB),a.ModuleContainer.registerSingleton(MU,aB),a.ModuleContainer.registerSingleton(RU,nB),a.ModuleContainer.registerSingleton(SU.a,SU.b),a.ModuleContainer.registerSingleton(rB.a,rB.b),a.ModuleContainer.registerSingleton(xU.a,xU.b);var oB,cB=s("WDlm"),lB=s("Ivja"),dB=s("3rJp"),uB=s("j+NN");let hB=Object(a.injectable)()(oB=Reflect.metadata("design:type",Function)(oB=Reflect.metadata("design:paramtypes",[])(oB=class{constructor(){this.name=void 0,this.key=void 0,this.name=cB.b,this.key=cB.b}async doVerify(e){Object(sO.h)("call doVerify",null==e?void 0:e.length);const t=(null==e?void 0:e.length)&&!!lB.a.instance().isKeyAvailable(),{myCloudItems:s,decryptItems:a,submitItems:i,updateThumbUrlItems:n}=await this.analyse(e);Object(sO.h)("analysed...",null==s?void 0:s.length,null==a?void 0:a.length,null==i?void 0:i.length,null==n?void 0:n.length);let r=[];if(Object(nS.b)().isEnableSubmitExtraInfoConv("mycloud")&&s.length>0){const e=await this.updateMyCloudItems(s);r=[...r,...e]}if(Object(nS.b)().isEnableSubmitExtraInfoConv("other")&&t&&a.length>0){const e=await this.updatePCloudItems(a);r=[...r,...e]}if(Object(nS.b)().isEnableSubmitExtraInfoConv("e2ee")&&t&&i.length>0){const e=await this.submitAndUpdatePCloudItems(i);r=[...r,...e]}if(n.length>0){const e=await this.updateThumbUrl(n);r=[...r,...e]}return r}async analyse(e){const t=e,s=Ce.default.sendToMeId;if(0===t.length||!s)return{myCloudItems:[],decryptItems:[],submitItems:[],updateThumbUrlItems:[]};const a=[],i=[],n=[],r=[];for(let g=0;g<t.length;g++){var o,c,l,d,u,h;const e=t[g];if(!e)continue;const m=(null==e||null===(o=e.msgInfo)||void 0===o?void 0:o.destId)==s,p=null==e||null===(c=e.msgInfo)||void 0===c?void 0:c.isE2EE,f=null===(l=e.mediaInfo)||void 0===l||null===(d=l.mediaExtInfo)||void 0===d?void 0:d.data,v=null===(u=e.mediaInfo)||void 0===u||null===(h=u.mediaExtInfo)||void 0===h?void 0:h.decryptedData;if(v){this.shouldUpdateThumbUrl(t[g],v)&&r.push(e)}else m?f||a.push(e):p?v||(f?i.push(e):n.push(e)):v||f&&i.push(e)}return{myCloudItems:a,decryptItems:i,submitItems:n,updateThumbUrlItems:r}}shouldUpdateThumbUrl(e,t){const s=ui.default.normalizeMessageType(e.msgInfo.msgType);if(uB.a.includes(s))try{return!Object(QE.a)(t).thumbUrl}catch(a){return!1}return!1}async updateThumbUrl(e){const t=Object(dB.b)(e),s=await ue.a.getInstance().getMultiMessages(t);if(!s)return[];const a=[];if((t=>{for(let s=0;s<t.length;s++){const i=t[s],n=e.find((e=>$E.a.getZCloudKeyFromCloudItem(e)===$E.a.getZCloudKeyFromQueryItem(i)));if(!i||!n)continue;const r=Object(dB.g)(n,i);r&&a.push(r)}})(s),0===a.length)return[];try{return await ue.a.getInstance().updateCloudQueue(a,["mediaInfo"]),Object(sO.r)("[updateThumbUrl] has success","updateClouds",a.length),a}catch(i){throw Object(sO.q)("[updateThumbUrl] has error",i),i}}async updateMyCloudItems(e){const t=Object(dB.b)(e),s=await ue.a.getInstance().getMultiMessages(t);if(!s)return[];const a=[];if((t=>{for(let s=0;s<t.length;s++){const i=t[s],n=e.find((e=>$E.a.getZCloudKeyFromCloudItem(e)===$E.a.getZCloudKeyFromQueryItem(i)));if(!i||!n)continue;const r=Object(dB.d)(n,i);r&&a.push(r)}})(s),0===a.length)return[];try{return await ue.a.getInstance().updateCloudQueue(a,["mediaInfo"]),Object(sO.r)("[updateMyCloudItems] has success","updateClouds",a.length),a}catch(i){throw Object(sO.q)("[updateMyCloudItems] has error",i),i}}decryptAndUpdateParams(e){return new Promise((async t=>{try{var s,a,i,n;const r=(null===(s=e.mediaInfo.mediaExtInfo)||void 0===s?void 0:s.data)||"",o=(null===(a=e.mediaInfo)||void 0===a||null===(i=a.mediaExtInfo)||void 0===i||null===(n=i.encryptInfo)||void 0===n?void 0:n.encryptKey)||"";Object(sO.h)("decryptAndUpdateParams...",r,o);let c=await lB.a.instance().decryptCloudInfo(r,o);if(c){const s=$E.a.getZCloudKeyFromCloudItem(e),a={};c=await this.updateDecryptedData(e,c),a[s]=c,Object(sO.r)("decrypt succcess",null==e?void 0:e.noiseId),t(a)}}catch(r){Object(sO.q)("[updatePCloudItems] => [decryptAndUpdateParams], has error",r),Object(sO.g)("decrypt info failed",null==e?void 0:e.noiseId,r),t("")}}))}async updateDecryptedData(e,t){const s=ui.default.normalizeMessageType(e.msgInfo.msgType);if(uB.a.includes(s)){let s=Object(QE.a)(t);if(s.thumbUrl)return JSON.stringify(s);const i=Object(dB.b)([e]),n=await ue.a.getInstance().getMultiMessages(i);if(n){const e=n;var a;if(e&&e[0])return s=Object(I.a)(Object(I.a)({},s),{},{thumbUrl:null===(a=e[0].message)||void 0===a?void 0:a.thumbUrl}),JSON.stringify(s)}}return t}async updatePCloudItems(e){const t=[],s=[];let a={};e.forEach((e=>{s.push(this.decryptAndUpdateParams(e))}));try{return(await Promise.allSettled(s)).forEach((e=>{e.value&&(a=Object(I.a)(Object(I.a)({},a),e.value))})),e.forEach((e=>{const s=$E.a.getZCloudKeyFromCloudItem(e);let i=a[s];if(i){const s=Object(dB.e)(e,i);t.push(s)}})),0===t.length?[]:(await ue.a.getInstance().updateCloudQueue(t,["mediaInfo"]),Object(sO.r)("[updatePCloudItems] has success","updateClouds",t.length),t)}catch(i){throw Object(sO.q)("[updatePCloudItems] has error",i),i}}encryptParams(e,t){return new Promise((async s=>{try{const a=await Object(dB.c)(e,t);s(a||"")}catch(a){Object(sO.q)("[submitAndUpdatePCloudItem] =>[encryptParams], has error",a),s("")}}))}async submitAndUpdatePCloudItems(e){const t=Object(dB.b)(e),s=await ue.a.getInstance().getMultiMessages(t);if(!s)return[];const a=[],i=[];(t=>{for(let s=0;s<t.length;s++){const i=t[s],n=e.find((e=>$E.a.getZCloudKeyFromCloudItem(e)===$E.a.getZCloudKeyFromQueryItem(i)));i&&n&&a.push(this.encryptParams(n,i))}})(s);try{const t=(await Promise.allSettled(a)).map((e=>e.value)).filter((e=>!!e)),s=t.map((e=>e.submit));if(0===s.length)return[];0;const n=await fO.a.submitMediaExtInfo({info:s});return Object(sO.r)("submit ext info success",n),t.forEach((t=>{const s=e.find((e=>e.noiseId===t.submit.noiseId));n&&s&&!n.noiseIdsErr.includes(s.noiseId)&&i.push(Object(dB.f)(s,t))})),0===i.length?[]:(await ue.a.getInstance().updateCloudQueue(i,["mediaInfo","encryptInfo"]),Object(sO.r)("[submitAndUpdatePCloudItems] has success","updateClouds",i.length),Object(sO.h)("update cloud success",i),i)}catch(n){throw Object(sO.q)("[submitAndUpdatePCloudItems] has error",n),n}}})||oB)||oB)||oB;var gB=s("LA5e");const mB="zcloud-queue-fetcher",pB=Object(a.define)(mB),fB="zcloud-base-sync-queue";Object(a.define)(fB);var vB;let _B=Object(a.injectable)()(vB=Reflect.metadata("design:type",Function)(vB=Reflect.metadata("design:paramtypes",[])(vB=class{constructor(){this.name=void 0,this.key=void 0,this.name=fB,this.key=fB}groupFetchedCloudsByAction(e){const t=[],s=[],a=[];for(let i=e.length-1;i>=0;i--){let n=e[i];if(n){let{action:e}=n;switch(e){case ZE.a.add:a.push(n);break;case ZE.a.remove:s.push(n);break;case ZE.a.del_thread:t.push(n)}}}return{delThreads:t,delClouds:s,addClouds:a}}})||vB)||vB)||vB;var bB=s("vNFC"),IB=s("FvOk");const yB="zcloud-update-queue-after-fetch-queue",SB=Object(a.define)(yB);var CB=s("ZL0F"),EB=s("5BgH");const OB=["lastNoiseId"];var MB;let TB=Object(a.injectable)()(MB=function(e,t){return Object(a.inject)(pB)(e,void 0,0)}(MB=function(e,t){return Object(a.inject)(SB)(e,void 0,1)}(MB=function(e,t){return Object(a.inject)(CB.a)(e,void 0,2)}(MB=Reflect.metadata("design:type",Function)(MB=Reflect.metadata("design:paramtypes",[void 0===pB?Object:pB,void 0===SB?Object:SB,void 0===CB.a?Object:CB.a])(MB=class extends _B{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloud,[w.ZLoggerNametags.zCloudVerifyQueueServices])),this._Logger}constructor(e,t,s){super(),this.queueFetcher=e,this.updateQueueService=t,this.syncZCloudQueueUIState=s,this.name=void 0,this.key=void 0,this._Logger=void 0,this.name=gB.a,this.key=gB.a}get PCloudMetrics(){return a.ModuleContainer.resolve(nS.g)}async checkVerify(e){const{lastNoiseId:t,forceVerify:s,forceReset:a}=e.mycloudMedia;let i=await ue.a.getInstance().getLastNoiseId();return a?{sourceForceVerify:bB.a.CMD_621_FORCE_RESET}:s?{sourceForceVerify:bB.a.CMD_621_FORCE_VERIFY}:i?t!==i?{sourceVerify:bB.b.CMD_621_VERIFY}:{}:{sourceForceVerify:bB.a.CMD_621_EMPTY_LAST_NOISEID}}async buildVerifyFetchReq(e){try{return{lastNoiseId:await ue.a.getInstance().getLastNoiseId(),lastNoiseIds:[],loadType:ZE.d.oldest_to_newest,trackingSource:e.trackingSource}}catch(t){throw t}}buildForceVerifyFetchReq(e){return{lastNoiseId:"",lastNoiseIds:[],loadType:ZE.d.oldest_to_newest,trackingSource:e.trackingSource}}shouldCheckResetItem(e){return(null==e?void 0:e.sourceForceVerify)!==bB.a.CMD_620_RESET_CLOUD}async doFetch(e,t,s,a=!1){const i={lastNoiseId:"",cloudItems:[],hasMore:!1};let n=!0,r=!a&&this.shouldCheckResetItem(s);for(t===IB.a.VERIFY_PAGE&&(i.preventCheckResetItem=a);n;){var o;const{cloudItems:s,lastNoiseId:a,hasMore:c}=await this.queueFetcher.fetchQueueByPage(e),l=null!=a?a:null===(o=s[0])||void 0===o?void 0:o.noiseId;if(s.find((e=>e.action===ZE.a.reset_cloud))&&this.Logger.zsymb(0,"ydAAS0","doFetch ###### [DEV-DEBUG] ##### FOUND RESET ITEM ######"),r){s.find((e=>e.action===ZE.a.reset_cloud))?(this.Logger.zsymb(0,"KkZWS-","doFetch, force verify from [found reset_item], sourceForceVerify",bB.a.VERIFY_FOUND_RESET_CLOUD),await ue.a.getInstance().removeAll(),i.cloudItems=[],i.lastNoiseId="",e.lastNoiseId="",n=!0,r=!1,t===IB.a.VERIFY_PAGE&&(i.preventCheckResetItem=!0)):(i.cloudItems.unshift(...s),i.lastNoiseId=l,i.hasMore=!!c,e.lastNoiseId=l,n=!!c)}else i.cloudItems.unshift(...s),i.lastNoiseId=l,i.hasMore=!!c,e.lastNoiseId=l,n=!!c;if(t===IB.a.VERIFY_PAGE&&i.cloudItems.length>0)break}return i}async verify(e){if(EB.a.getInstance().isBlocked)throw Error("Local db is blocked");const{data:t,syncStrategy:s,sourceSync:a,req:i,preventCheckResetItem:n}=e;try{const e=i||await this.buildVerifyFetchReq(t),{cloudItems:r,lastNoiseId:o,hasMore:c,preventCheckResetItem:l}=await this.doFetch(e,s,a,n),{delThreads:d,delClouds:u,addClouds:h}=this.groupFetchedCloudsByAction(r);return{delThreads:d,delClouds:u,addClouds:h,lastNoiseId:o,hasMore:c,preventCheckResetItem:l}}catch(r){throw r}}forceVerify(e){const{data:t,syncStrategy:s,sourceSync:a,req:i,preventCheckResetItem:n}=e,r=i||this.buildForceVerifyFetchReq(t);return this.verify({data:t,syncStrategy:s,sourceSync:a,req:r,preventCheckResetItem:n})}async doVerifyWithSourceVerify(e,t,s){let a=null;return a=await this.verify({data:{trackingSource:ZE.k.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceVerify:t},preventCheckResetItem:s}),a}async doForceVerifyWithOtherForceVerify(e,t,s){let a=null;return this.syncZCloudQueueUIState.setForceSyncSource(t),this.Logger.zsymb(0,"k9-79z","syncQueueByVerify, otherForceVerify",t),await ue.a.getInstance().removeAll(),a=await this.forceVerify({data:{trackingSource:ZE.k.Need_Verify_CMD},syncStrategy:e,sourceSync:{sourceForceVerify:t},preventCheckResetItem:s}),a}async doVerifyWithServerCmd(e,t,s){let a=null;Object(sO.r)("doVerifyWithServerCmd",e,t,s);const{sourceForceVerify:i,sourceVerify:n}=await this.checkVerify(e);return i===bB.a.CMD_621_FORCE_RESET||i===bB.a.CMD_621_FORCE_VERIFY||i===bB.a.CMD_621_EMPTY_LAST_NOISEID?(this.Logger.zsymb(0,"te-5-h","syncQueueByVerify, sourceForceVerify",i),this.syncZCloudQueueUIState.setForceSyncSource(i),await ue.a.getInstance().removeAll(),a=await this.forceVerify({data:{trackingSource:ZE.k.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceForceVerify:i},preventCheckResetItem:s})):n===bB.b.CMD_621_VERIFY&&(Object(sO.r)("doVerifyWithServerCmd, sourceVerify",n),a=await this.verify({data:{trackingSource:ZE.k.Need_Verify_CMD},syncStrategy:t,sourceSync:{sourceVerify:n}})),a}async doVerify(e){const{data:t,syncStrategy:s,sourceVerify:a,otherForceVerify:i,preventCheckResetItem:n=!1}=e;let r=null;if(a?r=await this.doVerifyWithSourceVerify(s,a,n):i===bB.a.TOOL_CLIENT||i===bB.a.CMD_620_RESET_CLOUD||i==bB.a.SELF_VERIFY?r=await this.doForceVerifyWithOtherForceVerify(s,i,n):t&&(r=await this.doVerifyWithServerCmd(t,s,n)),r){var o,c,l;const{lastNoiseId:e}=r,t=Object($i.a)(r,OB);this.Logger.zsymb(0,"TMo6fP","syncQueueByVerify, after fetched & filtered actions, ","added clouds",null===(o=t.addClouds)||void 0===o?void 0:o.length,"deleted clouds",null===(c=t.delClouds)||void 0===c?void 0:c.length,"deleted thread",null===(l=t.delThreads)||void 0===l?void 0:l.length),await this.updateQueueService.updateQueue(Object(I.a)(Object(I.a)({},t),{},{lastNoiseId:e})),this.Logger.zsymb(0,"FvWHNK","syncQueueByVerify, done update db, lastNoiseId",e)}return r}async submitVerifyAction(e){try{await fO.a.submitVerifyAction({type:e})}catch(t){this.Logger.zsymb(18,"mv4DGz","submitVerifyAction",t)}}})||MB)||MB)||MB)||MB)||MB)||MB;var RB,wB=s("zCNv");async function LB(e){for(let t=0;t<e.length;t++){const s=e[t];wB.a.getInstance().log("queue",...wB.a.getLogArgFromCloudItem(s))}}let DB=Object(a.injectable)()(RB=Reflect.metadata("design:type",Function)(RB=Reflect.metadata("design:paramtypes",[])(RB=class extends _B{constructor(){super(),this.name=void 0,this.key=void 0,this.name=yB,this.key=yB}async updateQueue(e){const{delThreads:t,delClouds:s,addClouds:a,lastNoiseId:i}=e;return(null==a?void 0:a.length)>0&&(Object(sO.j)("add -------",a.map((e=>e.noiseId))),await qE.a.getInstance().setCloudItems(a,!0),await LB(a)),(null==s?void 0:s.length)>0&&(Object(sO.j)("del -------",s.map((e=>e.noiseId))),await qE.a.getInstance().removeCloudItems(s,!0),await LB(s)),(null==t?void 0:t.length)>0&&(Object(sO.j)("delThread -------",t.map((e=>e.noiseId))),await qE.a.getInstance().delThreads(t,!0),await LB(t)),i&&await qE.a.getInstance().setLastNoiseId(i,Date.now()),[]}})||RB)||RB)||RB;var AB;let FB=Object(a.injectable)()(AB=Reflect.metadata("design:type",Function)(AB=Reflect.metadata("design:paramtypes",[])(AB=class{constructor(){this.name=void 0,this.key=void 0,this.name=mB,this.key=mB}async fetchQueue(e){const{loadType:t,lastNoiseIds:s,trackingSource:a}=e;let{lastNoiseId:i}=e;const n={lastNoiseId:"",cloudItems:[]};let r=!0;for(;r;){var o;const{mediaItems:e,hasMore:c,lastNoiseId:l}=await fO.a.verifyCloudMedia(i,t,s,a);Object(sO.d)("fetchQueue",l,null==e?void 0:e.length,c);const d=null!=l?l:null===(o=e[0])||void 0===o?void 0:o.noiseId,u=e.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));n.cloudItems.unshift(...u),n.lastNoiseId=d,i=d,r=c}return n}async fetchQueueByPage(e){var t;const{lastNoiseId:s,lastNoiseIds:a,loadType:i,trackingSource:n}=e,r={lastNoiseId:"",cloudItems:[],hasMore:0};Object(sO.d)("call verifyCloudMedia",s,a,i,n);const{mediaItems:o,lastNoiseId:c,hasMore:l}=await fO.a.verifyCloudMedia(s,i,a,n);Object(sO.d)("fetchQueueByPage",null==o?void 0:o.length,c,l);const d=null!=c?c:null===(t=o[0])||void 0===t?void 0:t.noiseId,u=o.sort(((e,t)=>t.msgInfo.ts-e.msgInfo.ts));return r.cloudItems=u,r.lastNoiseId=d,r.hasMore=l,r}})||AB)||AB)||AB;var kB=s("jqP8"),NB=s("Hvyc"),PB=s("Dr9L");const jB="zcloud-media-pc-fetcher",UB=Object(a.define)(jB),BB="zcloud-media-web-fetcher",zB=Object(a.define)(BB);var GB;let xB,VB=Object(m.d)()(GB=Object(m.h)()(GB=Object(m.i)()(GB=Object(a.injectable)()(GB=function(e,t){return Object(a.inject)(UB)(e,void 0,0)}(GB=function(e,t){return Object(a.inject)(zB)(e,void 0,1)}(GB=Reflect.metadata("design:type",Function)(GB=Reflect.metadata("design:paramtypes",[void 0===UB?Object:UB,void 0===zB?Object:zB])(GB=class extends kB.a{constructor(e,t){super(),this.pcFetcher=e,this.webFetcher=t,this.name=void 0,this.key=void 0,this.cleanupTimeoutId=void 0,this.name=NB.b,this.key=NB.b,this.cleanupTimeoutId=null}onSessionExpired(){this.cleanup()}onDispose(){this.cleanup()}onApplicationReady(){this.cleanup()}doCleanupAfterTimeout(e){e&&(this.cleanupTimeoutId=setTimeout((()=>{this.cleanup()}),e))}clearCleanupTimeoutId(){this.cleanupTimeoutId&&clearTimeout(this.cleanupTimeoutId)}async getCloudItem(e){const t=this.getCloudQueryByMessage(e);return t?this.getCloudItemByCloudQuery(t):null}async getDownloadUrl(e,t,s){return this.getUrl(e,t,s)}async getDownloadHeaders(){return this.getHeaders()}async fetch(e){const{cloud:t,message:s,options:a}=e,{type:i}=a,n=await this.getDownloadUrl(t.cloud,s,i),r=await this.getHeaders();if(!n||!r)throw PB.b.getError(Object(I.a)(Object(I.a)({},PB.a.INVALID_PARAMS),{},{message:"No cloud "+(n?"headers":"url")}));return this.pcFetcher.fetch({url:n,headers:r,cloud:t.cloud,options:a})}async cleanup(){}})||GB)||GB)||GB)||GB)||GB)||GB)||GB)||GB;(xB||(xB={})).buildData=function(e){return ui.default.normalizeMessageType(e.msgInfo.msgType),Y.MSG_FILE,function(e){var t,s;const{zKey:a,msgInfo:i,mediaInfo:n}=e,{msgType:r,destId:o}=i,c=ui.default.normalizeMessageType(r),l=Object(Wp.e)(null!=a?a:$E.a.getZCloudKeyFromCloudItem(e),c),d=$E.a.getConversationIdFromCloudItem(e,Re.default.getUserId()),u=Object(QE.a)(o===Ce.default.sendToMeId?null==n||null===(t=n.mediaExtInfo)||void 0===t?void 0:t.data:null==n||null===(s=n.mediaExtInfo)||void 0===s?void 0:s.decryptedData),{fileSize:h,checksum:g,fType:m,title:p,fileExt:f}=u,v=p||wl.a.NoNameFile,_=f||v.split(".").pop();return{fileName:v,localPath:l,conversationId:d,msgType:c,fileSize:h,checksum:g,fType:m,ext:_}}(e)};var HB=xB;const WB=["options"];var qB;let KB=Object(a.injectable)()(qB=Reflect.metadata("design:type",Function)(qB=Reflect.metadata("design:paramtypes",[])(qB=class{constructor(){this.name=void 0,this.key=void 0,this.name=jB,this.key=jB}async fetch(e){const{url:t,headers:s,cloud:a,options:i}=e,{options:n}=i,r=Object($i.a)(i,WB),o=Object.assign(n,{headers:s}),c=Object.assign(HB.buildData(a),{url:t});return tt.default.run(Object(I.a)(Object(I.a)({},r),{},{options:o,data:c}))}})||qB)||qB)||qB;var ZB;let $B=Object(a.injectable)()(ZB=Reflect.metadata("design:type",Function)(ZB=Reflect.metadata("design:paramtypes",[])(ZB=class{constructor(){this.name=void 0,this.key=void 0,this.name=BB,this.key=BB}async fetch(e){const{url:t,options:s}=e,a=null!=s&&s.options?Object(I.a)(Object(I.a)({},null==s?void 0:s.options),{},{headers:e.headers}):{headers:e.headers},i=null==s?void 0:s.queueType,n=null==s?void 0:s.onProgress;return Object(at.h)(Object(at.j)().toString(),t,i,n,a)}})||ZB)||ZB)||ZB;const QB="zcloud-photo-fetcher",YB=Object(a.define)(QB);var JB=s("LeFD");const XB=$znode.path,ez=e=>tt.default.run(e),tz=e=>new Promise((async(t,s)=>{try{var a;const{url:n,localPath:r,timeout:o=6e4,maxTTFB:c=2e4,signal:l,noCacheRespFail:d,disableCache:u,msgId:h,entrySerial:g,mediaId:m,options:p,sendDttm:f}=e,v=XB.basename(r),_=XB.dirname(r),b=Object(I.a)({srcAction:u?tt.default.constants.srcAction.Manual:tt.default.constants.srcAction.Dev,saveDir:_,caching:!0,cacheResp:{noCacheRespFail:d},error:{handleError:!0},maxTTFB:c,mediaId:m},p),y={entrySerial:g,type:tt.default.constants.DownloadType.Photo,data:{url:n,fileName:v,msgId:h,sendDttm:f},options:b},S=()=>{s(new JB.a)};if(null!=l&&l.aborted)return S();null==l||l.addEventListener("abort",S);const C=setTimeout((()=>{s(new JB.d)}),o),E=await Object(Ef.a)(ez,y);if(null==l||l.removeEventListener("abort",S),clearTimeout(C),E.ok)return t(null);const O=E.error;if(!O)return s(new JB.f);const M="string"==typeof(null==O?void 0:O.code)||"number"==typeof(null==O?void 0:O.code)?null==O?void 0:O.code:null==O||null===(a=O.downloadError)||void 0===a?void 0:a.code;if(isNaN(M))return s(new JB.f(O.name));if(M>=75e3&&M<76e3){const e=M-75e3;if(nf.a.image_loader.enable){var i;const t=null===(i=nf.a.image_loader.retryErrorCodes)||void 0===i?void 0:i.some((t=>t===e));if(!!f&&t&&Object(Tf.a)(f))return s(new Of.NotReadyError)}return s(new JB.c(e))}return s(1010==M?new JB.d:new JB.f(M))}catch(n){const e=new JB.f("[LoadPhotoPC]"+(null==n?void 0:n.message));return null!=n&&n.stack&&(e.stack=n.stack),s(e)}}));var sz;let az=Object(a.injectable)()(sz=function(e,t){return Object(a.inject)(NB.a)(e,void 0,0)}(sz=Reflect.metadata("design:type",Function)(sz=Reflect.metadata("design:paramtypes",[void 0===NB.a?Object:NB.a])(sz=class extends kB.a{constructor(e){super(),this.mediaZCloudFetcher=e,this._responsesCache=new Map,this._blobURLReserveMap=new Map,this.name=void 0,this.key=void 0,this._downloadHandler=async e=>{const{localPath:t}=e,s=await Object(Ef.a)(tz,e),a=s.ok?t:"";if(s.ok)return{mediaURL:a,error:void 0};throw s.error},this._downloadWithRetry=Object(af.a)(this._downloadHandler,{min:nf.a.image_loader.retryMin,max:nf.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:nf.a.image_loader.lastTryDelayTime.min,max:nf.a.image_loader.lastTryDelayTime.max},shouldRetryOnError:async({error:e})=>e instanceof vk.a.NotReadyError||e instanceof vk.a.TimeoutTTFB||e instanceof vk.a.TimeoutError}),this.name=QB,this.key=QB}async fetchOnWeb(e,t){Object(ef.a)("string"==typeof t&&tf(t),`Media source must be a (http|https) URL. Got ${t}`);const s=this._responsesCache.get(t);if(s&&!s.isRevoked)return Np.l.Success({mediaURL:this._responsesCache.get(t).blobURL});try{const s=Object(at.j)().toString(),a=Object(af.a)(at.h,{min:nf.a.image_loader.retryMin,max:nf.a.image_loader.retryMax,retries:3,lastTryDelayTime:{min:nf.a.image_loader.lastTryDelayTime.min,max:nf.a.image_loader.lastTryDelayTime.max}}),i=await this.mediaZCloudFetcher.getDownloadHeaders(),n=await a(s,t,at.a.dev,void 0,{useDiskCache:!1,headers:i});if(n.error)return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:n.error}});const r=this._responsesCache.get(t)||{};return this._cacheResponse(t,Object(I.a)(Object(I.a)({},r),{},{remoteURL:t,blobURL:n.data,mediaId:e,isRevoked:!1})),Np.l.Success({mediaURL:n.data})}catch(a){return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:a}})}}_cacheResponse(e,t){this._responsesCache.set(e,t),this._blobURLReserveMap.set(t.blobURL,e)}async fetchOnPC(e,t,s){const{entrySerial:a,savePath:i}=s;if(i&&Object(Hi.a)(i))return Np.l.Success({mediaURL:i});try{let n={url:t,mediaId:e,localPath:i,entrySerial:a,sendDttm:null==s?void 0:s.sendDttm,noCacheRespFail:(null==s?void 0:s.sendDttm)&&Object(Tf.a)(null==s?void 0:s.sendDttm)};const r=await this.mediaZCloudFetcher.getDownloadHeaders(),o=s.autoDownload?{srcAction:tt.default.constants.srcAction.Auto,headers:r}:{headers:r};n.options=o;const c=await this._downloadWithRetry(n);return c.error?Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:c.error}}):Np.l.Success({mediaURL:i})}catch(n){return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH,error:{mediaURL:t,error:n}})}}async fetch(e){const{mediaId:t,source:s,diskFetcherConfig:a}=e;let i;Object(ef.a)("string"==typeof t,`MediaFetcherImpl: mediaId must be a string. Got ${t}`),Object(ef.a)("string"==typeof s,`MediaFetcherImpl: source must be a string. Got ${s}`),i=a?Np.j.DiskCache:Np.j.MemoryCache;const n=tf(s),r=sf(s);if(!n&&r)return Np.l.Success({mediaURL:s});if(!n&&!r){var o,c;const e=!r||["file://","zfile://"].some((e=>s.startsWith(e)));if(e&&(null===(o=$znode.fs)||void 0===o?void 0:o.existsSync(null==s||null===(c=s.replace("file://",""))||void 0===c?void 0:c.replace("zfile://",""))))return Np.l.Success({mediaURL:s});if(e)return Np.l.Failure({code:Np.d.FAILURE_BY_FETCH})}if(i===Np.j.MemoryCache)try{return await this.fetchOnWeb(t,s)}catch(u){return Promise.reject(u)}Object(ef.a)("object"==typeof a&&"string"==typeof a.savePath&&!!a.downloadEntrySerial,`MediaFetcherImpl: invalid diskFetcherConfig. Got ${a}`);const{savePath:l,downloadEntrySerial:d}=a;return this.fetchOnPC(t,s,{entrySerial:d,savePath:l})}})||sz)||sz)||sz)||sz;a.ModuleContainer.registerSingleton(cB.a,hB),a.ModuleContainer.registerSingleton(gB.b,TB),a.ModuleContainer.registerSingleton(SB,DB),a.ModuleContainer.registerSingleton(pB,FB),a.ModuleContainer.registerSingleton(NB.a,VB),a.ModuleContainer.registerSingleton(UB,KB),a.ModuleContainer.registerSingleton(zB,$B),a.ModuleContainer.registerSingleton(YB,az);var iz=s("v9wC"),nz=s("/078"),rz=s("Q8oB");const oz=Object(a.define)("zcloud-offload-client-storage");class cz{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("OffloadStorage already initialized");this.key="zcloud-offload-storage"}read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=s.getItemForCurrentUser(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItemForCurrentUser(e)}return null}write(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void a.setItemForCurrentUser(e,JSON.stringify({version:t,value:s}));this.remove(e)}remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,t.removeItemForCurrentUser(e)}}const lz="state_store",dz={isOffloading:!1};class uz{constructor(e){this.adapter=e,this._state=void 0}get isOffloading(){return!!this._state&&this._state.isOffloading}set isOffloading(e){this._state||(this._state=dz),this._state=Object(I.a)(Object(I.a)({},this._state),{},{isOffloading:e}),this.save()}load(){this._state=this.adapter.read(lz,1)}clear(){this._state=null,this.save()}save(){this._state?this.adapter.write(lz,1,this._state):this.adapter.remove(lz)}}a.ModuleContainer.registerSingleton(oz,class{constructor(){this._adapter=void 0,this._offloadStateStore=void 0,this._adapter=new cz,this._offloadStateStore=new uz(this._adapter)}load(){this._adapter.load(),this._offloadStateStore.load()}clear(){this._offloadStateStore.clear()}get offloadState(){return this._offloadStateStore}});var hz=s("LZ6X"),gz=s("n+2d");var mz,pz,fz,vz,_z,bz,Iz,yz,Sz,Cz,Ez,Oz,Mz,Tz,Rz,wz,Lz,Dz,Az,Fz=function(e){return function(t,s,i){const n=i.value;return i.value=function(...t){const s=a.ModuleContainer.resolve(e).getState().zCloudStatus;if(s.hasKey&&s.isPaid)return n.apply(this,t);Object(gz.a)("Not ready for offload: ",JSON.stringify(s))},i}},kz=s("hhQE"),Nz=s("y6jC");let Pz=(mz=Object(m.d)(),pz=Object(m.f)(),fz=Object(m.h)(),vz=Object(a.injectable)(),_z=function(e,t){return a.ModuleContainer.inject(nz.a)(e,void 0,0)},bz=function(e,t){return a.ModuleContainer.inject(rz.b)(e,void 0,1)},Iz=function(e,t){return a.ModuleContainer.inject(oz)(e,void 0,2)},yz=function(e,t){return a.ModuleContainer.inject(bO.a)(e,void 0,3)},Sz=function(e,t){return a.ModuleContainer.inject(nS.f)(e,void 0,4)},Cz=Reflect.metadata("design:type",Function),Ez=Reflect.metadata("design:paramtypes",[void 0===nz.a?Object:nz.a,void 0===rz.b?Object:rz.b,void 0===oz?Object:oz,void 0===bO.a?Object:bO.a,void 0===nS.f?Object:nS.f]),Oz=Fz(rz.b),Mz=Reflect.metadata("design:type",Function),Tz=Reflect.metadata("design:paramtypes",[]),Rz=Fz(rz.b),wz=Reflect.metadata("design:type",Function),Lz=Reflect.metadata("design:paramtypes",[]),mz(Dz=pz(Dz=fz(Dz=vz(Dz=_z(Dz=bz(Dz=Iz(Dz=yz(Dz=Sz(Dz=Cz(Dz=Ez((Az=class{constructor(e,t,s,a,i){this.OffloadConvsManager=e,this.uiController=t,this.storage=s,this.OnboardingEventsResolver=a,this.EventsResolver=i,this.name=void 0,this.key=void 0,this.timeoutId=void 0,this.offloadAbortController=new AbortController,this.eventHandler=void 0,this.name=iz.b,this.key=iz.b,this.timeoutId=null,this.eventHandler=this.exportImportDBEventHandler.bind(this),_e.default.subscribe(this.eventHandler)}abortOffloadIfPossible(e){this.offloadAbortController.abort(),this.offloadAbortController=new AbortController,this.storage.offloadState.clear(),e&&Object(gz.b)("aborted reason: ",e)}onDispose(){this.abortOffloadIfPossible("onDispose lifecycle"),this.clearTimeoutInAppSession(),_e.default.unsubscribe(this.eventHandler),Nz.a.getInstance().reset()}onAuthenticated(e){this.onLoadingOffload(e)}onLoadingOffload(e){this.storage.load(e.getSession().userId),this.storage.offloadState.clear(),this.addPlanListeners(),this.addKeyListeners(),this.addMigrationListeners(),this.addVerifyQueueListeners(),this.addNetworkListeners()}onApplicationReady(){this.onStartingOffload()}onStartingOffload(){this.onInitZCloudStatus(),this.onTryCheckValidCondition()}onChangeEnableSetting(e){e?this.onEnablOffloadSettingChanged():this.onDisableSettingChanged()}onInitZCloudStatus(){const e=this.uiController.getState().zCloudStatus,t=ue.a.getInstance().checkUpgraded(),s=hO.a.getInstance().isPaidUser();Object(gz.b)("init status:",JSON.stringify(Object(I.a)(Object(I.a)({},e),{},{hasKey:t,isPaid:s}))),this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{hasKey:t,isPaid:s}))}addPlanListeners(){this.EventsResolver.addEventListener(nS.a.UPGRADE_ZCLOUD_PLAN,this.onHandleUpgradePlan.bind(this)),this.EventsResolver.addEventListener(nS.a.OFF_PERSONAL_CLOUD_PLAN,this.onHandleFreePlan.bind(this)),this.EventsResolver.addEventListener(nS.a.GRACE_PERIOD_ZCLOUD_PLAN,this.onHandleGracePeriod.bind(this))}addKeyListeners(){ue.a.getInstance().addListener(ZE.c.UPDATE_CLOUD_KEY_STATUS,this.onChangeCloudKeyStatus.bind(this))}addMigrationListeners(){this.OnboardingEventsResolver.addEventListener(_O.b.MOBILE_NOT_COMPLETED,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(_O.b.MOBILE_COMPLETED_BEFORE,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(_O.b.PC_COMPLETED_BEFORE,this.onHavingMigrateStatus.bind(this)),this.OnboardingEventsResolver.addEventListener(_O.b.MOBILE_JUST_MIGRATE_DONE,this.onMobileMigrated.bind(this))}addVerifyQueueListeners(){ue.a.getInstance().addListener(ZE.c.VERIFYING_QUEUE,this.onVerifyingQueue.bind(this)),ue.a.getInstance().addListener(ZE.c.SYNC_QUEUE_DONE,this.onQueueVerifiedDone.bind(this))}addNetworkListeners(){J.p.listenEvent(J.k,this.networkHandler.bind(this))}exportImportDBEventHandler(e,t){switch(e){case Yc.c.EXPORT_IMPORT_START:this.abortOffloadIfPossible("export-import running");break;case Yc.c.EXPORT_IMPORT_FINISHED:this.onTryCheckValidCondition()}}onHandleUpgradePlan(){const e=this.uiController.getState().zCloudStatus;Object(gz.b)("onHandleUpgradePlan",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{isPaid:!0})),this.onTryCheckValidCondition()}onHandleGracePeriod(){this.abortOffloadIfPossible("grace period");const e=this.uiController.getState().zCloudStatus;Object(gz.b)("onHandleGracePeriod",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{isPaid:!1})),Nz.a.getInstance().resetNecessaryStates()}onHandleFreePlan(){this.abortOffloadIfPossible("free plan");const e=this.uiController.getState().zCloudStatus;Object(gz.b)("onHandleFreePlan",JSON.stringify(e)),this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{isPaid:!1})),Nz.a.getInstance().clear()}onHavingMigrateStatus(e){const t=this.uiController.getState().zCloudStatus;switch(e.type){case _O.b.MOBILE_NOT_COMPLETED:this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},t),{},{isMigrated:!1}));break;case _O.b.MOBILE_COMPLETED_BEFORE:case _O.b.PC_COMPLETED_BEFORE:this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},t),{},{isMigrated:!0})),this.onTryCheckValidCondition()}}onMobileMigrated(){const e=this.uiController.getState().zCloudStatus;this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},e),{},{isMigrated:!0})),this.onTryCheckValidCondition()}onChangeCloudKeyStatus(e){const t=this.uiController.getState().zCloudStatus;this.uiController.setZCloudStatus(Object(I.a)(Object(I.a)({},t),{},{hasKey:e})),e&&this.onTryCheckValidCondition()}onVerifyingQueue(){this.abortOffloadIfPossible("verifying queue")}onQueueVerifiedDone(){this.onTryCheckValidCondition()}networkHandler(e){e===le.a.DISCONNECT?(Object(gz.b)("network disconnected"),this.abortOffloadIfPossible("network disconnected")):e===le.a.CONNECTED&&(Object(gz.b)("network reconnected"),this.onTryCheckValidCondition())}onTryCheckValidCondition(){this.checkBeforeOffload()}checkBeforeOffload(){this.shouldStartOffload()&&this.startOffload()}shouldStartOffload(){if(!Nz.a.getInstance().getSetting("enableOffload"))return Object(gz.b)("not start offload because enableOffload is falsy"),!1;if(this.storage.offloadState.isOffloading)return Object(gz.b)("not start offload because there is another offloading process"),!1;if(a.ModuleContainer.resolve(CB.a).isSyncing())return Object(gz.b)("not start offload because zcloud queue is verifying"),!1;const e=Nz.a.getInstance().getSetting("lastOffloadTime");if(!e)return!0;const t=Object(hz.a)().getCycleOptions()[0],s=Date.now()-e;if(s<t){Object(gz.b)("not start offload because of no reach interval time");const e=t-s;this.setTimeoutForNextTimeOffload(e)}return s>=t}setTimeoutForNextTimeOffload(e){this.clearTimeoutInAppSession(),this.timeoutId=setTimeout((()=>{this.onTryCheckValidCondition()}),e)}clearTimeoutInAppSession(){this.timeoutId&&clearTimeout(this.timeoutId)}onEnablOffloadSettingChanged(){this.checkShouldRunRightNow()}checkShouldRunRightNow(){this.shouldRightNowOffload()&&this.startOffload()}shouldRightNowOffload(){return!this.storage.offloadState.isOffloading}onDisableSettingChanged(){Object(hz.a)().getAbortPermission()&&this.abortOffloadIfPossible("user off toggle button")}async startOffload(){this.abortOffloadIfPossible(),this.storage.offloadState.isOffloading=!0;try{Object(gz.b)("start offload time: ",Date.now()),Nz.a.getInstance().onSend(Nz.b.onStart,Date.now());await this.OffloadConvsManager.offload(this.offloadAbortController.signal,this.onConvOffloaded.bind(this));Nz.a.getInstance().onSend(Nz.b.onEnd,Date.now()),Date.now()!==Nz.a.getInstance().getSetting("lastOffloadTime")&&(kz.a.logOffloadCompleted({offload_size:Nz.a.getInstance().getSetting("offloadingConvSize")}),Nz.a.getInstance().updateSetting("lastOffloadSize",Nz.a.getInstance().getSetting("offloadingConvSize")),Nz.a.getInstance().updateSetting("offloadingConvId",null),Nz.a.getInstance().updateSetting("offloadingConvSize",0),Nz.a.getInstance().updateSetting("lastOffloadTime",Date.now()),Nz.a.getInstance().updateSetting("isMarkedAsReadLastestOffloadPopup",!1),Nz.a.getInstance().updateSetting("isClickedZCloudOffloadCompletedTooltipMainAction",!1),Nz.a.getInstance().updateSetting("isClickedZCloudOffloadCompletedTooltipSkipAction",!1),Object(gz.b)("end offload time: ",Date.now())),this.setTimeoutForNextTimeOffload(Object(hz.a)().getCycleOptions()[0])}catch(e){Object(gz.a)("offload error: ",e)}finally{this.storage.offloadState.clear()}}onConvOffloaded(e,t){this.uiController.setOffloadingConv(e)}changeEnableOffload(e){Nz.a.getInstance().updateSetting("enableOffload",e),Nz.a.getInstance().updateSetting("onboardingOffloadCompleted",!0)}},Object(Ok.a)(Az.prototype,"onTryCheckValidCondition",[Oz,Mz,Tz],Object.getOwnPropertyDescriptor(Az.prototype,"onTryCheckValidCondition"),Az.prototype),Object(Ok.a)(Az.prototype,"onEnablOffloadSettingChanged",[Rz,wz,Lz],Object.getOwnPropertyDescriptor(Az.prototype,"onEnablOffloadSettingChanged"),Az.prototype),Dz=Az))||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz)||Dz);const jz="zcloud-offload-cloud-media-service",Uz=Object(a.define)(jz);let Bz=function(e){return e[e.PAGE_SIZE=20]="PAGE_SIZE",e}({});const zz={noiseId:"",zDate:Object(hz.a)().getMediaTTL(),offset:0};var Gz;let xz=Object(a.injectable)()(Gz=Reflect.metadata("design:type",Function)(Gz=Reflect.metadata("design:paramtypes",[])(Gz=class{constructor(){this.name=void 0,this.key=void 0,this.name=jz,this.key=jz}async fetchCloudMediaFromOldestToNewestByCOnv(e,t,s){const a=(null==t?void 0:t.zDate)||zz.zDate,i=(null==t?void 0:t.noiseId)||zz.noiseId,n=(null==t?void 0:t.offset)||zz.offset,r=(null==s?void 0:s.limit)||Bz.PAGE_SIZE;try{const t=await ue.a.getInstance().getAllByConversationTypeDate(e,"",a,i,r,O.c.NEXT,n),s=Object(I.a)(Object(I.a)({},t[t.length-1]),{},{offset:n+t.length});return t.length<r?{cloudItems:t,hasMore:!1,lastItem:s}:{cloudItems:t,hasMore:!0,lastItem:s}}catch(o){return{cloudItems:[],hasMore:!1,lastItem:null}}}filterCloudMediaByCreatedTime(e){return e.filter((e=>{const t=e.msgInfo.ts,s=Object(hz.a)().getMediaTTL();return Date.now()-t>s}))}})||Gz)||Gz)||Gz;const Vz="zcloud-offload-conversation-service",Hz=Object(a.define)(Vz);let Wz=function(e){return e[e.ACTIVE_DECREASE=0]="ACTIVE_DECREASE",e[e.ACTIVE_INCREASE=1]="ACTIVE_INCREASE",e}({});var qz,Kz=s("qwfD");let Zz=Object(a.injectable)()(qz=function(e,t){return a.ModuleContainer.inject(Nn.PreviewDataManager)(e,void 0,0)}(qz=Reflect.metadata("design:type",Function)(qz=Reflect.metadata("design:paramtypes",[void 0===Nn.PreviewDataManager?Object:Nn.PreviewDataManager])(qz=class{constructor(e){this.PreviewDataManager=e,this.name=void 0,this.key=void 0,this.name=Vz,this.key=Vz}onSortActionTime(e,t){return e.sort(((e,s)=>{var a,i;const n=(null===(a=this.PreviewDataManager.getPreviewByIDSync(e))||void 0===a?void 0:a.messageTime)||0,r=(null===(i=this.PreviewDataManager.getPreviewByIDSync(s))||void 0===i?void 0:i.messageTime)||0;switch(t){case Wz.ACTIVE_DECREASE:if(r&&n){if(r>n)return 1;if(r<n)return-1}return r&&!n?1:!r&&n?-1:0;case Wz.ACTIVE_INCREASE:if(r&&n){if(r<n)return 1;if(r>n)return-1}return!r&&n?1:r&&!n?-1:0;default:return 0}}))}async getClientUsageWithRetry(e=5,t=1e3){const s=e=>{const t=null==e?void 0:e.usageByConversation;return!(!Array.isArray(t)||null==t||!t.length)};let a=null,i=t,n=t;for(let r=0;r<e;r++){if(a=await Kz.a.getInstance().usage(!1),s(a))return a;await new Promise((e=>setTimeout(e,n)));const e=i+n;i=n,n=e}return Object(gz.b)(`get client usage failed after retry ${e} times`),a}async getConversationList(){const e=await this.getClientUsageWithRetry(),t=null==e?void 0:e.usageByConversation;return t?Object.keys(t):[]}async getConvIdsByActiveAscending(){const e=await this.getConversationList();if(!e||!e.length)return[];return this.onSortActionTime(e,Wz.ACTIVE_INCREASE)}})||qz)||qz)||qz)||qz;const $z="zcloud-offload-media-message-service",Qz=Object(a.define)($z);async function Yz(e,t=10){const s=[],a=new Set;for(const i of e)s.push(i),a.add(i),i.then((()=>a.delete(i))),a.size>=t&&await Promise.race(a);return Promise.allSettled(s)}var Jz;const Xz=s("IJ+6").FileRes;let eG=Object(a.injectable)()(Jz=Reflect.metadata("design:type",Function)(Jz=Reflect.metadata("design:paramtypes",[])(Jz=class{constructor(){this.name=void 0,this.key=void 0,this.getMessagesByCloudQuery=async(e,t)=>{try{return await $v.a.messageDBHandler.getMessagesByCliIdsOwnerIds(e,t)}catch(s){return Object(gz.a)("mapping messages error: ",s),null}},this.name=$z,this.key=$z}getCloudItemGroupByMsgType(e){let t={files:[],images:[],videos:[],voices:[],folders:[]};return e.forEach((e=>{switch(ui.default.normalizeMessageType(e.msgInfo.msgType)){case Y.MSG_PHOTO:case Y.MSG_PHOTO_2:case Y.MSG_DOODLE:t.images.push(e);break;case Y.MSG_VIDEO:t.videos.push(e);break;case Y.MSG_FILE:t.files.push(e);break;case Y.MSG_VOICE:t.voices.push(e)}})),t}async isAllMsgRefsValid(e){try{const t=[];e.forEach((e=>{t.push($v.a.messageDBHandler.getMessageByMsgId(e.msgId,e.convId))}));const s=(await Promise.allSettled(t)).flatMap((e=>"fulfilled"===e.status?e.value:[])),a=await qE.a.getInstance().getCloudItems(s);return a.every((e=>{if(!e)return Object(gz.b)("ref invalid because item is not clouded"),!1;const t=Date.now()-e.msgInfo.ts>Object(hz.a)().getMediaTTL();return t||Object(gz.b)("ref invalid because of not valid time",e.noiseId,e.msgInfo.ts),t}))}catch(t){return Object(gz.a)("error in check all refs valid: ",t),!1}}async checkValidRefForOffload(e){try{var t;if(null==Xz||!Xz.cache||null===(t=Xz.cache)||void 0===t||!t.getRefsByMessage)return!1;const s=await Xz.cache.getRefsByMessage(e);return!(s&&Array.isArray(s)&&s.length>=2)||await this.isAllMsgRefsValid(s)}catch(s){return Object(gz.a)("error check valid refs: ",s),!1}}async getValidTag(e){return{valid:await this.checkValidRefForOffload(e),item:e}}async filterValidFiles(e){const t=[],s=[];e.forEach((e=>{const t=this.getValidTag(e);s.push(t)}));return(await Yz(s)).forEach((e=>{"fulfilled"===e.status&&e.value.valid&&t.push(e.value.item)})),t}async getMediaMessageGroupsByCloudMediaItems(e,t){const{files:s,images:a,videos:i,voices:n}=this.getCloudItemGroupByMsgType(e),r=Object(dB.b)(a),o=await this.getMessagesByCloudQuery(r,t),c=Object(dB.b)(i),l=await this.getMessagesByCloudQuery(c,t),d=Object(dB.b)(s),u=await this.getMessagesByCloudQuery(d,t),h=Object(dB.b)(n),g=await this.getMessagesByCloudQuery(h,t),m={files:[],images:[],videos:[],voices:[],folders:[]};return Array.isArray(o)&&(m.images=o),Array.isArray(l)&&(m.videos=l),Array.isArray(g)&&(m.voices=g),Array.isArray(u)&&u.forEach((e=>{var t,s;(null===(t=Object(Ai.safeParseJson)(null==e||null===(s=e.message)||void 0===s?void 0:s.params))||void 0===t?void 0:t.fType)===wl.a.Ftype.Folder?m.folders.push(e):m.files.push(e)})),m.files=await this.filterValidFiles(m.files),m}})||Jz)||Jz)||Jz;const tG="zcloud-offload-delete-local-media-service",sG=Object(a.define)(tG),aG=Object(a.define)("zcloud-offload-local-media-cleaner");let iG,nG;nG=$znode.path,iG=s("Dprd").default;class rG extends LU.a{constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this.queue=e,this.numberOfRunningTasks=0}async clean(e){Object(gz.b)("call clean",e);let t=0;const{data:s}=e,{convId:i,files:n=[],images:r=[],videos:o=[],voices:c=[],folders:l=[]}=s,d=[];n.length>0&&d.push(a.ModuleContainer.resolve(sG).deleteFiles(n,i)),r.length>0&&d.push(a.ModuleContainer.resolve(sG).deletePhotos(r,i)),o.length>0&&d.push(a.ModuleContainer.resolve(sG).deleteVideos(o,i)),c.length>0&&d.push(a.ModuleContainer.resolve(sG).deleteVoices(c,i)),l.length>0&&d.push(a.ModuleContainer.resolve(sG).deleteFolders(l,i));try{Object(gz.b)("cleaning...",{files:n,images:r,videos:o,voices:c,folders:l});return(await Promise.allSettled(d)).forEach((e=>{"fulfilled"===e.status&&(t+=e.value)})),Object(gz.b)("cleaning success",t),t}catch(u){return Object(gz.a)("clean failed",u),0}}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const t=this.queue.shift();if(!t)break;this.numberOfRunningTasks++;const{data:s,resolve:a,reject:i}=t;try{a(await this.clean(s))}catch(e){i(e)}await new Promise((e=>setTimeout(e,Object(hz.a)().getDelayTimeBetweenCleanTask()))),this.numberOfRunningTasks--,this.run()}}}const oG=[],cG=new LU.b(oG),lG=new rG(oG),dG=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}async clean(e){const{data:t}=e,s=new Promise(((e,s)=>{const a={data:{data:t},resolve:e,reject:s};this.provider.send(a),this.consumer.run()}));return s.catch((()=>{})).finally((()=>{})),s}}(cG,lG);a.ModuleContainer.registerValue(aG,dG);var uG=dG;const hG="zcloud-offload-scan-local-media-service",gG=Object(a.define)(hG),mG=Object(a.define)("zcloud-offload-local-media-cleaner");let pG,fG;fG=$znode.path,pG=s("Dprd").default;class vG extends LU.a{get Logger(){return this._Logger||(this._Logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.zCloud,["zcloud-offload"])),this._Logger}constructor(e){super(),this.numberOfRunningTasks=void 0,this.queue=void 0,this._Logger=void 0,this.queue=e,this.numberOfRunningTasks=0}async run(){for(;this.queue.length>0&&this.numberOfRunningTasks<1;){const t=this.queue.shift();if(!t)break;this.numberOfRunningTasks++;const{data:s,resolve:i,reject:n}=t;try{const{files:e,images:t,videos:n,voices:r,folders:o}=s.data;let c=0;t&&(c+=await a.ModuleContainer.resolve(gG).calculatePhotoSize(t)),n&&(c+=await a.ModuleContainer.resolve(gG).calculateVideoSize(n)),e&&(c+=await a.ModuleContainer.resolve(gG).calculateFileSize(e)),r&&(c+=await a.ModuleContainer.resolve(gG).calculateVoiceSize(r)),o&&(c+=await a.ModuleContainer.resolve(gG).calculateFolderSize(o)),i(c)}catch(e){n(e)}await new Promise((e=>setTimeout(e,200))),this.numberOfRunningTasks--,this.run()}}}const _G=[],bG=new LU.b(_G),IG=new vG(_G),yG=new class{constructor(e,t){this.provider=void 0,this.consumer=void 0,this.provider=e,this.consumer=t}async scan(e){const{data:t}=e,s=new Promise(((e,s)=>{const a={data:{data:t},resolve:e,reject:s};this.provider.send(a),this.consumer.run()}));return s.catch((()=>{})).finally((()=>{})),s}}(bG,IG);a.ModuleContainer.registerValue(mG,yG);var SG=yG;var CG;let EG=Object(a.injectable)()(CG=function(e,t){return a.ModuleContainer.inject(Hz)(e,void 0,0)}(CG=function(e,t){return a.ModuleContainer.inject(Uz)(e,void 0,1)}(CG=function(e,t){return a.ModuleContainer.inject(Qz)(e,void 0,2)}(CG=Reflect.metadata("design:type",Function)(CG=Reflect.metadata("design:paramtypes",[void 0===Hz?Object:Hz,void 0===Uz?Object:Uz,void 0===Qz?Object:Qz])(CG=class{constructor(e,t,s){this.ConversationService=e,this.CloudMediaService=t,this.MediaMessageService=s,this.name=void 0,this.key=void 0,this.name=nz.b,this.key=nz.b}get zCloudOffloadUIController(){return a.ModuleContainer.resolve(rz.b)}async offloadByConvId(e,t){let s=0,a=!0,i=null;const n=Object(hz.a)().getDelayTimeBetweenConvQuery();let r=0;for(;a;){const o=Date.now();o-r<n&&await new Promise((e=>setTimeout(e,n-(o-r)))),r=Date.now();const c=await Promise.race([this.CloudMediaService.fetchCloudMediaFromOldestToNewestByCOnv(e,i,{limit:Object(hz.a)().getConvQueryLimit()}),t]);a=c.hasMore,i=c.lastItem;const l=await this.MediaMessageService.getMediaMessageGroupsByCloudMediaItems(this.CloudMediaService.filterCloudMediaByCreatedTime(c.cloudItems),e);let d;d=e.startsWith(Y.GROUPID_PREFIX)?yn.default.getDName(e):Ii.default.getDName(e),Object(gz.b)("start clean convId",e,"displayName",d);s+=await uG.clean({data:Object(I.a)(Object(I.a)({},l),{},{convId:e})})}return s}async scanOffloadByConvId(e,t){let s=0,a=!0,i=null;const n=Object(hz.a)().getDelayTimeBetweenConvQuery();let r=0;for(;a;){const o=Date.now();o-r<n&&await new Promise((e=>setTimeout(e,n-(o-r)))),r=Date.now();const c=await Promise.race([this.CloudMediaService.fetchCloudMediaFromOldestToNewestByCOnv(e,i,{limit:Object(hz.a)().getConvQueryLimit()}),t]);a=c.hasMore,i=c.lastItem;const l=await this.MediaMessageService.getMediaMessageGroupsByCloudMediaItems(this.CloudMediaService.filterCloudMediaByCreatedTime(c.cloudItems),e);s+=await SG.scan({data:Object(I.a)(Object(I.a)({},l),{},{convId:e})})}return s}async offload(e,t){const s=new Promise(((t,s)=>{const a=()=>{i(),s(new Error("abort offload!"))},i=()=>{e.removeEventListener("abort",a)};e.addEventListener("abort",a)})),a=await this.ConversationService.getConvIdsByActiveAscending();Object(gz.b)("list offload convId: ",a),this.zCloudOffloadUIController.setOffloadConvNum(0),this.zCloudOffloadUIController.setTotalOffloadConvNum(a.length),this.zCloudOffloadUIController.setInProgressOffloadSize(0);let i=0;const n=Nz.a.getInstance().getSetting("offloadingConvId"),r="string"==typeof n?a.findIndex((e=>e===n)):0,o=-1!==r?r:0,c=Nz.a.getInstance().getSetting("offloadingConvSize");c&&"number"==typeof c&&(i=c);for(let l=o;l<a.length;l++){Nz.a.getInstance().updateSetting("offloadingConvId",a[l]);const e=await this.offloadByConvId(a[l],s);i+=e,t(a[l],i),Object(gz.b)("done offload conv: ",a[l],e),this.zCloudOffloadUIController.setOffloadConvNum(l+1),this.zCloudOffloadUIController.setInProgressOffloadSize(i)}return i}async testScanOffload(e){const t=new Promise(((t,s)=>{const a=()=>{i(),s(new Error("abort offload!"))},i=()=>{e.removeEventListener("abort",a)};e.addEventListener("abort",a)}));let s=await this.ConversationService.getConvIdsByActiveAscending();const a=s.length;this.zCloudOffloadUIController.setTotalOffloadConvNum(a);let i=0;for(let n=0;n<a;n++){const e=await this.scanOffloadByConvId(s[n],t);this.zCloudOffloadUIController.setNewEstimatedSizeConv(s[n],e),i+=e}return i}})||CG)||CG)||CG)||CG)||CG)||CG;var OG,MG=s("KQkt"),TG=s("bUHp");const RG=$znode.path,wG=s("Dprd").default;let LG=Object(a.injectable)()(OG=Reflect.metadata("design:type",Function)(OG=Reflect.metadata("design:paramtypes",[])(OG=class{constructor(){this.name=void 0,this.key=void 0,this.name=tG,this.key=tG}isLikeFolderPath(e){return!!RG&&e.endsWith(null==RG?void 0:RG.join("~",RG.sep))}accumulateSize(e){if(!e||"number"!=typeof e)return;const t=Nz.a.getInstance().getSetting("offloadingConvSize")||0;if("number"==typeof t){const s=t+e;Object(gz.b)("accumulateSize",s,t,e),Nz.a.getInstance().updateSetting("offloadingConvSize",s)}}async deletePhoto(e,t){try{const s=await wG.isFile(e),a=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),Object(gz.b)("deletePhoto item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),a}catch(s){return Object(gz.a)("deletePhoto item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deletePhotos(e,t){try{let t=0;const s=J.p.getSessionUserId(),a=[];for(const i of e){const e=MG.a.getPathsByMessageIfExistSync(s,i);Array.isArray(e)&&e.length&&e.forEach((e=>{const t=this.deletePhoto(e.path,i);a.push(t)}))}return(await Yz(a)).forEach((e=>{"fulfilled"===e.status&&(t+=e.value)})),Object(gz.b)("deletePhotos totalSize: ",t),t}catch(s){return Object(gz.a)("deletePhotos error",s),0}}async deleteVideo(e,t){try{const s=await wG.isFile(e),a=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),Object(gz.b)("deleteVideo item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),a}catch(s){return Object(gz.a)("deleteVideo item error : ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteVideos(e,t){let s=0;const a=J.p.getSessionUserId();try{const t=[];for(const s of e){const e=MG.a.getPathsByMessageIfExistSync(a,s).filter((e=>e.type===TG.a.Video));Array.isArray(e)&&e.length&&e.forEach((e=>{const a=this.deleteVideo(e.path,s);t.push(a)}))}return(await Yz(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),Object(gz.b)("deleteVideos totalSize: ",s),s}catch(i){return Object(gz.a)("deleteVideos error",i),0}}async deleteFile(e,t){try{const s=await wG.isFile(e),a=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),Object(gz.b)("deleteFile item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),a}catch(s){return Object(gz.a)("deleteFile item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteFiles(e,t){let s=0;const a=J.p.getSessionUserId();try{const t=[];for(const s of e){const e=MG.a.getPathsByMessageIfExistSync(a,s);Array.isArray(e)&&e.length&&e.forEach((e=>{const a=this.deleteFile(e.path,s);t.push(a)}))}return(await Yz(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),Object(gz.b)("deleteFiles totalSize: ",s),s}catch(i){return Object(gz.a)("deleteFiles error",i),0}}async deleteVoice(e,t){try{const s=await wG.isFile(e),a=(null==s?void 0:s.size)||0;return $znode.fs.unlinkSync(e),Object(gz.b)("deleteVoice item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),a}catch(s){return Object(gz.a)("deleteVoice item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,s),0}}async deleteVoices(e,t){let s=0;const a=J.p.getSessionUserId();try{const t=[];for(const s of e){const e=MG.a.getPathsByMessageIfExistSync(a,s);Array.isArray(e)&&e.length&&e.forEach((e=>{const a=this.deleteVoice(e.path,s);t.push(a)}))}return(await Yz(t)).forEach((e=>{"fulfilled"===e.status&&(s+=e.value)})),Object(gz.b)("deleteVoices totalSize: ",s),s}catch(i){return Object(gz.a)("deleteVoices error",i),0}}async deleteFolder(e,t){const s=this.isLikeFolderPath(e);try{let a=0;if(!s){const t=await wG.isFile(e);a=(null==t?void 0:t.size)||0}return await wG.deleteFolder(e),Object(gz.b)("deleteFolder item success: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,e,a),this.accumulateSize(a),{size:a,isLikeFolder:s}}catch(a){return Object(gz.a)("deleteFolder item error: ",null==t?void 0:t.msgId,null==t?void 0:t.cliMsgId,a),{size:0,isLikeFolder:s}}}async deleteFolders(e,t){try{let t=0;const s=J.p.getSessionUserId(),a=[];for(const i of e){const e=MG.a.getPathsByMessageIfExistSync(s,i);Array.isArray(e)&&e.length&&e.forEach((e=>{const t=this.deleteFolder(e.path,i);a.push(t)}))}return(await Yz(a)).forEach((e=>{"fulfilled"!==e.status||e.value.isLikeFolder||(t+=2*e.value.size)})),Object(gz.b)("deleteFolders totalSize: ",t),t}catch(s){return Object(gz.a)("deleteFolders error",s),0}}})||OG)||OG)||OG;var DG;const AG=new(s("VIVm").a)({concurrency:400,interval:1e3});let FG,kG;kG=$znode.path,FG=s("Dprd").default;let NG=Object(a.injectable)()(DG=Reflect.metadata("design:type",Function)(DG=Reflect.metadata("design:paramtypes",[])(DG=class{constructor(){this.name=void 0,this.key=void 0,this.name=hG,this.key=hG}async calculatePhotoSize(e){const t=J.p.getSessionUserId();let s=0;for(const a of e){const e=MG.a.getPathsByMessageIfExistSync(t,a);for(const t of e){if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=AG.throttle(FG.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateVideoSize(e){const t=J.p.getSessionUserId();let s=0;for(const a of e){const e=MG.a.getPathsByMessageIfExistSync(t,a);for(const t of e){if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=AG.throttle(FG.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateFileSize(e){const t=J.p.getSessionUserId();let s=0;for(const i of e){const e=MG.a.getPathsByMessageIfExistSync(t,i);for(const t of e)try{if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=AG.throttle(FG.isFile);s+=(await e(t.path,!1)).size}}catch(a){}}return s}async calculateVoiceSize(e){const t=J.p.getSessionUserId();let s=0;for(const a of e){const e=MG.a.getPathsByMessageIfExistSync(t,a);for(const t of e){if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=AG.throttle(FG.isFile);s+=(await e(t.path,!1)).size}}}return s}async calculateFolderSize(e){const t=J.p.getSessionUserId();let s=0;for(const a of e){const e=MG.a.getPathsByMessageIfExistSync(t,a);for(const t of e){if(await me.a.ResCacheManager.hasCacheFile(t.path))s+=await me.a.ResCacheManager.getCacheFile(t.path)||0;else{const{task:e}=AG.throttle(FG.isFile);s+=(await e(t.path,!1)).size}}}return s}})||DG)||DG)||DG;a.ModuleContainer.registerSingleton(iz.a,Pz),a.ModuleContainer.registerSingleton(Uz,xz),a.ModuleContainer.registerSingleton(Hz,Zz),a.ModuleContainer.registerSingleton(Qz,eG),a.ModuleContainer.registerSingleton(nz.a,EG),a.ModuleContainer.registerSingleton(sG,LG),a.ModuleContainer.registerSingleton(gG,NG);var PG=s("GNMY"),jG=s("sGG0");var UG,BG=s("72EQ"),zG=s("v+vz"),GG=s("F1+M"),xG=s("XbxG"),VG=s("U/XY");function HG(){if(!Ce.default.profile.cover.randomUrls.length)return"";const{randomUrls:e}=Ce.default.profile.cover;return e[Math.floor(Math.random()*e.length)]}Object(m.h)()(UG=Object(xi.b)(PG.a)(UG=Reflect.metadata("design:type",Function)(UG=Reflect.metadata("design:paramtypes",[])(UG=class{constructor(){this.name=PG.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._randomCoverSrc=HG(),this._logger=void 0,this.type=void 0,this.data=new Map}get Logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(this.name,["personal-controller"])),this._logger}init(e){this.didInit||(this._fetchReceiveFriendList(),a.ModuleContainer.resolve(Jf.o).addEventListener(Jf.n.ReceiveAddFriendEvent,this.invitationEventHandler.bind(this)),a.ModuleContainer.resolve(Jf.o).addEventListener(Jf.n.UndoAddFriendEvent,this.invitationEventHandler.bind(this)),a.ModuleContainer.resolve(Jf.o).addEventListener(Jf.n.AcceptAddFriendEvent,this.invitationEventHandler.bind(this)),a.ModuleContainer.resolve(Jf.o).addEventListener(Jf.n.RejectAddFriendEvent,this.invitationEventHandler.bind(this)),a.ModuleContainer.resolve(Jf.o).addEventListener(Jf.n.UndoSentRequestFriendEvent,this.invitationEventHandler.bind(this)),this.didInit=!0)}onDispose(){TM.a.getInstance().removeAll()}bindDispatch(e){this._dispatch=e,_e.default.subscribe(this.eventHandler.bind(this)),this._randomCoverSrc=HG()}unbind(){this._dispatch=null,this._genMessageServer=null,this.data.clear(),_e.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"7oiBr6","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}clearState(e){this.data.has(e)&&this.data.delete(e)}_signalUpdate(e){Object(nc.h)(PG.b,e)}_updateData(e,t,s){const a=this.data.get(e);a?this.data.set(e,Object(I.a)(Object(I.a)({},a),{},{[t]:a&&a[t]?ui.default.deepMerge(a[t],s):s})):this.data.set(e,{[t]:s,version:0}),this._signalUpdate(e)}_udapteInfoData(e,t,s=!0){var a;const i=this.data.get(e);return s&&null!=i&&null!==(a=i.info)&&void 0!==a&&a.avatar&&(t.avatar=i.info.avatar),this._updateData(e,"info",t)}_updateVersion(e){const t=this.data.get(e);t?this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{version:t.version+1})):this.data.set(e,{version:0}),this._signalUpdate(e)}getCover(e){var t;const s=null===(t=this.data.get(e))||void 0===t?void 0:t.info;if(s){const e=s.cover;return e&&e==Ce.default.profile.cover.defaultUrl?this._randomCoverSrc||Ce.default.profile.cover.defaultUrl:e}return this._randomCoverSrc||Ce.default.profile.cover.defaultUrl}async getUserInfo(e,t=!1){const s=Object(I.a)({},Ii.default.getProfileFriendByIdSync(e));this._udapteInfoData(e,s);const a=async()=>{try{const t=await Ii.default.getProfileFriendById(e,Y.SRC_GET_PROFILE.FORCE_GET);return Ii.default.isFriend(e)||this.getStatusFriendRequest(e),t&&(zG.y(e)&&_e.default.send(ve.FetchActions.UDPATE_BUSINESS_INFO,{user:t}),this._udapteInfoData(e,t,!1)),this.getFullAvatar(e),t}catch(t){return this.Logger.zsymb(0,"_vaYIc","[getUserInfo]",t),Ii.default.getProfileFriendByIdSync(e)}};return t||!this.data.has(e)||!s||Object.keys(s).length<=4?a():s}async getExtraInfo(e){try{const t=await Ng.a.getProfileExtra(e,Ii.default.getUidMe());if(t){(e=>{if(e.bkPhotos&&e.photos&&e.photos.length)for(let t=0;t<e.photos.length;t++){const s=e.photos[t],a=e.bkPhotos[t];TM.a.getInstance().setBackup(s,a)}})(t);const s=(e=>{const t=e.photos?e.photos.map(((t,s)=>({url:t,meta:e.photoMetas&&e.photoMetas[s]}))):[];let s=[];return e.groupIds&&e.groupIds.length>0&&e.groupIds.forEach((e=>{In.a.checkHiddenChatByPureGroupId(e)||s.push(e)})),{mutualGroups:s,photos:t}})(t);return this._updateData(e,"extra",s),!0===t.fetched&&this.dispatch({type:ve.ConversationListActions.FORCE_UPDATE_MUTUAL_GROUP_ITEM,payload:e}),s}}catch(s){var t;this.Logger.zsymb(0,"6VTK1i","[getExtraInfo]",s),this._updateData(e,"extra",(null===(t=this.data.get(e))||void 0===t?void 0:t.extra)||{})}return null}async getFullAvatar(e,t=!1){const s=(t,s)=>{TM.a.getInstance().setBackup(t,s),this._updateData(e,"info",{fullAvatar:t})},a=async()=>{try{const t=await zG.k(e);t&&s(t.full_avatar,t.bk_full_avatar)}catch(t){if(this.Logger.zsymb(18,"ugJRx7","fetch full avatar error:",t),i){if(ui.default.isWeb()){let e=i.url;return e&&s(e),e}{let e=i.path;if(await Object(BG.a)(e))return s("file://"+e),"file://"+e}}}};let i=Re.default.getProfileAvatar(e);if(t||!i)return a();{let e=i.ts;if(Date.now()-3e5>e)return a();if(ui.default.isWeb()){let e=i.url;return s(e),e}{let e=i.path;Object(BG.a)(e).then((t=>t?(s("file://"+e),"file://"+e):a()))}}}async getProfileRank(e){try{const t=await Ng.a.getProfileRank(e,Ii.default.getUidMe());return this._updateData(e,"rank",t),t}catch(s){var t;this.Logger.zsymb(0,"oGPIi8","[getProfileRank]",s),this._updateData(e,"rank",(null===(t=this.data.get(e))||void 0===t?void 0:t.rank)||{})}return null}async getStatusFriendRequest(e){const t=async()=>{try{await ye.a.getStatusFriendRequest(e,!1)}catch(t){}};let s=J.p.getFriendRequestStatus(e);if(s){let e=s.ts;e&&e>-1&&e<Date.now()-2e3&&t()}else t()}async _fetchReceiveFriendList(e=!1){let t=Pg.a.getRecommendedFriendsSync();if(!Object.keys(t).length||e)try{t=await Pg.a.getRecommendedFriendsV2(!0,!0)}catch(a){this.Logger.zsymb(0,"yqCgGA","_fetchReceiveFriendList [ERROR]",t)}const s=Object.keys(t);s.length&&s.forEach((e=>{var s,a,i;(null===(s=t[e])||void 0===s||null===(a=s.dataInfo)||void 0===a?void 0:a.recommType)===cv.RECEIVE&&(this._cachedFriendRequest[e]=null===(i=t[e])||void 0===i?void 0:i.dataInfo)}))}getRequestInfo(e){return this._cachedFriendRequest[e]}async toggleBlock(e,t){var s;const a=this.data.get(e),i=(null==a||null===(s=a.info)||void 0===s?void 0:s.isBlocked)||Ii.default.isBlocked(e);Ia.default.logAction(1460207);try{const s=await Ii.default.blockFriend(e,i?Y.UNSET_BLOCK:Y.SET_BLOCK);return VG.c(t,i?"STR_UNBLOCK_USER_TOAST_SUCCESS":"STR_BLOCK_USER_TOAST_SUCCESS"),a&&this._updateData(e,"info",{isBlocked:!i}),i||Ia.default.logAction(146020701),this.dispatch({type:ve.ConversationListActions.BLOCK_CONVERSATION,payload:{blocked:!i,userId:e}}),s}catch(n){this.Logger.zsymb(18,"N3xDK_","toggleBlock",n),VG.c(t,i?"STR_UNBLOCK_USER_TOAST_FAIL":"STR_BLOCK_USER_TOAST_FAIL")}}async toggleRemoveFriend(e,t){Ia.default.logAction(1460206);try{const s=await zG.C(e);return Re.default.removeNewFriend(e),Re.default.removeFriend(e).then((t=>{_e.default.send(ve.PopupActions.TOGGLE_REMOVE_FRIEND,e)})),this.dispatch({type:ve.FetchActions.FRIENDS_REMOVED,payload:e}),VG.c(t,"STR_DELETE_SUCCESS"),s}catch(s){this.Logger.zsymb(18,"PhzMkY","toggleRemoveFriend",s)}}async toggleShareContact(e,t){const s=this.data.get(e),a=await Object(GG.c)([e]);Ia.default.logAction(1460205);let i="",n="";s&&s.info&&(i=s.info.avatar,n=s.info.displayName);let r={message:{action:"recommened.user",description:JSON.stringify({qrCodeUrl:a[e]}),params:e,thumb:i,title:n},msgType:Y.MSG_CONTACT,windowId:t};_e.default.send(ve.PopupActions.SHARE_MSG,r)}showImage(e,t,s=TO.l.ProfileAvatar){var a;let i=null===(a=this.data.get(e))||void 0===a?void 0:a.info;if(!i)return;const n={user:Ii.default.getProfileMeSync(),userId:e,conversation:Object(I.a)({},i),isVideo:!1,selectedId:null,isProfileImg:!0,href:t,appConfig:Object(Ce.getPVConfigs)(),source:s};ui.default.isWeb()||(n.appConfig={enable_feature_alias:Ce.default.enable_feature_alias,enable_stranger_alias:Ce.default.enable_stranger_alias}),me.a.OpenPhoto.openPhotoViewer(n)}voiceCall(e,t){const s=this.data.get(e);if(Ia.default.logAction(10643),Ia.default.logActionInfo(Ia.FeaturesInfo.BusinessAccount,1460203,[e,Ii.default.isFriend(e)?0:1]),!fl.d.isSupport()||null==s||!s.info)return;if(fl.d.isCalling())return void VG.b(t,void 0,ce.a.trans(fl.c.IN_CALL));const a=s.info;var i;ui.default.isWeb()||(i=e,Re.default.getConversation(i)).then((t=>{let s={lastSmsLocalId:t?t.lastSmsLocalId:null,displayName:a.displayName,userId:e},i=[s.userId];fl.d.makeCall(i,!1,!1,(e=>{this._genMessageServer&&this._genMessageServer(s,e),e.caller&&e.duration>0&&xG.b.updateLastActionTime(s.userId,this.dispatch,-1,xG.a.CALL)}))}))}jumpToConversation(e){let t=this.data.get(e);if(!t||!t.info)return;a.ModuleContainer.resolve(Q.b).openConversation(e,Q.d.fromProfileInfo(t.info));const s=Ii.default.isFriend(e);Ia.default.logActionInfo(Ia.FeaturesInfo.BusinessAccount,1460204,[e,s?1:0]),Ie.ModalManagerV2.closeAllModal()}async undoFriendRequest(e){Ia.default.logAction(146020802);try{return await ye.a.undoRequestAddFriend(e),a.ModuleContainer.resolve(Jf.o).dispatchEvent(new Jf.p(Jf.n.UndoSentRequestFriendEvent,null,e)),this.getUserInfo(e),!0}catch(t){t&&t.error_message&&VG.a(t.error_message)}return!1}async addFriend(e,t){const s=this.data.get(e);return!(!s||!s.info||s.info.isBlocked)&&(ye.a.isYouRequestMe(e)?(Ia.default.logAction(146020801),a.ModuleContainer.resolve(Fg.b).acceptFriendRequest(e,t),Re.default.getAcceptNewFriend(s)):Ia.default.logAction(1460208),!0)}async sendFriendRequest(e,t,s,a){const i=ye.a.getFriendRequestSource(e);try{await ye.a.requestAddFriend(e,s,i,t),this.dispatch({type:ve.ChatBoxActions.SEND_FRIEND_REQUEST,payload:e}),_e.default.send(ve.SideBarActions.SENT_FRIEND_REQUEST,e),VG.c(t,"STR_REQ_FR_SUCCESS"),Re.default.setStrangerCache(e,1),jG.a.callUpdate(e,a)}catch(n){this.Logger.zsymb(18,"DUKUJG","sendFriendRequest",n),n&&n.error_message&&VG.a(t,n.error_message),Re.default.setStrangerCache(e,0)}}openLink(e){Nw.b.open(e)}eventHandler(e,t){switch(e){case ve.FetchActions.STATUS_BLOCKED_CHANGED:if(t){this.data.has(t)&&this._updateData(t,"info",{isBlocked:Ii.default.isBlocked(t)})}break;case ve.FetchActions.UPDATE_NAME:if(t)if(t.constructor===Object){this.data.has(t.userId)&&this.getUserInfo(t.userId)}else if(t.constructor===Array)for(const[e,s]of Object.entries(this.data)){t.includes(e)&&this.getUserInfo(e)}break;case ve.FetchActions.USERID_FETCHED:case ve.FetchActions.PROFILE_ME_FETCHED:{const e=Ii.default.getUidMe();t&&this._udapteInfoData(e,Object(I.a)(Object(I.a)({},t),{},{isBlocked:!1,isFr:!0}),!this.data.has(t.userId)),this.data.has(t.userId)&&this.getFullAvatar(t.userId,!0);break}case ve.FetchActions.FRIEND_REQUEST_UPDATE:t&&this.data.has(t.userId)&&this._updateVersion(t.userId);break;case ve.ConversationListActions.BLOCK_CONVERSATION:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{isBlocked:t.blocked});break;case ve.FriendListActions.UPDATE_EXTRA_PROFILE_CACHE:t&&t.userId&&this.data.has(t.userId)&&this.getExtraInfo(t.userId);break;case ve.GeneralActions.NETWORK_STATUS_CHANGED:break;case ve.FriendsAction.FRIENDS_CHANGE_INFO:if(t)for(const e of t)this.data.has(e.userId)&&this.getUserInfo(e.userId)}}invitationEventHandler(e){switch(e.type){case Jf.n.ReceiveAddFriendEvent:Array.isArray(e.payload)&&e.payload.forEach((e=>{const t=e.dataInfo.userId;e&&e.dataInfo&&(this._cachedFriendRequest[t]=e.dataInfo,this.data.has(t)&&this._updateVersion(t))}));break;case Jf.n.UndoAddFriendEvent:case Jf.n.AcceptAddFriendEvent:case Jf.n.RejectAddFriendEvent:case Jf.n.UndoSentRequestFriendEvent:this._cachedFriendRequest[e.payload]&&(delete this._cachedFriendRequest[e.payload],this.data.has(e.payload)&&this._updateVersion(e.payload))}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||UG)||UG)||UG);var WG,qG=s("786D");Object(xi.b)(qG.a)(WG=Reflect.metadata("design:type",Function)(WG=Reflect.metadata("design:paramtypes",[])(WG=class{constructor(){this.name=qG.b,this.key="convId",this.didInit=!1,this.data=void 0,this._cachedFriendRequest={},this._dispatch=void 0,this._genMessageServer=void 0,this._connectClose=[],this._logger=void 0,this.type=void 0,this.data=new Map,this.eventHandler=this.eventHandler.bind(this)}get Logger(){return this._logger||(this._logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(this.name,["group-controller"])),this._logger}init(e){this.didInit||(this.didInit=!0)}clearState(e){this.data.has(e)&&this.data.delete(e)}bindDispatch(e){this._dispatch=e,_e.default.subscribe(this.eventHandler)}unbind(){this._dispatch=null,this._genMessageServer=null,this._connectClose=[],this.data.clear(),_e.default.unsubscribe(this.eventHandler)}dispatch(e){this._dispatch?this._dispatch(e):this.Logger.zsymb(0,"zOUZEe","Lost dispatch")}bindGenMessageServer(e){this._genMessageServer=e}connectCloseModalCallback(e){this._connectClose.push(e)}_updateData(e,t,s){const a=this.data.get(e);a?this.data.set(e,Object(I.a)(Object(I.a)({},a),{},{[t]:a&&a[t]?ui.default.deepMerge(a[t],s):s})):this.data.set(e,{[t]:s}),Object(nc.h)(qG.b,e)}_udapteInfoData(e,t){var s;const a=this.data.get(e);return null!=a&&null!==(s=a.info)&&void 0!==s&&s.avatar&&(t.avatar=a.info.avatar),this._updateData(e,"info",t)}async getGroupInfo(e){const t=async()=>{try{const t=await yn.default.getFullInfoGroupById(e,Y.SRC_GET_PROFILE.FORCE_GET);return t&&this._udapteInfoData(e,t),t}catch(t){return this.Logger.zsymb(0,"U4InfW","[getGroupInfo]",t),yn.default.getGroupByIdSync(e,void 0)}},s=yn.default.getGroupByIdSync(e,void 0);return this.data.has(e)?(this._udapteInfoData(e,s),s):(this._udapteInfoData(e,s),await t())}selectConversation(e){const t=this.data.get(e);if(t){Ia.default.logAction(1460204),this.dispatch({type:ve.ConversationListActions.SELECT_CONVERSATION,payload:t}),Ng.a.openConversation(e);const s=J.p.getSelectConversationSource();s&&Ia.default.logAction(s)}Ie.ModalManagerV2.closeAllModal()}async addGroupAdmin(e,t,s){try{return await yn.default.addGroupAdmin(t,s),!0}catch(a){if(this.Logger.zsymb(18,"lLTUqB","[addGroupAdmin] error",a),!a)return;if(a.error_code){let s="";switch(a.error_code){case 161:s=ce.a.str(_v.a.get("STR_GROUP_NO_EXIST",t));break;case 166:s=ce.a.str(_v.a.get("STR_GROUP_NO_PERMISION",t));break;default:s=ce.a.str(_v.a.get("STR_ADD_ADMIN_TOAST_UNSUCCESS",t))+" ("+a.error_code+")"}VG.a(e,void 0,s)}else a.code&&"ERR_NO_NETWORK"===a.code&&VG.a(e,"STR_CONNECTION_ERROR")}return!1}async changeGroupOwner(e,t,s,a=!1){var i;let n=!1;const r=(null===(i=yn.default.getGroupByIdSync(t))||void 0===i?void 0:i.topMember)||[];for(const l of r)if(l.id===s){n=!0;break}if(!n)return void VG.b(ce.a.trans(_v.a.get("STR_NO_LONGER_MEMBER_IN_GROUP",t),zG.h(s)));let o=t;o&&o.startsWith(Y.GROUPID_PREFIX)&&(o=o.slice(1));try{return await qc.default.changeGroupOwner(o,s),this._updateData(t,"info",{creatorId:s}),this.dispatch({type:ve.ConversationListActions.UPDATE_GROUP_OWNER,payload:{userId:t,creatorId:s}}),a&&await this.leaveGroup(e,o),!0}catch(c){return VG.a(e,_v.a.get("STR_CHANGE_GROUP_OWNER_FAIL",t)),!1}}async leaveGroup(e,t){try{await qc.default.leaveGroup(t),a.ModuleContainer.resolve(an.b).removeConvToList(t)}catch(s){s&&"ERR_NO_NETWORK"==s.code&&VG.a(e,"STR_CHECK_NET")}}eventHandler(e,t){switch(e){case ve.FetchActions.UPDATE_NAME:t.constructor===Object&&this.data.has(t.userId)?this.getGroupInfo(t.userId):t.constructor===Array&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case ve.FetchActions.GROUP_UPDATED:if(t){let{topMember:e=[],userId:a,isGroup:i}=t;const n=this.data.get(a);if(n&&i){var s;let t=null===(s=n.info)||void 0===s?void 0:s.topMember;(null==e?void 0:e.length)>0&&(t=e),this._updateData(a,"info",{topMember:t}),this.getGroupInfo(a)}}break;case ve.FetchActions.UPDATE_GROUP_SETTING:if(t&&t.data){let e=t.data.groupId;if(e&&(e=Y.GROUPID_PREFIX+e,this.data.has(e))){var a,i;const s=t.data.groupSetting||(null===(a=this.data.get(e))||void 0===a||null===(i=a.info)||void 0===i?void 0:i.setting);this._updateData(e,"info",{newSetting:s})}}break;case ve.GroupsAction.GROUPS_CHANGE_INFO:t&&t.forEach((e=>{this.data.has(e)&&this.getGroupInfo(e)}));break;case ve.FetchActions.DELETE_CONVERSATION:case ve.FetchActions.GROUP_LEAVE:this.data.has(t)&&this._connectClose.forEach((e=>e()));break;case ve.ConversationListActions.UPDATE_GROUP_OWNER:t&&this.data.has(t.userId)&&this._updateData(t.userId,"info",{creatorId:t.creatorId})}}getItem(e,t){return this.data.get(e.key)}getList(e,t){return Array.from(this.data.keys())}onGetItemFailure(e,t){}onGetListFailure(e,t){}getDefaultItem(){throw new Error("Method not implemented.")}getDefaultList(){throw new Error("Method not implemented.")}})||WG)||WG);var KG;Object(m.j)()(KG=Object(m.h)()(KG=Object(xi.b)(sM.ProfileVerificationController)(KG=Reflect.metadata("design:type",Function)(KG=Reflect.metadata("design:paramtypes",[])(KG=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.handleProfileVerificationChange=e=>{e===BO.b.VERIFIED&&this.onFinishVerification()},this.name=sM.PROFILE_VERIFICATION_CONTROLLER,this.key=sM.PROFILE_VERIFICATION_CONTROLLER,this.data=new Map}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.profile,[this.name])),this.logger}get userId(){return J.p.getSessionUserId()}init(){}getList(){return Array.from(this.data.keys())}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"YNmx3x","Get data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"e_5L-B","Get data list failed",e)}onStart(){Ii.default.subscribeEventFriend(Y.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}onDispose(){Ii.default.unsubscribeEventFriend(Y.EventFriend.PROFILE_VERIFICATION_CHANGE,this.handleProfileVerificationChange)}signalUpdateItem(e){Object(nc.h)(this.name,e)}requestUnblockStage(e,t){t>0&&e.step.isBlocking&&setTimeout((()=>{const t=Object(I.a)({},e);t.step.isBlocking=!1,this.data.set(t.key,t),this.signalUpdateItem(t.key)}),t)}createVerificationStage(e,t){return{key:this.userId,step:{stage:t,blockingTs:Ct.default.getTimeNow()+e,isBlocking:e>0}}}async sendOAVerificationMessage(e,t){let s=this.data.get(this.userId);try{await Ii.default.pushVerificationMessage(t,e),s=this.createVerificationStage(0,"sent")}catch(i){var a;this.Logger.zsymb(18,"qBnLHx","send oa verify fail",i);const e=null==i?void 0:i.error_code,t=(null==i||null===(a=i.data)||void 0===a?void 0:a.next_action_allowed_at)||0;let n,r=0;switch(e){case BO.c.UNAVAILABLE:r=Math.max(t-Ct.default.getTimeNow(),0),n="unavailable";break;case BO.c.FAILED:r=Math.max(t-Ct.default.getTimeNow(),0),n="failure";break;default:r=Ce.default.profile.verification.send_oa_delay,n="failure"}s=this.createVerificationStage(r,n),this.requestUnblockStage(s,r)}this.data.set(this.userId,s),this.signalUpdateItem(this.userId)}onFinishVerification(){this.data.delete(this.userId)}})||KG)||KG)||KG)||KG);var ZG;s("Ppsz");Object(xi.b)(IC.d)(ZG=Reflect.metadata("design:type",Function)(ZG=Reflect.metadata("design:paramtypes",[])(ZG=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.genId=void 0,this.name=IC.a,this.key="userId",this.data=new Map,this.genId=new De.a}init(){throw new Error("Method not implemented.")}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.reportV2,[this.name])),this.logger}getList(){return Array.from(this.data.keys())}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"wu6RBo","Get report abuse data item failed with id",e)}onGetListFailure(e){this.Logger.zsymb(20,"L-mFiS","Get report abuse data list failed",e)}signalUpdateItem(e){Object(nc.h)(this.name,e)}getOrCreateItem(e){let t=this.data.get(e);return t||(t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]}),t}onOpenReport(e){Ce.default.report_v2.enable&&this.Logger.zsymb(0,"qhNNGG","open report",e)}onReportDidOpen(e){if(Ce.default.report_v2.enable&&!this.data.has(e)){const t={userId:e,expandAttachment:!1,selectedPhotos:[],selectedMessages:[]};this.data.set(e,t),this.signalUpdateItem(e)}}onCloseReport(e){this.data.has(e)&&(this.cleanUpItem(e),Object(nc.f)(this.name,e),this.Logger.zsymb(0,"YTwEgD","close report",e))}cleanUpItem(e){const t=this.data.get(e);t&&(t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.delete(e))}toggleAttachment(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{expandAttachment:!t.expandAttachment})),this.signalUpdateItem(e)}selectReason(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{reasonId:t})),this.signalUpdateItem(e)}onSelectedPhotos(e,t){const s=this.getOrCreateItem(e),a=t.map((({blob:e,filename:t,type:s})=>({blob:e,id:this.genId.next(),url:URL.createObjectURL(e),filename:t,type:s})));this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedPhotos:s.selectedPhotos.concat(a)})),this.signalUpdateItem(e)}onDeselectPhoto(e,t){const s=this.getOrCreateItem(e),a=[...s.selectedPhotos],i=a.findIndex((e=>e.id===t));if(i>=0){a.splice(i,1).forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedPhotos:a})),this.signalUpdateItem(e)}}clearAllAttachedPhotos(e){const t=this.getOrCreateItem(e);t.selectedPhotos.forEach((({url:e})=>{URL.revokeObjectURL(e)})),this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedPhotos:[]})),this.signalUpdateItem(e)}onSelectedMessages(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedMessages:t})),this.signalUpdateItem(e)}clearAllAttachedMessages(e){const t=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedMessages:[]})),this.signalUpdateItem(e)}changeDescription(e,t){const s=this.getOrCreateItem(e);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{description:t})),this.signalUpdateItem(e)}})||ZG)||ZG);var $G,QG=s("7upJ");Object(a.singleton)(IC.e)($G=Reflect.metadata("design:type",Function)($G=Reflect.metadata("design:paramtypes",[])($G=class{constructor(){this.logger=void 0,this.name=void 0,this.name=IC.b}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.reportV2,[this.name])),this.logger}getRelatedStatus(e){return{blocked:Ii.default.isBlocked(e),unfriended:!Ii.default.isFriend(e)}}async blockAfterReport(e){try{await Ii.default.blockFriend(e,Y.SET_BLOCK)}catch(t){throw this.Logger.zsymb(18,"7qkWRu","block after report failed",e,t),t}}async unfriendAfterReport(e){try{await Ii.default.removeFriend(e)}catch(t){throw this.Logger.zsymb(18,"G_lhUn","unfriend after report failed",e,t),t}}getReportReasonFromId(e,t){const s=QG.a.getSortedAbuseList(e);if(!Array.isArray(s))return null;const a=s.find((e=>e.id===t));return a?a[ce.a.getCurrentLanguageName()]:null}getContentMessageToReport(e){const{message:t,msgType:s}=e;if("object"==typeof t)switch(s){case Y.MSG_LINK_CLIENT:case Y.MSG_CONTACT:return t.title||t.href;case Y.MSG_PHOTO:case Y.MSG_PHOTO_2:case Y.MSG_PHOTO_GROUP:case Y.MSG_VIDEO:return t.oriUrl||t.title;case Y.MSG_VOICE:return t.href;default:return t.title}return t}async submitReport(e){const t=new FormData,s={idTo:e.userId,objId:"person.profile",reason:String(e.reasonId),content:e.description};if(e.selectedPhotos.length){const a=e.selectedPhotos.map((e=>({filename:e.filename,type:e.type})));s.imgList=JSON.stringify(a),e.selectedPhotos.forEach((({blob:e},s)=>{t.append(`img${s}`,e)}))}if(e.selectedMessages.length){const t=e.selectedMessages.map((e=>({gmi:e.msgId,msg:this.getContentMessageToReport(e)}))).filter((({msg:e})=>!!e));s.msgList=JSON.stringify(t)}t.append("params",encodeURIComponent(ui.default.encodeAES(JSON.stringify(s))));try{const s=await qc.default.reportUserV2(t);this.Logger.zsymb(0,"TMOm1J","submit success",e.userId,s)}catch(a){throw this.Logger.zsymb(18,"uUo1tl","submit failed",e.userId,a),a}}})||$G)||$G);var YG=s("BpN3"),JG=s("UJhs");function XG(e){return"object"==typeof e&&!!e&&e.hasOwnProperty("loading")&&"boolean"==typeof e.loading&&e.type in JG.c&&e.hasOwnProperty("data")&&"object"==typeof e.data&&!!e.data}const ex="SEND_INPUT_PREVIEW",tx={[ex]:{feature:Ia.FeaturesInfo.InputBoxPreview,subType:1}};var sx=function(e){return e[e.Chat=1]="Chat",e[e.Group=2]="Group",e[e.MyCloud=3]="MyCloud",e[e.OA=4]="OA",e}(sx||{});class ax{}ax.actionlogSendPreview=e=>{requestIdleCallback((()=>{try{var t;if(!e.length)return;const i=e.filter((e=>e.type===JG.c.PHOTO));if(!i.length)return;let n;const r=null==i||null===(t=i[0])||void 0===t?void 0:t.toUid;n=Object(zG.z)(r)?sx.OA:ui.default.isGroup(r)?sx.Group:Object(zG.f)()===r?sx.MyCloud:sx.Chat;const o=e.length,c=[];for(let e=0;e<i.length;e++){var s,a;const t=i[e],n={photo_position:e+1,caption_length:(null==t||null===(s=t.caption)||void 0===s?void 0:s.length)||0,is_caption_form:null!=t&&null!==(a=t.caption)&&void 0!==a&&a.length?1:0};c.push(n)}const l={total_item_in_group:o,caption_info:c,chat_type:n};ax._actionlogSendInputPreview(ex,l)}catch(i){es.dangerouslyLogConsole.error("InputPreviewActionLog.logSendPreview",i)}}),{timeout:5e3})},ax._actionlogSendInputPreview=async(e,t)=>{const s=tx[e].feature,a=tx[e].subType;Ia.default.logActionInfoV2(s,a,t)};var ix,nx=ax;Object(a.injectable)()(ix=Object(xi.b)(YG.b)(ix=class{constructor(){this._eventEmitter=new Uf.a,this.totalPhotoSize=0,this.addPreviewItem=e=>{var t;Object(ua.a)(function(e){return XG(e)&&e.type!==JG.c.PLACEHOLDER}(e),"invalid item for input preview, must be InputPreviewData");const s=e,i=s.data,n=i.toUid,r=this.mayInitState(n),o=null!==(t=s.previewId)&&void 0!==t?t:i.clientId,c=r.oriItems.length>0?[...r.oriItems]:[...r.items],l=c.findIndex((e=>e.previewId===o)),d=s.data.clientId;(this.removedItems.get(n)||new Set).has(d)||(e.type===JG.c.PHOTO&&(a.ModuleContainer.resolve(Rf.b).trackTempBlob(e.data.clientId,e.data.img),this.trackPhotoSize(e)),-1!==l?c[l]=Object(I.a)(Object(I.a)(Object(I.a)({},r.items[l]),s),{},{previewId:o}):c.push(s),this.data.set(n,Object(I.a)(Object(I.a)({},r),{},{items:c,oriItems:c})),Object(nc.h)(this.name,n),this.emit("ON_ADD_INPUT_PREVIEW",{conversationId:n}))},this.getOrderedItemsForSending=e=>{const t=this.getOrderedItems(e).map((e=>e&&e.type===JG.c.GIF?Object(I.a)(Object(I.a)({},e),{},{type:JG.c.PHOTO}):e));return nx.actionlogSendPreview(t.map((e=>Object(I.a)({},e)))),t},this.removePreviewItemById=(e,t)=>{const s=this.data.get(e);if(!s)return;const a=s.items.filter((e=>e.data.clientId!==t)),i=s.oriItems.filter((e=>e.data.clientId!==t)),n=s.items.filter((e=>e.data.clientId===t));for(let r of n)this.untrackPhotoSize(r);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{items:a,oriItems:i})),Object(nc.h)(this.name,e)},this.trackPhotoSize=e=>{var t;e.type===JG.c.PHOTO&&(this.totalPhotoSize+=(null===(t=e.data.file)||void 0===t?void 0:t.size)||0)},this.untrackPhotoSize=e=>{var t;e.type===JG.c.PHOTO&&(this.totalPhotoSize=Math.max(0,this.totalPhotoSize-((null===(t=e.data.file)||void 0===t?void 0:t.size)||0)))},this.name=YG.a,this.data=new Map,this.removedItems=new Map,this.key="conversationId"}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter.emit(e,t)}get isOverInputPreviewMemoryLimit(){return this.totalPhotoSize>=Ce.default.file_photo_limit.maxInputPreviewMemory}canAddPreviewItem(e){if(this.isOverInputPreviewMemoryLimit)return!1;return this.totalPhotoSize+e<Ce.default.file_photo_limit.maxInputPreviewMemory}hasPreviewItems(e){const t=this.data.get(e);return!!t&&t.items.length>0}selectItem(e,t){if(!e||!t)return;const s=this.mayInitState(e);this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedItem:t})),Object(nc.h)(this.name,e)}selectPreviousItem(e){const t=this.mayInitState(e),s=t.items,a=t.selectedItem;if(!a)return;const i=s.findIndex((e=>e.data.clientId===a.cliMsgId));if(-1===i)return;const n=Math.max(i-1,0);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedItem:s[n]})),Object(nc.h)(this.name,e)}selectNextItem(e){const t=this.mayInitState(e),s=t.items,a=t.selectedItem;if(!a)return;const i=s.findIndex((e=>e.data.clientId===a.cliMsgId));if(-1===i)return;const n=Math.min(i+1,s.length-1);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedItem:s[n]})),Object(nc.h)(this.name,e)}addPlaceholder(e,t){Object(ua.a)("string"==typeof e&&!!e,"conversationId must be string"),Object(ua.a)("object"==typeof t&&!(null==t||!t.clientId),"invalid item for input preview placeholder");const s=this.mayInitState(e),a={loading:!0,type:JG.c.PLACEHOLDER,previewId:t.clientId,data:{clientId:t.clientId}};this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{items:[...s.items,a],oriItems:[...s.oriItems,a]})),Object(nc.h)(this.name,e)}getPreviewItemsCount(e){var t,s;return null!==(t=null===(s=this.data.get(e))||void 0===s?void 0:s.items.length)&&void 0!==t?t:0}getOrderedItems(e){const t=this.data.get(e);if(!t)return[];let s=[];const a=t.oriItems.filter((e=>{const t=e.type!==JG.c.PLACEHOLDER;return t&&s.push(e.data.clientId),t})).map((e=>{var s;const a=(null===(s=t.caption[e.data.clientId])||void 0===s?void 0:s.saved)||"",i=Object(I.a)(Object(I.a)({},e.data),{},{caption:a});return Object(I.a)(Object(I.a)({},e),{},{data:i})}));s=s.sort(((e,t)=>e-t));return a.map(((e,t)=>Object(I.a)(Object(I.a)({},e.data),{},{clientId:s[t]})))}getRawOrderedItems(e){const t=this.data.get(e);return t?t.oriItems:[]}updateOrder(e,t){const s=this.mayInitState(e);Object(ua.a)(Array.isArray(t),`invalid items for input preview at ${e}`),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{oriItems:t})),Object(nc.h)(this.name,e)}removePreviewItem(e,t){const s=this.data.get(e);if(!s)return;const i=[...s.items],n=[...s.oriItems],r=i[t];if(!r)return;const o=n.indexOf(r);i.splice(t,1),-1!==o&&n.splice(o,1),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{items:i,oriItems:n})),r.type===JG.c.PHOTO&&(URL.revokeObjectURL(r.data.img),a.ModuleContainer.resolve(Rf.b).removeTrackTempBlob(r.data.clientId),this.untrackPhotoSize(r)),Object(nc.h)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}removeAllItems(e,t=!1){const s=this.data.get(e);if(!s)return;const i=this.removedItems.get(e)||new Set;if(!t)for(let n of s.items)i.add(n.data.clientId),n.type===JG.c.PHOTO&&(URL.revokeObjectURL(n.data.img),a.ModuleContainer.resolve(Rf.b).removeTrackTempBlob(n.data.clientId),this.untrackPhotoSize(n));this.removedItems.set(e,i),this.data.delete(e),Object(nc.h)(this.name,e),this.emit("ON_REMOVE_INPUT_PREVIEW",{conversationId:e})}saveDraft(e,t,s){const a="string"==typeof s?s.trimStart().trimEnd():"",i=this.mayInitState(e);Object(ua.a)(!!i,`invalid state when saveDraft for conversationId ${e}`),Object(ua.a)("string"==typeof a,`invalid draft for conversationId ${e}`);let n=i.caption[t]||{saved:"",draft:""};if(n.saved===a&&n.draft===a)return;n=Object(I.a)(Object(I.a)({},n),{},{draft:a});const r=Object(I.a)(Object(I.a)({},i.caption),{},{[t]:n}),o=new Set(i.unsavedChanges);n.saved!==n.draft?o.add(t):o.delete(t),this.data.set(e,Object(I.a)(Object(I.a)({},i),{},{caption:r,unsavedChanges:Array.from(o)})),Object(nc.h)(this.name,e)}applyDraft(e,t){return Object(ua.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.applyDraftSingle(e,t):this.applyDraftMulti(e)}resetSelectedItem(e){if(!e)return;const t=this.mayInitState(e);this.data.set(e,Object(I.a)(Object(I.a)({},t),{},{selectedItem:null})),Object(nc.h)(this.name,e)}applyDraftSingle(e,t){const s=this.mayInitState(e);Object(ua.a)(!!s,`invalid state when addCaption for conversationId ${e}`);let a=s.caption[t];if(!a||a.saved===a.draft)return;const i=a.draft||"";a=Object(I.a)(Object(I.a)({},a),{},{saved:i});const n=Object(I.a)(Object(I.a)({},s.caption),{},{[t]:a}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{caption:n,unsavedChanges:Array.from(r)})),Object(nc.h)(this.name,e)}applyDraftMulti(e){const t=this.mayInitState(e);Object(ua.a)(!!t,`invalid state when addCaption for conversationId ${e}`);const s=Object(I.a)({},t.caption);Object.keys(s).forEach((e=>{const t=s[e];if(!t||t.saved===t.draft)return;const a=t.draft||"";s[e]=Object(I.a)(Object(I.a)({},t),{},{saved:a})}));const a=Object(I.a)(Object(I.a)({},t),{},{caption:s,unsavedChanges:[]});this.data.set(e,a),Object(nc.h)(this.name,e)}discardDraftedCaption(e,t){return Object(ua.a)("string"==typeof e&&!!e,"InputCaption: conversationId must be string"),"number"==typeof t?this.discardDraftedCaptionSingle(e,t):this.discardDraftedCaptionMulti(e)}discardDraftedCaptionSingle(e,t){const s=this.mayInitState(e);if(!s)return;const a=s.caption[t];if(!a||!a.draft)return;const i=s.caption[t],n=Object(I.a)(Object(I.a)({},s.caption),{},{[t]:Object(I.a)(Object(I.a)({},i),{},{draft:null==i?void 0:i.saved})}),r=new Set(s.unsavedChanges);r.delete(t),this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{caption:n,unsavedChanges:Array.from(r)})),Object(nc.h)(this.name,e)}discardDraftedCaptionMulti(e){let t=this.data.get(e);if(!t)return;const s=Object(I.a)({},t.caption);if(s)for(const a in s)s[a].draft=s[a].saved;t=Object(I.a)(Object(I.a)({},t),{},{caption:s,unsavedChanges:[]}),this.data.set(e,t),Object(nc.h)(this.name,e)}getCaption(e,t){return this.mayInitState(e).caption[t]}_listenEvents(){}mayInitState(e){let t=this.data.get(e);return t||(t={conversationId:e,items:[],oriItems:[],selectedItem:null,caption:{},unsavedChanges:[]},this.data.set(e,t)),t}init(){this._listenEvents()}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||ix);var rx=s("ONNR"),ox=s("1Q0E");const cx={network:{avgRequest:40,default:{hit:50},items:{file:{hit:80},"/keepalive":{hit:5}}},database:{avgRequest:300,default:{hit:100},items:{"Core.Message":{hit:500}}}};var lx=1e3;function dx(e,t){switch(t){case"byte-to-mb":return e/1024/1024;case"kb-to-mb":return e/1024;default:return}}var ux=s("fOVY"),hx=s("XnIt"),gx=s("CaBZ"),mx=s("mHfx");let px,fx;try{px=$znode.fs,fx=$znode.path}catch(CY){}async function vx(e){return new Promise((t=>{try{px.readdir(e,(async(s,a)=>{if(s)return t(0);let i=0;for(let t=0;t<a.length;t++){const s=a[t],n=fx.join(e,s),r=px.statSync(n);if(Object(mx.a)(r)){i+=await vx(n)}i+=r.size}t(i)}))}catch(s){t(0)}}))}var _x,bx=new class{constructor(){this.lastFrameTime=0,this.fps=0,this.pause=!0}loop(e){if(this.pause)return;const t=e;if(0===this.lastFrameTime)return this.lastFrameTime=t,void requestAnimationFrame(this.loop.bind(this));const s=t-this.lastFrameTime;s>0&&(this.fps=Math.round(1e3/s),this.lastFrameTime=t),requestAnimationFrame(this.loop.bind(this))}start(){this.pause=!1,requestAnimationFrame(this.loop.bind(this))}stop(){this.lastFrameTime=0,this.fps=0,this.pause=!0}get value(){return this.fps}};const Ix="z_m_h_",yx="z_m_h_i___",Sx={CPU:!0,GPU:!0,RAM:!0,FPS:!0,"JS Heap":!0,"Root Render":!0,LCP:!0};Object(xi.b)(ox.b)(_x=Object(a.injectable)()(_x=Object(a.singleton)()(_x=Reflect.metadata("design:type",Function)(_x=Reflect.metadata("design:paramtypes",[])(_x=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.isStarted=!1,this.userId=void 0,this.monitorItems=[],this.showMonitorItems=new Map,this.rootRenderInitTime=Oa.a.now(),this.rootRenderNumber=1,this.lcpMetric=void 0,this.intervalCheck=void 0,this.intervalCheckSteps=0,this.data={isShowZPCHealth:!1,monitorItemForUIs:[]},this.usageMonitor=void 0,this.name=ox.a,this.key=ox.a}initialize(e){this.isStarted||(this.isStarted=!0,function(){const e=a.ModuleContainer.resolve(gx.b);e.registerMonitorItem({expectedOrderPosition:1,title:"Database",description:"Cache & IndexedDB",getValue:async()=>{var e,t,s;let a=(null===(e=await(null===(t=navigator.storage)||void 0===t||null===(s=t.estimate)||void 0===s?void 0:s.call(t)))||void 0===e?void 0:e.usage)||0;return a=Math.round(dx(a,"byte-to-mb")||0),a},getType:e=>e>=200&&e<=500?"medium":e>500?"high":"low",getContent:e=>Object(ux.a)(e," MB"),checkSteps:10}),e.registerMonitorItem({expectedOrderPosition:2,title:"DOM",description:"DOM nodes",getValue:()=>document.getElementsByTagName("*").length||0,getType:e=>e>=3e3&&e<=6e3?"medium":e>6e3?"high":"low",getContent:e=>Object(ux.a)(e," nodes"),checkSteps:2}),!Ee.l&&e.registerMonitorItem({expectedOrderPosition:3,title:"Temp Files",description:"ZaloTemp & zTemp",getValue:async()=>{try{const e=await Object(wi.getZaloTempDir)(),t=await vx(e),s=await Object(wi.getzTempDir)(),a=await vx(s);return Math.round(dx(t+a,"byte-to-mb")||0)}catch(e){return 0}},getType:e=>e>=50&&e<=100?"medium":e>100?"high":"low",getContent:e=>Object(ux.a)(e," MB"),checkSteps:100}),e.registerMonitorItem({expectedOrderPosition:6,title:"Custom Domains",description:"Count custom domains usage",getValue:async()=>{const e=a.ModuleContainer.resolve(hx.a).getDomainConfig();let t=0;if(!e)return t;for(const s in e)e.hasOwnProperty(s)&&e[s].useDevDomain&&t++;return t},getType:e=>"low",getContent:e=>Object(ux.a)(e,""),checkSteps:2})}());const t=this.getStorage().getItem(Ix);this.data.isShowZPCHealth="1"===t;const s=this.getStorage().getItem(yx);if(s){s.split(",").forEach((e=>{e&&this.showMonitorItems.set(e,1)}))}this.data.isShowZPCHealth&&Object(gu.d)()&&(Object(rx.a)((e=>{this.lcpMetric=e}),{reportAllChanges:!0}),this.userId=e,this.startHealthCheck())}destroy(){this.stopHealthCheck()}registerMonitorItem(e){const t=`${e.expectedOrderPosition||""}_${e.title.replace(" ","")}`,s=Object(I.a)(Object(I.a)({},e),{},{id:t});this.monitorItems.push(s),this.monitorItems=this.monitorItems.sort(((e,t)=>e.expectedOrderPosition&&t.expectedOrderPosition?e.expectedOrderPosition-t.expectedOrderPosition:0))}addRootRender(){this.data.isShowZPCHealth&&Object(gu.d)()&&this.rootRenderNumber++}resetRootRender(){this.rootRenderNumber=1}startHealthCheck(){this.intervalCheck||(bx.start(),this.getMonitorItems(this.userId),this.intervalCheck=setInterval((()=>{this.getMonitorItems(this.userId),this.intervalCheckSteps++}),lx))}stopHealthCheck(){bx.stop(),this.rootRenderNumber=1,this.intervalCheck&&(clearInterval(this.intervalCheck),this.intervalCheck=void 0,this.intervalCheckSteps=0)}toggleZPCHealth(){this.data.isShowZPCHealth=!this.data.isShowZPCHealth,this.getStorage().setItem(Ix,this.data.isShowZPCHealth?"1":"0"),this.data.isShowZPCHealth||this.stopHealthCheck(),Object(nc.h)(this.name,"")}getMonitorList(){return this.monitorItems.map((e=>({id:e.id,title:e.title,isShow:!(!this.showMonitorItems.get(e.id)&&!Sx[e.title])})))}showZPCHealthItem(e,t){if(!e)return;t?this.showMonitorItems.set(e,1):this.showMonitorItems.delete(e);let s="";this.showMonitorItems.forEach(((e,t)=>{s+=t+","})),this.getStorage().setItem(yx,s),this.stopHealthCheck(),this.startHealthCheck()}async getMonitorItems(e){var t,s,a,i;const n=Ee.l?[]:await $zperf.getCpuInfos();let r=0,o=0,c=0;null==n||n.forEach((e=>{var t,s;const a=(null==e||null===(t=e.cpu)||void 0===t?void 0:t.percentCPUUsage)||0,i=(null==e||null===(s=e.memory)||void 0===s?void 0:s.workingSetSize)||0;"GPU"!==e.type?(r+=a,c+=i):o+=a})),r=Math.round(r),o=Math.round(o),c=Math.round(dx(c,"kb-to-mb")||0);let l=(null===(t=performance.memory)||void 0===t?void 0:t.usedJSHeapSize)||0;l=Math.round(dx(l,"byte-to-mb")||0);const d=bx.value;let u=(null===(s=await(null===(a=navigator.storage)||void 0===a||null===(i=a.estimate)||void 0===i?void 0:i.call(a)))||void 0===s?void 0:s.usage)||0;u=Math.round(dx(u,"byte-to-mb")||0);const h=Math.round((Oa.a.now()-this.rootRenderInitTime)/1e3/60)||1,g=Math.round(this.rootRenderNumber/h),m=[...[{id:"0_CPU",title:"CPU",description:"CPU usage",getValue:()=>r,getType:e=>e>=20&&e<=40?"medium":e>40?"high":"low",getContent:e=>Object(ux.a)(e," %"),checkSteps:2},{id:"0_GPU",title:"GPU",description:"GPU usage",getValue:()=>o,getType:e=>e>=10&&e<=30?"medium":e>30?"high":"low",getContent:e=>Object(ux.a)(e," %"),checkSteps:2},{id:"0_FPS",title:"FPS",description:"Frame Per Second",getValue:()=>d,getType:e=>e>=20&&e<=30?"medium":e<20?"high":"low",getContent:e=>Object(ux.a)(e),checkSteps:1},{id:"0_RAM",title:"RAM",description:"RAM usage",getValue:()=>c,getType:e=>e>=500&&e<=1e3?"medium":e>1e3?"high":"low",getContent:e=>Object(ux.a)(e," MB"),checkSteps:2},{id:"0_JSHeap",title:"JS Heap",description:"JS Heap usage",getValue:()=>l,getType:e=>e>=200&&e<=300?"medium":e>300?"high":"low",getContent:e=>Object(ux.a)(e," MB"),checkSteps:2},{id:"0_RootRender",title:"Root Render",description:"Root Render in minutes",getValue:()=>g,getType:e=>e>=10&&e<=20?"medium":e>20?"high":"low",getContent:e=>Object(ux.a)(e," times / minute"),checkSteps:2},{id:"0_LCP",title:"LCP",description:"Largest Contentful Paint",getValue:()=>{var e;return Math.round(((null===(e=this.lcpMetric)||void 0===e?void 0:e.value)||0)/1e3)},getType:e=>{var t;switch(null===(t=this.lcpMetric)||void 0===t?void 0:t.rating){case"poor":return"high";case"needs-improvement":return"medium";default:return"low"}},getContent:e=>Object(ux.a)(e," s"),checkSteps:2}],...this.monitorItems],p=[];for(let b=0;b<m.length;b++){const t=m[b];let s=!1;s=!(!this.showMonitorItems.get(t.id)&&!Sx[t.title]);let a,i,n=0;var f,v,_;if(s)if(this.data.monitorItemForUIs[b]&&this.intervalCheckSteps%(t.checkSteps||1)!=0)a=this.data.monitorItemForUIs[b].type,i=this.data.monitorItemForUIs[b].content;else n=await(null===(f=t.getValue)||void 0===f?void 0:f.call(t,e))||0,a=null===(v=t.getType)||void 0===v?void 0:v.call(t,n),i=null===(_=t.getContent)||void 0===_?void 0:_.call(t,n);const r={id:t.id,title:t.title,description:t.description,type:a,content:i,isShow:s,checkTime:(t.checkSteps||1)*lx};p.push(r)}this.data.monitorItemForUIs=p,Object(nc.h)(this.name,"")}getStorage(){return n.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||_x)||_x)||_x)||_x);var Cx=s("zdwi");const Ex="1",Ox={windowId:Ex,name:"ZPC_HEALTH"},Mx={windowId:Ex,name:"METRICS"};var Tx,Rx=s("Igfx"),wx=s("noAy");const Lx="z_m_h_f_",Dx="z_m_h_r_",Ax="z_m_h_r_w_";Object(xi.b)(Cx.a)(Tx=Object(a.injectable)()(Tx=Object(a.singleton)()(Tx=function(e,t){return Object(a.inject)(wx.b)(e,void 0,0)}(Tx=Reflect.metadata("design:type",Function)(Tx=Reflect.metadata("design:paramtypes",[void 0===wx.b?Object:wx.b])(Tx=class{constructor(e){this.resourceWarning=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1,isShowRenderingDebugger:!1,isShowReactiveLogger:!1,isShowResourceWarning:!1},this.observeRendering=void 0,this.name=Cx.b,this.key=Cx.b}initialize(){if(!Object(gu.d)())return;this.observeRendering=this.observeRendering?this.observeRendering:Object(gu.f)(),Ie.ModalManagerV2.addModal(Object(I.a)(Object(I.a)({},Ox),{},{altWindowId:void 0})),Ie.ModalManagerV2.subscribeTriggers({windowId:Ex,name:Ox.name,trigger:e=>{}});const e=this.getStorage().getItem(Lx);var t;(this.data.isShowRenderingDebugger="1"===e,"1"===e)&&(null===(t=this.observeRendering)||void 0===t||t.observe());const s=this.getStorage().getItem(Dx);this.data.isShowReactiveLogger="1"===s,this.data.isShowReactiveLogger?Rx.a.enable():Rx.a.disable();const a=this.getStorage().getItem(Ax);this.data.isShowResourceWarning=null!==a?"1"===a:this.data.isShowResourceWarning,this.data.isShowResourceWarning?this.resourceWarning.enable():this.resourceWarning.disable(),Object(nc.h)(this.name,"all")}destroy(){0}showZPCHealthPopup(e){Object(gu.d)()&&(e?Ie.ModalManagerV2.openModal(Object(I.a)(Object(I.a)({},Ox),{},{windowId:Ex,params:null})):Ie.ModalManagerV2.closeModal(Object(I.a)(Object(I.a)({},Ox),{},{windowId:Ex})),this.data.isShow=e,Object(nc.h)(this.name,"all"))}setIsShowRenderingDebugger(e){var t,s;(this.data.isShowRenderingDebugger=e,this.getStorage().setItem(Lx,e?"1":"0"),e)?null===(t=this.observeRendering)||void 0===t||t.observe():null===(s=this.observeRendering)||void 0===s||s.disconnect();Object(nc.h)(this.name,"all")}setIsShowReactiveLogger(e){this.data.isShowReactiveLogger=e,this.getStorage().setItem(Dx,e?"1":"0"),e?Rx.a.enable():Rx.a.disable(),Object(nc.h)(this.name,"all")}setIsShowResourceWarning(e){this.data.isShowResourceWarning=e,this.getStorage().setItem(Ax,e?"1":"0"),e?this.resourceWarning.enable():this.resourceWarning.disable(),Object(nc.h)(this.name,"all")}getStorage(){return n.default.getInstance()}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Tx)||Tx)||Tx)||Tx)||Tx);var Fx,kx=s("Bwur");Object(xi.b)(kx.b)(Fx=Object(a.injectable)()(Fx=Object(a.singleton)()(Fx=Reflect.metadata("design:type",Function)(Fx=Reflect.metadata("design:paramtypes",[])(Fx=class{constructor(){this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!1},this.name=kx.a,this.key=kx.a}initialize(){Object(gu.d)()&&(Ie.ModalManagerV2.addModal(Object(I.a)(Object(I.a)({},Mx),{},{altWindowId:void 0})),Ie.ModalManagerV2.subscribeTriggers({windowId:Ex,name:Mx.name,trigger:e=>{}}))}destroy(){0}showMetricsPopup(e){Object(gu.d)()&&(e?Ie.ModalManagerV2.openModal(Object(I.a)(Object(I.a)({},Mx),{},{windowId:Ex,params:null})):Ie.ModalManagerV2.closeModal(Object(I.a)(Object(I.a)({},Mx),{},{windowId:Ex})),this.data.isShow=e,Object(nc.h)(this.name,"all"))}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Fx)||Fx)||Fx)||Fx);var Nx=s("1UUk"),Px=s("PmZf");class jx{constructor(e){this._queue=void 0,this._maxSize=void 0,this._queue=[],this._maxSize=null==e?void 0:e.maxSize}enqueue(e){this._maxSize&&this._queue.length>=this._maxSize&&this._queue.shift(),this._queue.push(e)}dequeue(){return this._queue.shift()}peek(){return this._queue[0]}isEmpty(){return 0===this._queue.length}get length(){return this._queue.length}clear(){this._queue=[]}toArray(){return this._queue}}var Ux,Bx=s("WZ0o");const zx="requests / second",Gx=1e3;Object(xi.b)(wx.b)(Ux=Object(a.injectable)()(Ux=Object(a.singleton)()(Ux=function(e,t){return Object(a.inject)(Nx.b)(e,void 0,0)}(Ux=Reflect.metadata("design:type",Function)(Ux=Reflect.metadata("design:paramtypes",[void 0===Nx.a?Object:Nx.a])(Ux=class{constructor(e){this.databaseManager=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={network:{totalRequestInLiveTime:0,queue:new jx,hitCount:0,error:void 0},database:{totalRequestInLiveTime:0,queue:new jx,hitCount:0,error:void 0}},this.warningConfigs=cx,this.isEnable=void 0,this.initTime=void 0,this.timeoutSignals={},this.enableLogEachRequest=void 0,this.hitQueue=new jx({maxSize:20}),this.observePerformance=void 0,this.name=wx.a,this.key=wx.a,this.dbQueryExecListener=this.dbQueryExecListener.bind(this)}enable(){Object(gu.d)()&&(this.isEnable||(this.isEnable=!0,this.setup()))}disable(){var e;this.isEnable=!1,null===(e=this.observePerformance)||void 0===e||e.disconnect(),this.databaseManager.removeEventListener(Px.b.QueryExec,this.dbQueryExecListener),this.resetData()}getData(){return this.data}resetNetworkError(){this.data.network.totalRequestInLiveTime=0,this.data.network.error=void 0,Object(nc.h)(this.name,"all")}resetDatabaseError(){this.data.database.totalRequestInLiveTime=0,this.data.database.error=void 0,Object(nc.h)(this.name,"all")}setWarningConfigs(e){this.warningConfigs=e}setEnableLogEachRequest(e){this.enableLogEachRequest=e}getHitQueue(){return this.hitQueue}setup(){this.initTime=Object(gu.h)(),this.observePerformance=this.observePerformance?this.observePerformance:Object(Bx.b)(["resource"],this.listenObservePerformance.bind(this)),this.observePerformance.observe(),this.databaseManager.addEventListener(Px.b.QueryExec,this.dbQueryExecListener)}listenObservePerformance(e){let t=e.filter((e=>"resource"===e.entryType)).filter((e=>"xmlhttprequest"===e.initiatorType));if(0!==t.length){this.dequeueQueue(this.data.network.queue);for(let e=0;e<t.length;e++){const s=t[e],a={url:s.name,path:Object(ux.b)(s.name),ts:Object(gu.h)()};this.data.network.queue.enqueue(a),this.data.network.totalRequestInLiveTime++,this.enableLogEachRequest}this.slowHandleWarning("network",this.data.network,(()=>this.getWarningDetail("network",this.data.network.queue,(e=>{var t;return(null===(t=e.url)||void 0===t?void 0:t.startsWith("file://"))?"file":`${e.path}`}))))}}dbQueryExecListener(e){const t=e.data;if(!t)return;this.dequeueQueue(this.data.database.queue);const s={database:t.database,method:t.method,table:t.table,ts:Object(gu.h)()};this.data.database.queue.enqueue(s),this.data.database.totalRequestInLiveTime++,this.enableLogEachRequest,this.slowHandleWarning("database",this.data.database,(()=>this.getWarningDetail("database",this.data.database.queue,(e=>`${e.database}.${e.table}`))))}dequeueQueue(e){const t=e.peek();if(t&&t.ts){if(!(Object(gu.h)()-t.ts>Gx))return;e.dequeue(),this.dequeueQueue(e)}}slowHandleWarning(e,t,s){this.timeoutSignals[e]||(this.timeoutSignals[e]=setTimeout((()=>{const a=s();this.handleWarning(e,t,a),this.timeoutSignals[e]=void 0}),500))}handleWarning(e,t,s){const a=this.warningConfigs[e].default,i=this.warningConfigs[e].items,n=this.warningConfigs[e].avgRequest,r=a.hit;let o,c,l;const d=s.sorted;for(let u=0;u<d.length;u++){const[e,t]=d[u],a=i[e];if(a){if(t>=a.hit){o=`HIT. ${t} ${zx} (${e})`,c=JSON.stringify(d),l=JSON.stringify(s.meta);break}}else if(t>=r){o=`HIT. ${t} ${zx} (${e})`,c=JSON.stringify(d),l=JSON.stringify(s.meta);break}}if(!o&&this.initTime){let e=t.totalRequestInLiveTime/((Object(gu.h)()-this.initTime)/Gx);e=Math.round(e),e>=n&&(o=`AVG. ${e} ${zx}`)}o&&(t.hitCount++,t.error={code:400,message:o,description:c,meta:l,ts:Date.now()},this.hitQueue.enqueue(Object(I.a)(Object(I.a)({},t.error),{},{type:e})),Object(nc.h)(this.name,"all"))}getWarningDetail(e,t,s){const a={};let i="database"===e?{}:void 0;t.toArray().forEach((e=>{const t=s(e);i&&e.method&&(i[e.method]?i[e.method]++:i[e.method]=1),a[t]?a[t]++:a[t]=1}));return{sorted:Object.entries(a).sort((([,e],[,t])=>t-e)),meta:i}}resetData(){this.initTime=void 0,this.data.network.totalRequestInLiveTime=0,this.data.network.queue.clear(),this.data.network.hitCount=0,this.data.network.error=void 0,this.data.database.totalRequestInLiveTime=0,this.data.database.queue.clear(),this.data.database.hitCount=0,this.data.database.error=void 0;for(let e in this.timeoutSignals)this.timeoutSignals[e]&&clearTimeout(this.timeoutSignals[e]);Object(nc.h)(this.name,"all")}getItem(e,t){return this.data}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||Ux)||Ux)||Ux)||Ux)||Ux);Object(gu.d)()&&(window.$zpcHealth||(window.$zpcHealth={}),window.$zpcHealth.resourceWarningController=a.ModuleContainer.resolve(wx.b));const xx={maxRetry:3};var Vx,Hx,Wx,qx,Kx,Zx,$x,Qx=s("Hk5Z"),Yx=s("Y3Ul"),Jx=s("kuNG"),Xx=s("5miw");Vx=Object(a.injectable)(),Hx=Object(a.singleton)(Qx.a),eV=([e])=>e,Wx=(e,t,s)=>{const a=s.value,i=new Map;s.value=async function(...e){const t=eV(e);let s=i.get(t);return s||(s=a.apply(this,e),s.finally((()=>i.delete(t))),i.set(t,s)),s}},qx=Reflect.metadata("design:type",Function),Kx=Reflect.metadata("design:paramtypes",[void 0===Xx.RemoteURL?Object:Xx.RemoteURL]),Vx(Zx=Hx(($x=class{constructor(){this.responseCache_=void 0}async convert(e){if(!e||"string"!=typeof e)return Yx.a.Error({error:new Error("Invalid Remote URL!")});if("blob:"===e.slice(0,5))return Yx.a.Success({blobURL:e});this.responseCache_||(this.responseCache_=this.getCacheLazily_());if(this.responseCache_.has(e)){const t=this.responseCache_.get(e);return Yx.a.Success({blobURL:t.blobURL})}try{const t=Object(af.a)(fetch,{min:1e3,max:5e3,retries:3,afterRetry:async({success:e})=>{}}),s=await t(e),a=await s.blob(),i=URL.createObjectURL(a);return this.responseCache_.set(e,{remoteURL:e,blobURL:i}),Yx.a.Success({blobURL:i})}catch(t){return Yx.a.Error({error:t})}}revokeBlobUrl_(e){URL.revokeObjectURL(e)}getCacheLazily_(){return new u.default({maxSize:Object(Jx.a)().config.max_bu_cache_size,onEviction:(e,t)=>{this.revokeBlobUrl_(t.blobURL)}})}},Object(Ok.a)($x.prototype,"convert",[Wx,qx,Kx],Object.getOwnPropertyDescriptor($x.prototype,"convert"),$x.prototype),Zx=$x))||Zx);var eV;const tV=Object(a.define)("InternalEventBus");var sV;Object(a.injectable)()(sV=Object(a.singleton)(tV)(sV=class extends hs.b{})||sV);const aV=Object(a.define)("AIStickerMapper");function iV(e,t="token"){if("number"!=typeof e||Number.isNaN(e))throw Error(`${t}=${e} is invalid!`);return e}class nV{constructor(e,t,s,a,i){this.id=void 0,this.rootStickerCateId=void 0,this.url=void 0,this.width=void 0,this.height=void 0,this.id=iV(e,"id"),this.rootStickerCateId=iV(t,"rootStickerCateId"),this.url=function(e,t="token"){if(!e)throw Error(`${t}=${e} is invalid!`);return e}(s,"url"),this.width=iV(a,"width"),this.height=iV(i,"height")}equals(e){return this.id===e.id}}var rV;s("SF1S");Object(a.injectable)()(rV=Object(a.singleton)(aV)(rV=class{toAIStickerDTOFromDomain(e){return{id:e.id,url:e.url,thumb:"",type:KT.f.AI_GENERATED,intrinsicWidth:e.width,intrinsicHeight:e.height,renderedWidth:e.width,renderedHeight:e.height,animatable:!1}}toEntityFromSchema(e){return new nV(e.id,e.rootStickerCateId,e.url,e.width,e.height)}toSchemaFromEntity(e){return{id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height}}})||rV);const oV=Object(a.define)("AIStickerAPIClient");var cV;let lV=Object(a.injectable)()(cV=class{forwardAIStickerMessage(e,t,s,a,i,n){return qc.default.apiForwardMessage(e,Y.MSG_PHOTO,t,s,a,i,n)}fetchAIStickerList(){const e={imei:_l.a.getZaloClientID()},t=`${H.b.getStickerDomain()}/api/message/sticker/ai/list?${this.getCommonParams_()}&params=${this.encodeParams_(e)}`;return new Promise(((e,s)=>{this.makeGETRequest_(t,null,12190).then(Co.a).then(e).catch(s)}))}makeGETRequest_(e,t,s,a,i,n,r,o,c){return So.default._get(e,t,s,a,i,n,r,o,c)}getCommonParams_(){return So.default._getCommonParams()}encodeParams_(e){return So.default.getEncodedParams(e)}})||cV;a.ModuleContainer.register(oV,lV);const dV=Object(a.define)("AIStickerLocalStorageDB");var uV;Object(m.f)()(uV=Object(a.injectable)()(uV=Object(a.singleton)(dV)(uV=Reflect.metadata("design:type",Function)(uV=Reflect.metadata("design:paramtypes",[])(uV=class{constructor(){this.tableName_="ai_sticker_tbl_1706849065515"}onAuthenticated(e){}async countAsync(){const e=await this.getRecords_();return e?e.length:0}async getAsync(e){var t;const s=await this.getRecords_();return s&&null!==(t=s.find((t=>t.id===e)))&&void 0!==t?t:null}async getAllAsync(){return await this.getRecords_()}async insertMultiAsync(e){var t;const s=null!==(t=await this.getRecords_())&&void 0!==t?t:[],a=[];e.forEach((e=>{const t=s.findIndex((t=>t.id===e.id));-1===t?a.push(e):s[t]=e}));const i=[...s,...a];return await this.writeRecords_(i),e}async delete(e){let t=await this.getRecords_();return!t||(t=t.filter((t=>t.id!==e)),await this.writeRecords_(t),!0)}async deleteAll(){return await this.writeRecords_([]),!0}async destroyAsync(){const e=this.getLocalStorageDB_();await e.removeItemForCurrentUserAsync(this.tableName_)}async getMultiAsync(e){throw new Error("Method not implemented yet!")}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async deleteMulti(e){throw new Error("Method not implemented yet!")}getLocalStorageDB_(){return n.default.getInstance()}async getRecords_(){const e=this.getLocalStorageDB_(),t=await e.getItemForCurrentUserAsync(this.tableName_);return t?JSON.parse(t):null}async writeRecords_(e){const t=this.getLocalStorageDB_(),s=JSON.stringify(e);await t.setItemForCurrentUserAsync(this.tableName_,s)}})||uV)||uV)||uV)||uV);const hV=Object(a.define)("AIStickerRepository");var gV;Object(a.injectable)()(gV=Object(a.singleton)(hV)(gV=function(e,t){return Object(a.inject)(dV)(e,void 0,0)}(gV=Reflect.metadata("design:type",Function)(gV=Reflect.metadata("design:paramtypes",[Object])(gV=class{constructor(e){this.aiStickerDB_=void 0,this.aiStickerDB_=e}getFakeAIStickers_(){const e=[];return e.push(new nV(1,123,"https://media-ten.z-cdn.me/oXS0nzgaaTQAAAAl/pyonium-cute.webp",498,498)),e.push(new nV(2,123,"https://media-ten.z-cdn.me/krDtrF9w1wYAAAAl/chinese-dragon-dragon.webp",498,498)),e.push(new nV(3,123,"https://media-ten.z-cdn.me/XwHQ_iIQT6MAAAAl/dragon-ball.webp",360,360)),e}async getAllAsync(){return this.getFakeAIStickers_()}async countAsync(){return this.aiStickerDB_.countAsync()}async deleteAll(){return this.aiStickerDB_.deleteAll()}async delete(e){return this.aiStickerDB_.delete(e)}async insertMultiAsync(e){const t=e.map((e=>({id:e.id,rootStickerCateId:e.rootStickerCateId,url:e.url,width:e.width,height:e.height})));return await this.aiStickerDB_.insertMultiAsync(t),e}async insertAsync(e){throw new Error("Method not implemented yet!")}async updateAsync(e,t){throw new Error("Method not implemented yet!")}async getAsync(e){throw new Error("Method not implemented yet!")}async find(e){throw new Error("Method not implemented yet!")}})||gV)||gV)||gV)||gV);var mV=s("xvqP");var pV=s("VLUZ");let fV=function(e){return e.SETUP_AI_STICKER_LIST_UPDATER="SETUP_AI_STICKER_LIST_UPDATER",e.FETCH_AI_STICKER_LIST="FETCH_AI_STICKER_LIST",e.FORWARD_AI_STICKER_MESSAGE="FORWARD_AI_STICKER_MESSAGE",e}({});class vV extends hs.a{constructor(e,t){super(fV.SETUP_AI_STICKER_LIST_UPDATER),this.expiredTime=void 0,this.version=void 0,this.expiredTime=e,this.version=t}}class _V extends hs.a{constructor(e,t){super(fV.FETCH_AI_STICKER_LIST),this.onCompleted=void 0,this.onFailed=void 0,this.onCompleted=null!=e?e:()=>{},this.onFailed=null!=t?t:()=>{}}}class bV extends hs.a{constructor(e,t,s){super(fV.FORWARD_AI_STICKER_MESSAGE),this.payload=void 0,this.onCompleted=void 0,this.onFailed=void 0,this.payload=null!=e?e:{},this.onCompleted=null!=t?t:()=>{},this.onFailed=null!=s?s:()=>{}}}var IV;Object(a.injectable)()(IV=Object(m.f)()(IV=Object(a.singleton)(mV.c)(IV=function(e,t){return Object(a.inject)(oV)(e,void 0,0)}(IV=function(e,t){return Object(a.inject)(tV)(e,void 0,1)}(IV=Reflect.metadata("design:type",Function)(IV=Reflect.metadata("design:paramtypes",[Object,Object])(IV=class{constructor(e,t){this.apiClient_=void 0,this.internalEventBus_=void 0,this.apiClient_=e,this.internalEventBus_=t}onAuthenticated(e){this.internalEventBus_.addEventListener(fV.FETCH_AI_STICKER_LIST,this.handleFetchAPIStickerListEvent_.bind(this)),this.internalEventBus_.addEventListener(fV.FORWARD_AI_STICKER_MESSAGE,this.handleForwardAPIStickerMessageEvent_.bind(this))}getAIStickerList(){return new Promise(((e,t)=>{const s=t=>{e({errorCode:pV.a.SUCCESS,data:{expiredTime:t.expired_time,version:t.version,stickers:t.stickers.map((e=>({id:e.id,url:e.url,width:e.width,height:e.height,rootStickerCateId:e.cateid_root})))}})},a=t=>{e({errorCode:pV.a.FAIL,data:void 0})};this.apiClient_.fetchAIStickerList().then(s).catch((e=>{this.requestErrorHandler_(e,this.getAIStickerList).then(s).catch(a)}))}))}handleForwardAPIStickerMessageEvent_(e){const{payload:t,onCompleted:s,onFailed:a}=e,i=t.retryTimeout?{count:Ce.default.retryConfig.max_retry_count,timeout:t.retryTimeout,timestamp:Date.now(),lowPriority:t.lowPriority}:null,n=Lo.a.newReq();this.apiClient_.forwardAIStickerMessage(t.toUid,t.messageContent,t.clientMsgId,i,n,t.additional).then(s).catch(a)}handleFetchAPIStickerListEvent_(e){this.getAIStickerList().then(e.onCompleted).catch(e.onFailed)}requestErrorHandler_(e,t,s=0){return new Promise(((a,i)=>{if(s>=1)return i(e);let n=-1;switch(e?e.error_code||e.code:"UNKNOWN"){case 112:n=5e3;break;case"ERR_NO_NETWORK":case"ERR_CONNECTION_TIMED_OUT":n=1e4;break;default:n=-1}if(n<0)return i(e);setTimeout((()=>{t().then(a).catch((e=>{this.requestErrorHandler_(e,t,s+1).then(a).catch(i)}))}),n)}))}})||IV)||IV)||IV)||IV)||IV)||IV);const yV="ai_sticker_list_ver_1706778251026",SV="ai_sticker_list_expt_1707057455164";class CV{constructor(){this.aiStickerListVersion_=null,this.versionExpiredTime_=null}getAIStickerListVersion(){if(null==this.aiStickerListVersion_){const t=n.default.getInstance().getItemForCurrentUser(yV);let s=KT.b;if(t)try{s=JSON.parse(t)}catch(e){}this.aiStickerListVersion_=s}return this.aiStickerListVersion_}setAIStickerListVersion(e){this.aiStickerListVersion_=e;n.default.getInstance().setItemForCurrentUser(yV,JSON.stringify(e))}getVersionExpiredTime(){if(null==this.versionExpiredTime_){const t=n.default.getInstance().getItemForCurrentUser(SV);let s=-1;if(t)try{s=JSON.parse(t)}catch(e){}this.versionExpiredTime_=s}return this.versionExpiredTime_}setVersionExpiredTime(e){this.versionExpiredTime_=e;n.default.getInstance().setItemForCurrentUser(SV,JSON.stringify(e))}}CV.NOT_AI_STICKER_LIST_VERSION=KT.b,CV.NOT_VERSION_EXPIRED_TIME=-1;var EV,OV=new CV;let MV=Object(a.injectable)()(EV=function(e,t){return Object(a.inject)(aV)(e,void 0,0)}(EV=function(e,t){return Object(a.inject)(hV)(e,void 0,1)}(EV=function(e,t){return Object(a.inject)(tV)(e,void 0,2)}(EV=Reflect.metadata("design:type",Function)(EV=Reflect.metadata("design:paramtypes",[Object,Object,Object])(EV=class{constructor(e,t,s){this.aiStickerListVersion_=void 0,this.aiStickerMapper_=void 0,this.aiStickerRepository_=void 0,this.internalEventBus_=void 0,this.aiStickerMapper_=e,this.aiStickerRepository_=t,this.internalEventBus_=s,this.aiStickerListVersion_=OV}transformFromAIStickerMessage(e){var t,s,a,i,n;const r=e.content,o=e.content.parsedParams,c=o.contentId,l=null!==(t=null!==(s=null!==(a=r.oriUrl)&&void 0!==a?a:r.hdUrl)&&void 0!==s?s:null===(i=o.webp)||void 0===i?void 0:i.url)&&void 0!==t?t:"";return{id:c,url:l,thumb:null!==(n=r.thumbUrl)&&void 0!==n?n:l,intrinsicWidth:o.width,intrinsicHeight:o.height,renderedWidth:Object(Jx.a)().config.ai_sticker_message.w,renderedHeight:Object(Jx.a)().config.ai_sticker_message.h,animatable:undefined,type:KT.f.AI_GENERATED,extra:{fromSrc:KT.a.MESSAGE}}}transformRecentAIStickerFromAISticker(e){return Object(I.a)(Object(I.a)({},e),{},{extra:{fromSrc:KT.a.RECENT}})}transformFromAIStickerMessageContent(e){throw new Error("Method does not be implemented yet!")}isValidAISticker(e){const t=!!e.id,s=!!e.url,a=e.type===KT.f.AI_GENERATED;return t&&s&&a}isValidAIStickerFromRecentStickerPanel(e){var t;return(null==e||null===(t=e.extra)||void 0===t?void 0:t.fromSrc)===KT.a.RECENT}async getAIStickerList(){let e=await this.aiStickerRepository_.getAllAsync();if((!e||0===e.length)&&this.aiStickerListVersion_.getAIStickerListVersion()===CV.NOT_AI_STICKER_LIST_VERSION){e=await this.syncAIStickerList_()?await this.aiStickerRepository_.getAllAsync():[]}return e.map((e=>this.aiStickerMapper_.toAIStickerDTOFromDomain(e)))}getAIStickerListVersion(){return this.aiStickerListVersion_.getAIStickerListVersion()}async syncAIStickerList_(){return new Promise(((e,t)=>{const s=()=>{e(!1)},a=new _V((async t=>{try{if(t.errorCode===pV.a.SUCCESS){const s=t.data;if(s.version>this.aiStickerListVersion_.getAIStickerListVersion()){const t=s.stickers.map((e=>new nV(e.id,e.rootStickerCateId,e.url,e.width,e.height)));await this.aiStickerRepository_.insertMultiAsync(t),this.aiStickerListVersion_.setAIStickerListVersion(s.version),s.expiredTime&&(this.aiStickerListVersion_.setVersionExpiredTime(s.expiredTime),this.internalEventBus_.dispatchEvent(new vV(s.expiredTime,s.version))),e(!0)}}e(!1)}catch(a){s()}}),s);this.internalEventBus_.dispatchEvent(a)}))}})||EV)||EV)||EV)||EV)||EV)||EV;function TV(e){var t;if(!e)return;let s={message:""};if("string"==typeof e.msg)s.message=e.msg;else try{const t=e.msg;s=Object(I.a)(Object(I.a)({},t),{},{message:t.title||""})}catch(i){}const a=null!==(t=e.ownerId)&&void 0!==t?t:e.fromUid;return Object(I.a)(Object(I.a)({},e),{},{attachment:RT.a.deep(e.attach),rootClientMessageID:e.cliMsgId,rootClientMessageType:e.cliMsgType,rootContent:s,rootGlobalMessageID:e.globalMsgId,rootSentTime:+e.ts,rootSenderName:Ii.default.getDName(a),rootSenderID:a,ttl:e.ttl})}function RV(e){if(e)return{fromID:e.fromId,icon:e.icon,isGroup:Boolean(e.isGroup),isMessageInfo:Boolean(e.isMsgInfo),senderAvatar:e.senderAvatar,senderDisplayName:e.senderDisplayName,threadID:e.threadId,timestamp:e.ts,ttl:e.ttl}}a.ModuleContainer.register(mV.a,MV);const wV=()=>({contentId:"",width:-1,height:-1,thumbWidth:-1,thumbHeight:-1,pStickerType:KT.c.AI_STICKER,webp:{width:-1,height:-1,url:""}});function LV(e){return e?Object(I.a)(Object(I.a)({},e),{},{contentId:e.contentId,pStickerType:e.pStickerType,webp:{width:e.webp.width,height:e.webp.height,url:e.webp.url},height:e.height,width:e.width,thumbHeight:e.thumb_height,thumbWidth:e.thumb_width}):wV()}const DV=()=>({title:"",description:"",oriUrl:"",thumbUrl:"",hdUrl:"",parsedParams:LV(null)});function AV(e){if(!e)return DV();const t=e.params;let s=LV(null);if("string"==typeof t)try{s=LV(JSON.parse(t))}catch(CY){0}else"object"==typeof t&&(s=LV(t));return Object(I.a)(Object(I.a)({},e),{},{title:e.title,description:e.description,hdUrl:e.hdUrl,oriUrl:e.oriUrl,thumbUrl:e.thumbUrl,parsedParams:s})}const FV=()=>({color:-1,size:-1,subType:-1,type:-1,parsedExt:{sSrcStr:"",sSrcType:-1}});function kV(e){if(!e)return FV();const t=e.ext;let s={sSrcStr:"",sSrcType:-1};if("string"==typeof t)try{s=JSON.parse(t)}catch(CY){0}else"object"==typeof t&&(s=t);return Object(I.a)(Object(I.a)({},e),{},{color:e.color,size:e.size,subType:e.subType,type:e.type,parsedExt:s})}function NV(e){return Object(I.a)(Object(I.a)({},function(e){if(e)return Object(I.a)(Object(I.a)({},e),{},{actionID:e.actionId,clientMessageID:e.cliMsgId,e2eeStatus:e.e2eeStatus,eventInfo:RV(e.eventInfo),extra:e.extra,fromUID:String(e.fromUid),messageID:e.msgId,platformType:e.platformType,quote:TV(e.quote),sentSource:e.src,sentTime:+e.sendDttm,serverTime:+e.serverTime,status:e.status,syncFromMobile:e.syncFromMobile,toUID:String(e.toUid),ttl:e.ttl,type:-1})}(e)),{},{content:AV(e.message),type:9999,src:e.src,msgType:e.msgType,originMsgType:"chat.photo",properties:kV(e.properties)})}var PV,jV=s("bKjh");let UV=Object(a.injectable)()(PV=function(e,t){return Object(a.inject)(tV)(e,void 0,0)}(PV=Reflect.metadata("design:type",Function)(PV=Reflect.metadata("design:paramtypes",[Object])(PV=class{constructor(e){this.internalEventBus_=void 0,this.internalEventBus_=e}isAIStickerMessageObject(e){return Object(jV.b)(e)}isAIStickerMessage(e){return Object(jV.a)(e)}isOldAIStickerMessage(e){return Object(jV.e)(e)}isNewAIStickerMessage(e){return Object(jV.d)(e)}transformFromRawMessage(e){return NV(e)}transformAIStickerMessageObjectFromAISticker(e,t){return{toId:e,sendByUrl:!0,title:"",description:"",file:{},img:t.url,oriUrl:t.url,thumbUrl:t.thumb||t.url,hdUrl:t.url,width:t.intrinsicWidth,height:t.intrinsicHeight,params:{contentId:t.id,pStickerType:KT.c.AI_STICKER,height:t.intrinsicHeight,width:t.intrinsicWidth,thumb_width:t.intrinsicWidth,thumb_height:t.intrinsicHeight,webp:{width:t.intrinsicWidth,height:t.intrinsicHeight,url:t.url}},properties:{subType:0,color:-1,size:-1,type:Y.MSG_BUBBLE_LAYOUT_TYPE_NO_BORDER,ext:{sSrcStr:KT.d.AI,sSrcType:KT.e.AI}}}}forwardAIStickerMessage(e,t,s,a={retryTimeout:0,lowPriority:!1,fwAdditional:{}}){return new Promise(((i,n)=>{const r=s.content.parsedParams.webp.url||s.content.oriUrl;if(!r)return n();this.checkAlive_(r,{count:Ce.default.retryConfig.max_normal_request_retry_count}).then((()=>{var r,o,c,l,d,u;const h={description:"",title:"",oriUrl:s.content.oriUrl,thumbUrl:s.content.thumbUrl,normalUrl:s.content.normalUrl,hdUrl:s.content.hdUrl||s.content.normalUrl,contentId:s.content.parsedParams.contentId,thumb_width:null!==(r=s.content.parsedParams.thumbWidth)&&void 0!==r?r:s.content.parsedParams.width,thumb_height:null!==(o=s.content.parsedParams.thumbHeight)&&void 0!==o?o:s.content.parsedParams.height,webp:JSON.stringify(s.content.parsedParams.webp),width:s.content.parsedParams.width,height:s.content.parsedParams.height,properties:JSON.stringify({color:s.properties.color,size:s.properties.size,subType:s.properties.subType,type:s.properties.type,ext:JSON.stringify(s.properties.parsedExt)}),pStickerType:s.content.parsedParams.pStickerType,photoId:null!==(c=s.content.photoId)&&void 0!==c?c:1},g=s.e2eeStatus===Y.MSG_E2EE;g&&(h.isAISticker=!0);const m=new bV({toUid:e,clientMsgId:t,lowPriority:null!==(l=a.lowPriority)&&void 0!==l&&l,retryTimeout:null!==(d=a.retryTimeout)&&void 0!==d?d:0,messageContent:h,additional:null!==(u=a.fwAdditional)&&void 0!==u?u:{}},(async e=>{if(g)i(e);else{const t={msgId:e.msgId+"",thumbUrl:s.content.thumbUrl,hdUrl:s.content.hdUrl,oriUrl:s.content.oriUrl,width:s.content.parsedParams.width,height:s.content.parsedParams.height};i(t)}}),(async e=>{n(e)}));this.internalEventBus_.dispatchEvent(m)})).catch(n)}))}checkAlive_(e,t){return new Promise(((s,i)=>{ui.default.checkAlive(e).then(s).catch((n=>{if(Ce.default.retryConfig.enable_add_missing_retry&&n===xS.XMLHttpRequestErrorCode.NO_RESPONSE&&t.count){t.count=t.count-1;const n=()=>this.checkAlive_(e,t).then(s).catch(i);a.ModuleContainer.resolve(xS.ConnectionPendingController).pushToRetryQueue(n)}else i(n)}))}))}})||PV)||PV)||PV)||PV;a.ModuleContainer.register(mV.b,UV);var BV,zV=s("56jR"),GV=s("397E"),xV=s("RJlJ");Object(a.injectable)()(BV=Object(m.f)()(BV=Object(xi.b)(GV.b)(BV=Object(a.singleton)(GV.b)(BV=function(e,t){return Object(a.inject)(mV.a)(e,void 0,0)}(BV=Reflect.metadata("design:type",Function)(BV=Reflect.metadata("design:paramtypes",[void 0===zV.IAIStickerAppService?Object:zV.IAIStickerAppService])(BV=class{constructor(e){this.aiStickerService_=void 0,this.state_={version:KT.b,aiStickers:[]},this.name=GV.a,this.key=xV.a,this.aiStickerService_=e}onAuthenticated(e){Object(Jx.a)().isEnable("AIStickerTab")&&this.aiStickerService_.getAIStickerList().then((e=>{this.state_.version=this.aiStickerService_.getAIStickerListVersion(),this.state_.aiStickers=e,Object(nc.h)(this.name,this.key)}))}getAIStickerList(){return this.state_.aiStickers}init(){}getItem(e){if(e.key===this.key)return this.state_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||BV)||BV)||BV)||BV)||BV)||BV);var VV=s("T6Qc"),HV=s("RYTL");const WV=Object(HV.b)("socket-polling"),qV=Object(HV.b)("event-bus"),KV=Object(HV.b)("z-storage"),ZV=Object(HV.b)("z-search-v3"),$V=Object(HV.b)("actionlog-service"),QV=Object(HV.b)("important-message-manager"),YV=Object(HV.b)("sync-message-controller");var JV,XV=s("KBxP");const eH=new ee.a({enable:ee.b.field().boolean(),batch_size:ee.b.field().number().min(0),enable_fetch_foreground:ee.b.field().boolean(),enable_segment_updater:ee.b.field().boolean(),enable_tracking_overflow:ee.b.field().boolean(),enable_local_msgId_attach:ee.b.field().boolean(),min_throttle:ee.b.field().number().min(100),throttle:ee.b.field().number().min(0),throttle_idle:ee.b.field().number(),group_queue_config:ee.b.field().array("string"),one_one_queue_config:ee.b.field().array("string"),interval_check_insufficient_data:ee.b.field().number().min(0),max_time_check_insufficient_data:ee.b.field().number().min(0),max_retry_batch:ee.b.field().number().min(0),retry_strategy:ee.b.field().string().oneOf(["fibo","linear"]),time_exclude:ee.b.field().array("number"),debugger:ee.b.field().schema({show_msg_src:ee.b.field().boolean(),logger:ee.b.field().schema({machine_transition:ee.b.field().boolean(),save_message:ee.b.field().boolean(),batch_request_info:ee.b.field().boolean(),interval_update_sufficient_ts:ee.b.field().boolean()}),simulator:ee.b.field().schema({overflow_db_group_offline:ee.b.field().boolean(),slow_load_message:ee.b.field().boolean()})})});let tH=Object(HV.d)()(JV=Object(HV.e)(VV.b)(JV=Reflect.metadata("design:type",Function)(JV=Reflect.metadata("design:paramtypes",[])(JV=class extends X.ZFeatureConfig{constructor(){super({default:XV.b,valiator:eH})}selector(e){return e.auto_fetch_msg_mini_cloud||{}}shouldConfigUpdate(e,t){return!new E.g.Comparer(e,t,!0).AND("enable").AND("batch_size").AND("min_throttle").AND("enable_fetch_foreground").AND("enable_segment_updater").AND("enable_tracking_overflow").AND("enable_local_msgId_attach").AND("throttle").AND("throttle_idle").AND("group_queue_config",rC.a.isEqual).AND("one_one_queue_config",rC.a.isEqual).AND("interval_check_insufficient_data").AND("max_time_check_insufficient_data").AND("max_retry_batch").AND("retry_strategy").AND("time_exclude",rC.a.isEqual).AND("debugger",rC.a.isEqual).exec()}})||JV)||JV)||JV)||JV;var sH=s("7Yx4");let aH=function(e){return e.OVERFLOW_DB_GROUP_OFFLINE="OVERFLOW_DB_GROUP_OFFLINE",e.NEXT_CURSOR="NEXT_CURSOR",e}({});var iH=s("j8Zv");let nH=function(e){return e[e.ONLY_1_1=0]="ONLY_1_1",e[e.ONLY_GROUP=1]="ONLY_GROUP",e[e.BOTH_1_1_AND_GROUP=2]="BOTH_1_1_AND_GROUP",e[e.NONE=3]="NONE",e}({});class rH extends hs.a{constructor(e){super(Ym.a.SHOW_SYNC_MESSAGE_SUGGESTION),this.queueId=e}}class oH extends hs.a{constructor(){super(Ym.a.AFMC_START)}}class cH extends hs.a{constructor(){super(Ym.a.AFMC_FINISHED)}}class lH extends hs.a{constructor(e){super(Ym.a.AFMC_START_FETCH_CONV),this.convId=e}}class dH extends hs.a{constructor(e,t){super(Ym.a.AFMC_STOP_FETCH_CONV),this.convId=e,this.success=t}}var uH;let hH=Object(HV.d)()(uH=Object(yo.e)()(uH=Object(HV.e)(VV.c)(uH=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)}(uH=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,1)}(uH=function(e,t){return Object(yo.d)(VV.b)(e,void 0,2)}(uH=function(e,t){return Object(yo.d)(VV.n)(e,void 0,3)}(uH=function(e,t){return Object(yo.d)(VV.h)(e,void 0,4)}(uH=function(e,t){return Object(yo.d)(VV.k)(e,void 0,5)}(uH=function(e,t){return Object(yo.d)(VV.o)(e,void 0,6)}(uH=function(e,t){return Object(yo.d)(VV.i)(e,void 0,7)}(uH=function(e,t){return Object(yo.d)(VV.r)(e,void 0,8)}(uH=function(e,t){return Object(yo.d)(VV.e)(e,void 0,9)}(uH=Reflect.metadata("design:type",Function)(uH=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMachine?Object:AFMC_IMachine,"undefined"==typeof AFMC_ITrackingOverflowMessage?Object:AFMC_ITrackingOverflowMessage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(uH=class extends hs.b{constructor(e,t,s,a,i,n,r,o,c,l){super(),this.logger=void 0,this.service=void 0,this.ledger=void 0,this.metrics=void 0,this.storage=void 0,this.systemTime=void 0,this.fetcherMachine=void 0,this.eventCollector=void 0,this.trackingOverflow=void 0,this.config=void 0,this.isInsufficientMessage=void 0,this.onOverflowDBGroupOffline=e=>{this.logger.zsymb(0,"2q4Ypv","DB Group offline overflow, should suggest sync message"),this.dispatchEvent(new rH(e.queueId))},this.onNextCursor=async e=>{const{currCheckpoint:t,nextCheckpoint:s}=e;t&&this.dispatchEvent(new dH(t.convId,await t.isDone())),s&&this.dispatchEvent(new lH(s.convId))},this.onConfigUpdate=e=>{!0===e.config.enable?this.fetcherMachine.status!==Km.b.Running?(this.logger.zsymb(0,"qjDA3F","Receive config enabled, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):this.logger.zsymb(0,"Sbthkd","Receive config enable but machine is already started"):(this.logger.zsymb(0,"T8LTEh","Receive config disabled, let stop machine"),this.fetcherMachine.stop(),this.unregisterMachineListener())},this.onMachineTransition=e=>{switch(e.event.type){case"START":this.onMachineStartFetch();break;case"STOP":this.onMachineStopFetch()}this.config.get("debugger.logger.machine_transition")&&this.logger.zsymb(12,"fCnfXC","machine transition",JSON.stringify(e.value))},this.onMachineStop=()=>{this.logger.zsymb(0,"Fvdaja","Machine is stopped")},this.onMachineStartFetch=async()=>{this.dispatchEvent(new oH);const e=this.isInsufficientMessage=await this.service.isInsufficientMessage(),t=this.trackingOverflow.getOverflowStatus(),s=this.fetcherMachine.hasRemainConvInPrevSession();if(e){const e=await this.storage.getLastQueueIdOverflowMessage();this.dispatchEvent(new rH(null!=e?e:iH.a.SOCKET_MESSAGE_GROUP_OLD)),this.logger.zsymb(0,"ff1a_4","User messages may not be enough, should suggest sync message"),this.metrics.logAutoShowBannerSuggestion(s)}else if(this.logger.zsymb(0,"amx-HC","Can cover overflow by fetch message from mini-cloud"),t===nH.ONLY_GROUP)this.metrics.logAutoHideBannerSuggestion();this.metrics.logStartFetch(e,t)},this.onMachineStopFetch=async()=>{const e=0===await this.ledger.size();e?(this.logger.zsymb(0,"OlBz3i","fetch done"),this.storage.saveLastFetchSuccess(this.systemTime.getTimeNow())):this.logger.zsymb(18,"IPTmDV","fetch stop"),null!==this.isInsufficientMessage&&this.metrics.logStopFetch(this.isInsufficientMessage,this.trackingOverflow.getOverflowStatus(),e),this.isInsufficientMessage=null,this.dispatchEvent(new cH)},this.onOverflowMessageQueue=async e=>!1===this.config.get("enable")?(this.logger.zsymb(0,"uNN4kG","Module is disabled, should suggest sync message"),void this.dispatchEvent(new rH(e.queueId))):!1===this.service.isQueueMessageGroup(e.queueId)?(this.logger.zsymb(0,"6k01lY","Detected overflow other queue, forward event to suggest sync message"),void this.dispatchEvent(new rH(e.queueId))):void this.logger.zsymb(0,"8WyJs3","Detected overflow queue message group, let wait done offline"),this.logger=e.createZLogger(w.ZLoggerNametags.autoFetchMsgCloud,[w.ZLoggerNametags.controller]),this.config=s,this.ledger=i,this.service=a,this.metrics=n,this.storage=r,this.systemTime=t,this.fetcherMachine=o,this.eventCollector=l,this.trackingOverflow=c,this.isInsufficientMessage=null}start(){this.fetcherMachine.create(),this.registerListener(),this.config.get("enable")?(this.logger.zsymb(0,"vVNwKB","Module is enabled on startup, let start machine"),this.registerMachineListener(),this.fetcherMachine.start()):this.logger.zsymb(0,"l6uh_e","Module is disabled on startup, let listen config from server")}getRemainConvIds(){return this.fetcherMachine.getRemainConvIds()}registerListener(){this.config.addEventListener("update",this.onConfigUpdate),this.ledger.addEventListener(aH.OVERFLOW_DB_GROUP_OFFLINE,this.onOverflowDBGroupOffline),this.ledger.addEventListener(aH.NEXT_CURSOR,this.onNextCursor),this.eventCollector.addEventListener(sH.a.OVERFLOW_MESSAGE_QUEUE,this.onOverflowMessageQueue)}registerMachineListener(){this.logger.zsymb(0,"DJbAYO","register machine listener"),this.fetcherMachine.onStop(this.onMachineStop),this.fetcherMachine.onTransition(this.onMachineTransition)}unregisterMachineListener(){this.logger.zsymb(0,"3wmAu7","unregister machine listener"),this.fetcherMachine.off(this.onMachineStop),this.fetcherMachine.off(this.onMachineTransition)}})||uH)||uH)||uH)||uH)||uH)||uH)||uH)||uH)||uH)||uH)||uH)||uH)||uH)||uH)||uH,gH=function(e){return e.AUTO_FETCH_MSG_CLOUD_SETTING="auto_fetch_msg_cloud",e.SYNC_MESSAGE_SETTING="sync_cross_settings",e.IMPORT_MESSAGE_SETTING="export_import_data",e.OVERFLOW_MSG_TS="overflow_msg_ts",e.SUFFICIENT_MSG_TS="sufficient_msg_ts",e.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS="last-time-close-first-login-transfer-modal",e}({});class mH{constructor(e,t,s){this.key=void 0,this.version=void 0,this.storageAdapter=void 0,this.data=null,this.key=e,this.version=t,this.storageAdapter=s}async get(){return this.data?this.data:this.data=await this.storageAdapter.readAsync(this.key,this.version)}async save(e){this.data=e,await this.storageAdapter.writeAsync(this.key,this.version,e)}async clear(){this.data=null,await this.storageAdapter.removeAsync(this.key)}}class pH extends mH{constructor(e,t){super([e,"conv_ids"].join("_"),1,t)}async remove(e){var t;const s=(null!==(t=await this.get())&&void 0!==t?t:[]).filter((t=>t!==e));await this.save(s)}async getRemainConv(){const e=await this.get();return(null==e?void 0:e.length)||0}}class fH extends mH{constructor(e,t){super([e,"overflow"].join("_"),1,t)}}class vH extends mH{constructor(e,t){super([e,"last_fetch"].join("_"),2,t)}async getLastTsSuccess(){var e,t;return null!==(t=(null!==(e=await this.get())&&void 0!==e?e:{}).lastTsSuccess)&&void 0!==t?t:-1}async getFetchInfo(){var e;return null!==(e=await this.get())&&void 0!==e?e:{}}async saveLastTsSuccess(e){var t;const s=null!==(t=await this.get())&&void 0!==t?t:{};return this.save(Object(I.a)(Object(I.a)({},s),{},{lastTsSuccess:e}))}async saveStartFetchInfo(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{};n.evict||(n.evict=e.evict),n.listTsStart=(null!==(a=n.listTsStart)&&void 0!==a?a:[]).concat(e.tsStart),n.tsSufficient=e.tsSufficient,await this.save(Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n}))}async saveConvIds(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{};n.convIds=E.b.merge(null!==(a=null==n?void 0:n.convIds)&&void 0!==a?a:[],e);const r=Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n});await this.save(r)}async saveConvErrorIds(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{},r=null!==(a=null==n?void 0:n.convErrorIds)&&void 0!==a?a:[],o=E.b.merge(r,e);n.convErrorIds=o,await this.save(Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n}))}async saveTotalMessageFetched(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{},r=(null!==(a=n.totalMsgFetched)&&void 0!==a?a:0)+e;n.totalMsgFetched=r,await this.save(Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n}))}async removeLastStartFetchInfo(){var e;const t=null!==(e=await this.get())&&void 0!==e?e:{};return delete t.onProgressInfo,this.save(t)}async removeConvId(e){var t,s,a,i;const n=null!==(t=await this.get())&&void 0!==t?t:{},r=null!==(s=n.onProgressInfo)&&void 0!==s?s:{};r.convIds=(null!==(a=r.convIds)&&void 0!==a?a:[]).filter((t=>t!==e)),r.convErrorIds=(null!==(i=r.convErrorIds)&&void 0!==i?i:[]).filter((t=>t!==e));const o=Object(I.a)(Object(I.a)({},n),{},{onProgressInfo:r});await this.save(o)}async removeConvIdFetchFailed(e){var t,s,a;const i=null!==(t=await this.get())&&void 0!==t?t:{},n=null!==(s=i.onProgressInfo)&&void 0!==s?s:{};n.convErrorIds=(null!==(a=n.convErrorIds)&&void 0!==a?a:[]).filter((t=>t!==e));const r=Object(I.a)(Object(I.a)({},i),{},{onProgressInfo:n});await this.save(r)}}var _H;let bH=Object(HV.d)()(_H=Object(yo.e)()(_H=Object(HV.e)(VV.o)(_H=function(e,t){return Object(yo.d)(VV.a)(e,void 0,0)}(_H=Reflect.metadata("design:type",Function)(_H=Reflect.metadata("design:paramtypes",["undefined"==typeof IAsyncStorageAdapter?Object:IAsyncStorageAdapter])(_H=class{constructor(e){this.localStorage=void 0,this.storageConvIds=void 0,this.storageOverflow=void 0,this.storageLastFetch=void 0,this.localStorage=n.default.getInstance(),this.storageConvIds=new pH(gH.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageOverflow=new fH(gH.AUTO_FETCH_MSG_CLOUD_SETTING,e),this.storageLastFetch=new vH(gH.AUTO_FETCH_MSG_CLOUD_SETTING,e)}async getAllConvIds(){var e;return null!==(e=await this.storageConvIds.get())&&void 0!==e?e:[]}async getLastTsSyncMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(gH.SYNC_MESSAGE_SETTING),[,s]=E.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastSync)&&void 0!==e?e:-1}async getLastTsCloseTransferSuggestion(){var e;const t=this.localStorage.getItemForCurrentUser(gH.SYNC_MESSAGE_SETTING),[,s]=E.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastCloseSuggest)&&void 0!==e?e:-1}async getLastTsCloseFirstLoginTransferSuggestion(){const e=await this.localStorage.getItemForCurrentUserAsync(gH.LAST_CLOSE_FIRST_LOGIN_TRANSFER_MODAL_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getLastTsImportMessageSuccess(){var e;const t=this.localStorage.getItemForCurrentUser(gH.IMPORT_MESSAGE_SETTING),[,s]=E.g.safeParseJson(t||"");return null!==(e=null==s?void 0:s.lastTimeImportSuccess)&&void 0!==e?e:-1}async getLastTsAutoFetchMessageSuccess(){return await this.storageLastFetch.getLastTsSuccess()}async getFetchInfo(){return await this.storageLastFetch.getFetchInfo()}async getLastTsOverflowMessage(){const e=this.localStorage.getItemForCurrentUser(gH.OVERFLOW_MSG_TS);if(e){const[t]=e.split("::");if(!isNaN(Number(t)))return Number(t)}return-1}async getLastQueueIdOverflowMessage(){const e=this.localStorage.getItemForCurrentUser(gH.OVERFLOW_MSG_TS);if(e){const[t,s]=e.split("::");return s||null}return null}async getLastTsSufficientMessage(){const e=this.localStorage.getItemForCurrentUser(gH.SUFFICIENT_MSG_TS);return e&&!isNaN(Number(e))?Number(e):-1}async getOverflowInfo(){return await this.storageOverflow.get()}async getRemainConv(){return await this.storageConvIds.getRemainConv()}async saveConvIds(e){await this.storageConvIds.save(e),await this.storageLastFetch.saveConvIds(e)}async saveLastFetchSuccess(e){await this.storageLastFetch.saveLastTsSuccess(e)}async saveLastOverflow(e,t){this.localStorage.setItemForCurrentUser(gH.OVERFLOW_MSG_TS,[t,e].join("::"))}async saveLastSufficientMessage(e){this.localStorage.setItemForCurrentUser(gH.SUFFICIENT_MSG_TS,String(e))}async saveOverflowInfo(e,t,s){await this.storageOverflow.save({queueId:e,lastMsgId:t,lastActionId:s})}async saveStartFetchInfo(e){await this.storageLastFetch.saveStartFetchInfo(e)}async saveConvErrorId(e){await this.storageLastFetch.saveConvErrorIds([e])}async saveTotalMessageFetched(e){await this.storageLastFetch.saveTotalMessageFetched(e)}async removeOverflowInfo(){await this.storageOverflow.clear()}async removeConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvIdFetchFailed(e)}async forceRemoveConvId(e){await this.storageConvIds.remove(e),await this.storageLastFetch.removeConvId(e)}async removeStartFetchInfo(){await this.storageLastFetch.removeLastStartFetchInfo()}})||_H)||_H)||_H)||_H)||_H)||_H;var IH;let yH=Object(HV.d)()(IH=Object(HV.e)(VV.a)(IH=Reflect.metadata("design:type",Function)(IH=Reflect.metadata("design:paramtypes",[])(IH=class{constructor(){this.storage=void 0,this.storage=n.default.getInstance()}async readAsync(e,t){const s=await this.storage.getItemForCurrentUserAsync(e),[a,i]=E.g.safeParseJson(s);return a||null===i?null:i.version===t?i.value:(await this.storage.removeItemForCurrentUserAsync(e),null)}async writeAsync(e,t,s){const a=JSON.stringify({version:t,value:s});await this.storage.setItemForCurrentUserAsync(e,a)}async removeAsync(e){await this.storage.removeItemForCurrentUserAsync(e)}})||IH)||IH)||IH)||IH;var SH=s("9Gk3"),CH=s("WnuJ"),EH=s("wd/R"),OH=s.n(EH);const MH=(e,t={})=>(s,a,i)=>{const n=i.value,r=new Map,o=new u.default({maxSize:10});i.value=async function(...s){const a=e(s);let i=null;return t.cache&&(i=o.get(a)||null),i=i||r.get(a)||null,i||(i=n.apply(this,s),t.cache&&i.then((()=>{o.set(a,i)})),i.finally((()=>r.delete(a))),r.set(a,i)),i}};let TH=function(e){return e[e.SAVE_MESSAE_ERROR=0]="SAVE_MESSAE_ERROR",e[e.GET_GROUP_INFO_ERROR=1]="GET_GROUP_INFO_ERROR",e}({});class RH extends Eo.a{constructor(e){super("SaveMessageError",TH.SAVE_MESSAE_ERROR,e)}}class wH extends Eo.a{constructor(e,t){super("GetGroupInfoError",TH.GET_GROUP_INFO_ERROR,"An error occured during get list groups info. Error: "+JSON.stringify(t)+". GroupIds: "+e)}}var LH,DH,AH,FH,kH,NH,PH,jH,UH,BH,zH,GH,xH,VH,HH,WH,qH,KH,ZH,$H,QH,YH;let JH=(LH=Object(HV.d)(),DH=Object(yo.e)(),AH=Object(HV.e)(VV.n),FH=function(e,t){return Object(yo.d)(VV.b)(e,void 0,0)},kH=function(e,t){return Object(yo.d)(VV.o)(e,void 0,1)},NH=function(e,t){return Object(yo.d)(VV.j)(e,void 0,2)},PH=function(e,t){return Object(yo.d)(VV.q)(e,void 0,3)},jH=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,4)},UH=function(e,t){return a.ModuleContainer.inject(go)(e,void 0,5)},BH=function(e,t){return a.ModuleContainer.inject(El.b)(e,void 0,6)},zH=function(e,t){return a.ModuleContainer.inject(Nn.ConversationManager)(e,void 0,7)},GH=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,8)},xH=Reflect.metadata("design:type",Function),VH=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMessageProcessor?Object:AFMC_IMessageProcessor,"undefined"==typeof AFMC_ISufficientMessageController?Object:AFMC_ISufficientMessageController,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof IMessageController?Object:IMessageController,void 0===El.b?Object:El.b,void 0===Nn.ConversationManager?Object:Nn.ConversationManager,"undefined"==typeof ISystemTime?Object:ISystemTime]),HH=MH((([e])=>`${e.convId}::${e.requestMsgId}`),{cache:!0}),WH=Reflect.metadata("design:type",Function),qH=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo]),KH=MH((([e])=>`${e.convId}::${e.requestMsgId}`),{cache:!0}),ZH=Reflect.metadata("design:type",Function),$H=Reflect.metadata("design:paramtypes",["undefined"==typeof IBatchRequestInfo?Object:IBatchRequestInfo,Array]),LH(QH=DH(QH=AH(QH=FH(QH=kH(QH=NH(QH=PH(QH=jH(QH=UH(QH=BH(QH=zH(QH=GH(QH=xH(QH=VH((YH=class{constructor(e,t,s,a,i,n,r,o,c){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.groupManager=void 0,this.convManager=void 0,this.messageProcessor=void 0,this.messageController=void 0,this.sufficientMessageController=void 0,this.logger=i.createZLogger(w.ZLoggerNametags.autoFetchMsgCloud,[w.ZLoggerNametags.service]),this.config=e,this.storage=t,this.systemTime=c,this.convManager=o,this.groupManager=r,this.messageProcessor=s,this.messageController=n,this.sufficientMessageController=a}getThrottle(e){return e?Math.max(this.config.get("min_throttle"),this.config.get("throttle")+this.config.get("throttle_idle")):Math.max(this.config.get("min_throttle"),this.config.get("throttle"))}allowFetchForeground(){return this.config.get("enable_fetch_foreground")}async getLocalMsgIdsFrom(e,t,s){let a=[];try{const i=Xt.default.getInstance();let n=null;if(t===Y.MessageConstants.MAX_MSG_ID)n=Y.MessageConstants.MAX_SENDDTTM;else{const s=await i.Core.Message.get(t,{partition:e});s&&(n=s.sendDttm)}n&&(a=await i.Core.Message.getAllKey({from:[e,"",""],to:[e,n,t],excludeTo:!0},{partition:e,index:"userId_sendDttm_msgId",direction:O.c.PREV,limit:s}),a=a.filter((e=>!CH.a.isFakeId(e))),a.sort())}catch{}return a}async fetchMessages(e){const{convId:t,requestMsgId:s}=e,a=this.config.get("batch_size");let i=[];this.config.get("enable_local_msgId_attach")&&(i=await this.getLocalMsgIdsFrom(t,s,a));const n=await this.messageController.fetchMessagesCloud(t,s,a,{isOA:0,src:SH.c.AUTO_FETCH_MINI_CLOUD,localMsgIds:i});return n.groupMsgs.forEach((e=>e.setSrc(Y.MSG_SRC.AUTO_LOADER))),n}async processMessages(e,t){const[s,a]=await E.c.catchPromise(this.messageProcessor.process(e,t));return Uk(s,new RH("Save messages error "+(null==s?void 0:s.toString()))),a}checkBusyHour(){const e=this.systemTime.getTimeNow(),t=OH()(e).get("h");if(!1===this.config.get("time_exclude").includes(t))return[!1,0];const s=Math.random()*Math.max(this.config.get("throttle"),this.config.get("min_throttle")),a=OH()(e).add(1,"h").set("m",0).set("s",0).toDate().getTime();return[!0,Math.abs(a-e)+s]}checkMaxRetryBatch(e,t){if(e>=this.config.get("max_retry_batch"))return[!0,0];let s=this.getThrottle(t)+1e3*Math.random();if("fibo"===this.config.get("retry_strategy"))s+=1e3*E.f.get(e+1);return[!1,s]}async isInsufficientMessage(){const e=await this.sufficientMessageController.getLastTsSufficientMessage();return this.systemTime.getTimeNow()-e>this.config.get("max_time_check_insufficient_data")}isQueueMessageGroup(e){return this.config.get("group_queue_config").includes(e.toString())}async getGroupsHaveMessageOffline(){let e=!1,t=[];const s=await this.storage.getOverflowInfo();if(s){const a=await this.messageController.getGroupHasMessageOffline(s.queueId,s.lastMsgId,s.lastActionId);e=a.evict,t=a.listConvIds,XV.a&&this.config.get("debugger.simulator.overflow_db_group_offline")&&(e=!0)}const a=await this.storage.getAllConvIds(),i=E.b.merge(t,a),[n,r]=await E.c.catchPromise(this.groupManager.getMulti(i));Uk(n,new wH(i,n));const o=await E.b.asyncMapParallel(r,(async e=>{const s=await this.convManager.get(e.id),a=e.isAdmin()||e.isOwner(),i=!(null==s||!s.isPinned),n=!(null==s||!s.isMuted),r=e.totalMembers;let o=-1,c=-1;const l=await(null==s?void 0:s.getLastMessage());return null!=l&&l.sendDttm&&(o=Number(l.sendDttm),c=E.d.getNumberOfDays(o,this.systemTime.getTimeNow())),{convId:e.id,groupInfo:e,isNewGroupOffline:t.includes(e.id),isPinned:i,isOwnerOrAdmin:a,isMuted:n,lastActiveTime:o,totalMembers:r,lastActiveTimeInDays:c}}));return e?{listGroups:o,evict:e,queueId:s.queueId}:{listGroups:o,evict:e,queueId:null}}reloadMessageOfConv(e){this.messageController.reloadMessage(e)}},Object(Ok.a)(YH.prototype,"fetchMessages",[HH,WH,qH],Object.getOwnPropertyDescriptor(YH.prototype,"fetchMessages"),YH.prototype),Object(Ok.a)(YH.prototype,"processMessages",[KH,ZH,$H],Object.getOwnPropertyDescriptor(YH.prototype,"processMessages"),YH.prototype),QH=YH))||QH)||QH)||QH)||QH)||QH)||QH)||QH)||QH)||QH)||QH)||QH)||QH)||QH)||QH);var XH,eW=s("C3LF");let tW=Object(HV.d)()(XH=Object(yo.e)()(XH=Object(HV.e)(VV.e)(XH=function(e,t){return Object(yo.d)(qV)(e,void 0,0)}(XH=function(e,t){return Object(yo.d)(WV)(e,void 0,1)}(XH=function(e,t){return Object(yo.d)(YV)(e,void 0,2)}(XH=function(e,t){return a.ModuleContainer.inject(m.a)(e,void 0,3)}(XH=Reflect.metadata("design:type",Function)(XH=Reflect.metadata("design:paramtypes",["undefined"==typeof IEventBus?Object:IEventBus,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof SyncMessageController?Object:SyncMessageController,"undefined"==typeof BaseApplication?Object:BaseApplication])(XH=class extends hs.b{constructor(e,t,s,a){super(),this.onStartPullOffline=()=>{this.dispatchEvent(new eW.l)},this.onDonePullOffline=()=>{this.dispatchEvent(new eW.n)},this.onOverflowQueue=e=>{this.dispatchEvent(new eW.j(e.queueId))},this.onStartSyncMessage=()=>{this.dispatchEvent(new eW.m("start"))},this.onResumeSyncMessage=()=>{this.dispatchEvent(new eW.m("resume"))},this.onSyncMessageSuccess=()=>{this.dispatchEvent(new eW.o("",!0))},this.onSyncMessageFailed=()=>{this.dispatchEvent(new eW.o("",!1))},this.onApplicationBackground=()=>{this.dispatchEvent(new eW.a)},this.onApplicationForeground=()=>{this.dispatchEvent(new eW.c)},this.onApplicationExit=()=>{this.dispatchEvent(new eW.b)},this.onNetworkStatusChanged=e=>{this.dispatchEvent(new eW.i(e))},this.onLogout=()=>{this.dispatchEvent(new eW.h)},this.onServiceReady=()=>{this.dispatchEvent(new eW.k)},this.onBeforeUnload=()=>{this.dispatchEvent(new eW.d)},this.registerListener(e,t,a,s)}registerListener(e,t,s,a){var i,n,r,o,c;e.subscribe(((e,t)=>{switch(e){case ve.FetchActions.CHECK_OVERFLOW_QUEUE_BY_FLAG:return this.onOverflowQueue(t);case ve.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t)}})),t.addEventListener(Tu.SOCKET_POLLING_EVENT.CHAT_CONNECTED,(e=>{var t,s;e.nextChatHandler.subcribe(Ru.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),e.nextChatHandler.subcribe(Ru.b.ON_DONE_OFFLINE,this.onDonePullOffline),null===(t=e.prevChatHandler)||void 0===t||t.unsubcribe(Ru.b.ON_START_PULL_OFFLINE,this.onStartPullOffline),null===(s=e.prevChatHandler)||void 0===s||s.unsubcribe(Ru.b.ON_DONE_OFFLINE,this.onDonePullOffline)})),null==a||null===(i=a.addEventListener)||void 0===i||i.call(a,Cm.e.ON_START,this.onStartSyncMessage),null==a||null===(n=a.addEventListener)||void 0===n||n.call(a,Cm.e.ON_RETRY,this.onStartSyncMessage),null==a||null===(r=a.addEventListener)||void 0===r||r.call(a,Cm.e.ON_RESUME,this.onResumeSyncMessage),null==a||null===(o=a.addEventListener)||void 0===o||o.call(a,Cm.e.ON_SUCCESS,this.onSyncMessageSuccess),null==a||null===(c=a.addEventListener)||void 0===c||c.call(a,Cm.e.ON_FAILED,this.onSyncMessageFailed),s.addEventListener(m.b.Idle,this.onApplicationBackground),s.addEventListener(m.b.Active,this.onApplicationForeground),s.addEventListener(m.b.Exit,this.onApplicationExit),s.addEventListener(m.b.ServicesReady,this.onServiceReady),s.addEventListener(m.b.BeforeUnload,this.onBeforeUnload),s.addEventListener(m.b.LogOut,this.onLogout)}onLeaveGroup(e){this.dispatchEvent(new eW.f(e))}onDeleteConv(e){this.dispatchEvent(new eW.e(e))}})||XH)||XH)||XH)||XH)||XH)||XH)||XH)||XH)||XH;var sW,aW,iW,nW,rW,oW,cW,lW,dW,uW,hW,gW,mW,pW,fW=s("Hy6w");class vW{constructor(e,t,s,i,n,r,o,c,l){var d;this.isNew=s,this.isPinned=i,this.isOwnerOrAdmin=n,this.isMuted=r,this.lastActiveTime=o,this.totalMembers=c,this.lastActiveTimeInDays=l,this.segmentController=void 0,this.hasMore=void 0,this.tsCheck=void 0,this.lastMsgId=void 0,this.id=void 0,this.convId=void 0,this.metrics=void 0,this.disabled=!1,this.convId=this.id=t,this.metrics=new _W(t),this.segmentController=e,this.hasMore=!0,this.tsCheck=a.ModuleContainer.resolve(St.b).getTimeNow(),this.lastMsgId=(null===(d=a.ModuleContainer.resolve(Nn.ConvInfoDataManager).getConvByIdSync(this.convId))||void 0===d?void 0:d.lastSmsLocalId)||"0"}getCursor(){return{value:()=>this.getCurrentCursorValue(),next:e=>this.update(e)}}async update(e){const t=await this.segmentController.get(this.convId),s=await this.segmentController.updateSegment(t,e);this.hasMore=this.isHasMoreMessage(e,s)}disable(){this.disabled=!0}async isDone(){return null===await this.getCurrentCursorValue()}async getCurrentCursorValue(){var e;if(!this.hasMore)return null;if(this.disabled)return null;const t=await this.segmentController.get(this.convId),s=this.getRequestMsgId(t);return null===s?null:{convId:this.convId,requestMsgId:s,lastMsgId:this.lastMsgId,lastDeleteMsgId:(null===(e=t.lastDeletedMsgID)||void 0===e?void 0:e.toString())||"0"}}getRequestMsgId(e){var t,s,a;const i=null!==(t=e.lastDeletedMsgID)&&void 0!==t?t:0,n=null!==(s=e.lastCloudVerifiedDttm)&&void 0!==s?s:0,r=null!==(a=e.cloudSegmentCheckAutoFetch)&&void 0!==a?a:[];if(parseInt(this.lastMsgId.replace(".",""))<=i)return null;if(this.tsCheck>n)return Y.MessageConstants.MAX_MSG_ID;for(let o=r.length-1;o>=0;o--){const[e,t]=r[o];if(i>=t)return null;if(i<e)return String(e)}return null}isHasMoreMessage(e,t){return!!e.hasMore&&this.getRequestMsgId(t)!==e.requestMsgId}}class _W{constructor(e){this.convId=e,this.timeTracker=new bW,this.tsStart=0,this.tsStop=0,this.isDone=!1,this.totalBatch=0,this.totalRetry=0}get metrics(){return a.ModuleContainer.resolve(VV.l).get(VV.k)}start(){this.tsStart=performance.now()}stop(e){this.tsStop=performance.now(),this.isDone=e}exportReport(){const e=this.tsStop||performance.now(),t=this.timeTracker.prepare.time,s=this.timeTracker.fetch.time,a=this.timeTracker.sync.time,i=e-this.tsStart,n=i-(t+s+a);return{convId:this.convId,meta:{isDone:this.isDone,total:this.totalBatch,retry:this.totalRetry},duration:{total:i,prepare:t,fetch:s,save:a,idle:n}}}increaseBatch(){this.totalBatch++}increaseRetry(){this.totalRetry++}submit(){const e=this.exportReport();this.metrics.submitConvReport(e)}}class bW{constructor(){this.prepare=new fW.a("AFMC_prepare"),this.fetch=new fW.a("AFMC_fetch"),this.sync=new fW.a("AFMC_sync")}}class IW extends hs.a{constructor(e){super(aH.OVERFLOW_DB_GROUP_OFFLINE),this.queueId=e}}class yW extends hs.a{constructor(e,t){super(aH.NEXT_CURSOR),this.currCheckpoint=e,this.nextCheckpoint=t}}let SW=(sW=Object(yo.e)(),aW=Object(HV.d)(),iW=Object(HV.e)(VV.h),nW=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,0)},rW=function(e,t){return Object(yo.d)(VV.n)(e,void 0,1)},oW=function(e,t){return Object(yo.d)(VV.o)(e,void 0,2)},cW=function(e,t){return Object(yo.d)(VV.k)(e,void 0,3)},lW=Reflect.metadata("design:type",Function),dW=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics]),uW=((e=xx)=>(t,s,a)=>{const i=a.value,n="AsyncFunction"===i.constructor.name;a.value=n?async function(...t){let s=0;for(;;){var a;const[n,r]=await E.c.catchAsyncFn((()=>i.apply(this,t)));if(!n)return r;if(null==e||null===(a=e.onRetry)||void 0===a||a.call(e,n),++s>=e.maxRetry)throw n;e.delay&&await E.c.delay(e.delay+1e3*Math.random())}}:function(...t){let s=0;for(;;){var a;const[n,r]=E.c.catchFn((()=>i.apply(this,t)));if(!n)return r;if(null==e||null===(a=e.onRetry)||void 0===a||a.call(e,n),++s>=e.maxRetry)throw n}}})({maxRetry:3,delay:3e3}),hW=Reflect.metadata("design:type",Function),gW=Reflect.metadata("design:paramtypes",[]),sW(mW=aW(mW=iW(mW=nW(mW=rW(mW=oW(mW=cW(mW=lW(mW=dW((pW=class extends hs.b{constructor(e,t,s,a){super(),this.logger=void 0,this.service=void 0,this.storage=void 0,this.metrics=void 0,this.listCheckpoints=void 0,this.currentCursorIndex=void 0,this.logger=e.createZLogger(w.ZLoggerNametags.autoFetchMsgCloud,[w.ZLoggerNametags.stateMachine]),this.service=t,this.storage=s,this.metrics=a,this.listCheckpoints=[],this.currentCursorIndex=-1}async init(){var e;const{listGroups:t,evict:s,queueId:i}=await this.service.getGroupsHaveMessageOffline();s&&this.dispatchEvent(new IW(i));const n=t.map((e=>e.convId)),r=a.ModuleContainer.resolve(Uo);this.listCheckpoints=t.map((e=>new vW(r,e.convId,e.isNewGroupOffline,e.isPinned,e.isOwnerOrAdmin,e.isMuted,e.lastActiveTime,e.totalMembers,e.lastActiveTimeInDays))),this.listCheckpoints.sort(E.b.Sorter.create([{key:"lastActiveTime",comparer:E.b.Sorter.Comparer.number,order:E.b.Sorter.Order.DES},{key:"isPinned",comparer:E.b.Sorter.Comparer.bool},{key:"isOwnerOrAdmin",comparer:E.b.Sorter.Comparer.bool},{key:"isMuted",comparer:E.b.Sorter.Comparer.bool,order:E.b.Sorter.Order.DES},{key:"lastActiveTimeInDays",comparer:E.b.Sorter.Comparer.number},{key:"totalMembers",comparer:E.b.Sorter.Comparer.number}])),this.currentCursorIndex=0-Number(this.listCheckpoints.length<=0),null===(e=this.getCurrentCursorValue())||void 0===e||e.metrics.start(),await this.storage.saveConvIds(n),await this.storage.removeOverflowInfo(),this.logger.zsymb(0,"VwWZkQ","init ledger success",n),-1!==this.currentCursorIndex&&(this.metrics.submitLedgerReport(this.listCheckpoints),E.c.Macrotask.push((()=>{this.dispatchEvent(new yW(null,this.getCurrentCursorValue()))})));return{isEvict:s,isHasNewConv:this.listCheckpoints.some((e=>e.isNew))}}async getRemainCheckpoints(){return-1===this.currentCursorIndex?[]:this.listCheckpoints.slice(this.currentCursorIndex)}async size(){return await this.storage.getRemainConv()}async clear(){await Promise.all([this.storage.saveConvIds([]),this.storage.removeOverflowInfo()]),this.listCheckpoints=[]}getCursor(){return{value:async()=>this.getCurrentCursorValue(),next:async()=>this.handleNextCursor()}}async remove(e){await this.storage.forceRemoveConvId(e);const t=this.listCheckpoints.find((t=>t.id===e));return!!t&&(t.disable(),!0)}getCurrentCursorValue(){var e;return null!==(e=this.listCheckpoints[this.currentCursorIndex])&&void 0!==e?e:null}async handleNextCursor(){const e=this.getCurrentCursorValue();if(e){const t=await e.isDone();t&&await this.storage.removeConvId(e.convId),e.metrics.stop(t),e.metrics.submit()}this.currentCursorIndex++,E.c.Macrotask.push((()=>{var t;null===(t=this.getCurrentCursorValue())||void 0===t||t.metrics.start(),this.dispatchEvent(new yW(e,this.getCurrentCursorValue()))}))}},Object(Ok.a)(pW.prototype,"init",[uW,hW,gW],Object.getOwnPropertyDescriptor(pW.prototype,"init"),pW.prototype),mW=pW))||mW)||mW)||mW)||mW)||mW)||mW)||mW)||mW)||mW),CW=function(e){return e.SUCCESS="success",e.FAILED="failed",e.FILLED_BY_SYNC="filled_by_sync",e}({}),EW=function(e){return e.NONE="none",e.CLOSE_APP="close_app",e}({}),OW=function(e){return e.NEW="new",e.RESUME="resume",e.RESUME_AND_NEW="resume_and_new",e}({}),MW=function(e){return e[e.AVG_EXECUTION_TIME_EACH_CONV=151050]="AVG_EXECUTION_TIME_EACH_CONV",e[e.AVG_BATCH=151051]="AVG_BATCH",e[e.AVG_BATCH_RETRY=151052]="AVG_BATCH_RETRY",e[e.AVG_CONV=151053]="AVG_CONV",e[e.AVG_NEW_CONV=151054]="AVG_NEW_CONV",e[e.ERROR_RUNNING=151055]="ERROR_RUNNING",e}({}),TW=function(e){return e.SYNC_MESSAGE="SYNC_MESSAGE",e}({}),RW=function(e){return e.PREPARE_BATCH="PREPARE_BATCH",e.FETCH_MESSAGE="FETCH_MESSAGE",e.PROCESS_MESSAGE="PROCESS_MESSAGE",e}({}),wW=function(e){return e[e.PREPARE_BATCH=0]="PREPARE_BATCH",e[e.FETCH_MESSAGE=1]="FETCH_MESSAGE",e[e.PROCESS_MESSAGE=2]="PROCESS_MESSAGE",e}({});class LW extends Eo.a{constructor(e,t){super("ErrorTaskAborted",-1,`Task [type,id]=[${e},${t}] is aborted`)}}let DW=function(e){return e.ABORT="ABORT",e.PAUSE="PAUSE",e.RESUME="RESUME",e.FULFILLED="FULFILLED",e}({});class AW extends hs.b{constructor(){super(),this.id=void 0,this.type=void 0,this.promiseContainer=void 0,this.abortee=void 0,this.status=void 0,this.isPaused=void 0,this.result=void 0,this.error=void 0,this.onAbort=()=>{this.error=new LW(this.type,this.id),this.resolvePromise(),this.dispatchEvent(new hs.a(DW.ABORT))},this.status="idle",this.isPaused=!1,this.abortee=new AbortController,this.promiseContainer=new E.c.Container}exec(e){return this.status="pending",this.abortee.signal.addEventListener("abort",this.onAbort,{once:!0}),E.c.catchPromise(e()).then((([e,t])=>{this.error=e,this.result=t,this.status="fulfilled",this.isPaused||this.resolvePromise()})),this}toPromise(){return this.promiseContainer.promise}pause(){this.isPaused=!0,this.dispatchEvent(new hs.a(DW.PAUSE))}resume(){this.isPaused=!1,this.dispatchEvent(new hs.a(DW.RESUME)),this.abortee.signal.aborted||"fulfilled"===this.status&&this.resolvePromise()}abort(){this.abortee.abort()}resolvePromise(){this.error?this.promiseContainer.reject(this.error):this.promiseContainer.resolve(this.result),this.dispatchEvent(new hs.a(DW.FULFILLED)),this.abortee.signal.removeEventListener("abort",this.onAbort),this.removeAllEventListener()}}class FW extends AW{constructor(){super(),this.id=void 0,this.type="prepare",this.id=++FW.counter}}FW.counter=0;class kW extends AW{constructor(){super(),this.id=void 0,this.type="fetch",this.id=++kW.counter}}kW.counter=0;class NW extends AW{constructor(){super(),this.id=void 0,this.type="process",this.id=++NW.counter}}NW.counter=0;class PW extends AW{constructor(){super(),this.id=void 0,this.type="sleep",this.id=++PW.counter}}PW.counter=0;const jW={isBackground:!1,pausedCounter:0,error:null,totalMessageFetched:0,totalMessageSaved:0,task:null,currentStep:RW.PREPARE_BATCH,convCheckpoint:null,batchRequestInfo:null,batchResponseInfo:null,retryCounter:0};var UW;let BW=Object(HV.d)()(UW=Object(yo.e)()(UW=Object(HV.e)(VV.i)(UW=function(e,t){return Object(yo.d)(VV.h)(e,void 0,0)}(UW=function(e,t){return Object(yo.d)(VV.b)(e,void 0,1)}(UW=function(e,t){return Object(yo.d)(VV.n)(e,void 0,2)}(UW=function(e,t){return Object(yo.d)(VV.o)(e,void 0,3)}(UW=function(e,t){return Object(yo.d)(VV.k)(e,void 0,4)}(UW=function(e,t){return a.ModuleContainer.inject(VV.d)(e,void 0,5)}(UW=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,6)}(UW=function(e,t){return Object(yo.d)(WV)(e,void 0,7)}(UW=function(e,t){return Object(yo.d)(VV.e)(e,void 0,8)}(UW=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,9)}(UW=Reflect.metadata("design:type",Function)(UW=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_ILedger?Object:AFMC_ILedger,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IService?Object:AFMC_IService,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IMetrics?Object:AFMC_IMetrics,"undefined"==typeof AFMC_IDevtoolMonitor?Object:AFMC_IDevtoolMonitor,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof ISocketPolling?Object:ISocketPolling,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(UW=class extends bm.a{constructor(e,t,s,a,i,n,r,o,c,l){super(),this.logger=void 0,this.config=void 0,this.ledger=void 0,this.service=void 0,this.storage=void 0,this.monitor=void 0,this.metrics=void 0,this.systemTime=void 0,this.socketPolling=void 0,this.eventCollector=void 0,this.currentSessionFetchInfo=void 0,this.pendingGetRemainConvIds=void 0,this.registerSessionFetchListener=()=>{this.logger.zsymb(0,"LM0xaB","register session fetch listener"),this.eventCollector.addEventListener(sH.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.addEventListener(sH.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.addEventListener(sH.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.unregisterSessionFetchListener=()=>{this.logger.zsymb(0,"HML1Eh","unregister session fetch listener"),this.eventCollector.removeEventListener(sH.a.LOAD_MESSAGE,this.onLoadMessage),this.eventCollector.removeEventListener(sH.a.APPLICATION_BACKGROUND,this.onApplicationBackground),this.eventCollector.removeEventListener(sH.a.APPLICATION_FOREGROUND,this.onApplicationForeground)},this.onEventChange=e=>{switch(e.type){case"START":this.onMachineStartFetch(),this.registerSessionFetchListener();break;case"STOP":this.unregisterSessionFetchListener(),this.onMachineStopFetch();break;case"NEXT_TO_SLEEP_TO_NEXT_HOUR":this.logger.zsymb(0,"-3uT2j","Busy hour, let sleep to next hour");break;case"TRY_MOVE_TO_NEXT_CONV":this.onFetchConvError(e.data.currConvId);break;case"PROCESS_MESSAGE_SUCCESS":this.storage.saveTotalMessageFetched(e.data.totalMessageFetched);break;case"FAILED":const t=this.interpreter.state.context,{batchRequestInfo:s,currentStep:a}=t,i=`${a}-${null==s?void 0:s.convId}-${null==s?void 0:s.requestMsgId}`;this.logger.zsymb(18,"P6mu94",`An error ocurred during fetch message ${i}`),this.logger.zsymb(18,"el6hN7",e.error),this.metrics.submitErrorRunning(a,e.error)}},this.onEventChangeForDevtool=async e=>{switch(e.type){case"PREPARE_BATCH_SUCCESS":this.monitor.updateBatchRequestInfo(e.data.batchRequestInfo),this.monitor.updateRemainConv(await this.ledger.size()),this.config.get("debugger.logger.batch_request_info")&&this.logger.zsymb(12,"farpdW","batch request info",e.data.batchRequestInfo);break;case"PROCESS_MESSAGE_SUCCESS":var t,s;if(this.monitor.updateTotalMessageFetched(e.data.totalMessageFetched),this.config.get("debugger.logger.save_message"))this.logger.zsymb(12,"4-6eej","save message result",null===(t=e.data.result)||void 0===t?void 0:t.batchInfo,null===(s=e.data.result)||void 0===s?void 0:s.messages.map((e=>e.msgId)));break;case"STOP":this.monitor.updateBatchRequestInfo(null),this.monitor.updateRemainConv(await this.ledger.size())}},this.onTransitionChangeForDevtool=e=>{const t=["idle","running","paused","locked"];for(const s of t)if(e.matches(s))return this.monitor.updateStatus(s)},this.onFetchConvError=async e=>{this.logger.zsymb(18,"5UZTE6","Save conv fetch failed",e),await this.storage.saveConvErrorId(e)},this.onMachineStartFetch=()=>{var e,t;this.metrics.submitStartFetchReport(null!==(e=null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.startType)&&void 0!==e?e:null)},this.onMachineStopFetch=async()=>{var e,t;await this.metrics.submitStopFetchReport((null===(e=this.currentSessionFetchInfo)||void 0===e?void 0:e.startType)||null,(null===(t=this.currentSessionFetchInfo)||void 0===t?void 0:t.interuptType)||null,await this.ledger.size()),this.currentSessionFetchInfo=null},this.onStartPullDataOffline=()=>{this.pauseMachine(),this.enablePendingGetRemainConv()},this.onStopPullDataOffline=async()=>{var e,t,s,a;let[i,n]=await E.c.catchPromise(this.ledger.size());null!==(e=n)&&void 0!==e||(n=0),n>0&&this.metrics.logResumeFetchAfterInterupt();const[r,o]=await E.c.catchPromise(this.ledger.init());if(null===(t=this.pendingGetRemainConvIds)||void 0===t||t.resolve(),this.pendingGetRemainConvIds=null,r)return this.logger.zsymb(18,"pRRNXW","An error occured during init ledger",r),this.stopMachine(),this.disablePendingGetRemainConv(),void(this.currentSessionFetchInfo=null);const{isHasNewConv:c,isEvict:l}=o;if(0===await this.ledger.size())return this.logger.zsymb(0,"zUjyAK","stop machine"),this.stopMachine(),this.disablePendingGetRemainConv(),void(this.currentSessionFetchInfo=null);c&&this.resetMachine(),this.currentSessionFetchInfo={startType:c&&n>0?OW.RESUME_AND_NEW:c&&0===n?OW.NEW:OW.RESUME},null!==(s=this.interpreter)&&void 0!==s&&null!==(a=s.state.history)&&void 0!==a&&a.matches("running")?(this.logger.zsymb(0,"Sjy_vZ","resume machine"),this.resumeMachine()):(this.logger.zsymb(0,"aaYCRy","start machine"),this.startMachine()),this.disablePendingGetRemainConv(),await this.storage.saveStartFetchInfo({evict:l,tsStart:this.systemTime.getTimeNow(),tsSufficient:await this.storage.getLastTsSufficientMessage()})},this.onStartTransferMessage=()=>{this.pauseMachine()},this.onStopTransferMessage=async e=>{const t=await this.ledger.size();t>0&&this.currentSessionFetchInfo&&e.isSuccess&&(this.currentSessionFetchInfo.interuptType=TW.SYNC_MESSAGE),e.isSuccess?(await this.ledger.clear(),this.stopMachine()):this.resumeMachine();t>0&&this.metrics.logStopInteruptFetch(TW.SYNC_MESSAGE,e.isSuccess)},this.onDeleteConv=async e=>{this.logger.zsymb(0,"ULVAAq",`Receive delete conversation ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLeaveGroup=async e=>{this.logger.zsymb(0,"tQgGho",`Receive leave group ${e.convId} event`),this.handleRemoveConv(e.convId)},this.onLoadMessage=e=>{if(!this.config.get("enable_fetch_foreground"))return;this.pauseMachine();const t=this.config.get("debugger.simulator.slow_load_message");e.promiseContainer.promise.then((()=>t?E.c.delay(5e3):void 0)).finally((()=>this.resumeMachine()))},this.onApplicationBackground=()=>{this.backgroundMachine()},this.onApplicationForeground=()=>{this.foregroundMachine()},this.autoStartMachine=()=>{var e,t;null!==(e=this.socketPolling.chatHandler)&&void 0!==e&&e.isDoneOffline&&null!==(t=this.interpreter)&&void 0!==t&&t.state.matches("idle")&&(this.logger.zsymb(0,"pdUl-a","Done offline detected, auto dispatch stop pull offline"),this.onStopPullDataOffline())},this.startMachine=()=>this.send({type:"START"}),this.resetMachine=()=>this.send({type:"RESET"}),this.stopMachine=()=>this.send({type:"STOP"}),this.pauseMachine=()=>this.send({type:"PAUSED"}),this.resumeMachine=()=>this.send({type:"RESUME"}),this.foregroundMachine=()=>this.send({type:"FOREGROUND"}),this.backgroundMachine=()=>this.send({type:"BACKGROUND"}),this.enablePendingGetRemainConv=()=>{var e;null!==(e=this.pendingGetRemainConvIds)&&void 0!==e||(this.pendingGetRemainConvIds=new E.c.Container)},this.disablePendingGetRemainConv=()=>{var e;null===(e=this.pendingGetRemainConvIds)||void 0===e||e.resolve(),this.pendingGetRemainConvIds=null},this.logger=l.createZLogger(w.ZLoggerNametags.autoFetchMsgCloud,[w.ZLoggerNametags.stateMachine]),this.ledger=e,this.config=t,this.service=s,this.storage=a,this.metrics=i,this.monitor=n,this.systemTime=r,this.socketPolling=o,this.eventCollector=c,this.pendingGetRemainConvIds=null,this.currentSessionFetchInfo=null}createMachine(){return e=this.ledger,t=this.service,Object(Pm.a)({id:"afmc-machine-v2",initial:"idle",context:jW,states:{idle:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},running:{id:"running",type:"compound",initial:"checking",states:{checking:{invoke:{src:s=>async a=>{var i;if(null===await e.getCursor().value())return void a({type:"STOP"});const[n,r]=t.checkBusyHour();if(n)a({type:"NEXT_TO_SLEEP_TO_NEXT_HOUR",data:{time:r}});else if("sleep"!==(null===(i=s.task)||void 0===i?void 0:i.type))if(s.isBackground||t.allowFetchForeground())switch(s.currentStep){case RW.PREPARE_BATCH:return void a({type:"NEXT_TO_PREPARE_BATCH"});case RW.FETCH_MESSAGE:return void a({type:"NEXT_TO_FETCH_MESSAGE"});case RW.PROCESS_MESSAGE:return void a({type:"NEXT_TO_PROCESS_MESSAGE"});default:return void a({type:"NEXT_TO_SLEEP"})}else a({type:"NEXT_TO_SLEEP"});else a({type:"NEXT_TO_SLEEP"})}},on:{NEXT_TO_PREPARE_BATCH:{target:"#running.prepareBatch"},NEXT_TO_FETCH_MESSAGE:{target:"#running.fetchMessage"},NEXT_TO_PROCESS_MESSAGE:{target:"#running.processMessage"},NEXT_TO_SLEEP:{target:"#running.sleep"},NEXT_TO_SLEEP_TO_NEXT_HOUR:{target:"#running.sleep"},STOP:{target:"#afmc-machine-v2.idle"}}},prepareBatch:{invoke:{src:s=>async a=>{var i;if("prepare"===(null===(i=s.task)||void 0===i?void 0:i.type))s.task.resume();else{const i=s.task=new FW,r=e.getCursor(),o=await r.value(),c=o.metrics.timeTracker.prepare.getTracker();try{c.start();const e=await i.exec((async()=>{const e=await o.getCursor().value();return null===e?(t.reloadMessageOfConv(o.convId),await r.next(),null):(o.metrics.increaseBatch(),{convCheckpoint:o,batchRequestInfo:e})})).toPromise(),{convCheckpoint:n=null,batchRequestInfo:l=null}=e||{};s.convCheckpoint=o,s.batchRequestInfo=l,n&&l?(s.currentStep=RW.FETCH_MESSAGE,a({type:"PREPARE_BATCH_SUCCESS",data:{batchRequestInfo:l,convCheckpoint:n}})):a({type:"MOVE_TO_NEXT_CONV"})}catch(n){if(n instanceof LW)return;a({type:"FAILED",error:n})}finally{c.end()}}}},on:{PREPARE_BATCH_SUCCESS:{target:"#running.checking",actions:"clearTask"},MOVE_TO_NEXT_CONV:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},fetchMessage:{invoke:{src:e=>async s=>{var a;if("fetch"===(null===(a=e.task)||void 0===a?void 0:a.type))e.task.resume();else{const a=e.task=new kW,{batchRequestInfo:n,convCheckpoint:r}=e,o=r.metrics.timeTracker.fetch.getTracker();try{o.start();const i=await a.exec((()=>t.fetchMessages(n))).toPromise();e.batchResponseInfo=i,e.currentStep=RW.PROCESS_MESSAGE,s({type:"FETCH_MESSAGE_SUCCESS",data:{batchResponseInfo:i}})}catch(i){if(i instanceof LW)return;s({type:"FAILED",error:i})}finally{o.end()}}}},on:{FETCH_MESSAGE_SUCCESS:{target:"#running.checking",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},processMessage:{invoke:{src:e=>async s=>{var a;if("process"===(null===(a=e.task)||void 0===a?void 0:a.type))e.task.resume();else{const a=e.task=new NW,{batchRequestInfo:r,batchResponseInfo:o,convCheckpoint:c}=e,l=c.metrics.timeTracker.sync.getTracker();try{var i;l.start();const n=o.groupMsgs,d=await a.exec((async()=>{const e=await t.processMessages(r,n);return await c.getCursor().next({messages:n,requestMsgId:r.requestMsgId,lastMsgId:r.lastMsgId,checkLoadTop:!0,hasMore:o.hasMore,minMsgIdFromServer:o.minMsgId,maxMsgIdFromServer:o.maxMsgId}),e})).toPromise();e.totalMessageFetched+=n.length,e.totalMessageSaved+=(null==d||null===(i=d.messages)||void 0===i?void 0:i.length)||0,e.error=null,e.retryCounter=0,e.currentStep=RW.PREPARE_BATCH,s({type:"PROCESS_MESSAGE_SUCCESS",data:{result:d,totalMessageFetched:n.length}})}catch(n){if(n instanceof LW)return;s({type:"FAILED",error:n})}finally{l.end()}}}},on:{PROCESS_MESSAGE_SUCCESS:{target:"#running.sleep",actions:"clearTask"},FAILED:{target:"#running.checkRetry",actions:["attachError","clearTask"]}}},sleep:{invoke:{src:(e,s)=>async a=>{var i;if("sleep"===(null===(i=e.task)||void 0===i?void 0:i.type))e.task.resume();else{const i=e.task=new PW;try{let n=0;switch(s.type){case"NEXT_TO_SLEEP_TO_NEXT_HOUR":case"RETRY":n=s.data.time;break;default:n=t.getThrottle(e.isBackground)}await i.exec((()=>E.c.delay(n))).toPromise(),a({type:"WAKE_UP"})}catch(n){}}}},on:{WAKE_UP:{target:"#running.checking",actions:"clearTask"}}},checkRetry:{invoke:{src:s=>async a=>{var i;const[n,r]=t.checkMaxRetryBatch(s.retryCounter,s.isBackground);if(n){var o;await e.getCursor().next();const t=(null===(o=s.batchRequestInfo)||void 0===o?void 0:o.convId)||"";return s.error=null,s.retryCounter=0,s.currentStep=RW.PREPARE_BATCH,a({type:"TRY_MOVE_TO_NEXT_CONV",data:{currConvId:t}})}return null===(i=s.convCheckpoint)||void 0===i||i.metrics.increaseRetry(),s.retryCounter++,a({type:"RETRY",data:{time:r}})}},on:{RETRY:{target:"#running.sleep"},TRY_MOVE_TO_NEXT_CONV:{target:"#running.sleep"}}}}},paused:{on:{RESUME:{target:"#afmc-machine-v2.resume",actions:["decreasePausedCounter","logPausedCounter"]}}},resume:{invoke:{src:e=>async t=>{e.pausedCounter?t({type:"RESUME_PAUSED"}):t({type:"RESUME_RUNNING"})}},on:{RESUME_PAUSED:{target:"#afmc-machine-v2.paused"},RESUME_RUNNING:{target:"#afmc-machine-v2.running"}}}},on:{PAUSED:{target:"#afmc-machine-v2.paused",actions:["increasePausedCounter","pauseTask","logPausedCounter"]},STOP:{target:"#afmc-machine-v2.idle",actions:["abortTask","resetAll"]},RESET:{actions:"reset"},START:{target:"#afmc-machine-v2.resume",actions:"decreasePausedCounter"},FOREGROUND:{actions:"foreground"},BACKGROUND:{actions:"background"}}},{actions:{attachError:Um.a.assign(((e,t)=>Object(I.a)(Object(I.a)({},e),{},{error:t.error}))),abortTask:e=>{var t;return null!==(t=e.task)&&void 0!==t&&t.abort(),e.task=null},pauseTask:e=>{var t;return null===(t=e.task)||void 0===t?void 0:t.pause()},clearTask:Um.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{task:null}))),increasePausedCounter:Um.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{pausedCounter:e.pausedCounter+1}))),decreasePausedCounter:Um.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{pausedCounter:Math.max(e.pausedCounter-1,0)}))),logPausedCounter:e=>{XV.a},foreground:Um.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{isBackground:!1}))),background:Um.a.assign((e=>Object(I.a)(Object(I.a)({},e),{},{isBackground:!0}))),reset:Um.a.assign((({isBackground:e,pausedCounter:t})=>Object(I.a)(Object(I.a)({},jW),{},{isBackground:e,pausedCounter:t}))),resetAll:Um.a.assign((()=>Object(I.a)({},jW)))}});var e,t}start(){super.start(),this.registerListener(),this.autoStartMachine()}stop(){this.unregisterListener(),this.unregisterSessionFetchListener(),super.stop(),this.monitor.updateStatus("disabled")}hasRemainConvInPrevSession(){return null!==this.currentSessionFetchInfo&&this.currentSessionFetchInfo.startType!==OW.NEW}async getRemainConvIds(){var e,t;const s=null===(e=this.interpreter)||void 0===e?void 0:e.state;if(!s)return[];var a;!1===("idle"===s.value&&"STOP"===s.event.type)&&(null!==(a=this.pendingGetRemainConvIds)&&void 0!==a||(this.pendingGetRemainConvIds=new E.c.Container));await(null===(t=this.pendingGetRemainConvIds)||void 0===t?void 0:t.promise);return(await this.ledger.getRemainCheckpoints()).map((e=>e.convId))}registerListener(){var e,t,s;(this.logger.zsymb(0,"Gk9XHP","register persit listener"),this.eventCollector.addEventListener(sH.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.addEventListener(sH.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.addEventListener(sH.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.addEventListener(sH.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.addEventListener(sH.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.addEventListener(sH.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.onEvent(this.onEventChange),XV.a)&&(null===(t=this.interpreter)||void 0===t||t.onEvent(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.onTransition(this.onTransitionChangeForDevtool))}unregisterListener(){var e,t,s;(this.logger.zsymb(0,"DUab3j","unregister persit listener"),this.eventCollector.removeEventListener(sH.a.START_PULL_OFFLINE_DATA,this.onStartPullDataOffline),this.eventCollector.removeEventListener(sH.a.STOP_PULL_OFFLINE_DATA,this.onStopPullDataOffline),this.eventCollector.removeEventListener(sH.a.DELETE_CONV,this.onDeleteConv),this.eventCollector.removeEventListener(sH.a.LEAVE_GROUP,this.onLeaveGroup),this.eventCollector.removeEventListener(sH.a.START_TRANSFER_MESSAGE,this.onStartTransferMessage),this.eventCollector.removeEventListener(sH.a.STOP_TRANSFER_MESSAGE,this.onStopTransferMessage),null===(e=this.interpreter)||void 0===e||e.off(this.onEventChange),XV.a)&&(null===(t=this.interpreter)||void 0===t||t.off(this.onEventChangeForDevtool),null===(s=this.interpreter)||void 0===s||s.off(this.onTransitionChangeForDevtool))}async handleRemoveConv(e){this.pauseMachine(),await this.ledger.remove(e)?(this.logger.zsymb(0,"aLmKD2",`Disabled checkpoint ${e} success`),this.resetMachine()):this.logger.zsymb(0,"KSYLRv",`Checkpoint ${e} does not exist`),this.resumeMachine()}})||UW)||UW)||UW)||UW)||UW)||UW)||UW)||UW)||UW)||UW)||UW)||UW)||UW)||UW)||UW;var zW,GW=s("BYQe");let xW=Object(yo.e)()(zW=Object(HV.d)()(zW=Object(HV.e)(VV.j)(zW=function(e,t){return Object(yo.d)(VV.f)(e,void 0,0)}(zW=function(e,t){return Object(yo.d)(VV.p)(e,void 0,1)}(zW=function(e,t){return Object(yo.d)(VV.g)(e,void 0,2)}(zW=Reflect.metadata("design:type",Function)(zW=Reflect.metadata("design:paramtypes",["undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler,"undefined"==typeof IHandler?Object:IHandler])(zW=class{constructor(e,t,s){this.processor=void 0,this.processor=(new GW.Chain).pipe(e).pipe(t).pipe(s)}async process(e,t){return await this.processor.process({batchInfo:e,messages:t})}})||zW)||zW)||zW)||zW)||zW)||zW)||zW)||zW;var VW;let HW=Object(HV.d)()(VW=Object(yo.e)()(VW=Object(HV.e)(VV.k)(VW=function(e,t){return a.ModuleContainer.inject(zs.b)(e,void 0,0)}(VW=function(e,t){return Object(yo.d)($V)(e,void 0,1)}(VW=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,2)}(VW=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,3)}(VW=function(e,t){return Object(yo.d)(VV.o)(e,void 0,4)}(VW=function(e,t){return Object(yo.d)(VV.b)(e,void 0,5)}(VW=Reflect.metadata("design:type",Function)(VW=Reflect.metadata("design:paramtypes",["undefined"==typeof IQosService?Object:IQosService,"undefined"==typeof IActionlogService?Object:IActionlogService,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(VW=class{constructor(e,t,s,a,i,n){this.logger=void 0,this.qos=void 0,this.config=void 0,this.storage=void 0,this.actionlog=void 0,this.systemTime=void 0,this.qos=e,this.config=n,this.storage=i,this.actionlog=t,this.systemTime=a,this.logger=s.createZLogger(w.ZLoggerNametags.autoFetchMsgCloud,[w.ZLoggerNametags.metricz])}logAutoHideBannerSuggestion(){this.actionlog.logAction(2460001)}logAutoShowBannerSuggestion(e){this.actionlog.logAction(e?2460003:2460002)}logStartFetch(e,t){switch(this.actionlog.logAction(2460101),t){case nH.ONLY_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460102);break;case nH.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460104):this.actionlog.logAction(2460103)}}logStopFetch(e,t,s){if(!s)return this.actionlog.logAction(2460401);switch(this.actionlog.logAction(2460201),t){case nH.ONLY_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460202);break;case nH.BOTH_1_1_AND_GROUP:e?this.actionlog.logAction(2460204):this.actionlog.logAction(2460203)}}logStopInteruptFetch(e,t){if(e===TW.SYNC_MESSAGE)this.actionlog.logAction(t?2460302:2460303)}logResumeFetchAfterInterupt(){this.actionlog.logAction(2460304)}async submitStartFetchReport(e){if(null===e)return;const t={type:e,total_days_to_fetch:E.j.countDays(await this.storage.getLastTsSufficientMessage(),this.systemTime.getTimeNow()),days_to_fetch_from_new_evict:-1};this.logger.zsymb(12,"TUyFvx","submit start fetch report",JSON.stringify(t)),this.actionlog.logActionInfoV2(Ia.FeaturesInfo.AutoFetchMessageCloud,2,t)}async submitStopFetchReport(e,t,s){var a,i,n,r;if(null===e)return;const o=await this.storage.getFetchInfo();if(null==o||!o.onProgressInfo)return;const c=this.systemTime.getTimeNow(),l=o.onProgressInfo.totalMsgFetched||0,d={result:t===TW.SYNC_MESSAGE?CW.FILLED_BY_SYNC:s>0?CW.FAILED:CW.SUCCESS,interupted:(()=>{switch(e){case OW.RESUME:case OW.RESUME_AND_NEW:return EW.CLOSE_APP;case OW.NEW:default:return EW.NONE}})(),filled_queue_evict:(()=>{var e;return E.j.countDays(o.onProgressInfo.tsSufficient,c)>this.config.get("max_time_check_insufficient_data")||null!==(e=o.onProgressInfo)&&void 0!==e&&e.evict?0:1})(),estimated_fetching_time:(()=>Math.ceil(l/this.config.get("batch_size"))*this.config.get("throttle")/1e3)(),total_day_with_session_fetch:E.j.countUniqDays(...null!==(a=null==o||null===(i=o.onProgressInfo)||void 0===i?void 0:i.listTsStart)&&void 0!==a?a:[]),days_from_start_to_complete:(()=>{var e,t;const s=Math.min(...null!==(e=null===(t=o.onProgressInfo)||void 0===t?void 0:t.listTsStart)&&void 0!==e?e:[-1]);return s<0?-1:E.j.countDays(s,c)})(),total_conv_fetched:(null===(n=o.onProgressInfo.convIds)||void 0===n?void 0:n.length)||0,conv_fetch_failed:(null===(r=o.onProgressInfo.convErrorIds)||void 0===r?void 0:r.length)||0,total_msg_fetched:l};this.logger.zsymb(12,"0Xacao","submit stop fetch report",JSON.stringify(d)),this.actionlog.logActionInfoV2(Ia.FeaturesInfo.AutoFetchMessageCloud,1,d),await this.storage.removeStartFetchInfo()}submitConvReport(e){XV.a&&this.logger.zsymb(12,"rnORWm","submit metrics for conv",e.convId,JSON.stringify(e)),this.qos.log({commandId:MW.AVG_EXECUTION_TIME_EACH_CONV,success:!0,startTime:0,duration:e.duration.total,params:[JSON.stringify(e)]}),this.qos.log({commandId:MW.AVG_BATCH,success:!0,startTime:0,duration:e.meta.total}),this.qos.log({commandId:MW.AVG_BATCH_RETRY,success:!0,startTime:0,duration:e.meta.retry})}submitLedgerReport(e){const t=e.length,s=e.filter((e=>e.isNew)).length;XV.a&&this.logger.zsymb(12,"V7q1Mv","submit ledger report",JSON.stringify({totalConv:t,totalNewConv:s})),this.qos.log({commandId:MW.AVG_CONV,success:!0,startTime:0,duration:t}),this.qos.log({commandId:MW.AVG_NEW_CONV,success:!0,startTime:0,duration:s})}submitErrorRunning(e,t){this.qos.log({commandId:MW.ERROR_RUNNING,success:!1,startTime:0,errorCode:wW[e],params:[e,t.name,...t.qosParams]})}})||VW)||VW)||VW)||VW)||VW)||VW)||VW)||VW)||VW)||VW)||VW;var WW;let qW=Object(HV.d)()(WW=Object(HV.e)(VV.f)(WW=class{async process(e){const{batchInfo:t,messages:s}=e,a=s.filter((e=>parseInt(e.msgId)>parseInt(t.lastDeleteMsgId)));return{batchInfo:t,messages:a}}})||WW)||WW;var KW;let ZW=Object(yo.e)()(KW=Object(HV.d)()(KW=Object(HV.e)(VV.g)(KW=function(e,t){return Object(yo.d)(ZV)(e,void 0,0)}(KW=Reflect.metadata("design:type",Function)(KW=Reflect.metadata("design:paramtypes",["undefined"==typeof IZSearchV3?Object:IZSearchV3])(KW=class{constructor(e){this.zsearchV3=e}async process(e){return this.zsearchV3.executeData(this.filterMessageSearchable(e.messages)),e}filterMessageSearchable(e){return e.filter((e=>{var t;return"chat.delete"!==e.msgType&&"chat.undo"!==e.msgType&&"chat.list.action"!==e.msgType&&"msginfo.actionlist"!==(null===(t=e.content)||void 0===t?void 0:t.action)}))}})||KW)||KW)||KW)||KW)||KW)||KW;var $W;let QW=Object(yo.e)()($W=Object(HV.d)()($W=Object(HV.e)(VV.p)($W=function(e,t){return Object(yo.d)(KV)(e,void 0,0)}($W=function(e,t){return Object(yo.d)(QV)(e,void 0,1)}($W=Reflect.metadata("design:type",Function)($W=Reflect.metadata("design:paramtypes",["undefined"==typeof IZStorage?Object:IZStorage,"undefined"==typeof IImportantMsgManager?Object:IImportantMsgManager])($W=class{constructor(e,t){this.zstorage=e,this.importantMsgManager=t}async process(e){var t;const{batchInfo:s,messages:a}=e,[i,n]=await E.c.catchPromise(this.zstorage.addMessages(s.convId,a,void 0));Io(i,new RH("Save messages error "+JSON.stringify(i))),this.importantMsgManager.receiveImportantMessage((null==n?void 0:n.messages)||[]);const r=(null!==(t=null==n?void 0:n.messages)&&void 0!==t?t:[]).map((e=>e.msgId));return{batchInfo:s,messages:a.filter((e=>r.includes(e.msgId)))}}})||$W)||$W)||$W)||$W)||$W)||$W)||$W;var YW;let JW=Object(yo.e)()(YW=Object(HV.d)()(YW=Object(HV.e)(VV.m)(YW=function(e,t){return a.ModuleContainer.inject(Uo)(e,void 0,0)}(YW=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,1)}(YW=function(e,t){return Object(yo.d)(VV.b)(e,void 0,2)}(YW=Reflect.metadata("design:type",Function)(YW=Reflect.metadata("design:paramtypes",["undefined"==typeof ICloudSegmentController?Object:ICloudSegmentController,"undefined"==typeof ISystemTime?Object:ISystemTime,"undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig])(YW=class{constructor(e,t,s){this.segmentController=e,this.systemTime=t,this.config=s,this.mapTsSplitSegmentRange={},this.tsEvictQueue=void 0,this.tsEvictQueue=this.systemTime.getTimeNow()}process(e){const[t,s]=e;return!s&&this.config.get("enable_segment_updater")&&E.c.Macrotask.push((()=>this.updateSegment(t))),e}getGroupMessages(e){return e.deliverProcessData.groupMsgs}hasEvict(e){var t,s;const a=null!==(t=null==e||null===(s=e.deliverProcessData)||void 0===s?void 0:s.queueStatus)&&void 0!==t?t:{};for(const n of this.config.get("group_queue_config")){var i;if(null!==(i=a[n])&&void 0!==i&&i.evict)return!0}return!1}classifyMessagesByConv(e){const t={};for(const a of e){var s;const e=a.isGroup?a.msgKey:a.idTo;(t[e]=null!==(s=t[e])&&void 0!==s?s:[]).push(a)}return t}async updateSegment(e){const t=this.getGroupMessages(e);if(0===t.length)return;this.hasEvict(e)&&(this.tsEvictQueue=this.systemTime.getTimeNow());const s=this.classifyMessagesByConv(t),a=[];for(const i in s){const e=s[i],t=this.getRange(e);a.push(this.update(i,t,this.getModeMerged(i)))}await Promise.all(a)}getModeMerged(e){var t;let s="merge";return(null!==(t=this.mapTsSplitSegmentRange[e])&&void 0!==t?t:0)<this.tsEvictQueue&&(s="split",this.mapTsSplitSegmentRange[e]=this.systemTime.getTimeNow()),s}getRange(e){e.sort(E.b.Sorter.create([{key:"msgId",comparer:E.b.Sorter.Comparer.number,order:E.b.Sorter.Order.ASC},{key:"ts",comparer:E.b.Sorter.Comparer.number,order:E.b.Sorter.Order.ASC}]));const t=e.filter((e=>!isNaN(Number(e.msgId)))),s=t[0],a=t[t.length-1];return[Number(s.msgId),Number(a.msgId)]}async update(e,t,s){const a=await this.segmentController.get(e),i=0===(null!==(n=a.cloudSegmentCheckAutoFetch)&&void 0!==n?n:[]).length?(s="split",null!==(o=a.cloudSegmentCheck)&&void 0!==o?o:[]):null!==(r=a.cloudSegmentCheckAutoFetch)&&void 0!==r?r:[];var n,r,o;const c=this.mergeSegment(t,i);switch(s){case"split":a.cloudSegmentCheckAutoFetch=c;break;case"merge":a.cloudSegmentCheckAutoFetch=this.connectRange(t,c)}await this.segmentController.update(a)}connectRange(e,t){const s=[];for(let a=0;a<t.length;a++){const i=t[a],n=t[a-1];if(rC.a.isEqual(e,i)&&n){const e=n[0],t=i[1];s.pop(),s.push([e,t])}else s.push(i)}return s}mergeSegment(e,t){if(!e||2!==e.length||e[0]>e[1])return t;if(0==t.length)return[e];const s=[],[a,i]=e;let n=0,r=0;for(let o=0;o<t.length;o++){const e=t[o],c=e[0],l=e[1]===parseInt(Y.MessageConstants.MAX_MSG_ID)?e[0]+1:e[1];if(r){s.push(...t.slice(o));break}a>l?(s.push([c,l]),o===t.length-1&&s.push([a,i])):(0===n&&(n=a<c?a:c),i<c?(r=i,s.push([n,r]),s.push([c,l])):i<=l&&i>=c?(r=l,s.push([n,l])):i>l&&o===t.length-1&&s.push([n,i]))}return s}})||YW)||YW)||YW)||YW)||YW)||YW)||YW)||YW;var XW;let eq=Object(HV.d)()(XW=Object(yo.e)()(XW=Object(HV.e)(VV.q)(XW=function(e,t){return Object(yo.d)(VV.b)(e,void 0,0)}(XW=function(e,t){return Object(yo.d)(VV.o)(e,void 0,1)}(XW=function(e,t){return Object(yo.d)(VV.e)(e,void 0,2)}(XW=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,3)}(XW=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,4)}(XW=Reflect.metadata("design:type",Function)(XW=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(XW=class{constructor(e,t,s,a,i){this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.prevNetworkState=void 0,this.intervalUpdate=void 0,this.onApplicationExit=()=>{this.updateLastSufficientTs(),this.clearIntervalUpdate()},this.onStartPullOffline=()=>{this.clearIntervalUpdate()},this.onStopPullOffline=()=>{this.updateLastSufficientTs(),this.startIntervalUpdate()},this.logger=i.createZLogger(w.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=a,this.prevNetworkState=null,this.intervalUpdate=null,this.registerListener(s)}registerListener(e){e.addEventListener(sH.a.START_PULL_OFFLINE_DATA,this.onStartPullOffline),e.addEventListener(sH.a.STOP_PULL_OFFLINE_DATA,this.onStopPullOffline),e.addEventListener(sH.a.APPLICATION_EXIT,this.onApplicationExit)}async updateLastSufficientTs(){const e=await this.getLastTsSufficientMessage(),t=this.systemTime.getTimeNow(),s=await this.storage.getLastTsOverflowMessage()>e?e:t;await this.storage.saveLastSufficientMessage(s),this.config.get("debugger.logger.interval_update_sufficient_ts")&&this.logger.zsymb(12,"Rs8jom","Update last sufficient ts",s)}async getLastTsSufficientMessage(){const e=await Promise.all([this.storage.getLastTsSyncMessageSuccess(),this.storage.getLastTsImportMessageSuccess(),this.storage.getLastTsAutoFetchMessageSuccess(),this.storage.getLastTsCloseTransferSuggestion(),this.storage.getLastTsCloseFirstLoginTransferSuggestion(),this.storage.getLastTsSufficientMessage()]);return Math.max(...e)}startIntervalUpdate(){this.clearIntervalUpdate(),this.intervalUpdate=setInterval((()=>{this.updateLastSufficientTs()}),this.config.get("interval_check_insufficient_data"))}clearIntervalUpdate(){this.intervalUpdate&&clearInterval(this.intervalUpdate),this.intervalUpdate=null}})||XW)||XW)||XW)||XW)||XW)||XW)||XW)||XW)||XW)||XW;var tq;let sq=Object(HV.d)()(tq=Object(yo.e)()(tq=Object(HV.e)(VV.r)(tq=function(e,t){return Object(yo.d)(VV.b)(e,void 0,0)}(tq=function(e,t){return Object(yo.d)(VV.o)(e,void 0,1)}(tq=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,2)}(tq=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,3)}(tq=function(e,t){return Object(yo.d)(VV.e)(e,void 0,4)}(tq=Reflect.metadata("design:type",Function)(tq=Reflect.metadata("design:paramtypes",["undefined"==typeof AFMC_IConfig?Object:AFMC_IConfig,"undefined"==typeof AFMC_IStorage?Object:AFMC_IStorage,"undefined"==typeof ISystemTime?Object:ISystemTime,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof AFMC_IEventCollector?Object:AFMC_IEventCollector])(tq=class{constructor(e,t,s,a,i){this.overflowQueueIds=void 0,this.logger=void 0,this.config=void 0,this.storage=void 0,this.systemTime=void 0,this.logger=a.createZLogger(w.ZLoggerNametags.autoFetchMsgCloud,[]),this.config=e,this.storage=t,this.systemTime=s,this.overflowQueueIds=[],i.addEventListener(sH.a.OVERFLOW_MESSAGE_QUEUE,(e=>{const t=e.queueId.toString();this.overflowQueueIds.push(t),this.storage.saveLastOverflow(t,this.systemTime.getTimeNow())}))}process(e,t){if(e&&this.config.get("enable_tracking_overflow"))for(const a in e)if(this.config.get("group_queue_config").includes(a)){if(e[a].evict){var s;const e="-1",i=String((null===(s=t[a])||void 0===s?void 0:s.lastId)||1);this.saveOverflowInfo(a,e,i)}}}getOverflowStatus(){const e=!!this.overflowQueueIds.find((e=>this.config.get("group_queue_config").includes(e))),t=!!this.overflowQueueIds.find((e=>this.config.get("one_one_queue_config").includes(e)));return t||e?t&&e?nH.BOTH_1_1_AND_GROUP:t?nH.ONLY_1_1:nH.ONLY_GROUP:nH.NONE}async saveOverflowInfo(e,t,s){const a=await this.storage.getOverflowInfo();(null==a?void 0:a.queueId)!==e&&(await this.storage.saveOverflowInfo(e,t,s),this.logger.zsymb(0,"IMWySL","Overflow detected, let save info",{queueId:e,lastMsgId:t,lastActionId:s}))}})||tq)||tq)||tq)||tq)||tq)||tq)||tq)||tq)||tq)||tq;var aq,iq=s("h5Sw");Object(a.singleton)(VV.l)(aq=Object(m.j)()(aq=Object(m.g)()(aq=Object(HV.c)([tH,HW,JH,bH,SW,hH,tW,JW,QW,xW,BW,ZW,yH,qW,sq,eq,{token:KV,useFactory:()=>Re.default},{token:qV,useFactory:()=>_e.default},{token:ZV,useFactory:()=>Dc.a.getInstance()},{token:WV,useFactory:()=>Tu.default},{token:$V,useFactory:()=>Ia.default},{token:QV,useFactory:()=>iq.a},{token:YV,useFactory:()=>a.ModuleContainer.resolveIfExist(vm.a)}])(aq=class{onAuthenticating(){this.get(VV.b)}onStart(){this.get(VV.c).start()}get(e){return HV.a.resolve(e)}})||aq)||aq)||aq);var nq;const rq="z_afmc_devtool_";Object(xi.b)(VV.d)(nq=function(e,t){return Object(a.inject)(go)(e,void 0,0)}(nq=Reflect.metadata("design:type",Function)(nq=Reflect.metadata("design:paramtypes",["undefined"==typeof IMessageController?Object:IMessageController])(nq=class{constructor(e){var t;this.messageController=e,this.type=void 0,this.name=void 0,this.key=void 0,this.data={isShow:!0,status:"disabled",totalMessage:0,totalMessageFetched:0,remainConv:0,currentConv:"",currentRequestMsgId:"",totalMessageCurrentConv:0},this.promiseCountTotalMessage=null,this.promiseCountTotalMessageCurrConv=null,this.name="auto-fetch-message-cloud-devtool-monitor",this.key="auto-fetch-message-cloud-devtool-monitor",this.data.isShow=XV.a&&Boolean(Number(null!==(t=n.default.getInstance().getItem(rq))&&void 0!==t?t:"0")),this.toggleUpdateTotalMessage()}toggleDevtool(){!1!==XV.a&&(this.data.isShow=!this.data.isShow,this.data.isShow?n.default.getInstance().setItem(rq,Number(this.data.isShow).toString()):n.default.getInstance().removeItem(rq),Object(nc.h)(this.name,"all"))}updateStatus(e){!1!==XV.a&&(this.data.status=e,Object(nc.h)(this.name,"all"))}async toggleUpdateTotalMessage(){XV.a}async toggleUpdateTotalMessageCurrentConv(){if(!1===XV.a)return;this.promiseCountTotalMessageCurrConv||(this.promiseCountTotalMessageCurrConv=this.messageController.countMessages(this.data.currentConv));const e=await this.promiseCountTotalMessageCurrConv;this.promiseCountTotalMessageCurrConv=null,this.data.totalMessageCurrentConv=e,Object(nc.h)(this.name,"all")}updateTotalMessageFetched(e){!1!==XV.a&&(this.data.totalMessageFetched+=e,Object(nc.h)(this.name,"all"),this.toggleUpdateTotalMessage(),this.toggleUpdateTotalMessageCurrentConv())}updateRemainConv(e){!1!==XV.a&&(this.data.remainConv=e,Object(nc.h)(this.name,"all"))}updateBatchRequestInfo(e){!1!==XV.a&&(this.data.currentConv=(null==e?void 0:e.convId)||"",this.data.currentRequestMsgId=(null==e?void 0:e.requestMsgId)||"",e||(this.data.totalMessageCurrentConv=0),Object(nc.h)(this.name,"all"))}getItem(e,t){return Object(I.a)({},this.data)}init(e){throw new Error("Method not implemented.")}getList(e,t){throw new Error("Method not implemented.")}onGetItemFailure(e,t){throw new Error("Method not implemented.")}onGetListFailure(e,t){throw new Error("Method not implemented.")}})||nq)||nq)||nq);var oq,cq=s("n43+");class lq extends hs.a{constructor(){super(cq.a.OVERFLOW_QUEUE)}}class dq extends hs.a{constructor(){super(cq.a.NO_OVERFLOW_QUEUE)}}class uq extends hs.a{constructor(){super(cq.a.E2EE_CHANGE_DEVICE)}}class hq extends hs.a{constructor(){super(cq.a.NO_E2EE_CHANGE_DEVICE)}}class gq extends hs.a{constructor(){super(cq.a.USER_OFFLINE)}}class mq extends hs.a{constructor(){super(cq.a.SOCKET_DONE_PULL_OFFLINE)}}class pq extends hs.a{constructor(e){super(cq.a.DB_CORRUPTION),this.payload=e}}Object(m.f)()(oq=Object(a.injectable)()(oq=Object(xi.b)(Fm.b)(oq=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(oq=Reflect.metadata("design:type",Function)(oq=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory])(oq=class extends hs.b{constructor(e){super(),this.logger=void 0,this.handleDbCorruption=e=>{try{this.dispatchEvent(new pq(e))}catch(CY){this.logger.zsymb(21,"s0VBdt",["Cannot dispatch db corruption {}","pshfEP"],CY)}},this.handleEventBus=e=>{try{e===ve.GeneralActions.SOCKET_DONE_PULL_OFFLINE&&(this.dispatchEvent(new mq),_e.default.unsubscribe(this.handleEventBus))}catch(CY){this.logger.zsymb(21,"Jo39KQ",["Cannot dispatch SocketDonePullOfflineEvent: {}","Bc4KFI"],CY)}},this.onNoE2EEChangeDevice=()=>{try{this.dispatchEvent(new hq),a.ModuleContainer.resolve(ym.b).removeEventListener($m.a.NoE2eeConvChangeDevice,this.onNoE2EEChangeDevice)}catch(CY){this.logger.zsymb(21,"bHczET",["Cannot dispatch NoE2EEChangeDevice: {}","iQdQPk"],CY)}},this.onUserOffline=()=>{this.dispatchEvent(new gq)},this.onDoneCheckOverflow=e=>{try{if(e.length>0)return void this.dispatchEvent(new lq);this.dispatchEvent(new dq),My.default.getChatHandler().unsubcribe(Ru.b.DONE_CHECK_OVERFLOW,this.onDoneCheckOverflow)}catch(CY){this.logger.zsymb(21,"cxl0Dg",["Cannot dispatch OverflowQueueEvent: {}","FZGysy"],CY)}},this.onE2EEChangeDevice=()=>{try{this.dispatchEvent(new uq),a.ModuleContainer.resolve(ym.b).removeEventListener($m.a.HasE2eeConvChangeDevice,this.onE2EEChangeDevice)}catch(CY){this.logger.zsymb(21,"Kfa0F2",["Cannot dispatch E2EEChangeDeviceEvent: {}","EC0RdH"],CY)}},this.logger=e.createZLogger(w.ZLoggerNametags.msgSync,[w.ZLoggerNametags.messageReadinessChecker,w.ZLoggerNametags.eventCollectorMessageReadiness])}onAuthenticated(){this.registerListener()}registerListener(){_e.default.subscribe(this.handleEventBus),a.ModuleContainer.resolve(Ya).addEventListener(zv.USER_OFFLINE,this.onUserOffline),a.ModuleContainer.resolve(ym.b).addEventListener($m.a.HasE2eeConvChangeDevice,this.onE2EEChangeDevice),a.ModuleContainer.resolve(ym.b).addEventListener($m.a.NoE2eeConvChangeDevice,this.onNoE2EEChangeDevice),a.ModuleContainer.resolve(Us.TDBCorruptionDetector).addEventListener(Bs.a.DB_CORRUPTION_DETECTED,this.handleDbCorruption),My.default.getChatHandler().subcribe(Ru.b.DONE_CHECK_OVERFLOW,this.onDoneCheckOverflow)}})||oq)||oq)||oq)||oq)||oq);class fq extends hs.a{constructor(){super(Xm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED)}}function vq(e){const t=new Date(e),s=t.getDay(),a=0===s?6:s-1;return t.setDate(t.getDate()-a),t.setHours(0,0,0,0),t.getTime().toString()}let _q=function(e){return e.CHANGE_DEVICE="CHANGE_DEVICE",e.NO_CHANGE_DEVICE="NO_CHANGE_DEVICE",e.NOT_UPDATED_YET="NOT_UPDATED_YET",e}({}),bq=function(e){return e.OVERFLOW_QUEUE="OVERFLOW_QUEUE",e.NO_OVERFLOW_QUEUE="NO_OVERFLOW_QUEUE",e.NOT_UPDATED_YET="NOT_UPDATED_YET",e}({});let Iq=null;const yq=1,Sq=2,Cq=4,Eq=8,Oq=16,Mq=32,Tq=64;var Rq,wq=s("JTyQ"),Lq=s("NTiX");class Dq{static getInstance(){return null===this.instance&&(this.instance=new Dq),this.instance}constructor(){this.storage=void 0,this.firstLoginChecker=void 0,this.getLastDbCorruptionTimestamp=(e=Oq|Mq|Tq)=>{try{return function(){try{let e=a.ModuleContainer.resolve(Lq.b).getObject(wq.a);if(!e)return!0;if("string"==typeof e)try{e=JSON.parse(e)}catch(CY){return!0}return!e||e[J.p.getSessionUserId()]===O.a.SQLite}catch(e){return!0}}()?Math.max(e&Mq?this.storage.dbCorruptionInfo.getLastSqliteDBCorruptionFullTimestamp():0,e&Tq?this.storage.dbCorruptionInfo.getLastSqliteMessageDBCorruptionTimestamp():0):e&Oq?this.storage.dbCorruptionInfo.getLastIndexedDBCorruptionTimestamp():0}catch(t){return 0}},this.isMessageReadyWithIncludeFlags=e=>{const t=this.getLastMissingMessageEventsTimestamp(e),s=a.ModuleContainer.resolve(Sm.a).value().lastSync;return 0!=s&&s>t},this.getLastMissingMessageEventsTimestamp=e=>{const t=e&Eq?this.firstLoginChecker.getFirstLoginTime(J.p.getSessionUserId()):0,s=e&Cq?this.storage.changeDeviceLog.changeDeviceTimestamp:0,a=e&Sq?this.storage.overflowQueueLog.lastMessageTimestamp:0,i=e&yq?this.storage.overflowQueueLog.getOverflowQueueTimestamp():0,n=this.getLastDbCorruptionTimestamp(e);return Math.max(0,i,s,t,a,n)},this.storage=(Iq||(Iq=a.ModuleContainer.resolve(Fm.c)),Iq),this.firstLoginChecker=a.ModuleContainer.resolve(Uv.a)}}Dq.instance=null;const Aq=Object(a.define)("message-readiness-metrics");let Fq=Object(a.injectable)()(Rq=function(e,t){return a.ModuleContainer.inject(St.b)(e,void 0,0)}(Rq=function(e,t){return a.ModuleContainer.inject(es.ZLoggerFactory)(e,void 0,1)}(Rq=function(e,t){return a.ModuleContainer.inject(Uv.a)(e,void 0,2)}(Rq=Reflect.metadata("design:type",Function)(Rq=Reflect.metadata("design:paramtypes",[void 0===St.ISystemTime?Object:St.ISystemTime,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===Uv.IFirstLoginChecker?Object:Uv.IFirstLoginChecker])(Rq=class{constructor(e,t,s){this.systemTime=void 0,this.logger=void 0,this.firstLoginChecker=void 0,this.systemTime=e,this.firstLoginChecker=s,this.logger=t.createZLogger(w.ZLoggerNametags.messageReadinessChecker,[w.ZLoggerNametags.metricz])}async updateOnlineHistory(e){const t=vq(this.getTimeNow());let s=this.storage.loginHistory.getHistory(e);s.includes(t)||(s.push(t),s=s.slice(-3),await this.storage.loginHistory.saveHistory(e,s))}logLastTimeUserOffline(){return this.storage.loginHistory.setLastOfflineTimestamp(this.getTimeNow())}async logChangeDevice(){this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin=_q.CHANGE_DEVICE,await this.storage.changeDeviceLog.setChangeDeviceTimestamp(this.getTimeNow()),this.storage.changeDeviceLog.setE2EESessionChangedTimestamp(this.getTimeNow()),await this.updateOnlineHistory(Xm.b.CHANGE_DEVICE)}async logNoChangeDevice(){this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin=_q.NO_CHANGE_DEVICE,this.storage.changeDeviceLog.setE2EESessionChangedTimestamp(this.getTimeNow())}logOverflowQueue(){this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin=bq.OVERFLOW_QUEUE,this.storage.overflowQueueLog.setQueueEvictTimestamp(this.getTimeNow()),this.storage.overflowQueueLog.setOverflowQueueTimestamp(this.getTimeNow())}logNoOverflowQueue(){this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin=bq.NO_OVERFLOW_QUEUE,this.storage.overflowQueueLog.setQueueEvictTimestamp(this.getTimeNow())}logMessageReadinessStatus(){const e=this.getOnlineInfo(),t=this.getShowSyncConfig(),s=this.getMessageReadinessLog();this.actionLogInfoV2(Ia.FeaturesInfo.MessageReadinessStatus,1,Object(I.a)(Object(I.a)(Object(I.a)({},e),t),s))}getMessageReadinessLog(){const e=this.getMissingMessageEventInfo(),t=this.getMessageFulfillmentInfo(),s=+(e.last_missing_msg_event<t.last_success_sync_timestamp);return this.logger.zsymb(0,"ZAPUU7",(()=>[e,t,`messageReadinessStatus: ${s}`])),Object(I.a)(Object(I.a)(Object(I.a)({},e),t),{},{msg_readiness_status:s})}logGetLoginInfoTimestamp(){this.storage.loginHistory.logGetLoginInfoTimestamp(this.getTimeNow())}logApplicationReadyTimestamp(e){this.storage.loginHistory.setApplicationReadyTimestamp(e)}get storage(){return a.ModuleContainer.resolve(Fm.c)}get setting(){return a.ModuleContainer.resolve(Sm.a)}actionLogInfoV2(e,t,s,a,i){Ia.default.logActionInfoV2(e,t,s,a,i)}getTimeNow(){return this.systemTime.getTimeNow()}checkFrequentUsageByLoginType(e){const t=this.storage.loginHistory.getHistory(e),s=vq(this.getTimeNow()-24192e5);return+t[0]>=+s&&t.length>=3}async getLastMessageTimestampWhenOverflowQueue(){const e=Kc.b.getLastMsgKeyFromServer();if(!e)return 0;const[t,s,a]=e.split("_");try{var i;return+(await(null===(i=lo.b.messageCache)||void 0===i?void 0:i.getMessageAsync(void 0,s,t,a))).sendDttm}catch(n){return 0}}calculateDaysSinceLastOnline(){const e=this.storage.loginHistory.lastOfflineTimestamp;if(e<=0)return 0;return Math.round((this.getTimeNow()-e)/864e5)}async saveLastMessageTimestampWhenOverflowQueue(){const e=await this.getLastMessageTimestampWhenOverflowQueue();e&&this.storage.overflowQueueLog.setLastMessageTimestamp(e)}getOnlineInfo(){return{device_imei:n.default.getInstance().getItem("z_uuid"),multi_device_user:+this.checkFrequentUsageByLoginType(Xm.b.CHANGE_DEVICE),frequently_used_device:+this.checkFrequentUsageByLoginType(Xm.b.NORMAL),changed_device_since_last_login:Number(this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===_q.CHANGE_DEVICE),days_since_last_onl:this.calculateDaysSinceLastOnline()}}getShowSyncConfig(){return{config_sync_suggestion:+!this.setting.value().dontSuggest,config_show_sync_progress:+!this.setting.value().hideProgress}}getMissingMessageEventInfo(){const e=this.firstLoginChecker.getFirstLoginTime(J.p.getSessionUserId()),t=this.storage.changeDeviceLog.changeDeviceTimestamp,s=this.storage.overflowQueueLog.lastMessageTimestamp,a=this.storage.overflowQueueLog.getOverflowQueueTimestamp(),i=Dq.getInstance().getLastDbCorruptionTimestamp();return{last_missing_msg_event:Math.max(a,t,e,i),queue_evicted_last_message_timestamp:s,queue_evicted_timestamp:a,missing_msg_event_device_changed:t,missing_msg_event_first_login:e}}getMessageFulfillmentInfo(){const e=this.setting.value().maxSeq;return{last_msg_fulfilled_timestamp:e,last_msg_sync_timestamp:e,last_msg_import_timestamp:this.storage.importExportLog.lastImportMessageTimestamp,last_success_sync_timestamp:this.setting.value().lastSync}}})||Rq)||Rq)||Rq)||Rq)||Rq)||Rq;a.ModuleContainer.registerSingleton(Aq,Fq);const kq="disable_transfer_full_when_db_corrupt",Nq={enabled:!0,[kq]:!1},Pq=new X.ObjectValidator({enabled:X.Rule.field().boolean(),[`${kq}`]:X.Rule.field().boolean()});var jq=new X.AdvancedRemoteConfigs("message_readiness_log",Nq,{validator:Pq});const Uq="last_three_weeks_login",Bq="last_three_weeks_change_device",zq="last_msg_timestamp_when_overflow_queue",Gq="timestamp_when_overflow_queue",xq="change_device_e2ee_event_timestamp",Vq="last_time_user_offline",Hq="idb_corrupt_ts",Wq="sql_db_corrupt_full_ts",qq="sql_msg_db_corrupt_ts";class Kq{constructor(e){this.adapter=e,this._changedDeviceSinceLastLogin=void 0,this._changeDeviceTimestamp=void 0,this._e2eeSessionChangedTimestamp=void 0,this._changedDeviceSinceLastLogin=_q.NOT_UPDATED_YET,this._changeDeviceTimestamp=0,this._e2eeSessionChangedTimestamp=0}async load(){this._changeDeviceTimestamp=await this.adapter.read(xq,1)||0}get changeDeviceTimestamp(){return this._changeDeviceTimestamp}get isChangedDeviceSinceLastLogin(){return this._changedDeviceSinceLastLogin}async setChangeDeviceTimestamp(e){this._changeDeviceTimestamp=e,await this.adapter.write(xq,1,this._changeDeviceTimestamp)}set isChangedDeviceSinceLastLogin(e){this._changedDeviceSinceLastLogin=e}setE2EESessionChangedTimestamp(e){this._e2eeSessionChangedTimestamp=e}getE2EESessionChangedTimestamp(){return this._e2eeSessionChangedTimestamp}}class Zq{constructor(){this._data=void 0,this._secureLocalStorage=void 0,this._data={},this._secureLocalStorage=n.default.getInstance()}get lastImportMessageTimestamp(){try{var e,t;return this._data=i_(this._secureLocalStorage.getItemForCurrentUser(Yc.e)),null!==(e=null===(t=this._data)||void 0===t?void 0:t.lastMessageTimestamp)&&void 0!==e?e:0}catch(CY){return 0}}}class $q{constructor(e){this.adapter=e,this._loginHistory=void 0,this._changeDeviceHistory=void 0,this._lastOfflineTimestamp=void 0,this._getLoginInfoTimestamp=void 0,this._applicationReadyTimestamp=void 0,this._loginHistory=[],this._changeDeviceHistory=[],this._lastOfflineTimestamp=0,this._getLoginInfoTimestamp=0,this._applicationReadyTimestamp=0}async load(){try{const[e,t,s]=await Promise.all([this.adapter.read(Uq,1),this.adapter.read(Bq,1),this.adapter.read(Vq,1)]);this._loginHistory=e||[],this._changeDeviceHistory=t||[],this._lastOfflineTimestamp=s||0}catch(e){this._loginHistory=[],this._changeDeviceHistory=[],this._lastOfflineTimestamp=0}}getHistory(e){switch(e){case Xm.b.NORMAL:return this._loginHistory;case Xm.b.CHANGE_DEVICE:return this._changeDeviceHistory;default:return[]}}async saveHistory(e,t){switch(e){case Xm.b.NORMAL:await this.setLoginHistory(t);break;case Xm.b.CHANGE_DEVICE:await this.setChangeDeviceHistory(t)}}logGetLoginInfoTimestamp(e){this._getLoginInfoTimestamp=e}getCurrentLoginTimestamp(){return this._getLoginInfoTimestamp}setApplicationReadyTimestamp(e){this._applicationReadyTimestamp=e}getApplicationReadyTimestamp(){return this._applicationReadyTimestamp}async setLoginHistory(e){this._loginHistory=e,await this.adapter.write(Uq,1,this._loginHistory)}async setChangeDeviceHistory(e){this._changeDeviceHistory=e,await this.adapter.write(Bq,1,this._changeDeviceHistory)}get lastOfflineTimestamp(){return this._lastOfflineTimestamp}async setLastOfflineTimestamp(e){this._lastOfflineTimestamp=e,await this.adapter.write(Vq,1,this._lastOfflineTimestamp)}}class Qq{constructor(e){this.adapter=e,this._isOverflowQueueSinceLastLogin=void 0,this._lastMessageTimestamp=void 0,this._queueEvictEventArriveTimestamp=void 0,this._overflowQueueTimestamp=void 0,this._isOverflowQueueSinceLastLogin=bq.NOT_UPDATED_YET,this._lastMessageTimestamp=0,this._queueEvictEventArriveTimestamp=0,this._overflowQueueTimestamp=0}async load(){this._lastMessageTimestamp=await this.adapter.read(zq,1)||0,this._overflowQueueTimestamp=await this.adapter.read(Gq,1)||0}get lastMessageTimestamp(){return this._lastMessageTimestamp}async setLastMessageTimestamp(e){this._lastMessageTimestamp=e,await this.adapter.write(zq,1,this._lastMessageTimestamp)}get isOverflowQueueSinceLastLogin(){return this._isOverflowQueueSinceLastLogin}set isOverflowQueueSinceLastLogin(e){this._isOverflowQueueSinceLastLogin=e}setQueueEvictTimestamp(e){this._queueEvictEventArriveTimestamp=e}getQueueEvictTimestamp(){return this._queueEvictEventArriveTimestamp}async setOverflowQueueTimestamp(e){this._overflowQueueTimestamp=e,await this.adapter.write(Gq,1,this._overflowQueueTimestamp)}getOverflowQueueTimestamp(){return this._overflowQueueTimestamp}}class Yq{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("MessageReadinessStorage already initialized");this.key="message_readiness_store"}async read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=await s.getItemForCurrentUserAsync(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItemForCurrentUser(e)}return null}async write(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void(await a.setItemForCurrentUserAsync(e,JSON.stringify({version:t,value:s})));this.remove(e)}async remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,await t.removeItemForCurrentUser(e)}}class Jq{constructor(e){this.adapter=e,this.logger=void 0,this._lastIndexedDBCorruptionTimestamp=void 0,this._lastSqliteDBCorruptionFullTimestamp=void 0,this._lastSqliteMessageDBCorruptionTimestamp=void 0,this._lastIndexedDBCorruptionTimestamp=0,this._lastSqliteDBCorruptionFullTimestamp=0,this._lastSqliteMessageDBCorruptionTimestamp=0,this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.msgSync,[w.ZLoggerNametags.messageReadinessChecker,"daivd"])}async load(){this._lastIndexedDBCorruptionTimestamp=this.adapter.readSharedKey(Hq,1)||0,this._lastSqliteDBCorruptionFullTimestamp=this.adapter.read(Wq,1)||0,this._lastSqliteMessageDBCorruptionTimestamp=this.adapter.read(qq,1)||0}getLastIndexedDBCorruptionTimestamp(){return this._lastIndexedDBCorruptionTimestamp}getLastSqliteDBCorruptionFullTimestamp(){return this._lastSqliteDBCorruptionFullTimestamp}getLastSqliteMessageDBCorruptionTimestamp(){return this._lastSqliteMessageDBCorruptionTimestamp}setIndexedDBCorruptionTimestamp(e){try{this._lastIndexedDBCorruptionTimestamp=e,this.adapter.writeSharedKey(Hq,1,e)}catch(CY){this.logger.zsymb(23,"beCPrM",["setIndexedDBCorruptionTimestamp error: {}","NE0pvc"],CY)}}setSqliteDBCorruptionFullTimestamp(e){try{this._lastSqliteDBCorruptionFullTimestamp=e,this.adapter.write(Wq,1,e)}catch(CY){this.logger.zsymb(23,"QilCId",["setSqliteDBCorruptionFullTimestamp error: {}","SGWNvs"],CY)}}setSqliteMessageDBCorruptionTimestamp(e){try{this._lastSqliteMessageDBCorruptionTimestamp=e,this.adapter.write(qq,1,e)}catch(CY){this.logger.zsymb(23,"CSli9B",["setSqliteMessageDBCorruptionTimestamp error: {}","d9nOJS"],CY)}}}class Xq{constructor(){this.key=""}load(){if(""!==this.key)throw new Error("MessageReadinessStorage already initialized");this.key="message_readiness_store"}read(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=s.getItemForCurrentUser(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItemForCurrentUser(e)}return null}write(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void a.setItemForCurrentUser(e,JSON.stringify({version:t,value:s}));this.remove(e)}readSharedKey(e,t){const s=n.default.getInstance();e=`${this.key}_${e}`;const a=s.getItem(e);if(a){const i=JSON.parse(a);if(i.version===t)return i.value;s.removeItem(e)}return null}writeSharedKey(e,t,s){const a=n.default.getInstance();if(null!==s)return e=`${this.key}_${e}`,void a.setItem(e,JSON.stringify({version:t,value:s}));this.remove(e)}remove(e){const t=n.default.getInstance();e=`${this.key}_${e}`,t.removeItemForCurrentUser(e)}}a.ModuleContainer.registerSingleton(Fm.c,class{constructor(){this._adapter=void 0,this._localStorageAdapter=void 0,this._loginHistoryStore=void 0,this._changeDeviceLogStore=void 0,this._overFlowQueueLogStore=void 0,this._importExportLogStore=void 0,this._dbCorruptionInfoStore=void 0,this._adapter=new Yq,this._localStorageAdapter=new Xq,this._loginHistoryStore=new $q(this._adapter),this._changeDeviceLogStore=new Kq(this._adapter),this._overFlowQueueLogStore=new Qq(this._adapter),this._importExportLogStore=new Zq,this._dbCorruptionInfoStore=new Jq(this._localStorageAdapter)}async load(){this.migrate(),this._adapter.load(),this._localStorageAdapter.load(),this._dbCorruptionInfoStore.load(),await Promise.all([this._loginHistoryStore.load(),this._changeDeviceLogStore.load(),this._overFlowQueueLogStore.load()])}get loginHistory(){return this._loginHistoryStore}get changeDeviceLog(){return this._changeDeviceLogStore}get overflowQueueLog(){return this._overFlowQueueLogStore}get importExportLog(){return this._importExportLogStore}get dbCorruptionInfo(){return this._dbCorruptionInfoStore}migrate(){}});var eK,tK=s("Ilem");Object(a.injectable)()(eK=Object(m.f)()(eK=Object(m.d)()(eK=Object(xi.b)(Fm.a)(eK=function(e,t){return Object(a.inject)(Fm.b)(e,void 0,0)}(eK=function(e,t){return Object(a.inject)(Aq)(e,void 0,1)}(eK=function(e,t){return Object(a.inject)(Fm.c)(e,void 0,2)}(eK=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,3)}(eK=function(e,t){return Object(a.inject)(St.b)(e,void 0,4)}(eK=Reflect.metadata("design:type",Function)(eK=Reflect.metadata("design:paramtypes",[Object,void 0===Aq?Object:Aq,Object,void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,void 0===St.ISystemTime?Object:St.ISystemTime])(eK=class extends hs.b{constructor(e,t,s,i,n){super(),this.eventCollector=void 0,this.metrics=void 0,this.config=void 0,this.storage=void 0,this.logger=void 0,this.systemTime=void 0,this.messageReadinessService=void 0,this.isMessageReady=()=>{try{const e=this.metrics.getMessageReadinessLog();return Boolean(e.msg_readiness_status)}catch(e){return this.logger.zsymb(21,"kIfmZ0",["Error when call isMessageReady: {}","HHdPwY"],e),!1}},this.isMessageReadyWithIncludeFlags=e=>{try{return this.messageReadinessService.isMessageReadyWithIncludeFlags(e)}catch(t){return this.logger.zsymb(21,"PMSvL3",["Error when call isMessageReadyWithIncludeFlags {}","8lRmAS"],t),!1}},this.getGetLoginInfoTimestamp=()=>this.storage.loginHistory.getCurrentLoginTimestamp(),this.getApplicationReadyTimestamp=()=>this.storage.loginHistory.getApplicationReadyTimestamp(),this.getDoneCheckOverflowTimestamp=()=>this.storage.overflowQueueLog.getQueueEvictTimestamp(),this.getE2eeSessionChangedTimestamp=()=>this.storage.changeDeviceLog.getE2EESessionChangedTimestamp(),this.isDBCorruptedThatNeedToTransferFull=()=>{try{if(this.config.key(kq).boolean)return this.logger.zsymb(3,"LbYuEJ",["Transfer full when db corrupt is disabled, skip check db corrupted","HGsCg0"]),!1;const e=this.messageReadinessService.getLastDbCorruptionTimestamp(),t=a.ModuleContainer.resolve(Sm.a).value().lastSync,s=e>=t;return this.logger.zsymb(3,"Gtjm8O",["Should transfer full due to db corruption: {},\n\t\t\t\tlastSync: {},\n\t\t\t\tlastDbCorruptTimestamp {}","ZMxk13"],s,t,e),s}catch(e){return this.logger.zsymb(21,"Bf8dUN",["Can not check isDBCorruptedThatNeedToTransferFull, error {}","YGuYz7"],e),!1}},this.handleDbCorruption=e=>{this.logger.zsymb(3,"NA0aOh",["daivd event corrupt {}","nizmUZ"],e.payload);try{const t=e.payload,s=t.corruptionInfo;if(t.adapterType===O.a.IDB)return void this.storage.dbCorruptionInfo.setIndexedDBCorruptionTimestamp(this.systemTime.getTimeNow());if(t.adapterType!==O.a.SQLite)return;if(s.type===tK.a.FULL)return void this.storage.dbCorruptionInfo.setSqliteDBCorruptionFullTimestamp(this.systemTime.getTimeNow());if("Core"===s.databaseCorruptInfo.database&&"Message"===s.databaseCorruptInfo.table)return void this.storage.dbCorruptionInfo.setSqliteMessageDBCorruptionTimestamp(this.systemTime.getTimeNow())}catch(CY){this.logger.zsymb(21,"TMzwv0",["Cannot dispatch db corruption {}","pshfEP"],CY)}},this.handleUserOffline=async()=>{try{await this.metrics.logLastTimeUserOffline()}catch(e){this.logger.zsymb(21,"Dw3NfO",["Error when handleUserOffline {}","XDxj1x"],e)}},this.handleOverflowQueue=()=>{try{this.logger.zsymb(3,"uNQpjg",["overflow queue","AlALBm"]),this.metrics.logOverflowQueue(),this.eventCollector.removeEventListener(Xm.a.OVERFLOW_QUEUE,this.handleOverflowQueue)}catch(e){this.logger.zsymb(21,"B43aLI",["Error when handleOverflowQueue {}","vKRx2t"],e)}},this.handleE2EEChangeDevice=async()=>{try{this.logger.zsymb(3,"RfH625",["is e2ee change device","iMmkMJ"]),await this.metrics.logChangeDevice(),this.eventCollector.removeEventListener(Xm.a.E2EE_CHANGE_DEVICE,this.handleE2EEChangeDevice)}catch(e){this.logger.zsymb(21,"TWzsWg",["Error when handleE2EEChangeDevice {}","Vx0iaM"],e)}},this.handleDonePullOffline=()=>{try{this.handleMessageReadinessLog(),this.eventCollector.removeEventListener(Xm.a.SOCKET_DONE_PULL_OFFLINE,this.handleDonePullOffline)}catch(e){this.logger.zsymb(21,"rulR_a",["Error when handleDonePullOffline {}","LyvzJT"],e)}},this.handleMessageReadinessLog=async()=>{try{if(this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===bq.OVERFLOW_QUEUE&&await this.metrics.saveLastMessageTimestampWhenOverflowQueue(),await this.metrics.updateOnlineHistory(Xm.b.NORMAL),!this.isEnabledMessageReadinessLog())return;setTimeout((()=>this.metrics.logMessageReadinessStatus()),3e5)}catch(e){this.logger.zsymb(21,"IavAWB",["Error when handleMessageReadinessLog {}","EgoLny"],e)}},this.handleNoOverflowQueue=()=>{try{this.logger.zsymb(0,"-G1nJC","no overflow queue"),this.metrics.logNoOverflowQueue(),this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===_q.NO_CHANGE_DEVICE&&(this.logger.zsymb(2,"uOfEGB","NoMissingMessageEventsArrivedEvent, no overflow triggered "),this.dispatchEvent(new fq)),this.eventCollector.removeEventListener(Xm.a.NO_OVERFLOW_QUEUE,this.handleNoOverflowQueue)}catch(e){this.logger.zsymb(21,"mtWxGp",["Error when handleNoOverflowQueue {}","iyznQn"],e)}},this.handleNoE2EEChangeDevice=()=>{try{this.logger.zsymb(3,"Q8hhga",["no e2ee change device","1K9WoO"]),this.metrics.logNoChangeDevice(),this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===bq.NO_OVERFLOW_QUEUE&&(this.logger.zsymb(2,"iRrCwx","all no-missing-message-event events arrived, triggered by no-e2ee-change-device event"),this.dispatchEvent(new fq)),this.eventCollector.removeEventListener(Xm.a.NO_E2EE_CHANGE_DEVICE,this.handleNoE2EEChangeDevice)}catch(e){this.logger.zsymb(21,"3ZDri_",["Error when handleNoE2EEChangeDevice {}","LRGat3"],e)}},this.eventCollector=e,this.metrics=t,this.config=jq,this.storage=s,this.systemTime=n,this.messageReadinessService=Dq.getInstance(),this.logger=i.createZLogger(w.ZLoggerNametags.msgSync,[w.ZLoggerNametags.messageReadinessChecker,"daivd"]),this.registerEventListeners()}onAuthenticated(){this.storage.load(),this.metrics.logGetLoginInfoTimestamp()}onApplicationReady(){this.metrics.logApplicationReadyTimestamp(this.systemTime.getTimeNow())}isNoMissingMessageEventsArrived(){const e=this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===_q.NO_CHANGE_DEVICE;return this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===bq.NO_OVERFLOW_QUEUE&&e}isAtLeastOneMissingMessageEventArrived(){const e=this.storage.changeDeviceLog.isChangedDeviceSinceLastLogin===_q.CHANGE_DEVICE,t=this.storage.overflowQueueLog.isOverflowQueueSinceLastLogin===bq.OVERFLOW_QUEUE;return Boolean(e||t)}registerEventListeners(){this.eventCollector.addEventListener(Xm.a.USER_OFFLINE,this.handleUserOffline),this.eventCollector.addEventListener(Xm.a.E2EE_CHANGE_DEVICE,this.handleE2EEChangeDevice),this.eventCollector.addEventListener(Xm.a.OVERFLOW_QUEUE,this.handleOverflowQueue),this.eventCollector.addEventListener(Xm.a.NO_OVERFLOW_QUEUE,this.handleNoOverflowQueue),this.eventCollector.addEventListener(Xm.a.SOCKET_DONE_PULL_OFFLINE,this.handleDonePullOffline),this.eventCollector.addEventListener(Xm.a.NO_E2EE_CHANGE_DEVICE,this.handleNoE2EEChangeDevice),this.eventCollector.addEventListener(Xm.a.DB_CORRUPTION,this.handleDbCorruption)}isEnabledMessageReadinessLog(){return this.config.key("enabled").boolean}})||eK)||eK)||eK)||eK)||eK)||eK)||eK)||eK)||eK)||eK);var sK=s("N1xz"),aK=s("CHYU");const iK={auto_restart:!0,auto_restart_conf_no_restart:!0,auto_restart_conf_usage_time:144e5,auto_restart_conf_wss_limit:"2.5GB",auto_restart_conf_mem_limit:"2.5GB",auto_restart_conf_idle_time:6e5,auto_restart_conf_idle_interval_check:[9e5,3e5],auto_restart_ext_entry:!0,auto_restart_entries:[]},nK="restart_ss";var rK;oK=rK=Reflect.metadata("design:type",Function)(rK=Reflect.metadata("design:paramtypes",[])(rK=class extends Fa.MetriczProcessLifecycle.Renderer{constructor(){super(),this.SIDEBAR_TAB_TO_PERSIST=[rc.SidebarTab.MESSAGE_TAB,rc.SidebarTab.CONTACT_TAB,rc.SidebarTab.TODO_TAB],this._logger=void 0,this.running=void 0,this.checkPreviousPersistedStateAfterRestartSilently=()=>{const e=n.default.getInstance(),t=e.getItemForCurrentUser(nK);if(t){this.Logger.zsymb(0,"7HIn0o",`auto-restart: detect prev app state ${t}`);const a=async()=>{e.removeItemForCurrentUser(nK)};try{const e=JSON.parse(t),{tab:s,ts:i,convId:n}=e;let r=6e4;if(Ct.default.getTimeNow()-i>r)return this.Logger.zsymb(18,"Rn68vJ",`auto-restart: timeout ${r}, not persist prev app state.`),void a();if(!this.SIDEBAR_TAB_TO_PERSIST.includes(s))return this.Logger.zsymb(18,"B9WQHj",`auto-restart: invalid tab to persist: ${s}`),void a();const o=me.a.ConvListController;if(o.isPreviewLoaded())setTimeout((()=>{this.recoverPreviousPersistedState(s,n)}),500);else{const e=()=>{setTimeout((()=>{this.recoverPreviousPersistedState(s,n)}),500),o.removeEventListener(ai.c.LoadPreviewDone,e)};o.addEventListener(ai.c.LoadPreviewDone,e)}}catch(s){a()}}$zsub.$zapp.removeListenAfterAppRestartSilently(this.checkPreviousPersistedStateAfterRestartSilently)},this.handleBeforeRestartSilently=()=>{const e=a.ModuleContainer.resolve(rc.SidebarController).getState(),t=e.currentTab;if(this.SIDEBAR_TAB_TO_PERSIST.includes(t)){const s={tab:e.currentTab,ts:Ct.default.getTimeNow()};t===rc.SidebarTab.MESSAGE_TAB&&e.selectedId&&(s.convId=e.selectedId),n.default.getInstance().setItemForCurrentUser(nK,JSON.stringify(s)),this.Logger.zsymb(0,"aL6oM_","auto-restart: persist state before restart {}",s)}else this.Logger.zsymb(6,"hl-hSf",`auto-restart: not persist current tab ${t} before restart`)},this.useConfig(iK)}get Logger(){return this._logger||(this._logger=this.createLogger("auto-restart")),this._logger}async appReady(e){this.checkEnabledAutoRestart(e),e.auto_restart&&$zsub.$zapp.afterAppRestartSilently(this.checkPreviousPersistedStateAfterRestartSilently)}async appReceiveConfigOnRuntime(e){this.checkEnabledAutoRestart(e)}beforeLogOut(){this.cancelCheckBeforeAppRestartSilently()}checkEnabledAutoRestart(e){if(e.auto_restart){if(this.running)return;this.running=!0,$zsub.$zapp.beforeAppRestartSilently(this.handleBeforeRestartSilently)}else this.cancelCheckBeforeAppRestartSilently()}cancelCheckBeforeAppRestartSilently(){this.running&&$zsub.$zapp.removeListenBeforeAppRestartSilently(this.handleBeforeRestartSilently)}recoverPreviousPersistedState(e,t){this.Logger.zsymb(0,"V5ZqPB",`auto-restart: start recover previous persisted app state. tab ${e}${t?`; convid ${t}`:""}`);const s=a.ModuleContainer.resolve(rc.SidebarController);if(s.getState().currentTab!==e&&s.changeTab(e),e===rc.SidebarTab.MESSAGE_TAB&&t){const e=a.ModuleContainer.resolve(Q.b);let s=Q.c;t===Ce.default.sendToMeId&&(s=Q.d.fromToolBoxFileTranfer()),s=Object(I.a)(Object(I.a)({},s),{},{silently:!0}),e.openConversation(t,s)}}})||rK)||rK,sK.a.process===aK.b.Render&&(null===(cK=sK.a.ProcessLifecycleController)||void 0===cK||cK.register([oK]));var oK,cK;var lK;const dK={syncSource:null,forceSyncSource:null,isSyncing:!1};Object(xi.b)(CB.a)(lK=Reflect.metadata("design:type",Function)(lK=Reflect.metadata("design:paramtypes",[])(lK=class{constructor(){this.state=Object(I.a)({},dK),this.name="syc-zcloud-queue-ui",this.key="syc-zcloud-queue-ui"}getSyncSource(){return this.state.syncSource}getForceSyncSource(){return this.state.forceSyncSource}setSyncSource(e){this.setState((t=>{t.syncSource=e}))}setForceSyncSource(e){this.setState((t=>{t.forceSyncSource=e}))}reset(){this.setState((e=>{e.syncSource=null,e.forceSyncSource=null,e.isSyncing=!1}))}isSyncing(){return this.state.isSyncing}setSyncing(e){this.setState((t=>{t.isSyncing=e}))}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(rm.a)(this.state,e);this.state!==t&&(this.state=t,Object(nc.h)(this.name,"current"))}})||lK)||lK);let uK=function(e){return e[e.Hidden=0]="Hidden",e[e.Success=1]="Success",e[e.Info=2]="Info",e[e.Error=3]="Error",e}({});var hK;const gK={zCloudStatus:{isPaid:!1,hasKey:!1,isMigrated:!1},banner:uK.Hidden,inProgressOffloadSize:0,isShowZCloudOffloadRedDot:!1,offloadingConv:"",error:null,offloadConvNum:0,totalOffloadConvNum:0,offloadSizeConvs:{}};Object(xi.b)(rz.b)(hK=Reflect.metadata("design:type",Function)(hK=Reflect.metadata("design:paramtypes",[])(hK=class{constructor(){this.name=rz.a,this.key="window_id",this.state=Object(I.a)({},gK)}setItem(e,t){this.setState((s=>{s[e]=t}))}setZCloudStatus(e){this.setState((t=>{t.zCloudStatus=e}))}isZCloudStatusReady(){const{zCloudStatus:e}=this.getState();return e.isPaid&&e.hasKey}setShowZCloudOffloadRedDot(e){this.setState((t=>{t.isShowZCloudOffloadRedDot=e}))}setInProgressOffloadSize(e){this.setState((t=>{t.inProgressOffloadSize=e}))}setError(e){this.setState((t=>{t.error=e}))}setOffloadingConv(e){this.setState((t=>{t.offloadingConv=e}))}setOffloadConvNum(e){this.setState((t=>{t.offloadConvNum=e}))}setTotalOffloadConvNum(e){this.setState((t=>{t.totalOffloadConvNum=e}))}setNewEstimatedSizeConv(e,t){this.setState((s=>{s.offloadSizeConvs=Object(I.a)(Object(I.a)({},s.offloadSizeConvs),{},{[e]:t})}))}resetScanedStates(){this.setState((e=>{e.offloadConvNum=gK.offloadConvNum,e.offloadSizeConvs=gK.offloadSizeConvs}))}reset(){this.setState((e=>{e.banner=uK.Hidden,e.isShowZCloudOffloadRedDot=!1}))}getState(){return this.state}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}setState(e){const t=Object(rm.a)(this.state,e);this.state!==t&&(this.state=t,Object(nc.h)(this.name,"current"))}})||hK)||hK);var mK,pK=s("XNYy"),fK=s("/I0A");let vK=Object(a.injectable)()(mK=class{constructor(){this.decodeLocalImage=async e=>{const t=Date.now();try{var s;const t=lf.b.get(e);if(t)return t.prepared;const a=Date.now();let i;if(zp.a.jxl.version===Gp.a.V2){const t=await Object(Pp.b)(e,{quality:.9},{priority:0});Object(ua.a)(t.length>0,"JitJxlDecoderImpl:decodeLocalImage:failed");const s=t[0].data;i=new Blob([s],{type:"image/jpeg"})}else i=await Object(Pp.a)(e);const n=URL.createObjectURL(i);return zconsole.zsymb(3,"lARkPK",["decodeLocalImage:success: {} -> {}","Wqth8a"],e,n,null===(s=i)||void 0===s?void 0:s.size,Date.now()-a),lf.b.set(e,i.size,n),kc.default.increaseSuccess(Bp.a,0,Date.now()-a),kc.default.increaseSuccess(Bp.c,0,Date.now()-a),n}catch(CY){if(Object(fK.a)().zsymb(21,"CYQwm6",["JitJxlDecoderImpl:decodeLocalImage:failed","UajwXS"],CY),kc.default.increaseFailed(Bp.c,0,0,Object(Bp.i)(),t),kc.default.increaseFailed(Bp.a,0,0,Object(Bp.k)(),t),Object(cf.l)(CY))throw CY;throw new cf.a(9999,"JitJxlDecoderImpl:decodeLocalImage:failed")}}}})||mK;a.ModuleContainer.registerSingleton(pK.a,vK);const _K=Object(a.define)("JIT_MEDIA_CODEC");var bK,IK=s("zEx5");let yK=Object(a.injectable)()(bK=class{decodeLocalImage(e){return a.ModuleContainer.resolve(IK.TJitJxlDecoder).decodeLocalImage(e)}})||bK;a.ModuleContainer.registerSingleton(_K,yK);let SK=function(e){return e[e.Integrity=0]="Integrity",e[e.Strict=1]="Strict",e[e.BestEffort=2]="BestEffort",e}({});const CK={enable_feature:!0,roll_on_exceed_quota:!0,max_alive_account:5,roll_mode:SK.Integrity,roll_buffer_count:0,count_user_in_ls:!1},EK=new ee.a({enable_feature:ee.b.field().boolean(),roll_on_exceed_quota:ee.b.field().boolean(),max_alive_account:ee.b.field().number().min(1),roll_mode:ee.b.field().number().max(SK.BestEffort).min(SK.Integrity),roll_buffer_count:ee.b.field().number().min(0),count_user_in_ls:ee.b.field().boolean()});class OK extends X.ZFeatureConfig{constructor(){super({default:CK,valiator:EK})}selector(e){return e.auto_roll_ls||{}}shouldConfigUpdate(e,t){return!0}}class MK{constructor(e,t,s){this.uid=e,this.keyPath=t,this.lastAccess=s,this.setup=void 0,this.dispose=void 0,this.runner=void 0,this.setup=null,this.runner=null,this.dispose=null}get rawKeyPath(){return this.keyPath.slice(1)}get userIndex(){return this.keyPath.slice(0,1)}installSetup(e){this.setup=e}installRunner(e){this.runner=e}installDispose(e){this.dispose=e}async roll(){this.setup&&await this.setup(),this.runner&&await this.runner(),this.dispose&&await this.dispose()}}class TK extends MK{constructor(e,t,s){super(e,t,s),this.uid=e,this.keyPath=t,this.lastAccess=s,this.runner=async()=>{localStorage.removeItem(this.keyPath)}}}var RK,wK=s("Kfp5");const LK="last_check_exceed_quota",DK=["_z_sc","_cdk","_react","_cl-uc","_rs","_tracking-old-cbb","_pcl-k","_preload_cache","_list_recent_g_search_v2"],AK=152101,FK=152102;Object(m.j)()(RK=Reflect.metadata("design:type",Function)(RK=Reflect.metadata("design:paramtypes",[])(RK=class{constructor(){this.logger=void 0,this.config=void 0,this._quotaExceed=void 0,this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.localstorage,[w.ZLoggerNametags.lsRoller]),this.config=new OK,this._quotaExceed=null}onAuthenticated(){}onStart(){requestIdleCallback((()=>{this.qosCountAccountInLS(),this.roll()}))}async roll(){if(!this.config.get("enable_feature"))return void this.logger.zsymb(0,"rEjqGq","skip roll, feat disable!");if(!this.isExceededQuota()&&this.config.get("roll_on_exceed_quota"))return void this.logger.zsymb(0,"N8F-Cn","skip roll, quota ok!");const e=this.config.get("max_alive_account"),t=this.config.get("roll_mode"),s=this.getUserAccessTimes(),a=s.slice(e);switch(this.logger.zsymb(0,"8VG0eX","start roll: ",t,s.length,a.length),t){case SK.Integrity:this.doRollMatchingKey(a),this.qosRoll(t,a.length);break;case SK.Strict:this.doRollMatchingId(a),this.qosRoll(t,a.length);break;case SK.BestEffort:{const i=this.config.get("roll_buffer_count"),n=e-i;if(this.doRollMatchingId(a),i&&s.length>=n){const t=s.slice(n,e);this.doRollMatchingKey(t)}this.qosRoll(t,s.length-n);break}default:this.logger.zsymb(0,"Syn9Mq","Skip roll, unknow mode!")}}buildRollItems(e){return e.reduce(((e,t)=>(DK.forEach((s=>{const a=`${t.index}${s}`;e.push(new TK(t.uid,a,t.accessTime))})),e)),[])}setupExecutor(e){e.forEach((e=>{"_react"==e.rawKeyPath&&e.installSetup((async()=>{Object(wK.c)(e.uid)}))}))}doRollMatchingKey(e){const t=this.buildRollItems(e);this.setupExecutor(t),this.logger.zsymb(0,"tFIMKQ","roll matching key: ",t.length),t.length&&Promise.all(t.map((e=>e.roll().catch((t=>{this.logger.zsymb(0,"8V8PkM","roll item got error: ",e.keyPath,t)})))))}doRollMatchingId(e){if(this.logger.zsymb(0,"4naqOt","roll matching id: ",e.length),e.length){Lh.a.getInstance().cleanupLocalStorageMatchConditions((t=>e.some((e=>t.startsWith(e.index)))))}}isExceededQuota(){if(null!==this._quotaExceed)return this._quotaExceed;this._quotaExceed=!1;try{n.default.getInstance().setItemForCurrentUser(LK,Date.now().toString())}catch(e){this._quotaExceed=22==(null==e?void 0:e.code)}if(!this._quotaExceed){const e=new Blob(Object.values(localStorage)).size;this._quotaExceed=e>=5e6}return this._quotaExceed}getUserAccessTimes(){const e=Object(hr.f)(),t=[];return e&&e.length&&e.forEach(((e,s)=>{t.push(this.getAccesstimeFor(e,s))})),t.sort(((e,t)=>t.accessTime-e.accessTime)),t}getAccesstimeFor(e,t){const s=localStorage.getItem(`${t}_${Y.LAST_TIME_FETCH_ME_PREFIX}`)||0,a=localStorage.getItem(`${t}_${LK}`)||0;return{uid:e,index:t.toString(),accessTime:Math.max(+s,+a)}}qosRoll(e,t){t>0?kc.default.increaseSuccess(AK,e,0,[t]):kc.default.increaseFailed(AK,e,0,-t,Date.now())}qosCountAccountInLS(){if(!this.config.get("count_user_in_ls"))return;const e=this.isExceededQuota(),t=Object(hr.f)().length;this.logger.zsymb(0,"RyYm9p","total users in ls: ",e,t),e?kc.default.increaseFailed(FK,0,0,t,Date.now()):kc.default.increaseSuccess(FK,0,0,[t])}})||RK)||RK);var kK,NK=s("HMHh"),PK=s("4Rl+");Object(a.singleton)(NK.e)(kK=Reflect.metadata("design:type",Function)(kK=Reflect.metadata("design:paramtypes",[])(kK=class{constructor(){this.logger=void 0,this.pTracker=void 0,this.lastQueryId=void 0,this.lastQueryId=-1,this.pTracker=new PK.c}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.search,["search-message"])),this.logger}encodeKW(e){return ui.default.md5(e)}async handleResultSearchInChat(e,t,s){const{data:i,hasMore:n,result:r}=s,{id:o,keyword:c,filter:l}=t,d=(null==l?void 0:l.msgType)===Y.MSG_FILE,u=i[i.length-1];let h;d?(h={id:o,keyword:c,convId:e,filter:l,messages:[],files:r,hasMoreFiles:n},u&&u.ts&&(h.lastFileTs=+u.ts)):(h={id:o,keyword:c,convId:e,filter:l,files:[],messages:r,hasMoreMessages:n},u&&u.ts&&(h.lastMessageTs=+u.ts)),a.ModuleContainer.resolve(NK.d).onSearchResult(e,h)}isAllowQueryNoKeyword(e){const{filter:t,config:s}=e;return!!(t&&t.convId&&t.searchForEmpty&&(t.fromUid||t.timeRange&&(t.timeRange[0]||t.timeRange[1]))&&null!=s&&s.limit)}checkAbortQuery(e){if(e<this.lastQueryId)throw new Error(`Query ${e} was aborted`)}async querySearchDB(e){const{keyword:t,filter:s,config:a={},id:i}=e;let n=Object(I.a)(Object(I.a)({},a),{},{enableReject:!0}),r=!1;a.limit&&(n=Object(I.a)(Object(I.a)({},n),{},{limit:a.limit+1}));const o=await Dc.a.getInstance().search(t,!0,s,null,n);return this.checkAbortQuery(i),o&&a.limit&&o.length>a.limit&&(r=!0,o.pop()),{data:o,hasMore:r}}async getMessagesAfterQuery(e,t){const{id:s,options:i}=t;let n=await a.ModuleContainer.resolve(NK.f).getMessages(e);this.checkAbortQuery(s);const r=n.length;return n=n.filter((e=>!i||!i.predicate||i.predicate(e))),this.Logger.zsymb(0,"XrBbRE",`get messages id: ${s} total: ${r} after predicate: ${n.length}`),n}async onQueryResponse(e,t){const{filter:s,id:a}=e;return this.checkAbortQuery(a),s&&s.convId&&await this.handleResultSearchInChat(s.convId,e,t),t}async processQuery(e){const{filter:t,id:s,config:a}=e;this.pTracker.start(PK.b.QUERY,s);let{data:i=[],hasMore:n}=await this.querySearchDB(e);this.pTracker.end(PK.b.QUERY),this.pTracker.start(PK.b.GET_MESSAGES,s);let r=await this.getMessagesAfterQuery(i,e);if(this.pTracker.end(PK.b.GET_MESSAGES),n&&a&&r.length<i.length){this.Logger.zsymb(0,"bfTniy","continue query due to mismatch",s);const o=i[i.length-1].ts,c=[t&&t.timeRange?t.timeRange[0]:0,o],l=Object(I.a)(Object(I.a)({},e),{},{filter:Object(I.a)(Object(I.a)({},t||{}),{},{timeRange:c}),config:Object(I.a)(Object(I.a)({},a),{},{limit:i.length-r.length})}),d=await this.processQuery(l);i=i.concat(d.data),n=d.hasMore,r=r.concat(d.result)}return{data:i,hasMore:n,result:r}}async query(e){const{keyword:t,id:s}=e;if(this.lastQueryId=s,!Pc.a.formatTextSearch(t)&&!this.isAllowQueryNoKeyword(e))return this.onQueryResponse(e,{data:[],hasMore:!1,result:[]});this.Logger.zsymb(0,"ZphGj-","start query with params:",Object(I.a)(Object(I.a)({},e),{},{keyword:this.encodeKW(t)}));const a=await this.processQuery(e);return this.onQueryResponse(e,a)}async queryNoKeyword(e){const{filter:t,config:s,id:i}=e;let n=!1,r=[];if(this.Logger.zsymb(0,"2jZox1","start query no kw",e),!(t&&t.convId&&(t.fromUid||t.timeRange&&(t.timeRange[0]||t.timeRange[1]))&&null!=s&&s.limit))return this.onQueryResponse(e,{data:r,hasMore:n,result:[]});const o=t.convId;let c=s;if(s&&s.limit&&(c=Object(I.a)(Object(I.a)({},s),{},{limit:s.limit+1})),t.msgType===Y.MSG_FILE){const l=a.ModuleContainer.resolve(NK.d).getLastResultFile(o);this.pTracker.start(PK.b.GET_MESSAGES,i);const d=await a.ModuleContainer.resolve(NK.f).getFilesForConversation({convId:o,config:c,filter:t,fromMsgId:null==l?void 0:l.msgId});return this.pTracker.end(PK.b.GET_MESSAGES),d.length>s.limit&&(n=!0,d.pop()),r=d.map((e=>({convId:o,msgId:e.msgId,ts:e.sendDttm}))),this.onQueryResponse(e,{data:r,hasMore:n,result:d})}const l=a.ModuleContainer.resolve(NK.d).getLastResultMessage(o);this.pTracker.start(PK.b.GET_MESSAGES,i);const d=await a.ModuleContainer.resolve(NK.f).getMessagesForConversation({convId:o,config:c,filter:t,fromMsgId:null==l?void 0:l.msgId});return this.pTracker.end(PK.b.GET_MESSAGES),d.length>s.limit&&(n=!0,d.pop()),r=d.map((e=>({convId:o,msgId:e.msgId,ts:e.sendDttm}))),this.onQueryResponse(e,{data:r,hasMore:n,result:d})}abortAllQueries(){Dc.a.getInstance().abortSearch()}async jumpToResult(e){const{msgId:t,convId:s,dispatch:a,keyword:i}=e;let n=null;i&&(n={searchKeyWord:i}),this.Logger.zsymb(0,"jRdMud",`jump to msgId: ${t} convId: ${s} kw: ${i?this.encodeKW(i):""}`),this.pTracker.start(PK.b.JUMP_MESSAGE,t),await Ng.a.gotoMessage(t,s,a,n),this.pTracker.end(PK.b.JUMP_MESSAGE)}})||kK)||kK);var jK;Object(a.singleton)(NK.f)(jK=class{async getMessagesForConversation(e){var t,s;const{convId:a,config:i,filter:n,fromMsgId:r}=e,o=Xt.default.getInstance();return await o.Core.Message.index("userId_sendDttm_msgId").getAll({from:[a,null!==(t=n.timeRange)&&void 0!==t&&t[0]?String(n.timeRange[0]):"0","0"],to:[a,null!==(s=n.timeRange)&&void 0!==s&&s[1]?String(n.timeRange[1]):fo.b,r||fo.a],excludeFrom:!1,excludeTo:!1},{partition:a,limit:i.limit,predicate:e=>(!n.fromUid||e.fromUid===n.fromUid)&&(!!Pc.a.isMsgSearchable(e)&&!vo.d.isDeletingInConversation(e)),direction:O.c.PREV})}async getFilesForConversation(e){const{convId:t,config:s,filter:i,fromMsgId:n}=e;if(!s.limit)return[];return(await a.ModuleContainer.resolve(mU.a).getFilesFromConversation(t,s.limit,n||fo.a)).filter((e=>{if(i.fromUid&&i.fromUid!==e.fromUid)return!1;if(i.timeRange){const t=+e.sendDttm;if(i.timeRange[0]&&t<i.timeRange[0])return!1;if(i.timeRange[1]&&t>i.timeRange[1])return!1}return!0}))}deduplicateMessages(e){const t=new Set,s=[];for(const a of e){const e=a.msgId,i=`${a.cliMsgId}_${a.fromUid}_${a.toUid}`;t.has(e)||t.has(i)||(t.add(e),t.add(i),s.push(a))}return s}async getMessagesInConversation(e,t){const s=Xt.default.getInstance();let a=await s.Core.Message.getMulti(t,{partition:e});return a=a.filter((e=>!(!e||!Pc.a.isMsgSearchable(e))&&!vo.d.isDeletingInConversation(e))),a=this.deduplicateMessages(a),a}async getMessages(e){if(!e||!e.length)return[];const t=e.map((({msgId:e})=>e)),s=new Map;e.forEach((({convId:e,msgId:t})=>{const a=s.get(e)||[];a.push(t),s.set(e,a)}));const a=[];s.forEach(((e,t)=>{a.push(this.getMessagesInConversation(t,e))}));const i=(await Promise.all(a)).reduce(((e,t)=>e.concat(t)),[]),n=new Map(i.map((e=>[e.msgId,e]))),r=[];return t.forEach((e=>{const t=n.get(e);t&&r.push(t)})),r}});var UK;Object(xi.b)(NK.d)(UK=Reflect.metadata("design:type",Function)(UK=Reflect.metadata("design:paramtypes",[])(UK=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.queryPatch=void 0,this.openingSearch=void 0,this.keepCacheItems=void 0,this.name=NK.a,this.key=NK.a,this.data=new Map,this.openingSearch=new Set,this.keepCacheItems=new Set,this.queryPatch=new Map}init(){}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(nc.h)(this.name,e)}signalRemoveItem(e){Object(nc.f)(this.name,e)}signalUpdateList(){Object(nc.i)(this.name,this.key)}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.search,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"E91TCw","Get search in chat data item failed",e)}onGetListFailure(e){this.Logger.zsymb(20,"dtAApf","Get search in chat data list failed",e)}isOpeningSearch(e){return this.openingSearch.has(e)}setOpeningSearch(e,t){t?this.openingSearch.add(e):this.openingSearch.delete(e)}clearData(){this.data.size>0&&(this.data.clear(),this.signalUpdateList()),this.queryPatch.size>0&&this.queryPatch.clear()}clearDataItem(e){this.data.has(e)&&(this.data.delete(e),this.signalRemoveItem(e)),this.queryPatch.delete(e)}concatResultList(e,t){const s=new Set,a=[];for(const i of e){const e=`${i.cliMsgId}_${i.fromUid}_${i.toUid}`;s.add(i.msgId),s.add(e),a.push(i)}for(const i of t){const e=`${i.cliMsgId}_${i.fromUid}_${i.toUid}`;s.has(i.msgId)||s.has(e)||(s.add(i.msgId),s.add(e),a.push(i))}return a}isValidPatch(e){const t=this.queryPatch.get(e.convId);return!(!t||t!==e.id)}onSearchResult(e,t){if(!this.isValidPatch(t))return;let s=this.data.get(e);s&&s.id===t.id?(s=Object(I.a)(Object(I.a)({},s),{},{files:this.concatResultList(s.files,t.files),messages:this.concatResultList(s.messages,t.messages)}),void 0!==t.hasMoreFiles&&(s.hasMoreFiles=t.hasMoreFiles),void 0!==t.hasMoreMessages&&(s.hasMoreMessages=t.hasMoreMessages),void 0!==t.lastFileTs&&(s.lastFileTs=t.lastFileTs),void 0!==t.lastMessageTs&&(s.lastMessageTs=t.lastMessageTs)):s=t,this.data.set(e,s),this.signalUpdateItem(e)}getSearchResult(e){return this.data.get(e)}getLastResultMessage(e){const t=this.data.get(e);return null==t?void 0:t.messages[t.messages.length-1]}getLastResultFile(e){const t=this.data.get(e);return null==t?void 0:t.files[t.files.length-1]}getLastResultFileTs(e){const t=this.data.get(e);return null==t?void 0:t.lastFileTs}getLastResultMessageTs(e){const t=this.data.get(e);return null==t?void 0:t.lastMessageTs}onStartSearch(e,t){this.queryPatch.set(e,t)}onSelectResultItem(e,t){const s=this.data.get(e);s&&(this.data.set(e,Object(I.a)(Object(I.a)({},s),{},{selectedResultItem:t})),this.signalUpdateItem(e))}})||UK)||UK);var BK;Object(xi.b)(NK.g)(BK=Reflect.metadata("design:type",Function)(BK=Reflect.metadata("design:paramtypes",[])(BK=class{constructor(){this.name=void 0,this.key=void 0,this.logger=void 0,this.data=void 0,this.promoteCache=void 0,this.name=NK.c,this.key=NK.c,this.data=new Map,this.promoteCache=new eM.a(NK.b)}init(){}getList(){return Array.from(this.data.keys())}signalUpdateItem(e){Object(nc.h)(this.name,e)}signalRemoveItem(e){Object(nc.f)(this.name,e)}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.search,[this.name])),this.logger}getItem(e){return this.data.get(e.key)}onGetItemFailure(e){this.Logger.zsymb(20,"UBCpTz","Get search promote data item failed",e)}onGetListFailure(e){this.Logger.zsymb(20,"OMiBgz","Get search promote data list failed",e)}isPromoteAt(e){const{position:t,version:s}=e,a=this.promoteCache.getItem(t);return!a||s>a}promoteAt(e){const{position:t,version:s,autoClose:a}=e;this.promoteCache.setItem(t,s),this.data.set(t,{version:s,promote:!0}),this.signalUpdateItem(t),a&&a>0&&setTimeout((()=>{this.closePromoteAt({position:t,version:s})}),a)}closePromoteAt(e){const{position:t,version:s}=e;this.isPromoteAt(e)&&this.promoteCache.setItem(t,s);const a=this.data.get(t);a&&a.promote&&(this.data.delete(t),this.signalRemoveItem(t))}})||BK)||BK);s("+bFI");ie.a.register(hT.e.Call,((e,t)=>{const{isMultiSelectOn:s}=e;return[]}));var zK=s("rI+G");ie.a.register(hT.e.Contact,((e,t)=>{const{isMultiSelectOn:s,message:a}=e;if(s)return[];let i=null;if(a.message.action===Y.MessageContentAction.User){let e=Object(fe.b)(a);e&&e.phone&&(i=new zK.CopyNumberMenuItem(e.phone))}return[i].filter(Boolean)}));var GK=s("0bqf"),xK=s("aODc"),VK=s("XOIG"),HK=s("vRKI");function WK(e){if(Ee.l)return!1;if(!e)return!1;let{flag:t}=Object(Je.b)(e);return!!(t&It.d.local)}var qK=s("HyDr"),KK=s("Vi1T");function ZK(e,t){var s;e&&(null===(s=ZR.a.for(e))||void 0===s||s.collect(t))}function $K(e,t,s){const{message:a,source:i,windowId:n}=e||{},r=a.toUid;GK.b.downloadMessage(a||{},{src:GK.a.CHAT,targetId:r}),Object(ge.c)(a,ge.a.UserAction),i===qK.a.ContextMenu?(Ia.default.logAction(1063914),Object(xK.a)(10,a)):Ia.default.logAction(106380410),Uc.a.addUserAction(n,"Download"),Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload),Ee.l?function(e){const{event:t,message:s}=e||{};Object(fU.downloadWebV2ByMsg)(t,window.document,s,!0),GK.c.log(GK.c.ACT.VIEW,{src:GK.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}(e):function(e,t,s){const{message:a}=e||{},{manualDownloadMediaDoneHandler:i}=Object(q.c)();Object(KK.a)(a,Ar.c,{actions:i,entryType:oe.f.File})}(e)}ie.a.register(hT.e.File,(function(e,t){const{detail:s,isMultiSelectOn:a,message:i}=e||{};if(a||!i)return[];let n,r;return ZK(null==s?void 0:s.trackingCmdId,"FileMessage: start build ctx menu"),function(e){const{message:t}=e||{};return!!t&&!Object(x_.r)(t)&&!Object(x_.K)(t)&&Object(HK.a)(t)}({message:i})&&(n=new VK.s,n.setHandler((t=>{try{var a;null==t||t.stopPropagation(),null===(a=n.getMenu())||void 0===a||a.close();const i=n.getWindowId();$K(Object(I.a)(Object(I.a)({},e),{},{windowId:i}),null==s||s.fileData,null==s||s.fileHandler)}catch(CY){}}))),ZK(null==s?void 0:s.trackingCmdId,"FileMessage: check SaveFileToDevice done"),WK(i)&&(r=new VK.x,r.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=r.getMenu())||void 0===s||s.close(),function(e){const{message:t,source:s}=e||{};GK.b.showMessageInFolder(t,{targetId:t.toUid,src:GK.a.CHAT}),s===qK.a.ContextMenu?(Ia.default.logAction(1063913),Object(xK.a)(11,t)):Ia.default.logAction(106380409),Ia.default.logAction(107190901),Object(KR.default)(e.message)}(e)}catch(CY){}}))),ZK(null==s?void 0:s.trackingCmdId,"FileMessage: build ctx menu done"),[n,r].filter(Boolean)})),ie.a.register(hT.e.GIF,((e,t)=>{const{event:s,detail:a,isMultiSelectOn:i,message:n}=e||{};if(!s||!n||i)return[];let r,o;return[r,o].filter(Boolean)}));var QK=s("IBuc"),YK=s("P7Ey");function JK(e){for(;null!=e&&e.firstChild;)e.removeChild(e.firstChild)}var XK=function(e,t){const s=t||window,a=s.getSelection();if("string"==typeof e&&a&&"Range"===a.type&&a.rangeCount>0){const t=s.document.getElementById(e);if(t){const i=a.getRangeAt(0),n=i.commonAncestorContainer;if(t.contains(n)){if(n.nodeType===Node.ELEMENT_NODE&&"rtf-container"===(null==n?void 0:n.getAttribute("data-component")))return()=>"";const{content:e}=Object(YK.a)(s);return e||a.toString()}{const t=i.cloneContents();if(null!=t&&t.getElementById(e))return JK(t),t=>{try{const s=t||window,a=s.getSelection();if(null===a)return"";const i=a.getRangeAt(0).cloneContents();let n=i.getElementById(e);if(JK(i),null==n)return"";s.document.body.appendChild(n);const r=new Range;r.selectNodeContents(n),a.removeAllRanges(),a.addRange(r);const o=a.toString();return r.deleteContents(),a.removeAllRanges(),s.document.body.removeChild(n),n=null,o}catch(CY){return""}};JK(t)}}}};function eZ(e){return Boolean(e&&"function"==typeof e.getAttribute&&e.getAttribute("data-z-element-type")===Y.DataAttributes.Element.EMAIL)}function tZ(e){if(!e||"function"!=typeof e.getAttribute)return!1;const t=e.getAttribute("data-z-element-type");return t===Y.DataAttributes.Element.RTF_TEXT?e.classList.contains("text-is-link"):Boolean(t===Y.DataAttributes.Element.LINK)}function sZ(e){return Boolean(e&&"function"==typeof e.getAttribute&&e.getAttribute("data-z-element-type")===Y.DataAttributes.Element.PHONE_NUMBER)}function aZ(e,t){var s;e&&(null===(s=ZR.a.for(e))||void 0===s||s.collect(t))}ie.a.register(hT.e.Link,((e,t)=>{const{detail:s,event:a,isMultiSelectOn:i,message:n,source:r}=e||{};if(!a||!n||i)return[];aZ(null==s?void 0:s.trackingCmdId,"LinkMessage: start build ctx menu");const o=Object(x_.Z)(n);let c=null;if(!o)if(r===qK.a.MessageFloatingMenu)c=new zK.CopyLinkMenuItem(n.message.href);else{const e=a.view,t=XK(null==s?void 0:s.linkMessageContainerId,e);if(aZ(null==s?void 0:s.trackingCmdId,"LinkMessage: check selectedContent"),t)"string"==typeof t?c=new zK.CopySelectedContentMenuItem(t):"function"==typeof t&&(c=new zK.CopySelectedContentMenuItem(""),c.setHandler((()=>{const s=t(e);s?Object(QK.a)(s):e.document.execCommand("copy"),c.getMenu().close()})));else{var l;const e=a.target,t=null!==(l=a.currentTarget)&&void 0!==l?l:a._currentTarget;if(null!=t&&t.id&&(null==t?void 0:t.id)===(null==s?void 0:s.linkContentContainerId))c=new zK.CopyLinkMenuItem(n.message.href);else if(tZ(e)&&e.textContent)c=new zK.CopyLinkMenuItem(n.message.href);else if(eZ(e)&&e.textContent)c=new zK.CopyEmailMenuItem(e.textContent);else if(sZ(e)&&e.textContent)c=new zK.CopyNumberMenuItem(e.textContent);else if(""===n.message.title||n.message.title===n.message.href)c=new zK.CopyLinkMenuItem(n.message.href);else{const e=n.message.title||n.message.href;c=new zK.CopyMessageContentMenuItem(e)}}}return aZ(null==s?void 0:s.trackingCmdId,"LinkMessage: build ctx menu done"),[c].filter(Boolean)})),ie.a.register(hT.e.Location,((e,t)=>{const{isMultiSelectOn:s}=e;return[]})),ie.a.register(hT.e.OA,((e,t)=>{const{detail:s,isMultiSelectOn:a}=e;if(a)return[];const{indexOAChild:i=0}=s||{},{message:n}=e;let r={href:"",title:""};Array.isArray(n.message)&&(r=n.message[i]);let o=null;return r.href?o=new zK.CopyLinkMenuItem(r.href):r.title&&(o=new zK.CopyMessageContentMenuItem(r.title)),[o].filter(Boolean)}));var iZ=s("4X16"),nZ=s("RUNN");var rZ=s("knYB"),oZ=s("kWKb");function cZ(e){const{message:t}=e,s=t.message,a={},i=s.length,n=JSON.parse(s[0].message.params);if(n.total_item_in_group===i){const e=s.filter((e=>![Y.MSG_UNDO,Y.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(x_.i)(e)));e.forEach((t=>{Object(ge.c)(t,ge.a.UserAction);const s=ui.default.getConversationType(t.toUid||t.userId),i=new oe.c(oe.a.ChatBoxView).getBuilder().withType(oe.f.Photo).withConvType(oe.b[s]).withMode(oe.e.Manual).withCode(oe.d.CBVMessageAction);e.msgType==Y.MSG_VIDEO&&i.withType(oe.f.Video),a[t.msgId]=i.build()})),ue.a.getInstance().downloadWithMultiSrc("runByMultiMsg",e,{entriesCode:a,saveAs:!0}).then((t=>{e.forEach((e=>{if(e.msgId&&t[e.msgId]){const{downloadError:s,localPath:a}=t[e.msgId]||{};((e,t,s)=>{const a=Date.now();!e&&Ce.default.recent_photo.enableFeature&&ui.default.isWindows()&&Oe.a.setPhotoDownload({isLocalFile:!0,path:s,lastModified:a,name:$znode.path.basename(s),shortenPath:ui.default.getShortenPath(s,40),fromSource:"DownloadedPhoto"})})(s,e.msgId,a)}}))})).catch((e=>{}))}else{const e=s[i-1];Re.default.getGroupPhoto(e.msgId,n.total_item_in_group-i,e.toUid).then((e=>{Array.prototype.push.apply(s,e);const t=s.filter((e=>![Y.MSG_UNDO,Y.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(x_.i)(e)));t.forEach((e=>{Object(ge.c)(e,ge.a.UserAction);const s=ui.default.getConversationType(e.toUid||e.userId),i=new oe.c(oe.a.ChatBoxView).getBuilder().withType(oe.f.Photo).withConvType(oe.b[s]).withMode(oe.e.Manual).withCode(oe.d.CBVMessageAction);t.msgType==Y.MSG_VIDEO&&i.withType(oe.f.Video),a[e.msgId]=i.build()})),ue.a.getInstance().downloadWithMultiSrc("runByMultiMsg",t,{entriesCode:a,saveAs:!0})}))}}function lZ(e){const{message:t}=e;!1!==Array.isArray(t.message)&&(le.b.getStateNetwork()===le.a.CONNECTED?(Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload),Ee.l?function(e){const{message:t}=e;let s="";const a=t.toUid,i=t.message;s=Object(Cu.a)(a)?yn.default.getDName(a):Ii.default.getDName(a),s||(s="");const n=i.filter((e=>![Y.MSG_UNDO,Y.MSG_DEL_EVERYONE].includes(e.msgType)&&!Object(x_.i)(e)));n.forEach((e=>{Object(ge.c)(e,ge.a.UserAction)})),oZ.a.downloadMultiFiles(n,s).catch((e=>{let t=ce.a.str("STR_DOWNLOAD_FAILED_DETAILS");t=e&&"string"==typeof e&&e.startsWith("ERR_")?`${t}: ${e}`:`${t}: ERR_UNKNOWN`,mc.default.createError(t)}))}(e):cZ(e)):mc.default.createError(ce.a.str("STR_TOAST_CONNECTION_FAILED")))}function dZ(e){const{message:t,source:s,windowId:a}=e||{},i=t.toUid;GK.b.downloadMessage(t||{},{src:GK.a.CHAT,targetId:i}),Object(ge.c)(t,ge.a.UserAction),s===qK.a.ContextMenu?(Ia.default.logAction(1063914),Object(xK.a)(10,t)):Ia.default.logAction(106380410),Ce.default.cloud_send2me.enable&&i==Ce.default.sendToMeId&&jw.b.log(jw.a.DOWNLOAD,1,t),Uc.a.addUserAction(a,"Download"),Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload),Ee.l?function(e){const{event:t,message:s}=e||{};Object(fU.downloadWebV2ByMsg)(t,window.document,s,!0),GK.c.log(GK.c.ACT.VIEW,{src:GK.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}(e):function(e){const{message:t}=e||{};if(Ia.default.logAction(1071908),!t.message.oriUrl)return void mc.default.createError(ce.a.str("STR_TOAST_DOWNLOAD_FAILED"));const{manualDownloadMediaDoneHandler:s}=Object(q.c)();Object(KK.a)(t,Ar.c,{actions:s,entryType:oe.f.Video,additional:{type:tt.default.constants.DownloadType.Video}})}(e)}function uZ(e){const{event:t,message:s}=e||{};Object(fU.downloadWebV2ByMsg)(t,window.document,s,!0),GK.c.log(GK.c.ACT.VIEW,{src:GK.c.SRC.CHAT,targetId:s.toUid,key:s.msgId})}function hZ(e){const{message:t,source:s,windowId:a}=e||{};if(t.msgType===Y.MSG_VIDEO)return void dZ(e);const i=t.toUid;GK.b.downloadMessage(t||{},{src:GK.a.CHAT,targetId:i}),Object(ge.c)(t,ge.a.UserAction),s===qK.a.ContextMenu?(Ia.default.logAction(1063914),Object(xK.a)(10,t)):Ia.default.logAction(106380410),Ce.default.cloud_send2me.enable&&i==Ce.default.sendToMeId&&jw.b.log(jw.a.DOWNLOAD,1,t),Uc.a.addUserAction(a,"Download");const n=[Y.MSG_PHOTO,Y.MSG_PHOTO_2].some((e=>e===t.msgType));Si.a.emitWithKey(Ci.d.userOnNewDeviceTracking,Ci.d.mediaDownload),Ee.l||n&&!Object(he.a)()?uZ(e):function(e){const{message:t}=e||{};if(Ia.default.logAction(1071908),!t.message.oriUrl)return void mc.default.createError(ce.a.str("STR_TOAST_DOWNLOAD_FAILED"));const{manualDownloadMediaDoneHandler:s}=Object(q.c)();Object(KK.a)(t,Ar.c,{actions:s,entryType:oe.f.Photo,additional:{type:tt.default.constants.DownloadType.Photo}})}(e)}const gZ={ok:!1,messages:[]};function mZ(e,t){var s;const{detail:a,event:i,isMultiSelectOn:n,message:r}=e||{};if(!i||n||!r)return[];const{captionContainerElementId:o=""}=a||{};let c;const l=null!==(s=i.currentTarget)&&void 0!==s?s:i._currentTarget;(function(e){const{message:t}=e||{};return!(!t||Ee.l)&&!Object(x_.t)(t)&&!Object(x_.l)(t)&&!Object(x_.v)(t)&&!Object(x_.n)(t)&&!Object(x_.W)(t)&&Object(nZ.a)(t)})({message:r})&&(null!=l&&l.id&&(null==l?void 0:l.id)===o||(c=new zK.CopyPhotoMenuItem));let d,u,h=null;if(r.message.title){const e=i.view,t=XK(o,e);if(t)"string"==typeof t?h=new zK.CopySelectedContentMenuItem(t):"function"==typeof t&&(h=new zK.CopySelectedContentMenuItem(""),h.setHandler((()=>{const s=t(e);s?Object(QK.a)(s):e.document.execCommand("copy"),h.getMenu().close()})));else{const e=i.target;let t;tZ(e)?(t=Object(rZ.a)(e),h=new zK.CopyLinkMenuItem(t)):h=eZ(e)&&(t=e.textContent)?new zK.CopyEmailMenuItem(t):sZ(e)&&(t=e.textContent)?new zK.CopyNumberMenuItem(t):new zK.CopyMessageContentMenuItem(r.message.title)}}return function(e){const{message:t}=e||{};return!!t&&!Object(x_.r)(t)&&!Object(x_.n)(t)&&!Object(x_.K)(t)&&Object(HK.a)(t)}({message:r})&&(d=new zK.SavePhotoToDeviceMenuItem,d.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=d.getMenu())||void 0===s||s.close();const a=d.getWindowId();hZ(Object(I.a)(Object(I.a)({},e),{},{windowId:a}))}catch(CY){}}))),[c,h,d,u].filter(Boolean)}function pZ(e,t){const{event:s,isMultiSelectOn:a,message:i}=e||{};if(!s||a||!i)return[];let n;const r=function(e){if(!e)return gZ;if(e.message.length<=0)return gZ;if(!0===Boolean(Object(iZ.e)(e.message)))return gZ;if(!1===Object(iZ.b)(e.message))return gZ;const t=Object(iZ.g)(e.message);return 0===t.length?gZ:{ok:!0,messages:t}}(i);return!0===r.ok&&(n=new zK.SaveGroupPhotoToDeviceMenuItem(r.messages.length),n.setHandler((()=>{var t;null===(t=n.getMenu())||void 0===t||t.close();try{lZ(e)}catch(CY){}}))),[n].filter(Boolean)}ie.a.register(hT.e.Photo,((e,t,...s)=>{const{event:a,message:i}=e||{};return a?i.msgType===Y.MSG_PHOTO_GROUP&&Array.isArray(i.message)?pZ(e):mZ(e):[]})),ie.a.register(hT.e.AISticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(hT.e.NewFSSticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(hT.e.PhotoSticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(hT.e.NoBorderPhotoSticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(hT.e.Sticker,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};if(!a||i||null==n||!n.message)return[];const r=[];return[Y.MSG_STICKER,Y.MSG_STICKER_2].includes(n.msgType)&&null!=n.message.catId&&r.push(new zK.ViewStickerSetMenuItem),r})),ie.a.register(hT.e.StickerGroup,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};if(!a||i||null==n||!n.message)return[];const r=[],o=1===n.message.length?n.message[0]:null;if(o&&[Y.MSG_STICKER,Y.MSG_STICKER_2].includes(o.msgType)&&null!=o.message.catId){const e=new zK.ViewStickerSetMenuItem;e.getBuilder().fromMessage(o),r.push(e)}return r})),ie.a.register(hT.e.StickerSet,((e,t,...s)=>{const{event:a,isMultiSelectOn:i,message:n}=e||{};return[]})),ie.a.register(hT.e.Text,((e,t)=>{const{event:s,isMultiSelectOn:a,message:i}=e||{};if(!s||a||!i)return[];const n=(null==t?void 0:t.getAttribute("id"))||"";let r=null;const o=s.view,c=XK(n,o);if(c)"string"==typeof c?r=new zK.CopySelectedContentMenuItem(c):"function"==typeof c&&(r=new zK.CopySelectedContentMenuItem(""),r.setHandler((()=>{const e=c(o);e?Object(QK.a)(e):o.document.execCommand("copy"),r.getMenu().close()})));else{const e=s.target;let t;tZ(e)?(t=Object(rZ.a)(e),r=new zK.CopyLinkMenuItem(t)):eZ(e)&&(t=e.textContent)?r=new zK.CopyEmailMenuItem(t):sZ(e)&&(t=e.textContent)?r=new zK.CopyNumberMenuItem(e.textContent):Object(x_.F)(i)?(r=new zK.CopyMessageContentMenuItem(""),r.setHandler((()=>{var e;let t="",s=document.getElementById(Y.MSG_TEXT_CONTENT_ID_PREFIX+i.msgId);s&&(t=s.outerHTML),Object(QK.a)(null===(e=i.message)||void 0===e?void 0:e.title,t)}))):(t=i.message,r=new zK.CopyMessageContentMenuItem(t))}return[r].filter(Boolean)}));var fZ=s("+ed7");class vZ extends fZ.a{constructor(e){super(e)}}var _Z=vZ;ie.a.register(hT.e.Video,((e,t)=>{const{detail:s,event:a,isMultiSelectOn:i,message:n}=e||{};if(!a||i||!n)return[];let r;r=null!=n.UIContent?n.UIContent.caption:n.message.title;let o=null;if(r){const{captionContainerElementId:e=""}=null!=s?s:{},t=a.view,i=XK(e,t);if(i)"string"==typeof i?o=new zK.CopySelectedContentMenuItem(i):"function"==typeof i&&(o=new zK.CopySelectedContentMenuItem(""),o.setHandler((()=>{const e=i(t);e?Object(QK.a)(e):t.document.execCommand("copy"),o.getMenu().close()})));else{const e=a.target;let t;tZ(e)?(t=Object(rZ.a)(e),o=new zK.CopyLinkMenuItem(t)):o=eZ(e)&&(t=e.textContent)?new zK.CopyEmailMenuItem(t):sZ(e)&&(t=e.textContent)?new zK.CopyNumberMenuItem(t):new zK.CopyMessageContentMenuItem(n.message.title)}}let c=null;return function(e){const{message:t}=e||{};return!!t&&!Object(x_.r)(t)&&!Object(x_.K)(t)&&Object(HK.a)(t)}({message:n})&&(c=new _Z,c.setHandler((t=>{try{var s;null==t||t.stopPropagation(),null===(s=c.getMenu())||void 0===s||s.close();const a=c.getWindowId();dZ(Object(I.a)(Object(I.a)({},e),{},{windowId:a}))}catch(CY){}}))),[o,c].filter(Boolean)})),ie.a.register(hT.e.Voice,((e,t)=>{const{isMultiSelectOn:s}=e;return[]}));var bZ,IZ=s("dBRD");Object(a.injectable)()(bZ=Object(xi.b)(IZ.b)(bZ=Reflect.metadata("design:type",Function)(bZ=Reflect.metadata("design:paramtypes",[])(bZ=class{constructor(){this.justAddedMessagesOfConvStateMap_=new Map,this.isDevEnv_=void 0,this.separator_="<|>",this.name=IZ.a,this.type=void 0,this.key="",this.isDevEnv_=!1}addJustAddedMessage(e,t,s=!0){if(!e)return;if(!t)return;const a=Array.isArray(t)?t:[t],i={};for(let n=a.length-1;n>=0;n--){const e=a[n],t=J.p.getSessionUserId()===e.fromUid?"0":e.fromUid,s=this.buildJustAddedMessageStateKey({fromUid:t,toUid:e.toUid,cliMsgId:e.cliMsgId});s&&(i[s]={fromUid:t,toUid:e.toUid,cliMsgId:e.cliMsgId,src:e.src})}this.justAddedMessagesOfConvStateMap_.set(e,{convId:e,aSet:i}),s&&Object(nc.h)(this.name,this.key)}isJustAddedMessage(e){if(!e)return!1;const t=this.getConvIdFromThreeKeyMsgId(e);if(!t)return!1;const s=this.justAddedMessagesOfConvStateMap_.get(t);return!(!s||!s.aSet)&&null!=s.aSet[e]}removeJustAddedMessage(e,t=!0){if(!e)return;const s=this.getConvIdFromThreeKeyMsgId(e),a=this.justAddedMessagesOfConvStateMap_.get(s);if(!a||!a.aSet[e])return;const i=Object(I.a)({},a.aSet);delete i[e],this.justAddedMessagesOfConvStateMap_.set(s,{convId:s,aSet:i}),t&&Object(nc.h)(this.name,e)}getJustAddedMessageList(e){const t=this.getASetOfJustAddedMessage(e);return Object.values(t)}getASetOfJustAddedMessage(e){if(!e)return{};const t=this.justAddedMessagesOfConvStateMap_.get(e);return t&&t.aSet?t.aSet:{}}buildJustAddedMessageStateKey(e){return e&&null!=e.fromUid&&null!=e.toUid&&null!=e.cliMsgId?[e.fromUid,e.toUid,e.cliMsgId].join(this.separator_):""}getConvIdFromThreeKeyMsgId(e){if(!e)return"";return e.split(this.separator_)[1]}init(){}getItem(e){const t=e.key;if(t)return this.justAddedMessagesOfConvStateMap_.get(t)}getList(e){return[]}onGetItemFailure(e,t){this.isDevEnv_}onGetListFailure(e,t){this.isDevEnv_}})||bZ)||bZ)||bZ);var yZ=s("bUFI");const SZ="z_chatbg_reset";var CZ;Object(a.singleton)(yZ.a)(CZ=Object(m.j)()(CZ=class{onStart(){this.switchDefaultOffBgChat()}switchDefaultOffBgChat(){const e=n.default.getInstance();if(!e.getItemForCurrentUser(SZ)){this.isUseChatBackground()&&(Me.g.setUseChatBg(J.p.getSessionUserId(),!1),_e.default.send(ve.GeneralActions.CHANGE_BG_CHAT,!1)),e.setItemForCurrentUser(SZ,"1")}}isUseChatBackground(){const e=J.p.getSessionUserId();return Boolean(Me.g.useChatBg(e))}})||CZ);var EZ=s("uPsl");class OZ{constructor(){this.onDeleteMessage=this.onDeleteMessage.bind(this),this.registerEvents()}dispose(){}static create(){return new OZ}static getInstance(){return OZ.instance||(OZ.instance=OZ.create()),OZ.instance}registerEvents(){hi.a.instance.on("delete-message-only-me",this.onDeleteMessage)}cancelUpload(e){EZ.a.emit("cancel-upload",e)}onDeleteMessage(e){if(e.type===ve.ChatBoxActions.DELETE_MESSAGE){const{payload:t}=e;if(Array.isArray(t.messages)){const e=new Set;t.messages.forEach((t=>{t&&t.cliMsgId&&("file"===t.mediaType||"image"===t.mediaType)&&e.add(t.cliMsgId)})),e.size>0&&Array.from(e).forEach((e=>{this.cancelUpload(e)}))}}}}OZ.instance=void 0,OZ.create();var MZ=s("+pEX"),TZ=s("AWVP"),RZ=s("Iq7B");class wZ{constructor(e,t,s,a,i){this.name=void 0,this.code=void 0,this.data=void 0,this.message=void 0,this.details=void 0,this.name=e,this.code=t,this.message=s,this.details=a,this.data=i,Object(MZ.a)().error(`${this.name}[${this.code}]:${this.message}`,this.details)}}class LZ extends wZ{constructor(e,t,s){super("HttpApiError",TZ.e.HTTP_API,e,s),this.data=void 0,this.data=t}}class DZ{async sendSeenSubChatTab(e){try{const t=H.b.getChatDomain(),s=RZ.b,a=`${t}${s}${`?${this.getCommonParams_()}`}`,i=Lo.a.newReq(),n={msgInfos:JSON.stringify({seens:e}),imei:_l.a.getZaloClientID()},r=`params=$${this.encodeParams_(n)}`,o=await So.default._post(a,r,{retry:0},RZ.a,void 0,!1,i),c=await Object(Co.a)(o),{status:l}=null!=c?c:{};return TZ.b.Success(0==l)}catch(i){var t,s,a;const e={status:null==i?void 0:i.status,errorCode:null!==(t=null==i?void 0:i.error_code)&&void 0!==t?t:null==i?void 0:i.code,message:null!==(s=null!==(a=null==i?void 0:i.error_message)&&void 0!==a?a:null==i?void 0:i.message)&&void 0!==s?s:""};return TZ.b.Failure(new LZ("Cannot send seen sub chat tab.",e,e))}}getCommonParams_(){return So.default._getCommonParams()}encodeParams_(e){return So.default._encodeParams(e)}}class AZ extends wZ{constructor(e,t,s){super("WSSApiError",TZ.e.WSS_API,e,s),this.data=void 0,this.data=t}}class FZ{async getLastSeenSubChatTab(e){const t={subtabs:e};try{const e=await Ty.a.instance().requestAsyncV2({cmd:Ru.j.GET_LAST_SEEN_SUB_CHAT_TAB,subCmd:0,data:{data:t}});if(0!=e.error_code){const s={errorCode:e.error_code,message:e.error_message},a=Object(I.a)(Object(I.a)({},s),{},{params:JSON.stringify(t)}),i="Cannot get last seen sub chat tab.";return TZ.b.Failure(new AZ(i,s,a))}return TZ.b.Success({clearUnreadInfo:e.data.clearUnreadInfo})}catch(n){var s,a,i;const e={errorCode:null!==(s=null==n?void 0:n.error_code)&&void 0!==s?s:null==n?void 0:n.code,message:null!==(a=null!==(i=null==n?void 0:n.error_message)&&void 0!==i?i:null==n?void 0:n.message)&&void 0!==a?a:""},r=Object(I.a)(Object(I.a)({},e),{},{params:JSON.stringify(t)}),o="Cannot get last seen sub chat tab.";return TZ.b.Failure(new AZ(o,e,r))}}}var kZ,NZ=s("1HgD"),PZ=s("Ui4J");Object(a.injectable)()(kZ=Object(a.singleton)(NZ.a)(kZ=Reflect.metadata("design:type",Function)(kZ=Reflect.metadata("design:paramtypes",[])(kZ=class{constructor(){this.httpApi_=void 0,this.wssApi_=void 0,this.currentSyncSeenSubtabReq_=null,this.httpApi_=new DZ,this.wssApi_=new FZ,My.default.getChatHandler().subcribe(Ru.b.ON_DONE_OFFLINE,this.pullOfflineLastSeenSubChatTabIfNeeded_.bind(this))}sendSeenSubChatTab_(e,t){let s=!1;const a=null==t?void 0:t.signal;return a&&a.addEventListener("abort",(()=>s=!0)),new Promise(((t,a)=>{const i=PZ.a(),n=Object(af.a)((async()=>{const t=await this.httpApi_.sendSeenSubChatTab(e);return"error"===t.type?Promise.reject(t.data):Promise.resolve(t.data)}),{min:i.min,max:i.max,step:i.step,retries:i.retries,shouldRetryOnError:({error:e})=>new Promise((t=>{var a;if(s)return t(!1);if(!e)return t(!1);const i=null===(a=e.data)||void 0===a?void 0:a.errorCode;if(-69===i)return t(!1);return[Y.NetWorkError.NO_NETWORK,Y.NetWorkError.TIMEOUT,Y.NetWorkError.TIMEOUT_SENT].includes(i)?t(!0):t(111!==i)}))});n().then((e=>{t(TZ.b.Success(e))})).catch((e=>{t(TZ.b.Failure(e))}))}))}syncSeenSubChatTab(e){const t={abortController:new AbortController,payload:{seens:e}};if(this.currentSyncSeenSubtabReq_){const s=this.currentSyncSeenSubtabReq_,a=[...s.payload.seens,...e].reduce(((e,t)=>{const s=t.sct+"_"+t.id;if(e[s]=t,e[s]){const a=e[s],i=t.msgId>a.msgId?t.msgId:a.msgId;e[s]=Object(I.a)(Object(I.a)({},t),{},{msgId:i})}else e[s]=t;return e}),Object.create(null));t.payload.seens=Object.values(a),s.abortController.abort()}this.currentSyncSeenSubtabReq_=t,this.sendSeenSubChatTab_(t.payload.seens,{signal:t.abortController.signal}).finally((()=>{this.currentSyncSeenSubtabReq_===t&&(this.currentSyncSeenSubtabReq_=null)}))}onReceiveSeenSubChatTab_(e,t=TZ.a.Unknown){Object(MZ.a)().info(`[${t}] Receive seen sub chat tab.`,{seens:e});const s=a.ModuleContainer.resolve(bc.TUnreadSubChatTabStateManager),i=e.map((e=>({type:+e.idTo,msgId:e.lastMsgId})));s.onReceiveSeenSubChatTab(i)}async pullOfflineLastSeenSubChatTabIfNeeded_({msgId:e,msgKey:t}){if(Object(MZ.a)().info("[PullOffline] Start sync when done offline.",{msgId:e,msgKey:t},1),Ce.default.socket.enable_ctrl_socket){const t=e||null,s=a.ModuleContainer.resolve(bc.TUnreadSubChatTabStateManager).getAllSubChatTabsNeedPullLastSeenWhenPullOfflineDone(t);if(!s.length)return;const i=s.map((e=>({sct:TZ.c.SubChatTab,id:e}))),n=await this.wssApi_.getLastSeenSubChatTab(i);"success"===n.type?this.onReceiveSeenSubChatTab_(n.data.clearUnreadInfo,TZ.a.Wss_PullOffline):Object(MZ.a)().error("[PullOffline] Cannot get last seen sub chat tab.")}else Object(MZ.a)().info("[PullOffline] Socket is not enabled. -> Skip.")}onReceiveSeenSubChatTabFromCtrl(e){this.onReceiveSeenSubChatTab_(e,TZ.a.Wss_Response)}})||kZ)||kZ)||kZ);var jZ=s("TtB7"),UZ=s("BjT2");const BZ="s_s_m_prxk",zZ="l_r_m_i";class GZ{constructor(){this.seenMilestoneAtSubtab_={[TZ.d.ARCHIVED]:void 0,[TZ.d.FOCUSED]:void 0},this.lastReceivedMsgInfoAtSubtab_={[TZ.d.ARCHIVED]:void 0,[TZ.d.FOCUSED]:void 0}}setNewSeenMilestone(e,t){this.seenMilestoneAtSubtab_[e]=t;const s=n.default.getInstance(),a=`${BZ}::${e}`;s.setItemForCurrentUser(a,t)}getLastSeenMilestone(e){var t;let s=this.seenMilestoneAtSubtab_[e];if(null!=s)return s;const a=n.default.getInstance(),i=`${BZ}::${e}`;return s=null!==(t=a.getItemForCurrentUser(i))&&void 0!==t?t:"",this.seenMilestoneAtSubtab_[e]=s,s}setNewReceivedMsgInfo(e,t){this.lastReceivedMsgInfoAtSubtab_[e]=Object(I.a)({},t);const s=n.default.getInstance(),a=`${zZ}::${e}`;s.setItemForCurrentUser(a,JSON.stringify(t))}getLastReceivedMsgInfo(e){var t,s;if(null!=this.lastReceivedMsgInfoAtSubtab_[e])return this.lastReceivedMsgInfoAtSubtab_[e];const a=n.default.getInstance(),i=`${zZ}::${e}`,r=null!==(t=a.getItemForCurrentUser(i))&&void 0!==t?t:"";return r?(this.lastReceivedMsgInfoAtSubtab_[e]=null!==(s=JSON.parse(r))&&void 0!==s?s:{convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e]):(this.lastReceivedMsgInfoAtSubtab_[e]={convId:"",msgId:""},this.lastReceivedMsgInfoAtSubtab_[e])}}var xZ,VZ=s("7l8h");Object(xi.b)(UZ.b)(xZ=function(e,t){return Object(a.inject)(VZ.c)(e,void 0,0)}(xZ=function(e,t){return Object(a.inject)(m.a)(e,void 0,1)}(xZ=Reflect.metadata("design:type",Function)(xZ=Reflect.metadata("design:paramtypes",["undefined"==typeof IUnreadSubChatTabNetworkService?Object:IUnreadSubChatTabNetworkService,"undefined"==typeof BaseApplication?Object:BaseApplication])(xZ=class{constructor(e,t){this.unreadSubChatTabStateStore_=void 0,this.storage_=void 0,this.networkService_=void 0,this.key=jZ.a,this.name=UZ.a,this.storage_=new GZ,this.networkService_=e,this.handleReceiveLatestMessage=this.handleReceiveLatestMessage.bind(this),this.handleReceiveLatestMessage_=this.handleReceiveLatestMessage_.bind(this),this.handleChangeSubtab=this.handleChangeSubtab.bind(this),this.hasUnreadSubChatTab=this.hasUnreadSubChatTab.bind(this),this.handleDisplayMessageTab=this.handleDisplayMessageTab.bind(this),this.handleHideMessageTab=this.handleHideMessageTab.bind(this),this.handleUpdateArchivedChat=this.handleUpdateArchivedChat.bind(this),this.handleMoveConvFromHiddenToArchivedChat=this.handleMoveConvFromHiddenToArchivedChat.bind(this),this.handleShowReddotsAtSubChatTab=this.handleShowReddotsAtSubChatTab.bind(this),t.addEventListener(m.b.Idle,this.handleMainApplicationInBackground_.bind(this)),t.addEventListener(m.b.Active,this.handleMainApplicationInForeground_.bind(this))}handleReceiveLatestMessage(e){e&&e.convId&&this.isRightMsgIdString_(e.msgId)?this.handleReceiveLatestMessage_(e):Object(MZ.a)().error("[Event] Receive latest message - Invalid info.",{info:e},1)}handleReceiveLatestMessage_(e){const{convId:t,msgId:s}=e,a=this.getSubtabTypeOfConv(t);if(!this.isValidSubChatTabType(a))return;const i=this.getLastReceivedMsgInfo_(a);(!i.msgId||i.msgId<s)&&this.saveNewReceivedMsgInfo_(a,{convId:t,msgId:s})}getSubtabTypeOfConv(e){let t=TZ.d.NONE;return _c.a.isArchivedChat(e)?t=TZ.d.ARCHIVED:In.a.isThreadHidden(e)||(t=TZ.d.FOCUSED),t}handleShowReddotsAtSubChatTab(e){const t=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);this.getAllValidSubtabs().forEach((s=>{if(t===s)return;const a=this.hasUnreadSubChatTab(s),i=e[s];if(a!==i){let e=this.getUnreadSubChatTabStateStore_()[s];e=Object(I.a)(Object(I.a)({},e),{},{hasUnread:i}),this.getUnreadSubChatTabStateStore_()[s]=e,Object(nc.h)(this.name,this.key)}}))}handleMoveConvFromHiddenToArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,TZ.d.ARCHIVED)}handleUpdateArchivedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,TZ.d.ARCHIVED)}handleMoveConvToArchiveChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,TZ.d.ARCHIVED)}handleMoveConvToFocusedChat(e){this.updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,TZ.d.FOCUSED)}handleChangeSubtab(e,t){const s={fromSubtab:e,toSubtab:t};Object(MZ.a)().info("[Event] Change subtab.",s);const a=[];if(this.isValidSubChatTabType(t)){const e=this.getLastReceivedMsgInfo_(t);if(e.msgId){let s=this.getUnreadSubChatTabStateStore_()[t];s=Object(I.a)(Object(I.a)({},s),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[t]=s,this.saveNewSeenMilestone_(t,e.msgId),Object(nc.h)(this.name,this.key),a.push({sct:TZ.c.SubChatTab,msgId:e.msgId,id:t})}}if(this.isValidSubChatTabType(e)){const t=this.getLastReceivedMsgInfo_(e),s=this.getLastSeenMilestone_(e);t.msgId&&t.msgId>s&&(this.saveNewSeenMilestone_(e,t.msgId),a.push({sct:TZ.c.SubChatTab,msgId:t.msgId,id:e}))}a.length&&this.networkService_.syncSeenSubChatTab(a)}handleDisplayMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);if(Object(MZ.a)().info("[Event] Display message tab.",{info:e,enteringSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],a=this.getLastReceivedMsgInfo_(t),i=this.getLastSeenMilestone_(t);if(a.msgId&&a.msgId>i){const e=a.msgId;this.saveNewSeenMilestone_(t,e),s.push({sct:TZ.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}handleHideMessageTab(e){const t=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);if(Object(MZ.a)().info("[Event] Hide message tab.",{info:e,leavingSubtab:t}),!this.isValidSubChatTabType(t))return;const s=[],a=this.getLastReceivedMsgInfo_(t),i=this.getLastSeenMilestone_(t);if(a.msgId&&a.msgId>i){const e=a.msgId;this.saveNewSeenMilestone_(t,e),s.push({sct:TZ.c.SubChatTab,id:t,msgId:e})}s.length&&this.networkService_.syncSeenSubChatTab(s)}updateSeenMilestoneByLastProcessUnreadMsgIdIfNeeded_(e,t){const s=me.a.UnreadDataManager.getUnreadByConvIdSync(e);if(!s)return;const a=s.lastProcessMsgId;if(!a)return;const i=this.getLastSeenMilestone_(t);i&&i>=a||this.saveNewSeenMilestone_(t,a)}handleMainApplicationInForeground_(){const e=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);if(Object(MZ.a)().info(`[Event] Main application in foreground - enteringSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.getLastReceivedMsgInfo_(e),a=this.getLastSeenMilestone_(e);if(s.msgId&&s.msgId>a){const a=s.msgId;this.saveNewSeenMilestone_(e,a),t.push({sct:TZ.c.SubChatTab,id:e,msgId:a})}t.length&&this.networkService_.syncSeenSubChatTab(t)}handleMainApplicationInBackground_(){const e=this.convetFilterTypeToSubChatTabType(me.a.ConvListController.getCurrentFilter().type);if(Object(MZ.a)().info(`[Event] Main application in background - leavingSubtab: ${e}`),!this.isValidSubChatTabType(e))return;const t=[],s=this.getLastReceivedMsgInfo_(e),a=this.getLastSeenMilestone_(e);if(s.msgId&&s.msgId>a){const a=s.msgId;this.saveNewSeenMilestone_(e,a),t.push({sct:TZ.c.SubChatTab,id:e,msgId:a})}t.length&&this.networkService_.syncSeenSubChatTab(t)}onReceiveSeenSubChatTab(e){e.forEach((({type:e,msgId:t})=>{if(this.isValidSubChatTabType(e)){const s=t,a=this.getLastSeenMilestone_(e);if(s&&s>a){let t=this.getUnreadSubChatTabStateStore_()[e];t=Object(I.a)(Object(I.a)({},t),{},{hasUnread:!1}),this.getUnreadSubChatTabStateStore_()[e]=t,this.saveNewSeenMilestone_(e,s),Object(nc.h)(this.name,this.key)}}}))}hasUnreadSubChatTab(e){var t;return!!this.isValidSubChatTabType(e)&&(null!==(t=this.getUnreadSubChatTabStateStore_()[e].hasUnread)&&void 0!==t&&t)}isValidSubChatTabType(e){return this.getAllValidSubtabs().includes(e)}convetFilterTypeToSubChatTabType(e){return e===ii.d.FOCUSED?TZ.d.FOCUSED:e===ii.d.ARCHIVED?TZ.d.ARCHIVED:TZ.d.NONE}getAllSeenMilestones(){return this.getAllValidSubtabs().reduce(((e,t)=>(e[t]=this.getLastSeenMilestone_(t),e)),{})}getAllValidSubtabs(){return[TZ.d.FOCUSED,TZ.d.ARCHIVED]}getAllSubChatTabsNeedPullLastSeenWhenPullOfflineDone(e){const t=[];return this.getAllValidSubtabs().forEach((s=>{(e||this.hasUnreadSubChatTab(s))&&t.push(s)})),t}getUnreadSubChatTabStateStore_(){return this.unreadSubChatTabStateStore_||(this.unreadSubChatTabStateStore_=this.getAllValidSubtabs().reduce(((e,t)=>(e[t]={type:t,hasUnread:!1},e)),{})),this.unreadSubChatTabStateStore_}isRightMsgIdString_(e){return!!e&&("string"==typeof e&&!e.includes("object"))}saveNewSeenMilestone_(e,t){this.isValidSubChatTabType(e)?this.isRightMsgIdString_(t)?this.storage_.setNewSeenMilestone(e,t):Object(MZ.a)().error("[SaveNMS] Invalid newMilestone.",{newMilestone:t},1):Object(MZ.a)().error("[SaveNMS] Invalid subchat tab type.",{type:e},1)}getLastSeenMilestone_(e){if(!this.isValidSubChatTabType(e))return"";let t=this.storage_.getLastSeenMilestone(e);return t&&!this.isRightMsgIdString_(t)&&(Object(MZ.a)().error("[GetLSM] Get invalid milestone.",{milestone:t},1),t="",this.storage_.setNewSeenMilestone(e,t)),t}saveNewReceivedMsgInfo_(e,t){this.isValidSubChatTabType(e)?t&&t.convId&&this.isRightMsgIdString_(t.msgId)?this.storage_.setNewReceivedMsgInfo(e,t):Object(MZ.a)().error("[SaveNRMI] Invalid msgId.",{info:t},1):Object(MZ.a)().error("[SaveNRMI] Invalid subchat tab type.",{type:e},1)}getLastReceivedMsgInfo_(e){if(!this.isValidSubChatTabType(e))return{convId:"",msgId:""};let t=this.storage_.getLastReceivedMsgInfo(e);return t.msgId&&!this.isRightMsgIdString_(t.msgId)&&(Object(MZ.a)().error("[GetLRMI] Get invalid msgId.",{lastReceivedMsgInfo:t},1),t={convId:"",msgId:""},this.storage_.setNewReceivedMsgInfo(e,t)),t}init(){}getItem(e){if(e.key===this.key)return this.unreadSubChatTabStateStore_}getList(e,t){return[]}onGetItemFailure(e,t){0}onGetListFailure(e,t){0}})||xZ)||xZ)||xZ)||xZ);s("UCdJ");var HZ,WZ=s("qhMx"),qZ=s("wKHS");Object(m.j)()(HZ=Object(m.h)()(HZ=Object(a.singleton)(WZ.RRCConfig)(HZ=Reflect.metadata("design:type",Function)(HZ=Reflect.metadata("design:paramtypes",[])(HZ=class{constructor(){this.isAppIdle=void 0,this.changeListeners=void 0,this.onAppIdle=()=>{this.isAppIdle=!0,this.signalConfigChange()},this.onAppActive=()=>{this.isAppIdle=!1,this.signalConfigChange()},this.isAppIdle=!1,this.changeListeners=[]}signalConfigChange(){for(const e of this.changeListeners)try{e(this.getConfig())}catch{}}onStart(){const e=a.ModuleContainer.resolve(m.a);e.addEventListener(m.b.Idle,this.onAppIdle),e.addEventListener(m.b.Active,this.onAppActive)}onDispose(){const e=a.ModuleContainer.resolve(m.a);e.removeEventListener(m.b.Idle,this.onAppIdle),e.removeEventListener(m.b.Active,this.onAppActive)}getConfig(){const e={enable:Ce.default.redundant_res_cleanup.enable,enableForZCloud:Ce.default.redundant_res_cleanup.enable_for_zcloud,forceRun:Ce.default.redundant_res_cleanup.version,deleteStatCache:Ce.default.redundant_res_cleanup.del_stat_cache,enableDelete:Ce.default.redundant_res_cleanup.enable_del,collectGeneratedJPG:Ce.default.redundant_res_cleanup.collect_gen_jpg,batchSize:Ce.default.redundant_res_cleanup.batch_size,batchDelay:Ce.default.redundant_res_cleanup.batch_delay,batchConv:Ce.default.redundant_res_cleanup.batch_conv,startDelay:Ce.default.redundant_res_cleanup.start_delay,scheduleDelay:Ce.default.redundant_res_cleanup.schedule_delay,retryDelay:Ce.default.redundant_res_cleanup.retry_delay,expiredCacheTime:Ce.default.redundant_res_cleanup.expired_cache_time};return this.isAppIdle&&(e.batchSize=Ce.default.redundant_res_cleanup.batch_size_idle,e.batchDelay=Ce.default.redundant_res_cleanup.batch_delay_idle),e}subscribeChange(e){this.changeListeners.push(e)}unsubscribeChange(e){const t=this.changeListeners.indexOf(e);t>=0&&this.changeListeners.splice(t,1)}handleServerConfig(e){const t=new ee.a({enable:ee.b.field().oneOf([0,1,!0,!1]),enable_for_zcloud:ee.b.field().oneOf([0,1,!0,!1]),version:ee.b.field().number(),del_stat_cache:ee.b.field().oneOf([0,1,!0,!1]),enable_del:ee.b.field().oneOf([0,1,!0,!1]),collect_gen_jpg:ee.b.field().oneOf([0,1,!0,!1]),batch_size:ee.b.field().number().min(1).max(1e4),batch_delay:ee.b.field().number().min(0),batch_conv:ee.b.field().number().min(1),batch_size_idle:ee.b.field().number().min(1).max(1e4),batch_delay_idle:ee.b.field().number().min(0),start_delay:ee.b.field().number().min(0),schedule_delay:ee.b.field().number().min(0),retry_delay:ee.b.field().number().min(0),expired_cache_time:ee.b.field().number().min(0)});Ce.default.redundant_res_cleanup=t.validateWithFallback(e,qZ.a.redundant_res_cleanup,!0),this.signalConfigChange()}})||HZ)||HZ)||HZ)||HZ);var KZ=s("vVAj"),ZZ=s("q8PC"),$Z=s("Tlqd");class QZ extends ep.b{constructor(e){super({type:"REDUNDANT_RES_CLEANUP_START",params:e})}}var YZ,JZ=s("yVfy");Object(a.injectable)()(YZ=Object(m.j)()(YZ=Object(m.h)()(YZ=Object(m.f)()(YZ=Object(m.d)()(YZ=Object(a.singleton)(Xr.RRCController)(YZ=function(e,t){return Object(a.inject)(Xr.RRCConfig)(e,void 0,0)}(YZ=function(e,t){return Object(a.inject)(vm.a)(e,void 0,1)}(YZ=function(e,t){return Object(a.inject)(Fm.a)(e,void 0,2)}(YZ=Reflect.metadata("design:type",Function)(YZ=Reflect.metadata("design:paramtypes",[void 0===Xr.RRCConfig?Object:Xr.RRCConfig,void 0===vm.a?Object:vm.a,Object])(YZ=class extends hs.b{constructor(e,t,s){super(),this.config=e,this.syncMessageController=t,this.messageReadinessController=s,this.task=void 0,this.logger=void 0,this.store=void 0,this.factors=void 0,this.requested=void 0,this.runningMode=void 0,this.handleConfigChange=e=>{if(!e.enable)return this.Logger.zsymb(0,"ogYQp2","config change to OFF -> stop cleanup"),void this.stopCleanup();this.isForceRun(e.forceRun)?this.forceRunCleanup(e.forceRun):this.task&&this.task.changeParams({config:e})},this.handleAppIdle=()=>{this.factors.set({appIdle:!0}),this.requested.has("appIdle")&&(this.requested.remove("appIdle"),this.Logger.zsymb(0,"jHRgwb","app is idle -> trigger requested item"),this.triggerAutoRun())},this.handleAppActive=()=>{this.factors.set({appIdle:!1})},this.handleMessageReadyChange=()=>{const e=this.messageReadinessController.isMessageReadyWithIncludeFlags(Oq|Mq|Tq|Eq);this.factors.set({msgReady:e})},this.handleResMgmtEvents=e=>{e&&(e.payload===kn.m.START_CALCULATE?(this.factors.set({resMgmtIdle:!1}),this.isRunning()&&(this.Logger.zsymb(0,"Tqm9fY","start calc res mgmt -> pause cleanup"),this.pauseCleanup(),this.requested.add("resMgmtIdle"))):e.payload===kn.m.FINISH_CALCULATE&&(this.factors.set({resMgmtIdle:!0}),this.requested.has("resMgmtIdle")&&(this.requested.remove("resMgmtIdle"),this.Logger.zsymb(0,"x9SFGf","finish calc res mgmt -> resume cleanup"),this.triggerAutoRun())))},this.handleSyncMessageStart=()=>{this.isRunning()&&(this.Logger.zsymb(0,"_X-yhw","start sync msg -> stop cleanup"),this.stopCleanup(),this.requested.add("syncMsgIdle"))},this.handleSyncMessageFinish=()=>{this.requested.has("syncMsgIdle")&&(this.requested.remove("syncMsgIdle"),this.Logger.zsymb(0,"mN3ocP","finish sync msg -> restart cleanup"),this.triggerAutoRun())},this.task=null,this.store=new ZZ.a($Z.b),this.factors=new Xr.RRCFactorsStatusRunner({appIdle:!1,msgReady:!1,resMgmtIdle:!0}),this.requested=new Xr.RRCRequestRunner({appIdle:!1,syncMsgIdle:!1,resMgmtIdle:!1,msgReady:!1}),this.runningMode=null}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.redundantResCleanup,["controller"])),this.logger}isAllowRunCleanup(){if(!this.config.getConfig().enable)return this.Logger.zsymb(0,"Ra4m2K","not allow <- config off"),!1;if(!this.config.getConfig().enableForZCloud&&hO.a.getInstance().isPaidUser())return this.Logger.zsymb(0,"KLcVi7","not allow <- config off for zcloud user"),!1;if(this.isRunning())return this.Logger.zsymb(0,"cfCFQ4","not allow <- another is running"),!1;if(!this.factors.get("msgReady"))return this.Logger.zsymb(0,"VSKP3y","not allow <- message not ready"),!1;let e=null;try{const t=this.store.getItemForCurrentUser($Z.a.LAST_STATUS);t&&(e=JSON.parse(t))}catch{e=null}if(!e||"number"!=typeof e.time)return!0;const t=e.success?e.time+this.config.getConfig().scheduleDelay:e.time+this.config.getConfig().retryDelay;return Ct.default.getTimeNow()>=t||(this.Logger.zsymb(0,"4dw5OV","not allow <- not over schedule time"),!1)}getCurrentSessionId(){let e=1;try{const t=this.store.getItemForCurrentUser($Z.a.LAST_STATUS);if(t){const{session_id:s}=JSON.parse(t);s&&!isNaN(+s)&&(e=+s+1)}}catch{e=1}return e}setLastStatus(e){this.store.setItemForCurrentUser($Z.a.LAST_STATUS,JSON.stringify({time:Ct.default.getTimeNow(),success:e?1:0,session_id:this.getCurrentSessionId()}))}isForceRun(e){if(e>0){let t=this.store.getItemForCurrentUser($Z.a.FORCE_RUN);return!(t&&!isNaN(+t))||e>+t}return!1}isNeedResetBeforeRunning(){return!1}isNeedSetErrorStatus(e){return!this.task||!this.task.abortController.signal.aborted&&"WorkerInterrupted"!==(null==e?void 0:e.name)}triggerAutoRun(){if(this.syncMessageController.isThisSessionSyncing())return this.requested.add("syncMsgIdle"),void this.Logger.zsymb(0,"d8g3xr","triggerAutoRun but sync msg is running -> wait finish");if(!this.factors.get("resMgmtIdle"))return this.requested.add("resMgmtIdle"),void this.Logger.zsymb(0,"A43Fc1","triggerAutoRun but calc res mgmt is running -> wait finish");if(!this.factors.get("appIdle"))return this.requested.add("appIdle"),void this.Logger.zsymb(0,"_cjBqA","triggerAutoRun but app is not idle -> wait idle");if(this.isAllowRunCleanup())this.isNeedResetBeforeRunning()&&(this.resetCleanup(),JZ.b.logCleanupResetRun("interval")),this.runningMode="interval",this.runCleanup();else{const e=this.config.getConfig().forceRun;this.isForceRun(e)&&this.forceRunCleanup(e)}}onStart(){this.config.subscribeChange(this.handleConfigChange),a.ModuleContainer.resolve(m.a).addEventListener(m.b.Idle,this.handleAppIdle),a.ModuleContainer.resolve(m.a).addEventListener(m.b.Active,this.handleAppActive),this.messageReadinessController.addEventListener(Xm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleMessageReadyChange),me.a.DiskStatusManager.addEventListener(Fn.ResCalc_Calculate,this.handleResMgmtEvents),this.syncMessageController.addEventListener(Cm.e.ON_START,this.handleSyncMessageStart),this.syncMessageController.addEventListener(Cm.e.ON_RESUME,this.handleSyncMessageStart),this.syncMessageController.addEventListener(Cm.e.ON_RETRY,this.handleSyncMessageStart),this.syncMessageController.addEventListener(Cm.e.ON_SUCCESS,this.handleSyncMessageFinish),this.syncMessageController.addEventListener(Cm.e.ON_FAILED,this.handleSyncMessageFinish)}onAuthenticated(e){this.store.init(e.getSession().userId)}onApplicationReady(){setTimeout((()=>{this.handleMessageReadyChange(),this.triggerAutoRun()}),this.config.getConfig().startDelay)}onDispose(){this.pauseCleanup(),this.config.unsubscribeChange(this.handleConfigChange),a.ModuleContainer.resolve(m.a).removeEventListener(m.b.Idle,this.handleAppIdle),a.ModuleContainer.resolve(m.a).removeEventListener(m.b.Active,this.handleAppActive),this.messageReadinessController.removeEventListener(Xm.c.NO_MISSING_MESSAGE_EVENTS_ARRIVED,this.handleMessageReadyChange),me.a.DiskStatusManager.removeEventListener(Fn.ResCalc_Calculate,this.handleResMgmtEvents),this.syncMessageController.removeEventListener(Cm.e.ON_START,this.handleSyncMessageStart),this.syncMessageController.removeEventListener(Cm.e.ON_RESUME,this.handleSyncMessageStart),this.syncMessageController.removeEventListener(Cm.e.ON_RETRY,this.handleSyncMessageStart),this.syncMessageController.removeEventListener(Cm.e.ON_SUCCESS,this.handleSyncMessageFinish),this.syncMessageController.removeEventListener(Cm.e.ON_FAILED,this.handleSyncMessageFinish)}onCleanupStart(){this.dispatchEvent(new hs.a(Xr.RRCEvents.Start));const e=this.getCurrentSessionId();JZ.a.startScanReport({sessionId:e,triggerType:"forced"===this.runningMode?"forced":"interval"}),this.Logger.zsymb(0,"c92CkH","cleanup start",e,this.runningMode)}onCleanupSuccess(e){const{statsBefore:t,statsDetailBefore:s,statsAfter:a,statsDetailAfter:i,statsFailure:n,statsAccessTime:r}=e,o=this.getCurrentSessionId();t&&s&&a&&i&&JZ.a.completeCleanupReport({sessionId:o,duration:e.duration,interrupt:e.interupted,triggerType:"forced"===this.runningMode?"forced":"interval",statsAfter:a,statsBefore:t,statsDetailAfter:i,statsDetailBefore:s,statsFailure:n,statsAccessTime:r}),this.setLastStatus(!0),this.dispatchEvent(new Xr.RRCSuccessEvent(e)),this.task=null,this.runningMode=null,this.Logger.zsymb(0,"TIV4c8","cleanup success",o)}onCleanupFail(e){const t=this.getCurrentSessionId();this.isNeedSetErrorStatus(e)&&this.setLastStatus(!1),this.dispatchEvent(new Xr.RRCErrorEvent(e)),this.task=null,this.runningMode=null,this.Logger.zsymb(18,"HFheCW","cleanup fail",t,e),e&&"WorkerInterrupted"===e.name&&setTimeout((()=>{this.triggerAutoRun()}),this.config.getConfig().startDelay)}async forceRunCleanup(e){this.Logger.zsymb(0,"dCK0z6","force run cleanup version=",e),this.stopCleanup().then((()=>{this.resetCleanup(),JZ.b.logCleanupResetRun("forced")})).finally((()=>{this.store.setItemForCurrentUser($Z.a.FORCE_RUN,String(e)),this.runningMode="forced",this.runCleanup()}))}async runCleanup(){this.task=new QZ({userId:J.p.getSessionUserId(),config:this.config.getConfig(),maxTimeScan:Ct.default.getTimeNow(),flush:!0,sessionId:this.getCurrentSessionId(),forced:"forced"===this.runningMode}),this.onCleanupStart(),this.task.addEventListenerOnce(KZ.c.Completed,(({result:e})=>{this.onCleanupSuccess(e)})),this.task.addEventListenerOnce(KZ.c.Error,(({error:e})=>{this.onCleanupFail(e)})),this.task.run()}async stopCleanup(){this.task&&(await this.task.abort(),this.dispatchEvent(new hs.a(Xr.RRCEvents.Abort)),this.task=null,this.runningMode=null)}resetCleanup(){this.task||(this.store.removeItemForCurrentUser($Z.a.LAST_STATUS),this.store.removeItemForCurrentUser($Z.a.PROGRESS),this.store.removeItemForCurrentUser($Z.a.PROGRESS_LIMIT),this.store.removeItemForCurrentUser($Z.a.STAGE),this.store.removeItemForCurrentUser($Z.a.TRACKING_DATA))}async pauseCleanup(){this.task&&(this.task.changeParams({flush:!1}),await this.task.abort(),this.dispatchEvent(new hs.a(Xr.RRCEvents.Abort)),this.task=null,this.runningMode=null)}isRunning(){return!!this.task}})||YZ)||YZ)||YZ)||YZ)||YZ)||YZ)||YZ)||YZ)||YZ)||YZ);s("AHxZ");class XZ{constructor(){this.aborted=void 0,this.aborted=!0}}class e${constructor(e,t=[]){this._task=e,this.args=t,this._abortController=void 0,this._aborted=!1,this._fulfilled=!1,this._promise=null,this._abortableTask=void 0,this._taskId=Object(ha.b)(8),this.abort=()=>{this._abortController.abort()},this._abortController=new AbortController,this._abortableTask=(...e)=>new Promise(((t,s)=>{const a=()=>{this._aborted=!0,s(new XZ),this._abortController.signal.removeEventListener("abort",a)};this._abortController.signal.addEventListener("abort",a),this._task(...e).then(t).catch(s).finally((()=>{this._abortController.signal.removeEventListener("abort",a),this._fulfilled=!0}))}))}get aborted(){return this._aborted}get fulfilled(){return this._fulfilled}get promise(){return this._promise||(this._promise=this._abortableTask(...this.args)),this._promise}get taskId(){return this._taskId}set taskId(e){this._taskId=e}}function t$(e,...t){return new e$(e,t)}var s$=s("W0O7"),a$=s("SkSZ");const i$={UNLOAD_ZPOPUP_WINDOW:"UNLOAD_ZPOPUP_WINDOW"};var n$,r$=s("6VRG");Object(a.injectable)()(n$=Object(xi.b)(ga.a)(n$=class{constructor(){this.OPEN_TIMEOUT=1e4,this.CLOSE_TIMEOUT=1e4,this.instances=new Map,this.runningTask=new Map,this._eventEmitter=new Uf.a,this.open=async e=>{const t=e.windowId;Object(ua.a)(!!t,`windowId must be a valid string. Received ${t}`),Object(ua.a)("object"==typeof e.parentWindow,"parentWindow must be a valid window object");const s=this.getOpenTaskId(t),a=this.runningTask.get(s);if(a&&!a.fulfilled)return await a.promise;if(this.instances.has(t)){const e=this.instances.get(t);return this.focus(t),e}const i=t$(this._create,e);i.taskId=s;const n=e.parentWindow.setTimeout((()=>{i.abort(),this.runningTask.delete(s)}),this.OPEN_TIMEOUT),r=()=>{this.runningTask.delete(s),e.parentWindow.clearTimeout(n)};this.runningTask.set(s,i);try{const e=await i.promise;return r(),e}catch(o){throw r(),o}},this.openMediaViewerWindow=async e=>{Object(ua.a)(!!e.windowId,`windowId must be a valid string. Received ${e.windowId}`),Object(ua.a)("object"==typeof e.parentWindow,"parentWindow must be a valid window object");const t=this.getOpenTaskId(e.windowId),s=this.runningTask.get(t);if(s&&!s.fulfilled)return zconsole.zsymb(3,"ksqDbK",["[MVR]:found opening task:lock","-Wm3pm"],e.windowId),await this.runningTask.get(t).promise;if(this.instances.has(e.windowId)){const t=this.instances.get(e.windowId);return this.focus(e.windowId),t}const i=a.ModuleContainer.resolve(da.c).getInfoScreenOfMouse(e.parentWindow),n={min_width_open_window:a$.a.media_viewer.min_width_open_window,min_height_open_window:a$.a.media_viewer.min_height_open_window,max_width_open_window:a$.a.media_viewer.max_width_open_window,max_height_open_window:a$.a.media_viewer.max_height_open_window},r=this._getSavedPopupSize(e.windowId);zconsole.zsymb(12,"uLPILE","[MVR]: open:init savedSize",r);const o=da.d.calculateWindowSizeByScreen(i,n,r),c=da.d.calculatePositionCenterScreen(i,o),l={w:o.w,h:o.h,x:c.x,y:c.y};zconsole.zsymb(12,"u3WX4f","[MVR]: open:init bounds",l),e.onWindowDOMContentLoaded||(e.onWindowDOMContentLoaded=()=>{var t;const s=this.getWindow(e.windowId),a=s.instance;Object(ua.a)(!!a,`zpopupWindow must be a valid object. Received ${s}`),zconsole.info("[MVR]: onWindowDOMContentLoaded",null==a||null===(t=a.document)||void 0===t?void 0:t.readyState),Object(s$.copyStyles)(e.parentWindow.document,a.document)}),e.onWindowLoad||(e.onWindowLoad=()=>{var t;const s=this.getWindow(e.windowId),a=s.instance;Object(ua.a)(!!a,`[MVR]: zpopupWindow must be a valid object. Received ${s}`),zconsole.zsymb(12,"reifZt","[MVR]: onWindowLoad cb"),Object(s$.preventUserAction)(a,!0,this._exitWhenError);const i=a.document.createElement("div");i.id="popup-viewer";const n=a.document.createElement("div");n.id=s.id,i.appendChild(n),a.document.body.appendChild(i),null===(t=a.document.getElementById("app"))||void 0===t||t.remove(),this.data.set(e.windowId,{windowId:e.windowId,ready:!0}),this._signalRenderItem(this.name,e.windowId)}),e.frame||(e.frame=da.d.convertObjectToUrl({left:c.x,top:c.y,width:o.w,height:o.h,availHeight:i.availH,availWidth:i.availW},"?key=media-viewer")),e.specs||(e.specs=da.d.getWindowSpec(l)),e.windowBoundary||(e.windowBoundary=l);try{const t=await this.open(e);return Ei.a.increaseSuccess(Ei.a.duration),t}catch(CY){throw Ei.a.increaseFailed(Ei.a.duration,Ei.a.Code.WindowOpenFailed,Date.now(),[Ei.a.platform]),CY}},this.getWindow=e=>this.instances.get(e)||null,this.close=async e=>{var t;this.emit(i$.UNLOAD_ZPOPUP_WINDOW,{windowId:e});const s=this.getOpenTaskId(e);if(this.runningTask.has(s))return;const a=this.getCloseTaskId(e);if(this.runningTask.has(a))return;const i=this.instances.get(e);if(!i)return zconsole.zsymb(18,"fUeedg","[MVR]: zpopup close failed due to NO WINDOW FOUND"),Promise.resolve();this.savePopupSize(e);const n=t$(i.close);n.taskId=a,this.runningTask.set(a,n);const r=null===(t=i.instance)||void 0===t?void 0:t.setTimeout(n.abort,this.CLOSE_TIMEOUT),o=()=>{var t;this.runningTask.delete(a),null===(t=i.instance)||void 0===t||t.clearTimeout(r),this.instances.delete(e),this.data.delete(e),this._signalRenderItem(this.name,e),zconsole.zsymb(0,"wkW40U",`[MVR]: zpopup: close finished ${e}`)};try{await n.promise,Ei.a.increaseSuccess(Ei.a.duration),o()}catch(c){throw Ei.a.increaseFailed(Ei.a.duration,Ei.a.Code.WindowFailed,Date.now(),[Ei.a.platform]),o(),zconsole.error("[MVR]: zpopup:close error",c),c}},this.focus=async e=>{const t=this.instances.get(e);if(!t)return Promise.resolve();try{await t.focus(),Ei.a.increaseSuccess(Ei.a.duration)}catch(CY){throw Ei.a.increaseFailed(Ei.a.duration,Ei.a.Code.WindowFocusFailed,Date.now(),[Ei.a.platform]),this.instances.delete(e),CY}},this.getOpenTaskId=e=>`open-${e}`,this.getCloseTaskId=e=>`close-${e}`,this._exitWhenError=e=>{zconsole.zsymb(18,"c8DnEg",`[MVR]: zpopup:exitWhenError windowId ${e}`),mc.default.createError(ce.a.str("STR_POPUP_OPEN_ERR")),this.close(e),this.data.delete(e),this._signalRenderItem(this.name,e),Ei.a.increaseFailed(Ei.a.duration,Ei.a.Code.ExitWhenError,Date.now())},this._abortTask=async e=>{const t=this.runningTask.get(e);t?(t.abort(),this.runningTask.delete(e)):zconsole.info(`[MVR]: zpopup:abort open windowId ${e}`)},this._signalRenderItem=(...e)=>{Object(nc.h)(...e)},this._create=async e=>{if(this.instances.has(e.windowId))return this.instances.get(e.windowId);e.onWindowCreated=t=>{this.instances.set(e.windowId,t)};const t=await a.ModuleContainer.resolve(da.c).create(e);if("ERROR"===t.type)throw t;return t.data},this.savePopupSize=e=>{if(r$.MVR_ID_LIST.some((t=>t===e))){const t=this.instances.get(e);if(!t)return;const s=t.getCurrentWindowSizes(),a=n.default.getInstance();if(a&&s)try{const{w:t,h:i}=s;Object(ua.a)("number"==typeof t&&t>0,`width must be a number. Received ${t}`),Object(ua.a)("number"==typeof i&&i>0,`height must be a number. Received ${i}`),zconsole.zsymb(15,"CYFIjQ",["[MVR] savePopupSize: windowId: {}, width: {}, height: {}","YPoFQd"],e,t,i);const n=this._buildPopupSizeKey(e),r=JSON.stringify({width:t,height:i});a.setItemForCurrentUser(n,r)}catch(CY){zconsole.zsymb(21,"DH70dk",["[MVR] error: Cannot save popup size. windowId: {}","ZY2ZhS"],e,CY)}else zconsole.zsymb(21,"wwED7E",["[MVR] Cannot save popup size. secureLocalStorage is not found. windowId: {}","4Rh5zP"],e)}},this._buildPopupSizeKey=e=>`mvr_${e}_size`,this._getSavedPopupSize=e=>{const t=n.default.getInstance();if(t)try{const s=this._buildPopupSizeKey(e),a=t.getItemForCurrentUser(s);if(a){const e=JSON.parse(a);return Object(ua.a)("object"==typeof e,"width must be a number. Received "+typeof e),Object(ua.a)("number"==typeof(null==e?void 0:e.width),`width must be a number. Received ${null==e?void 0:e.width}`),Object(ua.a)("number"==typeof(null==e?void 0:e.height),`height must be a number. Received ${null==e?void 0:e.height}`),{w:e.width,h:e.height}}}catch(CY){zconsole.zsymb(21,"QdWRUa",["[MVR] error: Cannot get popup size. windowId: {}","Blb3k1"],e,CY)}else zconsole.zsymb(21,"FUtjPN",["[MVR] Cannot get popup size. secureLocalStorage is not found. windowId: {}","qxB--X"],e);return null},this.name=ga.b,this.data=new Map,this.key="windowId",this.init=()=>{}}on(e,t){return this._eventEmitter.on(e,t),()=>this._eventEmitter.off(e,t)}off(e,t){this._eventEmitter.off(e,t)}emit(e,t){this._eventEmitter&&e in i$&&this._eventEmitter.emit(e,t)}isValidPhotoViewerWindowId(e){return e===da.a.PHOTO_VIEWER_ID}getItem(e){return this.data.get(e.key)}getList(e){return"all"===e.key?Array.from(this.data.keys()):[]}onGetItemFailure(e){}onGetListFailure(e){}})||n$);var o$,c$=s("RHk6"),l$=s("r06Z");Object(a.singleton)(c$.BankParserController)(o$=class{constructor(){this.logger=void 0}get Logger(){return this.logger||(this.logger=a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(w.ZLoggerNametags.bankParser,["controller"])),this.logger}async createParserTasks(e,t){const s=new Map,a=new Map;for(const i of e){const e=t.get(i);if(!e||!e.length)continue;const n=await Re.default.getMessagesByIds(i,e);for(const t in n){const e=n[t];if(l$.a.isMessageParsable(e)&&e.message){const t=e.cliMsgId,n=Number(e.sendDttm)||Ct.default.getTimeNow(),r=l$.a.formatMessageContent({content:{text:e.message},mentions:e.mentions});if(r){let e=s.get(r);e||(e=l$.a.create(r),s.set(r,e));const o=a.get(r)||[];o.push({clientId:String(t),convId:i,ts:n}),a.set(r,o)}}}}return{parserMapping:s,submitInfoMapping:a}}onForwardMessages(e,t){if(!Array.isArray(e)||!l$.a.enableBankParser())return;const s=Array.isArray(t)?t:[t],a=new Map;for(const{msgId:i,toUid:n}of s){const e=a.get(n)||[];e.push(i),a.set(n,e)}this.createParserTasks(e,a).then((({parserMapping:e,submitInfoMapping:t})=>{e.forEach(((e,s)=>{const a=t.get(s)||[];for(const{clientId:t,ts:i,convId:n}of a)e.submit(t,i,n,ui.default.isGroup(n));e.parse().exec()}))})).catch((t=>{this.Logger.zsymb(18,"7QRyrh","[forward] parse bank failed",e,t)}))}});var d$,u$=s("cO+G"),h$=s("ju6I");let g$=Object(a.injectable)()(d$=Object(m.d)()(d$=function(e,t){return Object(a.inject)(es.ZLoggerFactory)(e,void 0,0)}(d$=function(e,t){return Object(a.inject)(ei)(e,void 0,1)}(d$=Reflect.metadata("design:type",Function)(d$=Reflect.metadata("design:paramtypes",[void 0===es.ZLoggerFactory?Object:es.ZLoggerFactory,"undefined"==typeof ILastOnlineDetector?Object:ILastOnlineDetector])(d$=class extends hs.b{constructor(e,t){super(),this.lastOnlineDetector=t,this.config=void 0,this.isBackOnlineEventFired=!1,this.prevNetworkStatus=null,this.prevUserActiveStatus=null,this.logger=void 0,this.config=u$.a,this.logger=e.createZLogger(w.ZLoggerNametags.offline2Online,["back-to-online-detector"])}onApplicationReady(){this.logger.zsymb(3,"ZiahwQ",["application ready","nYg8KM"]),this.dispatchEventBackToOnline("first-start-app"),this.registerListener()}registerListener(){this.logger.zsymb(3,"Ds6DOq",["register listener","G4Vcek"]),_e.default.subscribe(((e,t)=>{switch(e){case ve.GeneralActions.NETWORK_STATUS:return this.onNetworkStatusChanged(t);case ve.GeneralActions.USER_ACTIVE_CHANGED:return this.onUserActiveChanged(t);case ve.WebsocketActions.CONNECTION_STATE_CHANGE:return this.onWebSocketStateChanged(null==t?void 0:t.state)}}))}onNetworkStatusChanged(e){const t=this.prevNetworkStatus;e!==t&&(this.logger.zsymb(3,"3MJOci",["network status changed, [prev, curr]=[{}, {}]","4JnNMB"],this.prevNetworkStatus,e),this.prevNetworkStatus=e,t!==le.a.CONNECTED&&e===le.a.CONNECTED?this.checkAndDispatchEventIfNeeded():e!==le.a.CONNECTED&&My.default.getSocketState()!==WebSocket.OPEN&&(this.isBackOnlineEventFired=!1))}onUserActiveChanged(e){if(!1===[Hv.c.RESUME,Hv.c.SLEEP].includes(e))return;const t=this.prevUserActiveStatus;e!==t&&(this.logger.zsymb(3,"ax651n",["user active changed, [prev, curr]=[{}, {}]","7kmu7l"],this.prevUserActiveStatus,e),this.prevUserActiveStatus=e,t===Hv.c.SLEEP&&e===Hv.c.RESUME?this.checkAndDispatchEventIfNeeded():e===Hv.c.SLEEP&&(this.isBackOnlineEventFired=!1))}onWebSocketStateChanged(e){if(this.config.nestedKey("back_to_online_detector.enable_detect_session_by_websocket"))switch(e){case WebSocket.OPEN:return void this.dispatchEventBackToOnline("resume-app");case WebSocket.CLOSED:case-1:return void(this.isBackOnlineEventFired=!1)}}checkAndDispatchEventIfNeeded(){if(this.config.nestedKey("back_to_online_detector.enable_detect_session_by_websocket")){switch(Tu.default.getMsgSrcType()){case Y.MsgSources.SOCKET:this.checkWebSocketAndDispatchEventIfNeeded();break;case Y.MsgSources.POLLING:case Y.MsgSources.UNSET:default:this.checkDurationOfflineAndDispatchEventIfNeeded()}}else this.checkDurationOfflineAndDispatchEventIfNeeded()}checkWebSocketAndDispatchEventIfNeeded(){const e=My.default.getSocketState();e!==WebSocket.OPEN?this.dispatchEventBackToOnline("resume-app"):(this.logger.zsymb(3,"-m0_AP",["not need dispatch event resume app, socket state is {}","Og344x"],e),this.isBackOnlineEventFired=!0)}async checkDurationOfflineAndDispatchEventIfNeeded(){const[e,t]=await Promise.all([this.lastOnlineDetector.getStartTsOnlineCurrSession(),this.lastOnlineDetector.getLastTsOnlinePrevSession()]);Math.abs(e-t)>=this.config.nestedKey("back_to_online_detector.max_offline_duration")&&this.dispatchEventBackToOnline("resume-app"),this.isBackOnlineEventFired=!0}dispatchEventBackToOnline(e){this.isBackOnlineEventFired||(this.dispatchEvent(new h$.b(e)),this.isBackOnlineEventFired=!0)}})||d$)||d$)||d$)||d$)||d$)||d$;a.ModuleContainer.registerSingleton(h$.c,g$);let m$=function(e){return e.ON_SUCCESS="onsuccess",e.ON_FAILED="onfailed",e.ON_INTERRUPTED="oninterrupted",e.ON_NONE="onnone",e}({});var p$,f$=s("tzCl");Object(a.singleton)(f$.a)(p$=Reflect.metadata("design:type",Function)(p$=Reflect.metadata("design:paramtypes",[])(p$=class{constructor(){this.refreshed_=!1;const e=null;e&&e.addEventListenerOnce(m$.ON_SUCCESS,this.handleMigrateDriveSuccess_.bind(this))}refreshPhotoStickerLocalFieldsIfNeeded(){if(this.refreshed_)return;const e=null;if(!e)return;e.getMigrateDriveStatusForCurrentSession()===Jr.d.SUCCEED&&(this.refreshPhotoStickerLocalFields_(),this.refreshed_=!0)}handleMigrateDriveSuccess_(){this.refreshed_||(this.refreshPhotoStickerLocalFields_(),this.refreshed_=!0)}refreshPhotoStickerLocalFields_(){const e=Re.default.getRecentMediaItems();if(e&&e.length){let t=!1;const s=a.ModuleContainer.resolve(V_.TAIStickerAppService),i=[];e.forEach((e=>{if($_.a.Helper.isPhotoSticker(e)&&!s.isValidAISticker(e)){const s={localUrl:"",localPreview:"",localPng:""};i.push(Object(I.a)(Object(I.a)({},e),s)),t=!0}else i.push(e)})),t&&Re.default.setRecentMediaItems(i)}}})||p$)||p$);var v$,_$=s("T9Ct");Object(m.j)()(v$=Object(m.h)()(v$=Object(a.singleton)(_$.DraftKeepingManager)(v$=class{constructor(){this.prevStateKeeper=void 0,this.draftInputKeeper=void 0,this.onRequestBackup=()=>{this.getStateKeeper().backup(),this.getDraftInputKeeper().backup()},this.onRequestRestore=()=>{this.getStateKeeper().restore(),this.getDraftInputKeeper().restore()}}onStart(){this.getStateKeeper().init(),this.getDraftInputKeeper().init(),$zresource.onBackupAppState(this.onRequestBackup),$zresource.onRestoreAppState(this.onRequestRestore)}onDispose(){$zresource.removeListenBackupAppState(this.onRequestBackup),$zresource.removeListenRestoreAppState(this.onRequestRestore)}getStateKeeper(){return this.prevStateKeeper||(this.prevStateKeeper=new _$.PreviousStateKeeper),this.prevStateKeeper}getDraftInputKeeper(){return this.draftInputKeeper||(this.draftInputKeeper=new _$.DraftInputKeeper),this.draftInputKeeper}})||v$)||v$);class b${constructor(){this.name=Ga.a,this.key="",this.state={shouldKeepLoadingScreen:!0},this.timer=null}startKeepLoadingIfNeeded(){this.enabled&&this.state.shouldKeepLoadingScreen&&(this.resetTimer(),this.timer=setTimeout((()=>{this.dismissLoadingScreen(),this.timer=null}),this.timeoutDuration))}async dismissLoadingScreen(){await Object(oi.c)(this.delayDuration),this.state.shouldKeepLoadingScreen=!1,Object(nc.h)(this.name,Ga.b),this.resetTimer()}resetTimer(){null!==this.timer&&clearTimeout(this.timer)}get enabled(){return!!u$.a.nestedKey("keep_loading_during_preload.enable")}get timeoutDuration(){return u$.a.nestedKey("keep_loading_during_preload.timeout_duration")}get delayDuration(){return u$.a.nestedKey("keep_loading_during_preload.screen_dismiss_delay")}init(){}getItem(){return this.state}getList(e,t){return[]}onGetItemFailure(e,t){}onGetListFailure(e,t){}}a.ModuleContainer.registerSingleton(Ga.c,b$),a.ModuleContainer.registerSingleton(xi.a,b$),function(){const e=a.ModuleContainer.resolve(rc.ConvListController),t=Qa.a.getInstance();e.addEventListener(ai.c.StateChangedDueToFilterTypeChange,(e=>{t.skipAnimationForSnapshot(e.listFiltered)})),e.addEventListener(ai.c.StateChangedDueToFilterTypeSrcChange,(e=>{t.skipAnimationForSnapshot(e.listFiltered)}))}();var I$=s("ZG3m");const y$={[I$.d]:!1,[I$.e]:3,[I$.b]:!0},S$=new X.ObjectValidator({[I$.d]:X.Rule.field().boolean(),[I$.e]:X.Rule.field().number(),[I$.b]:X.Rule.field().boolean()}),C$=new X.AdvancedRemoteConfigs("reorganize_zalo_chat_data",y$,{validator:S$});var E$=s("Y+p1"),O$=s.n(E$),M$=s("Puqe"),T$=s.n(M$),R$=s("CCM8");const w$={CMD:152711},L$={CMD:152712};class D${static getInstance(){return this.instance||(this.instance=new D$),this.instance}increaseFailed(e){a.ModuleContainer.resolve(zs.b).log({success:!1,commandId:e.cmd,subCommandId:e.subCmd,duration:e.duration,errorCode:e.code,startTime:0,params:[]})}migrateZaloPcSuccess(e,t){this.increaseFailed({cmd:w$.CMD,subCmd:e,duration:t,code:0})}migrateZaloPcFailed(e,t,s){this.increaseFailed({cmd:L$.CMD,subCmd:e,duration:s,code:t})}}D$.instance=void 0;class A${static getInstance(){return this.instance||(this.instance=new A$),this.instance}actionLogTripleNine(e,t){try{Ia.default.logActionInfoV2(Ia.FeaturesInfo.MigrateZaloPc,e,t)}catch(CY){}}migrateZaloPcResult(e){this.actionLogTripleNine("migration_result",(e=>{const t=Object.fromEntries(Object.entries(e).map((([e,t])=>[e.replace(/([A-Z])/g,"_$1").toLowerCase(),t])));return Object(I.a)(Object(I.a)({},t),{},{ts:e.ts||Date.now()})})(e))}}A$.instance=null;var F$,k$=s("7r+T");Object(As.a)()(F$=Reflect.metadata("design:type",Function)(F$=Reflect.metadata("design:paramtypes",[])(F$=class{constructor(){this.logger=void 0,this.remoteConfig=void 0,this.logger=(e=>{const t=[e];return a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(t)})("migrate-service-coordinator"),this.handleConfigChange=this.handleConfigChange.bind(this)}async onApplicationReady(){const e=Object(R$.a)().get(I$.k);this.remoteConfig=e,this.syncConfigsToStore(),C$.on(this.handleConfigChange),setTimeout((()=>{this.submitLogData()}),6e4);const t=Object(R$.b)();this.logger.zsymb(0,"csOA5s","ZaloPC folder migration status:",t)}handleConfigChange(){this.syncConfigsToStore()}syncConfigsToStore(){try{const e=I$.k;if(Object(R$.b)())return;const t={[I$.d]:C$.key("enable_migrate_media_to_new_position").boolean,[I$.e]:C$.key("migrate_media_to_new_position_max_retry").number,[I$.b]:C$.key("enable_log_migration_status").boolean,[I$.r]:J.p.getSessionUserId(),[I$.q]:Date.now()},s=[I$.q,I$.r];if(O$()(T$()(this.remoteConfig,s),T$()(t,s)))return;this.remoteConfig=t,Object(R$.a)().set(e,t),this.logger.zsymb(0,"VPZ3e_",`Updated electron-store key '${e}' with value: ${JSON.stringify(t)}`)}catch(e){this.logger.zsymb(18,"uGbJdt","Failed to sync remote config to electron-store:",e)}}async submitLogData(){await this.submitQosData(),await this.submitActionLog(),Object(R$.a)().delete(I$.g)}async submitActionLog(){try{var e;const t=Object(R$.a)().get(I$.g),s=Object(R$.a)().get(I$.k);if(!t||0===Object.keys(t).length)return;const a=(null==t?void 0:t[I$.m])||"success",i=(null==s?void 0:s[I$.r])===J.p.getSessionUserId(),n=Math.max(((null==t?void 0:t[I$.l])||0)-((null==s?void 0:s[I$.q])||0),0),r=(null==t?void 0:t[I$.h])||0,o="success"===a?void 0:(null==t?void 0:t[I$.i])||I$.o.UNKNOWN_ERROR,c=(null==t?void 0:t[I$.n])||0,l=(null===(e=k$.a.analyzeMainDisk())||void 0===e?void 0:e.free)||0,d={status:a,isUidReceivedConfig:i,timeFromReceivedConfigToStartMigration:n,timeMigrating:r,deviceId:ui.default.getZaloClientID(),ts:Date.now(),failReason:o,retryTimes:c,free:l};this.logger.zsymb(0,"Bcrgl-","Submitting action log data:",d),A$.getInstance().migrateZaloPcResult(d)}catch{}}async submitQosData(){try{const e=Object(R$.a)().get(I$.g);if(!e||0===Object.keys(e).length)return;this.logger.zsymb(0,"crHtH5","Successfully read 'migrate-config' store data.",e),"success"===e[I$.m]?D$.getInstance().migrateZaloPcSuccess(e[I$.n]||0,e[I$.h]||0):"fail"===e[I$.m]&&D$.getInstance().migrateZaloPcFailed(e[I$.n]||0,(e=>{switch(e){case I$.o.UNKNOWN_ERROR:return 1;case I$.o.EXIST:return 2;case I$.o.NOT_EMPTY:return 3;case I$.o.NOT_FOUND:return 4;case I$.o.PERMISSION_DENIED:return 5;case I$.o.IS_DIRECTORY:return 6;case I$.o.NOT_A_DIRECTORY:return 7;case I$.o.TOO_MANY_OPEN_FILES:return 8;case I$.o.RESOURCE_BUSY:return 9;case I$.o.INVALID_ARGUMENT:return 10;case I$.o.FILENAME_TOO_LONG:return 11;default:return 0}})(e[I$.i]||I$.o.UNKNOWN_ERROR),e[I$.h]||0)}catch(e){}}})||F$)||F$);$znode.systeminformation;let N$=function(e){return e[e.FULL_SUPPORT=0]="FULL_SUPPORT",e[e.PARTIAL_SUPPORT=1]="PARTIAL_SUPPORT",e[e.MINIMAL_SUPPORT=2]="MINIMAL_SUPPORT",e[e.NO_SUPPORT=3]="NO_SUPPORT",e}({});var P$=s("IrwE");function j$(){return Object(P$.b)(Object(wi.gethomeDirSync)())||"C:\\"}async function U$(){const e=await async function(){const e={platform:"unsupported",overallSupport:!1,details:{}};return e.details.Platform={supported:!1,reason:"Only Windows platform is supported"},e}();return"windows"===e.platform?await async function(e){const t=[],s=[];let a=!1;for(const[o,c]of Object.entries(e.details))c.supported?(t.push(o),o.toUpperCase().startsWith(j$().toUpperCase())&&(a=!0)):s.push(o);const i=t.length+s.length,n=t.length;let r;return r=n===i?N$.FULL_SUPPORT:n>1||1===n&&!a?N$.PARTIAL_SUPPORT:1===n&&a?N$.MINIMAL_SUPPORT:N$.NO_SUPPORT,{severity:r,supportedDrives:t,unsupportedDrives:s,osDriveSupported:a,totalDrives:i,supportedCount:n}}(e):{severity:N$.NO_SUPPORT,supportedDrives:[],unsupportedDrives:[],osDriveSupported:!1,totalDrives:0,supportedCount:0}}const B$={CMD:152720},z$={CMD:152721},G$={CMD:152722},x$={CMD:152723},V$={CMD:152724};class H${static getInstance(){return this.instance||(this.instance=new H$),this.instance}increaseFailed(e){a.ModuleContainer.resolve(zs.b).log({success:!1,commandId:e.cmd,subCommandId:e.subCmd,duration:e.duration,errorCode:e.code,startTime:0,params:[]})}markHardlinkSupport(e){this.increaseFailed({cmd:B$.CMD,subCmd:0,duration:0,code:e})}markHardlinkPartialSupport(e,t){this.increaseFailed({cmd:z$.CMD,subCmd:t,duration:0,code:e})}markHardlinkMinimalSupport(e){this.increaseFailed({cmd:G$.CMD,subCmd:0,duration:0,code:e})}markHardlinkNoSupport(e){this.increaseFailed({cmd:x$.CMD,subCmd:0,duration:0,code:e})}markMediaDriveNotSupportHardlink(e){this.increaseFailed({cmd:V$.CMD,subCmd:0,duration:0,code:e?1:0})}}H$.instance=void 0;var W$;Object(As.a)()(W$=Reflect.metadata("design:type",Function)(W$=Reflect.metadata("design:paramtypes",[])(W$=class{constructor(){this.logger=void 0,this.logger=(e=>{const t=[e];return t.push("migrate-media"),a.ModuleContainer.resolve(es.ZLoggerFactory).createZLogger(t)})("migrate-media")}async onApplicationReady(){0}async logMediaDriveHardlinkSupport(){try{const e=await async function(){const e=Object(wi.getZaloPCDirSync)(),t=Object(P$.b)(e),s=j$(),a=(null==t?void 0:t.toUpperCase())===s.toUpperCase(),i=await async function(e){return{supported:!1,reason:"Only Windows platform is supported"}}();return Object(I.a)(Object(I.a)({},i),{},{isInOriginalDrive:a,reason:`${i.reason} (Path: ${e}, Drive: ${t||"Unknown"}, OS Drive: ${s})`})}();if(this.logger.zsymb(0,"kSqv12","Media folder hardlink support:",e),!e.supported)return void H$.getInstance().markMediaDriveNotSupportHardlink(e.isInOriginalDrive)}catch(e){this.logger.zsymb(18,"S1OMNx","Error checking media folder hardlink support:",e)}}async logHardlinkSupportEvaluation(){try{const e=await U$();switch(this.logger.zsymb(0,"7V8cRG","Hardlink support evaluation result:",e),e.severity){case N$.FULL_SUPPORT:H$.getInstance().markHardlinkSupport(e.totalDrives);break;case N$.PARTIAL_SUPPORT:H$.getInstance().markHardlinkPartialSupport(e.totalDrives,e.supportedCount);break;case N$.MINIMAL_SUPPORT:H$.getInstance().markHardlinkMinimalSupport(e.totalDrives);break;default:H$.getInstance().markHardlinkNoSupport(e.totalDrives)}}catch(e){this.logger.zsymb(18,"tkM7at","Error evaluating hardlink support:",e)}}})||W$)||W$);s("69Uf"),s("Q/Ir"),s("Lp8g"),s("mneU");var q$,K$=s("eK4z");E.j.timeInMs("3m"),E.h.sizeInByte("110MB"),E.h.sizeInByte("100MB"),E.j.timeInMs("24h"),E.j.timeInMs("5s"),E.h.sizeInByte("200MB");const Z$={enable:!1,max_retries_create_bu:3,max_timeout_duration:E.j.timeInMs("3m"),total_msg_ratio:1636,delta_size_estimated_sqlite:E.h.sizeInByte("110MB"),force_start_migrate:!1,delta_size_storage_checking:E.h.sizeInByte("100MB"),auto_remind_modal_timeout:E.j.timeInMs("24h"),auto_dismiss_success_screen:E.j.timeInMs("5s"),migrate_version:1,max_retry_count:2,min_estimated_sqlite_size:E.h.sizeInByte("200MB"),drop_idb:!1};let $$=Object(a.singleton)()(q$=Reflect.metadata("design:type",Function)(q$=Reflect.metadata("design:paramtypes",[])(q$=class extends X.AdvancedRemoteConfigs{constructor(){super("db_migrate",Z$,{validator:new X.ObjectValidator({enable:X.Rule.field().boolean(),max_retries_create_bu:X.Rule.field().number().min(0),max_timeout_duration:X.Rule.field().number().min(0),total_msg_ratio:X.Rule.field().number().min(0),delta_size_estimated_sqlite:X.Rule.field().number().min(0),force_start_migrate:X.Rule.field().boolean(),delta_size_storage_checking:X.Rule.field().number().min(0),auto_remind_modal_timeout:X.Rule.field().number().min(0),auto_dismiss_success_screen:X.Rule.field().number().min(0),migrate_version:X.Rule.field().number().min(1),max_retry_count:X.Rule.field().number().min(1),min_estimated_sqlite_size:X.Rule.field().number().min(0),drop_idb:X.Rule.field().boolean()})})}loadConfig(e){super.loadConfig(e)}})||q$)||q$)||q$;a.ModuleContainer.registerSingleton(K$.a,$$);var Q$=s("0W0H");a.ModuleContainer.registerSingleton(cn.a,class{constructor(){this.logger=void 0,this.session=null,this.dbStateStorage=null;const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger("db-migrate",["utils"])}async getNotMigratedAccounts(){const e=await this.getStates(),t=Object(hr.f)(),s=[];for(const a of t){const t=e[a];void 0!==t?t!==O.a.IDB||s.push(a):s.push(a)}return s}authenticate(e){this.session=e}isCurrentAccountMigrated(){const e=this.getSession();return void 0!==this.getMigrateDoneState()[e.userId]}getTotalMigratedAccount(){const e=this.getMigrateDoneState();return Object.keys(e).length}async forceMarkAsDoneMigrateDB40(){const e=this.isCurrentAccountMigrated(),t=await $zFeatures.migrateDB.isMigrateFullDone();if(e||t){const e=await Object(on.a)(),t=n.default.getInstance();return e.forEach((e=>{const s=`${`${Object(hr.d)(e)}`}_${Q$.b}`;t.removeItemPlain(s)})),await $zFeatures.migrateDB.signalDoneFullMigrate(),!0}return!1}async getIsTrickle(){if(this.currentUserHasMigrated())return!1;{const e=this.getDBStateStorage();return!!(await e.getIntForCurrentUserAsync(Q$.d,{defaultInt:0}))}}getSession(){if(null===this.session)throw new Error("DatabaseMigrateUtils hasn't authenticated yet");return this.session}async getStates(){try{return this.dbStateStorage||(this.dbStateStorage=this.getDBStateStorage()),await this.dbStateStorage.getObjectAsync(wq.a)}catch(CY){throw new Error("Invalid adapter type states")}}getDBStateStorage(){if(null===this.dbStateStorage){const e=this.getSession();this.dbStateStorage=a.ModuleContainer.resolve(Lq.b),this.dbStateStorage.authenticate(e)}return this.dbStateStorage}getMigrateDoneState(){const e=this.getDBStateStorage().getItem(Q$.e);let t={};if(e)try{t=JSON.parse(e)}catch(CY){this.logger.zsymb(21,"yyOlFa",["Failed to parse migrate done state: {}","w6NFe_"],Object(Kt.c)(CY))}return t}currentUserHasMigrated(){const e=this.getMigrateDoneState(),t=this.getSession();return Boolean(e&&e[t.userId])}});class Y${constructor(){this.shouldPromote=void 0,this.shouldPromote=!1}setShouldPromote(e){this.shouldPromote=e}promoteForOpenConv(e){const t={type:"open-conv",payload:{convId:e}};this.sendPromote(t)}async sendPromote(e){if(this.shouldPromote){const t={typeID:f.m,data:{type:f.x,data:e}},s=a.ModuleContainer.resolve(p.b),i=await s.getPort();await i.invokeMessage(t)}}}var J$=s("/brz"),X$=s("YEoC");let eQ=function(e){return e[e.SQLITE_OK=0]="SQLITE_OK",e[e.SQLITE_ERROR=1]="SQLITE_ERROR",e[e.SQLITE_INTERNAL=2]="SQLITE_INTERNAL",e[e.SQLITE_PERM=3]="SQLITE_PERM",e[e.SQLITE_ABORT=4]="SQLITE_ABORT",e[e.SQLITE_BUSY=5]="SQLITE_BUSY",e[e.SQLITE_LOCKED=6]="SQLITE_LOCKED",e[e.SQLITE_NOMEM=7]="SQLITE_NOMEM",e[e.SQLITE_READONLY=8]="SQLITE_READONLY",e[e.SQLITE_INTERRUPT=9]="SQLITE_INTERRUPT",e[e.SQLITE_IOERR=10]="SQLITE_IOERR",e[e.SQLITE_CORRUPT=11]="SQLITE_CORRUPT",e[e.SQLITE_NOTFOUND=12]="SQLITE_NOTFOUND",e[e.SQLITE_FULL=13]="SQLITE_FULL",e[e.SQLITE_CANTOPEN=14]="SQLITE_CANTOPEN",e[e.SQLITE_PROTOCOL=15]="SQLITE_PROTOCOL",e[e.SQLITE_EMPTY=16]="SQLITE_EMPTY",e[e.SQLITE_SCHEMA=17]="SQLITE_SCHEMA",e[e.SQLITE_TOOBIG=18]="SQLITE_TOOBIG",e[e.SQLITE_CONSTRAINT=19]="SQLITE_CONSTRAINT",e[e.SQLITE_MISMATCH=20]="SQLITE_MISMATCH",e[e.SQLITE_MISUSE=21]="SQLITE_MISUSE",e[e.SQLITE_NOLFS=22]="SQLITE_NOLFS",e[e.SQLITE_AUTH=23]="SQLITE_AUTH",e[e.SQLITE_FORMAT=24]="SQLITE_FORMAT",e[e.SQLITE_RANGE=25]="SQLITE_RANGE",e[e.SQLITE_NOTADB=26]="SQLITE_NOTADB",e[e.SQLITE_NOTICE=27]="SQLITE_NOTICE",e[e.SQLITE_WARNING=28]="SQLITE_WARNING",e[e.SQLITE_ROW=100]="SQLITE_ROW",e[e.SQLITE_DONE=101]="SQLITE_DONE",e[e.SQLITE_BUSY_RECOVERY=261]="SQLITE_BUSY_RECOVERY",e}({});Error;let tQ,sQ=function(e){return e[e.READ=1]="READ",e[e.WRITE=2]="WRITE",e[e.INIT=3]="INIT",e}({});(()=>{const e=a.ModuleContainer.resolve(R.a);tQ=e.createZLogger(w.ZLoggerNametags.sqlDataMigration,[""])})();var aQ=tQ;let iQ,nQ,rQ;var oQ;let cQ;!function(e){e.isSQLiteError=function(e){return void 0!==e.errno},e.ignoreable=function(e){return t.has(e.errno)},e.retryable=function(e){return s.has(e.errno)},e.renewableError=function(e){return a.has(e.errno)},e.forceStop=function(e){return i.has(e.errno)};const t=new Set([eQ.SQLITE_NOTICE,eQ.SQLITE_WARNING]),s=new Set([eQ.SQLITE_BUSY,eQ.SQLITE_ERROR,eQ.SQLITE_ABORT,eQ.SQLITE_LOCKED,eQ.SQLITE_INTERRUPT,eQ.SQLITE_PROTOCOL,eQ.SQLITE_MISUSE,eQ.SQLITE_BUSY_RECOVERY]),a=new Set([eQ.SQLITE_IOERR,eQ.SQLITE_ERROR,eQ.SQLITE_CORRUPT,eQ.SQLITE_CANTOPEN,eQ.SQLITE_NOTADB]),i=new Set([eQ.SQLITE_NOMEM,eQ.SQLITE_PERM])}(iQ||(iQ={})),function(e){e.isIndexedDBError=function(e){return void 0===e.errno&&void 0!==e.code};let t=function(e){return e.NoModificationAllowedError="NoModificationAllowedError",e.DBNotFoundError="DBNotFoundError",e.NotFoundError="NotFoundError",e.NotSupportedError="NotSupportedError",e.InvalidStateError="InvalidStateError",e.SyntaxError="SyntaxError",e.InvalidModificationError="InvalidModificationError",e.AbortError="AbortError",e.QuotaExceededError="QuotaExceededError",e.TimeoutError="TimeoutError",e.DataCloneError="DataCloneError",e.EncodingError="EncodingError",e.NotReadableError="NotReadableError",e.UnknownError="UnknownError",e.ConstraintError="ConstraintError",e.DataError="DataError",e.ReadOnlyError="ReadOnlyError",e.VersionError="VersionError",e.OperationError="OperationError",e.NotAllowedError="NotAllowedError",e.OptOutError="OptOutError",e.Undefined="Undefined",e}({});e.errorsName=t;let s=function(e){return e[e.NoModificationAllowedError=7]="NoModificationAllowedError",e[e.NotFoundError=8]="NotFoundError",e[e.NotSupportedError=9]="NotSupportedError",e[e.InvalidStateError=11]="InvalidStateError",e[e.SyntaxError=12]="SyntaxError",e[e.InvalidModificationError=14]="InvalidModificationError",e[e.AbortError=20]="AbortError",e[e.QuotaExceededError=22]="QuotaExceededError",e[e.TimeoutError=23]="TimeoutError",e[e.DataCloneError=25]="DataCloneError",e}({});e.errorsCode=s,e.retryable=function(e,a){const i=[t.AbortError,t.TimeoutError,t.NotReadableError,t.OperationError].includes(e),n=[s.AbortError,s.TimeoutError].includes(a);return i||n},e.ignoreable=function(e,a){const i=[t.NotFoundError].includes(e),n=[s.NotFoundError].includes(a);return i||n},e.forceStop=function(e,a){const i=[t.QuotaExceededError].includes(e),n=[s.QuotaExceededError].includes(a);return i||n}}(nQ||(nQ={})),(oQ=rQ||(rQ={})).shouldIgnoreError=function(e,t){return e==X$.a.IDB?nQ.ignoreable(t.name,t.code):e==X$.a.SQLite&&iQ.ignoreable(t)},oQ.shouldRetryError=function(e,t){return e==X$.a.IDB?nQ.retryable(t.name,t.code):e==X$.a.SQLite&&iQ.retryable(t)},oQ.shouldForceStopError=function(e,t){return e==X$.a.IDB?nQ.forceStop(t.name,t.code):e==X$.a.SQLite&&iQ.forceStop(t)},(cQ||(cQ={})).parseErrorCode=function({error:e}){try{return iQ.isSQLiteError(e)||nQ.isIndexedDBError(e)?e.code:"re_"+e.name}catch(CY){return aQ.zsymb(21,"QNs2wH",["Failed to parse error code: {}","MzuUi2"],Object(Kt.c)(CY)),-2}};sQ.WRITE;var lQ=s("dko3");class dQ{constructor({session:e,dbConfig:t}){this.session=void 0,this.dbConfig=void 0,this.database=null,this.session=e,this.dbConfig=t}async openDB(){if(null===this.database){const e="",t=this.dbConfig.computeDatabaseName(this.session.userId,e),s=this.dbConfig.getLegacyPartition(e,this.session);this.database=await uQ.open(t,s)}return this.database}closeConnection(){this.database&&this.database.close()}async getStoreOrIndex(e,t){try{const s=await this.openDB(),a=s.transaction(e.tableName,"readonly").objectStore(e.tableName);return t&&"primary"!=t?a.index(t):a}catch(s){if((null==s?void 0:s.code)===nQ.errorsCode.NotFoundError)throw new uQ.TableDoesNotExistError(e.tableName);throw s}}async isTableExist(e){try{return await this.getStoreOrIndex(e),!0}catch(t){return!1}}async get(e,t){const s=await this.getStoreOrIndex(e);return await uQ.get(s,uQ.toIDBQuery(t))}async getAll(e,t,s){const a=await this.getStoreOrIndex(e,null==s?void 0:s.index);return await uQ.getAll(a,uQ.toIDBQuery(t),null==s?void 0:s.count)}async getMulti(e,t){const s=await this.getStoreOrIndex(e);return await uQ.getMulti(s,t)}async count(e,t){const s=await this.getStoreOrIndex(e);return await uQ.count(s,uQ.toIDBQuery(t))}async getAllKeys(e,t){const s=await this.getStoreOrIndex(e);return await uQ.getAllKeys(s,uQ.toIDBQuery(t))}}let uQ;!function(e){class t extends Error{constructor(e,t){super(t),this.code=e,this.message=t}}e.IDBError=t;e.DBDoesNotExistError=class extends t{constructor(e){super(nQ.errorsCode.NotFoundError,`Database ${e} does not exist`),this.name=nQ.errorsName.DBNotFoundError}};e.TableDoesNotExistError=class extends t{constructor(e){super(nQ.errorsCode.NotFoundError,`Table ${e} does not exist`),this.name=nQ.errorsName.NotFoundError}};e.isDatabaseExist=async e=>(await indexedDB.databases()).some((t=>t.name===e)),e.open=async(e,t)=>{if(!(await uQ.isDatabaseExist(e)))throw new uQ.DBDoesNotExistError(e);return new Promise(((s,a)=>{const i=lQ.a.open(e,t.version);i.onsuccess=()=>{s(i.result)},i.onerror=()=>{a(i.error)},i.onblocked=()=>{a(i.error)},i.onupgradeneeded=async s=>{if(null!==s.newVersion)try{const a=i.result,n=i.transaction,r=new J$.a(e,t,a,n);await r.upgrade(s.oldVersion,s.newVersion)}catch(a){throw i.transaction.abort(),a}}}))},e.get=async(e,...t)=>{var s;return null!==(s=await uQ.promisifyRequest(e.get(...t)))&&void 0!==s?s:null},e.getAll=(e,...t)=>uQ.promisifyRequest(e.getAll(...t)),e.getMulti=(e,t)=>Promise.all(t.map((t=>uQ.get(e,t)))),e.getAllKeys=(e,...t)=>uQ.promisifyRequest(e.getAllKeys(...t)),e.count=(e,...t)=>uQ.promisifyRequest(e.count(...t)),e.promisifyRequest=e=>new Promise(((t,s)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error)})),e.toIDBQuery=e=>{if(e){if("string"==typeof e)return e;if("number"==typeof e)return e;if(Array.isArray(e))return e;if(e.from&&e.to)try{return IDBKeyRange.bound(uQ.firstOrArray(e.from),uQ.firstOrArray(e.to),e.excludeFrom,e.excludeTo)}catch(t){throw t}return e.from?IDBKeyRange.lowerBound(uQ.firstOrArray(e.from),e.excludeFrom):e.to?IDBKeyRange.upperBound(uQ.firstOrArray(e.to),e.excludeTo):void 0}},e.firstOrArray=e=>1===e.length?e[0]:e}(uQ||(uQ={}));var hQ=s("pAGP"),gQ=s("2xv9"),mQ=s("p2N7"),pQ=s("Q97H"),fQ=s("DwEK"),vQ=s("4lsZ"),_Q=s("ycTR"),bQ=s("oRsZ"),IQ=s("lDvZ"),yQ=s("JeVx"),SQ=s("9bet"),CQ=s("3iCl"),EQ=s("B7VA");var OQ,MQ=new class{constructor(){this.messageLogs=[]}checkAndLog(e,t={error_code:0}){try{if(e!==EQ.g.CMD)return;if(t.identity&&t.identity.includes("Message"))return t.migrated_count&&this.messageLogs.push(t.migrated_count),void(this.messageLogs.length>=30&&this.flushLogs());this._log({migrated_count:t.migrated_count,identity:t.identity})}catch(s){}}flushLogs(){this._log({data:this.messageLogs,identity:"MsgCount"}),this.messageLogs=[]}_log(e){Ia.default.logActionInfoV2(Ia.FeaturesInfo.DBv4Migrate,1,e,[])}},TQ=s("QO5D");const RQ={percent:0,status:vu.d.UNSET,isLowDiskSpace:!1,requiredSpace:0,error:"",migratedCount:0,toMigrateCount:0,timeElapsed:0,numOfReader:1,batchSize:5e3,count:1,pausedLastSession:!1,allowReject:!1,forceReject:!1};let wQ=Object(a.injectable)()(OQ=Object(a.singleton)()(OQ=function(e,t){return Object(a.inject)(K$.a)(e,void 0,0)}(OQ=function(e,t){return Object(a.inject)(Lq.b)(e,void 0,1)}(OQ=Reflect.metadata("design:type",Function)(OQ=Reflect.metadata("design:paramtypes",["undefined"==typeof IMigrateRemoteConfigs?Object:IMigrateRemoteConfigs,"undefined"==typeof IDatabaseStateStorage?Object:IDatabaseStateStorage])(OQ=class{constructor(e,t){this.config=e,this.databaseStateStorage=t,this.name=void 0,this.key=void 0,this.state=void 0,this.signalDone=void 0,this.session=void 0,this.startTime=void 0,this.timeoutTimer=null,this.storageCheckingTimer=null,this.promoteSubject=void 0,this.migrateResolver=void 0,this.isMigrateStarted=void 0,this.taskScheduler=new fQ.b(new vQ.a,!1),this.logger=void 0,this.didBlockApp=!1,this.stopHandleMigrateProcessDisconnected=()=>{},this.initControllerServiceContainer=null,this.initCacheTotalMsgContainer=null,this.preparedDataProfileTimers=new Map,this.storageCheckingTimerContainer=null,this.isMigrationPaused=!1,this.didSignalProcessToStartMigration=!1,this.removeListenerFullDiskFromSM=()=>{},this.cachedIsFirstTimeMigrate=null,this.cachedTotalMsgCount=-1,this.migrateLocalInfo=null,this._lastElapsedTime=null,this.timeElapsedTimer=null,this.migrateDoneState=null,this._isTrickle=null,this.reminderTimeout=null,this.migrateProgressPercent=null,this.showSuccessScreen=!1,this.handleDBCorruption=e=>{if(this.isMigrateStarted){const{tsStartCheck:t}=e;this.handleErrorDuringBigBangMigration(`Corrupt - tsStartCheck: ${t}`),this.logger.zsymb(0,"9gWA1Y","[status] Pause migration due to corruption"),this.handlePauseMigrate("db-corrupt")}else this.logger.zsymb(0,"-aLrs4","[status] corrupt in onboarding screen. Ignore")},this.requestClearInfoDBSizeCache=async()=>{const e={type:f.f,data:{}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};await s.invokeMessage(i)},this.requestPauseMigrate=async e=>{const t={type:f.v,data:{reason:e}},s=a.ModuleContainer.resolve(p.b),i=await s.getPort(),n={typeID:f.m,data:t};await i.invokeMessage(n),this.isMigrationPaused=!0},this.requestResumeMigrate=async e=>{const t={type:f.A,data:{reason:e}},s=a.ModuleContainer.resolve(p.b),i=await s.getPort(),n={typeID:f.m,data:t};await i.invokeMessage(n),this.isMigrationPaused=!1},this.name=vu.a,this.key="",this.state=RQ,this.session={userId:""},this.startTime=0,this.isMigrateStarted=!1;const s=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=s.createZLogger("db-migrate",["manager"]),this.migrateResolver=new E.c.Container,this.promoteSubject=new Y$,this.taskScheduler.start(),this.handleDBMigrationMessage(),this.addDBCorruptionListener()}waitMigrateRelease(){return this.isMigrateStarted?this.migrateResolver.promise:Promise.resolve()}startHandleMigrateProcessDisconnected(){const e=a.ModuleContainer.resolve(p.b),t=[];t.push(e.addEventListener(TQ.c.ChannelDisconnected,(()=>{this.logger.zsymb(6,"k7C6LE","Migrate process disconnected")}))),t.push(e.addEventListener(TQ.c.ChannelReConnected,(()=>{this.logger.zsymb(0,"8zO38i","Migrate process re-connected -> Resume migrate"),this.signalSQLiteProcessToStartMigrate()}))),this.stopHandleMigrateProcessDisconnected=()=>t.forEach((e=>e()))}waitForDBMigrate(e,t,s){return new Promise((async i=>{try{this.updateCurrentDisplayedMigrateUI(vu.d.INIT),this.logger.zsymb(0,"wjci2A","Sync migrate server config",t),this.config.loadConfig(t),this.logger.zsymb(0,"8a0Boh","Sync full_disk_check server config",s),dn.a.updateServerConfig(s),this.session=e,this.databaseStateStorage.authenticate(e);const n=this.getIsMigrationStarted();if(!this.enableMigrate&&!n)return this.hideMigrateUI(vu.d.DISABLED),this.scheduleReminder(),this.logger.zsymb(0,"KlxgSP","[status] force skip migrate due to server config",this.enableMigrate),i(!1);if(a.ModuleContainer.resolve(Us.TDBCorruptionDetector).corruptionHasOccurred())return this.hideMigrateUI(vu.d.DISABLED),this.logger.zsymb(0,"CiqQUS","[status] force skip migrate due to corruption"),i(!1);if(this.currentUserHasMigrated())return this.hideMigrateUI(vu.d.TR_SUCCESS),this.logger.zsymb(0,"hQ0vG5","[status] current user migrated, no need to migrate"),i(!0);if(await $zFeatures.migrateDB.isMigrateFullDone())return this.hideMigrateUI(vu.d.TR_SUCCESS),this.logger.zsymb(0,"l_1a4M","[status] all user migrated"),i(!0);const r=Object(IQ.a)(e.userId);if(!n&&r)return this.logger.zsymb(0,"wV54bt","[status] first session, silent migrate"),this.isSilentMigrate=!0,void(await this.signalRestartAppToStartMigrate());const o=this.config.nestedKey("migrate_version"),{disable_migrate:c}=await this.getMigrateLocalInfo(o);if(c)return this.hideMigrateUI(vu.d.DISABLED),this.logger.zsymb(0,"-_aX2c","[status] force skip migrate due to too many retry!"),i(!1);if(!n){if(await this.needWaitCreateBackup())return this.hideMigrateUI(vu.d.WAIT_BACKUP),this.logger.zsymb(0,"8YF2sL","[status] force skip migrate to wait for backup",this.enableMigrate),SQ.a.instance().onSkipDuetoNoBackup(),i(!1)}if(this.signalDone=i,$zwindow.setLoginSize(),n&&(CQ.b.getInstance().setDisableAnalyzeCorruption(!0),this.startHandleMigrateProcessDisconnected()),n&&(this.isTrickle||this.isSilentMigrate))this.isTrickle?(this.logger.zsymb(0,"7JyHYW","[status] continue trickle"),this.startMigrateAsTrickle(),this.signalDone(!0)):(this.logger.zsymb(0,"QYwBER","[status] start silent migrate"),this.startMigrateAsSilent());else if(this.didBlockApp=!0,this.initControllerService(),n){this.logger.zsymb(0,"FlYJeu","[status] continue BigBang");let e=!1,t=0;if(!this.isFirstTimeMigrate()){this.updateCurrentDisplayedMigrateUI(vu.d.GET_READY),await this.initCacheTotalMsg();try{this.logger.zsymb(0,"rVCB3r","[storage-checking] Timestamp: Start up");const s=await this.checkStorageByProgress();e=s.isLowDiskSpace,t=s.requiredSpace}catch(CY){const t=Object(Kt.c)(CY);return this.logger.zsymb(3,"SwFl9B",["[storage-checking] Failed due to error: {}","HcWnHK"],t),SQ.a.instance().onCheckDiskError(t),void this.handleErrorDuringBigBangMigration(CY)}}e?(this.logger.zsymb(0,"DDjyQn","[status] show storage checking screen"),this.updateCurrentDisplayedMigrateUI(vu.d.STORAGE_CHECK,{isLowDiskSpace:e,requiredSpace:t})):this.startMigrateAsBigBang()}else this.logger.zsymb(0,"cboZxF","[status] start migration for the 1st time"),this.logger.zsymb(0,"SVYMx6","[status] show onboarding"),await this.initCacheTotalMsg(),this.updateCurrentDisplayedMigrateUI(vu.d.ONBOARDING,{pausedLastSession:this.migratePausedLastSession()})}catch(CY){const t=Object(Kt.c)(CY);this.logger.zsymb(21,"lh2JWZ",["Unexpected err: {}","U66luz"],t),SQ.a.instance().onUnexpectedError(t)}}))}async initControllerService(){if(null!==this.initControllerServiceContainer)return this.initControllerServiceContainer.promise;this.initControllerServiceContainer=new E.c.Container,this.startProfileSlowPrepareData(EQ.f.SUB_CMD.CONTROL_SERVICE);try{const e=performance.now();await this.signalSQLiteProcessToInitState();const t=performance.now();this.logger.zsymb(3,"uWaLk5",["[prepare][success] 'initState' cost: {}","c0DAWJ"],t-e)}catch(CY){const t=Object(Kt.c)(CY);SQ.a.instance().onSlowPreparedData(EQ.f.SUB_CMD.CONTROL_SERVICE,EQ.f.ERR_CODE.FAILED,t),this.logger.zsymb(21,"u_zdTG",["[prepare][failed] 'initState': {}","_Lt2NZ"],t)}this.stopProfileSlowPrepareData(EQ.f.SUB_CMD.CONTROL_SERVICE),this.initControllerServiceContainer.resolve()}async initCacheTotalMsg(){if(null!==this.initCacheTotalMsgContainer)return this.initCacheTotalMsgContainer.promise;this.initCacheTotalMsgContainer=new E.c.Container,this.startProfileSlowPrepareData(EQ.f.SUB_CMD.TOTAL_MSG);try{const e=performance.now();await this.getTotalMsgCount(!1);const t=performance.now();this.logger.zsymb(3,"paNrQb",["[prepare][success] 'totalMsg' cost: {}","b4LjyG"],t-e)}catch(CY){const t=Object(Kt.c)(CY);SQ.a.instance().onSlowPreparedData(EQ.f.SUB_CMD.TOTAL_MSG,EQ.f.ERR_CODE.FAILED,t),this.logger.zsymb(21,"QOcyVa",["[prepare][failed] 'totalMsg': {}","aPl5_E"],t)}this.stopProfileSlowPrepareData(EQ.f.SUB_CMD.TOTAL_MSG),this.initCacheTotalMsgContainer.resolve()}startProfileSlowPrepareData(e){let t=this.preparedDataProfileTimers.get(e);void 0===t&&(t=[setTimeout((()=>{SQ.a.instance().onSlowPreparedData(e,EQ.f.ERR_CODE["10s"])}),1e4),setTimeout((()=>{SQ.a.instance().onSlowPreparedData(e,EQ.f.ERR_CODE["20s"])}),2e4),setTimeout((()=>{SQ.a.instance().onSlowPreparedData(e,EQ.f.ERR_CODE["30s"])}),3e4)],this.preparedDataProfileTimers.set(e,t))}stopProfileSlowPrepareData(e){const t=this.preparedDataProfileTimers.get(e);t&&(t.forEach((e=>clearTimeout(e))),this.preparedDataProfileTimers.delete(e))}waitUntilFinishInitService(){if(null!==this.initControllerServiceContainer)return this.initControllerServiceContainer.promise;this.logger.zsymb(18,"zGhqRD","Service hasn't been init yet")}cleanupInternalState(){n.default.getInstance().removeItemForCurrentUser(Q$.f),this.databaseStateStorage.removeItemForCurrentUser(Q$.d),this.databaseStateStorage.removeItemForCurrentUser(Q$.c)}async cleanupData(){const e=this.currentUserHasMigrated(),t=await $zFeatures.migrateDB.isMigrateFullDone();(e||t)&&this.config.nestedKey("drop_idb")&&(yQ.a.instance().unlock(),yQ.a.instance().deleteOldDB(this.session))}updateCurrentDisplayedMigrateUI(e,t){this.updateState(Object(I.a)({status:e},t||{}))}hideMigrateUI(e){this.updateState({status:e}),$zapp.setMainWindowResizable(!0)}startStorageCheckingTimer(){null===this.storageCheckingTimer&&(this.storageCheckingTimer=setTimeout((async()=>{this.taskScheduler.run({execute:async()=>{this.storageCheckingTimer=null,this.logger.zsymb(0,"CmHPuR","[storage-checking] Timestamp: During BigBang migration");let e=null;try{e=await this.getMigrateDiskInfoByProgress(!0)}catch(CY){this.logger.zsymb(21,"0HHPvR",["Failed to get migrate disk info by progress due to error: {}","EJ3v4D"],Object(Kt.c)(CY))}const{isLowDiskSpace:t,requiredSpace:s}=e||{isLowDiskSpace:!1,requiredSpace:0};if(t)return await this.handlePauseMigrate("low-disk"),this.logger.zsymb(0,"e68I2l","[status] Pause migration due to low disk (storage checking interval)"),this.stopBigBangMigrationTimers(),this.logger.zsymb(0,"TjGi1C","[status] show storage checking screen"),this.storageCheckingTimerContainer=new E.c.Container,this.updateCurrentDisplayedMigrateUI(vu.d.STORAGE_CHECK,{isLowDiskSpace:t,requiredSpace:s}),this.storageCheckingTimerContainer.promise;this.startStorageCheckingTimer()}})}),5e3))}stopStorageCheckingTimer(){null!==this.storageCheckingTimer&&(clearTimeout(this.storageCheckingTimer),this.storageCheckingTimer=null)}async getCurrentMigrateProgress(){if(null===this.migrateProgressPercent){const{migratedCount:e,toMigrateCount:t}=await this.calculateCurrentMigrateProgress();if(-1===e||-1===t)throw new Error("Failed to get current migrate progress");const s=e/t;this.migrateProgressPercent=s}return this.migrateProgressPercent}async signalGetCurrentMigrateProgress(){const e={type:f.q,data:{session:this.session}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};return await s.invokeMessage(i)}async calculateCurrentMigrateProgress(){return this.logger.zsymb(0,"L7Vd41","Get current progress from migrate controller"),this.signalGetCurrentMigrateProgress()}async getEstimatedSQLiteSize(e){const t=this.config.nestedKey("total_msg_ratio"),s=this.config.nestedKey("delta_size_estimated_sqlite"),a=this.config.nestedKey("min_estimated_sqlite_size");return Math.max(t*e+s,a)}async getMigrateDiskInfoByProgress(e){const t=sn.a.analyzeMainDisk();if(!t)throw new Error("Failed to get disk info");const{total:s,free:a}=t,{secondAlmostFullThreshold:i}=this.getAlmostFullStorageThreshold(s),n=await this.getTotalMsgCount(e),r=await this.getEstimatedSQLiteSize(n),o=await this.getCurrentMigrateProgress(),c=r*(1-o),l=this.config.nestedKey("delta_size_storage_checking");let d=0;d=a>i?c+i+l:c+i;const u=E.h.bytesToMB(a),h=E.h.bytesToMB(d),g=Math.ceil(u)<Math.ceil(h);return g?this.logger.zsymb(3,"HocB5T",["[storage-checking][progress] FAILED  ❌ - Required: {} - Actual: {} - Progress: {}","Nt_ES9"],Object(mQ.a)(d),Object(mQ.a)(a),o.toFixed(3)):this.logger.zsymb(3,"RtFoQV",["[storage-checking][progress] PASSED  ✅ - Required: {} - Actual: {} - Progress: {}","qlw6ZZ"],Object(mQ.a)(d),Object(mQ.a)(a),o.toFixed(3)),{isLowDiskSpace:g,requiredSpace:d}}async handleResumeMigrate(e){this.didSignalProcessToStartMigration?(null!==this.storageCheckingTimerContainer&&(this.storageCheckingTimerContainer.resolve(),this.storageCheckingTimerContainer=null),this.logger.zsymb(0,"khgLOa","[status] resume"),this.startBigBangMigrationTimers(),this.startHandleMigrateProcessDisconnected(),await this.requestResumeMigrate(e),this.logger.zsymb(0,"u7hOV4","[status] show in-progress screen"),this.updateCurrentDisplayedMigrateUI(vu.d.BB_IN_PROGRESS)):this.startMigrateAsBigBang()}async handlePauseMigrate(e){this.stopBigBangMigrationTimers(),this.stopHandleMigrateProcessDisconnected(),await this.requestPauseMigrate(e)}async checkStorageByProgress(){let e=null;try{e=await this.getMigrateDiskInfoByProgress(!0)}catch(CY){throw this.logger.zsymb(21,"jaqco0",["Failed to get migrate disk info by progress due to error: {}","EJ3v4D"],Object(Kt.c)(CY)),CY}return e}async startMigrateAsSilent(){this.updateCurrentDisplayedMigrateUI(vu.d.INIT,{pausedLastSession:this.migratePausedLastSession()}),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}async startMigrateAsTrickle(){this.hideMigrateUI(vu.d.TR_IN_PROGRESS),this.listenFullDiskFromSM(),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}async getRejectConfig(){let e=!1,t=!1;try{const s=this.config.nestedKey("migrate_version"),a=this.config.nestedKey("max_retry_count"),i=await this.getMigrateLocalInfo(s),{current_retry_count:n}=i;e=n>0,t=n>=a}catch(CY){const t=Object(Kt.c)(CY);this.logger.zsymb(21,"QlYK9S",["Failed to get reject config: {}","dCmUha"],t)}return{allowReject:e,forceReject:t}}async startMigrateAsBigBang(){const{allowReject:e,forceReject:t}=await this.getRejectConfig();let s=0;if(!this.isFirstTimeMigrate())try{const e=Math.min(100*await this.getCurrentMigrateProgress(),100);s=this.getMigratePercent(e).percent}catch(CY){this.logger.zsymb(21,"V0JOtw",["Failed to get current migrate progress: {}","vK1XbQ"],Object(Kt.c)(CY))}this.logger.zsymb(3,"8ki-UN",["[status] show in-progress screen","27n6cN"]),await this.waitUntilFinishInitService(),this.updateCurrentDisplayedMigrateUI(vu.d.BB_IN_PROGRESS,{pausedLastSession:this.migratePausedLastSession(),allowReject:e,forceReject:t,percent:this.formatPercent(s)}),this.startBigBangMigrationTimers(),this.signalSQLiteProcessToStartMigrate(),this.didSignalProcessToStartMigration=!0,this.promoteSubject.setShouldPromote(!0)}listenFullDiskFromSM(){const e=async e=>{var t;const s=null==e||null===(t=e.payload)||void 0===t?void 0:t.level;if(s)switch(s){case kn.g.FULL:this.isMigrationPaused||(this.logger.zsymb(0,"XmW-8b","[status] Pause migration due to full disk (SM signal)"),this.stopHandleMigrateProcessDisconnected(),this.requestPauseMigrate("full-disk"));break;case kn.g.RICH_SPACE:case kn.g.ALMOST_FULL_1:case kn.g.ALMOST_FULL_2:this.isMigrationPaused&&(this.logger.zsymb(3,"WM4Rb6",["[status] Resume migration (SM signal: {})","7T5SQe"],s),this.startHandleMigrateProcessDisconnected(),this.requestResumeMigrate("sm-signal"))}};me.a.DiskStatusManager.addEventListener(Fn.ResDisk_CurrentLevel,e),this.removeListenerFullDiskFromSM=()=>me.a.DiskStatusManager.removeEventListener(Fn.ResDisk_CurrentLevel,e)}getAlmostFullStorageThreshold(e){let{firstAlmostFullThreshold:t,secondAlmostFullThreshold:s}=dn.a.getServerConfigThreshold();let a=-1,i=-1;if(dn.a.lowCapacityDevice){a=t*e,i=s*e}else a=E.h.sizeInByte(`${t}GB`),i=E.h.sizeInByte(`${s}GB`);return{firstAlmostFullThreshold:a,secondAlmostFullThreshold:i}}async handleStartMigrate(){this.skipCheckStorageWhenStartupOnce(),await this.signalRestartAppToStartMigrate()}skipCheckStorageWhenStartupOnce(){n.default.getInstance().setItemForCurrentUser(Q$.a,"1")}isFirstTimeMigrate(){if(null!==this.cachedIsFirstTimeMigrate)return this.cachedIsFirstTimeMigrate;const e=n.default.getInstance(),t=null!==e.getItemForCurrentUser(Q$.a);return t&&e.removeItemForCurrentUser(Q$.a),this.cachedIsFirstTimeMigrate=t,this.cachedIsFirstTimeMigrate}async handleRetryMigrate(){this.logger.zsymb(0,"pdJYGI","[retry] start");try{await this.increaseRetryCount(),await this.signalRestartAppToRetryMigrate(),this.logger.zsymb(0,"QPPX_G","[retry] done ✅")}catch(CY){throw this.logger.zsymb(21,"W3zmlv",["[retry] fail ❌: {}","mBtSko"],Object(Kt.c)(CY)),CY}}async handleRejectMigrate(){this.logger.zsymb(18,"v85u9U","[reject] start");try{this.resetState(),SQ.a.instance().onUserRejectDuetoError(),await this.disableMigrateAfterTooManyRetry(),await this.signalRestartAppToRejectMigrate(),this.logger.zsymb(18,"6UHlCl","[reject] done ✅")}catch(CY){throw this.logger.zsymb(21,"mCj7lj",["[reject] fail ❌: {}","9uF5mX"],Object(Kt.c)(CY)),CY}}async getTotalMsgCount(e=!0){const t=async()=>{const e=bQ.a.baseConfig.name,t=Object(_Q.a)(e,X$.a.IDB),s=new dQ({session:this.session,dbConfig:t});try{return await s.count(bQ.a.schema.Message)}catch(CY){if(nQ.ignoreable(CY.name,CY.code))return 0;throw CY}finally{s.closeConnection()}};return-1!==this.cachedTotalMsgCount&&e||(this.cachedTotalMsgCount=await t()),this.cachedTotalMsgCount}async increaseRetryCount(){const e=this.config.nestedKey("migrate_version"),{current_retry_count:t}=await this.getMigrateLocalInfo(e);await this.updateMigrateLocalInfo(e,{current_retry_count:t+1})}async disableMigrateAfterTooManyRetry(){const e=this.config.nestedKey("migrate_version");await this.updateMigrateLocalInfo(e,{disable_migrate:!0})}async getMigrateLocalInfo(e){return null===this.migrateLocalInfo&&(this.migrateLocalInfo=await $zFeatures.migrateDB.getMigrateLocalInfo(e,this.session.userId)),this.migrateLocalInfo}async updateMigrateLocalInfo(e,t){null!==this.migrateLocalInfo&&(this.migrateLocalInfo=Object(I.a)(Object(I.a)({},this.migrateLocalInfo),t)),await $zFeatures.migrateDB.updateMigrateLocalInfo(e,this.session.userId,t)}resetState(){n.default.getInstance().removeItemForCurrentUser(Q$.f)}promoteMigrateByOpenConv(e){this.promoteSubject.promoteForOpenConv(e)}async signalRestartAppToStartMigrate(){SQ.a.instance().onStartMigrate(),this.setAdaperTypeForDAL(X$.a.SQLite),pQ.a.closeDB((()=>{$zFeatures.migrateDB.signalRestartAppToMigrate()}),{idbTimeout:0})}async signalRestartAppToRejectMigrate(){await this.signalSQLiteProcessToResetProgress(),await $zFeatures.migrateDB.signalRestartAppToMigrate()}async signalSQLiteProcessToResetProgress(){const e={type:f.z,data:{session:this.session}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};await s.invokeMessage(i)}async signalRestartAppToRetryMigrate(){$zFeatures.migrateDB.signalRestartAppToMigrate()}releaseBlockingAppLogic(){this.signalDone(!0)}setAdaperTypeForDAL(e){const t=this.databaseStateStorage.getObject(wq.a)||{},s=Object(I.a)(Object(I.a)({},t),{},{shared:e,[this.session.userId]:e});this.databaseStateStorage.setObject(wq.a,s)}get enableMigrate(){return this.config.nestedKey("enable")}get maxBURetries(){return this.config.nestedKey("max_retries_create_bu")}get timeoutDuration(){return this.config.nestedKey("max_timeout_duration")}get lastElapsedTime(){if(null===this._lastElapsedTime){const e=n.default.getInstance();this._lastElapsedTime=e.getIntForCurrentUser(Q$.f,{defaultInt:0})}return this._lastElapsedTime}resetLastElapsedTimeCached(){this._lastElapsedTime=null}getCurrentElapsedTime(){return 0===this.startTime?this.lastElapsedTime:Date.now()-this.startTime+this.lastElapsedTime}recordTimeElapsed(){const e=this.getCurrentElapsedTime();n.default.getInstance().setItemForCurrentUser(Q$.f,e.toString())}startRecordingTimeElapsed(){null!==this.timeElapsedTimer&&clearInterval(this.timeElapsedTimer),this.startTime=Date.now(),this.resetLastElapsedTimeCached(),this.timeElapsedTimer=setInterval((()=>{this.recordTimeElapsed()}),1e3)}stopRecordingTimeElapsed(){null!==this.timeElapsedTimer&&clearInterval(this.timeElapsedTimer)}getMigrateDoneState(){if(null===this.migrateDoneState){const e=this.databaseStateStorage.getItem(Q$.e);if(e)try{this.migrateDoneState=JSON.parse(e)}catch(CY){this.logger.zsymb(21,"aVBVB1",["Failed to parse migrate done state: {}","w6NFe_"],Object(Kt.c)(CY))}else this.migrateDoneState={}}return this.migrateDoneState}updateMigrateDoneState(e){this.migrateDoneState=Object(I.a)(Object(I.a)({},this.migrateDoneState),e);const t=JSON.stringify(this.migrateDoneState);this.databaseStateStorage.setItem(Q$.e,t)}currentUserHasMigrated(){const e=this.getMigrateDoneState();return Boolean(e&&e[this.session.userId])}async currentUserHasMigratedInAnyPhase(){const e=this.currentUserHasMigrated(),t=await $zFeatures.migrateDB.isMigrateFullDone();return e||t}async allUserHasMigrated(){const e=await Object(on.a)(),t=this.getMigrateDoneState();return Boolean(t&&Object.keys(t).length==e.length)}migratePausedLastSession(){if(this.currentUserHasMigrated())return!1;return!!n.default.getInstance().getItemForCurrentUser(Q$.f)}async needWaitCreateBackup(){const e=await $zFeatures.migrateDB.checkNeedWaitBackup(this.maxBURetries);return this.logger.zsymb(0,"UKM4wY","needWaitCreateBackup",this.maxBURetries,e),e}startTimeoutPoint(){if(null!==this.timeoutTimer)return;const e=Math.max(this.timeoutDuration-this.lastElapsedTime,0);this.timeoutTimer=setTimeout((()=>{this.taskScheduler.run({execute:()=>{this.timeoutTimer=null,this.stopBigBangMigrationTimers(),this.isTrickle=!0,this.logger.zsymb(0,"H8KKbN","[status] done big bang migration due to timeout"),this.showBigBangSuccessScreen(),this.disposeMigrationUI(!0),this.listenFullDiskFromSM(),this.removeDBCorruptionListener(),this.taskScheduler.stop()}})}),e)}get isTrickle(){return null===this._isTrickle&&(this.currentUserHasMigrated()?this._isTrickle=!0:this._isTrickle=!!this.databaseStateStorage.getIntForCurrentUser(Q$.d,{defaultInt:0})),this._isTrickle}set isTrickle(e){this._isTrickle!==e&&(this._isTrickle=e,0==e?this.databaseStateStorage.removeItemForCurrentUser(Q$.d):this.databaseStateStorage.setItemForCurrentUser(Q$.d,"1"))}startBigBangMigrationTimers(){this.startTimeoutPoint(),this.startStorageCheckingTimer(),this.startRecordingTimeElapsed()}stopBigBangMigrationTimers(){this.stopTimeoutPoint(),this.stopStorageCheckingTimer(),this.recordTimeElapsed(),this.stopRecordingTimeElapsed()}set isSilentMigrate(e){e?this.databaseStateStorage.setItemForCurrentUser(Q$.c,"1"):this.databaseStateStorage.removeItemForCurrentUser(Q$.c)}get isSilentMigrate(){return!!this.databaseStateStorage.getIntForCurrentUser(Q$.c,{defaultInt:0})}stopTimeoutPoint(){null!==this.timeoutTimer&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}async skipMigrate(){this.logger.zsymb(0,"OQydx5","[skip]"),this.logger.zsymb(0,"7eE7Hw","[status] hide migrate ui due to skip"),this.hideMigrateUI(vu.d.SKIP),this.removeDBCorruptionListener(),this.signalDone(!1);try{await this.requestClearInfoDBSizeCache(),this.logger.zsymb(3,"CLvpaR",["[status] clear info db size cache success","lDB5O3"])}catch(e){this.logger.zsymb(21,"12ULWW",["[status] an error occured due to clear info db size cache. {}","i-cVGx"],Object(Kt.c)(e))}}scheduleReminder(){if(null===this.reminderTimeout){const e=this.config.nestedKey("auto_remind_modal_timeout");this.updateState({isLowDiskSpace:!1,requiredSpace:0}),this.logger.zsymb(0,"-FVUnt","[reminder] init -  timeout: {}ms",e),this.reminderTimeout=setTimeout((async()=>{this.reminderTimeout=null,this.logger.zsymb(0,"E6pMgB","[reminder] expired"),this.enableMigrate?this.handleShowOnboardingModal():this.scheduleReminder()}),e)}}handleShowOnboardingModal(){this.logger.zsymb(0,"pr4ADN","[modal] show"),Ie.ModalManagerV2.openModal({windowId:Ar.c,name:Y.ModalIdentitiesDefine.DATA_MIGRATION,params:!0})}markDoneMigrate(){$zFeatures.migrateDB.signalDoneFullMigrate(),this.promoteSubject.setShouldPromote(!1)}async markDoneMigrateForCurrentUser(){const e=a.ModuleContainer.resolve(hQ.a);await e.setAdapterTypeOfUserScopedDatabases(this.session.userId,X$.a.SQLite),await e.setAdapterTypeOfSharedDatabases(X$.a.SQLite),this.updateMigrateDoneState({[this.session.userId]:Date.now()}),this.databaseStateStorage.removeItemForCurrentUser(Q$.d)}async signalSQLiteProcessToInitState(){const e={type:f.r,data:{session:this.session}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};await s.invokeMessage(i)}async signalSQLiteProcessToStartMigrate(){this.isMigrateStarted=!0;const e={type:f.G,data:{session:this.session}},t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i={typeID:f.m,data:e};await s.invokeMessage(i)}formatPercent(e){return e.toFixed(0)}async onMigrationProgress(e){const{data:t}=e,{error:s,migratedCount:i,toMigrateCount:n}=t;if(this.isTrickle||this.isSilentMigrate){if(s){this.migrateResolver.resolve(),CQ.b.getInstance().setDisableAnalyzeCorruption(!1);a.ModuleContainer.resolve(Us.TDBCorruptionDetector).forceCheckDBCorruptionFor(X$.a.IDB)}}else{const e=-1!==i?Math.min(100,100*i/n):100;this.migrateProgressPercent=i/n;const{percent:t,timeElapsed:a}=this.getMigratePercent(e);0,100===t&&this.logger.zsymb(3,"755qtD",["progress 100 - migrateProgress: {} - timeoutProgress: {}","yxAbSu"],e,Math.min(100*a/this.timeoutDuration,100));const r={timeElapsed:a};s?this.handleErrorDuringBigBangMigration(s.message||s):this.updateState(Object(I.a)({percent:this.formatPercent(t)},r))}}getMigratePercent(e){const t=this.getCurrentElapsedTime(),s=Math.min(100*t/this.timeoutDuration,100);return{percent:Math.max(e,s),timeElapsed:t}}handleErrorDuringBigBangMigration(e){this.isTrickle||this.taskScheduler.run({execute:()=>{this.stopBigBangMigrationTimers();const t=Object(Kt.c)(e);this.logger.zsymb(3,"ixOMJo",["[status] show error screen - error: {}","pSLT8v"],t),this.updateCurrentDisplayedMigrateUI(vu.d.BB_FAILED,{error:t});return new Promise((()=>{}))}})}showBigBangSuccessScreen(){this.showSuccessScreen||(this.showSuccessScreen=!0,this.logger.zsymb(0,"FJAe0h","[status] show success screen"),this.updateCurrentDisplayedMigrateUI(vu.d.BB_SUCCESS,{timeElapsed:this.getCurrentElapsedTime()}))}disposeMigrationUI(e){const t=()=>{this.logger.zsymb(0,"LQL3nU","[status] hide migrate ui due to release blocking ui"),this.hideMigrateUI(vu.d.TR_IN_PROGRESS),this.releaseBlockingAppLogic()};if(e){const e=this.config.nestedKey("auto_dismiss_success_screen");setTimeout(t,e)}else t()}async updateMigrateStateAsFinished(e){this.logger.zsymb(0,"KZJat0","[status] finish migrate"),await this.markDoneMigrateForCurrentUser(),await this.allUserHasMigrated()&&this.markDoneMigrate(),this.migrateResolver.resolve(),CQ.b.getInstance().setDisableAnalyzeCorruption(!1)}async handleDBMigrationMessage(){const e=a.ModuleContainer.resolve(p.b),t=await e.getPort(),s=async e=>{const{data:a}=e,{typeID:i}=a;if(i===f.m){const{data:e}=a,{type:i}=e;switch(i){case f.B:this.onMigrationProgress(e);break;case f.o:{const{data:a}=e;await this.updateMigrateStateAsFinished(a),this.removeListenerFullDiskFromSM(),this.isTrickle||(this.isSilentMigrate?(this.isSilentMigrate=!1,this.disposeMigrationUI(!1)):(this.logger.zsymb(0,"O2jm_q","[status] done big bang migration due to finish migration"),this.taskScheduler.run({execute:()=>{this.stopBigBangMigrationTimers(),this.showBigBangSuccessScreen(),this.disposeMigrationUI(!0),this.taskScheduler.stop()}}))),this.cleanupData(),this.cleanupInternalState(),this.stopHandleMigrateProcessDisconnected(),t.removeEventListener("message",s),this.removeDBCorruptionListener(),MQ.flushLogs();break}case f.y:{const{data:t}=e,{success:s,cmd:a,subCmd:i,duration:n,payload:r}=t;SQ.a.instance().submitQos(s,a,i,n,r),MQ.checkAndLog(a,r);break}}}};t.addEventListener("message",s)}addDBCorruptionListener(){a.ModuleContainer.resolve(Us.TDBCorruptionDetector).addEventListener(Bs.a.DB_CORRUPTION_DETECTED,this.handleDBCorruption)}removeDBCorruptionListener(){a.ModuleContainer.resolve(Us.TDBCorruptionDetector).removeEventListener(Bs.a.DB_CORRUPTION_DETECTED,this.handleDBCorruption)}getIsMigrationStarted(){const e=Object(gQ.a)();let t=e;try{t=this.databaseStateStorage.getObject(wq.a)||e}catch(CY){this.logger.zsymb(18,"_QnU6h","parse adapter type state error",Object(Kt.c)(CY))}return t[this.session.userId]===X$.a.SQLite}init(){}getItem(){return this.state}getList(){return[]}onGetItemFailure(){}onGetListFailure(){}updateState(e){this.state=Object(I.a)(Object(I.a)({},this.state),e),Object(nc.h)(this.name,vu.c)}})||OQ)||OQ)||OQ)||OQ)||OQ)||OQ;"render"==__ZaBUNDLENAME__&&(a.ModuleContainer.registerSingleton(vu.b,wQ),a.ModuleContainer.registerSingleton(xi.a,wQ));s("uiYo");var LQ,DQ=s("f4Qu"),AQ=s("Dprd"),FQ=s("XSmZ");Object(m.e)()(LQ=Object(As.e)()(LQ=Object(a.singleton)(DQ.a)(LQ=Reflect.metadata("design:type",Function)(LQ=Reflect.metadata("design:paramtypes",[])(LQ=class{constructor(){this.logger=void 0,this.confirmQuitApp=()=>{this.logger.zsymb(3,"fesDvv",["confirm app quit","0Dwk63"]);const e=this.getConfirmInfo();if(e){const t=()=>{this.logger.zsymb(3,"rkY4__",["abort app quit","-Dw-ZH"]),$zapp.cancelQuitApp()};this.showConfirm(e.confirmTitle,this.doQuitApp,t)}else this.doQuitApp()},this.doQuitApp=()=>{this.logger.zsymb(3,"OpZYrI",["do quit app","z3JTGQ"]),Bu.a.getInstance().storeItems(),Hv.b.deactiveApp(),a.ModuleContainer.resolve(by.a).onUserLogOff().then((e=>{pQ.a.clearSessionBeforeQuit(),pQ.a.closeDB($zapp.requestQuitAppImmediately)}))},this.onAppBeforeQuit=()=>{this.logger.zsymb(3,"SD185_",["onAppBeforeQuit","tBuSBv"]),$zFileManager.requestFlushZLog(),Me.g.getAvailableUpdate()&&Me.g.setAvailableUpdate(null)};const e=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=e.createZLogger("app-quit-flow",["main-window"])}onApplicationStart(e){this.logger.zsymb(3,"VjvCVJ",["onApplicationStart","RZHCqP"]),$zsub.$zapp.onConfirmAppQuit(this.confirmQuitApp),$zsub.$zapp.beforeAppQuit(this.onAppBeforeQuit)}onDispose(){this.logger.zsymb(3,"XrHqRD",["onDispose","hSGoJ7"]),$zsub.$zapp.removeListenConfirmAppQuit(this.confirmQuitApp),$zsub.$zapp.removeListenBeforeAppQuit(this.onAppBeforeQuit)}requestQuitApp(){this.logger.zsymb(3,"4Y4F1Z",["request quit app","UJ-5cw"]),$zwindow.quit()}getConfirmInfo(){let e=+vl.b.isUploading();!e&&AQ.default&&AQ.default.isDownloading()&&(e=2);let t=!1,s="";const a=FQ.default.isStarted;if(e>0&&a){const a=1===e?ce.a.str("STR_CONFIRM_QUIT_UPLOAD_TEXT"):ce.a.str("STR_CONFIRM_QUIT_DOWNLOAD_TEXT");s=`${ce.a.str("STR_CONFIRM_QUIT_EXPORT_IMPORT_1")} ${a} ${ce.a.str("STR_CONFIRM_QUIT_DOWNLOAD_SECOND")}`,t=!0}else if(a)s=`${ce.a.str("STR_CONFIRM_QUIT_EXPORT_IMPORT")}`,t=!0;else if(e>0){const a=1===e?ce.a.str("STR_CONFIRM_QUIT_UPLOAD_TEXT"):ce.a.str("STR_CONFIRM_QUIT_DOWNLOAD_TEXT");s=`${ce.a.str("STR_CONFIRM_QUIT_DOWNLOAD_FIRST")} ${a} ${ce.a.str("STR_CONFIRM_QUIT_DOWNLOAD_SECOND")}`,t=!0}return t?{confirmTitle:s}:null}showConfirm(e,t,s){pc.ConfirmManagerV2.openConfirm({windowId:Ar.c,name:Y.MODAL_CONFIRM.confirmIdentities,params:{message:e,okText:ce.a.str("STR_TITLE_PROFILE_EXIT"),cancelText:ce.a.str("STR_CONFIRM_NO"),onOk:t,onCancel:s}})}requestRelaunch(){this.logger.zsymb(3,"e54Xch",["just relaunch app","eq_99y"]),$zapp.requestRelaunch()}})||LQ)||LQ)||LQ)||LQ);const kQ=Object(a.define)("db-encrypt-remote-configs");var NQ,PQ=s("8zvx"),jQ=s("FKEL");E.j.timeInMs("1s"),E.j.timeInMs("100ms");const UQ={enable:!1,start_after:E.j.timeInMs("12s"),gap:E.j.timeInMs("200ms"),max_retry:3};Object(a.singleton)(kQ)(NQ=Reflect.metadata("design:type",Function)(NQ=Reflect.metadata("design:paramtypes",[])(NQ=class extends PQ.a{constructor(){super("db_encrypt",UQ,{validator:new jQ.a({enable:ee.b.field().boolean(),start_after:ee.b.field().number().min(0),gap:ee.b.field().number().min(10),max_retry:ee.b.field().number().max(10)})})}loadConfig(e){super.loadConfig(e)}})||NQ)||NQ);const BQ=Object(a.define)("database-encryption");var zQ=s("Brnv"),GQ=function(e){return e.NotStart="NotStart",e.Running="Running",e.Paused="Paused",e.Stopped="Stopped",e.Finished="Finished",e}(GQ||{});class xQ{constructor(){this.status=void 0,this.status=GQ.NotStart}canStart(){return this.status==GQ.NotStart||this.status==GQ.Paused}canPause(){return this.status==GQ.Running}start(){this.status=GQ.Running}pause(){this.status=GQ.Paused}stop(){this.status=GQ.Stopped}finish(){this.status=GQ.Finished}toString(){return this.status}}class VQ{constructor(e){this.taskInput=e}async run(){const e=a.ModuleContainer.resolve(p.b);return(await e.getPort()).invokeMessage(this.taskInput)}async onOnce(e){const t=a.ModuleContainer.resolve(p.b),s=await t.getPort(),i=async t=>{const{data:a}=t,{typeID:n}=a;if(n===this.taskInput.typeID){const{data:t}=a;t.type===this.taskInput.data.type&&(e(t.data),s.removeEventListener("message",i))}};s.addEventListener("message",i)}}class HQ extends VQ{constructor(e){super({typeID:f.l,data:{type:f.H,data:e}})}}class WQ extends VQ{constructor(e={}){super({typeID:f.l,data:{type:f.w,data:e}})}}class qQ extends VQ{constructor(e={}){super({typeID:f.l,data:{type:f.t,data:e}})}}class KQ extends VQ{constructor(e={}){super({typeID:f.l,data:{type:f.d,data:e}})}}const ZQ=152080,$Q=0,QQ=152081,YQ=0;class JQ{onEncryptionStart(){kc.default.increaseSuccess(ZQ,$Q,0)}onEncryptionFinish(e){const t=e.stats;e.success?kc.default.increaseSuccess(QQ,YQ,0,[JSON.stringify(t)]):kc.default.increaseFailed(QQ,YQ,0,t.failure/5,0,[JSON.stringify(t)])}onStartEncryptFail(e){kc.default.increaseFailed(ZQ,$Q,0,null==e?void 0:e.code,0,[JSON.stringify(null==e?void 0:e.message)])}}var XQ=s("PObO"),eY=s("UPII");let tY=function(e){return e.NotStarted="notStarted",e.Running="running",e.Finished="finished",e}({});class sY{constructor(){this.capturing=!1,this.handleCaptureStatusChanged=(e,t)=>{this.capturing=t}}start(){$zsub.$zscreencap.onChangeStatus(this.handleCaptureStatusChanged)}dispose(){$zsub.$zscreencap.removeListenChangeStatus(this.handleCaptureStatusChanged)}isCalling(){return fl.d.isCalling()}isCapturing(){return this.capturing}isTransferring(){return a.ModuleContainer.resolve(vm.a).isThisSessionSyncing()}isImportExporting(){return FQ.default.isStarted}isAppBusy(){return this.isCalling()||this.isCapturing()||this.isTransferring()||this.isImportExporting()}}var aY;Object(m.f)()(aY=Object(m.j)()(aY=Object(m.h)()(aY=Object(a.injectable)()(aY=Object(a.singleton)(BQ)(aY=function(e,t){return Object(a.inject)(kQ)(e,void 0,0)}(aY=function(e,t){return Object(a.inject)(zQ.b)(e,void 0,1)}(aY=Reflect.metadata("design:type",Function)(aY=Reflect.metadata("design:paramtypes",[void 0===kQ?Object:kQ,void 0===zQ.IDatabaseStateStorage?Object:zQ.IDatabaseStateStorage])(aY=class{constructor(e,t){this.config=e,this.databaseStorage=t,this.status=void 0,this.session=void 0,this.startTimmer=void 0,this.scheduler=void 0,this.handleEventQueue=void 0,this.listenEncryptTask=void 0,this.helper=void 0,this.logger=void 0,this.canTriggerEncrypt=async()=>{if(!this.config.nestedKey("enable"))return this.logger.zsymb(0,"v2HU6w","[Trigger encrypt] - Disable by config"),Promise.resolve(!1);if(this.startTimmer)return this.logger.zsymb(0,"H7ymlc","[Trigger encrypt] - timmer is running"),Promise.resolve(!1);if(!this.status.canStart())return this.logger.zsymb(0,"61B3G1","[Trigger encrypt] - Invalid status:",this.status.toString()),Promise.resolve(!1);if(null==this.session)return this.logger.zsymb(0,"ZPXyYb","[Trigger encrypt] - not authen yet"),Promise.resolve(!1);const e=a.ModuleContainer.resolve(vu.b).currentUserHasMigratedInAnyPhase();return await e?Promise.resolve(!0):(this.logger.zsymb(0,"KEddhA","[Trigger encrypt] - Need wait done migrate to SQLite"),Promise.resolve(!1))},this.handleAppVisiblityChange=(e,t)=>{this.handleEventQueue.pushTask((async()=>{this.logger.zsymb(0,"EY3a-N","Visiblity changed:",t.state),"visible"==t.state&&(this.removeStartTimer(),await this.pause()),"hidden"==t.state&&(this.helper.isCapturing()||this.helper.isCalling()?this.logger.zsymb(0,"bgfsPQ","app is capturing or calling"):(await this.start(),this.listenEncryptResult()))}))},this.status=new xQ,this.session=null,this.startTimmer=null,this.scheduler=new eY.b,this.handleEventQueue=new eY.b,this.listenEncryptTask=null,this.helper=new sY;const s=a.ModuleContainer.resolve(es.ZLoggerFactory);this.logger=s.createZLogger("db-encryption",["manager"])}onAuthenticated(e){this.session=e.getSession(),this.databaseStorage.authenticate(e.getSession())}onStart(){this.helper.start(),this.setupEvents(),this.checkMigrateAbnormaly()}onDispose(){this.clearEvents()}checkMigrateAbnormaly(){this.handleEventQueue.pushTask((async()=>{if(await(new KQ).run()!==tY.Running)return;this.logger.zsymb(18,"yOIQfl","The encryption is running in DB process"),this.status.start();"hidden"==await $zapp.getAppVisibilityStatus()?(this.logger.zsymb(0,"Q3Xtq1","App still hidden, recover"),this.listenEncryptResult()):(this.logger.zsymb(0,"z6seXF","App visible, pause"),this.pause())}))}setupEvents(){$zsub.$zapp.onAppVisibilityChanged(this.handleAppVisiblityChange)}clearEvents(){this.logger.zsymb(18,"2CARyd","clear all event listeners"),$zsub.$zapp.removeListenAppVisibilityChanged(this.handleAppVisiblityChange),this.listenEncryptTask=null,this.helper.dispose()}async start(){const e=this.scheduler.pushTask(this.canTriggerEncrypt);if(!(await e))return!1;const t=this.config.nestedKey("start_after");return this.logger.zsymb(0,"rfX5l7","schedule to check start",t),this.startTimmer=setTimeout((async()=>{this.startTimmer=null,this.helper.isAppBusy()?this.logger.zsymb(0,"LgDE_M","[Timer expires] - app is busy, skip"):this.doStart()}),t),!0}pause(){return new Promise((e=>this.status.canPause()?(this.doPause(),e(!0)):(this.logger.zsymb(0,"8ZHzK0","Current status:",this.status.toString()),e(!1))))}async doStart(){this.logger.zsymb(0,"H5ZUDw","Check start - currStatus:",this.status.toString()),this.status.start();const e=await a.ModuleContainer.resolve(XQ.a).getUserScopeKey(),t=await a.ModuleContainer.resolve(XQ.a).getSharedKey();return new HQ({enable:this.config.nestedKey("enable"),gap:this.config.nestedKey("gap"),maxRetry:this.config.nestedKey("max_retry"),cipher:{userKey:e,sharedKey:t}}).run().then((e=>(e?(this.logger.zsymb(0,"ooYPwX","Started encrypt databases."),(new JQ).onEncryptionStart()):(this.logger.zsymb(0,"qj4Dgh","Task is not running."),this.status.stop(),this.clearEvents()),e))).catch((e=>(this.logger.zsymb(0,"r3ap_E","Fail to start.",null==e?void 0:e.message),this.status.stop(),this.clearEvents(),(new JQ).onStartEncryptFail(e),!1)))}doPause(){this.logger.zsymb(0,"jOo906","doPause - currStatus:",this.status.toString()),this.status.pause();return(new WQ).run()}listenEncryptResult(){this.listenEncryptTask||(this.listenEncryptTask=new qQ,this.listenEncryptTask.onOnce((e=>{const t=Object(Bv.f)(e);this.logger.zsymb(0,"h1fl7v","Done encrypt All DB",t),this.clearEvents(),this.status.stop(),(new JQ).onEncryptionFinish(e)})))}removeStartTimer(){this.startTimmer&&(clearTimeout(this.startTimmer),this.startTimmer=null,this.logger.zsymb(0,"SkZnKN","remove start timmer"))}})||aY)||aY)||aY)||aY)||aY)||aY)||aY)||aY);var iY;s("pQlW");Object(As.b)()(iY=Object(a.singleton)()(iY=Reflect.metadata("design:type",Function)(iY=Reflect.metadata("design:paramtypes",[])(iY=class{constructor(){}onApplicationStart(e){$zapp.notifyAppStarted()}})||iY)||iY)||iY);var nY,rY=s("vyAj");let oY=Object(a.injectable)()(nY=Object(m.h)()(nY=Object(m.j)()(nY=Object(a.singleton)()(nY=Reflect.metadata("design:type",Function)(nY=Reflect.metadata("design:paramtypes",[])(nY=class{constructor(){}onStart(){rY.b.on(rY.a.UPDATE_SERVER_CONFIG_BY_SOCKET,this.handleReceiveConfig.bind(this))}onDispose(){rY.b.off(rY.a.UPDATE_SERVER_CONFIG_BY_SOCKET,this.handleReceiveConfig.bind(this))}handleReceiveConfig(e){return!!this.isValidConfig(e.payload)&&(this.handleUpdateConfig(e.payload),!0)}isValidConfig(e){return!!e&&("object"==typeof e&&(!!e.hasOwnProperty("data")&&(!!e.data.hasOwnProperty("actions")&&(!!Array.isArray(e.data.actions)&&(!!e.data.actions.length&&this.isValidActions(e.data.actions))))))}isValidActions(e){let t=!0;for(const s of e)s.act!==lY.ACT&&(t=!1),s.act_type!==lY.ACT_TYPE&&(t=!1),this.isValidJsonObjConf(s.data)||(t=!1);return t}isValidJsonObjConf(e){if(!e)return!1;try{let t=JSON.parse(e);return"object"==typeof t&&!Array.isArray(t)}catch(CY){return!1}}getObjConfFromAction(e){try{return JSON.parse(e.data)}catch(CY){return null}}handleUpdateConfig(e){e.data.actions.forEach((e=>{const t=this.getObjConfFromAction(e);t&&hM.default.updateConfigBySocket(t)}))}parsePathToObject(e,t){let s=e.split("?.").join("."),a=[],i="",n=!1,r=!1;for(let l=0;l<s.length;l++){let e=s[l];"["===e?(i&&a.push(i),i="",n=!0,r=!1):"]"===e?(n=!1,r?a.push(i):a.push(parseInt(i,10)),i=""):"'"===e||'"'===e?r=!0:"."!==e||n?i+=e:(i&&a.push(i),i="")}i&&a.push(i);let o="number"==typeof a[0]?[]:{},c=o;for(let l=0;l<a.length;l++){let e=a[l],s=a[l+1];l===a.length-1?c[e]=t:"number"==typeof s?(c[e]=c[e]||[],c=c[e]):(c[e]=c[e]||{},c=c[e])}return o}})||nY)||nY)||nY)||nY)||nY)||nY;const cY=Object(a.define)("server-info-socket-token");a.ModuleContainer.registerSingleton(cY,oY);const lY={ACT:"server_info",ACT_TYPE:"update_config"};var dY,uY=s("ABnx");E.j.timeInMs("5s"),H.a.CHAT;const hY={enable:!1,start_after:E.j.timeInMs("60s"),batch_size:20,domains:[H.a.CHAT],disable_keepalive:!1};let gY=Object(a.singleton)()(dY=Reflect.metadata("design:type",Function)(dY=Reflect.metadata("design:paramtypes",[])(dY=class extends X.AdvancedRemoteConfigs{constructor(){super("net_monitor",hY,{validator:new X.ObjectValidator({enable:X.Rule.field().boolean(),start_after:X.Rule.field().number().min(0),batch_size:X.Rule.field().number().min(1),domains:X.Rule.field().array("string"),disable_keepalive:X.Rule.field().boolean()})})}getConfigs(){return this.configs}})||dY)||dY)||dY;a.ModuleContainer.registerSingleton(uY.a,gY);class mY extends hs.b{start(){}}var pY,fY=mY;Object(m.j)()(pY=Object(a.singleton)(Hd)(pY=class extends fY{conversationWillClose(e,t){super.dispatchEvent(new Kd(e,t))}conversationDidClose(e,t){super.dispatchEvent(new Zd(e,t))}conversationWillOpen(e,t){super.dispatchEvent(new Yd(e,t))}conversationDidOpen(e,t){super.dispatchEvent(new Jd(e,t))}conversationWillDelete(e,t){super.dispatchEvent(new $d(e,t))}conversationDidDelete(e,t){super.dispatchEvent(new Qd(e,t))}onStart(){this.start()}start(){const e=Object.keys(nu);e.length>0&&e.forEach((e=>{const t=nu[e];this.addEventListener(e,(e=>{t.targets.forEach((s=>{try{var i,n;null===(i=(n=a.ModuleContainer.resolveToken(s))[t.callback])||void 0===i||i.call(n,e)}catch(r){}}))}))})),super.start()}})||pY);var vY=s("GFHO");s("zlHd");function _Y(){const e=Va.a.resolveAll(Wa.a);for(const t of e)t.init()}(function(e){const t=new vY.a(e);if(t.remoteConfigs.key("enable").boolean)_Y();else{const e=()=>{t.remoteConfigs.key("enable").boolean&&(_Y(),t.remoteConfigs.remove(e))};t.remoteConfigs.add(e)}})({platform:"pc"});var bY,IY=s("VHyX"),yY=s("05Vw");const SY=Object(a.define)("cloud-init");Object(m.d)()(bY=Object(m.f)()(bY=Object(m.h)()(bY=Object(a.singleton)(SY)(bY=class{onApplicationReady(e){Object(IY.d)("onApplicationReady"),yY.a.getInstance().clean()}onAuthenticated(e){Object(IY.d)("onAuthenticated")}onDispose(){Object(IY.d)("onDispose"),yY.a.getInstance().clean()}})||bY)||bY)||bY)},"5Ew1":function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var a=s("VTBJ"),i=s("jDHv"),n=s("iZzu"),r=s("WQAo"),o=s("igA5"),c=s("Mgpg"),l=s("h0S/");const d="draft_prev_s";class u{constructor(){this.logger=void 0,this.isInit=void 0,this.data=void 0}get Logger(){return this.logger||(this.logger=i.ModuleContainer.resolve(c.ZLoggerFactory).createZLogger(l.ZLoggerNametags.updater,["previous-state-keeper"])),this.logger}updateData(e,t){const s={currentTab:e};t&&(s.convId=t),this.data=s,o.default.getInstance().setItemForCurrentUser(d,JSON.stringify(s))}init(){this.isInit=!0;const e=o.default.getInstance().getItemForCurrentUser(d);if(e){try{this.data=JSON.parse(e)}catch{this.data=null}o.default.getInstance().removeItemForCurrentUser(d)}}backup(){const e=i.ModuleContainer.resolve(n.SidebarController),t=e.getCurrMainConvId(),s=e.getState().currentTab;this.updateData(s,t),this.Logger.zsymb(0,"P4V3Bp","done backup",s,t)}async restore(){if(this.isInit||this.init(),this.data){const{currentTab:e,convId:t}=this.data,s=i.ModuleContainer.resolve(n.SidebarController);s.getState().currentTab!==e&&s.changeTab(e),e===n.SidebarTab.MESSAGE_TAB&&t&&await i.ModuleContainer.resolve(r.b).openConversation(t,Object(a.a)(Object(a.a)({},r.c),{},{silently:!0,byPassPIN:!0})),this.Logger.zsymb(0,"cwK1uR","done restore",e,t)}else this.Logger.zsymb(18,"dj_nks","call restore but no data")}}},AHxZ:function(e,t,s){0},"E/H5":function(e,t,s){"use strict";var a=s("w+Cq");s.o(a,"DraftInputKeeper")&&s.d(t,"DraftInputKeeper",(function(){return a.DraftInputKeeper})),s.o(a,"PreviousStateKeeper")&&s.d(t,"PreviousStateKeeper",(function(){return a.PreviousStateKeeper}));var i=s("5Ew1");s.d(t,"PreviousStateKeeper",(function(){return i.a}));var n=s("H+4v");s.d(t,"DraftInputKeeper",(function(){return n.a}))},FCbV:function(e,t){},"H+4v":function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var a=s("VTBJ"),i=s("QVpS"),n=s("igA5"),r=s("jDHv"),o=s("yzMR"),c=s("U+ds"),l=s("bUXd"),d=s("Ydol"),u=s("97kL"),h=s("3xbP"),g=s("Mgpg"),m=s("h0S/");const p="draft_input";class f{constructor(){this.data=void 0,this.isInit=void 0,this.logger=void 0}get Logger(){return this.logger||(this.logger=r.ModuleContainer.resolve(g.ZLoggerFactory).createZLogger(m.ZLoggerNametags.updater,["draft-input-keeper"])),this.logger}shouldSaveDraftItem(e){var t,s,a;return!!e&&((!e.files||!e.files.length)&&!!(e.quote||null!==(t=e.mentions)&&void 0!==t&&t.length||null!==(s=e.contact)&&void 0!==s&&s.previewProfile||null!==(a=e.states)&&void 0!==a&&a.text))}isValidDraftItem(e){return!(!e||"object"!=typeof e||!e.hasOwnProperty("draftTime"))}updateData(e,t,s){this.data||(this.data={draftTimeMap:{},savedLastState:{}}),this.data.draftTimeMap[e]=s,this.data.savedLastState[e]=t}init(){this.isInit=!0;const e=n.default.getInstance().getItemForCurrentUser(p);if(e){try{const t=JSON.parse(e);t&&"object"==typeof t&&Object.keys(t).forEach((e=>{if(this.isValidDraftItem(t[e])){const s=t[e].draftTime;delete t[e].draftTime,this.updateData(e,t[e],s)}}))}catch(t){this.Logger.zsymb(18,"FD3kCE","parse cache error",t)}n.default.getInstance().removeItemForCurrentUser(p)}}backup(){d.default.emit(u.ChatInputAction.SAVE_DRAFT);const{savedLastState:e,draftTimeMap:t}=i.b,s={};let r=!1;Object.keys(e).forEach((i=>{this.shouldSaveDraftItem(e[i])&&(s[i]=Object(a.a)(Object(a.a)({},e[i]),{},{draftTime:t[i]||l.default.getTimeNow()}),r||(r=!0))})),r&&(n.default.getInstance().setItemForCurrentUser(p,JSON.stringify(s)),this.Logger.zsymb(0,"XWM2i1","done backup",t))}async restore(){if(this.isInit||this.init(),this.data){const e=this.data.draftTimeMap,t=this.data.savedLastState;Object.keys(t).forEach((s=>{var n,l;i.b.savedLastState[s]=t[s],i.b.draftTimeMap[s]=e[s],null!==(n=t[s].states)&&void 0!==n&&null!==(l=n.styles)&&void 0!==l&&l.length&&r.ModuleContainer.resolve(c.j).setChatInputType(h.c,s,{name:c.k.RTF,info:{mode:c.o.MINI,inputType:c.k.RTF}},!0),r.ModuleContainer.resolve(o.PreviewDataManager).onChangeDraft(s,Object(a.a)(Object(a.a)({},Object(i.a)(t[s],{},s)),{},{draftTime:e[s]}))})),this.data=null,this.Logger.zsymb(0,"HJJbAK","done restore")}}}},"ILT/":function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var a,i,n=s("igA5"),r=s("ezRR"),o=s("E/Lo"),c=s("QDKs"),l=s("UHN6"),d=s("dKg8"),u=s("jx7S");let h=Object(r.c)()(a=Reflect.metadata("design:type",Function)(a=Reflect.metadata("design:paramtypes",[])((i=class e extends r.b{constructor(){super(),this.name="",this.state=void 0,this.microTaskQueue=[],this.taskQueue=[],this.runTaskQueue=[],this.currentTask=void 0,this.backupData={},this.backupDataTimer=void 0,this.tookBackupKeys={},this.timer=void 0,this.timerCount=0,this.tempTaskId=void 0,this.storage=void 0,this.state="running"===this.appStatus?"running":"created"}create(){for(const t in e.instances){const s=e.instances[t];Object(o.d)()&&c.a.info(l.c,`ID: ${s.id} - TASK_MANAGER_CREATED`),s.state="created"}}running(){for(const t in e.instances){const s=e.instances[t];Object(o.d)()&&c.a.info(l.c,`ID: ${s.id} - TASK_MANAGER_RUNNING`),s.state="running",s.prepare()}}stop(){for(const t in e.instances){const s=e.instances[t];Object(o.d)()&&c.a.info(l.c,`ID: ${s.id} - TASK_MANAGER_STOP`),s.state="stop",s.clearTimer()}}setup(t){if(!t)throw new Error("TaskManager name is required.");return this.name=t,e.instances[this.getNameAsKey()]?e.instances[this.getNameAsKey()]:(e.instances[this.getNameAsKey()]=this,this.storage=n.default.getInstance(),"running"===this.state&&this.prepare(),this)}createTask(e,t){if(!this.name)throw new Error("TaskManager is not setup.");return new d.a(e,this,t)}addTask(e){var t,s;Object(o.d)()&&c.a.info(l.c,`ID: ${this.id} - ADD_TASK`,Object(u.b)(e),e.backupData||""),"immediately"===(null===(t=e.options)||void 0===t?void 0:t.priority)?this.runTaskQueue.unshift(e):"high"===(null===(s=e.options)||void 0===s?void 0:s.priority)?this.microTaskQueue.push(e):this.taskQueue.push(e),e.isRestore&&this.restoreBackup(e)}runTask(e){"running"!==this.state||this.currentTask?e&&this.addBackup(e):(this.currentTask=this.findNextTask(),this.currentTask?(Object(o.d)()&&c.a.info(l.c,`ID: ${this.id} - RUN_TASK`,Object(u.b)(this.currentTask),this.currentTask.backupData,`runTaskQueue: ${this.runTaskQueue.length} - microTaskQueue: ${this.microTaskQueue.length} - taskQueue: ${this.taskQueue.length}`),this.addBackup(this.currentTask),this.currentTask.run(),this.tempTaskId=this.currentTask.id):Object(o.d)()&&c.a.info(l.c,`ID: ${this.id} - NO_TASK_TO_RUN`))}doneTask(e,t=!1,s){var a,i,n;if(Object(o.d)()){const a=s?` - Reason: ${s}`:"";c.a.info(l.c,`ID: ${this.id} - DONE_TASK`,`isForce: ${t} - Task ${Object(u.b)(e)}${a}`,this.currentTask?`Current task ${Object(u.b)(this.currentTask)}`:"")}(null===(a=this.currentTask)||void 0===a?void 0:a.id)===e.id?(null!==(i=e.options)&&void 0!==i&&null!==(n=i.backup)&&void 0!==n&&n.key&&this.removeBackup(e),this.currentTask=void 0,this.tempTaskId=void 0):t&&this.findAndRemoveTask(e);this.runTask()}getBackupData(e){return this.backupData[e]}async prepare(){try{var e;const t=await(null===(e=this.storage)||void 0===e?void 0:e.getItemForCurrentUserAsync(this.getBackupKey()));t&&(this.backupData=JSON.parse(t))}catch(t){}finally{this.runBackup(),this.runTask(),this.runTimer()}}restoreBackup(e){var t,s;if("running"!==this.state)return;const a=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;if(!a||Object(o.e)(this.backupData[a])||this.tookBackupKeys[a])e.restore();else{Object(o.d)()&&c.a.info(l.c,`ID: ${this.id} - GET_BACKUP_DATA_FROM_DB`,Object(u.b)(e),this.backupData[a]),this.tookBackupKeys[a]=!0;const t=Object(u.a)(this.backupData[a]);this.resetBackup(e),e.restore(t)}}addBackup(e){var t,s;const a=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;a&&e.backupData&&(this.backupData[a]||(this.backupData[a]={}),this.backupData[a][e.id]=e.backupData,this.saveBackupData())}removeBackup(e){var t,s;const a=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;var i;a&&(null===(i=this.backupData[a])||void 0===i||delete i[e.id],this.saveBackupData())}runBackup(){for(const e in this.backupData){const t=this.runTaskQueue.find((t=>{var s,a;return(null===(s=t.options)||void 0===s||null===(a=s.backup)||void 0===a?void 0:a.key)===e}))||this.microTaskQueue.find((t=>{var s,a;return(null===(s=t.options)||void 0===s||null===(a=s.backup)||void 0===a?void 0:a.key)===e}))||this.taskQueue.find((t=>{var s,a;return(null===(s=t.options)||void 0===s||null===(a=s.backup)||void 0===a?void 0:a.key)===e}));(null==t?void 0:t.isRestore)&&this.restoreBackup(t)}}resetBackup(e){var t,s;const a=null===(t=e.options)||void 0===t||null===(s=t.backup)||void 0===s?void 0:s.key;a&&(delete this.backupData[a],this.saveBackupData())}getBackupKey(){return`${l.a}_${this.getNameAsKey()}`}getNameAsKey(){return this.name.replace(/ /gi,"_")}saveBackupData(){this.backupDataTimer||(this.backupDataTimer=setTimeout((()=>{var e;null===(e=this.storage)||void 0===e||e.setItemForCurrentUserAsync(this.getBackupKey(),JSON.stringify(this.backupData)),this.backupDataTimer=void 0,Object(o.d)()&&c.a.info(l.c,"SAVE_BACKUP_DATA",this.backupData)}),l.f))}findNextTask(){let e=[];if(e=Object(u.c)(this.microTaskQueue),this.runTaskQueue=this.runTaskQueue.concat(e),e=Object(u.c)(this.taskQueue),this.runTaskQueue=this.runTaskQueue.concat(e),this.runTaskQueue.length>0)return this.runTaskQueue.shift()}findAndRemoveTask(e){this.microTaskQueue=this.microTaskQueue.filter((t=>t.id!==e.id)),this.taskQueue=this.taskQueue.filter((t=>t.id!==e.id)),this.runTaskQueue=this.runTaskQueue.filter((t=>t.id!==e.id))}runTimer(){this.timer||(this.timer=setInterval((()=>{var e;(this.timerCount++,l.b/l.e===this.timerCount)&&(null!==(e=this.currentTask)&&void 0!==e&&e.id&&this.currentTask.id===this.tempTaskId&&c.a.warn(l.c,`ID: ${this.id} - TASK_TIMER Task (${Object(u.b)(this.currentTask)}) is running too long.`))}),l.e))}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=void 0,this.timerCount=0)}},i.instances={},a=i))||a)||a)||a},KGrx:function(e,t,s){"use strict";var a=s("ILT/");s.d(t,"TaskManager",(function(){return a.a}));s("dKg8"),s("qU4b")},Lp8g:function(e,t){globalThis.hasOwnProperty("$recoilDebugStates")&&(globalThis.$recoilDebugStates.push=function(...e){this.length>=100&&Array.prototype.splice.apply(this,[0,Math.round(this.length/2)]),Array.prototype.push.apply(this,e)})},Pswx:function(e,t,s){"use strict";s("1JlB");var a=s("DvQV");s.d(t,"a",(function(){return a.a})),s.d(t,"b",(function(){return a.b})),s.d(t,"c",(function(){return a.c})),s.d(t,"d",(function(){return a.d})),s.d(t,"e",(function(){return a.e})),s.d(t,"f",(function(){return a.f})),s.d(t,"g",(function(){return a.g})),s.d(t,"h",(function(){return a.h})),s.d(t,"i",(function(){return a.i})),s.d(t,"j",(function(){return a.j})),s.d(t,"k",(function(){return a.k})),s.d(t,"l",(function(){return a.l})),s.d(t,"m",(function(){return a.m})),s.d(t,"n",(function(){return a.n})),s.d(t,"o",(function(){return a.o})),s.d(t,"p",(function(){return a.p})),s.d(t,"q",(function(){return a.q})),s.d(t,"r",(function(){return a.r})),s.d(t,"s",(function(){return a.s})),s.d(t,"t",(function(){return a.t})),s.d(t,"u",(function(){return a.u})),s.d(t,"v",(function(){return a.v})),s.d(t,"w",(function(){return a.w})),s.d(t,"x",(function(){return a.x})),s.d(t,"y",(function(){return a.y})),s.d(t,"z",(function(){return a.z})),s.d(t,"A",(function(){return a.A})),s.d(t,"B",(function(){return a.B})),s.d(t,"C",(function(){return a.C})),s.d(t,"D",(function(){return a.D})),s.d(t,"E",(function(){return a.E})),s.d(t,"F",(function(){return a.F})),s.d(t,"G",(function(){return a.G})),s.d(t,"H",(function(){return a.H})),s.d(t,"I",(function(){return a.I})),s.d(t,"J",(function(){return a.J})),s.d(t,"K",(function(){return a.K})),s.d(t,"L",(function(){return a.L})),s.d(t,"M",(function(){return a.M})),s.d(t,"N",(function(){return a.N})),s.d(t,"O",(function(){return a.O})),s.d(t,"P",(function(){return a.P})),s.d(t,"Q",(function(){return a.Q})),s.d(t,"R",(function(){return a.R})),s.d(t,"S",(function(){return a.S})),s.d(t,"T",(function(){return a.T})),s.d(t,"U",(function(){return a.U})),s.d(t,"V",(function(){return a.V})),s.d(t,"W",(function(){return a.W})),s.d(t,"X",(function(){return a.X})),s.d(t,"Y",(function(){return a.Y}))},QDKs:function(e,t,s){"use strict";var a=s("VTBJ");const i="@LOGGER",n=Object(a.a)(Object(a.a)({},console),{},{info:(e,...t)=>{const s=`%c${i}::INFO`;zconsole.info(s,"font-weight: bold; color: #35611b; background-color: #dcffc6; padding: 2px 5px; border-radius: 5px;",e,...t)},warn:(e,...t)=>{const s=`%c${i}::WARN`;zconsole.warn(s,"font-weight: bold; color: #de6800; background-color: #ffdbbc; padding: 2px 5px; border-radius: 5px;",e,...t)},error:(e,...t)=>{const s=`%c${i}::ERROR`;zconsole.error(s,"font-weight: bold; color: #e11c1c; background-color: #ffc9c9; margin-left: 5px; padding: 2px 5px; border-radius: 5px;",e,...t)},zlog:zconsole});t.a=n},SF1S:function(e,t){},T9Ct:function(e,t,s){"use strict";var a=s("nVrC");s.d(t,"DraftKeepingManager",(function(){return a.a}));var i=s("E/H5");s.o(i,"DraftInputKeeper")&&s.d(t,"DraftInputKeeper",(function(){return i.DraftInputKeeper})),s.o(i,"PreviousStateKeeper")&&s.d(t,"PreviousStateKeeper",(function(){return i.PreviousStateKeeper}))},UHN6:function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return i})),s.d(t,"f",(function(){return n})),s.d(t,"e",(function(){return r})),s.d(t,"b",(function(){return o})),s.d(t,"d",(function(){return c}));const a="[@TASK_MANAGEMENT]",i="t_m_t_q__",n=500,r=1e4,o=2e4,c=2e4},WOja:function(e,t){},dKg8:function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var a=s("E/Lo"),i=s("QDKs"),n=s("UHN6"),r=s("jx7S");class o{constructor(e,t,s){this._options=void 0,this._name=void 0,this._id=void 0,this._taskManager=void 0,this._state=void 0,this._retry=0,this._waitForRetry=1e3,this._retryCheatingCount=0,this._backupData=void 0,this._timeout=n.d,this._timer=void 0,this._restore=void 0,this._executor=void 0,this._error=void 0,this._options=s,this._name=e,this._id=Object(a.g)(),this._taskManager=t,this._state="created",this._retry=(null==s?void 0:s.retry)||this._retry,this._waitForRetry=(null==s?void 0:s.waitForRetry)||this._waitForRetry,this._timeout=(null==s?void 0:s.timeout)||this._timeout,this._taskManager.addTask(this),this._createTimer(!0)}get options(){return this._options}get name(){return this._name}get id(){return this._id}get state(){return this._state}get backupData(){return this._backupData}get isRestore(){return void 0!==this._restore}onRestore(e){this._restore=e}onError(e){this._error=e}execute(e,t){"ended"===this.state&&(this._state="created",this._taskManager.addTask(this)),this._clearTimer(),this._state="ready",this._backupData=t,this._executor=e,this._taskManager.runTask(this)}close(e=!1,t){this._clearTimer(),this._state="ended",this._taskManager.doneTask(this,e,t)}destroy(){}restore(e){var t;null===(t=this._restore)||void 0===t||t.call(this,e)}async run(){try{if("created"===this.state||"running"===this.state)return;if(!this._executor)throw new Error("Task executor is not defined.");this._createTimer(),this._state="running";window.$taskCheatingFailCount;0,await this._executor()}catch(t){var e;if(this._retry>0)return Object(a.d)()&&i.a.info(n.c,"TASK_RETRY",this._retry,Object(r.b)(this),t),this._retry--,void Object(a.i)(this._waitForRetry).then((()=>{this._state="ready",this.run()}));Object(a.d)()&&i.a.error(n.c,"TASK_ERROR",Object(r.b)(this),t),null===(e=this._error)||void 0===e||e.call(this,t),this.close()}}_createTimer(e=!1){this._clearTimer(),this._timer=setTimeout((()=>{this.close(!0),this._timer=void 0,Object(a.d)()&&i.a.warn(n.c,`Task (Name: ${this.name} - ID: ${this.id}) is timeout.${e?" Task is not defined executor.":""}`)}),this._timeout)}_clearTimer(){this._timer&&clearTimeout(this._timer),this._timer=void 0}}},i2tm:function(e,t,s){"use strict";s.r(t);var a=s("3rNm");s.d(t,"cast",(function(){return a.a}));var i=s("kaMP");s.d(t,"gather",(function(){return i.a}));var n=s("3hph");s.d(t,"stridedSlice",(function(){return n.a}));var r=s("kRdc");s.d(t,"add",(function(){return r.a}));var o=s("zvA9");s.d(t,"greater",(function(){return o.a}));var c=s("SHv8");s.d(t,"matMul",(function(){return c.a}));var l=s("AV8V");s.d(t,"scalar",(function(){return l.a}));var d=s("parS");s.d(t,"mul",(function(){return d.a}));var u=s("/7N0");s.d(t,"sigmoid",(function(){return u.a}));var h=s("QYQ3");s.d(t,"squaredDifference",(function(){return h.a}));var g=s("oAkI");s.d(t,"sub",(function(){return g.a}));var m=s("Ei6o");s.d(t,"mean",(function(){return m.a}));var p=s("2ugP");s.d(t,"expandDims",(function(){return p.a}));var f=s("k7Jv");s.d(t,"square",(function(){return f.a}));var v=s("4FMF");s.d(t,"sum",(function(){return v.a}));var _=s("Z5Ez");s.d(t,"where",(function(){return _.a}));var b=s("Fjpt");s.d(t,"sqrt",(function(){return b.a}));var I=s("CfTU");s.d(t,"maximum",(function(){return I.a}));var y=s("x3y4");s.d(t,"div",(function(){return y.a}))},jx7S:function(e,t,s){"use strict";function a(e){const t=[];for(let s=0;s<e.length;s++){const a=e[s];"ready"===a.state&&(t.push(a),e.splice(s,1),s--)}return t}function i(e){return`Name: ${e.name} - ID: ${e.id}`}function n(e){try{return JSON.parse(JSON.stringify(e))}catch(t){return}}s.d(t,"c",(function(){return a})),s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return n}))},nVrC:function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var a=s("jDHv");const i=Object(a.define)("draft-keeping-manager")},oSk7:function(e,t,s){"use strict";class a{constructor(e){this.stream=void 0,this.stream=e}pipe(e){return this.stream=a.transformStream(this.stream,e),this}getStream(){return this.stream}static transformStream(e,t,s){try{return e.pipeThrough(new TransformStream(t))}catch(a){const s=e.getReader();return new ReadableStream({start(e){var s;const a={desiredSize:null,enqueue(t){e.enqueue(t)},error(e){},terminate(){}};return null===(s=t.start)||void 0===s?void 0:s.call(t,a)},async pull(e){let a=!1;const i={desiredSize:null,enqueue(t){a=!0,t&&e.enqueue(t)},error(e){},terminate(){}};for(;!a;){var n;const a=await s.read();var r;if(a.done)return await(null===(r=t.flush)||void 0===r?void 0:r.call(t,i)),e.close();await(null===(n=t.transform)||void 0===n?void 0:n.call(t,a.value,i))}}})}}static createReadbleStreamFromArrayBuffer(e,t=2**20){const s=Math.ceil(e.byteLength/t);return new ReadableStream({start(a){for(let i=0;i<=s;i++)a.enqueue(new Uint8Array(e,i*t,t));a.close()}})}}t.a=a},qU4b:function(e,t){},taJj:function(e,t,s){"use strict";t.a=class{constructor(e){this.chunkSize=void 0,this.partialChunk=void 0,this.offset=void 0,this.chunkSize=e,this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}send(e,t){t.enqueue(e),this.partialChunk=new Uint8Array(this.chunkSize),this.offset=0}transform(e,t){let s=0;if(this.offset>0){const a=Math.min(e.byteLength,this.chunkSize-this.offset);this.partialChunk.set(e.slice(0,a),this.offset),this.offset+=a,s+=a,this.offset===this.chunkSize&&this.send(this.partialChunk,t)}for(;s<e.byteLength;){const a=e.byteLength-s;if(a>=this.chunkSize){const a=e.slice(s,s+this.chunkSize);s+=this.chunkSize,this.send(a,t)}else{const t=e.slice(s,s+a);s+=t.byteLength,this.partialChunk.set(t),this.offset=t.byteLength}}}flush(e){this.offset>0&&e.enqueue(this.partialChunk.slice(0,this.offset))}}},uAZB:function(e,t){globalThis.voiceMessageE2EERaw={actionId:"4724577257152",msgId:"4724598698821",zglobalMsgId:"4724598698821",cliMsgId:"1695617353668",msgType:3,status:2,notify:"1",message:{title:"",description:"",href:"https://f2-voice-aac-dl.zdn.vn/278747013645988928/f1a56fd8df70352e6c61.aac?e2esession=sWJaI+5h2lpvfOKhpVvK1WiZmAVsh9SMd8K9fBEoNNJXagE5R6xEwIPR/YTOg4sY1G/1zvynosJP+gvj",thumb:"",childnumber:0,action:"",params:'{"m4a":"https:\\/\\/f2-voice-aac-dl.zdn.vn\\/278747013645988928\\/f1a56fd8df70352e6c61.aac?e2esession=sWJaI+5h2lpvfOKhpVvK1WiZmAVsh9SMd8K9fBEoNNJXagE5R6xEwIPR\\/YTOg4sY1G\\/1zvynosJP+gvj","duration":3000}',type:""},sendDttm:"1695617381952",serverTime:1695617382529,fromUid:"0",toUid:"g8293820567948517115",dName:"Lê Võ Gia Khang",localDttm:1695617152380,properties:{color:-1,size:-1,type:1,subType:0,ext:'{"shouldParseLinkOrContact":0}'},ttl:0,st:6,at:0,cmd:-1,originMsgType:"chat.voice",e2eeStatus:3e3,platformType:0,src:5,syncFromMobile:!1,topOut:"0",topOutTimeOut:"0",topOutImprTimeOut:"0",isLastMsg:!1,mediaAction:null,isSelected:!1},globalThis.voiceMessageRaw={actionId:"6424901573796",msgId:"4728547151178",zglobalMsgId:"4728547151178",cliMsgId:"1695718894432",msgType:3,status:2,notify:"1",message:{title:"",description:"",href:"https://f1-voice-talk.zdn.vn/1199765638478242634/edd3d72884836edd3792.amr",thumb:"",childnumber:0,action:"",params:'{"m4a":"https:\\/\\/f2-voice-aac-dl.zdn.vn\\/1199765638478242634\\/edd3d72884836edd3792.aac","duration":3000}',type:""},sendDttm:"1695718897605",serverTime:"1695718897605",fromUid:"0",toUid:"g4243069577519568569",dName:"Lê Võ Gia Khang",localDttm:1695718898102,properties:{color:-1,size:-1,type:1,subType:0,ext:'{"shouldParseLinkOrContact":0}'},ttl:0,st:3,at:0,cmd:521,originMsgType:"chat.voice",subState:-1,e2eeStatus:-1,platformType:0,src:10,syncFromMobile:!1,topOut:"0",topOutTimeOut:"0",topOutImprTimeOut:"0",isLastMsg:!1,isSelected:!1},globalThis.runSound=e=>{const t=new Audio;return t.src=e,t.play(),t}},uGvo:function(e,t){},"w+Cq":function(e,t){}}]);
//# sourceMappingURL=../sourcemaps/lazy/main-startup.c6f810409c33ac002d9d.js.map